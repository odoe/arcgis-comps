import{T as e,hw as n,t,b as i,E as a,bO as s,f2 as o,k as r,eK as l,r as c,eX as u,eI as f,fC as p,fN as d,hx as m}from"./p-5420851c.js";import{O as g,T as y,L as w}from"./p-5e9a6603.js";import{u as h}from"./p-3bb1fb67.js";const b=e.getLogger("esri.layers.graphics.sources.ogcfeature"),j="http://www.opengis.net/def/crs/",I=`${j}OGC/1.3/CRS84`;async function F(e,n,r={},l=5){const{links:c}=e,u=K(c,"items","application/geo+json")||K(c,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(t(u))throw new i("ogc-feature-layer:missing-items-page","Missing items url");const{data:f}=await a(u.href,{signal:r.signal,query:{limit:l,...r.customParameters,token:r.apiKey},headers:{accept:"application/geo+json"}});await g(f);const p=y(f,{geometryType:n.geometryType}),d=n.fields||p.fields||[],m=null!=n.hasZ?n.hasZ:p.hasZ,w=p.geometryType,j=n.objectIdField||p.objectIdFieldName||"OBJECTID";let I=n.timeInfo;const F=d.find((e=>e.name===j));if(F)F.type="esriFieldTypeOID",F.editable=!1,F.nullable=!1;else{if(!p.objectIdFieldType)throw new i("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");d.unshift({name:j,alias:j,type:"esriFieldTypeOID",editable:!1,nullable:!1})}if(j!==p.objectIdFieldName){const e=d.find((e=>e.name===p.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}d===p.fields&&p.unknownFields.length>0&&b.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:p.unknownFields}});for(const e of d){if(null==e.name&&(e.name=e.alias),null==e.alias&&(e.alias=e.name),"esriFieldTypeOID"!==e.type&&"esriFieldTypeGlobalID"!==e.type&&(e.editable=null==e.editable||!!e.editable,e.nullable=null==e.nullable||!!e.nullable),!e.name)throw new i("ogc-feature-layer:invalid-field-name","field name is missing",{field:e});if(-1===s.jsonValues.indexOf(e.type))throw new i("ogc-feature-layer:invalid-field-type",`invalid type for field "${e.name}"`,{field:e})}if(I){const e=new o(d);if(I.startTimeField){const n=e.get(I.startTimeField);n?(I.startTimeField=n.name,n.type="esriFieldTypeDate"):I.startTimeField=null}if(I.endTimeField){const n=e.get(I.endTimeField);n?(I.endTimeField=n.name,n.type="esriFieldTypeDate"):I.endTimeField=null}if(I.trackIdField){const n=e.get(I.trackIdField);n?I.trackIdField=n.name:(I.trackIdField=null,b.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:I}}))}I.startTimeField||I.endTimeField||(b.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:I}}),I=null)}return{drawingInfo:w?h(w):null,geometryType:w,fields:d,hasZ:!!m,objectIdField:j,timeInfo:I}}async function k(e,n={}){const{links:s}=e,o=K(s,"data","application/json")||K(s,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(t(o))throw new i("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:r,customParameters:l,signal:c}=n,{data:u}=await a(o.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:r}});return u}async function T(e,n={}){const{links:s}=e,o=K(s,"conformance","application/json")||K(s,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(t(o))throw new i("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:r,customParameters:l,signal:c}=n,{data:u}=await a(o.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:r}});return u}async function x(e,n={}){const{apiKey:t,customParameters:i,signal:s}=n,{data:o}=await a(e,{signal:s,headers:{accept:"application/json"},query:{...i,token:t}});return o}async function v(e,n={}){const i="application/vnd.oai.openapi+json;version=3.0",s=K(e.links,"service-desc",i);if(t(s))return b.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:o,customParameters:r,signal:l}=n,{data:c}=await a(s.href,{signal:l,headers:{accept:i},query:{...r,token:o}});return c}function q(e){const n=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),t=null==n?void 0:n.groups;if(!t)return null;const{authority:i,code:a}=t;switch(i.toLowerCase()){case"ogc":switch(a.toLowerCase()){case"crs27":return r.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return r.WGS84.wkid;default:return null}case"esri":case"epsg":{const e=Number.parseInt(a,10);return Number.isNaN(e)?null:e}default:return null}}async function $(e,t,i){const a=await O(e,t,i);return n(a)}async function O(e,n,s){const{capabilities:{query:{maxRecordCount:o}},collection:g,layerDefinition:y,queryParameters:{apiKey:h,customParameters:b},spatialReference:j,supportedCrs:I}=e,{links:F}=g,k=K(F,"items","application/geo+json")||K(F,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(t(k))throw new i("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:T,num:x,start:v,timeExtent:q,where:$}=n;if(n.objectIds)throw new i("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const O=r.fromJSON(j),D=l(n.outSpatialReference,O),M=D.isWGS84?null:C(D,I),N=P(T,I),R=function(e){if(t(e))return null;const{start:n,end:i}=e;return`${c(n)?n.toISOString():".."}/${c(i)?i.toISOString():".."}`}(q),G=function(e){return t(e)||!e||"1=1"===e?null:e}($),Z=null!=x?x:null!=v&&void 0!==v?10:o,{data:A}=await a(k.href,{...s,query:{...b,...N,crs:M,datetime:R,query:G,limit:Z,startindex:v,token:h},headers:{accept:"application/geo+json"}});let E=!1;A.links&&(E=!!A.links.find((e=>"next"===e.rel))),!E&&Number.isInteger(A.numberMatched)&&Number.isInteger(A.numberReturned)&&(E=A.numberReturned<A.numberMatched);const{fields:S,globalIdField:B,hasM:J,hasZ:Q,objectIdField:W}=y,X=y.geometryType,z=w(A,{geometryType:X,hasZ:Q,objectIdField:W});if(!M&&D.isWebMercator)for(const e of z)if(c(e.geometry)){const n=u(e.geometry,X,Q,!1);n.spatialReference=r.WGS84,e.geometry=f(p(n,D))}for(const e of z)e.objectId=e.attributes[W];const H=M||!M&&D.isWebMercator?D.toJSON():d,L=new m;return L.exceededTransferLimit=E,L.features=z,L.fields=S,L.geometryType=X,L.globalIdFieldName=B,L.hasM=J,L.hasZ=Q,L.objectIdFieldName=W,L.spatialReference=H,L}function C(e,n){var t,i,a;const{isWebMercator:s,wkid:o}=e;if(!o)return null;const r=s?null!=(t=null!=(i=null!=(a=n[3857])?a:n[102100])?i:n[102113])?t:n[900913]:n[e.wkid];return r?`${j}${r}`:null}function D(e){if(t(e))return"";const{xmin:n,ymin:i,xmax:a,ymax:s}=e;return`${n},${i},${a},${s}`}function P(e,n){if(!function(e){return c(e)&&"extent"===e.type}(e))return null;const{spatialReference:t}=e;if(!t||t.isWGS84)return{bbox:D(e)};const i=C(t,n);return c(i)?{bbox:D(e),"bbox-crs":i}:t.isWebMercator?{bbox:D(p(e,r.WGS84))}:null}function K(e,n,t){return e.find((e=>e.rel===n&&e.type===t))||e.find((e=>e.rel===n&&!e.type))}export{I as F,F as I,$ as N,v as S,k as T,j,T as k,O as q,q as v,x}