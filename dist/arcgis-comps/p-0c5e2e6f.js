import{A as t,af as s,c9 as i,dX as r,aW as e,K as h,bE as o,e as n,i as p,b as a}from"./p-e58503d5.js";import{u as c}from"./p-ea916a39.js";import{s as u}from"./p-7ec84656.js";import{n as d,i as m,o as f}from"./p-1e473dab.js";import{n as l}from"./p-d1d9dbe4.js";import{D as j}from"./p-e6fe5d89.js";import{n as b}from"./p-56ed1c7a.js";import{r as g,E as w,I as y}from"./p-e3500fdc.js";import{i as v,f as A,o as x}from"./p-db566ae7.js";import{h as M,f as C}from"./p-19bc1e3d.js";import"./p-0bb84768.js";import{s as _}from"./p-c5443b47.js";import{o as U}from"./p-252fc884.js";import{m as k}from"./p-9b76ac50.js";import{G as E}from"./p-1676d4c7.js";import"./p-53bb6ab4.js";import"./p-2f398ed1.js";import"./p-d3105731.js";import"./p-b9aa4901.js";import"./p-6484267b.js";import"./p-400ca3dc.js";import"./p-efbca0ca.js";import"./p-9b7a2176.js";import"./p-e654504b.js";import"./p-0eb619a6.js";import"./p-4d17d2cd.js";import"./p-e273719b.js";import"./p-74de0937.js";import"./p-b5b00e38.js";import"./p-a9a30646.js";import"./p-765e6c28.js";import"./p-b79fcce3.js";import"./p-e94b450b.js";import"./p-7731c620.js";import"./p-5d962998.js";import"./p-1189fa83.js";import"./p-37058f88.js";import"./p-3e39c093.js";import"./p-8747982c.js";import"./p-7a5bfd29.js";import"./p-7d081d01.js";import"./p-54330161.js";import"./p-93765525.js";import"./p-8bc9b36a.js";import"./p-7a658388.js";import"./p-fb38a9d0.js";import"./p-f94762ac.js";import"./p-8a919d07.js";import"./p-c048b814.js";import"./p-afac6fb2.js";import"./p-01e5a461.js";import"./p-ca295674.js";import"./p-41f2b2dd.js";import"./p-612a2c14.js";import"./p-d443df87.js";import"./p-7ca40eac.js";import"./p-9087b4d3.js";import"./p-c1cd5521.js";import"./p-ca4492df.js";import"./p-9d34911e.js";import"./p-182bb5be.js";import"./p-db87794e.js";import"./p-2db4840f.js";import"./p-bba8b671.js";import"./p-5e833dfc.js";import"./p-a131049b.js";import"./p-a2324023.js";import"./p-dc852195.js";import"./p-ff2962f5.js";import"./p-da9e7ba9.js";import"./p-a8f0aa27.js";import"./p-4a96de15.js";import"./p-5032dfbd.js";import"./p-a87cccba.js";import"./p-dae095dd.js";import"./p-0e784e4d.js";import"./p-dbdf15fc.js";import"./p-e0d9ff4c.js";import"./p-08e5f531.js";import"./p-dfc6337f.js";import"./p-9f1c2d50.js";import"./p-6b2eb7a7.js";import"./p-889f7a78.js";import"./p-1f81b35d.js";import"./p-81b9df84.js";import"./p-5ce39624.js";import"./p-e9bae5e9.js";import"./p-b0565d49.js";import"./p-51a17e75.js";import"./p-d208934e.js";import"./p-480e5606.js";import"./p-22c9f19c.js";import"./p-c096b5df.js";import"./p-da33e926.js";import"./p-a24f7752.js";import"./p-ccdb8e80.js";import"./p-4a6dc5e4.js";import"./p-6a92ecb9.js";import"./p-1ab449fc.js";import"./p-a6c8fb32.js";import"./p-0edb3309.js";import"./p-e8160b60.js";import"./p-2e8ad983.js";import"./p-e3270d48.js";import"./p-e44bd0a6.js";import"./p-fe68aab5.js";import"./p-c6970847.js";import"./p-de86b3c9.js";import"./p-37d3434c.js";import"./p-120b7410.js";import"./p-b1eff69d.js";import"./p-612de336.js";import"./p-91fe06d4.js";import"./p-ab0e9273.js";import"./p-15a9486c.js";import"./p-2ae44317.js";import"./p-9f58a277.js";import"./p-9e860e7b.js";import"./p-f3659a34.js";import"./p-ca657fcf.js";import"./p-b312c1fd.js";import"./p-b8beb0d3.js";import"./p-2a99994a.js";import"./p-76f37e40.js";import"./p-eee9ef50.js";import"./p-6ded4c02.js";import"./p-d57f9971.js";import"./p-746a9d8f.js";import"./p-db4d63dc.js";import"./p-47e1bd73.js";import"./p-1ccb0bf6.js";import"./p-1c2ff3a7.js";import"./p-77b9a0fc.js";import"./p-a2b6db85.js";import"./p-2e5dd2d0.js";import"./p-56ca6f1f.js";import"./p-0bb41218.js";import"./p-97ec6ae5.js";import"./p-b392deaf.js";import"./p-b9c93bb2.js";import"./p-3a6cfd25.js";import"./p-1a7268a2.js";import"./p-2d0c34e5.js";import"./p-025c0c8e.js";import"./p-9790d1b4.js";import"./p-8acbca5b.js";import"./p-dc15ecc1.js";import"./p-0923eebd.js";import"./p-4019eec3.js";import"./p-b05e75b2.js";import"./p-e991a11e.js";import"./p-09dd2137.js";import"./p-ad14ca1b.js";import"./p-4414d64f.js";import"./p-a617738c.js";import"./p-f971b161.js";import"./p-6fe4db61.js";const T=4294967296;class X{constructor(t){this._head=t,this._cursor=t}static from(t){const s=S.from(new Float32Array(t));return new X(s)}get id(){return this._cursor.id}get baseZoom(){return this._cursor.baseZoom}get anchorX(){return this._cursor.anchorX}get anchorY(){return this._cursor.anchorY}get directionX(){return this._cursor.directionX}get directionY(){return this._cursor.directionY}get size(){return this._cursor.size}get materialKey(){return this._cursor.materialKey}get boundsCount(){return this._cursor.boundsCount}computedMinZoom(){return this._cursor.computedMinZoom()}setComputedMinZoom(t){return this._cursor.setComputedMinZoom(t)}boundsComputedAnchorX(t){return this._cursor.boundsComputedAnchorX(t)}boundsComputedAnchorY(t){return this._cursor.boundsComputedAnchorY(t)}setBoundsComputedAnchorX(t,s){return this._cursor.setBoundsComputedAnchorX(t,s)}setBoundsComputedAnchorY(t,s){return this._cursor.setBoundsComputedAnchorY(t,s)}boundsX(t){return this._cursor.boundsX(t)}boundsY(t){return this._cursor.boundsY(t)}boundsWidth(t){return this._cursor.boundsWidth(t)}boundsHeight(t){return this._cursor.boundsHeight(t)}link(s){if(t(s._head))return this._cursor.link(s._head)}getCursor(){return this.copy()}copy(){var t;const s=new X(null==(t=this._head)?void 0:t.copy());if(!s._head)return s;let i=s._head,r=s._head._link;for(;r;)i._link=r.copy(),i=r,r=i._link;return s}peekId(){var t;return null!=(t=this._cursor.peekId())?t:this._cursor._link.peekId()}nextId(){const t=this.id;for(;t===this.id;)if(!this.next())return!1;return!0}save(){this._savedCursor=this._cursor,this._savedOffset=this._cursor._offset}restore(){this._cursor=this._savedCursor,this._cursor._offset=this._savedOffset}next(){if(!this._cursor)return!1;if(!this._cursor.next()){if(!this._cursor._link)return!1;this._cursor=this._cursor._link,this._cursor._offset=0}return!0}lookup(t){for(this._cursor=this._head;this._cursor&&!this._cursor.lookup(t);){if(!this._cursor._link)return!1;this._cursor=this._cursor._link}return!!this._cursor}delete(s){let i=this._head,r=null;for(;i;){if(i.delete(s))return i.isEmpty()&&t(r)&&(r._link=i._link),!0;r=i,i=i._link}return!1}}class S{constructor(t){this._offset=-1,this._link=null,this._count=0,this._deletedCount=0,this._offsets={instance:null},this._buffer=t}static from(t){return new S(new Float32Array(t))}isEmpty(){return this._deletedCount===this.count}get count(){return this._count||(this._count=this._computeCount()),this._count}get id(){return this._buffer[this._offset+0]}set id(t){this._buffer[this._offset+0]=t}get baseZoom(){return this._buffer[this._offset+1]}get anchorX(){return this._buffer[this._offset+2]}get anchorY(){return this._buffer[this._offset+3]}get directionX(){return this._buffer[this._offset+4]}get directionY(){return this._buffer[this._offset+5]}get size(){return this._buffer[this._offset+6]}get materialKey(){return this._buffer[this._offset+7]}computedMinZoom(){return this._buffer[this._offset+8]}setComputedMinZoom(t){this._buffer[this._offset+8]=t}get boundsCount(){return this._buffer[this._offset+9]}boundsComputedAnchorX(t){return this._buffer[this._offset+10+6*t+0]}boundsComputedAnchorY(t){return this._buffer[this._offset+10+6*t+1]}setBoundsComputedAnchorX(t,s){this._buffer[this._offset+10+6*t+0]=s}setBoundsComputedAnchorY(t,s){this._buffer[this._offset+10+6*t+1]=s}boundsX(t){return this._buffer[this._offset+10+6*t+2]}boundsY(t){return this._buffer[this._offset+10+6*t+3]}boundsWidth(t){return this._buffer[this._offset+10+6*t+4]}boundsHeight(t){return this._buffer[this._offset+10+6*t+5]}link(t){let s=this;for(;s._link;)s=s._link;s._link=t}getCursor(){return this.copy()}copy(){const t=new S(this._buffer);return t._link=this._link,t._offset=this._offset,t._deletedCount=this._deletedCount,t._offsets=this._offsets,t._count=this._count,t}peekId(){const t=this._offset+10+6*this.boundsCount+0;return t>=this._buffer.length?0:this._buffer[t]}next(){let t=0;for(;this._offset<this._buffer.length&&t++<100&&(-1===this._offset?this._offset=0:this._offset+=10+6*this.boundsCount,this.id===T););return this.id!==T&&this._offset<this._buffer.length}delete(t){const s=this._offset,i=this.lookup(t);if(i)for(this.id=4294967295,++this._deletedCount;this.next()&&this.id===t;)this.id=4294967295,++this._deletedCount;return this._offset=s,i}lookup(t){const i=this._offset;if(s(this._offsets.instance)){this._offsets.instance=new Map;const t=this.copy();t._offset=-1;let s=0;for(;t.next();)t.id!==s&&(this._offsets.instance.set(t.id,t._offset),s=t.id)}return!!this._offsets.instance.has(t)&&(this._offset=this._offsets.instance.get(t),this.id!==T||(this._offset=i,!1))}_computeCount(){const t=this._offset;let s=0;for(this._offset=-1;this.next();)s++;return this._offset=t,s}}class Y{constructor(t){if(!Array.isArray(t))return void(this.data=t);this.data=t[0];let s=this;for(let i=1;i<t.length;i++)s.next=new Y([t[i]]),s=s.next}*values(){let t=this;for(;t;)yield t.data,t=t.next}forEach(t){let s=this;for(;s;)t(s.data),s=s.next}find(t){var s;return t(this.data)?this:null==(s=this.next)?void 0:s.find(t)}max(t,s=this){const i=t(this.data)>t(s.data)?this:s;return this.next?this.next.max(t,i):i}remove(t,s=null){return this===t?s?(s.next=this.next,s):this.next:this.next.remove(t,this)}get last(){return this.next?this.next.last:this}}class B{constructor(t){this._head=null,s(t)||(this._head=new Y(t))}get head(){return this._head}maxAvailableSpace(){if(s(this._head))return 0;const t=this._head.max((t=>t.end-t.start));return t.data.end-t.data.start}firstFit(t){if(s(this._head))return null;let i=null,r=this._head;for(;r;){const s=r.data.end-r.data.start;if(s===t)return i?i.next=r.next:this._head=r.next,r.data.start;if(s>t){const s=r.data.start;return r.data.start+=t,s}i=r,r=r.next}return null}free(t,i){const r=t+i;if(s(this._head)){const s=new Y({start:t,end:r});return void(this._head=s)}if(r<=this._head.data.start){if(r===this._head.data.start)return void(this._head.data.start-=i);const s=new Y({start:t,end:r});return s.next=this._head,void(this._head=s)}let e=this._head,h=e.next;for(;h;){if(h.data.start>=r){if(e.data.end===t)return void(e.data.end+=i);if(h.data.start===r)return void(h.data.start-=i);const s=new Y({start:t,end:r});return s.next=e.next,void(e.next=s)}e=h,h=h.next}if(t===e.data.end)return void(e.data.end+=i);const o=new Y({start:t,end:r});e.next=o}}class R{constructor(t,s,i,r,e){this.target=t,this.geometryType=s,this.materialKey=i,this.indexFrom=r,this.indexCount=e}get indexEnd(){return this.indexFrom+this.indexCount}extend(t){this.indexCount+=t}draw(t,s,i){this.target.draw(t,s,i,this.indexFrom,this.indexCount)}}class F{constructor(t,s){this.geometryType=0,this._target=t,this.geometryType=s}static from(s,i,r,e){const h=new F(s,i);if(t(e))for(const t of e)r.seekIndex(t),h.addRecord(r);else for(;r.next();)h.addRecord(r);return h}addRecord(t){const i=this._target,r=this.geometryType,e=t.materialKey,h=t.indexFrom,o=t.indexCount;if(s(this._head)){const t=new R(i,r,e,h,o);return void(this._head=new Y(t))}let n=null,p=this._head;for(;p;){if(h<p.data.indexFrom)return this._insert(e,h,o,n,p);n=p,p=p.next}this._insert(e,h,o,n,null)}forEach(s){t(this._head)&&this._head.forEach(s)}*infos(){if(t(this._head))for(const t of this._head.values())yield t}_insert(i,r,e,h,o){if(s(h)&&s(o)){const t=new R(this._target,this.geometryType,i,r,e);this._head=new Y(t)}return s(h)&&t(o)?this._insertAtHead(i,r,e,o):t(h)&&s(o)?this._insertAtEnd(i,r,e,h):t(h)&&t(o)?this._insertAtMiddle(i,r,e,h,o):void 0}_insertAtHead(t,s,i,r){if(t===r.data.materialKey&&s+i===r.data.indexFrom)r.data.indexFrom=s,r.data.indexCount+=i;else{const e=new R(this._target,this.geometryType,t,s,i);this._head=new Y(e),this._head.next=r}}_insertAtEnd(t,s,i,r){if(r.data.materialKey===t&&r.data.indexEnd===s)r.data.indexCount+=i;else{const e=new R(this._target,this.geometryType,t,s,i),h=new Y(e);r.next=h}}_insertAtMiddle(t,s,i,r,e){const h=s+i;if(r.data.materialKey===t&&r.data.indexEnd===s)r.data.indexCount+=i,r.data.materialKey===e.data.materialKey&&r.data.indexEnd===e.data.indexFrom&&(r.data.indexCount+=e.data.indexCount,r.next=e.next);else if(t===e.data.materialKey&&h===e.data.indexFrom)e.data.indexFrom=s,e.data.indexCount+=i;else{const h=new R(this._target,this.geometryType,t,s,i),o=new Y(h);r.next=o,o.next=e}}}class P{constructor(t,s,i){const r=new Uint32Array(s*i);this.strideInt=i,this.bufferType=t,this.dirty={start:1/0,end:0},this.gpu=null,this._cpu=r,this.clear()}get elementSize(){return this._cpu.length/this.strideInt}destroy(){i(this.gpu,(t=>t.dispose()))}clear(){this.dirty.start=1/0,this.dirty.end=0,this.freeList=new B({start:0,end:this._cpu.length/this.strideInt}),this.fillPointer=0}ensure(s){if(this.maxAvailableSpace()>=s)return;const i=s*this.strideInt;if(i>this._cpu.length-this.fillPointer){t(this.gpu)&&(this.gpu=null);const s=Math.round(1.5*(this._cpu.length+i)),r=new Uint32Array(s),e=this._cpu.length/this.strideInt;this.freeList.free(e,s/this.strideInt-e),r.set(this._cpu),this._cpu=r}}set(t,s){this._cpu[t]!==s&&(this._cpu[t]=s,this.dirty.start=Math.min(t,this.dirty.start),this.dirty.end=Math.max(t,this.dirty.end))}getBuffer(){if(!this._cpu2||this._cpu2.length!==this._cpu.length){const t=this._cpu.slice();this._cpu2=t}return this._cpu2.set(this._cpu),this._cpu2}get bufferSize(){return this._cpu.length/this.strideInt}maxAvailableSpace(){return this.freeList.maxAvailableSpace()}insert(t,s,i,e){const h=i*this.strideInt,o=s*this.strideInt*Uint32Array.BYTES_PER_ELEMENT,n=new Uint32Array(t,o,h),p=r(this.freeList.firstFit(i),"First fit region must be defined")*this.strideInt,a=h,c=p/this.strideInt-s;if(0!==e)for(let t=0;t<n.length;t++)n[t]+=e;return this._cpu.set(n,p),this.dirty.start=Math.min(this.dirty.start,p),this.dirty.end=Math.max(this.dirty.end,p+a),this.fillPointer=Math.max(this.fillPointer,p+a),c}free(t,s,i){const r=t*this.strideInt,e=(t+s)*this.strideInt;if(!0===i)for(let i=t;i!==t+s;i++)this._cpu[i*this.strideInt]=2147450879;this.dirty.start=Math.min(this.dirty.start,r),this.dirty.end=Math.max(this.dirty.end,e),this.freeList.free(t,s)}upload(t){if(this.dirty.end){if(s(this.gpu))return this.gpu=this._createBuffer(t),this.dirty.start=1/0,void(this.dirty.end=0);this.gpu.setSubData(this._cpu,this.dirty.start,this.dirty.start,this.dirty.end),this.dirty.start=1/0,this.dirty.end=0}}_createBuffer(t){return"index"===this.bufferType?M.createIndex(t,35048,this._cpu):M.createVertex(t,35048,this._cpu)}}class D{constructor(t,s){this._indicesInvalid=!1,this.geometryType=t}destroy(){this._vao&&(this._vao.dispose(),this._vao=null)}insert(t,s,i){if(!t.records.byteLength)return;const e=t.stride;if(this._vertexBuffer&&this._indexBuffer){const i=t.vertices.byteLength/e;this._indexBuffer.ensure(4*t.indices.byteLength),this._vertexBuffer.ensure(i);const{vertices:h,indices:o}=t,n=v.from(t.records),p=this._vertexBuffer.insert(h,0,h.byteLength/e,0),a=this._indexBuffer.insert(o,0,o.byteLength/4,p);if(n.forEach((t=>{t.indexFrom+=a,t.vertexFrom+=p})),r(this._records,"Expected records to be defined").link(n),s)this._indicesInvalid=!0;else if(this._displayList){const t=n.getCursor();for(;t.next();)this._displayList.addRecord(t)}}else{const i=4*t.indices.byteLength,r=t.vertices.byteLength/e,h=e/Uint32Array.BYTES_PER_ELEMENT;this._records=v.from(t.records),this._indexBuffer=new P("index",i,1),this._vertexBuffer=new P("vertex",r,h),this._indexBuffer.insert(t.indices,0,t.indices.byteLength/4,0),this._vertexBuffer.insert(t.vertices,0,t.vertices.byteLength/e,0),s&&(this._indicesInvalid=!0)}}remove(t){if(!s(this._records))for(const s of t){const t=this._records.getCursor();if(!t.lookup(s))continue;const i=t.indexFrom,r=t.vertexFrom;let e=t.indexCount,h=t.vertexCount;for(;t.next()&&t.id===s;)e+=t.indexCount,h+=t.vertexCount;this._indexBuffer.free(i,e),this._vertexBuffer.free(r,h,!0),this._records.delete(s)}}draw(t,i,r,e,h){if(!this._vertexBuffer||!this._indexBuffer||s(this._records))return;if((s(this._vertexBuffer.gpu)||s(this._indexBuffer.gpu))&&(this._vao&&(this._vao.dispose(),this._vao=null),this._vertexBuffer.gpu=null,this._indexBuffer.gpu=null),this._vertexBuffer.upload(t),this._indexBuffer.upload(t),!this._vao){const s=this._vertexBuffer.gpu,e=this._indexBuffer.gpu;if(!e||!s)return;this._vao=new C(t,r,i,{geometry:s},e)}const o=e*Uint32Array.BYTES_PER_ELEMENT;t.bindVAO(this._vao),t.drawElements(4,h,5125,o)}forEachCommand(t){if(!s(this._records)){if(this._sortIndices(this._records),!this._displayList){const t=this._cursorIndexOrder;this._displayList=F.from(this,this.geometryType,this._records.getCursor(),t)}this._displayList.forEach(t)}}_sortIndices(t){if(!this._indicesInvalid)return;this._indicesInvalid=!1;let s=0;const i=t.getCursor(),r=this._indexBuffer.getBuffer(),e=[],h=[],o=[];for(;i.next();)h.push(i.index),o.push(i.sortKey),e.push(i.id);h.sort(((t,s)=>{const i=o[s],r=o[t];return r===i?e[s]-e[t]:i-r}));const n=t.getCursor();for(const t of h){if(!n.seekIndex(t))throw new Error("Expected to find index");const{indexFrom:i,indexCount:e}=n;n.indexFrom=s;for(let t=0;t<e;t++)this._indexBuffer.set(s++,r[i+t])}this._cursorIndexOrder=h,this._displayList=null}}let Z=0;class z extends A{constructor(t,s,i,r){super(t,s,i),this.instanceId=Z++,this.patchCount=0,this._renderState={current:{geometry:new Map,metrics:null},next:null,swap:!1,swapFrames:0,locked:!1},this._patches=new u(100),this._bufferPatches=new u(100),this._lastCommitTime=0,this._lastMessageWasClear=!1,this.transforms.labelMat2d=l(),this._store=r}destroy(){super.destroy(),this._renderState.current.geometry.forEach((t=>t.destroy()))}get labelMetrics(){return this._renderState.current.metrics}get hasData(){return!!this._renderState.current.geometry.size}getGeometry(t){return this._renderState.current.geometry.get(t)}setTransform(t,s){super.setTransform(t,s);const i=this.transforms.labelMat2d,r=t.getScreenTransform(i,s),e=b();j(e,[this.x,this.y],r),d(i),m(i,i,e),f(i,t.viewMat2d,i)}patch(t,s){if(this.patchCount++,t.clear&&this._lastMessageWasClear)return;this._lastMessageWasClear=t.clear,t.clear&&this._patches.size>=50&&this._dropPatches();const i=t;s&&i.addOrUpdate&&this.key.id!==i.addOrUpdate.tileKeyOrigin?this._bufferPatches.enqueue(i):(i.sort=i.sort&&!s,this._patches.enqueue(i)),this.requestRender()}commit(t){if(this._lastCommitTime!==t.time){this._lastCommitTime=t.time;for(let t=0;t<4;t++)this._updateMesh(),this.isReady&&this._updateBufferMesh();this._renderState.swap&&(this._swapRenderStates(),this.requestRender())}}lock(){this._renderState.locked=!0}unlock(){this._renderState.locked=!1,this._flushUpdates(),this._swap()}_swapRenderStates(){if(this._renderState.next){if(this._renderState.locked)return this._renderState.swap=!0,void this.requestRender();if(this._renderState.swap=!0,0===this._renderState.swapFrames)return this._renderState.swapFrames=8,void this.requestRender();1==this._renderState.swapFrames--?this._swap():this.requestRender()}}_swap(){this._renderState.swap&&(this._renderState.swap=!1,t(this._renderState.next)&&(this._renderState.current.geometry.forEach((t=>t.destroy())),this._renderState.current=this._renderState.next,this._renderState.next=null))}_flushUpdates(){let t=this._patches.maxSize;for(;this._patches.size&&t--;)this._updateMesh(),this._swap()}_updateBufferMesh(){const s=this._bufferPatches.peek();if(!t(s)||!s.clear||null===this._renderState.next)for(;this._bufferPatches.size;){const s=this._bufferPatches.dequeue();t(s)&&this._patchBuffer(s)}}_updateMesh(){const s=this._patches.peek();if(t(s)&&s.clear&&null!==this._renderState.next)return;const i=this._patches.dequeue();if(t(i)){if(!0===i.clear){if(!this.isReady)return;return void(this._renderState.next={geometry:new Map,metrics:null})}this.requestRender(),this._patch(i),i.end&&(this.ready(),this._swapRenderStates())}}_patch(t){g((s=>{this._remove(s,t.remove),this._insert(s,t,!1)}))}_patchBuffer(t){g((s=>{this._insert(s,t,!0)}))}_insert(t,i,r){try{var h;const o=e(this._renderState.next,this._renderState.current),n=null==(h=i.addOrUpdate)?void 0:h.data[t],p=o.geometry;if(s(n))return;p.has(t)||p.set(t,new D(t,this.stage)),p.get(t).insert(n,i.sort,r),t===w.LABEL&&this._insertLabelMetrics(i.type,n.metrics,i.clear)}catch(t){}}_insertLabelMetrics(t,i,r){const h=e(this._renderState.next,this._renderState.current);if(s(i))return;const o=X.from(i);if(s(h.metrics))h.metrics=o;else{if("update"===t){const t=o.getCursor();for(;t.next();)h.metrics.delete(t.id)}h.metrics.link(o)}}_remove(t,s){const i=e(this._renderState.next,this._renderState.current).geometry.get(t);s&&s.length&&i&&(i.remove(s),this._removeLabelMetrics(s))}_removeLabelMetrics(t){const{metrics:i}=e(this._renderState.next,this._renderState.current);if(!s(i)&&t.length)for(const s of t)for(;i.delete(s););}_dropPatches(){const t=new Array;let i=!1;for(;this._patches.size;){const r=this._patches.dequeue();if(s(r))break;if(r.clear){if(i)break;i=!0}t.push(r)}this._patches.clear(),t.forEach((t=>this._patches.enqueue(t)))}}const I=h("featurelayer-order-by-server-enabled");class L extends x{constructor(t,s,i,r){super(t),this._pointToCallbacks=new Map,this._layer=i,this._layerView=s,this._onUpdate=r}renderChildren(t){this.attributeView.update(),this.hasAnimation&&t.painter.effects.integrate.draw(t,t.attributeView),super.renderChildren(t)}isUpdating(){return this.attributeView.isUpdating()}hitTest(t,s){const i=[t,s],r=o();return this._pointToCallbacks.set(i,r),this.requestRender(),r.promise}onTileData(t,s){const i=I&&"orderBy"in this._layer&&this._layer.orderBy;t.patch(s,i&&this._layerView.orderByFields===((null==i?void 0:i.length)&&!i[0].valueExpression&&i[0].field)),this.contains(t)||this.addChild(t),this.requestRender()}onTileError(t){this.contains(t)||this.addChild(t)}doRender(t){const{minScale:s,maxScale:i}=this._layer,r=t.state.scale;r<=(s||1/0)&&r>=i&&super.doRender(t)}onAttributeStoreUpdate(){this.hasLabels&&this._layerView.view.labelManager.requestUpdate(),this._onUpdate()}get hasAnimation(){return this.hasLabels}get hasLabels(){if("sublayers"in this._layer)return this._layer.sublayers.some((t=>t.labelingInfo&&t.labelingInfo.length&&t.labelsVisible));const t=this._layer.featureReduction;return this._layer.labelingInfo&&this._layer.labelingInfo.length&&this._layer.labelsVisible||!!(t&&"cluster"===t.type&&t.labelsVisible&&t.labelingInfo&&t.labelingInfo.length)}prepareRenderPasses(t){const s=t.registerRenderPass({name:"label",brushes:[E.label],target:()=>this.hasLabels?this.children:null,drawPhase:y.LABEL|y.LABEL_ALPHA}),i=t.registerRenderPass({name:"geometry",brushes:[E.fill,E.line,E.marker,E.text],target:()=>this.children,enableDefaultDraw:()=>!this._layerView.hasEffects,effects:[{apply:t.effects.outsideEffect,enable:()=>this._layerView.hasEffects,args:()=>this._layerView.effectLists.excluded},{apply:t.effects.insideEffect,enable:()=>this._layerView.hasEffects,args:()=>this._layerView.effectLists.included},{apply:t.effects.hittest,enable:()=>!!this._pointToCallbacks.size,args:()=>this._pointToCallbacks}]}),r=t.registerRenderPass({name:"highlight",brushes:[E.fill,E.line,E.marker,E.text],target:()=>this.children,drawPhase:y.HIGHLIGHT,enableDefaultDraw:()=>!1,effects:[{apply:t.effects.highlight,enable:()=>!!this._layerView.hasHighlight()}]});return[...super.prepareRenderPasses(t),i,r,s]}}let $=class extends U{install(t){const s=new L(this.tileInfoView,this.layerView,this.layer,(()=>this.notifyChange("updating")));this.featuresView=s,t.addChild(s)}uninstall(t){t.removeChild(this.featuresView),this.featuresView.destroy()}fetchResource(t,s){const{url:i}=t,r=this.featuresView.stage;try{return r.resourceManager.fetchResource(i,{signal:s.signal})}catch(t){return a(t)?Promise.resolve({width:0,height:0}):Promise.reject(t)}}isUpdating(){const t=super.isUpdating(),s=!this.featuresView||this.featuresView.isUpdating(),i=t||s;return h("esri-2d-log-updating")&&console.log(`Updating SymbolTileRenderer ${i}\n  -> updatingTiles ${t}\n  -> updatingFeaturesView ${s}`),i}hitTest(t,s){return this.featuresView.hitTest(t,s)}supportsRenderer(t){return null!=t&&-1!==["simple","class-breaks","unique-value","dot-density","dictionary"].indexOf(t.type)}onConfigUpdate(t){let s=null;if("visualVariables"in t){const i=(_(t).visualVariables||[]).map((t=>{const s=t.clone();return"normalizationField"in t&&(s.normalizationField=null),t.valueExpression&&"$view.scale"!==t.valueExpression&&(s.valueExpression=null,s.field="nop"),s}));s=k(i)}this.featuresView.setRendererInfo(t,s,this.layerView.featureEffect)}onTileData(t){const s=this.tiles.get(t.tileKey);s&&t.data&&this.featuresView.onTileData(s,t.data),this.layerView.view.labelManager.requestUpdate()}onTileError(t){const s=this.tiles.get(t.tileKey);s&&this.featuresView.onTileError(s)}forceAttributeTextureUpload(){this.featuresView.attributeView.forceTextureUpload()}lockGPUUploads(){this.featuresView.attributeView.lockTextureUpload(),this.tiles.forEach((t=>t.lock()))}unlockGPUUploads(){this.featuresView.attributeView.unlockTextureUpload(),this.tiles.forEach((t=>t.unlock()))}async getMaterialItems(t){return this.featuresView.getMaterialItems(t)}invalidateLabels(){this.featuresView.hasLabels&&this.layerView.view.labelManager.requestUpdate()}createTile(t){const s=this.tileInfoView.getTileBounds(c(),t);return new z(t,s[0],s[3],this.featuresView.attributeView)}disposeTile(t){this.featuresView.removeChild(t),t.destroy(),this.layerView.view.labelManager.requestUpdate()}};$=n([p("esri.views.2d.layers.features.tileRenderers.SymbolTileRenderer")],$);const G=$;export default G;