import{aE as t,A as i,d7 as s,bt as e,D as n,C as r,af as h,S as a,c as o,e as l,d as c,i as u,p as d,bE as p,r as f,ai as m,cp as v,V as g,cq as y,cu as w,bo as b}from"./p-e58503d5.js";import{h as x}from"./p-54330161.js";import{a as M,d as O}from"./p-7731c620.js";import{h as k}from"./p-5f05b534.js";import{f as S,k as I,b as T,m as _,v as E,n as D}from"./p-b79fcce3.js";import{H as j}from"./p-01e5a461.js";import{m as C,f as V,c as z}from"./p-90239435.js";import{simplify as R,distance as A}from"./p-2f16d655.js";import{r as P}from"./p-1e473dab.js";import{e as U,n as G}from"./p-d57f9971.js";import{S as Z,k as F}from"./p-a3955219.js";import{a as H}from"./p-8f986f60.js";import{d as q,z as L,c as X,a as Y,_ as B,P as N,e as $}from"./p-2f398ed1.js";import{n as W,r as J}from"./p-d3105731.js";import{g as K}from"./p-612a2c14.js";import{c as Q,i as tt}from"./p-fb38a9d0.js";import{r as it}from"./p-e1b62a0c.js";import{x as st,l as et,g as nt,p as rt}from"./p-ab86fcff.js";import{O as ht}from"./p-c93d2280.js";import{r as at}from"./p-dd537345.js";import{e as ot}from"./p-f5813fa9.js";import{f as lt,D as ct}from"./p-ca295674.js";import{v as ut}from"./p-3bcc4805.js";function dt(t,s,e=null){return i(e)?[t,s,e]:[t,s]}function pt(t,s,e=null){return i(e)?{x:t,y:s,z:e}:{x:t,y:s}}class ft{constructor(t){this.spatialReference=t}mapToLocalMultiple(t){return s(t.map((t=>this.mapToLocal(t))))}get doUnnormalization(){return!1}}class mt extends ft{constructor(t,i,s=null){super(i),this.defaultZ=s,this.transform=U(),this.transformInv=U(),this.transform=G(t),P(this.transformInv,this.transform)}makeMapPoint(t,i){return dt(t,i,this.defaultZ)}mapToLocal(t){return pt(this.transform[0]*t[0]+this.transform[2]*t[1]+this.transform[4],this.transform[1]*t[0]+this.transform[3]*t[1]+this.transform[5])}localToMap(t){return dt(this.transformInv[0]*t.x+this.transformInv[2]*t.y+this.transformInv[4],this.transformInv[1]*t.x+this.transformInv[3]*t.y+this.transformInv[5],this.defaultZ)}}class vt extends ft{constructor(t,i){super(t.spatialReference),this.view=t,this.defaultZ=null,this.pWS=W(),this.tangentFrameUpWS=W(),this.tangentFrameRightWS=W(),this.tangentFrameForwardWS=W(),this.localFrameRightWS=W(),this.localFrameUpWS=W(),this.worldToLocalTransform=H(),this.localToWorldTransform=H(),this.scale=1,this.scale=t.resolution,this.referenceMapPoint=i,this.defaultZ=i.hasZ?i.z:null;const s=t.state.camera.viewRight;this.view.renderCoordsHelper.toRenderCoords(this.referenceMapPoint,this.pWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,0,this.tangentFrameRightWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,1,this.tangentFrameUpWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,2,this.tangentFrameForwardWS);const e=W();q(e,this.tangentFrameForwardWS,L(s,this.tangentFrameForwardWS)),X(this.localFrameRightWS,s,e),Y(this.localFrameRightWS,this.localFrameRightWS),B(this.localFrameUpWS,this.tangentFrameForwardWS,this.localFrameRightWS),Z(this.worldToLocalTransform,this.localFrameRightWS,this.tangentFrameRightWS),F(this.localToWorldTransform,this.worldToLocalTransform)}get doUnnormalization(){return"global"===this.view.viewingMode}makeMapPoint(t,i){return dt(t,i,this.defaultZ)}mapToLocal(s){const e=W();this.view.renderCoordsHelper.toRenderCoords(new t({x:s[0],y:s[1],spatialReference:this.spatialReference}),e),N(e,e,this.worldToLocalTransform);const n=this.view.renderCoordsHelper.fromRenderCoords(e,this.view.spatialReference);return i(n)?pt(n.x/this.scale,n.y/this.scale):null}localToMap(s){const e=W();this.view.renderCoordsHelper.toRenderCoords(new t({x:s.x*this.scale,y:s.y*this.scale,spatialReference:this.spatialReference}),e),N(e,e,this.localToWorldTransform);const n=this.view.renderCoordsHelper.fromRenderCoords(e,this.view.spatialReference);return i(n)?dt(n.x,n.y,this.defaultZ):null}}function gt(i,s){if("2d"===i.type)return new mt(i.state.transform,i.spatialReference,s.length>2?s[2]:null);if("3d"===i.type){const e=new t(s.length>2?{x:s[0],y:s[1],z:s[2],spatialReference:i.spatialReference}:{x:s[0],y:s[1],spatialReference:i.spatialReference});return new vt(i,e)}return null}function yt(i,s){const e=new t({x:i[0],y:i[1],spatialReference:s});return i.length>2&&(e.z=i[2]),e}function wt(t,i,s){const e=new _({paths:t,spatialReference:i});return s&&I(e),e}function bt(t,i,s,h=!0){const a=n(t);a.forEach((t=>{r(t[0],t[t.length-1])&&1!==t.length||t.push(t[0])}));let o=new E({rings:a,spatialReference:i});return o.rings.forEach((t=>{S(t,!1,!1)||t.reverse()})),s&&I(o),h&&o.isSelfIntersecting&&e(i)&&(o=R(o)),o}function xt(t,i,e){const n=i.mapToLocalMultiple(t),r=[],h={x:n[0].x,y:n[0].y},a=n[1].y,o=Math.round(n[1].x-h.x),l=Math.round(a-h.y),c=Math.max(Math.abs(o),Math.abs(l));if(e){const t={x:h.x+c,y:h.y+c},i={x:h.x-c,y:h.y-c};r.push(pt(t.x,i.y),pt(i.x,i.y),pt(i.x,t.y),pt(t.x,t.y))}else{const t={x:o>0?h.x+c:h.x-c,y:l>0?h.y+c:h.y-c};r.push(pt(h.x,h.y),pt(t.x,h.y),pt(t.x,t.y),pt(h.x,t.y))}return bt([s(r.map((t=>i.localToMap(t))))],i.spatialReference,i.doUnnormalization,!0)}function Mt(t,i,s,n){const r=i.mapToLocalMultiple(t);let a=null,o=null;if(s)a=r[0],o=r[1];else{const t=r[0],i=r[1],s=Math.round(i.x-t.x),e=Math.round(i.y-t.y),n=Math.max(Math.abs(s),Math.abs(e));a=pt(s>0?t.x+n/2:t.x-n/2,e>0?t.y+n/2:t.y-n/2),o=pt(Math.abs(s)>Math.abs(e)?a.x-n/2:a.x,Math.abs(s)>Math.abs(e)?a.y:a.y-n/2)}const l=i.localToMap(a),c=i.localToMap(o);if(h(l)||h(c))return null;i.doUnnormalization&&D([[l,c]],i.spatialReference);const u=yt(l,i.spatialReference),d=yt(c,i.spatialReference),p=j(i.spatialReference);let f=0;if(e(i.spatialReference))f=p*A(u,d,null);else{const t=a.x-o.x,i=a.y-o.y;f=p*Math.sqrt(t*t+i*i)*(n||1)}const m=new C({center:u,radius:f,radiusUnit:"meters",spatialReference:i.spatialReference});return bt(m.rings,m.spatialReference,!1)}class Ot{constructor(){this._isToolEditable=!0,this._manipulators=new a,this._nextManipulatorId=0,this._resourceContexts={manipulator3D:{}},this._attached=!1}set isToolEditable(t){this._isToolEditable=t}get length(){return this._manipulators.length}add(t,i=0){return this.addMany([t],i)[0]}addMany(t,i=0){return t.map((t=>{const s=this._nextManipulatorId++,e={id:s,manipulator:t,visibilityPredicate:i,attached:!1};return this._manipulators.add(e),this._attached&&this._updateManipulatorAttachment(e),s}))}remove(t){if("number"==typeof t){const i=t;for(let t=0;t<this._manipulators.length;t++)if(this._manipulators.getItemAt(t).id===i){const i=this._manipulators.splice(t,1)[0];return this._detachManipulator(i),i.id}return null}const i=t;for(let t=0;t<this._manipulators.length;t++)if(this._manipulators.getItemAt(t).manipulator===i){const i=this._manipulators.splice(t,1)[0];return this._detachManipulator(i),i.id}return null}removeAll(){this._manipulators.forEach((t=>{this._detachManipulator(t)})),this._manipulators.removeAll()}attach(){this._manipulators.forEach((t=>{this._updateManipulatorAttachment(t)})),this._attached=!0}detach(){this._manipulators.forEach((t=>{this._detachManipulator(t)})),this._attached=!1}destroy(){this._manipulators.forEach((({manipulator:t})=>{t.destroy&&t.destroy()})),this._manipulators.destroy(),this._resourceContexts=null}on(t,i){return this._manipulators.on(t,(t=>{i(t)}))}forEach(t){for(const i of this._manipulators.items)t(i)}some(t){return this._manipulators.items.some(t)}toArray(){const t=[];return this.forEach((i=>t.push(i.manipulator))),t}intersect(t,s){let e=null,n=Number.MAX_VALUE;return this._manipulators.forEach((({id:r,manipulator:h,attached:a})=>{if(!a||!h.interactive)return;const o=h.intersectionDistance(t,s);i(o)&&o<n&&(n=o,e={id:r,manipulator:h})})),e}findById(t){if(h(t))return null;for(const i of this._manipulators.items)if(t===i.id)return i.manipulator;return null}_updateManipulatorAttachment(t){this._isManipulatorItemVisible(t)?this._attachManipulator(t):this._detachManipulator(t)}_attachManipulator(t){t.attached||(t.manipulator.attach&&t.manipulator.attach(this._resourceContexts),t.attached=!0)}_detachManipulator(t){if(!t.attached)return;const i=t.manipulator;i.grabbing=!1,i.dragging=!1,i.hovering=!1,i.selected=!1,i.detach&&i.detach(this._resourceContexts),t.attached=!1}_isManipulatorItemVisible(t){return 2===t.visibilityPredicate||(this._isToolEditable?0===t.visibilityPredicate:1===t.visibilityPredicate)}}const kt=o.getLogger("esri.views.interactive.InteractiveToolBase");let St=class extends d{constructor(t){super(t),this.toolState="pending",this.completed=!1,this.manipulators=new Ot,this.updating=!1,this.automaticManipulatorSelection=!0,this._editableFlags=new Map([[1,!0],[0,!0]]),this._creationStartedResolver=p(),this._creationFinishedResolver=p()}get active(){return null!=this.view&&this.view.activeTool===this}set visible(t){this._set("visible",t),t||this.active&&(this.view.activeTool=null),this.attached&&(t?this._show():this._hide())}get editable(){return this.getEditableFlag(0)}set editable(t){this.setEditableFlag(0,t)}get attached(){return this._get("attached")}get created(){return"created"===this.toolState}get cursor(){return null}attach(){this.attached?kt.warn("Tool is already attached. Ignoring attach request."):(this.manipulators.attach(),this.onAttach(),this.visible&&this.onShow(),this._set("attached",!0))}detach(){this.attached?(this.visible&&this.onHide(),this.onDetach(),this.manipulators.detach(),this._set("attached",!1)):kt.error("Tool isn't currently attached. Ignoring detach request.")}activate(){h(this.view)?kt.error("Can't activate tool if view is not defined."):this.active?kt.warn("Tool is already active, ignoring activation request."):(K(this.view)&&this.view.focus(),this.onActivate())}deactivate(){this.active?this.onDeactivate():kt.warn("Tool is not active, ignoring deactivation request.")}handleInputEvent(t){this.attached?this.onInputEvent(t):kt.warn("handleInputEvent() called on detached tool")}handleInputEventAfter(t){this.attached?this.onInputEventAfter(t):kt.warn("handleInputEventAfter() called on detached tool")}destroy(){this.manipulators.destroy(),this._set("view",null),this._set("completed",!1)}setEditableFlag(t,i){this._editableFlags.set(t,i),this.manipulators.isToolEditable=this.internallyEditable,this._updateManipulatorAttachment(),0===t&&this.notifyChange("editable"),this.onEditableChange()}getEditableFlag(t){return this._editableFlags.get(t)}whenCreationStarted(){return this._creationStartedResolver.promise}when(){return this._creationFinishedResolver.promise}rejectCreation(t){"pending"!==this.toolState&&"creating"!==this.toolState||this._creationStartedResolver.resolve(this),this._creationFinishedResolver.reject(t)}onActivate(){}onDeactivate(){}onAttach(){}onDetach(){}onShow(){}onHide(){}onEditableChange(){}onInputEvent(t){}onInputEventAfter(t){}get internallyEditable(){return this.getEditableFlag(0)&&this.getEditableFlag(1)}startToolCreation(){if("pending"===this.toolState)return this._creationStartedResolver.resolve(this),void(this.toolState="creating");throw new Error(`Unexpected tool state ${this.toolState}`)}finishToolCreation(){switch(this.toolState){case"pending":this.startToolCreation();case"creating":this.created||this._creationFinishedResolver.resolve(this),this.toolState="created";break;case"created":break;default:throw new Error(`Unexpected tool state ${this.toolState}`)}}complete(){this.finishToolCreation(),this._set("completed",!0)}_show(){this._updateManipulatorAttachment(),this.onShow()}_hide(){this._updateManipulatorAttachment(),this.onHide()}_updateManipulatorAttachment(){this.attached&&this.visible?this.manipulators.attach():this.manipulators.detach()}};l([c()],St.prototype,"toolState",void 0),l([c({constructOnly:!0})],St.prototype,"view",void 0),l([c({readOnly:!0})],St.prototype,"active",null),l([c({value:!0})],St.prototype,"visible",null),l([c({value:!0})],St.prototype,"editable",null),l([c({value:!1,readOnly:!0})],St.prototype,"attached",null),l([c({readOnly:!0})],St.prototype,"created",null),l([c({readOnly:!0})],St.prototype,"completed",void 0),l([c({readOnly:!0})],St.prototype,"manipulators",void 0),l([c({readOnly:!0})],St.prototype,"updating",void 0),l([c()],St.prototype,"cursor",null),l([c()],St.prototype,"automaticManipulatorSelection",void 0),St=l([u("esri.views.interactive.InteractiveToolBase")],St);let It=class extends(M(f.EventedMixin(St))){constructor(t){super(t),this._graphic=null,this.defaultZ=0,this.geometryType=null,this.hasZ=!0,this.mode=null,this.snappingManager=null,this.snapToScene=!1}initialize(){this.internalGraphicsLayer=new k({listMode:"hide",internal:!0}),this.view.map.layers.add(this.internalGraphicsLayer),this.drawOperation=this.makeDrawOperation(),this.handles.add([this.drawOperation.on("vertex-add",(t=>this.onVertexAdd(t))),this.drawOperation.on("vertex-remove",(t=>this.onVertexRemove(t))),this.drawOperation.on("vertex-update",(t=>this.onVertexUpdate(t))),this.drawOperation.on("cursor-update",(t=>this.onCursorUpdate(t))),this.drawOperation.on("complete",(t=>this.onComplete(t)))]),this.complete()}destroy(){this.drawOperation=m(this.drawOperation),this._destroyAllVisualisations(),this.view.map.remove(this.internalGraphicsLayer),this.internalGraphicsLayer=m(this.internalGraphicsLayer),this._set("view",null)}get canRedo(){return this.drawOperation.canRedo}get canUndo(){return this.drawOperation.canUndo}set centered(t){this._set("centered",t),this._updateGraphic()}set enabled(t){this.drawOperation.interactive=t,this._set("enabled",t)}set forceUniformSize(t){this._set("forceUniformSize",t),this._updateGraphic()}get graphic(){return this._graphic}set graphicSymbol(t){this._set("graphicSymbol",t),i(this._graphic)&&(this._graphic.symbol=t)}get updating(){var t,i;return null!=(t=null==(i=this.drawOperation)?void 0:i.updating)&&t}completeCreateOperation(){this.drawOperation.complete()}onInputEvent(t){this.drawOperation.onInputEvent(t)}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo()}_createGraphic(t){this._graphic=new x({geometry:t,symbol:this.graphicSymbol}),this.internalGraphicsLayer.add(this._graphic),this.handles.add(this.initializeGraphic(this._graphic)),this.notifyChange("graphic"),this.handles.add(v((()=>{i(this._graphic)&&(this.internalGraphicsLayer.remove(this._graphic),this._graphic=m(this._graphic))})),Tt)}_destroyAllVisualisations(){this.handles.remove(_t.outline),this.handles.remove(_t.regularVertices),this.handles.remove(_t.activeVertex),this.handles.remove(Tt)}_getCreateOperationGeometry(t={operationComplete:!1}){if(null==this.drawOperation||0===this.drawOperation.numVertices)return null;const e=this.drawOperation.stagedVertex,n=this.drawOperation.committedVertices,r=n.slice();i(e)&&r.push(this.drawOperation.coordinateHelper.pointToArray(e));const h=i(e)?this.drawOperation.coordinateHelper.pointToArray(e):n.splice(-1)[0],a={regularVertices:null,activeVertex:null,full:null,outline:null},o=r.length,l=this.drawOperation.spatialReference,c="3d"===this.view.type&&"global"===this.view.viewingMode;switch(this.geometryType){case"point":a.regularVertices=n,a.activeVertex=h,a.full=this.drawOperation.coordinateHelper.arrayToPoint(r[0]);break;case"multipoint":a.regularVertices=n,a.activeVertex=h,o>0&&(a.full=function(t,i){return new T({points:t,spatialReference:i})}(r,l));break;case"polyline":a.regularVertices=n,a.activeVertex=h,o>0&&(a.full=wt([r],l,c));break;case"polygon":a.regularVertices=n,a.activeVertex=h,o>0&&(a.full=bt([r],l,c,!0));break;case"circle":if(o>0){const i=gt(this.view,r[0]);if(1===o&&t.operationComplete){const t=r[0],s=i.makeMapPoint(t[0]+Dt*this.view.resolution,t[1]);a.full=Mt([t,s],i,!0)}else 2===o&&(a.full=this.forceUniformSize?Mt(r,i,this.centered):function(t,i,e){const n=i.mapToLocalMultiple(t),r=n[0],h=n[1],a=Math.round(h.x-r.x),o=Math.round(h.y-r.y),l=pt(e?r.x:r.x+a/2,e?r.y:r.y+o/2),c=e?a:a/2,u=e?o:o/2,d=[],p=2*Math.PI/60;for(let t=0;t<60;t++){const i=Math.cos(t*p),s=Math.sin(t*p),e=pt(c*i+l.x,u*s+l.y);d.push(e)}return d.push(d[0]),bt([s(d.map((t=>i.localToMap(t))))],i.spatialReference,i.doUnnormalization,!1)}(r,i,this.centered))}break;case"rectangle":if(o>0){const i=gt(this.view,r[0]);if(1===o&&t.operationComplete){const t=r[0],s=i.makeMapPoint(t[0]+Dt*this.view.resolution,t[1]);a.full=xt([t,s],i,!0)}else 2===o&&(a.full=this.forceUniformSize?xt(r,i,this.centered):function(t,i,e){let n=i.mapToLocalMultiple(t);if(1===n.length){const t=48,i=n[0];n=[pt(i.x-t,i.y+t),pt(i.x+t,i.y-t),pt(i.x+t,i.y-t),pt(i.x-t,i.y+t)]}const r=[],h={x:n[0].x,y:n[0].y},a={x:n[1].x,y:n[1].y};if(e){const t=Math.round(a.x-h.x),i=Math.round(a.y-h.y);r.push(pt(h.x-t,h.y-i),pt(a.x,h.y-i),pt(a.x,a.y),pt(h.x-t,a.y))}else r.push(pt(h.x,h.y),pt(a.x,h.y),pt(a.x,a.y),pt(h.x,a.y));return bt([s(r.map((t=>i.localToMap(t))))],i.spatialReference,i.doUnnormalization,!0)}(r,i,this.centered))}break;default:return null}switch(this.geometryType){case"point":case"multipoint":break;case"polyline":case"polygon":o>1&&(a.outline=wt([r],l,c));break;case"circle":case"rectangle":i(a.full)&&"polygon"===a.full.type&&(a.outline=bt(a.full.rings,l,c))}return a}initializeGraphic(t){return null}onComplete(t){this._updateGraphic();let s=null;if(this.drawOperation.isCompleted){const t=this._getCreateOperationGeometry({operationComplete:!0});i(t)&&(s=new x({geometry:t.full,symbol:this.graphicSymbol,sourceLayer:this.internalGraphicsLayer,...this.graphicProperties}))}this.emit("complete",{graphic:s,...t})}onCursorUpdate(t){this._updateGraphic(),this.emit("cursor-update",t)}onDeactivate(){this.drawOperation.isCompleted||this.drawOperation.cancel()}onVertexAdd(t){this._updateGraphic(),this.emit("vertex-add",t)}onVertexRemove(t){this._updateGraphic(),this.emit("vertex-remove",t)}onVertexUpdate(t){this._updateGraphic(),this.emit("vertex-update",t)}_updateGraphic(){const t=this._getCreateOperationGeometry();h(t)?this._destroyAllVisualisations():(i(t.outline)?this.handles.add(this.onOutlineChanged(t.outline),_t.outline):this.handles.remove(_t.outline),i(t.regularVertices)?this.handles.add(this.onRegularVerticesChanged(t.regularVertices),_t.regularVertices):this.handles.remove(_t.regularVertices),i(t.activeVertex)?this.handles.add(this.onActiveVertexChanged(t.activeVertex),_t.activeVertex):this.handles.remove(_t.activeVertex),i(t.full)?h(this._graphic)?this._createGraphic(t.full):this._graphic.geometry=t.full:this.handles.remove(Tt))}};l([c({value:!0})],It.prototype,"centered",null),l([c({nonNullable:!0})],It.prototype,"defaultZ",void 0),l([c()],It.prototype,"drawOperation",void 0),l([c({value:!0})],It.prototype,"enabled",null),l([c({value:!0})],It.prototype,"forceUniformSize",null),l([c({constructOnly:!0})],It.prototype,"geometryType",void 0),l([c()],It.prototype,"graphic",null),l([c({constructOnly:!0})],It.prototype,"graphicProperties",void 0),l([c()],It.prototype,"graphicSymbol",null),l([c({constructOnly:!0})],It.prototype,"hasZ",void 0),l([c({constructOnly:!0})],It.prototype,"mode",void 0),l([c()],It.prototype,"snappingManager",void 0),l([c()],It.prototype,"snapToScene",void 0),l([c({readOnly:!0})],It.prototype,"type",void 0),l([c({readOnly:!0})],It.prototype,"updating",null),l([c({constructOnly:!0,nonNullable:!0})],It.prototype,"view",void 0),It=l([u("esri.views.draw.DrawGraphicTool")],It);const Tt="create-operation-graphic",_t={outline:"outline-visual",regularVertices:"regular-vertices-visual",activeVertex:"active-vertex-visual"};function Et(t){switch(t){case"point":case"polyline":case"polygon":case"multipoint":return t;case"circle":case"rectangle":return"segment";default:return null}}const Dt=48;class jt{constructor({grabbableForEvent:t}){this.events=new f,this.interactive=!0,this.selectable=!1,this.cursor=null,this.grabbable=!0,this.grabbableForEvent=t}intersectionDistance(t,i){return 0}attach(){}detach(){}}const Ct="click";function Vt(t,s){let e=null,n=null;return r=>{if("cancel"===r.action)return void(i(n)&&(n.execute({action:"cancel"}),e=null,n=null));const a={action:r.action,screenStart:r.start,screenEnd:r.screenPoint};"start"===r.action&&h(e)&&(e=new Xt,n=new Xt,s(t,e,n,r.pointerType,a)),i(e)&&e.execute(a),"end"===r.action&&i(e)&&(e=null,n=null)}}function zt(t,i){return t.events.on("drag",Vt(t,i))}function Rt(t,i){const s=[t.x,t.y,t.z],e=i,n=[Math.cos(e),Math.sin(e)],r=Math.sqrt(n[0]*n[0]+n[1]*n[1]);if(0===r)return null;n[0]/=r,n[1]/=r;const h=t=>{const i=(t.x-s[0])*n[0]+(t.y-s[1])*n[1];t.x=s[0]+i*n[0],t.y=s[1]+i*n[1]};return t=>(h(t.mapStart),h(t.mapEnd),t)}function At(t,s){let e=null;return n=>{if("start"===n.action&&(e=function(t,s,e){const n=t.geometry;if(h(n))return null;if("mesh"===n.type)return function(t,s,e,n){if(i(s.transform))return Ut(t,s,s.transform,e);if(!s.spatialReference.equals(e))return null;let r=0,h=0,a=0;return{move:(i,e,o)=>{const l=i-r,c=e-h,u=o-a;if(l||c||u){const d=s.origin.clone().offset(l,c,u);s.centerAt(d,{geographic:1===n}),t.notifyGeometryChanged(),r=i,h=e,a=o}}}}(t,n,s,e);const r=Pt(n,s),a=n.spatialReference;return h(r)?null:{move:(i,s,e)=>{const n=at(r.clone(),i,s,e);t.geometry=n.spatialReference.equals(a)?n:ht(n,a)}}}(t,n.mapStart.spatialReference,s)),h(e))return null;const r=n.mapEnd.x-n.mapStart.x,a=n.mapEnd.y-n.mapStart.y,o=n.mapEnd.z-n.mapStart.z;return e.move(r,a,o),{...n,translationX:r,translationY:a,translationZ:o}}}function Pt(t,i){return h(t)?null:t.spatialReference.equals(i)?t.clone():ht(t,i)}function Ut(t,s,e,n){const r=Pt(e.getOriginPoint(s.spatialReference),n),a=s.spatialReference;return h(r)?null:{move:(s,n,h)=>{const o=at(r.clone(),s,n,h);if(o.spatialReference.equals(a))e.origin=J(o.x,o.y,o.z);else{const t=ht(o,a);i(t)&&(e.origin=J(t.x,t.y,t.z))}t.notifyGeometryChanged()}}}function Gt(t,s){const e=t.map((t=>g(At(t,s)))).filter((t=>i(t)));return t=>{const i=t.mapEnd.x-t.mapStart.x,s=t.mapEnd.y-t.mapStart.y,n=t.mapEnd.z-t.mapStart.z;return e.forEach((i=>i(t))),{...t,translationX:i,translationY:s,translationZ:n}}}function Zt(t){return i(t.geometry)&&"mesh"===t.geometry.type?function(t,s){const e=i(s.transform)?s.transform.clone():null,n=s.vertexAttributes.clonePositional();return i=>(s.transform=e,s.vertexAttributes=n,t.notifyGeometryChanged(),i)}(t,t.geometry):function(t){const i=new Map;for(const s of["geometry"])i.set(s,n(t[s]));return s=>(i.forEach(((i,s)=>{t[s]=i})),s)}(t)}function Ft(t){const s=t.map((t=>g(Zt(t)))).filter((t=>i(t)));return t=>(s.forEach((i=>i(t))),t)}function Ht(){let t=0,i=0,s=0;return e=>{"start"===e.action&&(t=e.mapStart.x,i=e.mapStart.y,s=e.mapStart.z);const n=e.mapEnd.x-t,r=e.mapEnd.y-i,h=e.mapEnd.z-s;return t=e.mapEnd.x,i=e.mapEnd.y,s=e.mapEnd.z,{...e,mapDeltaX:n,mapDeltaY:r,mapDeltaZ:h,mapDeltaSpatialReference:e.mapStart.spatialReference}}}function qt(){let t=0,i=0;return s=>{"start"===s.action&&(t=s.screenStart.x,i=s.screenStart.y);const e=s.screenEnd.x-t,n=s.screenEnd.y-i;return t=s.screenEnd.x,i=s.screenEnd.y,{...s,screenDeltaX:e,screenDeltaY:n}}}function Lt(t,i){let s=null,e=0,n=0;return r=>{if("start"===r.action&&(s=t.toScreen(i),s.x<0||s.x>t.width||s.y<0||s.y>t.height?s=null:(e=r.screenStart.x-s.x,n=r.screenStart.y-s.y)),null==s)return null;const h=$(r.screenEnd.x-e,0,t.width),a=$(r.screenEnd.y-n,0,t.height),o=Q(h,a);return r.screenStart=s,r.screenEnd=o,r}}class Xt{constructor(){this.execute=()=>{}}next(t,s=new Xt){return i(t)&&(this.execute=e=>{const n=t(e);i(n)&&s.execute(n)}),s}}class Yt{constructor(){this.next=new Xt}createSnapDragEventPipelineStep({predicate:t=(()=>!0),cancel:s,snappingManager:e,snappingContext:n,updatingHandles:r}){if(h(e))return t=>t;let a=null,o=null;const l=()=>{a=y(a),e.doneSnapping(),i(o)&&o.frameTask.remove(),o=null};return s.next((t=>(l(),t))),this.next=new Xt,s=>{if(!t(s))return s;if(a=y(a),"start"===s.action){const t="3d"===e.view.type?e.view.resourceController.scheduler.registerTask(lt.SNAPPING):ct;o={context:new ot({editGeometryOperations:n.editGeometryOperations,elevationInfo:n.elevationInfo,pointer:n.pointer,vertexHandle:i(s.info)?s.info.handle:null,excludeFeature:n.excludeFeature,visualizer:n.visualizer}),originalPos:i(s.snapOrigin)?n.coordinateHelper.vectorToDehydratedPoint(s.snapOrigin):s.mapStart,frameTask:t}}if(i(o)){const t=o.context.coordinateHelper.vectorToDehydratedPoint(o.context.coordinateHelper.arrayToVector([o.originalPos.x,o.originalPos.y,o.originalPos.z]));t.x+=s.mapEnd.x-s.mapStart.x,t.y+=s.mapEnd.y-s.mapStart.y;const i=s.mapStart.x-o.originalPos.x,n=s.mapStart.y-o.originalPos.y,h={...s,action:"udpate"},l=o.context,c=e.update(t,o.context);if(s.mapEnd.x=c.x+i,s.mapEnd.y=c.y+n,"end"!==s.action){const s=o.frameTask;a=w((async r=>{const a=await s.schedule((()=>e.snap(t,l,r)),r);if(a.valid){const t=await s.schedule((()=>a.apply()),r);it(t,c)||(h.mapEnd.x=t.x+i,h.mapEnd.y=t.y+n,this.next.execute(h))}})),r.addPromise(a.promise)}}return"end"===s.action&&l(),s}}}let Bt=class extends(f.EventedMixin(O)){constructor(t){super(t),this._createOperationCompleted=!1,this._pointerDownStates=new Set,this._snappingPipeline=new Yt,this._snappingTask=null,this._stagedVertex=null,this.snapToSceneEnabled=null,h(t.elevationInfo)&&(this.elevationInfo={mode:t.hasZ?"absolute-height":"on-the-ground",offset:0})}initialize(){var t,i;this.coordinateHelper=st(this.hasZ,this.hasM,this.view.spatialReference);const s="3d"===this.view.type?null==(t=this.view)||null==(i=t.resourceController)?void 0:i.scheduler:null;this._frameTask=s?s.registerTask(lt.SNAPPING):ct;const e="viewingMode"in this.view.state?this.view.state.viewingMode:2;this._editGeometryOperations=new et(new nt("segment"===this.geometryType||"multipoint"===this.geometryType?"polyline":this.geometryType,this.coordinateHelper,e)),this._activeComponent=new rt(this.spatialReference,e),this._editGeometryOperations.data.components.push(this._activeComponent),this.handles.add(this._editGeometryOperations.on(["vertex-add","vertex-update","vertex-remove"],(t=>{const i=t.vertices.map((t=>({componentIndex:0,vertexIndex:t.index,coordinates:this.coordinateHelper.vectorToArray(t.pos)}))),s=i.map((t=>t.coordinates));switch(t.type){case"vertex-add":this.emit(t.type,{...t,added:s,vertices:i});break;case"vertex-update":this.emit(t.type,{...t,updated:s,vertices:i});break;case"vertex-remove":this.emit(t.type,{...t,removed:s,vertices:i})}}))),this._manipulator=new jt({grabbableForEvent:t=>"click"!==this.drawingMode||"touch"===t.pointerType&&this._snappingEnabled&&1===this._pointerDownStates.size}),this.manipulators.add(this._manipulator),this._manipulator.grabbable="point"!==this.geometryType,this.handles.add([this._createManipulatorDragPipeline(this._manipulator),this._manipulator.events.on("immediate-click",(t=>this._onImmediateClick(t))),this._manipulator.events.on("immediate-double-click",(t=>this._onImmediateDoubleClick(t)))])}destroy(){this._editGeometryOperations=m(this._editGeometryOperations),this._frameTask=b(this._frameTask)}get _snappingEnabled(){return i(this.snappingManager)&&this.snappingManager.options.effectiveEnabled}get canRedo(){return this._editGeometryOperations.canRedo}get canUndo(){return this._editGeometryOperations.canUndo}get committedVertices(){return this._activeComponent.vertices.map((t=>this.coordinateHelper.vectorToArray(t.pos)))}set drawingMode(t){this._set("drawingMode",null!=t?t:Ct)}get hasStagedVertex(){return i(this._stagedVertex)}get interactive(){return this._manipulator.interactive}set interactive(t){this._manipulator.interactive=t}get isCompleted(){return this._createOperationCompleted}get numCommittedVertices(){return this._activeComponent.vertices.length}get numVertices(){return i(this._stagedVertex)?this._activeComponent.vertices.length+1:this._activeComponent.vertices.length}get spatialReference(){return this.view.spatialReference}get stagedVertex(){return this._stagedVertex}set stagedVertex(t){if(h(t))this.discardStagedVertex();else if(!i(this._stagedVertex)||!it(this._stagedVertex,t)){if(h(this._stagedVertex))this._stagedVertex=n(t);else{if(it(this._stagedVertex,t))return;this._stagedVertex.x=t.x,this._stagedVertex.y=t.y,this._stagedVertex.z=t.z,this._stagedVertex.m=t.m,this._stagedVertex.hasZ=t.hasZ,this._stagedVertex.hasM=t.hasM,this._stagedVertex.spatialReference=t.spatialReference}this.emit("cursor-update",{updated:null,vertices:[{componentIndex:0,vertexIndex:this._activeComponent.vertices.length,coordinates:this.coordinateHelper.pointToArray(t)}],operation:"apply",type:"vertex-update"})}}get updating(){return this.updatingHandles.updating}get vertices(){const t=this.committedVertices;return i(this._stagedVertex)&&t.push(this.coordinateHelper.pointToArray(this._stagedVertex)),t}cancel(){this.complete({aborted:!0})}commitStagedVertex(){if(this._snappingTask=y(this._snappingTask),i(this._stagedVertex)){const t=this._stagedVertex;this._stagedVertex=null,this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(t))}}complete(t){const s=t&&t.aborted||!1;y(this._snappingTask),i(this.snappingManager)&&this.snappingManager.doneSnapping(),"segment"===this.geometryType||"point"===this.geometryType?this.commitStagedVertex():this.discardStagedVertex(),this._createOperationCompleted=!("multipoint"===this.geometryType&&0===this.numVertices||"polyline"===this.geometryType&&this.numVertices<2||"polygon"===this.geometryType&&this.numVertices<3),(this.isCompleted||s)&&this.emit("complete",{vertices:this.vertices.map(((t,i)=>({componentIndex:0,vertexIndex:i,coordinates:t}))),aborted:s,type:"complete"})}discardStagedVertex(){this._stagedVertex=null}onInputEvent(t){switch(t.type){case"pointer-down":this._pointerDownStates.add(t.pointerId);break;case"pointer-up":this._pointerDownStates.delete(t.pointerId)}switch(t.type){case"pointer-move":return this._onPointerMove(t);case"hold":return this._onHold(t)}}redo(){this._editGeometryOperations.redo()}undo(){i(this.snappingManager)&&this.snappingManager.doneSnapping(),this._editGeometryOperations.undo()}_closeOnClickVertexIndex(t){const i=this._activeComponent;if("polygon"===this.geometryType&&i.vertices.length>2){if(this._vertexWithinPointerDistance(i.vertices[0].pos,t))return 0;if(this._vertexWithinPointerDistance(i.vertices[i.vertices.length-1].pos,t))return i.vertices.length-1}return null}_createManipulatorDragPipeline(t){switch(this.drawingMode){case"click":return this._createManipulatorDragPipelineClick(t);case"freehand":return this._createManipulatorDragPipelineFreehand(t);case"hybrid":return this._createManipulatorDragPipelineHybrid(t)}}_createManipulatorDragPipelineClick(t){return zt(t,((t,s,e,n)=>{const r="touch"===n&&this._snappingEnabled;!this.isCompleted&&r&&(s.next(this._screenToMapDragEventStep()).next((t=>("start"===t.action&&(this.stagedVertex=t.mapStart,("segment"===this.geometryType||r&&0===this.numVertices)&&this.commitStagedVertex()),t))).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>r,cancel:e,snappingManager:this.snappingManager,snappingContext:new ot({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:n,visualizer:this.snappingVisualizer}),updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next((t=>(r&&(this.stagedVertex=t.mapEnd,"end"===t.action&&this.commitStagedVertex()),t))).next((t=>("end"===t.action&&("segment"!==this.geometryType&&"point"!==this.geometryType||this.complete()),t))),e.next((()=>{r&&i(this.snappingManager)&&this.snappingManager.doneSnapping()})))}))}_createManipulatorDragPipelineFreehand(t){return zt(t,((t,i)=>{this.isCompleted||i.next(this._screenToMapDragEventStep()).next((t=>("start"===t.action&&(h(this.stagedVertex)&&(this.stagedVertex=t.mapStart),"segment"===this.geometryType&&this.commitStagedVertex()),t))).next((t=>{switch(t.action){case"start":case"update":this.stagedVertex=t.mapEnd,"polygon"!==this.geometryType&&"polyline"!==this.geometryType||this.commitStagedVertex();break;case"end":this.complete()}return t}))}))}_createManipulatorDragPipelineHybrid(t){return zt(t,((t,i)=>{this.isCompleted||i.next(this._screenToMapDragEventStep()).next((t=>("start"===t.action&&(h(this.stagedVertex)&&(this.stagedVertex=t.mapStart),this.commitStagedVertex()),t))).next((t=>{switch(t.action){case"start":case"update":this.stagedVertex=t.mapEnd,"polygon"!==this.geometryType&&"polyline"!==this.geometryType||this.commitStagedVertex();break;case"end":"segment"!==this.geometryType&&"point"!==this.geometryType||this.complete()}return t}))}))}_getDrawSurface(){if(h(this.elevationDrawSurface))return this.drawSurface;if(!this.coordinateHelper.hasZ)return this.elevationDrawSurface.defaultZ=null,this.elevationDrawSurface;let t=this.defaultZ,s=!1;return i(this.elevationInfo)&&"absolute-height"===this.elevationInfo.mode&&(s=!0),i(this.snapToSceneEnabled)&&(s=this.snapToSceneEnabled),i(this.elevationInfo)&&"on-the-ground"===this.elevationInfo.mode&&(s=!1),("segment"===this.geometryType||"polygon"===this.geometryType)&&this._activeComponent.vertices.length>0&&(t=this.coordinateHelper.getZ(this._activeComponent.vertices[0].pos),s=!1),s?this.drawSurface:(this.elevationDrawSurface.defaultZ=t,this.elevationDrawSurface)}_mapToScreen(t){return this._getDrawSurface().mapToScreen(t)}_onHold(t){y(this._snappingTask),"click"===this.drawingMode&&"touch"===t.pointerType&&this._snappingEnabled&&(this.stagedVertex=t.mapPoint),t.stopPropagation()}_onImmediateClick(t){if(this._manipulator.dragging)return;const s=this._activeComponent,e=this._closeOnClickVertexIndex(t.screenPoint);if(i(e))return t.stopPropagation(),this.discardStagedVertex(),void this.complete();const n=this._screenToMap(t.screenPoint);if(i(n))switch(this.drawingMode){case"freehand":"point"===this.geometryType&&(this.hasStagedVertex?this.commitStagedVertex():this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(n)),this.complete());break;case"click":case"hybrid":this._snappingTask=y(this._snappingTask),this.hasStagedVertex?this.commitStagedVertex():this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(n)),("point"===this.geometryType||"segment"===this.geometryType&&2===s.vertices.length||"segment"===this.geometryType&&"hybrid"===this.drawingMode&&1===s.vertices.length)&&this.complete()}t.stopPropagation()}_onImmediateDoubleClick(t){this._manipulator.dragging||"point"===this.geometryType||(this.complete(),t.stopPropagation())}_onPointerMove(t){if(y(this._snappingTask),this._manipulator.dragging||this._pointerDownStates.has(t.pointerId)||this._manipulator.grabbing||!this._manipulator.interactive)return;const s=Q(t.x,t.y),e=this._closeOnClickVertexIndex(s);if(i(e)){this.discardStagedVertex();const t={componentIndex:0,vertexIndex:e,coordinates:this.coordinateHelper.vectorToArray(this._activeComponent.vertices[e].pos)};this.emit("cursor-update",{updated:null,vertices:[t],operation:"apply",type:"vertex-update"})}else{const e=this._screenToMap(s);if(this._manipulator.cursor=i(e)?"crosshair":null,i(e))if(i(this.snappingManager)){const i=this.snappingManager,s=new ot({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:t.pointerType,visualizer:this.snappingVisualizer});this.stagedVertex=i.update(e,s),this._snappingTask=w((async t=>{const n=await this._frameTask.schedule((()=>i.snap(e,s,t)),t);n.valid&&await this._frameTask.schedule((()=>{this.stagedVertex=n.apply()}),t)})),this.updatingHandles.addPromise(this._snappingTask.promise)}else this.stagedVertex=e}t.stopPropagation()}_screenToMap(t){return this._getDrawSurface().screenToMap(t)}_screenToMapDragEventStep(){let t=null;return s=>{if("start"===s.action&&(t=this._screenToMap(s.screenStart)),h(t))return null;const e=this._screenToMap(s.screenEnd);return i(e)?{...s,mapStart:t,mapEnd:e}:null}}_vertexWithinPointerDistance(t,s){const e=this._mapToScreen(this.coordinateHelper.vectorToDehydratedPoint(t));return!!i(e)&&function(t,i){const s=t.x-i.x,e=t.y-i.y;return s*s+e*e<=25}(e,s)}};l([c()],Bt.prototype,"defaultZ",void 0),l([c({value:Ct})],Bt.prototype,"drawingMode",null),l([c({constructOnly:!0})],Bt.prototype,"elevationDrawSurface",void 0),l([c({constructOnly:!0})],Bt.prototype,"elevationInfo",void 0),l([c({constructOnly:!0})],Bt.prototype,"geometryType",void 0),l([c({constructOnly:!0})],Bt.prototype,"hasM",void 0),l([c({constructOnly:!0})],Bt.prototype,"hasZ",void 0),l([c({constructOnly:!0})],Bt.prototype,"manipulators",void 0),l([c({constructOnly:!0})],Bt.prototype,"drawSurface",void 0),l([c({constructOnly:!0})],Bt.prototype,"snappingManager",void 0),l([c({constructOnly:!0})],Bt.prototype,"snappingVisualizer",void 0),l([c()],Bt.prototype,"snapToSceneEnabled",void 0),l([c({readOnly:!0})],Bt.prototype,"updating",null),l([c({constructOnly:!0})],Bt.prototype,"view",void 0),Bt=l([u("esri.views.draw.DrawOperation")],Bt);class Nt{constructor(t,i,s,e=null){this.elevationInfo=t,this.defaultZ=i,this.view=s,this.excludeGraphics=e}screenToMap(t){if(i(this.defaultZ))return this.view.sceneIntersectionHelper.intersectElevationFromScreen(tt(t.x,t.y),this.elevationInfo,this.defaultZ,this.excludeGraphics);const s=this.view.sceneIntersectionHelper.intersectElevationFromScreen(tt(t.x,t.y),this.elevationInfo,0,this.excludeGraphics);return i(s)&&(s.z=void 0),s}mapToScreen(t){const i=ut(t.x,t.y,V(this.view,t,this.elevationInfo),t.spatialReference);return this.view.toScreen(i)}}class $t{constructor(t,i,s=[]){this.view=t,this.elevationInfo=i,this.exclude=s}screenToMap(t){const s=this.view.toMap(t,{exclude:this.exclude});return i(s)&&(s.z=z(s,this.view,this.elevationInfo)),s}mapToScreen(t){let s=t;return i(this.elevationInfo)&&(s=ut(t.x,t.y,V(this.view,t,this.elevationInfo),t.spatialReference)),this.view.toScreen(s)}}class Wt{constructor(t){this.view=t,this.screenToMap=i=>t.toMap(i),this.mapToScreen=i=>t.toScreen(i)}}export{qt as D,Bt as M,It as O,Gt as S,Lt as a,Xt as b,Wt as c,St as d,Yt as e,zt as m,$t as n,Rt as p,Ht as q,Nt as r,Ft as v,Et as x,At as y,Zt as z}