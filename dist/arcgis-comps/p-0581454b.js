import{c as t,e as i,d as s,i as p,p as e,I as r,_ as o,A as a,b as m,Q as h,a as j,g as d}from"./p-e58503d5.js";import{l as c}from"./p-728f106f.js";import{h as n}from"./p-54330161.js";import{c as f}from"./p-fb38a9d0.js";import{r as l}from"./p-a9a30646.js";import{j as b}from"./p-d1a9be2d.js";import{m as u}from"./p-1eb62563.js";import{c as y}from"./p-7d081d01.js";import{n as g}from"./p-56ca6f1f.js";import{i as v}from"./p-b8b8ba99.js";import{r as w}from"./p-f7106e47.js";import{d as x}from"./p-f971b161.js";import{t as I}from"./p-35dda696.js";import{i as D}from"./p-6d6923ed.js";import{S as P}from"./p-e7c8290e.js";import{u as V}from"./p-ae614024.js";import{u as E}from"./p-a63f7978.js";import{i as R}from"./p-07ab8db5.js";import"./p-53bb6ab4.js";import"./p-efbca0ca.js";import"./p-b79fcce3.js";import"./p-c048b814.js";import"./p-93765525.js";import"./p-765e6c28.js";import"./p-8747982c.js";import"./p-8bc9b36a.js";import"./p-7a658388.js";import"./p-e273719b.js";import"./p-74de0937.js";import"./p-2f398ed1.js";import"./p-d3105731.js";import"./p-f94762ac.js";import"./p-ea916a39.js";import"./p-8a919d07.js";import"./p-01e5a461.js";import"./p-c93d2280.js";import"./p-ccdb8e80.js";import"./p-fea9512d.js";import"./p-7731c620.js";import"./p-5d962998.js";import"./p-6484267b.js";import"./p-400ca3dc.js";import"./p-9b7a2176.js";import"./p-e654504b.js";import"./p-0eb619a6.js";import"./p-4d17d2cd.js";import"./p-b5b00e38.js";import"./p-e94b450b.js";import"./p-1189fa83.js";import"./p-37058f88.js";import"./p-3e39c093.js";import"./p-7a5bfd29.js";import"./p-afac6fb2.js";import"./p-ca295674.js";import"./p-41f2b2dd.js";import"./p-612a2c14.js";import"./p-d443df87.js";import"./p-7ca40eac.js";import"./p-9087b4d3.js";import"./p-c1cd5521.js";import"./p-ca4492df.js";import"./p-9d34911e.js";import"./p-182bb5be.js";import"./p-db87794e.js";import"./p-2db4840f.js";import"./p-bba8b671.js";import"./p-5e833dfc.js";import"./p-a131049b.js";import"./p-a2324023.js";import"./p-dc852195.js";import"./p-ff2962f5.js";import"./p-da9e7ba9.js";import"./p-a8f0aa27.js";import"./p-4a96de15.js";import"./p-5032dfbd.js";import"./p-a87cccba.js";import"./p-dae095dd.js";import"./p-0e784e4d.js";import"./p-dbdf15fc.js";import"./p-e0d9ff4c.js";import"./p-08e5f531.js";import"./p-dfc6337f.js";import"./p-9f1c2d50.js";import"./p-6b2eb7a7.js";import"./p-889f7a78.js";import"./p-1f81b35d.js";import"./p-81b9df84.js";import"./p-5ce39624.js";import"./p-e9bae5e9.js";import"./p-b0565d49.js";import"./p-51a17e75.js";import"./p-d208934e.js";import"./p-480e5606.js";import"./p-22c9f19c.js";import"./p-c096b5df.js";import"./p-da33e926.js";import"./p-a24f7752.js";import"./p-4a6dc5e4.js";import"./p-6a92ecb9.js";import"./p-1ab449fc.js";import"./p-a6c8fb32.js";import"./p-0edb3309.js";import"./p-e8160b60.js";import"./p-2e8ad983.js";import"./p-e3270d48.js";import"./p-e44bd0a6.js";import"./p-fe68aab5.js";import"./p-c6970847.js";import"./p-de86b3c9.js";import"./p-37d3434c.js";import"./p-120b7410.js";import"./p-b1eff69d.js";import"./p-612de336.js";import"./p-91fe06d4.js";import"./p-ab0e9273.js";import"./p-15a9486c.js";import"./p-2ae44317.js";import"./p-9f58a277.js";import"./p-9e860e7b.js";import"./p-f3659a34.js";import"./p-ca657fcf.js";import"./p-b312c1fd.js";import"./p-b8beb0d3.js";import"./p-2a99994a.js";import"./p-76f37e40.js";import"./p-eee9ef50.js";import"./p-6ded4c02.js";import"./p-1e473dab.js";import"./p-d1d9dbe4.js";import"./p-d57f9971.js";import"./p-b9aa4901.js";import"./p-e6fe5d89.js";import"./p-56ed1c7a.js";import"./p-746a9d8f.js";import"./p-db4d63dc.js";import"./p-0bb41218.js";import"./p-1c2ff3a7.js";import"./p-e3500fdc.js";import"./p-0bb84768.js";import"./p-1a7268a2.js";import"./p-2d0c34e5.js";import"./p-025c0c8e.js";import"./p-47e1bd73.js";import"./p-b392deaf.js";import"./p-9790d1b4.js";import"./p-eec31d91.js";import"./p-e49308c6.js";import"./p-50ff864e.js";import"./p-19bc1e3d.js";import"./p-db566ae7.js";import"./p-1ccb0bf6.js";import"./p-77b9a0fc.js";import"./p-9b76ac50.js";import"./p-3a6cfd25.js";import"./p-a2b6db85.js";import"./p-2e5dd2d0.js";import"./p-1676d4c7.js";import"./p-09dd2137.js";import"./p-ad14ca1b.js";import"./p-4414d64f.js";import"./p-a617738c.js";import"./p-b9c93bb2.js";import"./p-6fe4db61.js";import"./p-97ec6ae5.js";import"./p-c232e25f.js";import"./p-6448f4dc.js";import"./p-75cd09f2.js";import"./p-285c6a34.js";import"./p-cd36fe2a.js";import"./p-c0f84cd3.js";import"./p-8925cd73.js";import"./p-237460e0.js";import"./p-f94ceb31.js";import"./p-dc15ecc1.js";import"./p-0923eebd.js";import"./p-4019eec3.js";import"./p-8acbca5b.js";import"./p-b05e75b2.js";import"./p-c5443b47.js";import"./p-e991a11e.js";import"./p-7a68337e.js";import"./p-c2152437.js";import"./p-db63fa0e.js";import"./p-e285e8f3.js";const S=t.getLogger("esri.views.2d.layers.imagery.ImageryGraphicsView2D");let q=class extends e{constructor(){super(...arguments),this.attached=!1,this.container=new g,this.updateRequested=!1,this._graphicsView=null,this._projectFullExtentPromise=null,this._dataParameters={exportParametersVersion:0,extents:[],tileResolution:0,time:""},this.type="Graphics",this._graphics=new y,this._updateGraphics=r((async(t,i)=>{if(!t.stationary)return;const s=t.state,p=new o({xmin:s.extent.xmin,ymin:s.extent.ymin,xmax:s.extent.xmax,ymax:s.extent.ymax,spatialReference:s.spatialReference}),[e,r]=t.state.size,m={};m.timeExtent=this.timeExtent,m.requestAsImageElement=!1,m.signal=i,null==this._projectFullExtentPromise&&(this._projectFullExtentPromise=this._getProjectedFullExtent(p.spatialReference));const h="vector-field"===this.layer.renderer.type?this.layer.renderer.symbolTileSize:50,j=await this._projectFullExtentPromise,{extent:d,resolution:c,width:n,height:f}=u(p,e,r,h,j),l=await this.layer.fetchImage(d,n,f,m),b=this.layer.renderer;if("vector-field"===b.type){const i=l.pixelData.pixelBlock,s=b.sizeVariables[0];!a(i)||s.minDataValue&&s.maxDataValue||(s.minDataValue=i.statistics[0].minValue,s.maxDataValue=i.statistics[0].maxValue),this._pixelData={extent:d,pixelBlock:i};const p=d.clone().normalize(),e={exportParametersVersion:this.layer.exportImageServiceParameters.version,extents:p,tileResolution:c,time:JSON.stringify(this.timeExtent||"")},r=this._canReuseVectorFieldData(e)?this._dataParameters.extents:[],o=await b.getGraphicsFromPixelData(l.pixelData,"vector-uv"===this.layer.rasterInfo.dataType,r);if(r.length){const t=this._graphics.items.filter((t=>a(t.geometry)&&r.some((i=>i.intersects(t.geometry)))&&!p.some((i=>i.intersects(t.geometry)))));this._graphics.removeMany(t),this._graphics.addMany(o)}else this._graphics.set("items",o);this._graphicsView.update(t),this._dataParameters=e}}))}destroy(){this.attached&&(this.detach(),this.attached=!1),this.updateRequested=!1}get updating(){return!this.attached||this.isUpdating()}update(t){this._updateGraphics(t).catch((t=>{m(t)||S.error(t)}))}hitTest(t,i){const s=this.view.toMap(f(t,i));return Promise.resolve(new n({attributes:{},geometry:s,layer:this.layer}))}attach(){this._graphicsView=new w({view:this.view,graphics:this._graphics,requestUpdateCallback:()=>this.requestUpdate(),container:new v(this.view.featuresTilingScheme)}),this.attached=!0}detach(){this._graphics.destroy(),this._graphicsView.destroy(),this.container.removeChild(this._graphicsView.container),this._graphicsView=null}install(t){this.container.addChild(this._graphicsView.container),t.addChild(this.container)}uninstall(t){this.container.removeChild(this._graphicsView.container),t.removeChild(this.container)}isUpdating(){return this._graphicsView.updating||this.updateRequested}getPixelData(){return this.updating?null:this._pixelData}redraw(){}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}async _getProjectedFullExtent(t){try{return await b(this.layer.fullExtent,t)}catch(i){try{const i=(await h(this.layer.url,{query:{option:"footprints",outSR:t.wkid||JSON.stringify(t.toJSON()),f:"json"}})).data.featureCollection.layers[0].layerDefinition.extent;return i?o.fromJSON(i):null}catch{return null}}}_canReuseVectorFieldData(t){const i=this._dataParameters.exportParametersVersion===t.exportParametersVersion,s=this._dataParameters.time===t.time,p=Math.abs(this._dataParameters.tileResolution-t.tileResolution)/t.tileResolution<.01,e=this._dataParameters.extents.some((i=>t.extents.some((t=>i.intersects(t)))));return i&&s&&p&&e}};i([s()],q.prototype,"attached",void 0),i([s()],q.prototype,"container",void 0),i([s()],q.prototype,"layer",void 0),i([s()],q.prototype,"timeExtent",void 0),i([s()],q.prototype,"view",void 0),i([s()],q.prototype,"updateRequested",void 0),i([s()],q.prototype,"updating",null),i([l({graphics:"Graphics"})],q.prototype,"type",void 0),q=i([p("esri.views.2d.layers.imagery.ImageryGraphicsView2D")],q);const U=q,k=t.getLogger("esri.views.2d.layers.imagery.ImageryView2D");let B=class extends e{constructor(){super(...arguments),this.attached=!1,this.container=new g,this.updateRequested=!1,this.type="Imagery",this._bitmapView=null}destroy(){this.attached&&(this.detach(),this.attached=!1),this.updateRequested=!1}get updating(){return!this.attached||this.isUpdating()}update(t){this.strategy.update(t).catch((t=>{m(t)||k.error(t)}))}detach(){this.strategy.destroy(),this._bitmapView.removeAllChildren(),this.container.removeAllChildren()}hitTest(t,i){const s=this.view.toMap(f(t,i));return Promise.resolve(new n({attributes:{},geometry:s,layer:this.layer}))}attach(){const t=this.layer.version>=10,i=this.layer.version>=10.1?this.layer.imageMaxHeight:2048,s=this.layer.version>=10.1?this.layer.imageMaxWidth:2048;this._bitmapView=new I,this.strategy=new P({container:this._bitmapView,imageNormalizationSupported:t,imageMaxHeight:i,imageMaxWidth:s,fetchSource:this._fetchImage.bind(this),requestUpdate:()=>this.requestUpdate()}),this.attached=!0}install(t){this.container.addChild(this._bitmapView),t.addChild(this.container)}uninstall(t){this.container.removeChild(this._bitmapView),t.removeChild(this.container)}redraw(){this.strategy.updateExports((t=>{t.source instanceof HTMLImageElement?t.requestRender():this.layer.applyRenderer({pixelBlock:t.source.pixelBlock}).then((i=>{const s=t.source;s.pixelBlock=i.pixelBlock,s.filter=t=>this.layer.applyFilter(t),this.container.requestRender()}))}))}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}isUpdating(){return this.strategy.updating||this.updateRequested}getPixelData(){if(this.updating)return null;const t=this.strategy.bitmaps;if(1===t.length&&t[0].source)return{extent:t[0].source.extent,pixelBlock:t[0].source.originalPixelBlock};if(t.length>1){const i=this.view.extent,s=t.map((t=>t.source)).filter((t=>t.extent&&t.extent.intersects(i))).map((t=>({extent:t.extent,pixelBlock:t.originalPixelBlock}))),p=x(s,i);return a(p)?{extent:p.extent,pixelBlock:p.pixelBlock}:null}return null}_fetchImage(t,i,s,p){return(p=p||{}).timeExtent=this.timeExtent,p.requestAsImageElement=!0,this.layer.fetchImage(t,i,s,p).then((t=>t.imageElement?t.imageElement:this.layer.applyRenderer(t.pixelData,{signal:p.signal}).then((i=>{const s=new D(i.pixelBlock,i.extent.clone(),t.pixelData.pixelBlock);return s.filter=t=>this.layer.applyFilter(t),s}))))}};i([s()],B.prototype,"attached",void 0),i([s()],B.prototype,"container",void 0),i([s()],B.prototype,"layer",void 0),i([s()],B.prototype,"strategy",void 0),i([s()],B.prototype,"timeExtent",void 0),i([s()],B.prototype,"view",void 0),i([s()],B.prototype,"updateRequested",void 0),i([s()],B.prototype,"updating",null),i([l({imagery:"Imagery"})],B.prototype,"type",void 0),B=i([p("esri.views.2d.layers.imagery.ImageryView2D")],B);const G=B;let M=class extends(V(R(c(E)))){constructor(){super(...arguments),this._exportImageVersion=-1}initialize(){this.handles.add([j(this,["layer.blendMode","layer.effects"],(t=>{this.subview&&(this.subview.container.blendMode=t)}),!0),j(this,"layer.effect",(t=>{this.subview&&(this.subview.container.effect=t)}),!0)])}get pixelData(){return this.updating?null:this.subview.getPixelData()}get updating(){return!(this.subview&&!this.subview.updating)}hitTest(t,i){return this.suspended||!this.subview?Promise.resolve(null):this.subview.hitTest(t,i)}update(t){var i;null==(i=this.subview)||i.update(t)}attach(){this.layer.increaseRasterJobHandlerUsage(),this._setSubView(),this.handles.add([j(this,"layer.exportImageServiceParameters.version",(t=>{this._exportImageVersion!==t&&(this._exportImageVersion=t,this.requestUpdate())})),this.watch("timeExtent",(()=>{this.subview.timeExtent=this.timeExtent,this.requestUpdate()})),this.layer.on("redraw",(()=>this.subview.redraw())),d(this.layer,"renderer",(()=>this._setSubView()))],"imagerylayerview-update")}detach(){this.layer.decreaseRasterJobHandlerUsage(),this.subview.destroy(),this.handles.remove("imagerylayerview-update"),this._exportImageVersion=-1}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}async doRefresh(){this.requestUpdate()}isUpdating(){return!this.subview||!this.suspended&&this.subview.isUpdating()}_setSubView(){var t;let i="Imagery";var s,p;"vector-field"===(null==(t=this.layer.renderer)?void 0:t.type)&&"lerc"===this.layer.format&&(i="Graphics"),this.subview&&this.subview.type===i||(null==(s=this.subview)||s.uninstall(this.container),null==(p=this.subview)||p.destroy(),this.subview="Imagery"===i?new G({layer:this.layer,view:this.view,timeExtent:this.timeExtent}):new U({layer:this.layer,view:this.view,timeExtent:this.timeExtent}),this.subview.attach(),this.subview.install(this.container),this.subview.container.blendMode=this.layer.blendMode,this.subview.container.effect=this.layer.effect),this.requestUpdate()}};i([s()],M.prototype,"pixelData",null),i([s({readOnly:!0})],M.prototype,"updating",null),i([s()],M.prototype,"subview",void 0),M=i([p("esri.views.2d.layers.ImageryLayerView2D")],M);const _=M;export default _;