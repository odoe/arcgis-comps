import{as as t,fs as e,W as s,fr as i,fm as n,cf as r,ch as o,fv as h,ca as l,s as a,fN as u,fq as c,cg as d,fw as p,ci as y,fu as f,fK as m,fE as b,jA as v,fF as g,fC as w,h$ as j,fn as x,jB as S,b$ as V,ft as R,da as N,gz as q,jC as P,fH as _,dr as M,jD as L,g as T,jE as C,jF as I,jG as D,H as A,aH as W,eZ as B,jH as k,e as z,d as F,i as U,a6 as O,aT as E,j as G,B as $,h9 as H,e5 as J,e6 as Z,e7 as K,i1 as Q,aG as Y,ie as X,ec as tt,u as et,e_ as st,cY as it,i8 as nt,iu as rt,aL as ot}from"./p-7b6f6c18.js";import{e as ht,n as lt,a as at}from"./p-01158f1c.js";import{r as ut,c as ct,s as dt,v as pt,A as yt,b as ft,n as mt}from"./p-54add8b0.js";import{e as bt,h as vt,r as gt,i as wt,f as jt,u as xt,P as St,C as Vt,d as Rt,l as Nt}from"./p-3d69ec35.js";import{N as qt}from"./p-229324a1.js";import"./p-227a5838.js";import"./p-2794293b.js";import"./p-207b5a2e.js";import"./p-bb20f481.js";function Pt(e){return t(`esri/libs/vxl/${e}`)}function _t(t=Bt){return[t[0],t[1],t[2],t[3]]}function Mt(t,e=_t()){return Lt(t[0],t[1],t[2],t[3],e)}function Lt(t,e,s,i,n=_t()){return n[0]=t,n[1]=e,n[2]=s,n[3]=i,n}const Tt=r();function Ct(t,s,i,n){return e(Tt,s,t),function(t,e,s){const i=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],n=Math.abs(i-1)>1e-5&&i>1e-12?1/Math.sqrt(i):1;return s[0]=e[0]*n,s[1]=e[1]*n,s[2]=e[2]*n,s[3]=-(s[0]*t[0]+s[1]*t[1]+s[2]*t[2]),s}(i,Tt,n)}function It(t,e,s){return Wt(t,e.origin,e.vector,0,s)}function Dt(t,e,s){return Wt(t,e.origin,e.vector,1,s)}function At(t,e){return function(t,e){return i(t,e)+t[3]}(t,e)>=0}function Wt(t,e,s,r,h){const a=i(t,s);if(0===a)return!1;let u=-(i(t,e)+t[3])/a;return 1&r&&(u=l(u,0,1)),!(!(4&r)&&u<0||!(8&r)&&u>1||(n(h,e,o(h,s,u)),0))}const Bt=[0,0,1,0],kt=a.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");function zt(t=ne){return{plane:_t(t.plane),origin:u(t.origin),basis1:u(t.basis1),basis2:u(t.basis2)}}function Ft(t,e=zt()){return Ut(t.origin,t.basis1,t.basis2,e)}function Ut(t,e,s,n=zt()){return c(n.origin,t),c(n.basis1,e),c(n.basis2,s),Ot(n),function(t,e){Math.abs(i(t.basis1,t.basis2)/(y(t.basis1)*y(t.basis2)))>1e-6&&kt.warn(e,"Provided basis vectors are not perpendicular"),Math.abs(i(t.basis1,Xt(t)))>1e-6&&kt.warn(e,"Basis vectors and plane normal are not perpendicular"),Math.abs(-i(Xt(t),t.origin)-t.plane[3])>1e-6&&kt.warn(e,"Plane offset is not consistent with plane origin")}(n,"fromValues()"),n}function Ot(t){Ct(t.basis2,t.basis1,t.origin,t.plane)}function Et(t,e,s){t!==s&&Ft(t,s);const i=o(ct.get(),Xt(t),e);return n(s.origin,s.origin,i),s.plane[3]-=e,s}function Gt(t,e=zt()){const s=(t[2]-t[0])/2,i=(t[3]-t[1])/2;return d(e.origin,t[0]+s,t[1]+i,0),d(e.basis1,s,0,0),d(e.basis2,0,i,0),Lt(0,0,1,0,e.plane),e}function $t(t,e,i){return!!function(t,e,i){return!!s(e)&&Wt(t,e.origin,e.direction,8,i)}(t.plane,e,i)&&te(t,i)}function Ht(t,e,s){const n=re.get();ie(t,e,n,re.get());let r=Number.POSITIVE_INFINITY;for(const o of ae){const h=se(t,o,oe.get()),l=ct.get();if(It(n,h,l)){const t=f(ct.get(),e.origin,l),n=Math.abs(R(i(e.direction,t)));n<r&&(r=n,c(s,l))}}return r===Number.POSITIVE_INFINITY?Jt(t,e,s):s}function Jt(t,e,s){if($t(t,e,s))return s;const i=re.get(),n=re.get();ie(t,e,i,n);let r=Number.POSITIVE_INFINITY;for(const o of ae){const h=se(t,o,oe.get()),l=ct.get();if(Dt(i,h,l)){const t=vt(e,l);if(!At(n,l))continue;t<r&&(r=t,c(s,l))}}return Qt(t,e.origin)<r&&Zt(t,e.origin,s),s}function Zt(t,e,s){const r=function(t,e,s){const r=o(ct.get(),t,-t[3]),l=function(t,e,s){const n=o(ct.get(),t,i(t,e));return h(s,e,n),s}(t,h(ct.get(),e,r),ct.get());return n(s,l,r),s}(t.plane,e,ct.get()),l=yt(ee(t,t.basis1),r,-1,1,ct.get()),a=yt(ee(t,t.basis2),r,-1,1,ct.get());return h(s,n(ct.get(),l,a),t.origin),s}function Kt(t,e,s){const{origin:i,basis1:n,basis2:r}=t,o=h(ct.get(),e,i),l=bt(n,o),a=bt(r,o),u=bt(Xt(t),o);return d(s,l,a,u)}function Qt(t,e){const s=Kt(t,e,ct.get()),{basis1:i,basis2:n}=t,r=y(i),o=y(n),h=Math.max(Math.abs(s[0])-r,0),l=Math.max(Math.abs(s[1])-o,0),a=s[2];return h*h+l*l+a*a}function Yt(t,e){const s=-t.plane[3];return bt(Xt(t),e)-s}function Xt(t){return t.plane}function te(t,e){const s=h(ct.get(),e,t.origin),n=S(t.basis1),r=S(t.basis2),o=i(t.basis1,s),l=i(t.basis2,s);return-o-n<0&&o-n<0&&-l-r<0&&l-r<0}function ee(t,e){const s=oe.get();return c(s.origin,t.origin),c(s.vector,e),s}function se(t,e,s){const{basis1:i,basis2:r,origin:h}=t,l=o(ct.get(),i,e.origin[0]),a=o(ct.get(),r,e.origin[1]);n(s.origin,l,a),n(s.origin,s.origin,h);const u=o(ct.get(),i,e.direction[0]),c=o(ct.get(),r,e.direction[1]);return o(s.vector,n(u,u,c),2),s}function ie(t,e,s,i){const n=Xt(t);Ct(n,e.direction,e.origin,s),Ct(s,n,e.origin,i)}const ne={plane:_t(),origin:V(0,0,0),basis1:V(1,0,0),basis2:V(0,1,0)},re=new dt(_t),oe=new dt(pt),he=r(),le=new dt((()=>({origin:null,basis1:null,basis2:null,plane:null}))),ae=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],ue=ht(),ce=ht();Object.freeze({__proto__:null,BoundedPlaneClass:class{constructor(){this.plane=_t(),this.origin=r(),this.basis1=r(),this.basis2=r()}},create:zt,wrap:function(t,e,s){const i=le.get();return i.origin=t,i.basis1=e,i.basis2=s,i.plane=Lt(0,0,0,0,ut.get()),Ot(i),i},copy:Ft,copyWithoutVerify:function(t,e){c(e.origin,t.origin),c(e.basis1,t.basis1),c(e.basis2,t.basis2),Mt(t.plane,e.plane)},fromValues:Ut,updateUnboundedPlane:Ot,elevate:Et,setExtent:function(t,e,s){return Gt(e,s),Et(s,Yt(t,t.origin),s),s},fromAABoundingRect:Gt,intersectRay:$t,intersectRayClosestSilhouette:function(t,e,s){if($t(t,e,s))return s;const i=Ht(t,e,ct.get());return n(s,e.origin,o(ct.get(),e.direction,p(e.origin,i)/y(e.direction))),s},closestPointOnSilhouette:Ht,closestPoint:Jt,projectPoint:Zt,projectPointLocal:Kt,distance2:Qt,distance:function(t,e){return Math.sqrt(Qt(t,e))},distanceToSilhouette:function(t,e){let s=Number.NEGATIVE_INFINITY;for(const i of ae){const n=se(t,i,oe.get()),r=ft(n,e);r>s&&(s=r)}return Math.sqrt(s)},extrusionContainsPoint:function(t,e){return At(t.plane,e)&&te(t,e)},axisAt:function(t,e,s,i){return function(t,e,s){switch(e){case 0:c(s,t.basis1),x(s,s);break;case 1:c(s,t.basis2),x(s,s);break;case 2:c(s,Xt(t))}return s}(t,s,i)},altitudeAt:Yt,setAltitudeAt:function(t,e,s,i){const r=Yt(t,e),h=o(he,Xt(t),s-r);return n(i,e,h),i},equals:function(t,e){return m(t.basis1,e.basis1)&&m(t.basis2,e.basis2)&&m(t.origin,e.origin)},transform:function(t,e,s){return t!==s&&Ft(t,s),b(ue,e),v(ue,ue),g(s.basis1,t.basis1,ue),g(s.basis2,t.basis2,ue),g(s.plane,t.plane,ue),g(s.origin,t.origin,e),function(t,e,s){t!==s&&Mt(t,s),s[3]=-i(s,e)}(s.plane,s.origin,s.plane),s},rotate:function(t,e,s,i){return t!==i&&Ft(t,i),w(ce,j(ce),e,s),g(i.basis1,t.basis1,ce),g(i.basis2,t.basis2,ce),Ot(i),i},normal:Xt,UP:ne});class de{constructor(){this._disposed=!1}get disposed(){return this._disposed}get shaderTransformation(){return this._shaderTransformation}acquire(t,e,s,i,n,r){this.id=q(),this.geometry=t,this.material=e,this.transformation=s,this.instanceParameters=i,this.origin=n,this._shaderTransformation=r,this._disposed=!1}release(){this._disposed=!1}dispose(){this._disposed=!0}getStaticTransformation(){return this.transformation}getShaderTransformation(){return s(this._shaderTransformation)?this._shaderTransformation(this.transformation):this.transformation}computeAttachmentOrigin(t){return!!(this.material.computeAttachmentOrigin?this.material.computeAttachmentOrigin(this.geometry,t):this.geometry.computeAttachmentOrigin(t))&&(g(t,t,this.getStaticTransformation()),!0)}}de.pool=new N(de);class pe{constructor(t){this.channel=t,this.id=q()}}class ye extends gt{constructor(t={}){super(),this.type=1,this._geometryRecords=new Array,this._geometries=new Array,this._objectTransformation=ht(),this._bvObjectSpace=new me,this._bvWorldSpace=new me,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._visible=!0,this.castShadow=null==t.castShadow||t.castShadow,this.metadata=t.metadata,this.metadata&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new fe),this.transformation=ht();const{geometries:e,materials:s,transformations:i,origins:n}=t;if(Array.isArray(e)){wt(s.length===e.length,"Object3D: materials don't match geometries"),wt(i.length===e.length,"Object3D: transformations don't match geometries"),this._geometryRecords.length=e.length,this._geometries.length=e.length;for(let t=0;t<e.length;t++)this._geometries[t]=e[t],this._geometryRecords[t]=de.pool.acquire(e[t],s[t],lt(i[t]),{highlights:null,occludees:null,visible:this._visible},n&&n[t])}}get geometryRecords(){return this._geometryRecords}get geometries(){return this._geometries}get transformation(){return this._objectTransformation}set transformation(t){P(this._objectTransformation,t),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}dispose(){this._geometryRecords.length=0,this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(t){wt(null==this._parentLayer||null==t,"Object3D can only be added to a single Layer"),this._parentLayer=t}addGeometry(t,e,i,n,r){i=i||at,this._geometries.push(t);const o=de.pool.acquire(t,e,i,{highlights:null,occludees:null,visible:this._visible},n,r);return this._geometryRecords.push(o),this._hasVolatileTransformation=this._hasVolatileTransformation||s(o.shaderTransformation),this._emit("objectGeometryAdded",{object:this,record:o}),this._invalidateBoundingVolume(),o}removeGeometry(t){const e=this._geometryRecords.splice(t,1)[0];return this._hasVolatileTransformation=s(e.shaderTransformation)?this._geometryRecords.some((t=>s(t.shaderTransformation))):this._hasVolatileTransformation,e.dispose(),this._geometries.splice(t,1),this._emit("objectGeometryRemoved",{object:this,record:e}),this._invalidateBoundingVolume(),e}removeAllGeometries(){for(;this.geometryRecords.length>0;)this.removeGeometry(0)}geometryVertexAttrsUpdated(t){this._emit("vertexAttrsUpdated",{object:this,record:t}),this._invalidateBoundingVolume()}get isVisible(){return this._visible}setVisible(t){if(this._visible!==t){this._visible=t;for(const t of this._geometryRecords)t.instanceParameters.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const t=new pe(1);for(const e of this._geometryRecords)e.instanceParameters.occludees=jt(e.instanceParameters.occludees,t);return this._emit("occlusionChanged",this),t}removeOcclude(t){for(const e of this._geometryRecords)e.instanceParameters.occludees=xt(e.instanceParameters.occludees,t);this._emit("occlusionChanged",this)}highlight(){const t=new pe(0);for(const e of this._geometryRecords)e.instanceParameters.highlights=jt(e.instanceParameters.highlights,t);return this._emit("highlightChanged",this),t}removeHighlight(t){for(const e of this._geometryRecords)e.instanceParameters.highlights=xt(e.instanceParameters.highlights,t);this._emit("highlightChanged",this)}getCombinedStaticTransformation(t,e){return _(M(e,ht()),this.transformation,t.getStaticTransformation())}getCombinedShaderTransformation(t,e){return e=e||ht(),_(e,this.transformation,t.getShaderTransformation()),e}hasVolativeTransformation(){return this._hasVolatileTransformation}get boundingVolumeWorldSpace(){return this._validateBoundingVolume(),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._validateBoundingVolume(),this._bvObjectSpace}_validateBoundingVolume(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(let t=0;t<this._geometryRecords.length;++t){const e=this._geometryRecords[t],i=this._geometries[t].boundingInfo;s(i)&&(this._calculateTransformedBoundingVolume(i,this._bvObjectSpace,e.getShaderTransformation()),this._calculateTransformedBoundingVolume(i,this._bvWorldSpace,this.getCombinedShaderTransformation(e)))}L(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),L(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);const t=r(),e=r(),i=C(this.transformation);for(let s=0;s<this._geometryRecords.length;++s){const n=this._geometries[s].boundingInfo;if(T(n))continue;const r=this._geometryRecords[s].getShaderTransformation(),o=C(r);g(t,n.getCenter(),r);const h=p(t,this._bvObjectSpace.bounds),l=n.getBSRadius()*o;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],h+l),g(e,t,this.transformation);const a=p(e,this._bvWorldSpace.bounds);this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],a+l*i)}this._bvDirty=!1}_calculateTransformedBoundingVolume(t,e,s){const i=t.getBBMin(),n=t.getBBMax(),r=u(i),o=u(n);g(r,r,s),g(o,o,s);for(let t=0;t<3;++t)e.min[t]=Math.min(e.min[t],r[t],o[t]),e.max[t]=Math.max(e.max[t],r[t],o[t]);for(let t=0;t<3;++t){c(r,i),c(o,n),r[t]=n[t],o[t]=i[t],g(r,r,s),g(o,o,s);for(let t=0;t<3;++t)e.min[t]=Math.min(e.min[t],r[t],o[t]),e.max[t]=Math.max(e.max[t],r[t],o[t])}}_invalidateBoundingVolume(){this._bvDirty=!0,s(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)}_emit(t,e){s(this._parentLayer)&&this._parentLayer.events.emit(t,e)}get test(){const t=this;return{hasGeometry:e=>t._geometries.indexOf(e)>-1,getGeometryIndex:e=>t._geometries.indexOf(e)}}}class fe{constructor(){this.min=V(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=V(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class me extends fe{constructor(){super(...arguments),this.bounds=St()}init(){d(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),d(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),Vt(this.bounds)}}class be{constructor(t){this.normal=r(),this.transformation=ht(),this._ray=Rt(),this.init(t)}get ray(){return this._ray}get hasIntersectionPoint(){return null!=this.dist}get distanceInRenderSpace(){if(null!=this.dist)return o(ve,this.ray.direction,this.dist),y(ve)}getIntersectionPoint(t){return!!this.hasIntersectionPoint&&(o(ve,this.ray.direction,this.dist),n(t,this.ray.origin,ve),!0)}getTransformedNormal(t){return c(ge,this.normal),ge[3]=0,I(ge,ge,this.transformation),c(t,ge),x(t,t),t}init(t){this.dist=void 0,this.target=void 0,this.name=void 0,this.drapedLayerOrder=void 0,this.drapedLayerGraphicOrder=void 0,this.center=null,this.geometryId=null,this.triangleNr=null,this.intersector="Stage",t?Nt(t,this._ray):this._ray=Rt()}set(t,e,s,i,n,r,o,h,l,a){t instanceof ye&&(t={type:"stage",obj:t}),this.dist=s,c(this.normal,i),P(this.transformation,n),this.target=t,this.name=e,this.drapedLayerOrder=r,this.center=o?u(o):null,this.geometryId=h,this.triangleNr=l,this.drapedLayerGraphicOrder=a}copyFrom(t){Nt(t.ray,this._ray),this.dist=t.dist,this.target=t.target,this.name=t.name,this.drapedLayerOrder=t.drapedLayerOrder,this.center=t.center?u(t.center):null,this.geometryId=t.geometryId,this.triangleNr=t.triangleNr,this.intersector=t.intersector,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,c(this.normal,t.normal),P(this.transformation,t.transformation)}}const ve=r(),ge=mt(),we=a.getLogger("esri.layers.VoxelWasmPerScene");class je{constructor(t){this._halfIntTexturesAvailable=!1,this._useDepthPass=!1,this._havePreparedWithAllLayers=!1,this._renderPluginContext=null,this._vxl=null,this._pluginIsActive=!1,this._moreToLoad=!1,this._viewportWidth=-1,this._viewportHeight=-1,this._newLayers=[],this._layers=new Map,this._renderPass=0,this._renderSlot=3,this._rctx=null,this._renderTargetToRestore=null,this._wasmMemBlockSizes=[512,1024,2048,4096,8192,16384,32768,65536],this._wasmMemBlocks=new Map,this._dbgFlags=new Set,this._dbgFlags.add(4),this._view=t,this.initialize()}get canRender(){return!!this._vxl&&"local"===this._view.viewingMode}dbg(t,e){this._dbgFlags.has(t)&&(4===t?we.error(e):we.warn(e))}removeRenderPlugin(){this._pluginIsActive&&this._view._stage&&(this.dbg(1,"--removeRenderPlugin--"),this._view._stage.removeRenderPlugin(this)),this._pluginIsActive=!1}initialize(){this.dbg(1,"--initialize--");for(const t of this._wasmMemBlockSizes)this._wasmMemBlocks.set(t,0);this._readyWatchHandle=D((()=>this._view.ready),(t=>{t&&"local"===this._view.viewingMode?(this.dbg(1,"view ready status changed to ready on a local view, calling addRenderPlugin"),this._view._stage.addRenderPlugin([this._renderSlot],this),this._pluginIsActive=!0):(this.dbg(1,"view ready status changed, not ready or not a local view!"),this.removeRenderPlugin())}),{initial:!0}),this._qualityWatchHandle=D((()=>{var t;return null==(t=this._view)?void 0:t.qualityProfile}),(t=>{this.dbg(3,"qualityProfile changed to "+t),this._vxl&&this._vxl.set_quality(this.toWasmQuality(t))}),{initial:!0}),this._timeExtentWatchHandle=D((()=>{var t;return null==(t=this._view)?void 0:t.timeExtent}),(()=>{if(this._vxl){var t;const e=this._getTimeArgs(null==(t=this._view)?void 0:t.timeExtent);this.dbg(3,"sceneView timeExtent changed to useTime="+e.useTime+" st="+e.startTime+" et="+e.endTime),this._vxl.set_scene_time_extent(e.startTime,e.endTime,e.useTime),this._renderPluginContext.requestRender()}}),{initial:!0})}initializeRenderContext(t){this.dbg(1,"--initializeRenderContext--");const e=t.renderContext.rctx;"webgl2"===e.webglVersion?(this._renderPluginContext=t,this._rctx=t.renderContext.rctx,this._halfIntTexturesAvailable=!!this._rctx.capabilities.textureNorm16,this.initializeWasm(e.gl)):this.dbg(4,"WebGL 1 context only!")}uninitializeRenderContext(){this._renderPluginContext=null,this._rctx=null,this.dbg(1,"--uninitializeRenderContext--")}restoreFramebuffer(){if(!this._renderTargetToRestore)return;const t=this._renderTargetToRestore.fbo;if(!this._rctx)return void this.dbg(4,"no context in restoreFramebuffer!");this._rctx.bindFramebuffer(t,!0);const e=this._renderTargetToRestore.viewport;this._rctx.setViewport(e.x,e.y,e.width,e.height)}bindPreviousDepthToSlot(t,e){if(!this._rctx||!this._renderTargetToRestore)return 0;const s=this._renderTargetToRestore.fbo.depthStencilTexture;return s?(this._rctx.bindTexture(0===e?null:s,t,!0),1):(this.dbg(4,"no depth/stencil texture exists!"),0)}setBlendState(t,e,s,i){this._rctx?(this._rctx.setBlendingEnabled(1===t),this._rctx.setBlendFunction(e,s),this._rctx.setBlendEquation(i)):this.dbg(4,"setBlendState callback has no rendering context!")}setFrontFace(t){this._rctx?this._rctx.setFrontFace(t):this.dbg(4,"setFrontFace callback has no rendering context!")}setDepthStencilStateFunction(t,e,s){this._rctx?(this._rctx.setDepthFunction(s),this._rctx.setDepthTestEnabled(1===t),this._rctx.setDepthWriteEnabled(1===e),this._rctx.setStencilTestEnabled(!1),this._rctx.setStencilFunction(519,0,255),this._rctx.setStencilOpSeparate(1028,7680,7682,7680),this._rctx.setStencilOpSeparate(1029,7680,7683,7680)):this.dbg(4,"setDepthStencilStateFunction callback has no rendering context!")}setRasterizerState(t){if(this._rctx)switch(t){case 1:this._rctx.setFaceCullingEnabled(!1);break;case 3:this._rctx.setCullFace(1029),this._rctx.setFaceCullingEnabled(!0);break;case 2:this._rctx.setCullFace(1028),this._rctx.setFaceCullingEnabled(!0)}else this.dbg(4,"setRasterizerState callback has no rendering context!")}setViewport(t,e,s,i){this._rctx?this._rctx.setViewport(t,e,s,i):this.dbg(4,"setViewport callback has no rendering context!")}_syncRequestsResponses(){this._layers.forEach(((t,e)=>{const s=[];t.responses.forEach(((t,i)=>{s.push(i),this.dbg(2,"responding for requestID:"+i+" size:"+t.size),this._vxl.respond(e,i,t)}));const i=t.responses;for(const t of s)i.delete(t);const n=this._vxl.get_new_requests(e),r=t.abortController.signal;for(const e in n){t.outstandingRequestCount+=1,1===t.outstandingRequestCount&&t.layerView.updatingFlagChanged();const s=n[e],o={responseType:"array-buffer",signal:r};this.dbg(2,"making requestID:"+e+" url:"+s.url),A(s.url,o).then((n=>{t.outstandingRequestCount-=1,0===t.outstandingRequestCount&&t.layerView.updatingFlagChanged(),this.dbg(2,"have response for requestID:"+e);let r=0;if(n.data.byteLength>0){r=this._vxl._malloc(n.data.byteLength);const t=new Uint8Array(this._vxl.HEAPU8.buffer,r,n.data.byteLength),e=new Uint8Array(n.data);for(let s=0;s<n.data.byteLength;++s)t[s]=e[s]}i.set(+e,{type:s.type,ptr:r,size:n.data.byteLength,success:!0})})).catch((n=>{t.outstandingRequestCount-=1,0===t.outstandingRequestCount&&t.layerView.updatingFlagChanged(),W(n)||(this.dbg(4,`requestID:${e} failed, error=${n.toString()}`),i.set(+e,{type:s.type,ptr:0,size:0,success:!1}))}))}}))}updateWasmCamera(t){this._vxl.set_projection_matrix.apply(this._vxl,t.projectionMatrix),this._vxl.set_view_matrix.apply(this._vxl,t.viewMatrix),this._vxl.set_near_far(t.near,t.far)}isUpdating(t){return!(this._vxl||!this._vxlPromise)||!!this._layers.has(t)&&this._layers.get(t).outstandingRequestCount>0}setEnabled(t,e){this._layers.forEach(((s,i)=>{s.layerView===t&&(this._vxl.set_enabled(i,e),this._renderPluginContext.requestRender())}))}setSlices(t,e){return this._doMaskedUIUpdate(t,{mask:2,slices:{planes:e,currentEditPlane:-1}},!0)}setDynamicSections(t,e){return this._doMaskedUIUpdate(t,{mask:4,dynamicSections:{planes:e,currentEditPlane:-1}},!0)}setStaticSections(t,e){return this._doMaskedUIUpdate(t,{mask:1,staticSections:e},!0)}setCurrentVariable(t,e){return this._doMaskedUIUpdate(t,{mask:1024,currentVariable:e},!0)}setRenderMode(t,e){return this._doMaskedUIUpdate(t,{mask:8192,renderMode:e},!0)}_doMaskedUIUpdate(t,e,s){if(!this._vxl)return!1;let i=!1;return this._layers.forEach(((s,n)=>{if(s.layerView===t){const t={str:JSON.stringify(e),byteCount:0,ptr:0,isReusable:!1};this._AllocateBlock(t)&&(i=1===this._vxl.handle_masked_ui_update(n,t.ptr,t.byteCount),t.isReusable||this._vxl._free(t.ptr))}})),i&&s&&this._renderPluginContext.requestRender(),i}addVoxelLayer(t){if(!this._vxl){const e={layerView:t,resolveCallback:null,rejectCallback:null},s=new Promise(((t,s)=>{e.resolveCallback=t,e.rejectCallback=s}));return this._newLayers.push(e),s}const e=this._addVoxelLayer(t);return e<0?Promise.reject(-1):Promise.resolve(e)}removeVoxelLayer(t){if(!this._vxl){const e=this._newLayers.findIndex((e=>t===e.layerView));e>=0&&(this._newLayers[e].resolveCallback(-1),this._newLayers.splice(e,1));const s=this._newLayers.length;return 0===s&&(this.dbg(1," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),s}let e=-1;this._layers.forEach(((s,i)=>{s.layerView===t&&(e=i,s.abortController.abort(),this._vxl.remove_layer(e))})),e>=0&&this._layers.delete(e);const s=this._layers.size;return 0===s&&(this.dbg(1," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),s}_getBlockSize(t){for(const e of this._wasmMemBlockSizes)if(t<e)return e;return-1}_AllocateBlock(t){t.byteCount=this._vxl.lengthBytesUTF8(t.str)+1;const e=this._getBlockSize(t.byteCount);return e<0?(t.isReusable=!1,t.ptr=this._vxl._malloc(t.byteCount)):(t.isReusable=!0,t.ptr=this._wasmMemBlocks.get(e),0===t.ptr&&(t.ptr=this._vxl._malloc(e),this._wasmMemBlocks.set(e,t.ptr))),0!==t.ptr&&(this._vxl.stringToUTF8(t.str,t.ptr,t.byteCount),!0)}_getTimeArgs(t){let e=-Number.MAX_VALUE,i=Number.MAX_VALUE,n=!1;return s(t)&&(t.isAllTime?n=!0:(s(t.start)&&(n=!0,e=t.start.getTime()/1e3),s(t.end)&&(n=!0,i=t.end.getTime()/1e3))),{startTime:e,endTime:i,useTime:n}}_addVoxelLayer(t){var e;const s=t.layer;let i=-1;const n=s.getConfiguration();if(n.length<1)return-1;const r={str:n,byteCount:0,ptr:0,isReusable:!1};if(!this._AllocateBlock(r))return-1;const o=this._getTimeArgs(null==(e=this._view)?void 0:e.timeExtent),h=this._view.spatialReference.isWGS84&&s.spatialReference.isWGS84?111319.49079327357:1;if(i=this._vxl.add_layer(s.serviceRoot,r.ptr,r.byteCount,h,h,o.startTime,o.endTime,o.useTime),r.isReusable||this._vxl._free(r.ptr),i>=0){const e=new AbortController;if(this._layers.set(i,{layerView:t,responses:new Map,outstandingRequestCount:0,abortController:e}),!this._halfIntTexturesAvailable){const e=[];let s="";for(const i of t.layer.variables)"Int16"!==i.renderingFormat.type&&"UInt16"!==i.renderingFormat.type||(e.push(i.name),i.id===t.layer.style.currentVariableId&&(s=i.name));""!==s&&we.error("#addVoxelLayer_error()",t.layer,`The voxel layer '${t.layer.title}' cannot render the current variable '${s}' in the this browser`),e.length>0&&we.warn("#addVoxelLayer_warning()",t.layer,`The voxel layer '${t.layer.title}' cannot render the variables '${e.toString()}' in the this browser`)}return i}return-1}prepareRender(t){if(!this._vxl)return;const e=t.viewForward,s=t.eye;this._vxl.update_camera_pos_and_direction(s[0],s[1],s[2],e[0],e[1],e[2]);const i=this._vxl.cull();this.dbg(2,"missingResourceCount="+i),this._moreToLoad=i>0,this._havePreparedWithAllLayers=0===this._newLayers.length}render(t){if(!this._vxl||t.pass!==this._renderPass||t.slot!==this._renderSlot)return!1;for(const t of this._newLayers){const e=this._addVoxelLayer(t.layerView);-1===e?t.rejectCallback(-1):t.resolveCallback(e)}if(this._newLayers=[],0===this._layers.size)return this.dbg(4,"No voxel layers but RenderPlugin instance is being asked to render!"),!1;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()},this._syncRequestsResponses(),this._vxl.begin_frame();const e=this._renderTargetToRestore.viewport;return e.width===this._viewportWidth&&e.height===this._viewportHeight||(this._viewportWidth=e.width,this._viewportHeight=e.height,this._vxl.set_viewport(e.width,e.height)),0===e.x&&0===e.y||this.dbg(4,"Unsupported viewport parameters detected!"),this.updateWasmCamera(t.camera),this._vxl.draw(),this._renderTargetToRestore.fbo=null,t.rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),t.rctx.externalVertexArrayObjectUpdate(),t.rctx.externalVertexBufferUpdate(),(this._moreToLoad||!this._havePreparedWithAllLayers&&this._layers.size>0)&&this._renderPluginContext.requestRender(),!0}queryDepthRange(t){this.dbg(1,"--queryDepthRange--");const e=t.viewForward,s=t.eye;this._vxl.update_camera_pos_and_direction(s[0],s[1],s[2],e[0],e[1],e[2]),this._vxl.cull();const i={near:5,far:1e4};return i.near=this._vxl.get_near(),i.far=this._vxl.get_far(),i}destroy(){this.dbg(1,"--destroy--"),this.removeRenderPlugin(),this._readyWatchHandle=B(this._readyWatchHandle),this._qualityWatchHandle=B(this._qualityWatchHandle),this._timeExtentWatchHandle=B(this._timeExtentWatchHandle),this._vxl&&(this._layers.forEach((t=>{t.abortController.abort()})),this._wasmMemBlocks.forEach((t=>{0!==t&&this._vxl._free(t)})),this._vxl.uninitialize_voxel_wasm(),this._vxl=null)}initializeWasm(t){return this._vxl?Promise.resolve():(this._vxlPromise||(this._vxlPromise=function(t){return new Promise((e=>import("./p-f9c7a059.js").then((t=>t.v)).then((({default:s})=>{const i=s({locateFile:Pt,preinitializedWebGLContext:t,onRuntimeInitialized:()=>e(i)})})))).catch((t=>Promise.reject(t)))}(t).then((t=>{var e;if(this._vxl=t,this._vxlPromise=null,this._newLayers.length<=0)return this.dbg(1," no voxel layers left after WASM downloaded, removing RenderPlugin and destroying"),void this.destroy();const s=this._getTimeArgs(null==(e=this._view)?void 0:e.timeExtent),i=this._vxl.addFunction(this.restoreFramebuffer.bind(this),"v"),n=this._vxl.addFunction(this.setBlendState.bind(this),"viiii"),r=this._vxl.addFunction(this.setFrontFace.bind(this),"vi"),o=this._vxl.addFunction(this.setRasterizerState.bind(this),"vi"),h=this._vxl.addFunction(this.setDepthStencilStateFunction.bind(this),"viii"),l=this._vxl.addFunction(this.setViewport.bind(this),"viiii"),a=this._vxl.addFunction(this.bindPreviousDepthToSlot.bind(this),"iii");this._vxl.initialize_voxel_wasm(i,n,r,o,h,l,a,s.startTime,s.endTime,s.useTime),this._vxl.set_quality(this.toWasmQuality(this._view.qualityProfile)),this._renderPluginContext&&this._renderPluginContext.requestRender()})).catch((()=>{for(const t of this._newLayers)t.rejectCallback(-2);this.dbg(4," WASM failed to download, removing RenderPlugin and destroying"),this.destroy()}))),this._vxlPromise)}get type(){return"external"}get isGround(){return!1}get slicePlane(){return!1}get intersectionHandlerId(){return"unj"}intersect(t,e,s,i,n){if(!this._vxl)return;if(!this._rctx)return;if(0===this._layers.size)return;if(n[0]<0||n[0]>t.camera.viewport[2]||n[1]<0||n[1]>t.camera.viewport[3])return;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()};const r=t.camera.viewForward,o=t.camera.eye;this._vxl.update_camera_pos_and_direction(o[0],o[1],o[2],r[0],r[1],r[2]),this.updateWasmCamera(t.camera),this._vxl.begin_frame(),this._useDepthPass?this.intersectDepth(t,e,s,i,n):this.intersectObject(t,e,s,i,n),this._renderTargetToRestore.fbo=null,this._rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),this._rctx.externalVertexArrayObjectUpdate(),this._rctx.externalVertexBufferUpdate()}intersectObject(t,e,s,h,a){const u=this._vxl.pick_object(a[0],a[1]);if(u.success){const a=r();k(a,h,s),x(a,a);const c=p(s,h),y=r();d(y,u.worldX,u.worldY,u.worldZ);const f=r();k(f,y,s);const m=r();o(m,a,i(f,a));const b=r();n(b,s,m);const v=p(s,b),g=l(v/c,0,1),w=t=>{t.intersector="Voxel",t.dist=g,t.target={type:"external",metadata:{layerUid:this.intersectionHandlerId}}},j=t.results.min;(null==j.dist||g<j.dist)&&(null==e||e(s,h,g))&&w(j);const S=t.results.max;if(0!==t.options.store&&(null==S.dist||g>S.dist)&&(null==e||e(s,h,g))&&w(S),2===t.options.store){const e=new be(t.ray);w(e),t.results.all.push(e)}}}intersectDepth(t,e,s,h,a){const u=this._vxl.pick_depth(a[0],a[1]);if(u.success){const a=r();k(a,h,s),x(a,a);const c=p(s,h),y=r();d(y,u.worldX,u.worldY,u.worldZ);const f=r();k(f,y,s);const m=r();o(m,a,i(f,a));const b=r();n(b,s,m);const v=p(s,b),g=l(v/c,0,1),w=t=>{t.intersector="Voxel",t.dist=g,t.target={type:"external",metadata:{layerUid:this.intersectionHandlerId}}},j=t.results.min;(null==j.dist||g<j.dist)&&(null==e||e(s,h,g))&&w(j);const S=t.results.max;if(0!==t.options.store&&(null==S.dist||g>S.dist)&&(null==e||e(s,h,g))&&w(S),2===t.options.store){const e=new be(t.ray);w(e),t.results.all.push(e)}}}toWasmQuality(t){switch(t){case"low":return 0;case"medium":return 1;case"high":return 2}}}class xe{constructor(){this.view2WASM=new Map}static getInstance(){return xe.instance||(xe.instance=new xe),xe.instance}isUpdating(t,e){return!!this.view2WASM.has(t)&&this.view2WASM.get(t).isUpdating(e)}addLayer(t,e){return this.view2WASM.has(t)||this.view2WASM.set(t,new je(t)),this.view2WASM.get(t).addVoxelLayer(e)}removeLayer(t,e){this.view2WASM.has(t)&&this.view2WASM.get(t).removeVoxelLayer(e)<1&&this.view2WASM.delete(t)}setLayerEnabled(t,e,s){this.view2WASM.has(t)&&this.view2WASM.get(t).setEnabled(e,s)}setLayerSlices(t,e){let s=!1;return this.view2WASM.forEach(((i,n)=>{n.allLayerViews.filter((t=>"voxel-3d"===t.type)).forEach((n=>{n.layer===t&&(s=i.setSlices(n,e))}))})),s}setLayerDynamicSections(t,e){let s=!1;return this.view2WASM.forEach(((i,n)=>{n.allLayerViews.filter((t=>"voxel-3d"===t.type)).forEach((n=>{n.layer===t&&(s=i.setDynamicSections(n,e))}))})),s}setLayerCurrentVariable(t,e){let s=!1;return this.view2WASM.forEach(((i,n)=>{n.allLayerViews.filter((t=>"voxel-3d"===t.type)).forEach((n=>{n.layer===t&&(s=i.setCurrentVariable(n,e))}))})),s}setLayerRenderMode(t,e){let s=!1;return this.view2WASM.forEach(((i,n)=>{n.allLayerViews.filter((t=>"voxel-3d"===t.type)).forEach((n=>{n.layer===t&&(s=i.setRenderMode(n,e))}))})),s}setLayerStaticSections(t,e){let s=!1;return this.view2WASM.forEach(((i,n)=>{n.allLayerViews.filter((t=>"voxel-3d"===t.type)).forEach((n=>{n.layer===t&&(s=i.setStaticSections(n,e))}))})),s}}let Se=class extends O{constructor(){super(...arguments),this.enabled=!0,this.label="",this.normal=null,this.point=null}};z([F({type:Boolean,json:{default:!0,write:!0}})],Se.prototype,"enabled",void 0),z([F({type:String,json:{write:!0}})],Se.prototype,"label",void 0),z([F({type:[Number],json:{write:!0}})],Se.prototype,"normal",void 0),z([F({type:[Number],json:{write:!0}})],Se.prototype,"point",void 0),Se=z([U("esri.layers.support.VoxelDynamicSection")],Se);const Ve=Se;let Re=class extends O{constructor(){super(...arguments),this.enabled=!0,this.label="",this.normal=null,this.point=null}};z([F({type:Boolean,json:{write:!0}})],Re.prototype,"enabled",void 0),z([F({type:String,json:{write:!0}})],Re.prototype,"label",void 0),z([F({type:[Number],json:{write:!0}})],Re.prototype,"normal",void 0),z([F({type:[Number],json:{write:!0}})],Re.prototype,"point",void 0),Re=z([U("esri.layers.support.VoxelSlice")],Re);const Ne=Re;let qe=class extends O{constructor(){super(...arguments),this.enabled=!0,this.href=null,this.id=null,this.label="",this.normal=null,this.point=null,this.sizeInPixel=null,this.slices=null,this.timeId=0,this.variableId=null}};z([F({type:Boolean,json:{default:!0,write:!0}})],qe.prototype,"enabled",void 0),z([F({type:String,json:{write:{enabled:!0,isRequired:!0}}})],qe.prototype,"href",void 0),z([F({type:E,json:{write:{enabled:!0,isRequired:!0}}})],qe.prototype,"id",void 0),z([F({type:String,json:{write:!0}})],qe.prototype,"label",void 0),z([F({type:[Number],json:{write:{enabled:!0,isRequired:!0}}})],qe.prototype,"normal",void 0),z([F({type:[Number],json:{write:{enabled:!0,isRequired:!0}}})],qe.prototype,"point",void 0),z([F({type:[E],json:{write:{enabled:!0,isRequired:!0}}})],qe.prototype,"sizeInPixel",void 0),z([F({type:[Ne],json:{write:!0}})],qe.prototype,"slices",void 0),z([F({type:E,json:{default:0,write:!0}})],qe.prototype,"timeId",void 0),z([F({type:E,json:{write:{enabled:!0,isRequired:!0}}})],qe.prototype,"variableId",void 0),qe=z([U("esri.layers.support.VoxelSection")],qe);const Pe=qe;let _e=class extends O{constructor(){super(...arguments),this.diffuseFactor=.5,this.specularFactor=.5}};z([F({type:Number,range:{min:0,max:1},json:{default:.5,write:!0}})],_e.prototype,"diffuseFactor",void 0),z([F({type:Number,range:{min:0,max:1},json:{default:.5,write:!0}})],_e.prototype,"specularFactor",void 0),_e=z([U("esri.layers.support.VoxelSimpleShading")],_e);const Me=_e;let Le=class extends O{constructor(){super(...arguments),this.color=null,this.value=null,this.enabled=!0,this.label=null}};z([F({type:G,json:{type:[E],write:{enabled:!0,isRequired:!0}}})],Le.prototype,"color",void 0),z([F({type:Number,json:{write:{enabled:!0,isRequired:!0}}})],Le.prototype,"value",void 0),z([F({type:Boolean,json:{default:!0,write:!0}})],Le.prototype,"enabled",void 0),z([F({type:String,json:{write:!0}})],Le.prototype,"label",void 0),Le=z([U("esri.layers.support.VoxelIsosurface")],Le);const Te=Le;let Ce=class extends O{constructor(){super(...arguments),this.alpha=0,this.position=0}};z([F({type:Number,json:{write:{enabled:!0,isRequired:!0}}})],Ce.prototype,"alpha",void 0),z([F({type:Number,json:{write:{enabled:!0,isRequired:!0}}})],Ce.prototype,"position",void 0),Ce=z([U("esri.layers.support.VoxelAlphaStop")],Ce);const Ie=Ce;let De=class extends O{constructor(){super(...arguments),this.color=null,this.position=0}};z([F({type:G,json:{type:[E],write:{enabled:!0,isRequired:!0}}})],De.prototype,"color",void 0),z([F({type:Number,json:{write:{enabled:!0,isRequired:!0}}})],De.prototype,"position",void 0),De=z([U("esri.layers.support.VoxelColorStop")],De);const Ae=De;let We=class extends O{constructor(){super(...arguments),this.enabled=!1,this.range=null}};z([F({type:Boolean,json:{default:!1,write:!0}})],We.prototype,"enabled",void 0),z([F({type:[Number],json:{write:!0}})],We.prototype,"range",void 0),We=z([U("esri.layers.support.VoxelRangeFilter")],We);const Be=We;let ke=class extends O{constructor(t){super(t),this.interpolation=null,this.stretchRange=null,this.rangeFilter=null,this.colorStops=new $,this.alphaStops=new $}set colorStops(t){this._set("colorStops",H(t,this._get("colorStops"),$.ofType(Ae)))}set alphaStops(t){this._set("alphaStops",H(t,this._get("alphaStops"),$.ofType(Ie)))}};z([F({type:["linear","nearest"],json:{write:!0}})],ke.prototype,"interpolation",void 0),z([F({type:[Number],json:{write:{enabled:!0,isRequired:!0}}})],ke.prototype,"stretchRange",void 0),z([F({type:$.ofType(Ae),json:{write:{enabled:!0,overridePolicy(){return{enabled:!!this.colorStops&&this.colorStops.length>0}}}}})],ke.prototype,"colorStops",null),z([F({type:$.ofType(Ie),json:{write:{enabled:!0,overridePolicy(){return{enabled:!!this.alphaStops&&this.alphaStops.length>0}}}}})],ke.prototype,"alphaStops",null),z([F({type:Be,json:{write:!0}})],ke.prototype,"rangeFilter",void 0),ke=z([U("esri.layers.support.VoxelTransferFunctionStyle")],ke);const ze=ke;let Fe=class extends O{constructor(){super(...arguments),this.color=null,this.value=0,this.enabled=!0,this.label=null}};z([F({type:G,json:{type:[E],write:{enabled:!0,isRequired:!0}}})],Fe.prototype,"color",void 0),z([F({type:E,json:{write:{enabled:!0,isRequired:!0}}})],Fe.prototype,"value",void 0),z([F({type:Boolean,json:{default:!0,write:!0}})],Fe.prototype,"enabled",void 0),z([F({type:String,json:{write:!0}})],Fe.prototype,"label",void 0),Fe=z([U("esri.layers.support.VoxelUniqueValue")],Fe);const Ue=Fe;let Oe=class extends O{constructor(t){super(t),this.variableId=0,this.label=null,this.transferFunction=null,this.uniqueValues=new $,this.isosurfaces=new $}set uniqueValues(t){this._set("uniqueValues",H(t,this._get("uniqueValues"),$.ofType(Ue)))}set isosurfaces(t){this._set("isosurfaces",H(t,this._get("isosurfaces"),$.ofType(Te)))}};z([F({type:E,json:{write:{enabled:!0,isRequired:!0}}})],Oe.prototype,"variableId",void 0),z([F({type:String,json:{write:!0}})],Oe.prototype,"label",void 0),z([F({type:ze,json:{write:{enabled:!0,overridePolicy(){return{enabled:!this.uniqueValues||this.uniqueValues.length<1}}}}})],Oe.prototype,"transferFunction",void 0),z([F({type:$.ofType(Ue),json:{write:{enabled:!0,overridePolicy(){return{enabled:!!this.uniqueValues&&this.uniqueValues.length>0}}}}})],Oe.prototype,"uniqueValues",null),z([F({type:$.ofType(Te),json:{write:{enabled:!0,overridePolicy(){return{enabled:(!this.uniqueValues||this.uniqueValues.length<1)&&!!this.isosurfaces&&this.isosurfaces.length>0}}}}})],Oe.prototype,"isosurfaces",null),Oe=z([U("esri.layers.support.VoxelVariableStyle")],Oe);const Ee=Oe;let Ge=class extends O{constructor(t){super(t),this.volumeId=0,this.verticalExaggeration=1,this.exaggerationMode="scale-height",this.verticalOffset=0,this.slices=new $,this.dynamicSections=new $}set slices(t){this._set("slices",H(t,this._get("slices"),$.ofType(Ne)))}set dynamicSections(t){this._set("dynamicSections",H(t,this._get("dynamicSections"),$.ofType(Ve)))}};z([F({type:E,json:{write:{enabled:!0,isRequired:!0}}})],Ge.prototype,"volumeId",void 0),z([F({type:Number,json:{default:1,write:!0}})],Ge.prototype,"verticalExaggeration",void 0),z([F({type:["scale-position","scale-height"],json:{default:"scale-height",write:!0}})],Ge.prototype,"exaggerationMode",void 0),z([F({type:Number,json:{default:0,write:!0}})],Ge.prototype,"verticalOffset",void 0),z([F({type:$.ofType(Ne),json:{write:{enabled:!0,overridePolicy(){return{enabled:!!this.slices&&this.slices.length>0}}}}})],Ge.prototype,"slices",null),z([F({type:$.ofType(Ve),json:{write:{enabled:!0,overridePolicy(){return{enabled:!!this.dynamicSections&&this.dynamicSections.length>0}}}}})],Ge.prototype,"dynamicSections",null),Ge=z([U("esri.layers.support.VoxelVolumeStyle")],Ge);const $e=Ge;let He=class extends O{constructor(t){super(t),this.currentVariableId=0,this.renderMode="volume",this.enableSlices=!0,this.enableSections=!0,this.enableDynamicSections=!0,this.enableIsosurfaces=!0,this.shading=new Me,this.volumeStyles=new $,this.variableStyles=new $}set volumeStyles(t){this._set("volumeStyles",H(t,this._get("volumeStyles"),$.ofType($e)))}set variableStyles(t){this._set("variableStyles",H(t,this._get("variableStyles"),$.ofType(Ee)))}};z([F({type:$.ofType($e),json:{write:!0}})],He.prototype,"volumeStyles",null),z([F({type:E,json:{write:{enabled:!0,isRequired:!0}}})],He.prototype,"currentVariableId",void 0),z([F({type:["volume","surfaces"],json:{write:!0}})],He.prototype,"renderMode",void 0),z([F({type:$.ofType(Ee),json:{write:!0}})],He.prototype,"variableStyles",null),z([F({type:Boolean,json:{write:!0}})],He.prototype,"enableSlices",void 0),z([F({type:Boolean,json:{write:!0}})],He.prototype,"enableSections",void 0),z([F({type:Boolean,json:{write:!0}})],He.prototype,"enableDynamicSections",void 0),z([F({type:Boolean,json:{write:!0}})],He.prototype,"enableIsosurfaces",void 0),z([F({type:Me,json:{write:!0}})],He.prototype,"shading",void 0),He=z([U("esri.layers.support.VoxelStyle")],He);const Je=He;let Ze=class extends O{constructor(){super(...arguments),this.continuity=null,this.hasNoData=!1,this.noData=0,this.offset=0,this.scale=1,this.type=null}};z([F({type:["discrete","continuous"],json:{write:!0}})],Ze.prototype,"continuity",void 0),z([F({type:Boolean,json:{write:!0}})],Ze.prototype,"hasNoData",void 0),z([F({type:Number,json:{write:!0}})],Ze.prototype,"noData",void 0),z([F({type:Number,json:{write:!0}})],Ze.prototype,"offset",void 0),z([F({type:Number,json:{write:!0}})],Ze.prototype,"scale",void 0),z([F({type:String,json:{write:{enabled:!0,isRequired:!0}}})],Ze.prototype,"type",void 0),Ze=z([U("esri.layers.support.VoxelFormat")],Ze);const Ke=Ze;let Qe=class extends O{constructor(){super(...arguments),this.id=null,this.description="",this.name=null,this.originalFormat=null,this.renderingFormat=null,this.unit="",this.volumeId=0,this.type=null}};z([F({type:Number,json:{write:{enabled:!0,isRequired:!0}}})],Qe.prototype,"id",void 0),z([F({type:String,json:{write:!0}})],Qe.prototype,"description",void 0),z([F({type:String,json:{write:{enabled:!0,isRequired:!0}}})],Qe.prototype,"name",void 0),z([F({type:Ke,json:{write:!0}})],Qe.prototype,"originalFormat",void 0),z([F({type:Ke,json:{write:{enabled:!0,isRequired:!0}}})],Qe.prototype,"renderingFormat",void 0),z([F({type:String,json:{write:!0}})],Qe.prototype,"unit",void 0),z([F({type:Number,json:{write:!0}})],Qe.prototype,"volumeId",void 0),z([F({type:["stc-hot-spot-results","stc-cluster-outlier-results","stc-estimated-bin","generic-nearest-interpolated"],json:{write:!0}})],Qe.prototype,"type",void 0),Qe=z([U("esri.layers.support.VoxelVariable")],Qe);const Ye=Qe;let Xe=class extends O{constructor(){super(...arguments),this.values=null}};z([F({type:[Number],json:{write:!0}})],Xe.prototype,"values",void 0),Xe=z([U("esri.layers.support.VoxelIrregularSpacing")],Xe);const ts=Xe;let es=class extends O{constructor(){super(...arguments),this.scale=1,this.offset=0}};z([F({type:Number,json:{write:!0}})],es.prototype,"scale",void 0),z([F({type:Number,json:{write:!0}})],es.prototype,"offset",void 0),es=z([U("esri.layers.support.VoxelRegularSpacing")],es);const ss=es;let is=class extends O{constructor(){super(...arguments),this.irregularSpacing=null,this.isPositiveUp=null,this.isWrappedDateLine=null,this.label=null,this.name=null,this.quantity=null,this.regularSpacing=null,this.size=0,this.unit=null}};z([F({type:ts,json:{write:!0}})],is.prototype,"irregularSpacing",void 0),z([F({type:Boolean,json:{write:!0}})],is.prototype,"isPositiveUp",void 0),z([F({type:Boolean,json:{write:!0}})],is.prototype,"isWrappedDateLine",void 0),z([F({type:String,json:{write:!0}})],is.prototype,"label",void 0),z([F({type:String,json:{write:!0}})],is.prototype,"name",void 0),z([F({type:String,json:{write:!0}})],is.prototype,"quantity",void 0),z([F({type:ss,json:{write:!0}})],is.prototype,"regularSpacing",void 0),z([F({type:Number,json:{write:!0}})],is.prototype,"size",void 0),z([F({type:String,json:{write:!0}})],is.prototype,"unit",void 0),is=z([U("esri.layers.support.VoxelDimension")],is);const ns=is;let rs=class extends O{constructor(){super(...arguments),this.id=0,this.dimensions=null}getZDimension(){if(!this.dimensions)return-1;if(!Array.isArray(this.dimensions))return-1;if(4!==this.dimensions.length)return-1;for(let t=2;t<4;++t)if(this.dimensions[t].size>0)return t;return-1}isVolumeValid(){return!!this.dimensions&&!!Array.isArray(this.dimensions)&&4===this.dimensions.length&&!(this.dimensions[0].size<1||this.dimensions[1].size<1)&&-1!==this.getZDimension()}};z([F({type:Number,json:{write:{enabled:!0,isRequired:!0}}})],rs.prototype,"id",void 0),z([F({type:[ns],json:{write:{enabled:!0,isRequired:!0}}})],rs.prototype,"dimensions",void 0),rs=z([U("esri.layers.support.VoxelVolume")],rs);const os=rs;var hs;let ls=hs=class extends O{constructor(){super(...arguments),this.apronWidth=1,this.brickSize=[32,32,32],this.maxLodLevel=0,this.nodeSize=[4,4,4]}isValid(){const t=new hs;return t.apronWidth===this.apronWidth&&t.maxLodLevel===this.maxLodLevel&&!!this.brickSize&&!!this.nodeSize&&!(!Array.isArray(this.brickSize)||!Array.isArray(this.nodeSize))&&3===this.brickSize.length&&3===this.nodeSize.length&&32===this.brickSize[0]&&32===this.brickSize[1]&&32===this.brickSize[2]&&4===this.nodeSize[0]&&4===this.nodeSize[1]&&4===this.nodeSize[2]}};z([F({type:Number,json:{write:{enabled:!0,isRequired:!0}}})],ls.prototype,"apronWidth",void 0),z([F({type:[Number],json:{write:{enabled:!0,isRequired:!0}}})],ls.prototype,"brickSize",void 0),z([F({type:Number,json:{write:{enabled:!0,isRequired:!0}}})],ls.prototype,"maxLodLevel",void 0),z([F({type:[Number],json:{write:{enabled:!0,isRequired:!0}}})],ls.prototype,"nodeSize",void 0),ls=hs=z([U("esri.layers.support.VoxelVolumeIndex")],ls);const as=ls,us=a.getLogger(" esri.layers.VoxelLayer");let cs=class extends(qt(J(Z(K(Q(Y(X(tt)))))))){constructor(t){super(t),this.serviceRoot="",this.popupEnabled=!0,this.operationalLayerType="Voxel",this.legendEnabled=!0,this.title=null,this.url=null,this.sections=new $,this.style=null,this.opacity=1,this.variables=new $,this.volumes=new $,this.index=null,this.minScale=0,this.maxScale=0,this.type="voxel",this._dbgFlags=new Set,this._handles=new et,this.version={major:Number.NaN,minor:Number.NaN,versionString:""},this._dbgFlags.add(3)}destroy(){this._handles=st(this._handles)}dbg(t,e){this._dbgFlags.has(t)&&(3===t?us.error(e):us.warn(e))}load(t){const e=s(t)?t.signal:null,i=this.loadFromPortal({supportedTypes:["Scene Service"]},t).catch(it).then((()=>this._fetchService(e))).then((()=>this.serviceRoot=this.url));return this.addResolvingPromise(i),Promise.resolve(this)}getConfiguration(){this._handles.add([D((()=>this._getRenderMode()),(t=>this._pushRenderModeToWasm(t))),D((()=>this._getCurrentVariableId()),(t=>this._pushCurrentVariableIdToWasm(t))),D((()=>this._getDynamicSections()),(t=>this._pushDynamicSectionsToWasm(t))),D((()=>this._getSlices()),(t=>this._pushSlicesToWasm(t))),D((()=>this._getSections()),(t=>this._pushSectionsToWasm(t)))]);const t={layerType:this.operationalLayerType,version:this.version.versionString,name:this.title,spatialReference:this.spatialReference,fullExtent:this.fullExtent,volumes:this.volumes.toJSON(),variables:this.variables.toJSON(),index:this.index.toJSON(),sections:this.sections.toJSON(),style:this.style};return t.index&&this.index.isValid()?JSON.stringify(t):""}readVersion(t,e){return super.parseVersionString(t)}_getSections(){const t=[];for(const e of this.sections)t.push(new Pe({enabled:e.enabled,href:e.href,id:e.id,label:e.label,normal:e.normal,point:e.point,sizeInPixel:e.sizeInPixel,slices:e.slices,timeId:e.timeId,variableId:e.variableId}));return t}_pushSectionsToWasm(t){this.dbg(2,"VoxelLayer._pushSectionsToWasm() called"),xe.getInstance().setLayerStaticSections(this,t)||this.dbg(3,"VoxelLayer._pushSectionsToWasm() failed!")}_isPlaneValid(t,e,s){if(!t.point)return!1;if(!Array.isArray(t.point)||3!==t.point.length)return!1;if(!t.normal)return!1;if(!Array.isArray(t.normal)||3!==t.normal.length)return!1;for(let i=0;i<3;++i){const n=t.point[i];if(n<0||n>=s[e[i]].size)return!1}const i=V(t.normal[0],t.normal[1],t.normal[2]);return x(i,i),!(Math.abs(i[0])+Math.abs(i[1])+Math.abs(i[2])<1e-6||(t.normal[0]=i[0],t.normal[1]=i[1],t.normal[2]=i[2],0))}getVariableStyle(t){let e=-1;if(e=s(t)?t:this._getCurrentVariableId(),!(null==this?void 0:this.style.variableStyles)||-1===e)return null;const i=this.style.variableStyles.findIndex((t=>t.variableId===e));return i<0?null:this.style.variableStyles.getItemAt(i)}getVariable(t){let e=-1;if(e=s(t)?t:this._getCurrentVariableId(),!this.variables||-1===e)return null;const i=this.variables.findIndex((t=>t.id===e));return i<0?null:this.variables.getItemAt(i)}_getVolume(t){const e=this.getVariable(t);return s(e)?this.volumes.find((({id:t})=>t===e.volumeId)):null}_getVolumeStyle(t){const e=this.getVariable(t);return s(e)?this.style.volumeStyles.find((({volumeId:t})=>t===e.volumeId)):null}_getSlices(){const t=[],e=this._getVolume(null);if(!s(e)||!e.isVolumeValid())return t;const i=this._getVolumeStyle(null);if(!s(i))return t;for(const s of i.slices)this._isPlaneValid(s,[0,1,e.getZDimension()],e.dimensions)?t.push(new Ne({enabled:s.enabled,label:s.label,point:s.point,normal:s.normal})):t.push(new Ne({enabled:!1,label:"invalid",point:s.point,normal:s.normal}));return t}_pushSlicesToWasm(t){this.dbg(2,"VoxelLayer._pushSlicesToWasm() called!"),xe.getInstance().setLayerSlices(this,t)||this.dbg(3,"VoxelLayer._pushSlicesToWasm() failed!")}_getDynamicSections(){const t=[],e=this._getVolume(null);if(!s(e)||!e.isVolumeValid())return t;const i=this._getVolumeStyle(null);if(!s(i))return t;for(const s of i.dynamicSections)this._isPlaneValid(s,[0,1,e.getZDimension()],e.dimensions)?t.push(new Ve({enabled:s.enabled,label:s.label,point:s.point,normal:s.normal})):t.push(new Ve({enabled:!1,label:"invalid",point:s.point,normal:s.normal}));return t}_pushDynamicSectionsToWasm(t){this.dbg(2,"VoxelLayer._pushDynamicSectionsToWasm() called!"),xe.getInstance().setLayerDynamicSections(this,t)||this.dbg(3,"VoxelLayer._updateDynamicSections() failed!")}_getCurrentVariableId(){return this.style?this.style.currentVariableId:-1}_pushCurrentVariableIdToWasm(t){this.dbg(2,"VoxelLayer._pushCurrentVariableIdToWasm() called!"),xe.getInstance().setLayerCurrentVariable(this,t)||this.dbg(3,"VoxelLayer._pushCurrentVariableIdToWasm() failed!")}_getRenderMode(){return this.style?this.style.renderMode:"volume"}_pushRenderModeToWasm(t){this.dbg(2,"VoxelLayer._pushRenderModeToWasm() called!"),xe.getInstance().setLayerRenderMode(this,t)||this.dbg(3,"VoxelLayer.setLayerRenderMode() failed!")}};z([F(nt)],cs.prototype,"popupEnabled",void 0),z([F({type:["Voxel"]})],cs.prototype,"operationalLayerType",void 0),z([F(rt)],cs.prototype,"legendEnabled",void 0),z([F({json:{write:!0}})],cs.prototype,"title",void 0),z([F({type:String,json:{write:!0}})],cs.prototype,"url",void 0),z([F({type:$.ofType(Pe),json:{write:!0,origins:{"web-scene":{name:"layerDefinition.sections",write:!0},service:{write:!1}}}})],cs.prototype,"sections",void 0),z([F({type:Je,json:{write:!0,origins:{"web-scene":{name:"layerDefinition.style",write:!0},service:{write:!1}}}})],cs.prototype,"style",void 0),z([F({type:["show","hide"]})],cs.prototype,"listMode",void 0),z([F({type:Number,range:{min:0,max:1},nonNullable:!0,json:{read:!1,write:!1,origins:{"web-scene":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],cs.prototype,"opacity",void 0),z([F({type:$.ofType(Ye)})],cs.prototype,"variables",void 0),z([F({type:$.ofType(os)})],cs.prototype,"volumes",void 0),z([F({type:as})],cs.prototype,"index",void 0),z([F({type:Number,json:{name:"layerDefinition.minScale",read:!1,write:!1,origins:{service:{read:!1,write:!1}}}})],cs.prototype,"minScale",void 0),z([F({type:Number,json:{name:"layerDefinition.maxScale",read:!1,write:!1,origins:{service:{read:!1,write:!1}}}})],cs.prototype,"maxScale",void 0),z([F({json:{read:!1},readOnly:!0})],cs.prototype,"type",void 0),z([F({readOnly:!0,json:{name:"serviceVersion"}})],cs.prototype,"version",void 0),z([ot("service","version")],cs.prototype,"readVersion",null),cs=z([U("esri.layers.VoxelLayer")],cs);const ds=cs;export default ds;