import{c as t,s as p,b as i,e as s,d as r,i as e,af as o}from"./p-e58503d5.js";import{r as m}from"./p-4e091578.js";import{l as a}from"./p-728f106f.js";import{h as j}from"./p-75cd09f2.js";import{e as c}from"./p-77b9a0fc.js";import{p as d,r as h}from"./p-6448f4dc.js";import{u as f}from"./p-a63f7978.js";import{i as b}from"./p-07ab8db5.js";import{i as n}from"./p-afa64d84.js";import{a as l}from"./p-b6fa3228.js";import"./p-53bb6ab4.js";import"./p-00d7b2cb.js";import"./p-ea916a39.js";import"./p-2f398ed1.js";import"./p-d3105731.js";import"./p-6484267b.js";import"./p-400ca3dc.js";import"./p-efbca0ca.js";import"./p-9b7a2176.js";import"./p-e654504b.js";import"./p-0eb619a6.js";import"./p-4d17d2cd.js";import"./p-e273719b.js";import"./p-74de0937.js";import"./p-b5b00e38.js";import"./p-a9a30646.js";import"./p-765e6c28.js";import"./p-b79fcce3.js";import"./p-e94b450b.js";import"./p-7731c620.js";import"./p-5d962998.js";import"./p-1189fa83.js";import"./p-37058f88.js";import"./p-3e39c093.js";import"./p-8747982c.js";import"./p-7a5bfd29.js";import"./p-7d081d01.js";import"./p-54330161.js";import"./p-93765525.js";import"./p-8bc9b36a.js";import"./p-7a658388.js";import"./p-fb38a9d0.js";import"./p-f94762ac.js";import"./p-8a919d07.js";import"./p-c048b814.js";import"./p-afac6fb2.js";import"./p-01e5a461.js";import"./p-ca295674.js";import"./p-41f2b2dd.js";import"./p-612a2c14.js";import"./p-d443df87.js";import"./p-7ca40eac.js";import"./p-9087b4d3.js";import"./p-c1cd5521.js";import"./p-ca4492df.js";import"./p-9d34911e.js";import"./p-182bb5be.js";import"./p-db87794e.js";import"./p-2db4840f.js";import"./p-bba8b671.js";import"./p-5e833dfc.js";import"./p-a131049b.js";import"./p-a2324023.js";import"./p-dc852195.js";import"./p-ff2962f5.js";import"./p-da9e7ba9.js";import"./p-a8f0aa27.js";import"./p-4a96de15.js";import"./p-5032dfbd.js";import"./p-a87cccba.js";import"./p-dae095dd.js";import"./p-0e784e4d.js";import"./p-dbdf15fc.js";import"./p-e0d9ff4c.js";import"./p-08e5f531.js";import"./p-dfc6337f.js";import"./p-9f1c2d50.js";import"./p-6b2eb7a7.js";import"./p-889f7a78.js";import"./p-1f81b35d.js";import"./p-81b9df84.js";import"./p-5ce39624.js";import"./p-e9bae5e9.js";import"./p-b0565d49.js";import"./p-51a17e75.js";import"./p-d208934e.js";import"./p-480e5606.js";import"./p-22c9f19c.js";import"./p-c096b5df.js";import"./p-da33e926.js";import"./p-a24f7752.js";import"./p-ccdb8e80.js";import"./p-4a6dc5e4.js";import"./p-6a92ecb9.js";import"./p-1ab449fc.js";import"./p-a6c8fb32.js";import"./p-0edb3309.js";import"./p-e8160b60.js";import"./p-2e8ad983.js";import"./p-e3270d48.js";import"./p-e44bd0a6.js";import"./p-fe68aab5.js";import"./p-c6970847.js";import"./p-de86b3c9.js";import"./p-37d3434c.js";import"./p-120b7410.js";import"./p-b1eff69d.js";import"./p-612de336.js";import"./p-91fe06d4.js";import"./p-ab0e9273.js";import"./p-15a9486c.js";import"./p-2ae44317.js";import"./p-9f58a277.js";import"./p-9e860e7b.js";import"./p-f3659a34.js";import"./p-ca657fcf.js";import"./p-b312c1fd.js";import"./p-b8beb0d3.js";import"./p-2a99994a.js";import"./p-76f37e40.js";import"./p-eee9ef50.js";import"./p-6ded4c02.js";import"./p-1e473dab.js";import"./p-d1d9dbe4.js";import"./p-d57f9971.js";import"./p-b9aa4901.js";import"./p-e6fe5d89.js";import"./p-56ed1c7a.js";import"./p-746a9d8f.js";import"./p-db4d63dc.js";import"./p-6d6923ed.js";import"./p-1c2ff3a7.js";import"./p-0bb84768.js";import"./p-1ccb0bf6.js";import"./p-1676d4c7.js";import"./p-47e1bd73.js";import"./p-19bc1e3d.js";import"./p-09dd2137.js";import"./p-e3500fdc.js";import"./p-ad14ca1b.js";import"./p-b392deaf.js";import"./p-4414d64f.js";import"./p-a617738c.js";import"./p-b9c93bb2.js";import"./p-f971b161.js";import"./p-6fe4db61.js";import"./p-a2b6db85.js";import"./p-2e5dd2d0.js";import"./p-56ca6f1f.js";import"./p-0bb41218.js";import"./p-97ec6ae5.js";import"./p-285c6a34.js";const u=t.getLogger("esri.views.2d.layers.TileLayerView2D"),w=[0,0];let y=class extends(n(b(m(a(f))))){constructor(){super(...arguments),this._tileStrategy=null,this._fetchQueue=null,this.layer=null}initialize(){const t=this.layer.tileInfo,i=t&&t.spatialReference;let s;i||(s=new p("layerview:tiling-information-missing","The layer doesn't provide tiling information",{layer:this.layer})),i.equals(this.view.spatialReference)||(s=new p("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer})),this.watch("resampling",(()=>{this.doRefresh()})),s&&this.addResolvingPromise(Promise.reject(s))}get resampling(){return!("resampling"in this.layer)||!1!==this.layer.resampling}hitTest(){return null}update(t){this._fetchQueue.pause(),this._fetchQueue.state=t.state,this._tileStrategy.update(t),this._fetchQueue.resume(),this.notifyChange("updating")}attach(){const t="tileServers"in this.layer?this.layer.tileServers:null;this._tileInfoView=new j(this.layer.tileInfo,this.layer.fullExtent),this._fetchQueue=new d({tileInfoView:this._tileInfoView,concurrency:t&&10*t.length||10,process:(t,p)=>this.fetchTile(t,p)}),this._tileStrategy=new h({cachePolicy:"keep",resampling:this.resampling,acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),tileInfoView:this._tileInfoView}),this.requestUpdate(),this.container.requestRender(),super.attach()}detach(){super.detach(),this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}createFetchPopupFeaturesQueryGeometry(t,p){return l(t,p,this.view)}async doRefresh(){this.updateRequested||this.suspended||(this._fetchQueue.reset(),this._tileStrategy.tiles.forEach((t=>this._enqueueTileFetch(t))),this.notifyChange("updating"))}isUpdating(){var t;return(null==(t=this._fetchQueue)?void 0:t.length)>0}acquireTile(t){const p=this._bitmapView.createTile(t),i=p.bitmap;return[i.x,i.y]=this._tileInfoView.getTileCoords(w,p.key),i.resolution=this._tileInfoView.getTileResolution(p.key),[i.width,i.height]=this._tileInfoView.tileInfo.size,this._enqueueTileFetch(p),this._bitmapView.addChild(p),this.requestUpdate(),p}releaseTile(t){this._fetchQueue.abort(t.key.id),this._bitmapView.removeChild(t),t.once("detach",(()=>t.destroy())),this.requestUpdate()}async fetchTile(t,p){const s="tilemapCache"in this.layer?this.layer.tilemapCache:null,r=!o(p)&&p.signal;if(!s)try{return await this._fetchImage(t,r)}catch(t){if(!i(t)&&!this.resampling)return this._createBlankImage();throw t}const e=new c(0,0,0,0);let m;try{if(await s.fetchAvailabilityUpsample(t.level,t.row,t.col,e,{signal:r}),e.level!==t.level&&!this.resampling)return this._createBlankImage();m=await this._fetchImage(e,r)}catch(p){if(i(p))throw p;m=await this._fetchImage(t,r)}const{level:a,row:j,col:d}=e;return this.resampling&&a!==t.level?this._resampleImage(m,a,j,d,t.level,t.row,t.col):m}async _enqueueTileFetch(t){if(!this._fetchQueue.has(t.key.id)){try{const p=await this._fetchQueue.push(t.key);t.bitmap.source=p,t.bitmap.width=this._tileInfoView.tileInfo.size[0],t.bitmap.height=this._tileInfoView.tileInfo.size[1],t.once("attach",(()=>this.requestUpdate()))}catch(t){i(t)||u.error(t)}this.requestUpdate()}}async _fetchImage(t,p){return this.layer.fetchTile(t.level,t.row,t.col,{signal:p})}_resampleImage(t,p,i,s,r,e,o){const m=this._tileInfoView.tileInfo.size,a=this._tileInfoView.getTileResolution(p),j=this._tileInfoView.getTileResolution(r);let c=this._tileInfoView.getLODInfoAt(r);const d=c.getXForColumn(o),h=c.getYForRow(e);c=this._tileInfoView.getLODInfoAt(p);const f=c.getXForColumn(s),b=c.getYForRow(i),n=Math.round((d-f)/a),l=Math.round(-(h-b)/a),u=Math.round(m[0]*(j/a)),w=Math.round(m[1]*(j/a)),y=this._createBlankImage();return y.getContext("2d").drawImage(t,n,l,u,w,0,0,m[0],m[1]),y}_createBlankImage(){const t=this._tileInfoView.tileInfo.size,p=document.createElement("canvas");return[p.width,p.height]=t,p}};s([r()],y.prototype,"resampling",null),y=s([e("esri.views.2d.layers.TileLayerView2D")],y);const g=y;export default g;