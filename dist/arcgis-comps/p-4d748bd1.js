import"./p-b79fcce3.js";import{e as t,aE as s,r as e,cJ as i,af as r,aW as n,A as a,V as o,K as c,d as h,f as l,aX as u,i as d,a1 as f,D as p,dD as m,c as g}from"./p-e58503d5.js";import{a as v,o as b,d as w,u as y,L as j,I as S,r as P,g as C,c as k,M as x,_ as O,B as M,s as E,m as _}from"./p-2f398ed1.js";import{n as z,s as D,e as F,r as T,h as W,m as N,i as A,b as R,c as V,P as L}from"./p-ccdb8e80.js";import{e as I}from"./p-2c84c65f.js";import{S as B}from"./p-a3955219.js";import{n as U,f as q,r as G}from"./p-d3105731.js";import{p as $,G as H,m as J,K}from"./p-ea0c022e.js";import{v as X,D as Q,p as Y,B as Z}from"./p-dcdb33cf.js";import{d as tt,i as st}from"./p-95909347.js";import{c as et,f as it,o as rt}from"./p-3c70d22f.js";import{i as nt,x as at,d as ot,y as ct}from"./p-fb38a9d0.js";import{a as ht}from"./p-b9aa4901.js";import{e as lt}from"./p-8f986f60.js";import{q as ut}from"./p-e6fe5d89.js";import{t as dt,o as ft,e as pt,z as mt}from"./p-c93d2280.js";import{p as gt}from"./p-01e5a461.js";import{j as vt}from"./p-ea916a39.js";import{b as bt,l as wt,B as yt,v as jt}from"./p-1c99992b.js";import{aG as St,J as Pt,aU as Ct,n as kt,i as xt,aI as Ot,a9 as Mt,aV as Et,aH as _t,aW as zt,P as Dt,ay as Ft,au as Tt}from"./p-340cd100.js";import{s as Wt}from"./p-70787875.js";import{T as Nt}from"./p-728dcbb0.js";import{n as At,r as Rt}from"./p-4d38e149.js";import{p as Vt,Y as Lt}from"./p-f94762ac.js";import{i as It}from"./p-f06611ed.js";import{A as Bt}from"./p-a72732f2.js";import{t as Ut,n as qt,r as Gt,w as $t,h as Ht,a as Jt,J as Kt,I as Xt,e as Qt,b as Yt,c as Zt,d as ts,k as ss,X as es,a7 as is,a8 as rs,a9 as ns,f as as,ad as os,aa as cs,av as hs,ar as ls,au as us,ae as ds,o as fs,a0 as ps}from"./p-eb48bb01.js";import{i as ms}from"./p-7f47b970.js";import{g as gs,u as vs,c as bs,s as ws,l as ys,f as js,r as Ss,d as Ps,e as Cs}from"./p-bdf9e611.js";import{c as ks,m as xs}from"./p-c96ccdbf.js";import{r as Os}from"./p-09dd2137.js";import{h as Ms}from"./p-86bdfe14.js";import{g as Es}from"./p-1907e0bc.js";import{U as _s}from"./p-6ded4c02.js";function zs(t){t.vertex.uniforms.add("camPos","vec3").add("perScreenPixelRatio","float").add("screenSize","float"),t.vertex.code.add(Ut`float computeRenderPixelSizeAt( vec3 pWorld ){
vec3 viewForward = - vec3(view[0][2], view[1][2], view[2][2]);
float viewDirectionDistance = abs(dot(viewForward, pWorld - camPos));
return viewDirectionDistance*perScreenPixelRatio;
}
vec3 screenSizeScaling(vec3 position, vec3 anchor){
return position * screenSize * computeRenderPixelSizeAt(anchor) + anchor;
}`)}function Ds(t){const s=new qt;return s.include(Gt,{linearDepth:!1}),s.include(zs,{}),s.include($t,t),s.fragment.include(Ht),s.vertex.uniforms.add("proj","mat4").add("view","mat4"),s.fragment.uniforms.add("color","vec4"),s.attributes.add("position","vec3"),s.varyings.add("vWorldPosition","vec3"),t.multipassTerrainEnabled&&s.varyings.add("depth","float"),t.screenSizeEnabled&&s.attributes.add("offset","vec3"),t.shadingEnabled&&(s.vertex.uniforms.add("viewNormal","mat4"),s.fragment.uniforms.add("shadedColor","vec4").add("shadingDirection","vec3"),s.attributes.add("normal","vec3"),s.varyings.add("vViewNormal","vec3")),s.vertex.code.add(Ut`
    void main(void) {
      vWorldPosition = ${t.screenSizeEnabled?"screenSizeScaling(offset, position)":"position"};
  `),t.shadingEnabled&&s.vertex.code.add(Ut`vec3 worldNormal = normal;
vViewNormal = (viewNormal * vec4(worldNormal, 1)).xyz;`),s.vertex.code.add(Ut`
    ${t.multipassTerrainEnabled?"depth = (view * vec4(vWorldPosition, 1.0)).z;":""}
    gl_Position = transformPosition(proj, view, vWorldPosition);
  }
  `),t.multipassTerrainEnabled&&(s.fragment.include(Jt),s.include(Kt,t)),s.fragment.code.add(Ut`
    void main() {
      discardBySlice(vWorldPosition);
      ${t.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
    `),s.fragment.code.add(t.shadingEnabled?Ut`vec3 viewNormalNorm = normalize(vViewNormal);
float shadingFactor = 1.0 - clamp(-dot(viewNormalNorm, shadingDirection), 0.0, 1.0);
vec4 finalColor = mix(color, shadedColor, shadingFactor);`:Ut`vec4 finalColor = color;`),s.fragment.code.add(Ut`
      if (finalColor.a < ${Ut.float(Xt)}) {
        discard;
      }
      ${7===t.output?Ut`gl_FragColor = vec4(finalColor.a);`:""}

      ${0===t.output?Ut`gl_FragColor = highlightSlice(finalColor, vWorldPosition); ${t.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    }
    `),s}const Fs=Object.freeze({__proto__:null,build:Ds});class Ts extends Zt{initializeProgram(t){const s=Ts.shader.get(),e=this.configuration,i=s.build({output:e.output,slicePlaneEnabled:e.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,screenSizeEnabled:e.screenSizeEnabled,shadingEnabled:e.shadingEnabled,OITEnabled:0===e.transparencyPassType,multipassTerrainEnabled:e.multipassTerrainEnabled,cullAboveGround:e.cullAboveGround});return new ts(t.rctx,i,Ns)}bindPass(t,s){const{screenSizeEnabled:e,shadingEnabled:i}=this.configuration,{color:r,shadingTint:n,shadingDirection:a}=t;ss(this.program,s.camera.projectionMatrix),this.program.setUniform4fv("color",r),s.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",s.camera.nearFar),this.program.setUniform2fv("inverseViewport",s.inverseViewport),es(this.program,s)),i&&(this.program.setUniform4fv("shadedColor",this.blendColor(As,n,r)),this.program.setUniform3fv("shadingDirection",a),this.program.setUniformMatrix4fv("viewNormal",s.camera.viewInverseTransposeMatrix)),e&&function(t,s,e){t.setUniform1f("perScreenPixelRatio",e.camera.perScreenPixelRatio),t.setUniform1f("screenSize",s.screenSize)}(this.program,t,s)}bindDraw(t){is(this.program,t),rs(this.program,t.origin,t.camera.viewInverseTransposeMatrix),ns(this.program,this.configuration,t),this.program.rebindTextures()}blendColor(t,s,e){const i=1-s[3],r=s[3]+e[3]*i;return 0===r?(t[3]=r,t):(t[0]=(s[0]*s[3]+e[0]*e[3]*i)/r,t[1]=(s[1]*s[3]+e[1]*e[3]*i)/r,t[2]=(s[2]*s[3]+e[2]*e[3]*i)/r,t[3]=e[3],t)}setPipelineState(t){const s=this.configuration,e=3===t,i=2===t;return gs({blending:0!==s.output&&7!==s.output||!s.transparent?null:e?vs:bs(t),culling:ws(s.cullFace),depthTest:{func:i?513:s.shadingEnabled?515:513},depthWrite:e?s.writeDepth&&ys:js(t),colorWrite:Ss,polygonOffset:e||i?null:Ps})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}Ts.shader=new as(Fs,(()=>import("./p-dc58e202.js")));class Ws extends Yt{constructor(){super(...arguments),this.output=0,this.cullFace=0,this.slicePlaneEnabled=!1,this.transparent=!1,this.writeDepth=!0,this.screenSizeEnabled=!0,this.shadingEnabled=!0,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}t([Qt({count:8})],Ws.prototype,"output",void 0),t([Qt({count:3})],Ws.prototype,"cullFace",void 0),t([Qt()],Ws.prototype,"slicePlaneEnabled",void 0),t([Qt()],Ws.prototype,"transparent",void 0),t([Qt()],Ws.prototype,"writeDepth",void 0),t([Qt()],Ws.prototype,"screenSizeEnabled",void 0),t([Qt()],Ws.prototype,"shadingEnabled",void 0),t([Qt({count:4})],Ws.prototype,"transparencyPassType",void 0),t([Qt()],Ws.prototype,"multipassTerrainEnabled",void 0),t([Qt()],Ws.prototype,"cullAboveGround",void 0);const Ns=new Map([["position",0],["normal",1],["offset",2]]),As=At();class Rs extends cs{constructor(t){super(t,Ls),this.supportsEdges=!0,this.techniqueConfig=new Ws,this._vertexAttributeLocations=Ns}getTechniqueConfig(t,s){return this.techniqueConfig.output=t,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.screenSizeEnabled=this.parameters.screenSizeEnabled,this.techniqueConfig.shadingEnabled=this.parameters.shadingEnabled,this.techniqueConfig.transparencyPassType=s.transparencyPassType,this.techniqueConfig.multipassTerrainEnabled=s.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=s.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}intersect(t,s,e,i,r,n,a){if(this.parameters.screenSizeEnabled){const e=t.vertexAttributes.get("offset"),o={applyToVertex:(t,s,r,n)=>{const a=b(Bs,e.data[3*n+0],e.data[3*n+1],e.data[3*n+2]),o=b(Us,t,s,r);return w(a,a,this.parameters.screenSize*i.camera.computeRenderPixelSizeAt(a)),y(o,o,a),[o[0],o[1],o[2]]},applyToAabb:t=>{const s=Vt(t,Bs);return Lt(t,this.parameters.screenSize*i.camera.computeRenderPixelSizeAt(s))}};hs(t,s,i,r,n,o,a)}else hs(t,s,i,r,n,void 0,a)}requiresSlot(t,s){if(4===St(s))return 2===t;let e=2;return this.parameters.transparent&&(e=this.parameters.writeDepth?4:7),t===e||20===t}createGLMaterial(t){return 0===t.output||7===t.output||4===t.output?new Vs(t):null}createBufferWriter(){return new Is(this.parameters.screenSizeEnabled)}}class Vs extends ls{updateParameters(t){return this.ensureTechnique(Ts,t)}beginSlot(t){return this.updateParameters(t)}bind(t,s){s.bindPass(this._material.getPassParameters(),t)}}const Ls={color:[1,1,1,1],shadingTint:[0,0,0,.25],shadingDirection:v(U(),[.5,-.5,-.5]),transparent:!1,writeDepth:!0,slicePlaneEnabled:!1,cullFace:0,screenSizeEnabled:!1,screenSize:14,shadingEnabled:!0,...os};class Is{constructor(t){this.screenSizeEnabled=t;const s=Bt().vec3f("position").vec3f("normal");this.screenSizeEnabled&&s.vec3f("offset"),this.vertexBufferLayout=s}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get("position").length}write(t,s,e,i){if(us(s,this.vertexBufferLayout,t.transformation,t.invTranspTransformation,e,i),this.screenSizeEnabled){if(!s.vertexAttributes.has("offset"))throw new Error("offset vertex attribute required for screenSizeEnabled ShadedColorMaterial");{const r=s.vertexAttributes.get("offset"),n=s.indices.get("offset");ms(3===r.size);const a=e.getField("offset",It);if(!a)throw new Error("unable to acquire view for offset");ds(n,r.data,t.invTranspTransformation,a,i)}}}}const Bs=U(),Us=U();class qs{constructor(t){this.camera=new Pt,this._elevation={offset:0,override:null},this.collisionType={type:"point"},this.collisionPriority=0,this._renderObjects=[],this.autoScaleRenderObjects=!0,this._available=!0,this._noDisplayCount=0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=I(),this._worldFrame=null,this._renderLocation=U(),this._renderLocationDirty=!0,this._location=new s({x:0,y:0,z:0}),this._elevationAlignedLocation=new s,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.cursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=0,this._focused=!1,this.events=new e.EventEmitter,this._screenLocation={screenPointArray:nt(),renderScreenPointArray:at(),pixelSize:0},this._screenLocationDirty=!0,this._applyObjectTransform=null,this._engineResourcesAddedToStage=!1,this._engineResources=null,this._attached=!1,this._engineLayer=null,this._materialIdReferences=null,this._location.spatialReference=t.view.spatialReference;for(const s in t)this[s]=t[s];this.view.state&&this.view.state.camera&&this.camera.copyFrom(this.view.state.camera)}destroy(){this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this.camera=null}get elevationInfo(){return this._elevationInfo}set elevationInfo(t){this._elevationInfo=t,this._elevationAlignedLocationDirty=!0,this._renderLocationDirty=!0,this._updateEngineObject()}get renderObjects(){return this._renderObjects}set renderObjects(t){this._removeResourcesFromStage(),this._engineResources=null,this._renderObjects=t.slice(),this._updateEngineObject()}set available(t){t!==this._available&&(this._available=t,this._updateEngineObject())}get available(){return this._available}disableDisplay(){return this._noDisplayCount++,1===this._noDisplayCount&&this._updateEngineObject(),{remove:i((()=>{this._noDisplayCount--,0===this._noDisplayCount&&this._updateEngineObject()}))}}set radius(t){t!==this._radius&&(this._radius=t,this._updateEngineObject())}get radius(){return this._radius}set worldSized(t){t!==this._worldSized&&(this._worldSized=t,this._updateEngineObject())}get worldSized(){return this._worldSized}get modelTransform(){return this._modelTransform}set modelTransform(t){Gs(t)&&(this._screenLocationDirty=!0),z(this._modelTransform,t),this._updateEngineObject()}get renderLocation(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=I()),function(t,s,e){switch(t.viewingMode){case"local":return T(e),!0;case"global":{const i=gt(t.renderCoordsHelper.spatialReference);pt(s,0,Zs,0,i.radius),mt(x(Zs[0]),x(Zs[1]),e)}}}(this.view,this._renderLocation,this._worldFrame)):this._worldFrame&&(this._worldFrame=null)),this._renderLocation}set renderLocation(t){this.view.renderCoordsHelper.fromRenderCoords(t,this._location),this.elevationAlignedLocation=this._location}get location(){return this._location}set location(t){Ct(t,this._location),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}get elevationAlignedLocation(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this._elevationAlignedLocation}set elevationAlignedLocation(t){Ct(t,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}_updateElevationAlignedLocation(){this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y;const t=a(this._elevation.override)?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.z=t+this._elevation.offset,this._elevationAlignedLocation.spatialReference=this.location.spatialReference,this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!1}grabbableForEvent(){return!0}get grabbing(){return this._grabbing}set grabbing(t){t!==this._grabbing&&(this._grabbing=t,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get hovering(){return this._hovering}set hovering(t){t!==this._hovering&&(this._hovering=t,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get selected(){return this._selected}set selected(t){t!==this._selected&&(this._selected=t,this._updateEngineObject(),this.events.emit("select-changed",{action:t?"select":"deselect"}))}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._updateEngineObject())}updateStateEnabled(t,s){s?this.state|=t:this.state&=~t}_setFocused(t){t!==this._focused&&(this._focused=t,this.events.emit("focus-changed",{action:!0===t?"focus":"unfocus"}))}get focused(){return this._focused}get screenLocation(){return this.ensureScreenLocation(),this._screenLocation}ensureScreenLocation(){if(!this._screenLocationDirty)return;let t;if(this._screenLocation.pixelSize=this.camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1,Gs(this._modelTransform)){const s=this._calculateModelTransformOffset(re);t=y(s,s,this.renderLocation)}else t=this.renderLocation;this.camera.projectToRenderScreen(t,this._screenLocation.renderScreenPointArray),this.camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}get applyObjectTransform(){return this._applyObjectTransform}set applyObjectTransform(t){this._applyObjectTransform=t,this._screenLocationDirty=!0,this._updateEngineObject()}intersectionDistance(t,s){if(!this.available)return null;const e=ot(t,$s),i=this._getCollisionRadius(s),n=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if(ut(this.screenLocation.screenPointArray,e)<i*i)return this.screenLocation.renderScreenPointArray[2]+n;break;case"line":{const t=this.collisionType.paths,s=this._getWorldToScreenObjectScale(),a=this._calculateObjectTransform(s,Qs),o=i*this.screenLocation.pixelSize,c=Wt(this.camera,e,Js);if(r(c))return null;for(const s of t){if(0===s.length)continue;const t=S(Zs,s[0],a);for(let e=1;e<s.length;e++){const i=S(te,s[e],a),r=yt(wt(t,i,Hs),c);if(null!=r&&r<o*o){const s=y(et.get(),t,i);w(s,s,.5);const e=ct(et.get());return this.camera.projectToRenderScreen(s,e),e[2]+n}P(t,i)}}break}case"disc":{var a;const t=this.collisionType.direction,s=null!=(a=this.collisionType.offset)?a:q,o=this._getWorldToScreenObjectScale(),c=this._calculateObjectTransform(o,Qs),h=i*this.screenLocation.pixelSize,l=Wt(this.camera,e,Js);if(r(l))return null;const u=ht(Ks,c),d=j(ee,t,u),f=S(ie,s,c);X(f,d,Ys);const p=se;if(Q(Ys,l,p)&&C(p,f)<h*h)return this.screenLocation.renderScreenPointArray[2]+n;break}case"ribbon":{const{paths:t,direction:s}=this.collisionType,a=this._getWorldToScreenObjectScale(),o=this._calculateObjectTransform(a,Qs),c=i*this.camera.computeScreenPixelSizeAt(this.renderLocation),h=Wt(this.camera,e,Js);if(r(h))return null;const l=ht(Ks,o),u=j(ee,s,l),d=this._calculateModelTransformPosition(ie);X(d,u,Ys);const f=se;if(!Q(Ys,h,f))break;for(const s of t){if(0===s.length)continue;const t=S(Zs,s[0],o);for(let e=1;e<s.length;e++){const i=S(te,s[e],o),r=bt(wt(t,i,Hs),f);if(null!=r&&r<c*c){const s=y(et.get(),t,i);w(s,s,.5);const e=ct(et.get());return this.camera.projectToRenderScreen(s,e),e[2]+n}P(t,i)}}break}}return null}attach(t={manipulator3D:{}}){var e;if(!this.view._stage)return;const i=t.manipulator3D;if(r(i.engineLayerId)){const t=new kt({isPickable:!1,updatePolicy:1});this.view._stage.add(t),i.engineLayerId=t.id,this._engineLayer=t}else null!=(e=this.view._stage)&&e.getObject&&(this._engineLayer=this.view._stage.getObject(i.engineLayerId));i.engineLayerReferences=(i.engineLayerReferences||0)+1,this._materialIdReferences=i.materialIdReferences,r(this._materialIdReferences)&&(this._materialIdReferences=new Map,i.materialIdReferences=this._materialIdReferences),this.camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),dt(this._location.spatialReference,this.view.spatialReference)||(this.location=new s({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}detach(t={manipulator3D:{}}){const s=t.manipulator3D;s.engineLayerReferences--;const e=0===s.engineLayerReferences;e&&(s.engineLayerId=null),this._removeResourcesFromStage(e),this._engineResources=null,this._engineLayer=null,this._materialIdReferences=null,this._attached=!1}onViewChange(){this.camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()}onElevationChange(t){ft(this.location,ne,t.spatialReference),vt(t.extent,ne)&&(this.location=this._location)}_evaluateElevationAlignment(t=this.location){if(r(this.elevationInfo))return!1;let s=null,e=0;const i=n(this.elevationInfo.offset,0);switch(this.elevationInfo.mode){case"on-the-ground":s=n(xt(this.view.elevationProvider,t,"ground"),0);break;case"relative-to-ground":e=n(xt(this.view.elevationProvider,t,"ground"),0)+i;break;case"relative-to-scene":e=n(xt(this.view.elevationProvider,t,"scene"),0)+i;break;case"absolute-height":e=i}return(e!==this._elevation.offset||s!==this._elevation.override)&&(this._elevation.offset=e,this._elevation.override=s,!0)}_updateEngineObject(){if(!this._attached)return;if(!this.available)return void this._removeResourcesFromStage();const t=this._getWorldToScreenObjectScale(),s=Qs;if(!0===this.autoScaleRenderObjects){const e=this._getFocusedSize(this._radius,this.focused)*t;this._calculateObjectTransform(e,s)}else this._calculateObjectTransform(t,s);const{objectsByState:e}=this._ensureEngineResources(),i=(this.focused?2:1)|(this.selected?8:4),r=this._noDisplayCount>0;for(const{stateMask:t,objects:n}of e){if(r){for(const t of n)t.setVisible(!1);continue}const e=!(0!=(65520&t))||(this.state&t)==(65520&t);if(0!=(15&t)&&(i&t)!=(15&t)||!e)for(const t of n)t.setVisible(!1);else for(const t of n)t.setVisible(!0),t.transformation=s}}_ensureEngineResources(){if(r(this._engineResources)){const t=o(this._engineLayer),s=[],e=new Set;this.renderObjects.forEach((({material:t})=>{e.has(t)||(s.push(t),e.add(t))}));const i=(t,s)=>{const{geometry:e,material:i,transform:r}=s;Array.isArray(e)?e.forEach((s=>t.addGeometry(s,i,r))):t.addGeometry(e,i,r)},r=new Map;this._renderObjects.forEach((t=>{const s=new Nt({castShadow:!1});i(s,t);const e=t.stateMask||0,n=r.get(e)||[];n.push(s),r.set(e,n)}));const n=[];r.forEach(((t,s)=>n.push({stateMask:s,objects:t}))),this._engineResources={objectsByState:n,layer:t,materials:s}}return this._addResourcesToStage(),this._engineResources}_addResourcesToStage(){if(this._engineResourcesAddedToStage||r(this._engineResources))return;const{objectsByState:t,layer:s,materials:e}=this._engineResources;e.forEach((t=>{const s=o(this._materialIdReferences),e=s.get(t.id)||0;0===e&&this.view._stage.add(t),s.set(t.id,e+1)})),t.forEach((({objects:t})=>{s.addMany(t),this.view._stage.addMany(t)})),this._engineResourcesAddedToStage=!0}_removeResourcesFromStage(t=!1){if(!this._engineResourcesAddedToStage||r(this._engineResources))return;const{objectsByState:s,layer:e,materials:i}=this._engineResources;s.forEach((({objects:t})=>{e.removeMany(t),this.view._stage.removeMany(t)})),i.forEach((t=>{const s=o(this._materialIdReferences),e=s.get(t.id);1===e?(this.view._stage.remove(t),s.delete(t.id)):s.set(t.id,e-1)})),t&&this.view._stage.remove(e),this._engineResourcesAddedToStage=!1}_getCollisionRadius(t){return this._getFocusedSize(this.radius,!0)*("touch"===t?this.touchMultiplier:1)}_getFocusedSize(t,s){return t*(s?this.focusMultiplier:1)}_getWorldToScreenObjectScale(){return this._worldSized?1:this.screenLocation.pixelSize}_calculateModelTransformPosition(t){const s=this._getWorldToScreenObjectScale(),e=this._calculateObjectTransform(s,Xs);return b(t,e[12],e[13],e[14])}_calculateModelTransformOffset(t){const s=this._calculateModelTransformPosition(t);return k(t,s,this.renderLocation)}_calculateObjectTransform(t,s){return D(s,t,0,0,0,0,t,0,0,0,0,t,0,0,0,0,1),this._worldFrame&&F(s,s,this._worldFrame),F(s,s,this._modelTransform),s[12]+=this.renderLocation[0],s[13]+=this.renderLocation[1],s[14]+=this.renderLocation[2],s[15]=1,a(this._applyObjectTransform)&&this._applyObjectTransform(s),s}get test(){let t=!1;if(a(this._engineResources))for(const s in this._engineResources.objectsByState){const e=this._engineResources.objectsByState[s];for(const s of e.objects)if(s.isVisible){t=!0;break}if(t)break}return{areAnyResourcesVisible:t}}}function Gs(t){return 0!==t[12]||0!==t[13]||0!==t[14]}const $s=nt(),Hs=jt(),Js=tt(),Ks=lt(),Xs=I(),Qs=I(),Ys=Y(),Zs=U(),te=U(),se=U(),ee=U(),ie=U(),re=U(),ne=new s({x:0,y:0,z:0,spatialReference:null});function ae(t,s=4,e=!0){const i=Rt(t[0],t[1],t[2],t.length>3?t[3]:1),r=t[3]<1;return e?new Rs({color:i,transparent:r,writeDepth:!0,cullFace:2,renderOccluded:s}):new Ot({color:i,transparent:r,writeDepth:!0,cullFace:2,renderOccluded:s})}function oe(t,s=4){const e=Rt(t[0],t[1],t[2],4===t.length?t[3]:1);return new Ot({color:e,transparent:!0,writeDepth:!0,cullFace:1,renderOccluded:s})}function ce(t,s,e,i){const r=k(et.get(),t,e),n=he(r,O(et.get(),i,r),e,it.get());W(n,n);const a=S(et.get(),s,n);return Math.atan2(a[1],a[0])}function he(t,s,e,i){const r=v(et.get(),t),n=v(et.get(),s),a=O(et.get(),r,n);return i[0]=r[0],i[1]=r[1],i[2]=r[2],i[3]=0,i[4]=n[0],i[5]=n[1],i[6]=n[2],i[7]=0,i[8]=a[0],i[9]=a[1],i[10]=a[2],i[11]=0,i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=1,i}function le(t,s){const e=t.getViewForGraphic(s);return a(e)&&"computeAttachmentOrigin"in e?e.computeAttachmentOrigin(s,t.spatialReference):null}function ue(t,s,e){const i=le(t,e);a(i)?s.elevationAlignedLocation=i:function(t,s){if(r(s))return;const e="mesh"===s.type?s.anchor:Mt(s);r(e)||(t.location=Et(e))}(s,e.geometry)}c("mac");const de=[1,.5,0],fe=2,pe=1,me=[...de,.7],ge=[0,0,0,.04],ve=[...de,.5],be=[...de,1],we=[1,1,1,1],ye=[1,.8,.6,1],je=[1,.93,.86,1],Se=[...de,1],Pe=[...de,1],Ce=[...de,1];function ke(){const t=new qt;return t.extensions.add("GL_OES_standard_derivatives"),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.attributes.add("position","vec3"),t.attributes.add("uv0","vec2"),t.varyings.add("vUV","vec2"),t.vertex.code.add(Ut`void main(void) {
vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);
}`),t.fragment.uniforms.add("backgroundColor","vec4").add("gridColor","vec4").add("ratio","float").add("gridWidth","float"),t.fragment.code.add(Ut`void main() {
const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
gl_FragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;
}`),t}const xe=Object.freeze({__proto__:null,build:ke});class Oe extends Zt{initializeProgram(t){const s=Oe.shader.get().build();return new ts(t.rctx,s,fs)}bindPass(t,s){ss(this.program,s.camera.projectionMatrix),this.program.setUniform4fv("backgroundColor",t.backgroundColor),this.program.setUniform4fv("gridColor",t.gridColor),this.program.setUniform1f("gridWidth",t.gridWidth)}bindDraw(t){is(this.program,t),this.program.rebindTextures()}initializePipeline(){return gs({blending:Cs(1,1,771,771),depthTest:{func:513},colorWrite:Ss})}}Oe.shader=new as(xe,(()=>import("./p-ce84a392.js")));class Me extends cs{constructor(t){super(t,_e),this._config=new Yt}intersect(t,s,e,i,r,n,a){return hs(t,s,i,r,n,void 0,a)}createBufferWriter(){return new _t(zt)}requiresSlot(t){return 7===t}createGLMaterial(t){return 0===t.output?new Ee(t):null}getTechniqueConfig(){return this._config}}class Ee extends ls{constructor(t){super(t),this.ensureTechnique(Oe,null)}updateParameters(){return o(this.technique)}beginSlot(){return o(this.technique)}bind(t,s){s.bindPass(this._material.parameters,t)}}const _e={backgroundColor:[1,0,0,.5],gridColor:[0,1,0,.5],gridWidth:4,...os};class ze extends ks{constructor(t){super(t),this._material=null,this._renderOccluded=4,this._gridWidth=1,this._gridColor=Os(1,0,0,1),this._backgroundColor=Os(1,0,0,1),this.applyProps(t)}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this._updateMaterial())}get gridWidth(){return this._gridWidth}set gridWidth(t){this._gridWidth!==t&&(this._gridWidth=t,this._updateMaterial())}get gridColor(){return this._gridColor}set gridColor(t){M(this._gridColor,t),this._updateMaterial()}get backgroundColor(){return this._backgroundColor}set backgroundColor(t){M(this._backgroundColor,t),this._updateMaterial()}createExternalResources(){this._material=new Me(this.materialParameters)}destroyExternalResources(){this._material=null}forEachExternalMaterial(t){a(this._material)&&t(this._material)}createGeometries(t){if(a(this._material)){const s=Dt.createSquareGeometry();t.addGeometry(s,this._material)}}get materialParameters(){return{backgroundColor:this._backgroundColor,gridWidth:this._gridWidth,gridColor:this._gridColor,renderOccluded:this._renderOccluded}}_updateMaterial(){a(this._material)&&this._material.setParameters(this.materialParameters)}}var De;let Fe=De=class extends f{constructor(t){super(t),this.type="plane",this.position=null,this.heading=0,this.tilt=0,this.width=10,this.height=10}clone(){return new De({position:p(this.position),heading:this.heading,tilt:this.tilt,width:this.width,height:this.height})}equals(t){return this.heading===t.heading&&this.tilt===t.tilt&&m(this.position,t.position)&&this.width===t.width&&this.height===t.height}};t([h({readOnly:!0,json:{read:!1,write:!0}})],Fe.prototype,"type",void 0),t([h({type:s}),Es()],Fe.prototype,"position",void 0),t([h({type:Number,nonNullable:!0,range:{min:0,max:360}}),Es(),l((t=>_s.normalize(u(t),0,!0)))],Fe.prototype,"heading",void 0),t([h({type:Number,nonNullable:!0,range:{min:0,max:360}}),Es(),l((t=>_s.normalize(u(t),0,!0)))],Fe.prototype,"tilt",void 0),t([h({type:Number,nonNullable:!0}),Es()],Fe.prototype,"width",void 0),t([h({type:Number,nonNullable:!0}),Es()],Fe.prototype,"height",void 0),Fe=De=t([d("esri.widgets.Slice.SlicePlane")],Fe);const Te=Fe,We=g.getLogger("esri.views.3d.interactive.analysisTools.slice.sliceToolUtils");function Ne(t,s,e){const i=s.worldUpAtPosition(t.origin,et.get()),r=t.basis1,n=Qe(t,i),a=Math.round(n/ei)*ei;return $(t,a-n,r,e)}function Ae(t,s){return he(t.basis1,t.basis2,t.origin,s)}function Re(t,s,e,i){const r=s.worldUpAtPosition(t.origin,et.get()),n=et.get();switch(e){case 1:P(n,r);break;case 2:P(n,t.basis1)}return X(t.origin,n,i)}function Ve(t,s,e,i){const r=E(i.basis1),n=E(i.basis2),a=Ie(i),o=Be(i),c=b(et.get(),0,0,0);y(c,w(et.get(),i.basis1,s.direction[0]),w(et.get(),i.basis2,s.direction[1])),y(c,i.origin,c);let h=0,l=1;if(Ue(s))1===s.direction[0]&&-1===s.direction[1]?h=ei:1===s.direction[0]&&1===s.direction[1]?h=Math.PI:-1===s.direction[0]&&1===s.direction[1]&&(h=3*Math.PI/2),l=o;else{const t=0!==s.direction[0]?1:2;h=1===t?ei:0,l=(1===t?n:r)-a}const u=T(it.get());N(u,u,h),A(u,u,b(et.get(),l,l,l)),F(u,e,u),u[12]=0,u[13]=0,u[14]=0,t.modelTransform=u,t.renderLocation=c}function Le(t,s,e,i){const r=i.worldUpAtPosition(e.origin,et.get()),n=function(t){return{basis:t.basis1,direction:1,position:y(et.get(),t.origin,t.basis1),edge:0}}(e),a=T(it.get());N(a,a,n.edge*Math.PI/2),R(a,a,-Qe(e,r)),F(a,s,a),a[12]=0,a[13]=0,a[14]=0,t.modelTransform=a,t.renderLocation=n.position}function Ie(t){const s=E(t.basis1),e=E(t.basis2);return.3*Math.min(s,e)}function Be(t){return Ie(t)}function Ue(t){return 0!==t.direction[0]&&0!==t.direction[1]}function qe(t,s=1){const e=0===s?40:0,i=[G(e,0,-24),G(e,0,24)],r=function(t){const s=k(U(),t[t.length-1],t[t.length-2]);v(s,s),w(s,s,12),y(s,s,t[t.length-1]);{const e=k(U(),t[0],t[1]);return v(e,e),w(e,e,12),y(e,e,t[0]),[e,...t,s]}}(i),n=(t,s)=>function(t,s,e){const i=i=>{const r=(i?s:t).slice(0),n=k(et.get(),r[0],r[1]);v(n,n);const o=k(et.get(),r[r.length-1],r[r.length-2]);if(v(o,o),e.padding>0){const t=w(U(),o,-e.padding);if(r[r.length-1]=y(t,t,r[r.length-1]),e.bothEnds){const t=w(U(),n,-e.padding);r[0]=y(t,t,r[0])}}const c=i?e.tipFocusMultiplier:1,h=e.tipLength*(e.focusTipLength?c:1),l=e.tipRadius*c,u=T(it.get());if(e.padding>0){const t=h/4,s=b(et.get(),0,t,0),i=1+e.padding/t;V(u,u,s),A(u,u,b(et.get(),i,i,i)),V(u,u,w(s,s,-1/i))}const d=T(I()),f=G(0,1,0),p=L(I(),B(rt.get(),f,o));p[12]=r[r.length-1][0],p[13]=r[r.length-1][1],p[14]=r[r.length-1][2],F(p,p,u);const m=[{part:"tube",geometry:Ke(e.tubeRadius*(i?e.tubeFocusMultiplier:1)+e.padding,e.flat,r),transform:d}];let g,j;if(a(e.flat)?g=Dt.createExtrudedTriangle(h,l,l,e.flat.thickness):(g=Dt.createConeGeometry(h,l,24,!1,!1,!0),j=Dt.createConeGeometry(h,l,24,!1,!0,!1)),m.push({part:"tip",geometry:g,transform:p}),j&&m.push({part:"cap",geometry:j,transform:p}),e.bothEnds){const t=L(I(),B(rt.get(),f,n));t[12]=r[0][0],t[13]=r[0][1],t[14]=r[0][2],F(t,t,u),m.push({part:"tip",geometry:g,transform:t}),j&&m.push({part:"cap",geometry:j,transform:t})}return m};return{normal:i(!1),focused:i(!0)}}(i,i,{tubeRadius:3,tipRadius:11,tipLength:22.5,tubeFocusMultiplier:1.15,tipFocusMultiplier:1.15,padding:t,bothEnds:!0,flat:null,focusTipLength:!0,addCap:s}),o=n(0,!1),c=n(2.25,!0),h=new Ot({color:we,cullFace:2,renderOccluded:16}),l=new Ot({color:ye,cullFace:2,renderOccluded:16}),u=new Ot({color:je,cullFace:2,renderOccluded:16}),d=new Ot({color:Pe,transparent:!0,writeDepth:!1,cullFace:1,renderOccluded:2}),f=Dt.createPolylineGeometry([[e,0,0],[e-40,0,0]]),p=Dt.createPolylineGeometry([[e,0,0],[e-40,0,0]]),m=new Ft({color:Se,renderOccluded:4});return new qs({view:t,renderObjects:[...o.normal.map((({part:t,geometry:s,transform:e})=>({geometry:s,material:"tip"===t?h:"cap"===t?l:u,transform:e,stateMask:1|ti}))),...c.normal.map((({geometry:t,transform:s})=>({geometry:t,material:d,transform:s,stateMask:1|ti}))),{geometry:f,material:m,stateMask:1|ti|si},...o.focused.map((({part:t,geometry:s,transform:e})=>({geometry:s,material:"tip"===t?h:"cap"===t?l:u,transform:e,stateMask:2|ti}))),...c.focused.map((({geometry:t,transform:s})=>({geometry:t,material:d,transform:s,stateMask:2|ti}))),{geometry:p,material:m,stateMask:2|ti|si}],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[r]},collisionPriority:1,radius:11,state:ti})}function Ge(t,s){const e=new Ms({transparent:!0,writeDepth:!1,textureId:s.id,renderOccluded:16}),i=40,r=27*1.1,n=t=>{const s=new Uint32Array([0,1,2,2,3,0]);return new ps([["position",{size:3,data:[i-t,-t,0,i+t,-t,0,i+t,t,0,i-t,t,0],exclusive:!0}],["uv0",{size:2,data:[0,0,1,0,1,1,0,1]}]],[["position",s],["uv0",s]])},a=Dt.createPolylineGeometry([[0,0,0],[13,0,0]]),o=Dt.createPolylineGeometry([[0,0,0],[i-r,0,0]]),c=new Ft({color:be,renderOccluded:4}),h=[{geometry:n(27),material:e,stateMask:1|ti},{geometry:a,material:c,stateMask:1|ti},{geometry:n(r),material:e,stateMask:2|ti},{geometry:o,material:c,stateMask:2|ti}];return new qs({view:t,renderObjects:h,autoScaleRenderObjects:!1,collisionType:{type:"disc",direction:[0,0,1],offset:[i,0,0]},collisionPriority:1,radius:13.5,state:ti})}function $e(t){return new xs({view:t,attached:!0,color:me,width:1,writeDepthEnabled:!1,renderOccluded:4,geometry:[[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]]]})}function He(t){return new ze({view:t,attached:!0,backgroundColor:[...ge],gridColor:ve,gridWidth:4,renderOccluded:4})}function Je(t,s){const e=Ue(s),i=e?[G(1,0,0),G(0,0,0),G(0,1,0)]:[G(1,0,0),G(-1,0,0)],r=Dt.createPolylineGeometry(i),n=Ce,a=e?4:1,o=2*a,c=t=>t>1?(t=>new Tt({color:n,width:t,renderOccluded:4}))(t):new Ft({color:n,renderOccluded:4}),h=[{geometry:r,material:c(a),stateMask:1|ii},{geometry:r,material:c(o),stateMask:2|ii},{geometry:r,material:c(1),stateMask:ri}],l=new qs({view:t,renderObjects:h,collisionType:{type:"line",paths:[i]},autoScaleRenderObjects:!1,worldSized:!0,radius:e?6:4});return l.state=ii,l}function Ke(t,s,e){const i=[];if(a(s))i.push([t,s.thickness/2],[-t,s.thickness/2],[-t,-s.thickness/2],[t,-s.thickness/2]);else{const s=12;for(let e=0;e<s;e++){const r=e/s*2*Math.PI;i.push([Math.cos(r)*t,Math.sin(r)*t])}}return Dt.createPathExtrusionGeometry(i,e,[],[],!1)}function Xe(t,e,i,n=new Te){if(r(t))return null;const o=a(n.position)?n.position:new s;e.fromRenderCoords(t.origin,o,i),n.position=o;const c=e.worldUpAtPosition(t.origin,et.get()),h=e.worldBasisAtPosition(t.origin,1,et.get());return n.width=2*E(t.basis1),n.height=2*E(t.basis2),n.tilt=_(Qe(t,c)),n.heading=_(function(t,s,e){return st(t.basis1,e,s)-ei}(t,c,h)),n}function Qe(t,s){return st(s,t.basis2,t.basis1)+ei}function Ye(t,s,e=H()){if(r(t)||r(t.position))return null;let i=t.position;return t.position.hasZ||(i=t.position.clone(),i.z=n(xt(s.elevationProvider,t.position),0)),function(t,s,e,i,r,n,a=H()){return n.toRenderCoords(t,a.origin)?(n.worldBasisAtPosition(a.origin,0,a.basis1),n.worldBasisAtPosition(a.origin,1,a.basis2),Z(a.basis2,a.basis1,a.origin,a.plane),$(a,-x(s),J(a),a),$(a,x(e),a.basis1,a),w(a.basis1,a.basis1,i/2),w(a.basis2,a.basis2,r/2),K(a),a):(We.error(`Failed to project slice plane position, projection from ${t.spatialReference.wkid} is not supported`),null)}(i,t.heading,t.tilt,t.width,t.height,s.renderCoordsHelper,e)}function Ze(t){switch(t.type){case"analysis":case"building-scene":case"csv":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"kml":case"map-notes":case"ogc-feature":case"point-cloud":case"route":case"scene":case"stream":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"open-street-map":case"tile":case"vector-tile":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return!1}}const ti=16,si=32,ei=Math.PI/2,ii=16,ri=32;export{pe as C,Ve as K,le as O,ri as P,Le as Q,me as S,ge as U,Ne as V,Ae as W,qs as Y,Re as Z,si as a,Je as b,ii as c,ae as d,Ds as e,Ze as f,Xe as g,Ye as h,Ue as i,oe as j,Te as k,$e as l,ve as m,He as n,Ge as o,Rs as q,ke as r,qe as s,Be as t,ue as v,fe as x,ce as y}