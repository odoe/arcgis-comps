import{p,bm as t,A as s,af as i,cu as r,e as o,d as e,i as m,b9 as a}from"./p-e58503d5.js";import{a as j}from"./p-7731c620.js";import{v as c,a as d}from"./p-b79fcce3.js";import{t as n,O as f,r as b}from"./p-c93d2280.js";import{u as h}from"./p-eec31d91.js";import{e as l}from"./p-5032dfbd.js";import{s as u}from"./p-182bb5be.js";import{m as y}from"./p-e06c6cf3.js";import{V as g}from"./p-bfea9714.js";import{z as S}from"./p-90239435.js";import{o as w}from"./p-1092f461.js";import"./p-53bb6ab4.js";import"./p-5d962998.js";import"./p-2f398ed1.js";import"./p-d3105731.js";import"./p-01e5a461.js";import"./p-ccdb8e80.js";import"./p-ea916a39.js";import"./p-fea9512d.js";import"./p-c048b814.js";import"./p-c1cd5521.js";import"./p-db87794e.js";import"./p-f94762ac.js";import"./p-58386239.js";import"./p-285c6a34.js";import"./p-f8414adc.js";import"./p-8925cd73.js";import"./p-b0565d49.js";import"./p-9f58a277.js";import"./p-61f47d2b.js";import"./p-e49308c6.js";import"./p-50ff864e.js";import"./p-06d309e6.js";import"./p-4019eec3.js";import"./p-292d2320.js";import"./p-8bcb4bb3.js";import"./p-e0d9ff4c.js";import"./p-e273719b.js";import"./p-74de0937.js";import"./p-a9a30646.js";import"./p-7a658388.js";import"./p-85a6d41b.js";import"./p-765e6c28.js";import"./p-612de336.js";import"./p-ca295674.js";import"./p-41f2b2dd.js";import"./p-612a2c14.js";import"./p-54330161.js";import"./p-93765525.js";import"./p-8747982c.js";import"./p-8bc9b36a.js";import"./p-fb38a9d0.js";import"./p-8a919d07.js";import"./p-efbca0ca.js";import"./p-d443df87.js";import"./p-7ca40eac.js";import"./p-9087b4d3.js";import"./p-ca4492df.js";import"./p-9d34911e.js";import"./p-2db4840f.js";import"./p-bba8b671.js";import"./p-5e833dfc.js";import"./p-7a5bfd29.js";import"./p-a131049b.js";import"./p-a2324023.js";import"./p-dc852195.js";import"./p-ff2962f5.js";import"./p-da9e7ba9.js";import"./p-a8f0aa27.js";import"./p-4a96de15.js";import"./p-a87cccba.js";import"./p-dae095dd.js";import"./p-0e784e4d.js";import"./p-dbdf15fc.js";import"./p-08e5f531.js";import"./p-dfc6337f.js";import"./p-9f1c2d50.js";import"./p-6b2eb7a7.js";import"./p-889f7a78.js";import"./p-1f81b35d.js";import"./p-81b9df84.js";import"./p-5ce39624.js";import"./p-e9bae5e9.js";import"./p-51a17e75.js";import"./p-d208934e.js";import"./p-afac6fb2.js";import"./p-3e39c093.js";import"./p-480e5606.js";import"./p-22c9f19c.js";import"./p-c096b5df.js";import"./p-da33e926.js";import"./p-a24f7752.js";import"./p-4a6dc5e4.js";import"./p-6a92ecb9.js";import"./p-1ab449fc.js";import"./p-a6c8fb32.js";import"./p-0edb3309.js";import"./p-e8160b60.js";import"./p-2e8ad983.js";import"./p-e3270d48.js";import"./p-e44bd0a6.js";import"./p-e654504b.js";import"./p-0eb619a6.js";import"./p-fe68aab5.js";import"./p-c6970847.js";import"./p-de86b3c9.js";import"./p-37d3434c.js";import"./p-120b7410.js";import"./p-b1eff69d.js";import"./p-91fe06d4.js";import"./p-ab0e9273.js";import"./p-15a9486c.js";import"./p-2ae44317.js";import"./p-9e860e7b.js";import"./p-f3659a34.js";import"./p-ca657fcf.js";import"./p-b312c1fd.js";import"./p-b8beb0d3.js";import"./p-2a99994a.js";import"./p-22ccef7d.js";import"./p-6f4b0bc8.js";import"./p-a184d75f.js";import"./p-5f05b534.js";import"./p-7d081d01.js";import"./p-b6fa3228.js";import"./p-f70b836b.js";import"./p-df35b79d.js";import"./p-e6fe5d89.js";import"./p-746a9d8f.js";import"./p-f16641e7.js";import"./p-d748d513.js";let v=class extends(j(p)){constructor(p){super(p),this.availability=1,this.sources={multipoint:null,point:null,polygon:null,polyline:null},this.loadedWkids=new Set,this.loadedWkts=new Set,this.pendingAdds=[]}get updating(){return this.updatingHandles.updating}get layer(){return this.layerSource.layer}destroy(){const p=this.pendingAdds;this.pendingAdds.length=0;for(const t of p)t.task.abort();this.mapSources((p=>this.destroySource(p)))}initialize(){this.handles.add([this.layer.on("graphic-update",(p=>this.onGraphicUpdate(p))),this.updatingHandles.addOnCollectionChange(this.layer.graphics,(p=>this.onGraphicsChanged(p)))]),this.addMany(this.layer.graphics.toArray())}async fetchCandidates(p,i){const r=(await t(this.mapSources((t=>t.queryEngine.executeQueryForSnapping({point:p.coordinateHelper.vectorToPoint(p.point).toJSON(),distance:p.distance,types:p.types,query:s(p.filter)?p.filter.createQuery().toJSON():{where:"1=1"}},i).then((({candidates:p})=>p)))))).flat().map((t=>w(t,p.coordinateHelper)));return S(p.point,r),r}refresh(){}onGraphicUpdate(p){switch(p.property){case"geometry":case"visible":this.remove(p.graphic),this.addMany([p.graphic])}}onGraphicsChanged(p){for(const t of p.removed)this.remove(t);this.addMany(p.added)}addMany(p){const t=[],s=new Map;for(const r of p)i(r.geometry)||(this.needsInitializeProjection(r.geometry.spatialReference)?(t.push(r.geometry.spatialReference),s.set(r.uid,r)):this.add(r));this.createPendingAdd(t,s)}createPendingAdd(p,t){if(!p.length)return;const s=r((async s=>{await b(p.map((p=>({source:p,dest:this.spatialReference}))),{signal:s}),this.markLoadedSpatialReferences(p);for(const[,p]of t)this.add(p)}));this.updatingHandles.addPromise(s.promise);const i={task:s,graphics:t},o=()=>a(this.pendingAdds,i);s.promise.then(o,o),this.pendingAdds.push(i)}markLoadedSpatialReferences(p){for(const t of p)null!=t.wkid&&this.loadedWkids.add(t.wkid),null!=t.wkt&&this.loadedWkts.add(t.wkt)}add(p){if(i(p.geometry)||!p.visible)return;let t=p.geometry;if("mesh"===t.type)return;"extent"===t.type&&(t=c.fromExtent(t));const r=this.ensureSource(t.type);if(i(r))return;const o=this.createOptimizedFeature(p.uid,t);s(o)&&r.featureStore.add(o)}needsInitializeProjection(p){return!(null!=p.wkid&&this.loadedWkids.has(p.wkid)||null!=p.wkt&&this.loadedWkts.has(p.wkt)||n(p,this.spatialReference))}createOptimizedFeature(p,t){const s=f(h(t),this.spatialReference);return s?new u(l(s,!1,!1),{[O]:p},null,p):null}ensureSource(p){const t=this.sources[p];if(s(t))return t;const i=this.createSource(p);return this.sources[p]=i,i}createSource(p){const t=d.toJSON(p),i=new y({geometryType:t,hasZ:!1,hasM:!1});return{featureStore:i,queryEngine:new g({featureStore:i,fields:[{name:O,type:"esriFieldTypeOID",alias:O}],geometryType:t,hasM:!1,hasZ:!1,objectIdField:O,spatialReference:this.spatialReference,scheduler:s(this.view)&&"3d"===this.view.type?this.view.resourceController.scheduler:null}),type:p}}remove(p){this.mapSources((t=>this.removeFromSource(t,p)));for(const t of this.pendingAdds)t.graphics.delete(p.uid),0===t.graphics.size&&t.task.abort()}removeFromSource(p,t){p.featureStore.has(t.uid)&&p.featureStore.removeById(t.uid)}destroySource(p){p.queryEngine.destroy(),this.sources[p.type]=null}mapSources(p){const{point:t,polygon:i,polyline:r,multipoint:o}=this.sources,e=[];return s(t)&&e.push(p(t)),s(i)&&e.push(p(i)),s(r)&&e.push(p(r)),s(o)&&e.push(p(o)),e}};o([e({constructOnly:!0})],v.prototype,"spatialReference",void 0),o([e({constructOnly:!0})],v.prototype,"layerSource",void 0),o([e({constructOnly:!0})],v.prototype,"view",void 0),o([e({readOnly:!0})],v.prototype,"updating",null),o([e({readOnly:!0})],v.prototype,"availability",void 0),v=o([m("esri.views.interactive.snapping.featureSources.GraphicsSnappingSource")],v);const O="OBJECTID";export{v as GraphicsSnappingSource}