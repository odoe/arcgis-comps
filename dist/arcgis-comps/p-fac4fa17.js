import{p as t,af as e,A as i,e as s,d as r,i as p,a as o,u as n,cp as a,al as l,aE as c,dB as d}from"./p-e58503d5.js";import{a as u,d as h}from"./p-7731c620.js";import{i as f,m,a as j}from"./p-5d962998.js";import{o as b}from"./p-2f398ed1.js";import{n as v}from"./p-4d38e149.js";import{Z as g,r as y,G as w}from"./p-ea0c022e.js";import{c as S}from"./p-ca657fcf.js";import{o as O}from"./p-1092f461.js";import{v as I,a as T}from"./p-b79fcce3.js";import{m as z,o as F}from"./p-ea916a39.js";import{b as x}from"./p-1ea80d7f.js";import{n as C}from"./p-e9596294.js";import{j as $,p as D}from"./p-db63fa0e.js";import{p as P}from"./p-41f2b2dd.js";import"./p-53bb6ab4.js";import"./p-d3105731.js";import"./p-3c70d22f.js";import"./p-8f986f60.js";import"./p-2c84c65f.js";import"./p-746a9d8f.js";import"./p-ccdb8e80.js";import"./p-1c99992b.js";import"./p-dcdb33cf.js";import"./p-95909347.js";import"./p-90239435.js";import"./p-765e6c28.js";import"./p-e273719b.js";import"./p-74de0937.js";import"./p-612a2c14.js";import"./p-01e5a461.js";import"./p-54330161.js";import"./p-93765525.js";import"./p-a9a30646.js";import"./p-8747982c.js";import"./p-8bc9b36a.js";import"./p-7a658388.js";import"./p-fb38a9d0.js";import"./p-f94762ac.js";import"./p-8a919d07.js";import"./p-efbca0ca.js";import"./p-c048b814.js";import"./p-d443df87.js";import"./p-7ca40eac.js";import"./p-9087b4d3.js";import"./p-c1cd5521.js";import"./p-ca4492df.js";import"./p-9d34911e.js";import"./p-182bb5be.js";import"./p-db87794e.js";import"./p-2db4840f.js";import"./p-bba8b671.js";import"./p-5e833dfc.js";import"./p-7a5bfd29.js";import"./p-a131049b.js";import"./p-a2324023.js";import"./p-dc852195.js";import"./p-ff2962f5.js";import"./p-da9e7ba9.js";import"./p-a8f0aa27.js";import"./p-4a96de15.js";import"./p-5032dfbd.js";import"./p-a87cccba.js";import"./p-dae095dd.js";import"./p-0e784e4d.js";import"./p-dbdf15fc.js";import"./p-e0d9ff4c.js";import"./p-08e5f531.js";import"./p-dfc6337f.js";import"./p-9f1c2d50.js";import"./p-6b2eb7a7.js";import"./p-889f7a78.js";import"./p-1f81b35d.js";import"./p-81b9df84.js";import"./p-5ce39624.js";import"./p-e9bae5e9.js";import"./p-b0565d49.js";import"./p-51a17e75.js";import"./p-d208934e.js";import"./p-afac6fb2.js";import"./p-3e39c093.js";import"./p-480e5606.js";import"./p-22c9f19c.js";import"./p-c096b5df.js";import"./p-da33e926.js";import"./p-a24f7752.js";import"./p-4a6dc5e4.js";import"./p-6a92ecb9.js";import"./p-1ab449fc.js";import"./p-a6c8fb32.js";import"./p-0edb3309.js";import"./p-e8160b60.js";import"./p-2e8ad983.js";import"./p-e3270d48.js";import"./p-e44bd0a6.js";import"./p-e654504b.js";import"./p-0eb619a6.js";import"./p-fe68aab5.js";import"./p-c6970847.js";import"./p-de86b3c9.js";import"./p-37d3434c.js";import"./p-120b7410.js";import"./p-b1eff69d.js";import"./p-612de336.js";import"./p-91fe06d4.js";import"./p-ab0e9273.js";import"./p-15a9486c.js";import"./p-2ae44317.js";import"./p-9f58a277.js";import"./p-9e860e7b.js";import"./p-f3659a34.js";import"./p-b312c1fd.js";import"./p-b8beb0d3.js";import"./p-2a99994a.js";import"./p-22ccef7d.js";import"./p-6f4b0bc8.js";import"./p-a184d75f.js";import"./p-5f05b534.js";import"./p-7d081d01.js";import"./p-b6fa3228.js";import"./p-f70b836b.js";import"./p-df35b79d.js";import"./p-fea9512d.js";import"./p-e6fe5d89.js";import"./p-f16641e7.js";import"./p-d748d513.js";function U(t,e){return g(e.extent,k),y(k,b(E,t.x,t.y,0))}const k=w(),E=v();let N=class extends(u(t)){constructor(t){super(t),this.pointOfInterest=null}get tiles(){const t=this.tilesCoveringView,e=i(this.pointOfInterest)?this.pointOfInterest:this.view.center;return t.sort(((t,i)=>U(e,t)-U(e,i))),t}scaleEnabled(){return S(this.view.scale,this.layer.minScale||0,this.layer.maxScale||0)}get tilesCoveringView(){if(!this.view.ready||!this.view.featuresTilingScheme||!this.view.state||e(this.tileInfo))return[];if(!this.scaleEnabled)return[];const{spans:t,lodInfo:i}=this.view.featuresTilingScheme.getTileCoverage(this.view.state,0),{level:s}=i,r=[];for(const{row:e,colFrom:p,colTo:o}of t)for(let t=p;t<=o;t++){const p={id:null,level:s,row:e,col:i.normalizeCol(t)};this.tileInfo.updateTileInfo(p),r.push(p)}return r}get tileInfo(){var t,e;return null!=(t=null==(e=this.view.featuresTilingScheme)?void 0:e.tileInfo)?t:null}get tileSize(){return i(this.tileInfo)?this.tileInfo.size[0]:256}initialize(){this.handles.add(this.watch("view.state.viewpoint",(()=>this.notifyChange("tilesCoveringView")),!0))}};s([r({readOnly:!0})],N.prototype,"tiles",null),s([r({readOnly:!0})],N.prototype,"scaleEnabled",null),s([r({readOnly:!0})],N.prototype,"tilesCoveringView",null),s([r({readOnly:!0})],N.prototype,"tileInfo",null),s([r({readOnly:!0})],N.prototype,"tileSize",null),s([r({constructOnly:!0})],N.prototype,"view",void 0),s([r({constructOnly:!0})],N.prototype,"layer",void 0),s([r()],N.prototype,"pointOfInterest",void 0),N=s([p("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiles2D")],N);let R=class extends h{constructor(t){super(t),this.pointOfInterest=null}get tiles(){const t=this.tilesCoveringView,e=this.effectivePointOfInterest;if(i(e)){const i=t.map((t=>U(e,t)));for(let s=1;s<i.length;s++)if(i[s-1]>i[s])return t.sort(((t,i)=>U(e,t)-U(e,i))),t.slice()}return t}get tilesCoveringView(){var t,e;return this.filterTiles(null==(t=this.view.featureTiles)||null==(e=t.tiles)?void 0:e.toArray()).map(V)}get tileInfo(){var t,e;return null!=(t=null==(e=this.view.featureTiles)?void 0:e.tilingScheme.toTileInfo())?t:null}get tileSize(){var t,e;return null!=(t=null==(e=this.view.featureTiles)?void 0:e.tileSize)?t:256}get effectivePointOfInterest(){var t;const e=this.pointOfInterest;return i(e)?e:null==(t=this.view.pointsOfInterest)?void 0:t.focus.location}initialize(){this.handles.add(o(this.view,"featureTiles",(t=>{this.handles.remove(M),t&&this.handles.add(t.addClient(),M)})))}filterTiles(t){return e(t)?[]:t.filter((t=>Math.abs(t.measures.screenRect[3]-t.measures.screenRect[1])>A&&2===t.measures.visibility))}};function V({lij:[t,e,i],extent:s}){return{id:`${t}/${e}/${i}`,level:t,row:e,col:i,extent:s}}s([r({readOnly:!0})],R.prototype,"tiles",null),s([r({readOnly:!0})],R.prototype,"tilesCoveringView",null),s([r({readOnly:!0})],R.prototype,"tileInfo",null),s([r({readOnly:!0})],R.prototype,"tileSize",null),s([r({constructOnly:!0})],R.prototype,"view",void 0),s([r()],R.prototype,"pointOfInterest",void 0),s([r()],R.prototype,"effectivePointOfInterest",null),R=s([p("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiles3D")],R);const A=50,M="feature-tiles";let W=class extends x{constructor(t){super(t),this.handles=new n}initialize(){const t=setInterval((()=>this.fetchDebugInfo()),2e3);this.handles.add(a((()=>clearInterval(t))))}destroy(){this.handles.destroy()}getTiles(){if(!this.debugInfo)return[];const t=new Map,e=new Map;this.debugInfo.storedTiles.forEach((e=>{t.set(e.data.id,e.featureCount)})),this.debugInfo.pendingTiles.forEach((i=>{t.set(i.data.id,i.featureCount),e.set(i.data.id,i.state)}));const i=i=>{var s;const r=e.get(i),p=null!=(s=t.get(i))?s:"?";return r?`${r}:${p}\n${i}`:`store:${p}\n${i}`},s=new Map;return this.debugInfo.storedTiles.forEach((t=>{s.set(t.data.id,t.data)})),this.debugInfo.pendingTiles.forEach((t=>{s.set(t.data.id,t.data)})),Array.from(s.values()).map((t=>({lij:[t.level,t.row,t.col],geometry:I.fromExtent(z(t.extent,this.view.spatialReference)),label:i(t.id)})))}fetchDebugInfo(){this.handle.getDebugInfo(null).then((t=>{this.debugInfo=t,this.update()}))}};s([r({constructOnly:!0})],W.prototype,"handle",void 0),W=s([p("esri.views.interactive.snapping.featureSources.WorkerTileTreeDebugger")],W);let H=class extends h{constructor(t){super(t),this.availability=0,this.workerHandleUpdating=!0,this.editId=0}get updating(){return this.updatingHandles.updating||this.workerHandleUpdating}destroy(){this.workerHandle.destroy()}initialize(){this.workerHandle=new L(this.schedule),this.handles.add([this.workerHandle.on("notify-updating",(({updating:t})=>this.workerHandleUpdating=t)),this.workerHandle.on("notify-availability",(({availability:t})=>this._set("availability",t)))])}async setup(t,i){const s=this.serviceInfoFromLayer(t.layer);if(e(s))return;const r={configuration:this.convertConfiguration(t.configuration),serviceInfo:s,spatialReference:t.spatialReference.toJSON()};await this.updatingHandles.addPromise(this.workerHandle.invokeMethod("setup",r,i)),this.updatingHandles.addPromise(this.workerHandle.invokeMethod("whenNotUpdating",{},i))}async configure(t,e){const i=this.convertConfiguration(t);await this.updatingHandles.addPromise(this.workerHandle.invokeMethod("configure",i,e)),this.updatingHandles.addPromise(this.workerHandle.invokeMethod("whenNotUpdating",{},e))}async refresh(t){await this.updatingHandles.addPromise(this.workerHandle.invokeMethod("refresh",{},t)),this.updatingHandles.addPromise(this.workerHandle.invokeMethod("whenNotUpdating",{},t))}async fetchCandidates(t,e){const s={distance:t.distance,point:t.coordinateHelper.vectorToPoint(t.point).toJSON(),types:t.types,filter:i(t.filter)?t.filter.createQuery().toJSON():null};return this.workerHandle.invoke(s,e)}async updateTiles(t,e){const s={tiles:t.tiles,tileInfo:i(t.tileInfo)?t.tileInfo.toJSON():null,tileSize:t.tileSize};await this.updatingHandles.addPromise(this.workerHandle.invokeMethod("updateTiles",s,e)),this.updatingHandles.addPromise(this.workerHandle.invokeMethod("whenNotUpdating",{},e))}async applyEdits(t,e){var i,s,r,p,o,n;const a=this.editId++,c={id:a};await this.updatingHandles.addPromise(this.workerHandle.invokeMethod("beginApplyEdits",c,e)),this.updatingHandles.addPromise(this.workerHandle.invokeMethod("whenNotUpdating",{},e));const d=await this.updatingHandles.addPromise(l(t.result,e)),u={id:a,edits:{addedFeatures:null!=(i=null==(s=d.addedFeatures)?void 0:s.map((({objectId:t})=>t)))?i:[],deletedFeatures:null!=(r=null==(p=d.deletedFeatures)?void 0:p.map((({objectId:t,globalId:e})=>({objectId:t,globalId:e}))))?r:[],updatedFeatures:null!=(o=null==(n=d.updatedFeatures)?void 0:n.map((({objectId:t})=>t)))?o:[]}};await this.updatingHandles.addPromise(this.workerHandle.invokeMethod("endApplyEdits",u,e)),this.updatingHandles.addPromise(this.workerHandle.invokeMethod("whenNotUpdating",{},e))}getDebugInfo(t){return this.workerHandle.invokeMethod("getDebugInfo",{},t)}convertConfiguration(t){return{filter:i(t.filter)?t.filter.toJSON():null,customParameters:t.customParameters}}serviceInfoFromLayer(t){var e;return"multipatch"===t.geometryType||"mesh"===t.geometryType?null:{url:t.parsedUrl.path,fields:t.fields.map((t=>t.toJSON())),geometryType:T.toJSON(t.geometryType),capabilities:t.capabilities,objectIdField:t.objectIdField,globalIdField:t.globalIdField,spatialReference:t.spatialReference.toJSON(),timeInfo:null==(e=t.timeInfo)?void 0:e.toJSON()}}};s([r({constructOnly:!0})],H.prototype,"schedule",void 0),s([r({readOnly:!0})],H.prototype,"updating",null),s([r({readOnly:!0})],H.prototype,"availability",void 0),s([r()],H.prototype,"workerHandleUpdating",void 0),H=s([p("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceSnappingSourceWorkerHandle")],H);class L extends C{constructor(t){super("FeatureServiceSnappingSourceWorker","fetchCandidates",t,{strategy:"dedicated"})}getTransferList(){return[]}}let B=class extends t{constructor(t){super(t),this.pointOfInterest=null}get tiles(){return[{id:"0/0/0",level:0,row:0,col:0,extent:F(-1e8,-1e8,1e8,1e8)}]}get tileInfo(){return new $({origin:new c({x:-1e8,y:1e8,spatialReference:this.layer.spatialReference}),size:[512,512],lods:[new D({level:0,scale:1,resolution:390625})],spatialReference:this.layer.spatialReference})}get tileSize(){return this.tileInfo.size[0]}};s([r({readOnly:!0})],B.prototype,"tiles",null),s([r({readOnly:!0})],B.prototype,"tileInfo",null),s([r({readOnly:!0})],B.prototype,"tileSize",null),s([r({constructOnly:!0})],B.prototype,"layer",void 0),s([r()],B.prototype,"pointOfInterest",void 0),B=s([p("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTilesSimple")],B);let q=class extends(u(t)){constructor(t){super(t)}get updateTilesParameters(){return{tiles:this.tilesOfInterest.tiles,tileInfo:this.tilesOfInterest.tileInfo,tileSize:this.tilesOfInterest.tileSize}}get updating(){return this.workerHandle.updating||this.updatingHandles.updating}get configuration(){return{filter:this.layer.createQuery(),customParameters:this.layer.customParameters}}get availability(){return this.workerHandle.availability}get layer(){return this.layerSource.layer}initialize(){const t=this.view;if(i(t))switch(t.type){case"2d":this.tilesOfInterest=new N({view:t,layer:this.layer}),this.workerHandle=new H;break;case"3d":{const e=t.resourceController;this.tilesOfInterest=new R({view:t}),this.workerHandle=new H({schedule:t=>e.schedule(t)});break}}else this.tilesOfInterest=new B({layer:this.layer}),this.workerHandle=new H;this.handles.add([d(this.workerHandle)]),this.workerHandle.setup({layer:this.layer,spatialReference:this.spatialReference,configuration:this.configuration},null),this.updatingHandles.add(this,"updateTilesParameters",(()=>this.workerHandle.updateTiles(this.updateTilesParameters,null)),2),this.handles.add([f((()=>this.configuration),(t=>this.workerHandle.configure(t,null)),m)]),i(t)&&this.handles.add(f((()=>P.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES),(e=>{e&&!this.debug?(this.debug=new W({view:t,handle:this.workerHandle}),this.handles.add(d(this.debug),"debug")):!e&&this.debug&&this.handles.remove("debug")}),j)),this.handles.add(this.layerSource.layer.on("apply-edits",(t=>{this.workerHandle.applyEdits(t,null)})))}refresh(){this.workerHandle.refresh(null)}async fetchCandidates(t,e){return this.tilesOfInterest.pointOfInterest=t.coordinateHelper.vectorToPoint(t.point),(await this.workerHandle.fetchCandidates({...t,filter:null},e)).candidates.map((e=>O(e,t.coordinateHelper)))}getDebugInfo(t){return this.workerHandle.getDebugInfo(t)}};s([r({constructOnly:!0})],q.prototype,"spatialReference",void 0),s([r({constructOnly:!0})],q.prototype,"layerSource",void 0),s([r({constructOnly:!0})],q.prototype,"view",void 0),s([r()],q.prototype,"tilesOfInterest",void 0),s([r({readOnly:!0})],q.prototype,"updateTilesParameters",null),s([r({readOnly:!0})],q.prototype,"updating",null),s([r({readOnly:!0})],q.prototype,"configuration",null),s([r({readOnly:!0})],q.prototype,"availability",null),q=s([p("esri.views.interactive.snapping.featureSources.FeatureServiceSnappingSource")],q);export{q as FeatureServiceSnappingSource}