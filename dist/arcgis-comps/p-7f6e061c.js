import{e as t,d as s,i,p as e,r,m as o,t as h,v as a,bm as n,h as l,N as p,a as c,a0 as u,_ as m}from"./p-9ae46e68.js";import{h as d,_ as f,M as b,E as j}from"./p-566b0715.js";import{j as y}from"./p-523f37cd.js";import{g,u as v,s as w,i as T}from"./p-4a6cae2b.js";import{u as P,l as _}from"./p-9dbf3f05.js";import{w as x,j as S,F}from"./p-40c5644b.js";import{l as I,u as z}from"./p-ebe5e529.js";import{u as V}from"./p-81e5b36e.js";import{n as D,p as R}from"./p-7a648ea5.js";import{x as L,G as E,c as G}from"./p-d40c97c9.js";import{r as k,o as U}from"./p-dd4e6b8b.js";import{I as A,t as C}from"./p-16def889.js";import{U as M,_ as W,S as O}from"./p-cb5759ce.js";import{s as B,i as N}from"./p-39da60a5.js";import{h as q,f as J}from"./p-81abd5fc.js";import"./p-7c7c5507.js";import{a as Q}from"./p-6ab16fcc.js";import{h as H}from"./p-1f10277d.js";import{r as K,p as X}from"./p-d18723b0.js";import{g as Y}from"./p-f271906a.js";import{d as Z}from"./p-24ce6cb4.js";import{i as $}from"./p-9ca88c10.js";import{a as tt}from"./p-52e6638d.js";import{o as st}from"./p-f614dce4.js";import"./p-84bf99cb.js";import"./p-fe01b82b.js";import"./p-bae36c84.js";import"./p-138c2b2c.js";import"./p-6ebb24ba.js";import"./p-4fd6e394.js";import"./p-b2a0fae5.js";import"./p-4681e856.js";import"./p-a0e42f29.js";import"./p-41655335.js";import"./p-3ffd0931.js";import"./p-8031c809.js";import"./p-3048cc18.js";import"./p-c7a0a732.js";import"./p-b2d0e2de.js";import"./p-db87794e.js";import"./p-22c8d854.js";import"./p-3d1b25b6.js";import"./p-f42060e0.js";import"./p-79553c8d.js";import"./p-8e03c038.js";import"./p-32462343.js";import"./p-98a14d68.js";import"./p-32824614.js";import"./p-40d3b500.js";import"./p-c8f716a9.js";import"./p-57ae469d.js";import"./p-27ef204b.js";import"./p-3a2e88bf.js";import"./p-9e860e7b.js";import"./p-ada83011.js";import"./p-98ce0cca.js";import"./p-4003c7ae.js";import"./p-a7080451.js";import"./p-7e9d2371.js";import"./p-94f8dc11.js";import"./p-bb07d873.js";import"./p-8ac97b63.js";import"./p-a0a931f0.js";import"./p-dfc6337f.js";import"./p-77e6a663.js";import"./p-c5b7f7c3.js";import"./p-30ddb3a0.js";import"./p-74fc1b7f.js";import"./p-b3024dec.js";import"./p-4fcbc3c5.js";import"./p-4b3ae2cf.js";import"./p-6443bfb4.js";import"./p-8e6daf54.js";import"./p-c0757461.js";import"./p-93d9099f.js";import"./p-d3898fd7.js";import"./p-844dad6c.js";import"./p-c59d0a4d.js";import"./p-3a5fe179.js";import"./p-ae0b06e3.js";import"./p-a293872e.js";import"./p-cf2267f9.js";import"./p-d2e19070.js";import"./p-e5429b9e.js";import"./p-cf8dc9be.js";import"./p-f17028ec.js";import"./p-5c89c68e.js";import"./p-725fd184.js";import"./p-0c91ebaf.js";import"./p-72355290.js";import"./p-d68829c1.js";import"./p-81102839.js";import"./p-2f7c985e.js";import"./p-00b9ea57.js";import"./p-5a0fe1d0.js";import"./p-7818def0.js";import"./p-da143060.js";import"./p-15bb2887.js";import"./p-1d6f3ddb.js";import"./p-789e71c1.js";import"./p-a198d6d0.js";import"./p-15515b8a.js";import"./p-264c75ac.js";import"./p-c431b12a.js";import"./p-b0f556d6.js";import"./p-8b767e6c.js";import"./p-8d03d70f.js";import"./p-9658240e.js";import"./p-d6725707.js";import"./p-d925341f.js";import"./p-c3efb223.js";import"./p-56ed1c7a.js";import"./p-2b250922.js";import"./p-b62a8a4f.js";import"./p-47e1bd73.js";import"./p-eb19a862.js";import"./p-b392deaf.js";import"./p-4414d64f.js";import"./p-a617738c.js";import"./p-ffe0d3ad.js";import"./p-97ec6ae5.js";import"./p-0c60bcc4.js";import"./p-285c6a34.js";class it extends k{constructor(t,s,i,e,r,o=null){super(t,s,i,e,r),this.bitmap=new L(o,null,null),this.bitmap.coordScale=[e,r],this.bitmap.once("isReady",(()=>this.ready()))}destroy(){super.destroy(),this.bitmap.destroy(),this.bitmap=null,this.stage=null}set stencilRef(t){this.bitmap.stencilRef=t}get stencilRef(){return this.bitmap.stencilRef}setTransform(t,s){super.setTransform(t,s),this.bitmap.transforms.dvs=this.transforms.dvs}_createTransforms(){return{dvs:D(),tileMat3:D()}}onAttach(){this.bitmap.stage=this.stage}onDetach(){this.bitmap.stage=null}}class et extends U{constructor(){super(...arguments),this.isCustomTilingScheme=!1}createTile(t){const s=this._getTileBounds(t),[i,e]=this._tileInfoView.tileInfo.size;return new it(t,s[0],s[3],i,e)}destroyTile(){}prepareRenderPasses(t){const s=t.registerRenderPass({name:"imagery (tile)",brushes:[E.raster],target:()=>this.children.map((t=>t.bitmap)),drawPhase:A.MAP});return[...super.prepareRenderPasses(t),s]}doRender(t){this.visible&&t.drawPhase===A.MAP&&super.doRender(t)}_getTileBounds(t){const s=this._tileInfoView.getTileBounds(V(),t);if(this.isCustomTilingScheme&&t.world){const{tileInfo:i}=this._tileInfoView,e=R(i.spatialReference);if(e){const{resolution:r}=i.lodAt(t.level),o=e/r%i.size[0],h=o?(i.size[0]-o)*r:0;s[0]-=h*t.world,s[2]-=h*t.world}}return s}}let rt=class extends e{constructor(){super(...arguments),this._emptyTilePixelBlock=null,this.container=null,this.layer=null,this.tileSize=null,this.useWebGLForProcessing=!0}fetchTile(t,s){return this.layer.fetchTile(t.level,t.row,t.col,s)}createEmptyTilePixelBlock(t=null){const s=null==t||t.join(",")===this.tileSize.join(",");if(s&&r(this._emptyTilePixelBlock))return this._emptyTilePixelBlock;t=t||this.tileSize;const[i,e]=t,o=new P({width:i,height:e,pixels:[new Uint8Array(i*e)],mask:new Uint8Array(i*e),pixelType:"u8"});return s&&(this._emptyTilePixelBlock=o),o}};t([s()],rt.prototype,"container",void 0),t([s()],rt.prototype,"layer",void 0),t([s()],rt.prototype,"tileSize",void 0),t([s()],rt.prototype,"type",void 0),t([s()],rt.prototype,"useWebGLForProcessing",void 0),rt=t([i("esri.views.2d.layers.imagery.BaseImageryTileSubView2D")],rt);let ot=class extends rt{constructor(){super(...arguments),this.container=null,this.layer=null,this.tileSize=null,this.type="raster",this.useWebGLForProcessing=!0}canUseWebGLForProcessing(){return this.useWebGLForProcessing&&this.layer.symbolizer.canRenderInWebGL&&!("majority"===this.layer.interpolation&&this._canUseMajorityInterpolationOnDataSource())}fetchTile(t,s){return this.layer.fetchTile(t.level,t.row,t.col,s)}async updateTileSource(t,s){const{bandIds:i}=this.layer,e=this._getLayerInterpolation(),o=this.canUseWebGLForProcessing(),{source:h,symbolizerParams:a,globalSymbolizerParams:n,suspended:l,coords:p,resolution:c}=s,{bitmap:u}=t;if([u.x,u.y]=p,u.resolution=c,h&&r(h)&&r(h.pixelBlock)){const t={extent:h.extent,pixelBlock:h.pixelBlock};if(u.rawPixelData=t,o)u.source=h.pixelBlock,u.isRendereredSource=!1;else{const s=await this.layer.applyRenderer(t,"stretch"===(null==n?void 0:n.type)?n:null);u.source=s,u.isRendereredSource=!0}u.symbolizerParameters=o?a:null,o?u.transformGrid||(u.transformGrid=h.transformGrid):u.transformGrid=null}else{const t=this.createEmptyTilePixelBlock();u.source=t,u.symbolizerParameters=o?a:null,u.transformGrid=null}u.bandIds=o?i:null,u.width=this.tileSize[0],u.height=this.tileSize[1],u.interpolation=e,u.suspended=l,u.invalidateTexture()}async updateTileSymbolizerParameters(t,s){const{local:i,global:e}=s,{bandIds:o}=this.layer,h=this._getLayerInterpolation(),a=this.canUseWebGLForProcessing(),{bitmap:n}=t,{rawPixelData:l}=n;!a&&r(l)?(n.source=await this.layer.applyRenderer(l,"stretch"===(null==e?void 0:e.type)?e:null),n.isRendereredSource=!0):(n.isRendereredSource&&r(l)&&(n.source=l.pixelBlock),n.isRendereredSource=!1),n.symbolizerParameters=a?e||i:null,n.bandIds=a?o:null,n.interpolation=h,n.suspended=!1}install(t,s){this.container=new et(s.tileInfoView),this.container.isCustomTilingScheme=s.isCustomTilingScheme,t.addChild(this.container)}uninstall(){this.container.removeAllChildren(),this.container.remove()}_canUseMajorityInterpolationOnDataSource(){const{bandCount:t,attributeTable:s,colormap:i,pixelType:e}=this.layer.rasterInfo;return 1===t&&(null!=s||null!=i||"u8"===e||"s8"===e)}_getLayerInterpolation(){const t=this.layer.renderer.type;if("raster-colormap"===t||"unique-value"===t||"class-breaks"===t)return"nearest";const{interpolation:s}=this.layer,{renderer:i}=this.layer;return"raster-stretch"===i.type&&null!=i.colorRamp?"bilinear"===s||"cubic"===s?"bilinear":"nearest":s}};t([s()],ot.prototype,"container",void 0),t([s()],ot.prototype,"layer",void 0),t([s()],ot.prototype,"tileSize",void 0),t([s()],ot.prototype,"type",void 0),t([s()],ot.prototype,"useWebGLForProcessing",void 0),ot=t([i("esri.views.2d.layers.imagery.ImageryTileView2D")],ot);const ht=ot;class at extends Q{constructor(t=null){super(),this._source=null,this._symbolizerParameters=null,this._vaoInvalidated=!0,this.coordScale=[1,1],this.height=null,this.stencilRef=0,this.rawPixelData=null,this.width=null,this.source=t}destroy(){var t,s;r(this.vaoData)&&(null==(t=this.vaoData.magdir)||t.vao.dispose(),null==(s=this.vaoData.scalar)||s.vao.dispose(),this.vaoData=null)}get symbolizerParameters(){return this._symbolizerParameters}set symbolizerParameters(t){JSON.stringify(this._symbolizerParameters)!==JSON.stringify(t)&&(this._symbolizerParameters=t,this.invalidateVAO())}get source(){return this._source}set source(t){this._source=t,this.invalidateVAO()}invalidateVAO(){var t,s;!this._vaoInvalidated&&r(this.vaoData)&&(null==(t=this.vaoData.magdir)||t.vao.dispose(),null==(s=this.vaoData.scalar)||s.vao.dispose(),this.vaoData=null,this._vaoInvalidated=!0,this.requestRender())}updateVectorFieldVAO(t){if(this._vaoInvalidated){if(this._vaoInvalidated=!1,r(this.source)&&!r(this.vaoData)){const{style:s}=this.symbolizerParameters;switch(s){case"beaufort_ft":case"beaufort_km":case"beaufort_kn":case"beaufort_m":case"beaufort_mi":case"classified_arrow":case"ocean_current_kn":case"ocean_current_m":case"single_arrow":{const s=M(this.source,this.symbolizerParameters),i=this._createVectorFieldVAO(t.context,s);this.vaoData={magdir:i}}break;case"simple_scalar":{const s=W(this.source,this.symbolizerParameters),i=this._createVectorFieldVAO(t.context,s);this.vaoData={scalar:i}}break;case"wind_speed":{const s=M(this.source,this.symbolizerParameters),i=this._createVectorFieldVAO(t.context,s),e=W(this.source,this.symbolizerParameters),r=this._createVectorFieldVAO(t.context,e);this.vaoData={magdir:i,scalar:r}}}}this.ready(),this.requestRender()}}_createTransforms(){return{dvs:D()}}onAttach(){this.invalidateVAO()}onDetach(){this.invalidateVAO()}_createVectorFieldVAO(t,s){const{vertexData:i,indexData:e}=s,r=q.createVertex(t,35044,new Float32Array(i)),o=q.createIndex(t,35044,new Uint32Array(e)),h=C("vector-field",{geometry:[{location:0,name:"a_pos",count:2,type:5126,normalized:!1},{location:1,name:"a_offset",count:2,type:5126,normalized:!1},{location:2,name:"a_vv",count:2,type:5126,normalized:!1}]});return{vao:new J(t,h.attributes,h.bufferLayouts,{geometry:r},o),elementCount:e.length}}}class nt extends k{constructor(t,s,i,e,r,o=null){super(t,s,i,e,r),this.tileData=new at(o),this.tileData.coordScale=[e,r],this.tileData.once("isReady",(()=>this.ready()))}destroy(){super.destroy(),this.tileData.destroy(),this.tileData=null,this.stage=null}set stencilRef(t){this.tileData.stencilRef=t}get stencilRef(){return this.tileData.stencilRef}_createTransforms(){return{dvs:D(),tileMat3:D()}}setTransform(t,s){super.setTransform(t,s);const i=s/(t.resolution*t.pixelRatio),e=this.transforms.tileMat3,[r,o]=this.tileData.offset,h=[this.x+r*s,this.y-o*s],[a,n]=t.toScreenNoRotation([0,0],h),{symbolTileSize:l}=this.tileData.symbolizerParameters,p=Math.round((this.width-this.tileData.offset[0])/l)*l,c=Math.round((this.height-this.tileData.offset[1])/l)*l;B(e,p/this.rangeX*i,0,0,0,c/this.rangeY*i,0,a,n,1),N(this.transforms.dvs,t.displayViewMat3,e),this.tileData.transforms.dvs=this.transforms.dvs}onAttach(){this.tileData.stage=this.stage}onDetach(){this.tileData.stage=null}}class lt extends U{constructor(){super(...arguments),this.isCustomTilingScheme=!1,this.symbolTypes=["triangle"]}createTile(t){const s=this._tileInfoView.getTileBounds(V(),t),[i,e]=this._tileInfoView.tileInfo.size;return new nt(t,s[0],s[3],i,e)}destroyTile(){}prepareRenderPasses(t){const s=t.registerRenderPass({name:"imagery (vf tile)",brushes:[G],target:()=>this.children.map((t=>t.tileData)),drawPhase:A.MAP});return[...super.prepareRenderPasses(t),s]}doRender(t){this.visible&&t.drawPhase===A.MAP&&this.symbolTypes.forEach((s=>{t.renderPass=s,super.doRender(t)}))}}let pt=class extends rt{constructor(){super(...arguments),this._handle=null,this.container=null,this.layer=null,this.tileSize=null,this.type="rasterVF",this.useWebGLForProcessing=!0}canUseWebGLForProcessing(){return!1}async fetchTile(t,s){const i=await this.layer.fetchTile(t.level,t.row,t.col,s);return"vector-magdir"===this.layer.rasterInfo.dataType&&null!=i&&i.pixelBlock&&(i.pixelBlock=await this.layer.convertVectorFieldData(i.pixelBlock,s)),i}updateTileSource(t,s){const i=s.symbolizerParams,{tileData:e}=t;e.key=t.key,e.width=this.tileSize[0],e.height=this.tileSize[1];const{symbolTileSize:o}=i,{source:h}=s;if(e.offset=this._getTileSymbolOffset(e.key,o),r(h)&&r(h.pixelBlock))e.rawPixelData={extent:h.extent,pixelBlock:h.pixelBlock},e.source=this._sampleVectorFieldData(h.pixelBlock,i,e.offset),e.symbolizerParameters=i;else{const t=[Math.round((this.tileSize[0]-e.offset[0])/o),Math.round((this.tileSize[1]-e.offset[1])/o)],s=this.createEmptyTilePixelBlock(t);e.source=s,e.symbolizerParameters=i}return e.invalidateVAO(),Promise.resolve(null)}updateTileSymbolizerParameters(t,s){var i;const e=s.local,{symbolTileSize:o}=e,{tileData:h}=t;h.offset=this._getTileSymbolOffset(h.key,o);const a=h.symbolizerParameters.symbolTileSize;return h.symbolizerParameters=e,r(null==(i=h.rawPixelData)?void 0:i.pixelBlock)&&a!==o&&(h.source=this._sampleVectorFieldData(h.rawPixelData.pixelBlock,h.symbolizerParameters,h.offset)),Promise.resolve(null)}install(t,s){this.container=new lt(s.tileInfoView),this.container.isCustomTilingScheme=s.isCustomTilingScheme,this._updateSymbolType(this.layer.renderer),this._handle=this.layer.watch("renderer",(t=>this._updateSymbolType(t))),t.addChild(this.container)}uninstall(){this.container.removeAllChildren(),this._handle.remove(),this._handle=null,this.container.remove()}_getTileSymbolOffset(t,s){const i=t.col*this.tileSize[0]%s,e=t.row*this.tileSize[1]%s;return[i>s/2?s-i:-i,e>s/2?s-e:-e]}_sampleVectorFieldData(t,s,i){const{symbolTileSize:e}=s;return O(t,"vector-uv",e,i)}_updateSymbolType(t){"vector-field"===t.type&&(this.container.symbolTypes="wind-barb"===t.style?["scalar","triangle"]:"simple-scalar"===t.style?["scalar"]:["triangle"])}};t([s()],pt.prototype,"container",void 0),t([s()],pt.prototype,"layer",void 0),t([s()],pt.prototype,"tileSize",void 0),t([s()],pt.prototype,"type",void 0),t([s()],pt.prototype,"useWebGLForProcessing",void 0),pt=t([i("esri.views.2d.layers.imagery.VectorFieldTileView2D")],pt);const ct=pt,ut=e=>{let a=class extends e{constructor(){super(...arguments),this._rasterFieldPrefix="Raster.",this.layer=null,this.view=null,this.fullExtent=null,this.tileInfo=null,this.datumTransformation=null}get hasTilingEffects(){return this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment}async fetchPopupFeatures(t,s){const{layer:i}=this;if(!t)return Promise.reject(new o("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:i}));const{popupEnabled:e}=i,h=Z(i,s);if(!e||!r(h))throw new o("imageryTileLayerView:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:e,popupTemplate:h});const a=[],{value:n,magdirValue:l}=await i.identify(t,{timeExtent:this.timeExtent});let p="";if(n&&n.length){var c,u;p="imagery-tile"===i.type&&i.hasStandardTime()&&null!=n[0]?n.map((t=>i.getStandardTimeValue(t))).join(", "):n.join(", ");const t={ObjectId:0},s="Raster.ServicePixelValue";t[s]=this._formatAttributeValue(p,s);const e=null==(c=i.rasterInfo)||null==(u=c.attributeTable)?void 0:u.features;if(e&&e.length>0){const s=e.filter((t=>String(t.attributes.value||t.attributes.Value||t.attributes.VALUE)===p));if(s.length>0){const i=s[0];if(i)for(const s in i.attributes)if(i.attributes.hasOwnProperty(s)){const e=this._rasterFieldPrefix+s;t[e]=this._formatAttributeValue(i.attributes[s],e)}}}const r=i.rasterInfo.dataType;"vector-magdir"!==r&&"vector-uv"!==r||(t["Raster.Magnitude"]=null==l?void 0:l[0],t["Raster.Direction"]=null==l?void 0:l[1]);const o=new d(this.fullExtent.clone(),null,t);o.layer=i,o.sourceLayer=o.layer,a.push(o)}return a}updateFullExtent(){const t=this.layer.tileInfo;if(!t||!t.spatialReference)return Promise.reject(new o("layerview:tiling-information-missing","The layer doesn't provide tiling information",{layer:this.layer}));if(h(this.layer.fullExtent))return Promise.reject(new o("layerview:extent-missing","The layer doesn't provide a full extent.",{layer:this.layer}));const s=x(this.layer.fullExtent,this.view.spatialReference,!1),i=S(this.layer.fullExtent,this.view.spatialReference,s);return null==i?Promise.reject(new o("layerview:projection-not-supported","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})):(this._set("fullExtent",i),this.datumTransformation||(this.datumTransformation=x(this.layer.fullExtent,this.view.spatialReference,!0)),Promise.resolve())}_formatAttributeValue(t,s){if("string"==typeof t){const i=this._getFieldInfo(this.layer.popupTemplate&&this.layer.popupTemplate.fieldInfos,s),e=i&&i.format;if(e){let s,i;return t.trim().indexOf(",")>-1?(s=",",i=s+" ",this._formatDelimitedString(t,s,i,e)):t.trim().indexOf(" ")>-1?(s=i=" ",this._formatDelimitedString(t,s,i,e)):this._formatNumberFromString(t,e)}}return t}_getFieldInfo(t,s){if(!t||!t.length||!s)return;const i=s.toLowerCase();let e;return t.some((t=>!(!t.fieldName||t.fieldName.toLowerCase()!==i&&t.fieldName.toLowerCase()!==i.replace(/ /g,"_")||(e=t,0)))),e}_formatDelimitedString(t,s,i,e){return t&&s&&i&&e?t.trim().split(s).map((t=>this._formatNumberFromString(t,e))).join(i):t}_formatNumberFromString(t,s){if(!t||!s)return t;const i=Number(t);return isNaN(i)?t:s.format(i)}};return t([s()],a.prototype,"layer",void 0),t([s(Y)],a.prototype,"timeExtent",void 0),t([s()],a.prototype,"view",void 0),t([s()],a.prototype,"fullExtent",void 0),t([s()],a.prototype,"tileInfo",void 0),t([s({readOnly:!0})],a.prototype,"hasTilingEffects",null),a=t([i("esri.views.layers.ImageryTileLayerView")],a),a},mt=a.getLogger("esri.views.2d.layers.ImageryTileLayerView2D"),dt=[0,0];let ft=class extends(ut($(I(z)))){constructor(){super(...arguments),this._tileStrategy=null,this._tileInfoView=null,this._fetchQueue=null,this._blockCacheRegistryUrl=null,this._blockCacheRegistryId=null,this._srcResolutions=null,this._previousLOD=null,this._needBlockCacheUpdate=!1,this._globalSymbolizerParams=null,this._symbolizerParams=null,this._abortController=null,this._globalUpdateRequested=!1,this._isCustomTilingScheme=!1,this.subview=null,this._redrawOrRefetch=n(((t,s)=>this._previousLOD?t?this.doRefresh():this._redrawImage(s):Promise.resolve()))}initialize(){const t=this.updateFullExtent();this.addResolvingPromise(t)}get useWebGLForProcessing(){var t;return null==(t=this._get("useWebGLForProcessing"))||t}set useWebGLForProcessing(t){this.subview&&(this.subview.useWebGLForProcessing=t),this._set("useWebGLForProcessing",t)}get useProgressiveUpdate(){return null==this._get("useProgressiveUpdate")||this._get("useProgressiveUpdate")}set useProgressiveUpdate(t){if(this._tileStrategy&&this.useProgressiveUpdate!==t){var s;this._tileStrategy.destroy(),null==(s=this.subview)||s.container.removeAllChildren();const i=this._getCacheSize(t);this._tileStrategy=new K({cachePolicy:"purge",acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),cacheSize:i,tileInfoView:this._tileInfoView}),this._set("useProgressiveUpdate",t),this.requestUpdate()}}hitTest(t,s){if(this.suspended)return Promise.resolve(null);const i=this.view.toMap(f(t,s));return Promise.resolve(new d({attributes:{},geometry:i}))}update(t){this._fetchQueue.pause(),this._fetchQueue.state=t.state,this._tileStrategy.update(t),this._fetchQueue.resume();const{extent:s,resolution:i,scale:e}=t.state,r=this._tileInfoView.getClosestInfoForScale(e);if(this.layer.raster){var o;if(!this.useProgressiveUpdate||this._needBlockCacheUpdate){const t=this._srcResolutions[r.level],e=s.toJSON?s:b.fromJSON(s);g(this._blockCacheRegistryUrl,this._blockCacheRegistryId,e,i,t,this.layer.raster.ioConfig.sampling)}this._needBlockCacheUpdate=!1,(null==(o=this._previousLOD)?void 0:o.level)!==r.level&&(this._previousLOD=r,null==this._symbolizerParams||this.hasTilingEffects||this._updateSymbolizerParams(),this._tileStrategy.updateCacheSize(0))}this.notifyChange("updating")}attach(){this.layer.increaseRasterJobHandlerUsage(),st().supportsTextureFloat||(this.useWebGLForProcessing=!1),this._initializeTileInfo(),this._tileInfoView=new H(this.tileInfo,this.fullExtent);const t=this._computeFetchConcurrency();this._fetchQueue=new X({tileInfoView:this._tileInfoView,concurrency:t,process:(t,s)=>this.fetchTile(t,s)});const s=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy=new K({cachePolicy:"purge",acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),cacheSize:s,tileInfoView:this._tileInfoView}),this._updatesubview(),this.handles.add([l(this.layer,["bandIds","renderer","interpolation","multidimensionalDefinition"],((t,s,i)=>{const e="multidimensionalDefinition"===i,r="interpolation"===i&&("majority"===t||"majority"===s)&&this._canUseMajorityInterpolationOnDataSource(),o="renderer"===i&&"vector-field"===s.type!=("vector-field"===t.type);o&&this._updatesubview(),this._redrawOrRefetch(e||r||o).catch((t=>{p(t)||mt.error(t)}))})),c(this,["layer.blendMode"],(t=>{this.subview&&(this.subview.container.blendMode=t)}),!0),c(this,["layer.effect"],(t=>{this.subview&&(this.subview.container.effect=t)}),!0),c(this,"timeExtent",(()=>{this._redrawOrRefetch(!0).catch((t=>{p(t)||mt.error(t)}))}))],"attach"),this._updateBlockCacheRegistry()}detach(){var t;this.handles.remove("attach"),this.layer.decreaseRasterJobHandlerUsage(),null==(t=this.subview)||t.uninstall(),this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null,v(this._blockCacheRegistryUrl,this._blockCacheRegistryId)}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){!this.hasTilingEffects&&this.useProgressiveUpdate||(this._abortController&&this._abortController.abort(),this._abortController=new AbortController,0===this._fetchQueue.length&&this._redrawImage(this._abortController.signal).then((()=>{this._globalUpdateRequested=!1,this.requestUpdate()})));const t=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy.updateCacheSize(t),this.requestUpdate()}createFetchPopupFeaturesQueryGeometry(t,s){return tt(t,s,this.view)}async doRefresh(){if(this.suspended)return;await this.layer.updateRenderer(),this.hasTilingEffects||this._updateSymbolizerParams(),this._updateBlockCacheRegistry(!0),this._fetchQueue.reset();const t=[];this._tileStrategy.tiles.forEach((s=>t.push(this._enqueueTileFetch(s)))),await u(t),this.notifyChange("updating")}isUpdating(){return this._fetchQueue.length>0||this._globalUpdateRequested}acquireTile(t){const s=this.subview.container.createTile(t);return this._enqueueTileFetch(s),this.requestUpdate(),this._needBlockCacheUpdate=!0,this._globalUpdateRequested=this.hasTilingEffects||!this.useProgressiveUpdate,s}releaseTile(t){var s;this._fetchQueue.abort(t.key.id),null==(s=this.subview)||s.container.removeChild(t),t.once("detach",(()=>{t.destroy(),this.requestUpdate()})),this.requestUpdate()}fetchTile(t,s){const i=!h(s)&&s.signal,e=this.subview.canUseWebGLForProcessing(),r={allowPartialFill:!0,datumTransformation:this.datumTransformation,interpolation:e?"nearest":this.layer.interpolation,registryId:this._blockCacheRegistryId,requestRawData:e,signal:m(i),srcResolution:this._srcResolutions[t.level],timeExtent:this.timeExtent,tileInfo:this.tileInfo};return this.subview.fetchTile(t,r)}_updatesubview(){const t=this._isVectorField()?"rasterVF":"raster";if(this.subview){if(this.subview.type===t)return;this.subview.uninstall()}const{layer:s}=this;this._tileStrategy.clear();const i=new("rasterVF"===t?ct:ht)({layer:s,tileSize:this.tileInfo.size,useWebGLForProcessing:this.useWebGLForProcessing});i.install(this.container,{tileInfoView:this._tileInfoView,isCustomTilingScheme:this._isCustomTilingScheme}),i.container.blendMode=s.blendMode,i.container.effect=s.effect,this.subview=i}_isVectorField(){return"vector-field"===this.layer.renderer.type}_getCacheSize(t){return t?40:0}_initializeTileInfo(){const t=this.view.spatialReference,s=new j({x:this.fullExtent.xmin,y:this.fullExtent.ymax,spatialReference:t}),{scales:i,srcResolutions:e,isCustomTilingScheme:r}=F(this.layer.rasterInfo,t),o=y.create({spatialReference:t,size:512,scales:i});(0===o.origin.x||o.origin.x>s.x)&&(o.origin=s),this._isCustomTilingScheme=r,this._set("tileInfo",o),this._srcResolutions=null!=e?e:[]}_computeFetchConcurrency(){const{blockBoundary:t}=this.layer.rasterInfo.storageInfo,s=t[t.length-1];return(s.maxCol-s.minCol+1)*(s.maxRow-s.minRow+1)>64?2:10}async _enqueueTileFetch(t,s){if(!this._fetchQueue.has(t.key.id)){try{const s=await this._fetchQueue.push(t.key),{bandIds:i}=this.layer;let e=!this.useProgressiveUpdate||this.hasTilingEffects&&!this._globalSymbolizerParams;if(this._globalUpdateRequested&&!this.moving&&0===this._fetchQueue.length){e=!1;try{await this._redrawImage(this._abortController&&this._abortController.signal)}catch(t){p(t)&&mt.error(t)}this._globalUpdateRequested=!1}!this.subview.canUseWebGLForProcessing()&&!this._isVectorField()||this.hasTilingEffects||null!=this._symbolizerParams||this._updateSymbolizerParams();const r=this._tileInfoView.getTileCoords(dt,t.key),o=this._tileInfoView.getTileResolution(t.key);await this.subview.updateTileSource(t,{source:s,symbolizerParams:this._symbolizerParams,globalSymbolizerParams:this._globalSymbolizerParams,suspended:e,bandIds:i,coords:r,resolution:o}),t.once("attach",(()=>this.requestUpdate())),this.subview.container.addChild(t)}catch(t){p(t)||mt.error(t)}this.requestUpdate()}}async _redrawImage(t){if(0===this.subview.container.children.length)return;await this.layer.updateRenderer(),this.hasTilingEffects?await this._updateGlobalSymbolizerParams(t):(this._updateSymbolizerParams(),this._globalSymbolizerParams=null);const s=this.subview.container.children.map((async t=>this.subview.updateTileSymbolizerParameters(t,{local:this._symbolizerParams,global:this._globalSymbolizerParams})));await u(s),this.container.requestRender()}async _updateGlobalSymbolizerParams(t){const s={srcResolution:this._srcResolutions[this._previousLOD.level],registryId:this._blockCacheRegistryId,signal:t},i=await this.layer.fetchPixels(this.view.extent,this.view.width,this.view.height,s);if(!i||!i.pixelBlock)return;const e=this.layer.symbolizer.generateWebGLParameters({pixelBlock:_(i.pixelBlock,this.layer.bandIds),isGCS:this.view.spatialReference.isGeographic,resolution:{x:this._previousLOD.resolution,y:this._previousLOD.resolution},bandIds:this.layer.bandIds});!this.subview.canUseWebGLForProcessing()&&e&&"stretch"===e.type&&this.layer.renderer&&"raster-stretch"===this.layer.renderer.type&&(e.factor=e.factor.map((t=>255*t)),e.outMin=Math.round(255*e.outMin),e.outMax=Math.round(255*e.outMax)),this._globalSymbolizerParams=e}_updateSymbolizerParams(){this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null,isGCS:this.view.spatialReference.isGeographic,resolution:{x:this._previousLOD.resolution,y:this._previousLOD.resolution},bandIds:this.layer.bandIds})}_updateBlockCacheRegistry(t=!1){const{url:s,rasterInfo:i,raster:e}=this.layer,{multidimensionalDefinition:r}=this.layer.normalizeRasterFetchOptions({multidimensionalDefinition:this.layer.multidimensionalDefinition,timeExtent:this.timeExtent}),o=null!=i&&i.multidimensionalInfo?e.getSliceIndex(r):null,h=T(s,o);if(h!==this._blockCacheRegistryUrl){if(null!=this._blockCacheRegistryUrl&&v(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryId=w(h,this.layer.raster.rasterInfo),t){const t=this._tileInfoView.getClosestInfoForScale(this.view.scale);g(h,this._blockCacheRegistryId,this.view.extent,this.view.resolution,this._srcResolutions[t.level],this.layer.raster.ioConfig.sampling)}this._blockCacheRegistryUrl=h}}_canUseMajorityInterpolationOnDataSource(){const{bandCount:t,attributeTable:s,colormap:i,pixelType:e}=this.layer.rasterInfo;return 1===t&&(null!=s||null!=i||"u8"===e||"s8"===e)}};t([s()],ft.prototype,"subview",void 0),t([s()],ft.prototype,"useWebGLForProcessing",null),t([s()],ft.prototype,"useProgressiveUpdate",null),ft=t([i("esri.views.2d.layers.ImageryTileLayerView2D")],ft);const bt=ft;export default bt;