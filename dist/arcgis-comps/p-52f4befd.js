import{c8 as t,a0 as e,aU as s,dj as i,bT as r,di as n,Q as l,az as h,bu as u}from"./p-e58503d5.js";import{v as o,t as a,o as c,s as f,n as d,l as p,i as g,u as w,T as m,h as y,a as S,E as F,f as _,p as E,m as b,g as I,b as A}from"./p-0910f78f.js";import{a2 as R,a3 as v,a4 as T,a5 as O,x as N,a6 as D,a7 as P,a8 as k,a9 as x,c as C,n as G}from"./p-1ce5adcc.js";import{WhereClause as U}from"./p-61f47d2b.js";import{h as j}from"./p-54330161.js";import{x as B,n as M}from"./p-e991a11e.js";import{y as L}from"./p-a131049b.js";import{d as q}from"./p-612de336.js";import{d as V}from"./p-c048b814.js";import{G as W}from"./p-dae095dd.js";import{s as K}from"./p-5032dfbd.js";import{a as Q}from"./p-ca4492df.js";import J from"./p-dc852195.js";import{b as X,m as H}from"./p-5e833dfc.js";import{Q as z}from"./p-4a96de15.js";import{c as Y}from"./p-9087b4d3.js";import{m as Z}from"./p-120b7410.js";import{l as $}from"./p-ff2962f5.js";import{B as tt}from"./p-efbca0ca.js";import et from"./p-0eb619a6.js";class st{constructor(){this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}add(t,e,s){this._layerById[e]=s,this._layerByName[t]=s}featureSetByName(t,e=!0,s=["*"]){return this.resolvePromise(void 0===this._layerByName[t]?null:this._layerByName[t])}featureSetById(t,e=!0,s=["*"]){return this.resolvePromise(void 0===this._layerById[t]?null:this._layerById[t])}castToText(){return"object, FeatureSetCollection"}resolvePromise(e){return t(e)}}class it extends o{constructor(t){super(t),this.declaredClass="esri.arcade.featureset.actions.AttributeFilter",this._maxProcessing=1e3,this._parent=t.parentfeatureset,t.whereclause instanceof U?(this._whereclause=t.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=t.whereclause,this._whereclause=null)}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new e({wkid:4326}),this.geometryType=R.point)}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._parent._getFilteredSet("",null,this._whereclause,null,e))).then((t=>(this._checkCancelled(e),this._wset=null!==this._whereClauseFunction?new a(t._candidates.slice(0).concat(t._known.slice(0)),[],t._ordered,this._clonePageDefinition(t.pagesDefinition)):new a(t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition)),this._wset))):t(this._wset)}_isInFeatureSet(t){let e=this._parent._isInFeatureSet(t);return e===v.NotInFeatureSet?e:(e=this._idstates[t],void 0===e?v.Unknown:e)}_getFeature(t,e,s){return this._parent._getFeature(t,e,s)}_getFeatures(t,e,s,i){return this._parent._getFeatures(t,e,s,i)}_featureFromCache(t){return this._parent._featureFromCache(t)}executeWhereClause(t){return this._whereclause.testFeature(t)}executeWhereClauseDeferred(e){if(null!==this._whereClauseFunction)try{const i=this._whereClauseFunction(e);return s(i)?i:t(i)}catch(t){return i(t)}return t(this.executeWhereClause(e))}_fetchAndRefineFeatures(t,e,s){const i=new a([],t,!1,null),n=Math.min(e,t.length);return this._parent._getFeatures(i,-1,n,s).then((()=>{if(this._checkCancelled(s),null==this._whereClauseFunction){for(let e=0;e<n;e++){const s=this._parent._featureFromCache(t[e]);this._idstates[t[e]]=!0===this.executeWhereClause(s)?v.InFeatureSet:v.NotInFeatureSet}return"success"}const i=[];for(let e=0;e<n;e++){const s=this._parent._featureFromCache(t[e]);i.push(this.executeWhereClauseDeferred(s))}return r(i).then((s=>{for(let i=0;i<e;i++)this._idstates[t[i]]=!0===s[i]?v.InFeatureSet:v.NotInFeatureSet;return"success"}))}))}_getFilteredSet(t,e,s,i,r){return null!==this._whereClauseFunction||(null!==s?null!==this._whereclause&&(s=c(this._whereclause,s)):s=this._whereclause),this._ensureLoaded().then((()=>this._parent._getFilteredSet(t,e,s,i,r))).then((t=>{let e;return this._checkCancelled(r),e=null!==this._whereClauseFunction?new a(t._candidates.slice(0).concat(t._known.slice(0)),[],t._ordered,this._clonePageDefinition(t.pagesDefinition)):new a(t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition)),e}))}_stat(e,s,i,r,n,l,h){if(null!==this._whereClauseFunction)return null===n&&""===i&&null===r?this._manualStat(e,s,l,h):t({calculated:!1});let u=this._whereclause;return null!==n&&null!==this._whereclause&&(u=c(this._whereclause,n)),this._parent._stat(e,s,i,r,u,l,h).then((t=>!1===t.calculated?null===n&&""===i&&null===r?this._manualStat(e,s,l,h):{calculated:!1}:t))}_canDoAggregates(e,s,i,r,n){return null!==this._whereClauseFunction?t(!1):(null!==n?null!==this._whereclause&&(n=c(this._whereclause,n)):n=this._whereclause,null===this._parent?t(!1):this._parent._canDoAggregates(e,s,i,r,n))}_getAggregatePagesDataSourceDefinition(t,e,s,r,n,l,h){return null===this._parent?i(new Error("Should never be called")):(null!==n?null!==this._whereclause&&(n=c(this._whereclause,n)):n=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(t,e,s,r,n,l,h))}static registerAction(){o._featuresetFunctions.filter=function(t){if("function"==typeof t)return new it({parentfeatureset:this,whereclause:t});let e=null;return t instanceof U&&(e=t),new it({parentfeatureset:this,whereclause:e})}}}class rt{constructor(t){this.field=t,this.sqlRewritable=!1}postInitialization(t,e){}}class nt extends rt{constructor(t){super(t),this.sqlRewritable=!0}extractValue(t){return t.attributes[this.field.name]}rewriteSql(t){return{rewritten:this.sqlRewritable,where:t}}}class lt extends rt{constructor(t,e,s){super(T(t)),this.originalField=t,this.sqlRewritable=!0,this.field.name=e,this.field.alias=s}rewriteSql(t,e){return{rewritten:this.sqlRewritable,where:f(t,this.field.name,this.originalField.name,e.getFieldsIndex())}}extractValue(t){return t.attributes[this.originalField.name]}}class ht extends rt{constructor(t,e,s){super(t),this.codefield=e,this.lkp=s,this.reverseLkp={};for(const t in s)this.reverseLkp[s[t]]=t;this.sqlRewritable=!0}rewriteSql(t,e){const s=this.evaluateNodeToWhereClause(t.parseTree,O.Standardised,this.field.name,this.codefield instanceof U?d(this.codefield,O.Standardised):this.codefield,t.parameters);return s.indexOf(ht.BADNESS)>=0?{rewritten:!1,where:t}:{rewritten:this.sqlRewritable,where:U.create(s,e._parent.getFieldsIndex())}}evaluateNodeToWhereClause(t,e,s=null,i=null,r){let n,l,h,u;switch(t.type){case"interval":return m(this.evaluateNodeToWhereClause(t.value,e,s,i,r),t.qualifier,t.op);case"case_expression":{let i=" CASE ";"simple"===t.format&&(i+=this.evaluateNodeToWhereClause(t.operand,e,s,ht.BADNESS,r));for(let n=0;n<t.clauses.length;n++)i+=" WHEN "+this.evaluateNodeToWhereClause(t.clauses[n].operand,e,s,ht.BADNESS,r)+" THEN "+this.evaluateNodeToWhereClause(t.clauses[n].value,e,s,ht.BADNESS,r);return null!==t.else&&(i+=" ELSE "+this.evaluateNodeToWhereClause(t.else,e,s,ht.BADNESS,r)),i+=" END ",i}case"param":{const s=r[t.value.toLowerCase()];if("string"==typeof s)return"'"+r[t.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(s instanceof Date)return w(s,e);if(s instanceof Array){const t=[];for(let i=0;i<s.length;i++)"string"==typeof s[i]?t.push("'"+s[i].toString().replace(/'/g,"''")+"'"):s[i]instanceof Date?t.push(w(s[i],e)):t.push(s[i].toString());return t}return s.toString()}case"expr_list":l=[];for(const n of t.value)l.push(this.evaluateNodeToWhereClause(n,e,s,i,r));return l;case"unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(t.expr,e,s,ht.BADNESS,r)+" ) ";case"binary_expr":switch(t.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" AND "+this.evaluateNodeToWhereClause(t.right,e,s,i,r)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" OR "+this.evaluateNodeToWhereClause(t.right,e,s,i,r)+") ";case"IS":if("null"!==t.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" IS NULL )";case"ISNOT":if("null"!==t.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" IS NOT NULL )";case"IN":if(n=[],"expr_list"===t.right.type){if("column_ref"===t.left.type&&t.left.column.toUpperCase()===this.field.name.toUpperCase()){const n=[];let l=!0;for(const e of t.right.value){if("string"!==e.type){l=!1;break}if(void 0===this.lkp[e.value]){l=!1;break}n.push(this.lkp[e.value].toString())}if(l)return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" IN ("+n.join(",")+")) "}return n=this.evaluateNodeToWhereClause(t.right,e,s,i,r)," ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" IN ("+n.join(",")+")) "}return u=this.evaluateNodeToWhereClause(t.right,e,s,i,r),u instanceof Array?" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" IN ("+u.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" IN ("+u+")) ";case"NOT IN":if(n=[],"expr_list"===t.right.type){if("column_ref"===t.left.type&&t.left.column.toUpperCase()===this.field.name.toUpperCase()){const n=[];let l=!0;for(const e of t.right.value){if("string"!==e.type){l=!1;break}if(void 0===this.lkp[e.value]){l=!1;break}n.push(this.lkp[e.value].toString())}if(l)return" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" NOT IN ("+n.join(",")+")) "}return n=this.evaluateNodeToWhereClause(t.right,e,s,i,r)," ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" NOT IN ("+n.join(",")+")) "}return u=this.evaluateNodeToWhereClause(t.right,e,s,i,r),u instanceof Array?" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" NOT IN ("+u.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(t.left,e,s,i,r)+" NOT IN ("+u+")) ";case"BETWEEN":return h=this.evaluateNodeToWhereClause(t.right,e,s,ht.BADNESS,r)," ("+this.evaluateNodeToWhereClause(t.left,e,s,ht.BADNESS,r)+" BETWEEN "+h[0]+" AND "+h[1]+" ) ";case"NOTBETWEEN":return h=this.evaluateNodeToWhereClause(t.right,e,s,ht.BADNESS,r)," ("+this.evaluateNodeToWhereClause(t.left,e,s,ht.BADNESS,r)+" NOT BETWEEN "+h[0]+" AND "+h[1]+" ) ";case"LIKE":return""!==t.escape?" ("+this.evaluateNodeToWhereClause(t.left,e,s,ht.BADNESS,r)+" LIKE "+this.evaluateNodeToWhereClause(t.right,e,s,ht.BADNESS,r)+" ESCAPE '"+t.escape+"') ":" ("+this.evaluateNodeToWhereClause(t.left,e,s,ht.BADNESS,r)+" LIKE "+this.evaluateNodeToWhereClause(t.right,e,s,ht.BADNESS,r)+") ";case"NOT LIKE":return""!==t.escape?" ("+this.evaluateNodeToWhereClause(t.left,e,s,ht.BADNESS,r)+" NOT LIKE "+this.evaluateNodeToWhereClause(t.right,e,s,ht.BADNESS,r)+" ESCAPE '"+t.escape+"') ":" ("+this.evaluateNodeToWhereClause(t.left,e,s,ht.BADNESS,r)+" NOT LIKE "+this.evaluateNodeToWhereClause(t.right,e,s,ht.BADNESS,r)+") ";case"<>":case"=":if("column_ref"===t.left.type&&"string"===t.right.type){if(t.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[t.right.value.toString()])return" ("+i+" "+t.operator+" "+this.lkp[t.right.value.toString()].toString()+") "}else if("column_ref"===t.right.type&&"string"===t.left.type&&t.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[t.right.value.toString()].toString()+" "+t.operator+" "+i+") ";return" ("+this.evaluateNodeToWhereClause(t.left,e,s,ht.BADNESS,r)+" "+t.operator+" "+this.evaluateNodeToWhereClause(t.right,e,s,ht.BADNESS,r)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(t.left,e,s,ht.BADNESS,r)+" "+t.operator+" "+this.evaluateNodeToWhereClause(t.right,e,s,ht.BADNESS,r)+") "}throw new Error("Not Supported Operator "+t.operator);case"null":return"null";case"bool":return!0===t.value?"1":"0";case"string":return"'"+t.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return w(t.value,e);case"number":return t.value.toString();case"current_time":return g("date"===t.mode,e);case"column_ref":return s&&s.toLowerCase()===t.column.toLowerCase()?"("+i+")":t.column;case"function":{const i=this.evaluateNodeToWhereClause(t.args,e,s,ht.BADNESS,r);return p(t.name,i,e)}}throw new Error("Unsupported sql syntax "+t.type)}extractValue(t){return this.codefield instanceof U?this.reverseLkp[this.codefield.calculateValueCompiled(t)]:this.reverseLkp[t.attributes[this.codefield]]}}ht.BADNESS="_!!!_BAD_LKP_!!!!";class ut extends rt{constructor(t,e){super(t),this.sql=e}rewriteSql(t,e){return{rewritten:!0,where:f(t,this.field.name,d(this.sql,O.Standardised),e.getFieldsIndex())}}extractValue(t){return this.sql.calculateValueCompiled(t)}}class ot extends o{constructor(t){super(t),this._calcFunc=null,this.declaredClass="esri.arcade.featureset.actions.Adapted",this.adaptedFields=null,this._extraFilter=null,this._extraFilter=t.extraFilter,this._parent=t.parentfeatureset,this._maxProcessing=30,this.adaptedFields=t.adaptedFields}static findField(t,e){for(const s of t)if(s.name.toLowerCase()===e.toString().toLowerCase())return s;return null}_initialiseFeatureSet(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new e({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=R.point,this.typeIdField="",this.types=null),this.fields=[];for(const t of this.adaptedFields)t.postInitialization(this,this._parent),this.fields.push(t.field)}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._extraFilter?this._getFilteredSet("",null,null,null,e):this._parent._getSet(e))).then((t=>(this._checkCancelled(e),this._wset=new a(t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition)),this._wset))):t(this._wset)}_isInFeatureSet(t){return this._parent._isInFeatureSet(t)}_getFeatures(e,s,i,r){const n=[];-1!==s&&void 0===this._featureCache[s]&&n.push(s);const l=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,l))return this._expandPagedSet(e,l,0,0,r).then((()=>this._getFeatures(e,s,i,r)));let h=0;for(let t=e._lastFetchedIndex;t<e._known.length&&(h++,h<=i&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[t]]&&(e._known[t]!==s&&n.push(e._known[t]),n.length>=l)));t++);if(0===n.length)return t("success");e=new a([],n,e._ordered,null);const u=Math.min(n.length,i);return this._parent._getFeatures(e,-1,u,r).then((()=>{this._checkCancelled(r);const t=[];for(let e=0;e<u;e++){const s=this._parent._featureFromCache(n[e]);void 0!==s&&t.push({geometry:s.geometry,attributes:s.attributes,id:n[e]})}for(const e of t){const t=[];for(const s of this.adaptedFields)t[s.field.name]=s.extractValue(e);this._featureCache[e.id]=new j({attributes:t,geometry:N(e.geometry)})}return"success"}))}_fetchAndRefineFeatures(){return i(new Error("Fetch and Refine should not be called in this featureset"))}_getFilteredSet(t,e,s,i,r){let n=!1;const l=this.reformulateWithoutAdaptions(s);n=l.cannot,s=l.where;let h=!1;if(null!==i){h=!0;const t=[];for(const e of this.adaptedFields)if(!(e instanceof nt)&&!0===i.scanForField(e.field.name)){if(!(e instanceof lt)){i=null,h=!1;break}t.push({field:e.field.name,newfield:e.originalField.name})}i&&t.length>0&&(i=i.replaceFields(t))}return null!==s?null!==this._extraFilter&&(s=c(this._extraFilter,s)):s=this._extraFilter,this._ensureLoaded().then((()=>this._parent._getFilteredSet(t,e,s,i,r))).then((t=>{let e;return this._checkCancelled(r),e=!0===n?new a(t._candidates.slice(0).concat(t._known.slice(0)),[],!0===h&&t._ordered,this._clonePageDefinition(t.pagesDefinition)):new a(t._candidates.slice(0),t._known.slice(0),!0===h&&t._ordered,this._clonePageDefinition(t.pagesDefinition)),e}))}reformulateWithoutAdaptions(t){const e={cannot:!1,where:t};if(null!==t)for(const s of this.adaptedFields)if(!0===y(t,s.field.name)){const i=s.rewriteSql(t,this);if(!0!==i.rewritten){e.cannot=!0,e.where=null;break}e.where=i.where}return e}_stat(e,s,i,r,n,l,h){let u=!1,o=this.reformulateWithoutAdaptions(s);return u=o.cannot,s=o.where,o=this.reformulateWithoutAdaptions(n),u=u||o.cannot,null!==(n=o.where)?null!==this._extraFilter&&(n=c(this._extraFilter,n)):n=this._extraFilter,!0===u?null===n&&""===i&&null===r?this._manualStat(e,s,l,h):t({calculated:!1}):this._parent._stat(e,s,i,r,n,l,h).then((t=>!1===t.calculated?null===n&&""===i&&null===r?this._manualStat(e,s,l,h):{calculated:!1}:t))}_canDoAggregates(e,s,i,r,n){if(null===this._parent)return t(!1);for(let s=0;s<e.length;s++)for(const i of this.adaptedFields)if(e[s].toLowerCase()===i.field.name.toLowerCase()&&!(i instanceof nt))return t(!1);const l=[];for(let e=0;e<s.length;e++){const i=s[e];if(null!==i.workingexpr){const e=this.reformulateWithoutAdaptions(i.workingexpr);if(e.cannot)return t(!1);const s=i.clone();s.workingexpr=e.where,l.push(s)}else l.push(i)}const h=this.reformulateWithoutAdaptions(n);return h.cannot?t(!1):(null!==(n=h.where)?null!==this._extraFilter&&(n=c(this._extraFilter,n)):n=this._extraFilter,this._parent._canDoAggregates(e,l,i,r,n))}_getAggregatePagesDataSourceDefinition(t,e,s,r,n,l,h){if(null===this._parent)return i(new Error("Should never be called"));const u=[];for(let t=0;t<e.length;t++){const s=e[t];if(null!==s.workingexpr){const t=this.reformulateWithoutAdaptions(s.workingexpr);if(t.cannot)return i(new Error("Should never be called"));const e=s.clone();e.workingexpr=t.where,u.push(e)}else u.push(s)}const o=this.reformulateWithoutAdaptions(n);return o.cannot?i(new Error("Should never be called")):(null!==(n=o.where)?null!==this._extraFilter&&(n=c(this._extraFilter,n)):n=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(t,u,s,r,n,l,h))}}function at(t,e){return t===e?0:null===t?-1:null===e?1:t<e?-1:1}class ct{constructor(t){const e=t.split(",");this._fields=[],this._directions=[];for(let t=0;t<e.length;t++){const s=e[t].match(/\S+/g);this._fields.push(s[0]),2===s.length?"asc"===s[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let t="";for(let e=0;e<this._fields.length;e++)0!==e&&(t+=","),t+=this._fields[e],t+=1===this._directions[e]?" ASC":" DESC";return t}order(t){t.sort(((t,e)=>{for(let s=0;s<this._fields.length;s++){const i=this.featureValue(t.feature,this._fields[s],s),r=this.featureValue(e.feature,this._fields[s],s);let n=0;if(n=1===this._directions[s]?at(i,r):-1*at(i,r),0!==n)return n}return 0}))}scanForField(t){for(let e=0;e<this._fields.length;e++)if(this._fields[e].toLowerCase().trim()===t.toLowerCase().trim())return!0;return!1}replaceFields(t){let e="";for(let s=0;s<this._fields.length;s++){0!==s&&(e+=",");let i=this._fields[s];for(const e of t)if(i.toLowerCase()===e.field.toLowerCase()){i=e.newfield;break}e+=i,e+=1===this._directions[s]?" ASC":" DESC"}return new ct(e)}featureValue(t,e,s){const i=t.attributes[e];if(void 0!==i)return i;for(const i in t.attributes)if(e.toLowerCase()===i.toLowerCase())return this._fields[s]=i,t.attributes[i];return null}}class ft extends o{constructor(t){super(t),this._orderbyclause=null,this.declaredClass="esri.arcade.featureset.actions.OrderBy",this._maxProcessing=100,this._orderbyclause=t.orderbyclause,this._parent=t.parentfeatureset}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._getFilteredSet("",null,null,this._orderbyclause,e))).then((t=>(this._checkCancelled(e),this._wset=t,this._wset))):t(this._wset)}manualOrderSet(t,e){return this.getIdColumnDictionary(t,[],-1,e).then((t=>{this._orderbyclause.order(t);const e=new a([],[],!0,null);for(let s=0;s<t.length;s++)e._known.push(t[s].id);return e}))}getIdColumnDictionary(e,s,i,r){if(i<e._known.length-1){const t=this._maxQueryRate();if("GETPAGES"===e._known[i+1])return D(this._parent._expandPagedSet(e,t,0,0,r)).then((()=>this.getIdColumnDictionary(e,s,i,r)));let n=i+1;const l=[];for(;n<e._known.length&&"GETPAGES"!==e._known[n];)l.push(e._known[n]),n++;return i+=l.length,D(this._parent._getFeatureBatch(l,r)).then((t=>{this._checkCancelled(r);for(const e of t)s.push({id:e.attributes[this.objectIdField],feature:e});return this.getIdColumnDictionary(e,s,i,r)}))}return e._candidates.length>0?D(this._refineSetBlock(e,this._maxProcessingRate(),r)).then((()=>(this._checkCancelled(r),this.getIdColumnDictionary(e,s,i,r)))):t(s)}_isInFeatureSet(t){return this._parent._isInFeatureSet(t)}_getFeatures(t,e,s,i){return this._parent._getFeatures(t,e,s,i)}_featureFromCache(t){if(void 0===this._featureCache[t]){const e=this._parent._featureFromCache(t);if(void 0===e)return;return null===e?null:(this._featureCache[t]=e,e)}return this._featureCache[t]}_fetchAndRefineFeatures(){return i(new Error("Fetch and Refine should not be called in this featureset"))}_getFilteredSet(t,e,s,i,r){return this._ensureLoaded().then((()=>this._parent._getFilteredSet(t,e,s,null===i?this._orderbyclause:i,r))).then((t=>{this._checkCancelled(r);const i=new a(t._candidates.slice(0),t._known.slice(0),t._ordered,this._clonePageDefinition(t.pagesDefinition));let n=!0;return t._candidates.length>0&&(n=!1),!1===i._ordered?this.manualOrderSet(i,r).then((t=>(!1===n&&(null===e&&null===s||(t=new a(t._candidates.slice(0).concat(t._known.slice(0)),[],t._ordered,this._clonePageDefinition(t.pagesDefinition)))),t))):i}))}static registerAction(){o._featuresetFunctions.orderBy=function(t){return""===t?this:new ft({parentfeatureset:this,orderbyclause:new ct(t)})}}}class dt{clone(){const t=new dt;return t.field=this.field,t.tofieldname=this.tofieldname,t.typeofstat=this.typeofstat,t.workingexpr=this.workingexpr,t}static parseStatField(t,e,s){const i=new dt;i.field=t;const r=U.create(e,s),n=function(t){if("function"===t.parseTree.type){if(0===t.parseTree.args.value.length)return{name:t.parseTree.name,expr:null};if(t.parseTree.args.value.length>1)throw new Error("Statistic does not have 1 or 0 Parameters");const e=U.create(S(t.parseTree.args.value[0],O.Standardised,t.parameters),t.fieldsIndex);return{name:t.parseTree.name,expr:e}}return null}(r);if(null===n)throw new Error("Invalid Statistic Function");const l=n.name.toUpperCase().trim();if("MIN"===l){if(i.typeofstat="MIN",i.workingexpr=n.expr,null===r)throw new Error("Invalid Statistic Function Parameters")}else if("MAX"===l){if(i.typeofstat="MAX",i.workingexpr=n.expr,null===r)throw new Error("Invalid Statistic Function Parameters")}else if("COUNT"===l)i.typeofstat="COUNT",i.workingexpr=n.expr;else if("STDEV"===l){if(i.typeofstat="STDDEV",i.workingexpr=n.expr,null===r)throw new Error("Invalid Statistic Function Parameters")}else if("SUM"===l){if(i.typeofstat="SUM",i.workingexpr=n.expr,null===r)throw new Error("Invalid Statistic Function Parameters")}else if("MEAN"===l){if(i.typeofstat="AVG",i.workingexpr=n.expr,null===r)throw new Error("Invalid Statistic Function Parameters")}else if("AVG"===l){if(i.typeofstat="AVG",i.workingexpr=n.expr,null===r)throw new Error("Invalid Statistic Function Parameters")}else{if("VAR"!==l)throw new Error("Invalid Statistic Function");if(i.typeofstat="VAR",i.workingexpr=n.expr,null===r)throw new Error("Invalid Statistic Function Parameters")}return i}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";default:return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg"}}}function pt(t){if(!t)return"COUNT";switch(t.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}class gt extends o{constructor(t){super(t),this._decodedStatsfield=[],this._decodedGroupbyfield=[],this._candosimplegroupby=!0,this.phsyicalgroupbyfields=[],this.objectIdField="ROW__ID",this._internalObjectIdField="ROW__ID",this._adaptedFields=[],this.declaredClass="esri.arcade.featureset.actions.Aggregate",this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=t.parentfeatureset,this._config=t}isTable(){return!0}_getSet(e){return null===this._wset?this._getFilteredSet("",null,null,null,e).then((t=>(this._wset=t,this._wset))):t(this._wset)}_isInFeatureSet(){return v.InFeatureSet}nextUniqueName(t){for(;1===t["T"+this._uniqueIds.toString()];)this._uniqueIds++;const e="T"+this._uniqueIds.toString();return t[e]=1,e}convertToEsriFieldType(t){return t}_initialiseFeatureSet(){const t={};let s=!1,i=1;const r=this._parent?this._parent.getFieldsIndex():new q([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===s;){let t=!1;for(let e=0;e<this._config.groupbyfields.length;e++)if(this._config.groupbyfields[e].name.toLowerCase()===this.objectIdField.toLowerCase()){t=!0;break}if(!1===t)for(let e=0;e<this._config.statsfields.length;e++)if(this._config.statsfields[e].name.toLowerCase()===this.objectIdField.toLowerCase()){t=!0;break}!1===t?s=!0:(this.objectIdField="ROW__ID"+i.toString(),i++)}for(const t of this._config.statsfields){const e=new dt;e.field=t.name,e.tofieldname=t.name,e.workingexpr=t.expression instanceof U?t.expression:U.create(t.expression,r),e.typeofstat=pt(t.statistic),this._decodedStatsfield.push(e)}this._decodedGroupbyfield=[];for(const t of this._config.groupbyfields){const e={name:t.name,singlefield:null,tofieldname:t.name,expression:t.expression instanceof U?t.expression:U.create(t.expression,r)};this._decodedGroupbyfield.push(e)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(const e of this._parent.fields)t[e.name.toUpperCase()]=1;this.types=null}else this.geometryType=R.point,this.typeIdField="",this.types=null,this.spatialReference=new e({wkid:4326});this.fields=[];const n=new dt;n.field=this.nextUniqueName(t),n.tofieldname=this.objectIdField,n.workingexpr=U.create(this._parent.objectIdField,this._parent.getFieldsIndex()),n.typeofstat="MIN",this._decodedStatsfield.push(n);for(const e of this._decodedGroupbyfield){const s=new L;if(e.name=this.nextUniqueName(t),s.name=e.tofieldname,s.alias=s.name,F(e.expression)){const t=this._parent.getField(d(e.expression,O.Standardised));if(!t)throw new Error("Field is not present for Aggregation");e.name=t.name,e.singlefield=t.name,this.phsyicalgroupbyfields.push(t.name),s.type=t.type}else{s.type=this.convertToEsriFieldType(_(e.expression,this._parent.fields));const t=new L;t.name=e.name,t.alias=t.name,this.phsyicalgroupbyfields.push(e.name),this._adaptedFields.push(new ut(t,e.expression)),this._candosimplegroupby=!1}this.fields.push(s)}if(this._adaptedFields.length>0)for(const t of this._parent.fields)this._adaptedFields.push(new nt(t));for(let e=0;e<this._decodedStatsfield.length;e++){const s=new L;let i=null;const r=this._decodedStatsfield[e];r.field=this.nextUniqueName(t),r.tofieldname===this.objectIdField&&(this._internalObjectIdField=r.field),s.name=r.tofieldname,s.alias=s.name;const n=null!==r.workingexpr&&F(r.workingexpr)?d(r.workingexpr,O.Standardised):"";switch(this._decodedStatsfield[e].typeofstat){case"SUM":if(""!==n){if(i=this._parent.getField(n),!i)throw new Error("Field is not present for Aggregation");s.type=i.type}else s.type="double";break;case"MIN":case"MAX":if(""!==n){if(i=this._parent.getField(n),!i)throw new Error("Field is not present for Aggregation");s.type=i.type}else s.type="double";break;case"COUNT":s.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==n&&(i=this._parent.getField(n),!i))throw new Error("Field is not present for Aggregation");s.type="double"}this.fields.push(s)}}_canDoAggregates(){return t(!1)}_getFeatures(e,s,i,r){const n=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(e,n)?this._expandPagedSet(e,n,0,0,r).then((()=>this._getFeatures(e,s,i,r))):t("success")}_getFilteredSet(e,s,i,r,n){if(""!==e)return t(new a([],[],!0,null));let l=null;const h={ordered:!1,nowhereclause:!1};return this._ensureLoaded().then((()=>{if(null!==i)for(let t=0;t<this._decodedStatsfield.length;t++)if(!0===y(i,this._decodedStatsfield[t].tofieldname)){h.nowhereclause=!0,i=null;break}if(null!==r){h.ordered=!0;for(let t=0;t<this._decodedStatsfield.length;t++)if(!0===r.scanForField(this._decodedStatsfield[t].tofieldname)){r=null,h.ordered=!1;break}if(null!==r)for(const t of this._decodedGroupbyfield)if(null===t.singlefield&&!0===r.scanForField(t.tofieldname)){r=null,h.ordered=!1;break}}return!1===this._candosimplegroupby?t(!1):this._parent._canDoAggregates(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,null)})).then((t=>{if(t){let t=null;i&&(t=this._reformulateWhereClauseWithoutGroupByFields(i));let e=null;return r&&(e=this._reformulateOrderClauseWithoutGroupByFields(r)),this._parent._getAggregatePagesDataSourceDefinition(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,t,e,this._internalObjectIdField).then((t=>(this._checkCancelled(n),l=!0===h.nowhereclause?new a(t._candidates.slice(0).concat(t._known.slice(0)),[],!0===h.ordered&&t._ordered,this._clonePageDefinition(t.pagesDefinition)):new a(t._candidates.slice(0),t._known.slice(0),!0===h.ordered&&t._ordered,this._clonePageDefinition(t.pagesDefinition)),l)))}let e=this._parent;if(this._adaptedFields.length>0&&(e=new ot({parentfeatureset:this._parent,adaptedFields:this._adaptedFields,extraFilter:null})),!0===h.nowhereclause)l=new a(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new ft({parentfeatureset:e,orderbyclause:new ct(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}});else{let t=e;if(null!==i){let e=null;i&&(e=this._reformulateWhereClauseWithoutGroupByFields(i)),t=new it({parentfeatureset:t,whereclause:e})}l=new a(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new ft({parentfeatureset:t,orderbyclause:new ct(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}})}return l}))}_reformulateWhereClauseWithoutStatsFields(t){for(const e of this._decodedStatsfield)t=f(t,e.tofieldname,d(e.workingexpr,O.Standardised),this._parent.getFieldsIndex());return t}_reformulateWhereClauseWithoutGroupByFields(t){for(const e of this._decodedGroupbyfield)e.tofieldname!==e.name&&(t=f(t,e.tofieldname,d(e.expression,O.Standardised),this._parent.getFieldsIndex()));return t}_reformulateOrderClauseWithoutGroupByFields(t){const e=[];for(const t of this._decodedGroupbyfield)t.tofieldname!==t.name&&e.push({field:t.tofieldname,newfield:t.name});return e.length>0?t.replaceFields(e):t}_clonePageDefinition(t){return null===t?null:!0===t.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:t.resultRecordCount,resultOffset:t.resultOffset,internal:t.internal}:this._parent._clonePageDefinition(t)}_refineSetBlock(e,s,r){try{return!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQuery)?this._expandPagedSet(e,this._maxQuery,0,0,r).then((()=>this._refineSetBlock(e,s,r))):(this._checkCancelled(r),this._refineKnowns(e,s),t(e))}catch(t){return i(t)}}_expandPagedSet(t,e,s,i,r){return this._expandPagedSetFeatureSet(t,e,s,i,r)}_getPhysicalPage(t,e,s){return!0===t.pagesDefinition.aggregatefeaturesetpagedefinition?n(((e,i)=>{this._sequentialGetPhysicalItem(t,t.pagesDefinition.resultRecordCount,s,[]).then((t=>{e(t)}),i)})):this._getAgregagtePhysicalPage(t,e,s).then((t=>{for(const e of t){const t={geometry:e.geometry,attributes:{}};for(const s of this._decodedGroupbyfield)t.attributes[s.tofieldname]=e.attributes[s.name];for(const s of this._decodedStatsfield)t.attributes[s.tofieldname]=e.attributes[s.field];this._featureCache[t.attributes[this.objectIdField]]=new j(t)}return t.length}))}_sequentialGetPhysicalItem(t,e,s,i){return n(((r,n)=>{null===t.pagesDefinition.internal.iterator&&(t.pagesDefinition.internal.iterator=t.pagesDefinition.internal.subfeatureset.iterator(s)),!0===t.pagesDefinition.internal.fullyResolved||0===e?r(i.length):this._nextAggregateItem(t,e,s,i,(n=>{r(null===n?i.length:this._sequentialGetPhysicalItem(t,e-=1,s,i))}),n)}))}_nextAggregateItem(t,e,s,i,r,n){try{D(t.pagesDefinition.internal.iterator.next()).then((l=>{if(null===l)if(null!==t.pagesDefinition.internal.workingItem){const e=this._calculateAndAppendAggregateItem(t.pagesDefinition.internal.workingItem);i.push(e),t.pagesDefinition.internal.workingItem=null,t.pagesDefinition.internal.set.push(e.attributes[this.objectIdField]),t.pagesDefinition.internal.fullyResolved=!0,r(null)}else t.pagesDefinition.internal.fullyResolved=!0,r(null);else{const h=this._generateAggregateHash(l);if(null===t.pagesDefinition.internal.workingItem)t.pagesDefinition.internal.workingItem={features:[l],id:h};else{if(h!==t.pagesDefinition.internal.workingItem.id){const s=this._calculateAndAppendAggregateItem(t.pagesDefinition.internal.workingItem);return i.push(s),t.pagesDefinition.internal.workingItem=null,t.pagesDefinition.internal.set.push(s.attributes[this.objectIdField]),e-=1,t.pagesDefinition.internal.workingItem={features:[l],id:h},void r(s)}t.pagesDefinition.internal.workingItem.features.push(l)}this._nextAggregateItem(t,e,s,i,r,n)}}),n)}catch(t){n(t)}}_calculateFieldStat(t,e,s){const i=[];for(let s=0;s<t.features.length;s++)if(null!==e.workingexpr){const r=e.workingexpr.calculateValue(t.features[s]);null!==r&&i.push(r)}else i.push(null);switch(e.typeofstat){case"MIN":s.attributes[e.tofieldname]=E("min",i,-1);break;case"MAX":s.attributes[e.tofieldname]=E("max",i,-1);break;case"SUM":s.attributes[e.tofieldname]=E("sum",i,-1);break;case"COUNT":s.attributes[e.tofieldname]=i.length;break;case"VAR":s.attributes[e.tofieldname]=E("var",i,-1);break;case"STDDEV":s.attributes[e.tofieldname]=E("stddev",i,-1);break;case"AVG":s.attributes[e.tofieldname]=E("avg",i,-1)}return!0}_calculateAndAppendAggregateItem(t){const e={attributes:{},geometry:null};for(const s of this._decodedGroupbyfield){const i=s.singlefield?t.features[0].attributes[s.singlefield]:s.expression.calculateValue(t.features[0]);e.attributes[s.tofieldname]=i}for(const s of this._decodedStatsfield)this._calculateFieldStat(t,s,e);const s=[];for(let i=0;i<this._decodedStatsfield.length;i++)s.push(this._calculateFieldStat(t,this._decodedStatsfield[i],e));return this._featureCache[e.attributes[this.objectIdField]]=new j({attributes:e.attributes,geometry:e.geometry}),e}_generateAggregateHash(t){let e="";for(const s of this._decodedGroupbyfield){const i=s.singlefield?t.attributes[s.singlefield]:s.expression.calculateValue(t);e+=null==i?":":":"+i.toString()}return B(e,M.String)}_stat(){return t({calculated:!1})}getFeatureByObjectId(){return t(null)}static registerAction(){o._featuresetFunctions.groupby=function(t,e){return new gt({parentfeatureset:this,groupbyfields:t,statsfields:e})}}}class wt extends o{constructor(t){super(t),this._topnum=0,this.declaredClass="esri.arcade.featureset.actions.Top",this._countedin=0,this._maxProcessing=100,this._topnum=t.topnum,this._parent=t.parentfeatureset}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._parent._getSet(e))).then((t=>(this._wset=new a(t._candidates.slice(0),t._known.slice(0),!1,this._clonePageDefinition(t.pagesDefinition)),this._setKnownLength(this._wset)>this._topnum&&(this._wset._known=this._wset._known.slice(0,this._topnum)),this._setKnownLength(this._wset)>=this._topnum&&(this._wset._candidates=[]),this._wset))):t(this._wset)}_setKnownLength(t){return t._known.length>0&&"GETPAGES"===t._known[t._known.length-1]?t._known.length-1:t._known.length}_isInFeatureSet(t){const e=this._parent._isInFeatureSet(t);if(e===v.NotInFeatureSet)return e;const s=this._idstates[t];return s===v.InFeatureSet||s===v.NotInFeatureSet?s:e===v.InFeatureSet&&void 0===s?this._countedin<this._topnum?(this._idstates[t]=v.InFeatureSet,this._countedin++,v.InFeatureSet):(this._idstates[t]=v.NotInFeatureSet,v.NotInFeatureSet):v.Unknown}_expandPagedSet(e,s,r,n,l){if(null===this._parent)return i(new Error("Parent Paging not implemented"));if(s>this._topnum&&(s=this._topnum),this._countedin>=this._topnum&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset){let s=e._known.length;return s>0&&"GETPAGES"===e._known[s-1]&&(e._known.length=s-1),s=e._candidates.length,s>0&&"GETPAGES"===e._candidates[s-1]&&(e._candidates.length=s-1),t("success")}return this._parent._expandPagedSet(e,s,r,n,l).then((t=>(this._setKnownLength(e)>this._topnum&&(e._known.length=this._topnum),this._setKnownLength(e)>=this._topnum&&(e._candidates.length=0),t)))}_getFeatures(e,s,i,r){const n=[],l=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,l))return this._expandPagedSet(e,l,0,0,r).then((()=>this._getFeatures(e,s,i,r)));-1!==s&&void 0===this._featureCache[s]&&n.push(s);let h=0;for(let t=e._lastFetchedIndex;t<e._known.length&&(h++,h<=i&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[t]]&&(e._known[t]!==s&&n.push(e._known[t]),n.length>l)));t++);if(0===n.length)return t("success");const u=new a([],n,!1,null),o=Math.min(n.length,i);return this._parent._getFeatures(u,-1,o,r).then((()=>{for(let t=0;t<o;t++){const e=this._parent._featureFromCache(n[t]);void 0!==e&&(this._featureCache[n[t]]=e)}return"success"}))}_getFilteredSet(t,e,s,i,r){return this._ensureLoaded().then((()=>this._getSet(r))).then((t=>new a(t._candidates.slice(0).concat(t._known.slice(0)),[],!1,this._clonePageDefinition(t.pagesDefinition))))}_refineKnowns(t,e){let s=0,i=null;const r=[];for(let n=0;n<t._candidates.length;n++){const l=this._isInFeatureSet(t._candidates[n]);if(l===v.InFeatureSet){if(t._known.push(t._candidates[n]),s+=1,null===i?i={start:n,end:n}:i.end===n-1?i.end=n:(r.push(i),i={start:n,end:n}),t._known.length>=this._topnum)break}else if(l===v.NotInFeatureSet)null===i?i={start:n,end:n}:i.end===n-1?i.end=n:(r.push(i),i={start:n,end:n}),s+=1;else if(l===v.Unknown)break;if(s>=e)break}null!==i&&r.push(i);for(let e=r.length-1;e>=0;e--)t._candidates.splice(r[e].start,r[e].end-r[e].start+1);this._setKnownLength(t)>this._topnum&&(t._known=t._known.slice(0,this._topnum)),this._setKnownLength(t)>=this._topnum&&(t._candidates=[])}_stat(){return t({calculated:!1})}_canDoAggregates(){return t(!1)}static registerAction(){o._featuresetFunctions.top=function(t){return new wt({parentfeatureset:this,topnum:t})}}}class mt extends o{constructor(t){super(t),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",this._removeGeometry=!1,this._overrideFields=null,this.formulaCredential=null,this._pageJustIds=!1,this._requestStandardised=!1,this._useDefinitionExpression=!0,t.spatialReference&&(this.spatialReference=t.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=t.layer,this._wset=null,void 0!==t.outFields&&(this._overrideFields=t.outFields),void 0!==t.includeGeometry&&(this._removeGeometry=!1===t.includeGeometry)}_maxQueryRate(){return P}end(){return this._layer}optimisePagingFeatureQueries(t){this._pageJustIds=t}convertQueryToLruCacheKey(t){const e=k(t.toJSON());return B(e,M.String)}load(){return null===this._loadPromise&&(this._loadPromise=n(((t,e)=>{try{if(!0===this._layer.loaded)return this._initialiseFeatureSet(),void t(this);this._layer.when().then((()=>{try{this._initialiseFeatureSet(),t(this)}catch(t){e(t)}}),e),this._layer.load()}catch(t){e(t)}}))),this._loadPromise}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{const t=[];for(const e of this.fields)if("oid"===e.type)t.push(e);else for(const s of this._layer.outFields)if(s.toLowerCase()===e.name.toLowerCase()){t.push(e);break}this.fields=t}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],e=[];for(const s of this.fields)if("oid"===s.type)t.push(s),e.push(s.name);else for(const i of this._overrideFields)if(i.toLowerCase()===s.name.toLowerCase()){t.push(s),e.push(s.name);break}this.fields=t,this._overrideFields=e}if(this._layer.source&&this._layer.source.sourceJSON){const t=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=O.StandardisedNoInterval,null!=t&&t>=10.61&&(this._databaseType=O.Standardised)):null!=t&&(t>=10.5&&(this._databaseType=O.StandardisedNoInterval,this._requestStandardised=!0),t>=10.61&&(this._databaseType=O.Standardised))}this.objectIdField=this._layer.objectIdField;for(const t of this.fields)"global-id"===t.type&&(this.globalIdField=t.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}_isInFeatureSet(){return v.InFeatureSet}_refineSetBlock(e){return t(e)}_candidateIdTransform(t){return t}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._getFilteredSet("",null,null,null,e))).then((t=>(this._wset=t,t))):t(this._wset)}_runDatabaseProbe(t){return n(((e,s)=>{try{this._ensureLoaded().then((()=>{try{const i=new X;i.where=t.replace("OBJECTID",this._layer.objectIdField),this._layer.queryObjectIds(i).then((()=>{e(!0)}),(()=>{try{e(!1)}catch(t){s(t)}}))}catch(t){s(t)}}))}catch(t){s(t)}}))}_canUsePagination(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}_cacheableFeatureSetSourceKey(){return this._layer.url}pbfSupportedForQuery(t){return!t.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode}queryPBF(t){return t.quantizationParameters={mode:"edit"},Y(this._layer.parsedUrl,t,new Q({})).then((t=>J.fromJSON(K(t.data)).unquantize()))}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}nativeCapabilities(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}executeQuery(t,e){const s=new z({url:this._layer.parsedUrl.path}),i="execute"===e&&this.pbfSupportedForQuery(t);let r=null;if(this.recentlyUsedQueries){const n=this.convertQueryToLruCacheKey(t);r=this.recentlyUsedQueries.getFromCache(n),null===r&&(r=!0!==i?s[e](t):this.queryPBF(t),this.recentlyUsedQueries.addToCache(n,r),r=r.catch((t=>{throw this.recentlyUsedQueries.removeFromCache(n),t})))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:t,method:e}),null===r&&(r=!0!==i?s[e](t):this.queryPBF(t)),r}_getFilteredSet(t,e,s,i,r){return this.databaseType().then((n=>{if(this.isTable()&&e&&null!==t&&""!==t)return new a([],[],!0,null);if(this._canUsePagination())return this._getFilteredSetUsingPaging(t,e,s,i,r);let l="",h=!1;null!==i&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(l=i.constructClause(),h=!0);const u=new X;return u.where=null===s?null===e?"1=1":"":d(s,n),this._requestStandardised&&(u.sqlFormat="standard"),u.spatialRelationship=this._makeRelationshipEnum(t),u.outSpatialReference=this.spatialReference,u.orderByFields=""!==l?l.split(","):null,u.geometry=null===e?null:e,u.relationParameter=this._makeRelationshipParam(t),this.executeQuery(u,"executeForIds").then((t=>(null===t&&(t=[]),this._checkCancelled(r),new a([],t,h,null))))}))}_expandPagedSet(t,e,s,i,r){return this._expandPagedSetFeatureSet(t,e,s,i,r)}_getFilteredSetUsingPaging(t,e,s,r,n){try{let i="",l=!1;return null!==r&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(i=r.constructClause(),l=!0),this.databaseType().then((r=>{let h=null===s?null===e?"1=1":"":d(s,r);this._layer.definitionExpression&&this._useDefinitionExpression&&(h=""!==h?"(("+this._layer.definitionExpression+") AND ("+h+"))":this._layer.definitionExpression);let u=this._maxQueryRate();const o=this._layer.capabilities.query.maxRecordCount;void 0!==o&&o<u&&(u=o);let c=null;if(!0===this._pageJustIds)c=new a([],["GETPAGES"],l,{spatialRel:this._makeRelationshipEnum(t),relationParam:this._makeRelationshipParam(t),outFields:this._layer.objectIdField,resultRecordCount:u,resultOffset:0,geometry:null===e?null:e,where:h,orderByFields:i,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{let s=!0;!0===this._removeGeometry&&(s=!1);const r=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]);c=new a([],["GETPAGES"],l,{spatialRel:this._makeRelationshipEnum(t),relationParam:this._makeRelationshipParam(t),outFields:r.join(","),resultRecordCount:u,resultOffset:0,geometry:null===e?null:e,where:h,orderByFields:i,returnGeometry:s,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return this._expandPagedSet(c,u,0,1,n).then((()=>c))}))}catch(t){return i(t)}}_clonePageDefinition(t){return null===t?null:!0!==t.groupbypage?{groupbypage:!1,spatialRel:t.spatialRel,relationParam:t.relationParam,outFields:t.outFields,resultRecordCount:t.resultRecordCount,resultOffset:t.resultOffset,geometry:t.geometry,where:t.where,orderByFields:t.orderByFields,returnGeometry:t.returnGeometry,returnIdsOnly:t.returnIdsOnly,internal:t.internal}:{groupbypage:!0,spatialRel:t.spatialRel,relationParam:t.relationParam,outFields:t.outFields,resultRecordCount:t.resultRecordCount,useOIDpagination:t.useOIDpagination,generatedOid:t.generatedOid,groupByFieldsForStatistics:t.groupByFieldsForStatistics,resultOffset:t.resultOffset,outStatistics:t.outStatistics,geometry:t.geometry,where:t.where,orderByFields:t.orderByFields,returnGeometry:t.returnGeometry,returnIdsOnly:t.returnIdsOnly,internal:t.internal}}_getPhysicalPage(t,e,s){try{const e=t.pagesDefinition.internal.lastRetrieved,i=e,r=t.pagesDefinition.internal.lastPage,n=new X;return this._requestStandardised&&(n.sqlFormat="standard"),n.spatialRelationship=t.pagesDefinition.spatialRel,n.relationParameter=t.pagesDefinition.relationParam,n.outFields=t.pagesDefinition.outFields.split(","),n.num=t.pagesDefinition.resultRecordCount,n.start=t.pagesDefinition.internal.lastPage,n.geometry=t.pagesDefinition.geometry,n.where=t.pagesDefinition.where,n.orderByFields=""!==t.pagesDefinition.orderByFields?t.pagesDefinition.orderByFields.split(","):null,n.returnGeometry=t.pagesDefinition.returnGeometry,n.outSpatialReference=this.spatialReference,this.executeQuery(n,"execute").then((n=>{if(this._checkCancelled(s),t.pagesDefinition.internal.lastPage!==r)return"done";for(let e=0;e<n.features.length;e++)t.pagesDefinition.internal.set[i+e]=n.features[e].attributes[this._layer.objectIdField];if(!1===this._pageJustIds)for(let t=0;t<n.features.length;t++)this._featureCache[n.features[t].attributes[this._layer.objectIdField]]=n.features[t];return(void 0===n.exceededTransferLimit&&n.features.length!==t.pagesDefinition.resultRecordCount||!1===n.exceededTransferLimit)&&(t.pagesDefinition.internal.fullyResolved=!0),t.pagesDefinition.internal.lastRetrieved=e+n.features.length,t.pagesDefinition.internal.lastPage+=t.pagesDefinition.resultRecordCount,"done"}))}catch(t){return i(t)}}_fieldsIncludingObjectId(t){if(null===t)return[this.objectIdField];const e=t.slice(0);if(e.indexOf("*")>-1)return e;let s=!1;for(const t of e)if(t.toUpperCase()===this.objectIdField.toUpperCase()){s=!0;break}return!1===s&&e.push(this.objectIdField),e}_getFeatures(e,s,r,n){const l=[];try{if(-1!==s&&void 0===this._featureCache[s]&&l.push(s),!0===this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate()))return this._expandPagedSet(e,this._maxProcessingRate(),0,0,n).then((()=>this._getFeatures(e,s,r,n)));let h=0;for(let t=e._lastFetchedIndex;t<e._known.length;t++){if(e._lastFetchedIndex+=1,h++,void 0===this._featureCache[e._known[t]]){let i=!1;if(null!=this._layer._mode){const s=this._layer._mode;if(void 0!==s._featureMap[e._known[t]]){const r=s._featureMap[e._known[t]];null!==r&&(i=!0,this._featureCache[e._known[t]]=r)}}if(!1===i&&(e._known[t]!==s&&l.push(e._known[t]),l.length>=this._maxProcessingRate()-1))break}if(h>=r&&0===l.length)break}if(0===l.length)return t("success");try{const t=new X;return this._requestStandardised&&(t.sqlFormat="standard"),t.objectIds=l,t.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]),t.returnGeometry=!0,!0===this._removeGeometry&&(t.returnGeometry=!1),t.outSpatialReference=this.spatialReference,this.executeQuery(t,"execute").then((t=>{if(this._checkCancelled(n),void 0!==t.error)return i(new Error(t.error));for(let e=0;e<t.features.length;e++)this._featureCache[t.features[e].attributes[this._layer.objectIdField]]=t.features[e];return"success"}))}catch(t){return i(t)}}catch(t){return i(t)}}_getDistinctPages(t,e,s,r,n,l,h,u,o){return this._ensureLoaded().then((()=>this.databaseType())).then((a=>{let c=s.parseTree.column;for(let t=0;t<this._layer.fields.length;t++)if(this._layer.fields[t].name.toLowerCase()===c.toLowerCase()){c=this._layer.fields[t].name;break}const f=new X;this._requestStandardised&&(f.sqlFormat="standard");let p=null===l?null===n?"1=1":"":d(l,a);return this._layer.definitionExpression&&this._useDefinitionExpression&&(p=""!==p?"(("+this._layer.definitionExpression+") AND ("+p+"))":this._layer.definitionExpression),f.where=p,f.spatialRelationship=this._makeRelationshipEnum(r),f.relationParameter=this._makeRelationshipParam(r),f.geometry=null===n?null:n,f.returnDistinctValues=!0,f.returnGeometry=!1,f.outFields=[c],this.executeQuery(f,"execute").then((a=>{if(this._checkCancelled(o),!a.hasOwnProperty("features"))return i(new Error("Unnexected Result querying statistics from layer"));let f=!1;for(let t=0;t<this._layer.fields.length;t++)if(this._layer.fields[t].name===c){"date"===this._layer.fields[t].type&&(f=!0);break}for(let t=0;t<a.features.length;t++){if(f){const e=a.features[t].attributes[c];u.push(null!==e?new Date(e):e)}else u.push(a.features[t].attributes[c]);if(u.length>=h)break}return 0===a.features.length?u:a.features.length===this._layer.capabilities.query.maxRecordCount&&u.length<h?this._getDistinctPages(t+a.features.length,e,s,r,n,l,h,u,o).then((t=>({calculated:!0,result:t}))):u}))}))}_distinctStat(t,e,s,i,r,n,l){return this._getDistinctPages(0,t,e,s,i,r,n,[],l).then((t=>({calculated:!0,result:t})))}isTable(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType}_countstat(t,e,s,i){return this.databaseType().then((t=>{const r=new X;if(this._requestStandardised&&(r.sqlFormat="standard"),this.isTable()&&s&&null!==e&&""!==e)return{calculated:!0,result:0};let n=null===i?null===s?"1=1":"":d(i,t);return this._layer.definitionExpression&&this._useDefinitionExpression&&(n=""!==n?"(("+this._layer.definitionExpression+") AND ("+n+"))":this._layer.definitionExpression),r.where=n,r.where=n,r.spatialRelationship=this._makeRelationshipEnum(e),r.relationParameter=this._makeRelationshipParam(e),r.geometry=null===s?null:s,r.returnGeometry=!1,this.executeQuery(r,"executeForCount").then((t=>({calculated:!0,result:t})))}))}_stats(t,e,s,r,n,l,h){return this._ensureLoaded().then((()=>{const u=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression,o=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics,a=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsDistinct;return"count"===t?a?this._countstat(t,s,r,n):{calculated:!1}:!1===o||!1===F(e)&&!1===u||!1===e.isStandardized?""!==s||null!==n?{calculated:!1}:this._manualStat(t,e,l,h):"distinct"===t?!1===a?""!==s||null!==n?{calculated:!1}:this._manualStat(t,e,l,h):this._distinctStat(t,e,s,r,n,l,h):this.databaseType().then((l=>{if(this.isTable()&&r&&null!==s&&""!==s)return{calculated:!0,result:null};const h=new X;this._requestStandardised&&(h.sqlFormat="standard");let u=null===n?null===r?"1=1":"":d(n,l);this._layer.definitionExpression&&this._useDefinitionExpression&&(u=""!==u?"(("+this._layer.definitionExpression+") AND ("+u+"))":this._layer.definitionExpression),h.where=u,h.spatialRelationship=this._makeRelationshipEnum(s),h.relationParameter=this._makeRelationshipParam(s),h.geometry=null===r?null:r;const o=new H;o.statisticType=b(t),o.onStatisticField=d(e,l),o.outStatisticFieldName="ARCADE_STAT_RESULT",h.returnGeometry=!1;let a="ARCADE_STAT_RESULT";return h.outStatistics=[o],this.executeQuery(h,"execute").then((t=>{if(!t.hasOwnProperty("features")||0===t.features.length)return i(new Error("Unnexected Result querying statistics from layer"));let e=!1;for(let s=0;s<t.fields.length;s++)if("ARCADE_STAT_RESULT"===t.fields[s].name.toUpperCase()){a=t.fields[s].name,"date"===t.fields[s].type&&(e=!0);break}if(e){let e=t.features[0].attributes[a];return null!==e&&(e=new Date(t.features[0].attributes[a])),{calculated:!0,result:e}}return{calculated:!0,result:t.features[0].attributes[a]}}))}))}))}_stat(t,e,s,i,r,n,l){return this._stats(t,e,s,i,r,n,l)}_canDoAggregates(t,e){return this._ensureLoaded().then((()=>{let t=!1;const s=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression;if(void 0!==this._layer.capabilities&&null!==this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics&&!0===this._layer.capabilities.query.supportsOrderBy&&(t=!0),t)for(let i=0;i<e.length-1;i++)null!==e[i].workingexpr&&(!1===e[i].workingexpr.isStandardized||!1===F(e[i].workingexpr)&&!1===s)&&(t=!1);return!1!==t}))}_makeRelationshipEnum(t){if(t.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(t){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return t}_makeRelationshipParam(t){return t.indexOf("esriSpatialRelRelation")>=0?t.split(":")[1]:""}_getAggregatePagesDataSourceDefinition(t,e,s,i,r,n,l){return this._ensureLoaded().then((()=>this.databaseType())).then((h=>{let u="",o=!1,c=!1;null!==n&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(u=n.constructClause(),c=!0),this._layer.capabilities&&this._layer.capabilities.query&&!1===this._layer.capabilities.query.supportsPagination&&(c=!1,o=!0,u=this._layer.objectIdField);const f=[];for(let t=0;t<e.length;t++){const s=new H;s.onStatisticField=null!==e[t].workingexpr?d(e[t].workingexpr,h):"",s.outStatisticFieldName=e[t].field,s.statisticType=e[t].toStatisticsName(),f.push(s)}""===u&&(u=t.join(","));let p=this._maxQueryRate();const g=this._layer.capabilities.query.maxRecordCount;void 0!==g&&g<p&&(p=g);let w=null===r?null===i?"1=1":"":d(r,h);return this._layer.definitionExpression&&this._useDefinitionExpression&&(w=""!==w?"(("+this._layer.definitionExpression+") AND ("+w+"))":this._layer.definitionExpression),new a([],["GETPAGES"],c,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(s),relationParam:this._makeRelationshipParam(s),outFields:["*"],useOIDpagination:o,generatedOid:l,resultRecordCount:p,resultOffset:0,groupByFieldsForStatistics:t,outStatistics:f,geometry:null===i?null:i,where:w,orderByFields:u,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}))}_getAgregagtePhysicalPage(e,s,r){try{let s=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(s=""!==s?"("+s+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());const n=e.pagesDefinition.internal.lastRetrieved,l=n,h=e.pagesDefinition.internal.lastPage,u=new X;return this._requestStandardised&&(u.sqlFormat="standard"),u.where=s,u.spatialRelationship=e.pagesDefinition.spatialRel,u.relationParameter=e.pagesDefinition.relationParam,u.outFields=e.pagesDefinition.outFields,u.outStatistics=e.pagesDefinition.outStatistics,u.geometry=e.pagesDefinition.geometry,u.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,u.num=e.pagesDefinition.resultRecordCount,u.start=e.pagesDefinition.internal.lastPage,u.returnGeometry=e.pagesDefinition.returnGeometry,u.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&u.geometry&&u.spatialRelationship?t([]):this.executeQuery(u,"execute").then((t=>{if(this._checkCancelled(r),!t.hasOwnProperty("features"))return i(new Error("Unnexected Result querying aggregates from layer"));const s=[];if(e.pagesDefinition.internal.lastPage!==h)return[];for(let s=0;s<t.features.length;s++)e.pagesDefinition.internal.set[l+s]=t.features[s].attributes[e.pagesDefinition.generatedOid];for(let e=0;e<t.features.length;e++)s.push(new j({attributes:t.features[e].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===t.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=t.features[t.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===t.exceededTransferLimit&&t.features.length!==e.pagesDefinition.resultRecordCount||!1===t.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=n+t.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,s}))}catch(t){return i(t)}}static create(t,e,s,i,r){const n=new W({url:t,outFields:null===e?["*"]:e});return new mt({layer:n,spatialReference:s,lrucache:i,interceptor:r})}relationshipMetaData(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]}serviceUrl(){return x(this._layer.parsedUrl.path)}queryAttachments(e,s,i,r,n){if(this._layer.capabilities.data.supportsAttachment&&this._layer.capabilities.operations.supportsQueryAttachments){const t={objectIds:[e],returnMetadata:n};return(s&&s>0||i&&i>0)&&(t.size=[s&&s>0?s:0,i&&i>0?i:s+1]),r&&r.length>0&&(t.attachmentTypes=r),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:t,method:"attachments"}),this._layer.queryAttachments(t).then((t=>{const s=[];return t&&t[e]&&t[e].forEach((t=>{const i=this._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+t.id.toString();let r=null;n&&t.exifInfo&&(r=C.convertJsonToArcade(t.exifInfo,!0)),s.push(new G(t.id,t.name,t.contentType,t.size,i,r))})),s}))}return t([])}queryRelatedFeatures(t){const e={f:"json",relationshipId:t.relationshipId.toString(),definitionExpression:t.where,outFields:t.outFields.join(","),returnGeometry:t.returnGeometry.toString()};return null!=t.resultOffset&&(e.resultOffset=t.resultOffset.toString()),null!=t.resultRecordCount&&(e.resultRecordCount=t.resultRecordCount.toString()),t.orderByFields&&(e.orderByFields=t.orderByFields.join(",")),t.objectIds.length>0&&(e.objectIds=t.objectIds.join(",")),t.outSpatialReference&&(e.outSR=JSON.stringify(t.outSpatialReference.toJSON())),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:e,method:"relatedrecords",url:this._layer.parsedUrl.path+"/queryRelatedRecords"}),l(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:e}).then((t=>{if(t.data){const e={},s=t.data;if(s&&s.relatedRecordGroups){const t=s.spatialReference;for(const i of s.relatedRecordGroups){const r=i.objectId,n=[];for(const e of i.relatedRecords){e.geometry&&(e.geometry.spatialReference=t);const s=new j({geometry:e.geometry?V(e.geometry):null,attributes:e.attributes});n.push(s)}e[r]={features:n,exceededTransferLimit:!0===s.exceededTransferLimit}}}return e}return i("Invalid Request")}))}getFeatureByObjectId(t,e){const s=new z({url:this._layer.parsedUrl.path}),i=new X;return i.outFields=e,i.returnGeometry=!1,i.outSpatialReference=this.spatialReference,i.where=this.objectIdField+"="+t.toString(),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:i,method:"execute"}),s.execute(i).then((t=>1===t.features.length?t.features[0]:null))}getIdentityUser(){return this.load().then((()=>{var t;const e=null==(t=h)?void 0:t.findCredential(this._layer.url);return e?e.userId:null}))}getOwningSystemUrl(){return this.load().then((()=>{var e;const s=null==(e=h)?void 0:e.findServerInfo(this._layer.url);if(s)return t(s.owningSystemUrl);let i=this._layer.url;const r=i.toLowerCase().indexOf("/rest/services");return i=r>-1?i.substring(0,r):i,i?(i+="/rest/info",n((t=>{l(i,{query:{f:"json"}}).then((e=>{let s="";e.data&&e.data.owningSystemUrl&&(s=e.data.owningSystemUrl),t(s)}),(()=>{t("")}))}))):t("")}))}getDataSourceFeatureSet(){const t=new mt({layer:this._layer,spatialReference:this.spatialReference,outFields:this._overrideFields,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries,interceptor:this.featureSetQueryInterceptor});return t._useDefinitionExpression=!1,t}}class yt extends o{constructor(t){super(t),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",this._removeGeometry=!1,this._overrideFields=null,this._forceIsTable=!1,t.spatialReference&&(this.spatialReference=t.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=t.layer,this._wset=null,!0===t.isTable&&(this._forceIsTable=!0),void 0!==t.outFields&&(this._overrideFields=t.outFields),void 0!==t.includeGeometry&&(this._removeGeometry=!1===t.includeGeometry)}_maxQueryRate(){return P}end(){return this._layer}optimisePagingFeatureQueries(){}load(){return null===this._loadPromise&&(this._loadPromise=n(((t,e)=>{if(!0===this._layer.loaded)return this._initialiseFeatureSet(),void t(this);this._layer.when().then((()=>{try{this._initialiseFeatureSet(),t(this)}catch(t){e(t)}}),e),this._layer.load()}))),this._loadPromise}get gdbVersion(){return""}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{const t=[];for(const e of this.fields)if("oid"===e.type)t.push(e);else for(const s of this._layer.outFields)if(s.toLowerCase()===e.name.toLowerCase()){t.push(e);break}this.fields=t}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],e=[];for(const s of this.fields)if("oid"===s.type)t.push(s),e.push(s.name);else for(const i of this._overrideFields)if(i.toLowerCase()===s.name.toLowerCase()){t.push(s),e.push(s.name);break}this.fields=t,this._overrideFields=e}this.objectIdField=this._layer.objectIdField;for(const t of this.fields)"global-id"===t.type&&(this.globalIdField=t.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=O.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}isTable(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}_isInFeatureSet(){return v.InFeatureSet}_candidateIdTransform(t){return t}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._getFilteredSet("",null,null,null,e))).then((t=>(this._wset=t,t))):t(this._wset)}_changeFeature(t){const e={};for(const s of this.fields)e[s.name]=t.attributes[s.name];return new j({geometry:!0===this._removeGeometry?null:t.geometry,attributes:e})}_getFilteredSet(e,s,i,r,n){let l="",h=!1;if(null!==r&&(l=r.constructClause(),h=!0),this.isTable()&&s&&null!==e&&""!==e){const e=new a([],[],!0,null);return t(e)}const u=new X;return u.where=null===i?null===s?"1=1":"":d(i,O.Standardised),u.spatialRelationship=this._makeRelationshipEnum(e),u.outSpatialReference=this.spatialReference,u.orderByFields=""!==l?l.split(","):null,u.geometry=null===s?null:s,u.returnGeometry=!0,u.relationParameter=this._makeRelationshipParam(e),this._layer.queryFeatures(u).then((t=>{if(null===t)return new a([],[],h,null);this._checkCancelled(n);const e=[];return t.features.forEach((t=>{const s=t.attributes[this._layer.objectIdField];e.push(s),this._featureCache[s]=this._changeFeature(t)})),new a([],e,h,null)}))}_makeRelationshipEnum(t){if(t.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(t){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return t}_makeRelationshipParam(t){return t.indexOf("esriSpatialRelRelation")>=0?t.split(":")[1]:""}_queryAllFeatures(){if(this._wset)return t(this._wset);const e=new X;return e.where="1=1",this._ensureLoaded().then((()=>{if(this._layer.source&&this._layer.source.items){const t=[];return this._layer.source.items.forEach((e=>{const s=e.attributes[this._layer.objectIdField];t.push(s),this._featureCache[s]=this._changeFeature(e)})),this._wset=new a([],t,!1,null),this._wset}return this._layer.queryFeatures(e).then((t=>{const e=[];return t.features.forEach((t=>{const s=t.attributes[this._layer.objectIdField];e.push(s),this._featureCache[s]=this._changeFeature(t)})),this._wset=new a([],e,!1,null),this._wset}))}))}_getFeatures(e,s,r){const n=[];-1!==s&&void 0===this._featureCache[s]&&n.push(s);for(let t=e._lastFetchedIndex;t<e._known.length&&(e._lastFetchedIndex+=1,!(void 0===this._featureCache[e._known[t]]&&(e._known[t]!==s&&n.push(e._known[t]),n.length>r)));t++);return 0===n.length?t("success"):i(new Error("Unaccounted for Features. Not in Feature Collection"))}_refineSetBlock(e){return t(e)}_stat(){return t({calculated:!1})}_canDoAggregates(){return t(!1)}relationshipMetaData(){return[]}static _cloneAttr(t){const e={};for(const s in t)e[s]=t[s];return e}nativeCapabilities(){return{title:this._layer.title,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(t,e){let s=t.layerDefinition.objectIdField;const i=t.layerDefinition.typeIdField?t.layerDefinition.typeIdField:"",r=[];if(t.layerDefinition.types)for(const e of t.layerDefinition.types)r.push(Z.fromJSON(e));let n=t.layerDefinition.geometryType;void 0===n&&(n=t.featureSet.geometryType||"");let l=t.featureSet.features;const h=e.toJSON();if(""===s||void 0===s){let e=!1;for(const i of t.layerDefinition.fields)if("oid"===i.type||"esriFieldTypeOID"===i.type){s=i.name,e=!0;break}if(!1===e){let e="FID",i=!0,r=0;for(;i;){let s=!0;for(const i of t.layerDefinition.fields)if(i.name===e){s=!1;break}!0===s?i=!1:(r++,e="FID"+r.toString())}t.layerDefinition.fields.push({type:"esriFieldTypeOID",name:e,alias:e});const n=[];for(let s=0;s<l.length;s++)n.push({geometry:t.featureSet.features[s].geometry,attributes:t.featureSet.features[s].attributes?this._cloneAttr(t.featureSet.features[s].attributes):{}}),n[s].attributes[e]=s;l=n,s=e}}const o=[];for(const e of t.layerDefinition.fields)o.push(e instanceof L?e:L.fromJSON(e));let a=n;switch(a){case"esriGeometryPoint":a="point";break;case"esriGeometryPolyline":a="polyline";break;case"esriGeometryPolygon":a="polygon";break;case"esriGeometryExtent":a="extent";break;case"esriGeometryMultipoint":a="multipoint"}for(const t of l)t.geometry&&t.geometry instanceof u==0&&(t.geometry.type=a,void 0===t.geometry.spatialReference&&(t.geometry.spatialReference=h));const c={outFields:["*"],source:l,fields:o,types:r,typeIdField:i,objectIdField:s,spatialReference:e};c.geometryType=a||"point";const f=new W(c);return new yt({layer:f,spatialReference:e,isTable:null===a||""===a})}queryAttachments(){return t([])}getFeatureByObjectId(t){const e=new X;return e.where=this.objectIdField+"="+t.toString(),this._layer.queryFeatures(e).then((t=>1===t.features.length?t.features[0]:null))}getOwningSystemUrl(){return t("")}getIdentityUser(){return t("")}}class St extends o{constructor(t){super(t),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",this._findObjectId=-1,this._requestStandardised=!1,this._removeGeometry=!1,this._overrideFields=null,this.featureObjectId=null,this.relatedLayer=null,this.relationship=null,t.spatialReference&&(this.spatialReference=t.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=t.layer,this._wset=null,this._findObjectId=t.objectId,this.featureObjectId=t.objectId,this.relationship=t.relationship,this.relatedLayer=t.relatedLayer,void 0!==t.outFields&&(this._overrideFields=t.outFields),void 0!==t.includeGeometry&&(this._removeGeometry=!1===t.includeGeometry)}_maxQueryRate(){return P}end(){return this._layer}optimisePagingFeatureQueries(){}load(){return null===this._loadPromise&&(this._loadPromise=n(((t,e)=>{r([this._layer.load(),this.relatedLayer.load()]).then((()=>{this._initialiseFeatureSet(),t(this)}),e)}))),this._loadPromise}nativeCapabilities(){return this.relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this.relatedLayer.geometryType,this.fields=this.relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],e=[];for(const s of this.fields)if("oid"===s.type)t.push(s),e.push(s.name);else for(const i of this._overrideFields)if(i.toLowerCase()===s.name.toLowerCase()){t.push(s),e.push(s.name);break}this.fields=t,this._overrideFields=e}const t=this._layer.nativeCapabilities();t&&(this._databaseType=t.databaseType,this._requestStandardised=t.requestStandardised),this.objectIdField=this.relatedLayer.objectIdField,this.globalIdField=this.relatedLayer.globalIdField,this.hasM=this.relatedLayer.supportsM,this.hasZ=this.relatedLayer.supportsZ,this.typeIdField=this.relatedLayer.typeIdField,this.types=this.relatedLayer.types}databaseType(){return this.relatedLayer.databaseType().then((()=>(this._databaseType=this.relatedLayer._databaseType,this._databaseType)))}isTable(){return this.relatedLayer.isTable()}_isInFeatureSet(){return v.InFeatureSet}_candidateIdTransform(t){return t}_getSet(e){return null===this._wset?this._ensureLoaded().then((()=>this._getFilteredSet("",null,null,null,e))).then((t=>(this._wset=t,t))):t(this._wset)}_changeFeature(t){const e={};for(const s of this.fields)e[s.name]=t.attributes[s.name];return new j({geometry:!0===this._removeGeometry?null:t.geometry,attributes:e})}_getFilteredSet(t,e,s,i,r){return this.databaseType().then((()=>{if(this.isTable()&&e&&null!==t&&""!==t)return new a([],[],!0,null);const n=this._layer.nativeCapabilities();if(!1===n.canQueryRelated)return new a([],[],!0,null);if(n.capabilities.queryRelated&&n.capabilities.queryRelated.supportsPagination)return this._getFilteredSetUsingPaging(t,e,s,i,r);let l="",h=!1;null!==i&&n.capabilities&&n.capabilities.queryRelated&&!0===n.capabilities.queryRelated.supportsOrderBy&&(l=i.constructClause(),h=!0);const u=new $;u.objectIds=[this._findObjectId];const o=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this.relatedLayer.fields?this.relatedLayer.fields.map((t=>t.name)):["*"]);u.outFields=o,u.relationshipId=this.relationship.id,u.where="1=1";let c=!0;return!0===this._removeGeometry&&(c=!1),u.returnGeometry=c,this._requestStandardised&&(u.sqlFormat="standard"),u.outSpatialReference=this.spatialReference,u.orderByFields=""!==l?l.split(","):null,n.source.queryRelatedFeatures(u).then((i=>{this._checkCancelled(r);const n=i[this._findObjectId]?i[this._findObjectId].features:[],l=[];for(let t=0;t<n.length;t++)this._featureCache[n[t].attributes[this._layer.objectIdField]]=n[t],l.push(n[t].attributes[this._layer.objectIdField]);const u=e&&null!==t&&""!==t,o=null!=s;return new a(u||o?l:[],u||o?[]:l,h,null)}))}))}_fieldsIncludingObjectId(t){if(null===t)return[this.objectIdField];const e=t.slice(0);if(e.indexOf("*")>-1)return e;let s=!1;for(const t of e)if(t.toUpperCase()===this.objectIdField.toUpperCase()){s=!0;break}return!1===s&&e.push(this.objectIdField),e}_getFilteredSetUsingPaging(t,e,s,r,n){try{let i="",l=!1;const h=this._layer.nativeCapabilities();return null!==r&&h&&h.capabilities.queryRelated&&!0===h.capabilities.queryRelated.supportsOrderBy&&(i=r.constructClause(),l=!0),this.databaseType().then((()=>{let r=this._maxQueryRate();const u=h.capabilities.query.maxRecordCount;void 0!==u&&u<r&&(r=u);const o=e&&null!==t&&""!==t,c=null!=s;let f=null,d=!0;!0===this._removeGeometry&&(d=!1);const p=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this.relatedLayer.fields?this.relatedLayer.fields.map((t=>t.name)):["*"]);return f=new a(o||c?["GETPAGES"]:[],o||c?[]:["GETPAGES"],l,{outFields:p.join(","),resultRecordCount:r,resultOffset:0,objectIds:[this._findObjectId],where:"1=1",orderByFields:i,returnGeometry:d,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),this._expandPagedSet(f,r,0,0,n).then((()=>f))}))}catch(t){return i(t)}}_expandPagedSet(t,e,s,i,r){return this._expandPagedSetFeatureSet(t,e,s,i,r)}_clonePageDefinition(t){return null===t?null:!0!==t.groupbypage?{groupbypage:!1,outFields:t.outFields,resultRecordCount:t.resultRecordCount,resultOffset:t.resultOffset,where:t.where,objectIds:t.objectIds,orderByFields:t.orderByFields,returnGeometry:t.returnGeometry,returnIdsOnly:t.returnIdsOnly,internal:t.internal}:{groupbypage:!0,outFields:t.outFields,resultRecordCount:t.resultRecordCount,useOIDpagination:t.useOIDpagination,generatedOid:t.generatedOid,groupByFieldsForStatistics:t.groupByFieldsForStatistics,resultOffset:t.resultOffset,outStatistics:t.outStatistics,geometry:t.geometry,where:t.where,objectIds:t.objectIds,orderByFields:t.orderByFields,returnGeometry:t.returnGeometry,returnIdsOnly:t.returnIdsOnly,internal:t.internal}}_getPhysicalPage(t,e,s){try{const e=t.pagesDefinition.internal.lastRetrieved,i=e,r=t.pagesDefinition.internal.lastPage,n=this._layer.nativeCapabilities(),l=new $;return!0===this._requestStandardised&&(l.sqlFormat="standard"),l.relationshipId=this.relationship.id,l.objectIds=t.pagesDefinition.objectIds,l.resultOffset=t.pagesDefinition.internal.lastPage,l.resultRecordCount=t.pagesDefinition.resultRecordCount,l.outFields=t.pagesDefinition.outFields.split(","),l.where=t.pagesDefinition.where,l.orderByFields=""!==t.pagesDefinition.orderByFields?t.pagesDefinition.orderByFields.split(","):null,l.returnGeometry=t.pagesDefinition.returnGeometry,l.outSpatialReference=this.spatialReference,n.source.queryRelatedFeatures(l).then((n=>{if(this._checkCancelled(s),t.pagesDefinition.internal.lastPage!==r)return 0;const l=n[this._findObjectId]?n[this._findObjectId].features:[];for(let e=0;e<l.length;e++)t.pagesDefinition.internal.set[i+e]=l[e].attributes[this._layer.objectIdField];for(let t=0;t<l.length;t++)this._featureCache[l[t].attributes[this._layer.objectIdField]]=l[t];return l.length!==t.pagesDefinition.resultRecordCount&&(!n[this._findObjectId]||!1===n[this._findObjectId].exceededTransferLimit)&&(t.pagesDefinition.internal.fullyResolved=!0),t.pagesDefinition.internal.lastRetrieved=e+l.length,t.pagesDefinition.internal.lastPage+=t.pagesDefinition.resultRecordCount,l.length}))}catch(t){return i(t)}}_getFeatures(e,s,r,n){const l=[];-1!==s&&void 0===this._featureCache[s]&&l.push(s);const h=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,h))return this._expandPagedSet(e,h,0,0,n).then((()=>this._getFeatures(e,s,r,n)));let u=0;for(let t=e._lastFetchedIndex;t<e._known.length&&(u++,u<=r&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[t]&&void 0===this._featureCache[e._known[t]]&&(e._known[t]!==s&&l.push(e._known[t]),l.length>r)))&&!(u>=r&&0===l.length);t++);return 0===l.length?t("success"):i(new Error("Unaccounted for Features. Not in Feature Collection"))}_refineSetBlock(e,s,i){return t(e)}_stat(e,s,i,r,n,l,h){return t({calculated:!1})}get gdbVersion(){return this.relatedLayer.gdbVersion}_canDoAggregates(e,s,i,r,n){return t(!1)}relationshipMetaData(){return this.relatedLayer.relationshipMetaData()}serviceUrl(){return this.relatedLayer.serviceUrl()}queryAttachments(t,e,s,i,r){return this.relatedLayer.queryAttachments(t,e,s,i,r)}getFeatureByObjectId(t,e){return this.relatedLayer.getFeatureByObjectId(t,e)}getOwningSystemUrl(){return this.relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this.relatedLayer.getIdentityUser()}getDataSourceFeatureSet(){return this.relatedLayer}}function Ft(e,s){if(A.applicationCache){const i=A.applicationCache.getLayerInfo(e);if(i)return i.then((i=>t(new W({url:e,outFields:s,sourceJSON:i}))));const r=new W({url:e,outFields:s});let l=n(((t,e)=>{r.load().then((()=>{t(r.sourceJSON)}),(t=>{e(t)}))}));return A.applicationCache&&(A.applicationCache.setLayerInfo(e,l),l=l.catch((t=>{throw A.applicationCache.clearLayerInfo(e),t}))),l.then((()=>t(r)))}return t(new W({url:e,outFields:s}))}function _t(e,s,i,r,n,l=null){return Ft(e,["*"]).then((e=>t(Et(e,s,i,r,n,l))))}function Et(t,e=null,s=null,i=!0,r=null,n=null){return!0===t._hasMemorySource()?new yt({layer:t,spatialReference:e,outFields:s,includeGeometry:i,lrucache:r,interceptor:n}):new mt({layer:t,spatialReference:e,outFields:s,includeGeometry:i,lrucache:r,interceptor:n})}function bt(e){if(null!==A.applicationCache){const t=A.applicationCache.getLayerInfo(e);if(null!==t)return t}let s=l(e,{responseType:"json",query:{f:"json"}}).then((e=>{if(e.data){const s=e.data;return s.layers||(s.layers=[]),s.tables||(s.tables=[]),t(s)}return t({layers:[],tables:[]})}));return null!==A.applicationCache&&(A.applicationCache.setLayerInfo(e,s),s=s.catch((t=>{throw A.applicationCache.clearLayerInfo(e),t}))),s}function It(e,s){const i={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return bt(e).then((r=>{if(i.metadata=r,r.controllerDatasetLayers&&null!=r.controllerDatasetLayers.utilityNetworkLayerId){if(r.layers)for(const t of r.layers)i.layerNameLkp[t.id]=t.name;if(r.tables)for(const t of r.tables)i.layerNameLkp[t.id]=t.name;const n=r.controllerDatasetLayers.utilityNetworkLayerId;return i.networkId=n,function(t,e){const s="QUERYDATAELEMTS:"+e.toString()+":"+t;if(null!==A.applicationCache){const t=A.applicationCache.getLayerInfo(s);if(null!==t)return t}let i=l(t+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([e.toString()]),f:"json"}}).then((t=>{if(t.data){const e=t.data;if(e.layerDataElements&&e.layerDataElements[0])return e.layerDataElements[0]}throw new Error("Not Found")}));return null!==A.applicationCache&&(A.applicationCache.setLayerInfo(s,i),i=i.catch((t=>{throw A.applicationCache.clearLayerInfo(s),t}))),i}(e,n).then((r=>{if(r){i.queryelem=r,i.queryelem&&i.queryelem.dataElement&&void 0!==i.queryelem.dataElement.schemaGeneration&&(i.unVersion=i.queryelem.dataElement.schemaGeneration),i.lkp={},i.queryelem.dataElement.domainNetworks||(i.queryelem.dataElement.domainNetworks=[]);for(const t of i.queryelem.dataElement.domainNetworks){for(const e of t.edgeSources?t.edgeSources:[]){const t={layerId:e.layerId,sourceId:e.sourceId,className:i.layerNameLkp[e.layerId]?i.layerNameLkp[e.layerId]:null};t.className&&(i.lkp[t.className]=t)}for(const e of t.junctionSources?t.junctionSources:[]){const t={layerId:e.layerId,sourceId:e.sourceId,className:i.layerNameLkp[e.layerId]?i.layerNameLkp[e.layerId]:null};t.className&&(i.lkp[t.className]=t)}}if(i.queryelem.dataElement.terminalConfigurations)for(const t of i.queryelem.dataElement.terminalConfigurations)for(const e of t.terminals)i.terminals.push({terminalId:e.terminalId,terminalName:e.terminalName});return function(e){if(null!==A.applicationCache){const t=A.applicationCache.getLayerInfo(e);if(null!==t)return t}let s=l(e,{responseType:"json",query:{f:"json"}}).then((e=>t(e.data?e.data:null)));return null!==A.applicationCache&&(A.applicationCache.setLayerInfo(e,s),s=s.catch((t=>{throw A.applicationCache.clearLayerInfo(e),t}))),s}(e+"/"+n).then((t=>{if(t.systemLayers&&null!=t.systemLayers.associationsTableId){const r=[];return i.unVersion>=4&&(r.push("STATUS"),r.push("PERCENTALONG")),_t(e+"/"+t.systemLayers.associationsTableId.toString(),s,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...r],!1,null,null).then((t=>t.load())).then((t=>i.unVersion>=4?(t=t.filter(U.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",t.getFieldsIndex()))).load():t)).then((t=>({lkp:i.lkp,associations:t,unVersion:i.unVersion,terminals:i.terminals})))}return{associations:null,unVersion:i.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:i.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:i.unVersion,lkp:null,terminals:[]}}))}function At(t,e,s,i=null,r=null,n=!0,l=null,h=null){let u=t.serviceUrl();return u?(u="/"===u.charAt(u.length-1)?u+e.relatedTableId.toString():u+"/"+e.relatedTableId.toString(),_t(u,i,r,n,l,h).then((u=>new St({layer:t,relatedLayer:u,relationship:e,objectId:s,spatialReference:i,outFields:r,includeGeometry:n,lrucache:l,interceptor:h})))):null}it.registerAction(),gt.registerAction(),ft.registerAction(),I.registerAction(),wt.registerAction();class Rt extends st{constructor(t,e=null,s=null,i=null){super(),this._map=t,this._overridespref=e,this.lrucache=s,this.interceptor=i,this._instantLayers=[]}makeAndAddFeatureSet(t,e=!0,s=null){const i=Et(t,this._overridespref,null===s?["*"]:s,e,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:i,opitem:t,includeGeometry:e,outFields:JSON.stringify(s)}),i}featureSetByName(t,e=!0,s=null){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((()=>{try{return this.featureSetByName(t,e,s)}catch(t){return i(t)}}));null===s&&(s=["*"]),s=(s=s.slice(0)).sort();const r=JSON.stringify(s);for(let s=0;s<this._instantLayers.length;s++){const i=this._instantLayers[s];if(i.opitem.title===t&&i.includeGeometry===e&&i.outFields===r)return this.resolvePromise(this._instantLayers[s].featureset)}const n=this._map.layers.find((e=>e instanceof W&&e.title===t));if(n)return this.resolvePromise(this.makeAndAddFeatureSet(n,e,s));if(this._map.tables){const i=this._map.tables.find((e=>!!(e.title&&e.title===t||e.title&&e.title===t)));if(i){if(i instanceof W)return this.resolvePromise(this.makeAndAddFeatureSet(i,e,s));if(i._materializedTable);else{const t=i.outFields?i:{...i,outFields:["*"]};i._materializedTable=new W(t)}return i._materializedTable.load().then((()=>this.resolvePromise(this.makeAndAddFeatureSet(i._materializedTable,e,s))))}}return this.resolvePromise(null)}featureSetById(t,e=!0,s=["*"]){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((()=>{try{return this.featureSetById(t,e,s)}catch(t){return i(t)}}));null===s&&(s=["*"]),s=(s=s.slice(0)).sort();const r=JSON.stringify(s);for(let s=0;s<this._instantLayers.length;s++){const i=this._instantLayers[s];if(i.opitem.id===t&&i.includeGeometry===e&&i.outFields===r)return this.resolvePromise(this._instantLayers[s].featureset)}const n=this._map.layers.find((e=>e instanceof W&&e.id===t));if(n)return this.resolvePromise(this.makeAndAddFeatureSet(n,e,s));if(this._map.tables){const i=this._map.tables.find((e=>e.id===t));if(i){if(i instanceof W)return this.resolvePromise(this.makeAndAddFeatureSet(i,e,s));if(i._materializedTable);else{const t={...i,outFields:["*"]};i._materializedTable=new W(t)}return i._materializedTable.load().then((()=>this.resolvePromise(this.makeAndAddFeatureSet(i._materializedTable,e,s))))}}return this.resolvePromise(null)}}class vt extends st{constructor(t,e=null,s=null,i=null){super(),this._url=t,this._overridespref=e,this.lrucache=s,this.interceptor=i,this.metadata=null,this._instantLayers=[]}get url(){return this._url}makeAndAddFeatureSet(t,e=!0,s=null){const i=Et(t,this._overridespref,null===s?["*"]:s,e,this.lrucache);return this._instantLayers.push({featureset:i,opitem:t,includeGeometry:e,outFields:JSON.stringify(s)}),i}_loadMetaData(){return bt(this._url).then((t=>(this.metadata=t,t)))}load(){return this._loadMetaData()}clone(){return new vt(this._url,this._overridespref,this.lrucache,this.interceptor)}featureSetByName(t,e=!0,s=null){null===s&&(s=["*"]),s=(s=s.slice(0)).sort();const i=JSON.stringify(s);for(let s=0;s<this._instantLayers.length;s++){const r=this._instantLayers[s];if(r.opitem.title===t&&r.includeGeometry===e&&r.outFields===i)return this.resolvePromise(this._instantLayers[s].featureset)}return this._loadMetaData().then((i=>{let r=null;for(const e of i.layers?i.layers:[])e.name===t&&(r=e);if(!r)for(const e of i.tables?i.tables:[])e.name===t&&(r=e);return r?Ft(this._url+"/"+r.id,["*"]).then((t=>this.makeAndAddFeatureSet(t,e,s))):this.resolvePromise(null)}))}featureSetById(t,e=!0,s=["*"]){null===s&&(s=["*"]),s=(s=s.slice(0)).sort();const i=JSON.stringify(s);t=null!=t?t.toString():"";for(let s=0;s<this._instantLayers.length;s++){const r=this._instantLayers[s];if(r.opitem.id===t&&r.includeGeometry===e&&r.outFields===i)return this.resolvePromise(this._instantLayers[s].featureset)}return this._loadMetaData().then((i=>{let r=null;for(const e of i.layers?i.layers:[])null!=e.id&&e.id.toString()===t&&(r=e);if(!r)for(const e of i.tables?i.tables:[])null!=e.id&&e.id.toString()===t&&(r=e);return r?Ft(this._url+"/"+r.id,["*"]).then((t=>this.makeAndAddFeatureSet(t,e,s))):this.resolvePromise(null)}))}}function Tt(t,e){return null===t?e:new tt({url:t.field("url")})}function Ot(e,s,i){return h.findCredential(e.restUrl)?"loaded"===e.loadStatus&&""===s&&e.user&&e.user.sourceJSON&&!1===i?t(e.user.sourceJSON):""===s?l(e.restUrl+"/community/self",{responseType:"json",query:{f:"json",...!1===i?{}:{returnUserLicenseTypeExtensions:!0}}}).then((e=>{if(e.data){const s=e.data;if(s&&s.username)return t(s)}return t(null)})):l(e.restUrl+"/community/users/"+s,{responseType:"json",query:{f:"json"}}).then((e=>{if(e.data){const s=e.data;return s.error?null:t(s)}return t(null)})):t(null)}function Nt(t,e,s,i,r){if(null===t)return null;if(t instanceof W){switch(e){case"datasource":return Et(t,r,t.outFields,!0,s,i).getDataSourceFeatureSet();case"parent":case"root":return Et(t,r,t.outFields,!0,s,i)}return null}if(t instanceof o)switch(e){case"datasource":return t.getDataSourceFeatureSet();case"parent":return t;case"root":return t.getRootFeatureSet()}return null}function Dt(e,s,r,l,h,u,o,a=null){if(A.applicationCache){const n=A.applicationCache.getLayerInfo(e+":"+u.url);if(n)return n.then((e=>{try{const i=new W({url:x(e.url)+"/"+s,outFields:["*"]});return t(Et(i,r,l,h,o,a))}catch(t){return i(t)}}),(t=>i(t)))}return n(((t,i)=>{const n=new et({id:e,portal:u}).load();A.applicationCache&&A.applicationCache.setLayerInfo(e+":"+u.url,n),n.then((e=>{try{const i=new W({url:x(e.url)+"/"+s,outFields:["*"]});t(Et(i,r,l,h,o,a))}catch(t){i(t)}}),(t=>{A.applicationCache&&A.applicationCache.clearLayerInfo(e+":"+u.url),i(t)}))}))}const Pt=Object.freeze({__proto__:null,constructAssociationMetaDataFeatureSetFromUrl:It,constructFeatureSet:Et,constructFeatureSetFromPortalItem:Dt,constructFeatureSetFromRelationship:At,constructFeatureSetFromUrl:_t,convertToFeatureSet:Nt,createFeatureSetCollectionFromMap:function(t,e,s=null,i=null){return new Rt(t,e,s,i)},createFeatureSetCollectionFromService:function(t,e,s=null,i=null){return new vt(t,e,s,i)},getPortal:Tt,initialiseMetaDataCache:function(){null===A.applicationCache&&(A.applicationCache=new A)},lookupUser:Ot});export{ht as C,Tt as D,ot as E,Dt as G,Nt as P,_t as T,it as _,ft as a,wt as b,ut as c,nt as d,ct as e,Pt as f,Et as g,It as j,Ot as q,st as r,lt as v,At as w,yt as y}