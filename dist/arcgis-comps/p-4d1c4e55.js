import{A as t,e as i,d as s,i as e,cp as n,cg as r,af as o,ct as h,V as a,c as l,aW as u,T as c,S as d,b as f,bm as p,h as m,dN as g,c$ as b,cT as y}from"./p-e58503d5.js";import{a as v,n as S}from"./p-e654504b.js";import{u as _}from"./p-fb38a9d0.js";import{Y as w}from"./p-01e5a461.js";import{z as x,c as P,d as M,v as z,h as C,o as j,s as A,i as O}from"./p-2f398ed1.js";import{n as N,r as I}from"./p-c2152437.js";import{d as F}from"./p-c93d2280.js";import{b as R,j as $,a as D,C as E,V,E as W,k,A as G}from"./p-f94762ac.js";import{b as H,u as L}from"./p-ea916a39.js";import{p as B,k as T}from"./p-dcdb33cf.js";import{v as U}from"./p-3bcc4805.js";import{u as q,c as Q}from"./p-a131049b.js";import{I as J}from"./p-765e6c28.js";import{i as K,f as X}from"./p-ca295674.js";import{r as Y}from"./p-a6c8fb32.js";import{p as Z,x as tt}from"./p-cbbdb7db.js";import{n as it}from"./p-e9596294.js";import{C as st,q as et,R as nt}from"./p-85e8677e.js";import{G as rt,K as ot,J as ht,D as at,L as lt,N as ut,P as ct,t as dt}from"./p-7de54cd0.js";import{a as ft,c as pt,d as mt}from"./p-5cd91fe7.js";import{h as gt}from"./p-54330161.js";import{r as bt,c as yt,e as vt}from"./p-ccdb8e80.js";import{c as St}from"./p-a24f7752.js";import{a as _t}from"./p-2c84c65f.js";import{n as wt}from"./p-d3105731.js";import{p as xt}from"./p-95909347.js";import{r as Pt,j as Mt}from"./p-728dcbb0.js";import{n as zt,w as Ct,t as jt,j as At,y as Ot,e as Nt,b as It,c as Ft,d as Rt,o as $t,P as Dt,R as Et,f as Vt,N as Wt,C as kt}from"./p-eb48bb01.js";import{g as Gt,l as Ht,r as Lt}from"./p-bdf9e611.js";import{f as Bt,h as Tt}from"./p-19bc1e3d.js";import{c as Ut}from"./p-20f761a5.js";import{u as qt}from"./p-a63f7978.js";import{o as Qt,c as Jt}from"./p-ca657fcf.js";class Kt extends it{constructor(t){super("PointCloudWorker","transform",t)}getTransferList(i){const s=[i.geometryBuffer];if(t(i.primaryAttributeData)&&i.primaryAttributeData.buffer&&s.push(i.primaryAttributeData.buffer),t(i.modulationAttributeData)&&i.modulationAttributeData.buffer&&s.push(i.modulationAttributeData.buffer),t(i.filterAttributesData))for(const e of i.filterAttributesData)t(e)&&e.buffer&&s.push(e.buffer);for(const t of i.userAttributesData)t.buffer&&s.push(t.buffer);return s}}const Xt=[!1],Yt=[null],Zt=[!1],ti=[null];function ii(t,i,s){let e=t;for(;e>0;){const t=i.indexOf(e);if(t>=0)return t;e=s.getParentId(e)}return i.indexOf(e)}function si(t,i,s){const e=[i.remove[0]],n=[];for(;1===e.length;){const t=e.pop();n.length=0;for(let r=0;r<i.load.length;r++){let o=i.load[r],h=s.getParentId(o);for(;h!==t;)o=h,h=s.getParentId(o);let a=e.indexOf(o);a<0&&(a=e.length,e.push(o),n.push([])),n[a].push(i.load[r])}}i.load=e;for(let i=0;i<e.length;i++)n[i].length>1?t.push({remove:[e[i]],load:n[i]}):e[i]=n[i][0]}class ei{constructor(t,i,s){this._pages=[],this.pageSize=0,this._nodeSR=null,this._renderSR=null,this._nodeSR=t,this._renderSR=i,this.pageSize=s}addPage(t,i,s=0){for(;this._pages.length<t;)this._pages.push(null);const e=function(t,i,s,e){const n=new at(t.length);for(let r=0;r<t.length;r++)st(t[r].obb,i,n.obbs[r],s,e);return n.obbs}(i,this._nodeSR,this._renderSR,s);this._pages[t]={nodes:i,renderObbs:e,parents:new Uint32Array(this.pageSize)},function(t,i){const s=[0];for(;s.length;){const e=s.pop(),n=t[ni(e,i)].nodes[ri(e,i)];for(let r=0;r<n.childCount;r++){const o=n.firstChild+r;null!=t[ni(o,i)]&&(t[ni(o,i)].parents[ri(o,i)]=e,s.push(o))}}}(this._pages,this.pageSize)}hasPage(t){return!!this._pages[t]}getNode(t){const i=this.pageSize;return this._pages[ni(t,i)].nodes[ri(t,i)]}getRenderObb(t){const i=this.pageSize;return this._pages[ni(t,i)].renderObbs[ri(t,i)]}getRenderCenter(t){return this.getRenderObb(t).center}setRenderObb(t,i){const s=this.pageSize;rt(i,this._pages[ni(t,s)].renderObbs[ri(t,s)])}getParentId(t){const i=this.pageSize;return this._pages[ni(t,i)].parents[ri(t,i)]}hasNodes(t,i){const s=ni(t,this.pageSize),e=ni(t+i-1,this.pageSize);for(let t=s;t<=e;t++)if(null==this._pages[t])return!1;return!0}forEachNodeId(t){for(let i=0;i<this._pages.length;i++){const s=this._pages[i];if(s)for(let e=0;e<s.nodes.length;e++)t(i*this.pageSize+e)}}createVisibilityTraverse(){const t={index:this,queue:[],masks:[],tempAabb:D()};return(i,s)=>function(t,i,s){const e=t.index;if(!e.hasNodes(0,1))return;const n=t.queue;n.length=0,n.push(0);const r=t.masks;for(r.length=0,r.push(0);n.length>0;){const o=n.pop();let h=r.pop();const a=e.getNode(o),l=e.getRenderObb(o);let u=!0;if(null!=i.clippingBox){const s=1<<i.frustum.length;if(0==(h&s)){const e=ot(l,t.tempAabb);R(i.clippingBox,e)?h|=s:$(i.clippingBox,e)||(u=!1)}}for(let t=0;t<i.frustum.length&&u;t++){const s=1<<t;if(0==(h&s)){const e=ht(l,i.frustum[t]);e>0?u=!1:e<0&&(h|=s)}}if(s.predicate(o,a,u)){const t=a.firstChild,i=a.childCount;let l=!1;const u=ni(t,e.pageSize),c=ni(t+i-1,e.pageSize);for(let t=u;t<=c;t++)if(!e.hasPage(t)){s.pageMiss(o,t),l=!0;break}if(!l)for(let s=0;s<i;s++)n.push(t+s),r.push(h)}}}(t,i,s)}}function ni(t,i){return t/i|0}function ri(t,i){return t%i}function oi(t){const i=t.renderer,s=i&&i.type,e=i&&t.renderer.toJSON()||null;let n=null,r=!1;"point-cloud-unique-value"===s||"point-cloud-stretch"===s||"point-cloud-class-breaks"===s?n=ui(t.attributeStorageInfo,i.field):"point-cloud-rgb"===s?(n=li(t.attributeStorageInfo,i.field),r=null!=n):(n=li(t.attributeStorageInfo,"RGB"),r=null!=n);let o=null;return i&&i.colorModulation&&(o=ui(t.attributeStorageInfo,i.colorModulation.field)),{rendererJSON:e,isRGBRenderer:r,primaryAttribute:n,modulationAttribute:o}}function hi(t){const i=t.filters;return i?i.map((i=>({filterJSON:i.toJSON(),attributeInfo:ui(t.attributeStorageInfo,i.field)}))):[]}function ai(t){const i=t&&t.pointSizeAlgorithm;return i&&"fixed-size"===i.type?i:null}function li(t,i){for(const s of t)if(s.name===i&&null!=s.attributeValues&&"UInt8"===s.attributeValues.valueType&&3===s.attributeValues.valuesPerElement)return{name:i,storageInfo:s,useElevation:!1};return null}function ui(t,i){for(const s of t)if(s.name===i){const t="embedded-elevation"===s.encoding;return{name:i,storageInfo:t?null:s,useElevation:t}}return"elevation"===i.toLowerCase()?{name:i,storageInfo:null,useElevation:!0}:null}var ci;let di=ci=class extends gt{constructor(t){super(t)}clone(){return new ci(this.cloneProperties())}cloneProperties(){const{pointCloudMetadata:t}=this;return{...super.cloneProperties(),pointCloudMetadata:t}}};i([s({constructOnly:!0})],di.prototype,"pointCloudMetadata",void 0),di=ci=i([e("esri.views.3d.layers.i3s.PointGraphic")],di);class fi{constructor(t){this.context=t,this.highlights=new Set}get hasHighlights(){return this.highlights.size>0}destroy(){this.highlights=null}add(t){const i=new pi(t);return this.highlights.add(i),this.enableSet(i),n((()=>this.removeSet(i)))}removeSet(t){this.disableSet(t),this.highlights.delete(t)}enableSet(t){t.enabled||(t.enabled=!0,this.context.forEachNode((i=>this.enableSetForNode(t,i))))}enableSetForNode(t,i){if(!t.enabled)return;const s=t.ids.get(i.id);s&&s.forEach((s=>this.context.addHighlight(i,s,t.id)))}disableSet(t){t.enabled&&(t.enabled=!1,this.context.forEachNode((i=>this.disableSetForNode(t,i))))}disableSetForNode(t,i){t.enabled||this.context.removeHighlight(i,t.id)}nodeAdded(t){this.highlights.forEach((i=>this.enableSetForNode(i,t)))}nodeRemoved(t){this.highlights.forEach((i=>this.disableSetForNode(i,t)))}removeAll(){this.highlights.forEach((t=>this.disableSet(t)))}}class pi{constructor(i){this.id=new Pt(0),this.ids=new Map,this.enabled=!1;for(const s of i)t(s)&&this.add(s.nodeId,s.pointId)}add(t,i){const s=this.ids.get(t);s?s.add(i):this.ids.set(t,new Set([i]))}}function mi(t){const i=new zt,s=0===t.output,e=1===t.output,n=4===t.output;return i.extensions.add("GL_OES_standard_derivatives"),i.include(Ct,t),i.attributes.add("position","vec3"),i.attributes.add("color","vec3"),i.vertex.uniforms.add("uModelViewMatrix","mat4").add("uProjectionMatrix","mat4").add("uScreenMinMaxSize","vec2").add("uPointScale","vec2").add("uClipMin","vec3").add("uClipMax","vec3"),e?(i.vertex.uniforms.add("nearFar","vec2"),i.varyings.add("depth","float")):4!==t.output&&i.varyings.add("vColor","vec3"),i.vertex.code.add(jt`
    void main(void) {
      // Move clipped points outside of clipspace
      if (position.x < uClipMin.x || position.y < uClipMin.y || position.z < uClipMin.z ||
        position.x > uClipMax.x || position.y > uClipMax.y || position.z > uClipMax.z) {
        gl_Position = vec4(0.0,0.0,0.0,2.0);
        gl_PointSize = 0.0;
        return;
      }

      if (rejectBySlice(position)) {
        gl_Position = vec4(0.0,0.0,0.0,2.0);
        gl_PointSize = 0.0;
        return;
      }

      // Position in camera space
      vec4 camera = uModelViewMatrix * vec4(position, 1.0);

      float pointSize = uPointScale.x;
      vec4 position = uProjectionMatrix * camera;
     ${t.drawScreenSize?jt`
      float clampedScreenSize = pointSize;`:jt`
      float pointRadius = 0.5 * pointSize;
      vec4 cameraOffset = camera + vec4(0.0, pointRadius, 0.0, 0.0);
      vec4 positionOffset = uProjectionMatrix * cameraOffset;
      float radius = abs(positionOffset.y - position.y);
      float viewHeight = uPointScale.y;
      // screen diameter = (2 * r / w) * (h / 2)
      float screenPointSize = (radius / position.w) * viewHeight;
      float clampedScreenSize = clamp(screenPointSize, uScreenMinMaxSize.x, uScreenMinMaxSize.y);
      // Shift towards camera, to move rendered point out of terrain i.e. to
      // the camera-facing end of the virtual point when considering it as a
      // 3D sphere.
      camera.xyz -= normalize(camera.xyz) * pointRadius * clampedScreenSize / screenPointSize;
      position = uProjectionMatrix * camera;`}

     gl_PointSize = clampedScreenSize;
     gl_Position = position;

     ${e?jt`depth = (-camera.z - nearFar[0]) / (nearFar[1] - nearFar[0]);`:""}
     ${s?jt`vColor = color;`:""}
    }
  `),i.fragment.include(At,t),n&&i.include(Ot),i.fragment.code.add(jt`
    void main(void) {
      vec2 vOffset = gl_PointCoord - vec2(0.5, 0.5);
      float r2 = dot(vOffset, vOffset);

      if (r2 > 0.25) {
        discard;
      }
      ${e?jt`gl_FragColor = float2rgba(depth);`:""}
      ${n?jt`outputHighlight();`:""}
      ${s?jt`gl_FragColor = vec4(vColor, 1.0);`:""}
    }
  `),i}const gi=Object.freeze({__proto__:null,build:mi});class bi extends Ft{constructor(t,i,s){super(t,i,s)}initializeProgram(t){const i=bi.shader.get(),s=this.configuration,e=i.build({output:s.output,slicePlaneEnabled:s.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,drawScreenSize:s.drawScreenSize});return new Rt(t.rctx,e,$t)}initializePipeline(){return Gt({depthTest:{func:513},depthWrite:Ht,colorWrite:Lt,stencilWrite:this.configuration.sceneHasOcludees?Dt:null,stencilTest:this.configuration.sceneHasOcludees?Et:null})}}bi.shader=new Vt(gi,(()=>import("./p-cb1e5f43.js")));class yi extends It{constructor(){super(...arguments),this.output=0,this.slicePlaneEnabled=!1,this.drawScreenSize=!1,this.sceneHasOcludees=!1}}i([Nt({count:8})],yi.prototype,"output",void 0),i([Nt()],yi.prototype,"slicePlaneEnabled",void 0),i([Nt()],yi.prototype,"drawScreenSize",void 0),i([Nt()],yi.prototype,"sceneHasOcludees",void 0);const vi={positions:[{name:"position",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"color",count:3,type:5121,offset:0,stride:3,normalized:!0}]};class Si{constructor(t){this._params=t,this.type="Point",this.isGround=!1,this._bindParameters={inverseViewport:[0,0],highlightDepthTexture:null},this._highlights=new fi({forEachNode:t=>this.forEachNode(t),addHighlight:(t,i,s)=>this.addHighlight(t,i,s),removeHighlight:(t,i)=>this.removeHighlight(t,i)}),this.canRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=D(E),this._techniqueConfig=new yi,this.tempMatrix4=St(),this.tempVec3=N(),this.nodes=new r}get needsHighlight(){return this._highlights.hasHighlights}initializeRenderContext(t){this._context=t,this._techniqueRep=this._context.shaderTechniqueRep,t.requestRender()}uninitializeRenderContext(){}intersect(t,i,s,e){const n=wt(),r=wt(),o=wt(),h=wt(),a=B(),l=t.camera.perScreenPixelRatio/2,u=t.camera.near,c=this._getSizeParams();P(r,e,s);const d=1/A(r);M(r,r,d),z(o,r),C(a,r[0],r[1],r[2],-x(r,s));class f{constructor(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""}}const p=new f,m=new f,g=[],b=D(),y=D(this._clipBox);V(y,-s[0],-s[1],-s[2],y),this.nodes.forAll((v=>{const S=v.splatSize*this._scaleFactor;let _=lt(v.obb,a),w=ut(v.obb,a);if(_-=xi(S,_+u,c,l,v.isLeaf),w-=xi(S,w+u,c,l,v.isLeaf),w<0||null!=p.dist&&null!=m.dist&&p.dist<_*d&&m.dist>w*d)return;const M=wi(S,w+u,c,l,v.isLeaf);if(!ct(v.obb,s,r,M))return;const z=M*M;ot(v.obb,b),V(b,-s[0],-s[1],-s[2],b);const C=!R(y,b);P(h,v.origin,s);const j=v.coordinates.length/3;for(let a=0;a<j;a++){if(n[0]=h[0]+v.coordinates[3*a],n[1]=h[1]+v.coordinates[3*a+1],n[2]=h[2]+v.coordinates[3*a+2],C&&!W(y,n))continue;const b=x(n,r),_=O(n)-b*b;if(_>z)continue;let w=b+u;const P=xi(S,w,c,l,v.isLeaf);if(b-P<0)continue;w-=P;const M=wi(S,w,c,l,v.isLeaf);if(_>M*M)continue;const j=(b-P)*d,A=t=>{t.point=Pi(v,a,t.point),t.dist=j,t.normal=o,t.node=v,t.pointId=a,t.layerUid=this.layerUid};if((null==p.dist||j<p.dist)&&(null==i||i(s,e,j))&&A(p),0!==t.options.store&&(null==m.dist||j>m.dist)&&(null==i||i(s,e,j))&&A(m),2===t.options.store&&(null==i||i(s,e,j))){const t=new f;A(t),g.push(t)}}}));const v=t=>{const{layerUid:i,node:s,pointId:e}=t;return{type:"external",point:t.point,metadata:{layerUid:i,createGraphic:()=>this._params.createGraphic(s,e,t.point)}}},S=(t,i)=>{const s=v(i);t.set(s,`${i.layerUid}/${i.node.id}/${i.pointId}`,i.dist,i.normal,_t,void 0),t.intersector="PointRenderer"};if(null!=p.dist){const i=t.results.min;(null==i.dist||p.dist<i.dist)&&S(i,p)}if(null!=m.dist&&0!==t.options.store){const i=t.results.max;(null==i.dist||m.dist>i.dist)&&S(i,m)}if(2===t.options.store){const i=xt(s,e);for(const s of g){const e=new Mt(i);S(e,s),t.results.all.push(e)}}}render(t){if(0===this.nodes.length||0!==t.pass&&2!==t.pass&&5!==t.pass)return!1;const i=this._getSizeParams(),s=this.selectTechnique(t,i),e=s.program;if(null==e)return!1;this.nodes.forAll((i=>{null==i.vao&&this._initNode(t,i)}));const n=t.rctx;n.useProgram(e),s.bindPipelineState(n);const r=this._clipBox,o=!k(r,E,((t,i)=>t===i));o||(j(this.tempVec3,-1/0,-1/0,-1/0),e.setUniform3fv("uClipMin",this.tempVec3),j(this.tempVec3,1/0,1/0,1/0),e.setUniform3fv("uClipMax",this.tempVec3)),e.setUniformMatrix4fv("uProjectionMatrix",t.camera.projectionMatrix),2===t.pass&&e.setUniform2f("nearFar",t.camera.near,t.camera.far),t.isHighlightPass&&(this._bindParameters.inverseViewport[0]=1/t.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/t.camera.fullViewport[3],this._bindParameters.highlightDepthTexture=t.highlightDepthTexture,Wt(e,this._bindParameters));const h=t.camera.pixelRatio;i.drawFixedSize&&e.setUniform2f("uPointScale",i.fixedSize*h,t.camera.fullHeight);const a=this._slicePlaneEnabled?t.sliceHelper&&t.sliceHelper.plane:null;return this.nodes.forAll((l=>{if(0===l.coordinates.length||t.isHighlightPass&&!l.highlights)return;e.setUniform2f("uScreenMinMaxSize",i.screenMinSize*h,_i(l.isLeaf)*h),i.drawFixedSize||e.setUniform2f("uPointScale",l.splatSize*this._scaleFactor*h,t.camera.fullHeight/h);const u=l.origin;o&&(j(this.tempVec3,r[0]-u[0],r[1]-u[1],r[2]-u[2]),e.setUniform3fv("uClipMin",this.tempVec3),j(this.tempVec3,r[3]-u[0],r[4]-u[1],r[5]-u[2]),e.setUniform3fv("uClipMax",this.tempVec3)),bt(this.tempMatrix4),yt(this.tempMatrix4,this.tempMatrix4,u),vt(this.tempMatrix4,t.camera.viewMatrix,this.tempMatrix4),e.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4),kt(e,s.configuration,a,u),n.bindVAO(l.vao),t.isHighlightPass?this._renderHighlightFragments(n,l):n.drawArrays(0,0,l.coordinates.length/3)})),!0}_renderHighlightFragments(t,i){const s=i.highlights;if(o(s))return;let e=a(s[0].component),n=e+1;for(let i=1;i<s.length;i++){const r=a(s[i].component);if(r!==n){const i=n-e;i>0&&t.drawArrays(0,e,i),e=r}n=r+1}const r=n-e;r>0&&t.drawArrays(0,e,r)}set useFixedSizes(t){this._useFixedSizes!==t&&(this._useFixedSizes=t,this._requestRender())}get useFixedSizes(){return this._useFixedSizes}set scaleFactor(t){this._scaleFactor!==t&&(this._scaleFactor=t,this._requestRender())}get scaleFactor(){return this._scaleFactor}set minSizePx(t){this._minSizePx!==t&&(this._minSizePx=t,this._requestRender())}get minSizePx(){return this._minSizePx}set useRealWorldSymbolSizes(t){this._useRealWorldSymbolSizes!==t&&(this._useRealWorldSymbolSizes=t,this._requestRender())}get useRealWorldSymbolSizes(){return this._useRealWorldSymbolSizes}set size(t){this._size!==t&&(this._size=t,this._requestRender())}get size(){return this._size}set sizePx(t){this._sizePx!==t&&(this._sizePx=t,this._requestRender())}get sizePx(){return this._sizePx}set clippingBox(t){G(this._clipBox,t||E)}get slicePlane(){return this._slicePlaneEnabled}set slicePlane(t){this._slicePlaneEnabled!==t&&(this._slicePlaneEnabled=t,this._requestRender())}get intersectionHandlerId(){return this.layerUid}addNode(t){this.nodes.push(t),this._highlights.nodeAdded(t),this._requestRender()}removeNode(t){let i=null;return this.nodes.filterInPlace((s=>s.id!==t||(i=s,s.vao=h(s.vao),this._highlights.nodeRemoved(s),!1))),this._requestRender(),i}forEachNode(t){this.nodes.forAll(t)}removeAll(){this.nodes.forAll((t=>t.vao=h(t.vao))),this._highlights.removeAll(),this.nodes.clear(),this._requestRender()}highlight(t){return this._highlights.add(t)}addHighlight(t,i,s){t.highlights=function(t,i,s){o(t)&&(t=[]);const e={component:i,id:s};t.push(e);const n=Mi(e);let r=t.length-1;for(;r>0&&n<Mi(t[r-1]);)[t[r-1],t[r]]=[t[r],t[r-1]],--r;return t}(t.highlights,i,s),this._requestRender()}removeHighlight(t,i){t.highlights=function(t,i){if(o(t))return t;const s=t.filter((t=>t.id!==i));return 0===s.length?null:s}(t.highlights,i),this._requestRender()}_initNode(t,i){const s=t.rctx;i.vao=new Bt(s,$t,vi,{positions:Tt.createVertex(s,35044,i.coordinates),colors:Tt.createVertex(s,35044,i.rgb)})}_requestRender(){this._context&&this._context.requestRender()}_getSizeParams(){const t=this._useFixedSizes,i=t&&!this._useRealWorldSymbolSizes;return{drawScreenSpace:i,drawFixedSize:t,fixedSize:i?this._sizePx:this._size,screenMinSize:t?0:this._minSizePx}}selectTechnique(t,i){return this._techniqueConfig.drawScreenSize=i.drawScreenSpace,this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled,this._techniqueConfig.sceneHasOcludees=t.hasOccludees,this._techniqueConfig.output=2===t.pass?1:5===t.pass?4:0,this._techniqueRep.releaseAndAcquire(bi,this._techniqueConfig,this._technique)}}function _i(t){return t?256:64}function wi(t,i,s,e,n){if(s.drawScreenSpace)return s.fixedSize*i*e;const r=_i(n)*i*e;return s.drawFixedSize?Math.min(s.fixedSize/2,r):s.screenMinSize>0?Math.min(Math.max(s.screenMinSize*i*e,t/2),r):Math.min(t/2,r)}function xi(t,i,s,e,n){return s.drawScreenSpace?0:wi(t,i,s,e,n)}function Pi(t,i,s){return null==s&&(s=wt()),s[0]=t.origin[0]+t.coordinates[3*i],s[1]=t.origin[1]+t.coordinates[3*i+1],s[2]=t.origin[2]+t.coordinates[3*i+2],s}function Mi(i){return t(i.component)?i.component:-1}(Si||(Si={})).isInstanceOfNode=function(t){return t.hasOwnProperty("splatSize")};const zi=l.getLogger("esri.views.3d.layers.PointCloudLayerView3D"),Ci=B();let ji=class extends(Ut(Z(qt))){constructor(){super(...arguments),this.type="point-cloud-3d",this.maximumPointCount=4e6,this.slicePlaneEnabled=!1,this._renderer=null,this._rendererAdded=!1,this._renderedNodes=new Set,this._nodeScales=new Map,this._updateViewNeeded=!0,this._lodFactor=1,this._maxLoggedBoxWarnings=5,this._pageMultiplier=1,this._nodeLoadEpoch=0,this._indexQueue=[],this._workQueue=new Array,this._idleQueue=new K,this._indexPagesLoading=new Map,this._loadingNodes=new Map,this._recalcWork=!0,this._layerIsVisible=!1,this._codedDomainPopulationPromise=null,this._codedDomainPopulationAbortController=null,this._totalWork=0,this._index=null,this._loadingInitNodePage=!1,this._nodeIdArray=[]}get pointScale(){const t=function(t){const i=t&&t.pointSizeAlgorithm;return i&&"splat"===i.type?i:null}(this.layer&&this.layer.renderer);return t&&null!=t.scaleFactor?t.scaleFactor:1}get useRealWorldSymbolSizes(){const t=ai(this.layer&&this.layer.renderer);return!(!t||null==t.useRealWorldSymbolSizes)&&t.useRealWorldSymbolSizes}get pointSize(){const t=ai(this.layer&&this.layer.renderer);return t&&null!=t.size?t.size:0}get inverseDensity(){return this.layer&&this.layer.renderer?96/this.layer.renderer.pointsPerInch:5}get availableFields(){const t=oi(this.layer),i=new Set;t.primaryAttribute&&i.add(t.primaryAttribute.name),t.modulationAttribute&&i.add(t.primaryAttribute.name);const s=hi(this.layer);if(s)for(const t of s)i.add(t.attributeInfo.name);if(this.layer.outFields)for(const t of J(this.layer.fieldsIndex,this.layer.outFields))i.add(t);return Array.from(i)}get _clippingBox(){if(!this.view||!this.view.clippingArea)return null;const t=D();return tt(this.view.clippingArea,t,this.view.renderSpatialReference)?t:null}get _elevationOffset(){const t=this.layer&&this.layer.elevationInfo;if(t&&"absolute-height"===t.mode){const i=w(this.layer.spatialReference),s=Y(t.unit);return u(t.offset,0)*s/i}return 0}initialize(){const t=this.view.resourceController;this._worker=new Kt((i=>t.schedule(i))),this.addResolvingPromise(this._worker.promise),this._tmpPoint=U(0,0,0,this.layer.spatialReference),et(this.layer),nt(this.layer,this.view),this._indexRequester=t.createStreamDataRequester(2),this._dataRequester=t.createStreamDataRequester(3),this._initRenderer();const i=this._initNodePages(),s=this.view.resourceController.memoryController;this._memCache=s.newCache(this.layer.uid),this.updatingHandles.add(this,"_clippingBox",(()=>this._setUpdateViewNeeded()),2),this.updatingHandles.add(this,"_elevationOffset",(()=>this._elevationOffsetChanged()),2),this.updatingHandles.add(this.layer,"renderer",(()=>this._rendererChanged()),2),this.updatingHandles.add(this.layer,"filters",(()=>this._reload()),2),this.updatingHandles.add(this.layer,"outFields",(()=>this._reload()),2),this.updatingHandles.add(this.layer,"scaleRangeId",(()=>this._setUpdateViewNeeded())),this.updatingHandles.add(this,"clippingArea",(()=>this._setUpdateViewNeeded()),2),this.updatingHandles.add(this.view.state,"contentCamera",(()=>this._setUpdateViewNeeded())),this.handles.add([this.view.basemapTerrain.on("scale-change",(t=>this._scaleUpdateHandler(t))),s.events.on("quality-changed",(()=>this._setUpdateViewNeeded()))]),this.addResolvingPromise(i),this.when((()=>{this.handles.add([t.scheduler.registerTask(X.POINT_CLOUD_LAYER,this),t.scheduler.registerIdleStateCallbacks((()=>this._idleBegin()),(()=>this._idleEnd())),this.updatingHandles.add(this,"suspended",(t=>{t?this._clearNodeState():this._setUpdateViewNeeded()}),2)])}),(()=>{this.updatingHandles.removeAll(),this.handles.removeAll()}))}_setUpdateViewNeeded(){this._updateViewNeeded=!0,this._updateLoading()}destroy(){this.cancelLoading(),this._worker&&(this._worker.destroy(),this._worker=null),this._destroyRenderer(),this._memCache.destroy(),this._memCache=null,this._codedDomainPopulationAbortController&&(this._codedDomainPopulationAbortController.abort(),this._codedDomainPopulationAbortController=null),this._codedDomainPopulationPromise=null}_initRenderer(){this._renderer=new Si({createGraphic:(t,i,s)=>this._createGraphic(t,i,s)}),this._renderer.layerUid=this.layer.uid,this.updatingHandles.add(this,"_clippingBox",(t=>this._renderer.clippingBox=t),2),this.updatingHandles.add(this,"suspended",(t=>this._setPointsVisible(!t)),2),this.updatingHandles.add(this,"pointScale",(t=>this._renderer.scaleFactor=t),2),this._renderer.minSizePx=Math.sqrt(2),this.updatingHandles.add(this,"useRealWorldSymbolSizes",(t=>this._renderer.useRealWorldSymbolSizes=t),2),this.updatingHandles.add(this,"pointSize",(t=>{const i=_(t);this._renderer.size=t,this._renderer.sizePx=i}),2),this.updatingHandles.add(this,"slicePlaneEnabled",(t=>this._renderer.slicePlane=t),2),this.updatingHandles.add(this,"inverseDensity",(()=>this._setUpdateViewNeeded()),2),this.updatingHandles.add(this,"maximumPointCount",(()=>this._setUpdateViewNeeded()),2),this.updatingHandles.add(this.view,"qualitySettings.sceneService.pointCloud.lodFactor",(t=>{this._lodFactor=t,this._setUpdateViewNeeded()}),2)}_destroyRenderer(){this._renderer.removeAll(),this._setPointsVisible(!1)}_createGraphic(i,s,e){const n=t(i.pointIdFilterMap)?i.pointIdFilterMap[s]:s,r=this.view.computeMapPointFromVec3d(e),o=this._createGraphicAttributes(i,n);return new di({pointCloudMetadata:{nodeId:i.id,pointIndexInNode:s,attributePointIndexInNode:n,epoch:this._nodeLoadEpoch},geometry:r,attributes:o,layer:this.layer,sourceLayer:this.layer})}_createGraphicAttributes(t,i){const s={};for(const e of t.attributes)this._encodeGraphicAttribute(e.attributeInfo,e.values,i,s);return s}_encodeGraphicAttribute(t,i,s,e){const n=t.storageInfo&&t.storageInfo.attributeValues,r=n?n.valuesPerElement:1;if(1===r)e[t.name]=i[s];else if("UInt8"===n.valueType&&r<=4){let n=0;const o=s*r;for(let t=o;t<o+r;t++)n=(n<<8)+i[t];e[t.name]=n}else e[t.name]=void 0}_setPointsVisible(t){t&&!this._rendererAdded?(this.view._stage.addRenderPlugin([3],this._renderer),this._rendererAdded=!0):!t&&this._rendererAdded&&(this.view._stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)}_rendererChanged(){this._renderer.useFixedSizes=function(t){const i=t&&t.pointSizeAlgorithm;return!(!i||!i.type)&&"fixed-size"===i.type}(this.layer.renderer),this._reload()}_reload(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()}_elevationOffsetChanged(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()}_scaleUpdateHandler(t){this.layer.minScale||this.layer.maxScale?F(t.extent,t.spatialReference,Ai,this.layer.spatialReference)&&(this._nodeScales.forEach(((i,s)=>{if(!this._renderedNodes.has(s))return void this._nodeScales.delete(s);const e=this._index.getNode(s);H(Ai,e.obb.center)&&this._nodeScales.set(s,t.scale)})),this._setUpdateViewNeeded()):this._nodeScales.clear()}displayNodes(t){this._workQueue=function(t,i,s){for(let t=0;t<i.length;t++)Zt[t]=!1,ti[t]=null;for(let i=0;i<t.length;i++)Xt[i]=!1,Yt[i]=null;for(let e=0;e<i.length;e++){const n=ii(i[e],t,s);n>=0&&(Zt[e]=!0,null!=Yt[n]?Yt[n].push(i[e]):Yt[n]=[i[e]])}for(let e=0;e<t.length;e++){const n=ii(t[e],i,s);n>=0&&(Xt[e]=!0,null!=ti[n]?ti[n].push(t[e]):ti[n]=[t[e]])}const e=[];for(let i=0;i<t.length;i++)null!=Yt[i]||Xt[i]||e.push({load:[],remove:[t[i]]});for(let t=0;t<i.length;t++)null!=ti[t]||Zt[t]||e.push({load:[i[t]],remove:[]});for(let t=0;t<i.length;t++)null!=ti[t]&&(ti[t].length>1||ti[t][0]!==i[t])&&e.push({load:[i[t]],remove:ti[t]});for(let i=0;i<t.length;i++)null!=Yt[i]&&(Yt[i].length>1||Yt[i][0]!==t[i])&&e.push({load:Yt[i],remove:[t[i]]});return e}([...this._renderedNodes],t,this._index),function(t,i,s){t.sort(((t,e)=>{if(0===t.load.length&&0===e.load.length)return 0;if(0===t.load.length)return-1;if(0===e.load.length)return 1;if(0===t.remove.length&&0===e.remove.length){const n=s.getRenderCenter(t.load[0]),r=s.getRenderCenter(e.load[0]);return x(n,i)-x(r,i)}if(0===t.remove.length)return-1;if(0===e.remove.length)return 1;if(1===t.load.length&&1===e.load.length){const n=s.getRenderCenter(t.load[0]),r=s.getRenderCenter(e.load[0]);return x(n,i)-x(r,i)}if(1===t.load.length)return-1;if(1===e.load.length)return 1;{const n=s.getRenderCenter(t.remove[0]),r=s.getRenderCenter(e.remove[0]);return x(n,i)-x(r,i)}}))}(this._workQueue,this.view.state.contentCamera.viewForward,this._index),function(t,i,s){for(let i=0;i<t.length;++i){const e=t[i];e.load.length>8&&1===e.remove.length&&si(t,e,s)}}(this._workQueue,0,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=t.length>0||this._loadingInitNodePage,this.notifyChange("suspended")}cancelLoading(){this._cancelNodeLoading(),this._cancelIndexLoading()}_cancelNodeLoading(){const t=new Array;this._loadingNodes.forEach((({abortController:i})=>t.push(i))),this._loadingNodes.clear();for(const i of t)i.abort();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()}_updateQueues(){const t=new Set;this._workQueue.forEach((i=>i.load.forEach((i=>t.add(i)))));const i=new Array,s=new Map;this._loadingNodes.forEach(((e,n)=>{t.has(n)?s.set(n,e):i.push(e)})),this._loadingNodes=s;for(const{abortController:t}of i)t.abort();this._workQueue=this._workQueue.filter((t=>{for(const i of t.load)if(this._loadingNodes.has(i))return this._recalcWork=!0,!1;return!0})),this._totalWork=this._computeWork(),this._updateLoading()}_cancelIndexLoading(){this._indexQueue=[],this._indexPagesLoading.forEach((({abortController:t})=>t.abort())),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()}_clearNodeState(){this._nodeLoadEpoch++,this._renderedNodes.forEach((t=>this._removeFromRenderer(t))),this._cancelNodeLoading()}_idleBegin(){this._setUpdateViewNeeded()}_idleEnd(){this._setUpdateViewNeeded()}get running(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.running}runTask(t){if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;const t=this._isRootNodeVisible();t!==this._layerIsVisible&&(this._layerIsVisible=t,this.notifyChange("suspended")),this._updateLoading()}}else{for(t.run((()=>this._updateWorkQueues()));this._indexQueue.length>0&&t.run((()=>this._processIndexQueue())););this._processWorkQueue(t),this._idleQueue.runTask(t)}}_processIndexQueue(){const t=this._indexQueue.shift(),i=this._loadNodePage(t);return this._indexPagesLoading.set(t,i),i.promise.then((i=>{this._index.addPage(t,i,this._elevationOffset),this._setUpdateViewNeeded()})).then((()=>{this._indexPagesLoading.delete(t)}),(()=>{this._indexPagesLoading.delete(t)})),!0}_processWorkQueue(t){for(;!t.done;){const i=this._scheduleWorkEntry();if(o(i))return;this._processWorkEntry(i),t.madeProgress()}}_scheduleWorkEntry(){let t=this._workQueue.length;for(;t--;){const t=this._workQueue.shift();if(!t.remove.find((t=>!this._renderedNodes.has(t))))return t;this._workQueue.push(t)}return null}_processWorkEntry(i){if(0!==i.load.length)Promise.all(i.load.map((i=>{const s=new AbortController,e=this._memCache.pop(i.toString());return t(e)?this._loadingNodes.set(i,{abortController:s,promise:Promise.resolve(e)}):this._loadingNodes.has(i)||this._loadingNodes.set(i,{abortController:s,promise:this.loadNode(i,s.signal)}),this._loadingNodes.get(i).promise}))).then((t=>{for(let s=0;s<i.load.length;s++)if(t[s]){const e=this._setupRendererData(i.load[s],t[s]);this._addToRenderer(e)}for(const t of i.remove)this._removeFromRenderer(t)})).catch((()=>{})).then((()=>{for(const t of i.load)this._loadingNodes.delete(t);this._updateLoading(),this._recalcWork&&!this._idleQueue.running&&0===this._indexQueue.length&&0===this._loadingNodes.size&&(this._recalcWork=!1,this._setUpdateViewNeeded())})),this._updateLoading();else for(const t of i.remove)this._removeFromRenderer(t)}async populateClassCodeCodedDomain(t,i){const s="CLASS_CODE",e=this.layer.fieldsIndex.get(s);if(!e||e.domain)return;if(-1===t.indexOf(e.name))return;const n=await v(this.layer.queryCachedStatistics(s,{signal:i}));if(!1===n.ok)return;const r=n.value,o=r&&r.labels&&r.labels.labels;o&&Array.isArray(o)&&(e.domain=new q({name:"CLASS_CODE",codedValues:o.map((t=>new Q({code:t.value,name:t.label})))}))}async prepareFetchPopupFeatures(t){return this._codedDomainPopulationPromise||(this._codedDomainPopulationAbortController=new AbortController,this._codedDomainPopulationPromise=this.populateClassCodeCodedDomain(t,this._codedDomainPopulationAbortController.signal).then((()=>{this._codedDomainPopulationAbortController=null}))),this._codedDomainPopulationPromise}async whenGraphicAttributes(t,i){const s=this._splitGraphicsPerNode(t),e=this.layer.attributeStorageInfo,n=i.map((t=>ui(e,t))),r=async(t,i)=>{const s=this._index.getNode(i);await S(n,(async i=>{const e=i.useElevation?await this._loadElevationAttributeFromGeometry(s.resourceId):await this._loadAndParseAttribute(s,i);if(e)for(const s of t)this._isValidPointGraphic(s)&&this._encodeGraphicAttribute(i,e,s.pointCloudMetadata.attributePointIndexInNode,s.attributes)}))},o=[];return s.forEach(((t,i)=>{o.push(r(t,i))})),await c(o),t}_isValidPointGraphic(t){return t instanceof di&&t.pointCloudMetadata&&t.pointCloudMetadata.epoch===this._nodeLoadEpoch}_splitGraphicsPerNode(t){const i=new Map;for(const s of t){if(!this._isValidPointGraphic(s))continue;const t=s.pointCloudMetadata,e=i.get(t.nodeId);e?e.push(s):i.set(t.nodeId,[s])}return i}async _loadAndParseAttribute(i,s){const e=await this._loadAttribute(i.resourceId,s,null);return t(e)?ft({attributeInfo:s,buffer:e},null,i.vertexCount):null}async _loadElevationAttributeFromGeometry(t){const i=pt(this.layer.store.defaultGeometrySchema,await this._loadGeometry(t,null));return mt(i,i.length/3)}highlight(t){if(!t)return{remove(){}};const i=d.isCollection(t)?t.toArray():Array.isArray(t)?t:[t];return this._renderer.highlight(i.map((t=>this._graphicToPointDefinition(t))))}_graphicToPointDefinition(t){if(!this._isValidPointGraphic(t))return null;const{nodeId:i,pointIndexInNode:s}=t.pointCloudMetadata;return null!=i&&null!=s?{nodeId:i,pointId:s}:null}_computeWork(){let t=0;for(const i of this._workQueue)t+=i.load.length+i.remove.length;return t+=this._loadingNodes.size,t+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,t+=this._loadingInitNodePage?100:0,t+=this._updateViewNeeded?100:0,t}get updatingProgressValue(){if(this.suspended)return this._updateViewNeeded?0:1;const t=this._computeWork();return 1-Math.min(this._totalWork,t)/this._totalWork}_updateLoading(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue")}canResume(){return super.canResume()&&this._layerIsVisible}isUpdating(){return this.suspended?this._updateViewNeeded:this._computeWork()>0}_initNodePages(){const t=this.layer.store.index;return this._index=new ei(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,t.nodesPerPage||t.nodePerIndexBlock),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=null!=t.nodesPerPage?1:t.nodePerIndexBlock,this._loadNodePage(0).promise.then((t=>{this._index.addPage(0,t,this._elevationOffset),this._loadingInitNodePage=!1,this._setUpdateViewNeeded()}))}_loadNodePage(t){const i=new AbortController;return{promise:this._requestNodePage(`${this.baseUrl}/nodepages/${t*this._pageMultiplier}`,i.signal).then((i=>i.nodes.map(((i,s)=>({resourceId:null!=i.resourceId?i.resourceId:t*this._index.pageSize+s,obb:i.obb,firstChild:i.firstChild,childCount:i.childCount,vertexCount:null!=i.vertexCount?i.vertexCount:i.pointCount,lodThreshold:null!=i.lodThreshold?i.lodThreshold:i.effectiveArea}))))),abortController:i}}_updateWorkQueues(){if(!this._updateViewNeeded)return!1;let t=this.inverseDensity/this._lodFactor*this._getLodMemoryFactor();const i=this.maximumPointCount*this._lodFactor*this._getLodMemoryFactor();let s=this._computeNodesForMinimumDensity(t),e=this._computePointCount(s),n=Math.sqrt(e/(.75*i));for(;e>i;)t*=n,s=this._computeNodesForMinimumDensity(t),e=this._computePointCount(s),n=Math.sqrt(2);return this.displayNodes(s),this._updateViewNeeded=!1,this._updateLoading(),!0}_computePointCount(t){let i=0;for(let s=0;s<t.length;s++){const e=this._index.getNode(t[s]);e&&(i+=e.vertexCount)}return i}_getLodMemoryFactor(){return this.view.resourceController.memoryController.memoryFactor}_isRootNodeVisible(){let t=!1;return this._traverseVisible({frustum:this.view.state.contentCamera.frustum,clippingBox:this._clippingBox},{predicate:(i,s,e)=>(t=e,!1),pageMiss:()=>{}}),t}_computeNodesForMinimumDensity(t){const i=this.view.state.contentCamera,s=i.frustum,e=this._clippingBox,n=i.viewForward,r=x(n,i.eye),o=T(n,-r,Ci),h=i.perScreenPixelRatio/2,a=t*t,l=this._nodeIdArray;l.length=0;const{minScale:u,maxScale:c}=Qt(this.layer),d=0===u&&0===c?t=>l.push(t):t=>{const i=this._getScale(t);Jt(i,u,c)&&l.push(t)};return this._traverseVisible({frustum:s,clippingBox:e},{predicate:(t,i,s)=>{if(!s)return!1;if(0===i.childCount)return d(t),!1;const e=this._index.getRenderObb(t);return!(this._computeAveragePixelArea(e,i.lodThreshold,i.vertexCount,o,h)<=a&&(d(t),1))},pageMiss:(t,i)=>{d(t),this._indexQueue.indexOf(i)<0&&this._indexQueue.push(i)}}),l}_getScale(t){let i=this._nodeScales.get(t);if(null==i){const s=this._index.getNode(t).obb.center;this._tmpPoint.x=s[0],this._tmpPoint.y=s[1],this._tmpPoint.z=s[2],i=this.view.basemapTerrain.getScale(this._tmpPoint),this._nodeScales.set(t,i)}return i}_computeAveragePixelArea(t,i,s,e,n){const r=Math.max(1e-7,lt(t,e));return i/(r*r)/(4*n*n)/s}loadNode(t,i){try{return this.loadNodeAsync(t,i)}catch(t){throw f(t)||zi.error(t),t}}async loadAdditionalUserAttributes(i,s,e){const n=this.layer.outFields;if(!n)return[];const r=J(this.layer.fieldsIndex,n),o=new Set(i.map((i=>t(i)?i.name:null))),h=this.layer.attributeStorageInfo,a=[];for(const t of r){if(o.has(t))continue;const i=ui(h,t);i&&a.push(s(i))}const l=await p(a);return m(e),g(l,(t=>t))}async loadNodeAsync(i,s){const e=this._index.getNode(i),n=oi(this.layer),r=hi(this.layer),h=e.resourceId,a=async i=>{if(o(i))return null;if(i.useElevation)return{attributeInfo:i,buffer:null};const e=await this._loadAttribute(h,i,s);return t(e)?{attributeInfo:i,buffer:e}:null};return this._idleQueue.push((async()=>{const t=this._loadGeometry(h,s),{primaryAttribute:e,modulationAttribute:o}=n,l=a(e),u=a(o),c=r.map((t=>t.attributeInfo)),d=c.map((t=>a(t))),f=this.loadAdditionalUserAttributes([e,o,...c],a,s),[p,g,b,y,v]=await Promise.all([t,l,u,Promise.all(d),f]);m(s);const S={geometryBuffer:p,primaryAttributeData:g,modulationAttributeData:b,filterAttributesData:y,userAttributesData:v,schema:this.layer.store.defaultGeometrySchema,rendererInfo:n,filterInfo:r,obb:this._index.getRenderObb(i),elevationOffset:this._elevationOffset,inSR:this.layer.spatialReference.toJSON(),outSR:this.view.renderCoordsHelper.spatialReference.toJSON()};return this._worker.invoke(S,s)}),s)}async _loadGeometry(t,i){return this._requestData(`${this.baseUrl}/nodes/${t}/geometries/0`,i)}async _loadAttribute(t,i,s){return o(i)||!i.storageInfo?null:this._requestData(`${this.baseUrl}/nodes/${t}/attributes/${i.storageInfo.key}`,s)}_requestNodePage(t,i){return this._indexRequester.request(t,"json",{query:{f:"json",token:this.layer.apiKey},signal:i})}_requestData(t,i){return this._dataRequester.request(t,"binary",{query:{token:this.layer.apiKey},signal:i})}_removeFromRenderer(t){if(this._renderedNodes.has(t)){const i=this._renderer.removeNode(t);this._renderedNodes.delete(t),this._nodeScales.delete(t),this._memCache.put(i.id.toString(),i,function(t){return 5*t.coordinates.length+128}(i))}}_addToRenderer(t){this._renderedNodes.has(t.id)||(this._renderedNodes.add(t.id),this._renderer.addNode(t))}_setupRendererData(t,i){const s=this._index.getNode(t),e=Math.sqrt(s.lodThreshold/s.vertexCount),n=this._index.getRenderObb(t);if(Si.isInstanceOfNode(i))return i.splatSize=e,i.obb=n,i.origin=I(i.obb.center),i;const r=.01*Math.max(n.halfSize[0],n.halfSize[1],n.halfSize[2]);if(i.obb.halfSize[0]>n.halfSize[0]+r||i.obb.halfSize[1]>n.halfSize[1]+r||i.obb.halfSize[2]>n.halfSize[2]+r){if(this._maxLoggedBoxWarnings>0){const s=t=>`[${t.halfSize[0]}, ${t.halfSize[1]}, ${t.halfSize[2]}]`;zi.warn(`Node ${t} reported bounding box too small. got ${s(n)} but points cover ${s(i.obb)}`),0==--this._maxLoggedBoxWarnings&&zi.warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(t,i.obb)}return{id:t,coordinates:i.points,origin:I(n.center),rgb:i.rgb,attributes:i.attributes,pointIdFilterMap:i.pointIdFilterMap,highlights:null,splatSize:e,obb:n,isLeaf:0===s.childCount}}getUsedMemory(){let t=0;return this._renderer.forEachNode((i=>{t+=Oi,t+=b(i.coordinates);for(const s of i.attributes){const i=s.values;y(i.buffer)&&(t+=b(i))}})),t}getUnloadedMemory(){const t=this._renderedNodes.size;if(t<4)return 0;const i=[...this._renderedNodes].reduce(((t,i)=>t+this._index.getNode(i).vertexCount));let s=this._loadingNodes.size;for(let t=0;t<this._workQueue.length;t++)s+=this._workQueue[t].load.length,s-=this._workQueue[t].remove.length;return s<0?0:s*i/t*((this.getUsedMemory()-t*Oi)/i)+s*Oi}ignoresMemoryFactor(){return!1}get performanceInfo(){return{nodes:this._renderedNodes.size,displayedNumberOfFeatures:[...this._renderedNodes].reduce(((t,i)=>t+this._index.getNode(i).vertexCount),0),maximumNumberOfFeatures:this.maximumPointCount,totalNumberOfFeatures:-1,core:null,"Loading Nodes":this._loadingNodes.size,"Index Queue":this._indexQueue.length,"Work Queue":this._workQueue.length,"Idle Queue":this._idleQueue.length}}get test(){return{index:this._index,visibleNodes:this._renderedNodes}}};i([s()],ji.prototype,"layer",void 0),i([s({readOnly:!0,aliasOf:"layer.parsedUrl.path"})],ji.prototype,"baseUrl",void 0),i([s({readOnly:!0})],ji.prototype,"pointScale",null),i([s({readOnly:!0})],ji.prototype,"useRealWorldSymbolSizes",null),i([s({readOnly:!0})],ji.prototype,"pointSize",null),i([s({readOnly:!0})],ji.prototype,"inverseDensity",null),i([s()],ji.prototype,"maximumPointCount",void 0),i([s({readOnly:!0})],ji.prototype,"availableFields",null),i([s({readOnly:!0})],ji.prototype,"_clippingBox",null),i([s({readOnly:!0})],ji.prototype,"_elevationOffset",null),i([s({type:Boolean})],ji.prototype,"slicePlaneEnabled",void 0),i([s()],ji.prototype,"updating",void 0),i([s(dt)],ji.prototype,"updatingProgress",void 0),i([s({readOnly:!0})],ji.prototype,"updatingProgressValue",null),ji=i([e("esri.views.3d.layers.PointCloudLayerView3D")],ji);const Ai=L(),Oi=160,Ni=Object.freeze({__proto__:null,default:ji});export{Ni as P,mi as r}