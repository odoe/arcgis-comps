import{e as t,d as e,w as i,i as s,z as n,n as r,s as o,A as a,c4 as h,k as l,b8 as u,bw as c,af as d,bB as f,U as v,c0 as p,aA as m,m as w,b6 as g,a$ as y,O as b,c5 as k,F as S,a5 as I,a_ as _,c6 as A,aU as T,ag as O,c7 as x,c8 as j}from"./p-9ae46e68.js";import{e as U}from"./p-ada83011.js";import{a as E}from"./p-fe01b82b.js";import"./p-84bf99cb.js";const D="esri-identity-form__group",C="esri-identity-form__label";let N=class extends n{constructor(t,e){super(t,e),this._usernameInputNode=null,this._passwordInputNode=null,this.messages=null,this.signingIn=!1,this.server=null,this.resource=null,this.error=null,this.oAuthPrompt=!1}render(){const{error:t,server:e,resource:i,signingIn:s,oAuthPrompt:n,messages:h}=this,l=r("div",{class:D},o(n?h.oAuthInfo:h.info,{server:/\.arcgis\.com/i.test(e)?"ArcGIS Online":e,resource:`(${i||h.lblItem})`})),u=n?null:r("div",{class:D,key:"username"},r("label",{class:C},h.lblUser,r("input",{value:"",required:!0,autocomplete:"off",spellcheck:!1,type:"text",bind:this,afterCreate:a,"data-node-ref":"_usernameInputNode",class:"esri-input"}))),c=n?null:r("div",{class:D,key:"password"},r("label",{class:C},h.lblPwd,r("input",{value:"",required:!0,type:"password",bind:this,afterCreate:a,"data-node-ref":"_passwordInputNode",class:"esri-input"}))),d=r("div",{class:this.classes(D,"esri-identity-form__footer")},r("input",{type:"submit",disabled:!!s,value:s?h.lblSigning:h.lblOk,class:"esri-button"}),r("input",{type:"button",value:h.lblCancel,bind:this,onclick:this._cancel,class:this.classes("esri-button","esri-button--secondary")})),f=t?r("div",null,t.details&&t.details.httpStatus?h.invalidUser:h.noAuthService):null;return r("form",{class:"esri-identity-form",bind:this,onsubmit:this._submit},l,f,u,c,d)}_cancel(){this._set("signingIn",!1),this._usernameInputNode&&(this._usernameInputNode.value=""),this._passwordInputNode&&(this._passwordInputNode.value=""),this.emit("cancel")}_submit(t){t.preventDefault(),this._set("signingIn",!0),this.emit("submit",this.oAuthPrompt?{}:{username:this._usernameInputNode&&this._usernameInputNode.value,password:this._passwordInputNode&&this._passwordInputNode.value})}};t([e(),i("esri/identity/t9n/identity")],N.prototype,"messages",void 0),t([e()],N.prototype,"signingIn",void 0),t([e()],N.prototype,"server",void 0),t([e()],N.prototype,"resource",void 0),t([e()],N.prototype,"error",void 0),t([e()],N.prototype,"oAuthPrompt",void 0),N=t([s("esri.identity.IdentityForm")],N);const F=N;
/*!
* tabbable 5.2.1
* @license MIT, https://github.com/focus-trap/tabbable/blob/master/LICENSE
*/var P=["input","select","textarea","a[href]","button","[tabindex]","audio[controls]","video[controls]",'[contenteditable]:not([contenteditable="false"])',"details>summary:first-of-type","details"],R=P.join(","),q="undefined"==typeof Element?function(){}:Element.prototype.matches||Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector,B=function(t){var e=parseInt(t.getAttribute("tabindex"),10);return isNaN(e)?function(t){return"true"===t.contentEditable}(t)?0:"AUDIO"!==t.nodeName&&"VIDEO"!==t.nodeName&&"DETAILS"!==t.nodeName||null!==t.getAttribute("tabindex")?t.tabIndex:0:e},M=function(t,e){return t.tabIndex===e.tabIndex?t.documentOrder-e.documentOrder:t.tabIndex-e.tabIndex},$=function(t){return"INPUT"===t.tagName},z=function(t,e){return!(e.disabled||function(t){return $(t)&&"hidden"===t.type}(e)||function(t,e){if("hidden"===getComputedStyle(t).visibility)return!0;var i=q.call(t,"details>summary:first-of-type");if(q.call(i?t.parentElement:t,"details:not([open]) *"))return!0;if(e&&"full"!==e){if("non-zero-area"===e){var s=t.getBoundingClientRect();return 0===s.width&&0===s.height}}else for(;t;){if("none"===getComputedStyle(t).display)return!0;t=t.parentElement}return!1}(e,t.displayCheck)||function(t){return"DETAILS"===t.tagName&&Array.prototype.slice.apply(t.children).some((function(t){return"SUMMARY"===t.tagName}))}(e)||function(t){if($(t)||"SELECT"===t.tagName||"TEXTAREA"===t.tagName||"BUTTON"===t.tagName)for(var e=t.parentElement;e;){if("FIELDSET"===e.tagName&&e.disabled){for(var i=0;i<e.children.length;i++){var s=e.children.item(i);if("LEGEND"===s.tagName)return!s.contains(t)}return!0}e=e.parentElement}return!1}(e))},L=function(t,e){return!(!z(t,e)||function(t){return function(t){return $(t)&&"radio"===t.type}(t)&&!function(t){if(!t.name)return!0;var e,i=t.form||t.ownerDocument,s=function(t){return i.querySelectorAll('input[type="radio"][name="'+t+'"]')};if("undefined"!=typeof window&&void 0!==window.CSS&&"function"==typeof window.CSS.escape)e=s(window.CSS.escape(t.name));else try{e=s(t.name)}catch(t){return console.error("Looks like you have a radio button with a name attribute containing invalid CSS selector characters and need the CSS.escape polyfill: %s",t.message),!1}var n=function(t,e){for(var i=0;i<t.length;i++)if(t[i].checked&&t[i].form===e)return t[i]}(e,t.form);return!n||n===t}(t)}(e)||B(e)<0)},G=P.concat("iframe").join(","),J=function(t,e){if(e=e||{},!t)throw new Error("No node provided");return!1!==q.call(t,G)&&z(e,t)};
/*!
* focus-trap 6.7.1
* @license MIT, https://github.com/focus-trap/focus-trap/blob/master/LICENSE
*/
function H(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,s)}return i}function V(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}var Y,X=(Y=[],{activateTrap:function(t){if(Y.length>0){var e=Y[Y.length-1];e!==t&&e.pause()}var i=Y.indexOf(t);-1===i||Y.splice(i,1),Y.push(t)},deactivateTrap:function(t){var e=Y.indexOf(t);-1!==e&&Y.splice(e,1),Y.length>0&&Y[Y.length-1].unpause()}}),W=function(t){return setTimeout(t,0)},K=function(t,e){var i=-1;return t.every((function(t,s){return!e(t)||(i=s,!1)})),i},Q=function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];return"function"==typeof t?t.apply(void 0,i):t},Z=function(t){return t.target.shadowRoot&&"function"==typeof t.composedPath?t.composedPath()[0]:t.target},tt=function(t,e){var i,s=(null==e?void 0:e.document)||document,n=function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?H(Object(i),!0).forEach((function(e){V(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):H(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}({returnFocusOnDeactivate:!0,escapeDeactivates:!0,delayInitialFocus:!0},e),r={containers:[],tabbableGroups:[],nodeFocusedBeforeActivation:null,mostRecentlyFocusedNode:null,active:!1,paused:!1,delayInitialFocusTimer:void 0},o=function(t,e,i){return t&&void 0!==t[e]?t[e]:n[i||e]},a=function(t){return!(!t||!r.containers.some((function(e){return e.contains(t)})))},h=function(t){var e=n[t];if("function"==typeof e){for(var i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];e=e.apply(void 0,r)}if(!e){if(void 0===e||!1===e)return e;throw new Error("`".concat(t,"` was specified but was not a node, or did not return a node"))}var a=e;if("string"==typeof e&&!(a=s.querySelector(e)))throw new Error("`".concat(t,"` as selector refers to no known node"));return a},l=function(){var t=h("initialFocus");if(!1===t)return!1;if(void 0===t)if(a(s.activeElement))t=s.activeElement;else{var e=r.tabbableGroups[0];t=e&&e.firstTabbableNode||h("fallbackFocus")}if(!t)throw new Error("Your focus-trap needs to have at least one focusable element");return t},u=function(){if(r.tabbableGroups=r.containers.map((function(t){var e,i,s,n=(i=[],s=[],function(t,e,i){var s=Array.prototype.slice.apply(t.querySelectorAll(R));return e&&q.call(t,R)&&s.unshift(t),s.filter(i)}(t,(e=e||{}).includeContainer,L.bind(null,e)).forEach((function(t,e){var n=B(t);0===n?i.push(t):s.push({documentOrder:e,tabIndex:n,node:t})})),s.sort(M).map((function(t){return t.node})).concat(i));if(n.length>0)return{container:t,firstTabbableNode:n[0],lastTabbableNode:n[n.length-1]}})).filter((function(t){return!!t})),r.tabbableGroups.length<=0&&!h("fallbackFocus"))throw new Error("Your focus-trap must have at least one container with at least one tabbable node in it at all times")},c=function t(e){!1!==e&&e!==s.activeElement&&(e&&e.focus?(e.focus({preventScroll:!!n.preventScroll}),r.mostRecentlyFocusedNode=e,function(t){return t.tagName&&"input"===t.tagName.toLowerCase()&&"function"==typeof t.select}(e)&&e.select()):t(l()))},d=function(t){var e=h("setReturnFocus",t);return e||!1!==e&&t},f=function(t){var e=Z(t);a(e)||(Q(n.clickOutsideDeactivates,t)?i.deactivate({returnFocus:n.returnFocusOnDeactivate&&!J(e)}):Q(n.allowOutsideClick,t)||t.preventDefault())},v=function(t){var e=Z(t),i=a(e);i||e instanceof Document?i&&(r.mostRecentlyFocusedNode=e):(t.stopImmediatePropagation(),c(r.mostRecentlyFocusedNode||l()))},p=function(t){if(function(t){return"Escape"===t.key||"Esc"===t.key||27===t.keyCode}(t)&&!1!==Q(n.escapeDeactivates,t))return t.preventDefault(),void i.deactivate();(function(t){return"Tab"===t.key||9===t.keyCode})(t)&&function(t){var e=Z(t);u();var i=null;if(r.tabbableGroups.length>0){var s=K(r.tabbableGroups,(function(t){return t.container.contains(e)}));if(s<0)i=t.shiftKey?r.tabbableGroups[r.tabbableGroups.length-1].lastTabbableNode:r.tabbableGroups[0].firstTabbableNode;else if(t.shiftKey){var n=K(r.tabbableGroups,(function(t){return e===t.firstTabbableNode}));n<0&&r.tabbableGroups[s].container===e&&(n=s),n>=0&&(i=r.tabbableGroups[0===n?r.tabbableGroups.length-1:n-1].lastTabbableNode)}else{var o=K(r.tabbableGroups,(function(t){return e===t.lastTabbableNode}));o<0&&r.tabbableGroups[s].container===e&&(o=s),o>=0&&(i=r.tabbableGroups[o===r.tabbableGroups.length-1?0:o+1].firstTabbableNode)}}else i=h("fallbackFocus");i&&(t.preventDefault(),c(i))}(t)},m=function(t){if(!Q(n.clickOutsideDeactivates,t)){var e=Z(t);a(e)||Q(n.allowOutsideClick,t)||(t.preventDefault(),t.stopImmediatePropagation())}},w=function(){if(r.active)return X.activateTrap(i),r.delayInitialFocusTimer=n.delayInitialFocus?W((function(){c(l())})):c(l()),s.addEventListener("focusin",v,!0),s.addEventListener("mousedown",f,{capture:!0,passive:!1}),s.addEventListener("touchstart",f,{capture:!0,passive:!1}),s.addEventListener("click",m,{capture:!0,passive:!1}),s.addEventListener("keydown",p,{capture:!0,passive:!1}),i},g=function(){if(r.active)return s.removeEventListener("focusin",v,!0),s.removeEventListener("mousedown",f,!0),s.removeEventListener("touchstart",f,!0),s.removeEventListener("click",m,!0),s.removeEventListener("keydown",p,!0),i};return(i={activate:function(t){if(r.active)return this;var e=o(t,"onActivate"),i=o(t,"onPostActivate"),n=o(t,"checkCanFocusTrap");n||u(),r.active=!0,r.paused=!1,r.nodeFocusedBeforeActivation=s.activeElement,e&&e();var a=function(){n&&u(),w(),i&&i()};return n?(n(r.containers.concat()).then(a,a),this):(a(),this)},deactivate:function(t){if(!r.active)return this;clearTimeout(r.delayInitialFocusTimer),r.delayInitialFocusTimer=void 0,g(),r.active=!1,r.paused=!1,X.deactivateTrap(i);var e=o(t,"onDeactivate"),s=o(t,"onPostDeactivate"),n=o(t,"checkCanReturnFocus");e&&e();var a=o(t,"returnFocus","returnFocusOnDeactivate"),h=function(){W((function(){a&&c(d(r.nodeFocusedBeforeActivation)),s&&s()}))};return a&&n?(n(d(r.nodeFocusedBeforeActivation)).then(h,h),this):(h(),this)},pause:function(){return r.paused||!r.active||(r.paused=!0,g()),this},unpause:function(){return r.paused&&r.active?(r.paused=!1,u(),w(),this):this},updateContainerElements:function(t){var e=[].concat(t).filter(Boolean);return r.containers=e.map((function(t){return"string"==typeof t?s.querySelector(t):t})),r.active&&u(),this}}).updateContainerElements(t),i};const et="esri-identity-modal__content";let it=class extends n{constructor(t,e){super(t,e),this.container=document.createElement("div"),this.content=null,this.open=!1,this._close=()=>{this.open=!1},document.body.appendChild(this.container),this.own(this.watch("open",(()=>this._toggleFocusTrap())))}destroy(){this._destroyFocusTrap()}render(){const t=this.id,{open:e,content:i,title:s,messages:n}=this,o=e&&!!i,a={"esri-identity-modal--open":o,"esri-identity-modal--closed":!o},h=r("button",{class:"esri-identity-modal__close-button","aria-label":n.close,title:n.close,bind:this,onclick:this._close},r("span",{"aria-hidden":"true",class:"esri-icon-close"})),l=`${t}_title`,u=`${t}_content`,c=s?r("h1",{id:l,class:"esri-identity-modal__title"},s):null,d=o?r("div",{bind:this,class:"esri-identity-modal__dialog",role:"dialog","aria-labelledby":l,"aria-describedby":u,afterCreate:this._createFocusTrap},h,c,this._renderContent(u)):null;return r("div",{tabIndex:-1,class:this.classes("esri-identity-modal",a)},d)}_destroyFocusTrap(){var t;null==(t=this._focusTrap)||t.deactivate({onDeactivate:null}),this._focusTrap=null}_toggleFocusTrap(){const{_focusTrap:t,open:e}=this;t&&(e?t.activate():t.deactivate())}_createFocusTrap(t){this._destroyFocusTrap();const e=requestAnimationFrame((()=>{this._focusTrap=tt(t,{initialFocus:"input",onDeactivate:this._close}),this._toggleFocusTrap()}));this.own(h((()=>cancelAnimationFrame(e))))}_renderContent(t){const e=this.content;return"string"==typeof e?r("div",{class:et,id:t,innerHTML:e}):U(e)?r("div",{class:et,id:t},e.render()):e instanceof HTMLElement?r("div",{class:et,id:t,bind:e,afterCreate:this._attachToNode}):null}_attachToNode(t){t.appendChild(this)}};t([e({readOnly:!0})],it.prototype,"container",void 0),t([e()],it.prototype,"content",void 0),t([e()],it.prototype,"open",void 0),t([e(),i("esri/t9n/common")],it.prototype,"messages",void 0),t([e({aliasOf:"messages.auth.signIn"})],it.prototype,"title",void 0),it=t([s("esri.identity.IdentityModal")],it);const st=it,nt="esriJSAPIOAuth";class rt{constructor(t,e){this.oAuthInfo=null,this.storage=null,this.appId=null,this.expires=null,this.ssl=null,this.token=null,this.userId=null,this.oAuthInfo=t,this.storage=e,this._init()}isValid(){let t=!1;if(this.oAuthInfo&&this.token&&this.userId){const e=Date.now();this.expires>e&&(this.expires-e)/1e3>60*this.oAuthInfo.minTimeUntilExpiration&&(t=!0)}return t}save(){if(!this.storage)return;const t=this._load(),e=this.oAuthInfo;if(e&&e.authNamespace&&e.portalUrl){let i=t[e.authNamespace];i||(i=t[e.authNamespace]={}),i[e.portalUrl]={appId:this.appId=e.appId,expires:this.expires,ssl:this.ssl,token:this.token,userId:this.userId};try{this.storage.setItem(nt,JSON.stringify(t))}catch(t){console.log(t)}}}destroy(){const t=this._load(),e=this.oAuthInfo;if(e&&e.appId&&e.portalUrl&&this.token&&this.expires>Date.now()){const t=e.portalUrl.replace(/^http:/i,"https:")+"/sharing/rest/oauth2/revokeToken",i=new FormData;if(i.append("f","json"),i.append("auth_token",this.token),i.append("client_id",e.appId),i.append("token_type_hint","access_token"),"function"==typeof navigator.sendBeacon)navigator.sendBeacon(t,i);else{const e=new XMLHttpRequest;e.open("POST",t),e.send(i)}}if(e&&e.authNamespace&&e.portalUrl&&this.storage){const i=t[e.authNamespace];if(i){delete i[e.portalUrl];try{this.storage.setItem(nt,JSON.stringify(t))}catch(t){console.log(t)}}}e&&(e._oAuthCred=null,this.oAuthInfo=null)}_init(){const t=this._load(),e=this.oAuthInfo;if(e&&e.authNamespace&&e.portalUrl){let i=t[e.authNamespace];i&&(i=i[e.portalUrl],i&&(this.appId=i.appId,this.expires=i.expires,this.ssl=i.ssl,this.token=i.token,this.userId=i.userId))}}_load(){let t={};if(this.storage){const e=this.storage.getItem(nt);if(e)try{t=JSON.parse(e)}catch(t){console.log(t)}}return t}}var ot;rt.prototype.declaredClass="esri.identity.OAuthCredential";let at=ot=class extends E{constructor(t){super(t),this._oAuthCred=null,this.appId=null,this.authNamespace="/",this.expiration=20160,this.forceLogin=!1,this.forceUserId=!1,this.locale=null,this.minTimeUntilExpiration=30,this.popup=!1,this.popupCallbackUrl="oauth-callback.html",this.popupWindowFeatures="height=490,width=800,resizable,scrollbars,status",this.portalUrl="https://www.arcgis.com",this.preserveUrlHash=!1,this.userId=null}clone(){return ot.fromJSON(this.toJSON())}};t([e({json:{write:!0}})],at.prototype,"appId",void 0),t([e({json:{write:!0}})],at.prototype,"authNamespace",void 0),t([e({json:{write:!0}})],at.prototype,"expiration",void 0),t([e({json:{write:!0}})],at.prototype,"forceLogin",void 0),t([e({json:{write:!0}})],at.prototype,"forceUserId",void 0),t([e({json:{write:!0}})],at.prototype,"locale",void 0),t([e({json:{write:!0}})],at.prototype,"minTimeUntilExpiration",void 0),t([e({json:{write:!0}})],at.prototype,"popup",void 0),t([e({json:{write:!0}})],at.prototype,"popupCallbackUrl",void 0),t([e({json:{write:!0}})],at.prototype,"popupWindowFeatures",void 0),t([e({json:{write:!0}})],at.prototype,"portalUrl",void 0),t([e({json:{write:!0}})],at.prototype,"preserveUrlHash",void 0),t([e({json:{write:!0}})],at.prototype,"userId",void 0),at=ot=t([s("esri.identity.OAuthInfo")],at);const ht=at;let lt=class extends E{constructor(t){super(t),this.adminTokenServiceUrl=null,this.currentVersion=null,this.hasPortal=null,this.hasServer=null,this.owningSystemUrl=null,this.owningTenant=null,this.server=null,this.shortLivedTokenValidity=null,this.tokenServiceUrl=null,this.webTierAuth=null}};t([e({json:{write:!0}})],lt.prototype,"adminTokenServiceUrl",void 0),t([e({json:{write:!0}})],lt.prototype,"currentVersion",void 0),t([e({json:{write:!0}})],lt.prototype,"hasPortal",void 0),t([e({json:{write:!0}})],lt.prototype,"hasServer",void 0),t([e({json:{write:!0}})],lt.prototype,"owningSystemUrl",void 0),t([e({json:{write:!0}})],lt.prototype,"owningTenant",void 0),t([e({json:{write:!0}})],lt.prototype,"server",void 0),t([e({json:{write:!0}})],lt.prototype,"shortLivedTokenValidity",void 0),t([e({json:{write:!0}})],lt.prototype,"tokenServiceUrl",void 0),t([e({json:{write:!0}})],lt.prototype,"webTierAuth",void 0),lt=t([s("esri.identity.ServerInfo")],lt);const ut=lt,ct={},dt=t=>{const e=new d(t.owningSystemUrl).host,i=new d(t.server).host,s=/.+\.arcgis\.com$/i;return s.test(e)&&s.test(i)},ft=(t,e)=>!!(dt(t)&&e&&e.some((e=>e.test(t.server))));let vt=null,pt=null;try{vt=window.localStorage,pt=window.sessionStorage}catch{}class mt extends l{constructor(){super(),this._portalConfig=f.esriGeowConfig,this.serverInfos=[],this.oAuthInfos=[],this.credentials=[],this._soReqs=[],this._xoReqs=[],this._portals=[],this.defaultOAuthInfo=null,this.defaultTokenValidity=60,this.dialog=null,this.formConstructor=F,this.tokenValidity=null,this.normalizeWebTierAuth=!1,this._appOrigin="null"!==window.origin?window.origin:window.location.origin,this._appUrlObj=v(window.location.href),this._busy=null,this._rejectOnPersistedPageShow=!1,this._oAuthHash=null,this._gwTokenUrl="/sharing/rest/generateToken",this._agsRest="/rest/services",this._agsPortal=/\/sharing(\/|$)/i,this._agsAdmin=/(https?:\/\/[^\/]+\/[^\/]+)\/admin\/?(\/.*)?$/i,this._adminSvcs=/\/rest\/admin\/services(\/|$)/i,this._gwDomains=[{regex:/^https?:\/\/www\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:dev|[a-z\d-]+\.mapsdev)\.arcgis\.com/i,customBaseUrl:"mapsdev.arcgis.com",tokenServiceUrl:"https://dev.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:devext|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,customBaseUrl:"mapsdevext.arcgis.com",tokenServiceUrl:"https://devext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:qaext|[a-z\d-]+\.mapsqa)\.arcgis\.com/i,customBaseUrl:"mapsqa.arcgis.com",tokenServiceUrl:"https://qaext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/[a-z\d-]+\.maps\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"}],this._legacyFed=[],this._regexSDirUrl=/http.+\/rest\/services\/?/gi,this._regexServerType=/(\/(FeatureServer|GPServer|GeoDataServer|GeocodeServer|GeoenrichmentServer|GeometryServer|GlobeServer|ImageServer|MapServer|MobileServer|NAServer|NetworkDiagramServer|OGCFeatureServer|ParcelFabricServer|RelationalCatalogServer|SceneServer|StreamServer|UtilityNetworkServer|ValidationServer|VectorTileServer|VersionManagementServer)).*/gi,this._gwUser=/http.+\/users\/([^\/]+)\/?.*/i,this._gwItem=/http.+\/items\/([^\/]+)\/?.*/i,this._gwGroup=/http.+\/groups\/([^\/]+)\/?.*/i,this._rePortalTokenSvc=/\/sharing(\/rest)?\/generatetoken/i,this._createDefaultOAuthInfo=!0,this._hasTestedIfAppIsOnPortal=!1,this._getOAuthHash(),window.addEventListener("pageshow",(t=>{this._pageShowHandler(t)}))}registerServers(t){const e=this.serverInfos;e?(t=t.filter((t=>!this.findServerInfo(t.server))),this.serverInfos=e.concat(t)):this.serverInfos=t,t.forEach((t=>{t.owningSystemUrl&&this._portals.push(t.owningSystemUrl),t.hasPortal&&this._portals.push(t.server)}))}registerOAuthInfos(t){const e=this.oAuthInfos;if(e){for(const i of t){const t=this.findOAuthInfo(i.portalUrl);t&&e.splice(e.indexOf(t),1)}this.oAuthInfos=e.concat(t)}else this.oAuthInfos=t}registerToken(t){t={...t};const e=this._sanitizeUrl(t.server),i=this._isServerRsrc(e);let s,n=this.findServerInfo(e),r=!0;n||(n=new ut,n.server=this._getServerInstanceRoot(e),i?n.hasServer=!0:(n.tokenServiceUrl=this._getTokenSvcUrl(e),n.hasPortal=!0),this.registerServers([n])),s=this._findCredential(e),s?(delete t.server,Object.assign(s,t),r=!1):(s=new wt({userId:t.userId,server:n.server,token:t.token,expires:t.expires,ssl:t.ssl,scope:i?"server":"portal"}),s.resources=[e],this.credentials.push(s)),s.emitTokenChange(!1),r||s.refreshServerTokens()}toJSON(){return c({serverInfos:this.serverInfos.map((t=>t.toJSON())),oAuthInfos:this.oAuthInfos.map((t=>t.toJSON())),credentials:this.credentials.map((t=>t.toJSON()))})}initialize(t){if(!t)return;"string"==typeof t&&(t=JSON.parse(t));const e=t.serverInfos,i=t.oAuthInfos,s=t.credentials;if(e){const t=[];e.forEach((e=>{e.server&&e.tokenServiceUrl&&t.push(e.declaredClass?e:new ut(e))})),t.length&&this.registerServers(t)}if(i){const t=[];i.forEach((e=>{e.appId&&t.push(e.declaredClass?e:new ht(e))})),t.length&&this.registerOAuthInfos(t)}s&&s.forEach((t=>{t.server&&t.token&&t.expires&&t.expires>Date.now()&&((t=t.declaredClass?t:new wt(t)).emitTokenChange(),this.credentials.push(t))}))}findServerInfo(t){let e;t=this._sanitizeUrl(t);for(const i of this.serverInfos)if(this._hasSameServerInstance(i.server,t)){e=i;break}return e}findOAuthInfo(t){let e;t=this._sanitizeUrl(t);for(const i of this.oAuthInfos)if(this._hasSameServerInstance(i.portalUrl,t)){e=i;break}return e}findCredential(t,e){let i;t=this._sanitizeUrl(t);const s=this._isServerRsrc(t)?"server":"portal";if(e){for(const n of this.credentials)if(this._hasSameServerInstance(n.server,t)&&e===n.userId&&n.scope===s){i=n;break}}else for(const e of this.credentials)if(this._hasSameServerInstance(e.server,t)&&-1!==this._getIdenticalSvcIdx(t,e)&&e.scope===s){i=e;break}return i}getCredential(t,e){let i,s,n=!0;e&&(i=!!e.token,s=e.error,n=!1!==e.prompt),e={...e},t=this._sanitizeUrl(t);const r=new AbortController,o=p();if(e.signal&&m(e.signal,(()=>{r.abort()})),m(r,(()=>{o.reject(new w("identity-manager:user-aborted","ABORTED"))})),g(r))return o.promise;e.signal=r.signal;const a=this._isAdminResource(t),h=i?this.findCredential(t):null;let l;if(h&&s&&s.details&&498===s.details.httpStatus)h.destroy();else if(h)return l=new w("identity-manager:not-authorized","You are currently signed in as: '"+h.userId+"'. You do not have access to this resource: "+t,{error:s}),o.reject(l),o.promise;const u=this._findCredential(t,e);if(u)return o.resolve(u),o.promise;let c=this.findServerInfo(t);if(c)!c.hasServer&&this._isServerRsrc(t)&&(c._restInfoPms=this._getTokenSvcUrl(t),c.hasServer=!0);else{const e=this._getTokenSvcUrl(t);if(!e)return l=new w("identity-manager:unknown-resource","Unknown resource - could not find token service endpoint."),o.reject(l),o.promise;c=new ut,c.server=this._getServerInstanceRoot(t),"string"==typeof e?(c.tokenServiceUrl=e,c.hasPortal=!0):(c._restInfoPms=e,c.hasServer=!0),this.registerServers([c])}return c.hasPortal&&void 0===c._selfReq&&(n||y(c.tokenServiceUrl,this._appOrigin)||this._gwDomains.some((t=>t.tokenServiceUrl===c.tokenServiceUrl)))&&(c._selfReq={owningTenant:e&&e.owningTenant,selfDfd:this._getPortalSelf(c.tokenServiceUrl.replace(this._rePortalTokenSvc,"/sharing/rest/portals/self"),t)}),this._enqueue(t,c,e,o,a)}getResourceName(t){return this._isRESTService(t)?t.replace(this._regexSDirUrl,"").replace(this._regexServerType,"")||"":this._gwUser.test(t)&&t.replace(this._gwUser,"$1")||this._gwItem.test(t)&&t.replace(this._gwItem,"$1")||this._gwGroup.test(t)&&t.replace(this._gwGroup,"$1")||""}generateToken(t,e,i){const s=this._rePortalTokenSvc.test(t.tokenServiceUrl),n=new d(this._appOrigin),r=t.shortLivedTokenValidity;let o,a,h,l,u,c,f,v;e&&(v=this.tokenValidity||r||this.defaultTokenValidity,v>r&&r>0&&(v=r)),i&&(o=i.isAdmin,a=i.serverUrl,h=i.token,c=i.signal,f=i.ssl,t.customParameters=i.customParameters),o?l=t.adminTokenServiceUrl:(l=t.tokenServiceUrl,u=new d(l.toLowerCase()),t.webTierAuth&&null!=i&&i.serverUrl&&!f&&"http"===n.scheme&&(y(n.uri,l,!0)||"https"===u.scheme&&n.host===u.host&&"7080"===n.port&&"7443"===u.port)&&(l=l.replace(/^https:/i,"http:").replace(/:7443/i,":7080")));const p={query:{request:"getToken",username:null==e?void 0:e.username,password:null==e?void 0:e.password,serverUrl:a,token:h,expiration:v,referer:o||s?this._appOrigin:null,client:o?"referer":null,f:"json",...t.customParameters},method:"post",authMode:"anonymous",useProxy:this._useProxy(t,i),signal:c,...null==i?void 0:i.ioArgs};return s||(p.withCredentials=!1),b(l,p).then((i=>{const s=i.data;if(!s||!s.token)return new w("identity-manager:authentication-failed","Unable to generate token");const n=t.server;return ct[n]||(ct[n]={}),e&&(ct[n][e.username]=e.password),s.validity=v,s}))}isBusy(){return!!this._busy}checkSignInStatus(t){return this.checkAppAccess(t,"").then((t=>t.credential))}checkAppAccess(t,e,i){let s=!1;return this.getCredential(t,{prompt:!1}).then((n=>{let r;const o={f:"json"};if("portal"===n.scope)if(e&&(this._doPortalSignIn(t)||i&&i.force))r=n.server+"/sharing/rest/oauth2/validateAppAccess",o.client_id=e;else{if(!n.token)return{credential:n};r=n.server+"/sharing/rest"}else{if(!n.token)return{credential:n};r=n.server+"/rest/services"}return n.token&&(o.token=n.token),b(r,{query:o,authMode:"anonymous"}).then((t=>{if(!1===t.data.valid)throw new w("identity-manager:not-authorized",`You are currently signed in as: '${n.userId}'.`,t.data);return s=!!t.data.viewOnlyUserTypeApp,{credential:n}})).catch((t=>{if("identity-manager:not-authorized"===t.name)throw t;const e=t.details&&t.details.httpStatus;if(498===e)throw n.destroy(),new w("identity-manager:not-authenticated","User is not signed in.");if(400===e)throw new w("identity-manager:invalid-request");return{credential:n}}))})).then((t=>({credential:t.credential,viewOnly:s})))}setOAuthResponseHash(t){var e;const i=this._oAuthDfd;if(this._oAuthDfd=null,!i||!t)return;clearInterval(this._oAuthIntervalId),null==(e=this._oAuthOnHashHandle)||e.remove(),"#"===t.charAt(0)&&(t=t.substring(1));const s=k(t);if(s.error){const t="access_denied"===s.error,e=new w(t?"identity-manager:user-aborted":"identity-manager:authentication-failed",t?"ABORTED":"OAuth: "+s.error+" - "+s.error_description);i.reject(e)}else{const t=i.oinfo_,e=t._oAuthCred,n=new wt({userId:s.username,server:i.sinfo_.server,token:s.access_token,expires:Date.now()+1e3*Number(s.expires_in),ssl:"true"===s.ssl,_oAuthCred:e});t.userId=n.userId,e.storage=s.persist?vt:pt,e.token=n.token,e.expires=n.expires,e.userId=n.userId,e.ssl=n.ssl,e.save(),i.resolve(n)}}setOAuthRedirectionHandler(t){this._oAuthRedirectFunc=t}setProtocolErrorHandler(t){this._protocolFunc=t}signIn(t,e,i={}){const s=p(),n=()=>{var t,e,i,s,n;null==(t=a)||t.remove(),null==(e=h)||e.remove(),null==(i=l)||i.remove(),null==(s=o)||s.destroy(),null==(n=this.dialog)||n.destroy(),this.dialog=o=a=h=l=null},r=()=>{n(),this._oAuthDfd=null,s.reject(new w("identity-manager:user-aborted","ABORTED"))};i.signal&&m(i.signal,(()=>{r()}));let o=new this.formConstructor;o.resource=this.getResourceName(t),o.server=e.server,this.dialog=new st,this.dialog.content=o,this.dialog.open=!0,this.emit("dialog-create");let a=o.on("cancel",r),h=this.dialog.watch("open",r),l=o.on("submit",(t=>{this.generateToken(e,t,{isAdmin:i.isAdmin,signal:i.signal}).then((r=>{n();const o=new wt({userId:t.username,server:e.server,token:r.token,expires:null!=r.expires?Number(r.expires):null,ssl:!!r.ssl,isAdmin:i.isAdmin,validity:r.validity});s.resolve(o)})).catch((t=>{o.error=t,o.signingIn=!1}))}));return s.promise}oAuthSignIn(t,e,i,s){this._oAuthDfd=p();const n=this._oAuthDfd;if(null!=s&&s.signal&&m(s.signal,(()=>{const t=this._oAuthDfd&&this._oAuthDfd.oAuthWin_;t&&!t.closed?t.close():this.dialog&&o()})),n.resUrl_=t,n.sinfo_=e,n.oinfo_=i,!i.popup||s&&!1===s.oAuthPopupConfirmation)return this._doOAuthSignIn(t,e,i),n.promise;const r=new this.formConstructor;r.oAuthPrompt=!0,r.server=e.server,this.dialog=new st,this.dialog.content=r,this.dialog.open=!0,this.emit("dialog-create");const o=()=>{u(),this._oAuthDfd=null,n.reject(new w("identity-manager:user-aborted","ABORTED"))},a=r.on("cancel",o),h=this.dialog.watch("open",o),l=r.on("submit",(()=>{u(),this._doOAuthSignIn(t,e,i)})),u=()=>{a.remove(),h.remove(),l.remove(),r.destroy(),this.dialog.destroy(),this.dialog=null};return n.promise}destroyCredentials(){this.credentials&&this.credentials.slice().forEach((t=>{t.destroy()})),this.emit("credentials-destroy")}enablePostMessageAuth(t="https://www.arcgis.com/sharing/rest"){this._postMessageAuthHandle&&this._postMessageAuthHandle.remove(),this._postMessageAuthHandle=S(window,"message",(e=>{var i;if((e.origin===this._appOrigin||e.origin.endsWith(".arcgis.com"))&&"arcgis:auth:requestCredential"===(null==(i=e.data)?void 0:i.type)){const i=e.source;this.getCredential(t).then((t=>{i.postMessage({type:"arcgis:auth:credential",credential:{expires:t.expires,server:t.server,ssl:t.ssl,token:t.token,userId:t.userId}},e.origin)})).catch((t=>{i.postMessage({type:"arcgis:auth:error",error:{name:t.name,message:t.message}},e.origin)}))}}))}disablePostMessageAuth(){this._postMessageAuthHandle&&(this._postMessageAuthHandle.remove(),this._postMessageAuthHandle=null)}_getOAuthHash(){let t=window.location.hash;if(t){"#"===t.charAt(0)&&(t=t.substring(1));const e=k(t);let i=!1;if(e.access_token&&e.expires_in&&e.state&&e.hasOwnProperty("username"))try{e.state=JSON.parse(e.state),"object"==typeof e.state&&e.state.portalUrl&&(this._oAuthHash=e,i=!0)}catch{}else e.error&&e.error_description&&(console.log("IdentityManager OAuth Error: ",e.error," - ",e.error_description),"access_denied"===e.error&&(i=!0));i&&(window.location.hash="object"==typeof e.state&&e.state.hash||"")}}_pageShowHandler(t){if(t.persisted&&this.isBusy()&&this._rejectOnPersistedPageShow){const t=new w("identity-manager:user-aborted","ABORTED");this._errbackFunc(t)}}_findCredential(t,e){let i,s,n,r,o=-1;const a=e&&e.token,h=e&&e.resource,l=this._isServerRsrc(t)?"server":"portal",u=this.credentials.filter((e=>this._hasSameServerInstance(e.server,t)&&e.scope===l));if(t=h||t,u.length)if(1===u.length){if(i=u[0],r=this.findServerInfo(i.server),s=r&&r.owningSystemUrl,n=s&&this.findCredential(s,i.userId),o=this._getIdenticalSvcIdx(t,i),!a)return-1===o&&i.resources.push(t),this._addResource(t,n),i;-1!==o&&(i.resources.splice(o,1),this._removeResource(t,n))}else{let e,i;if(u.some((a=>(i=this._getIdenticalSvcIdx(t,a),-1!==i&&(e=a,r=this.findServerInfo(e.server),s=r&&r.owningSystemUrl,n=s&&this.findCredential(s,e.userId),o=i,!0)))),a)e&&(e.resources.splice(o,1),this._removeResource(t,n));else if(e)return this._addResource(t,n),e}}_findOAuthInfo(t){let e=this.findOAuthInfo(t);if(!e)for(const i of this.oAuthInfos)if(this._isIdProvider(i.portalUrl,t)){e=i;break}return e}_addResource(t,e){e&&-1===this._getIdenticalSvcIdx(t,e)&&e.resources.push(t)}_removeResource(t,e){let i=-1;e&&(i=this._getIdenticalSvcIdx(t,e),i>-1&&e.resources.splice(i,1))}_useProxy(t,e){return e&&e.isAdmin&&!y(t.adminTokenServiceUrl,this._appOrigin)||!this._isPortalDomain(t.tokenServiceUrl)&&"10.1"===String(t.currentVersion)&&!y(t.tokenServiceUrl,this._appOrigin)}_getOrigin(t){const e=new d(t);return e.scheme+"://"+e.host+(null!=e.port?":"+e.port:"")}_getServerInstanceRoot(t){const e=t.toLowerCase();let i=e.indexOf(this._agsRest);return-1===i&&this._isAdminResource(t)&&(i=this._agsAdmin.test(t)?t.replace(this._agsAdmin,"$1").length:t.search(this._adminSvcs)),-1===i&&(i=e.indexOf("/sharing")),-1===i&&"/"===e.substr(-1)&&(i=e.length-1),i>-1?t.substring(0,i):t}_hasSameServerInstance(t,e){return"/"===t.substr(-1)&&(t=t.slice(0,-1)),t=t.toLowerCase(),e=this._getServerInstanceRoot(e).toLowerCase(),t=this._normalizeAGOLorgDomain(t),e=this._normalizeAGOLorgDomain(e),(t=t.substr(t.indexOf(":")))===e.substr(e.indexOf(":"))}_normalizeAGOLorgDomain(t){const e=/^https?:\/\/(?:cdn|[a-z\d-]+\.maps)\.arcgis\.com/i,i=/^https?:\/\/(?:cdndev|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,s=/^https?:\/\/(?:cdnqa|[a-z\d-]+\.mapsqa)\.arcgis\.com/i;return e.test(t)?t=t.replace(e,"https://www.arcgis.com"):i.test(t)?t=t.replace(i,"https://devext.arcgis.com"):s.test(t)&&(t=t.replace(s,"https://qaext.arcgis.com")),t}_sanitizeUrl(t){const e=(I.request.proxyUrl||"").toLowerCase(),i=e?t.toLowerCase().indexOf(e+"?"):-1;return-1!==i&&(t=t.substring(i+e.length+1)),t=_(t),v(t).path}_isRESTService(t){return t.indexOf(this._agsRest)>-1}_isAdminResource(t){return this._agsAdmin.test(t)||this._adminSvcs.test(t)}_isServerRsrc(t){return this._isRESTService(t)||this._isAdminResource(t)}_isIdenticalService(t,e){let i;if(this._isRESTService(t)&&this._isRESTService(e)){const s=this._getSuffix(t).toLowerCase(),n=this._getSuffix(e).toLowerCase();if(i=s===n,!i){const t=/(.*)\/(MapServer|FeatureServer|UtilityNetworkServer).*/gi;i=s.replace(t,"$1")===n.replace(t,"$1")}}else this._isAdminResource(t)&&this._isAdminResource(e)?i=!0:this._isServerRsrc(t)||this._isServerRsrc(e)||!this._isPortalDomain(t)||(i=!0);return i}_isPortalDomain(t){const e=new d(t.toLowerCase()),i=this._portalConfig;let s=this._gwDomains.some((t=>t.regex.test(e.uri)));return!s&&i&&(s=this._hasSameServerInstance(this._getServerInstanceRoot(i.restBaseUrl),e.uri)),s||I.portalUrl&&(s=y(e,I.portalUrl,!0)),s||(s=this._portals.some((t=>this._hasSameServerInstance(t,e.uri)))),s=s||this._agsPortal.test(e.path),s}_isIdProvider(t,e){let i=-1,s=-1;this._gwDomains.forEach(((n,r)=>{-1===i&&n.regex.test(t)&&(i=r),-1===s&&n.regex.test(e)&&(s=r)}));let n=!1;if(i>-1&&s>-1&&(0===i||4===i?0!==s&&4!==s||(n=!0):1===i?1!==s&&2!==s||(n=!0):2===i?2===s&&(n=!0):3===i&&3===s&&(n=!0)),!n){const i=this.findServerInfo(e),s=i&&i.owningSystemUrl;s&&dt(i)&&this._isPortalDomain(s)&&this._isIdProvider(t,s)&&(n=!0)}return n}_getIdenticalSvcIdx(t,e){let i=-1;for(let s=0;s<e.resources.length;s++)if(this._isIdenticalService(t,e.resources[s])){i=s;break}return i}_getSuffix(t){return t.replace(this._regexSDirUrl,"").replace(this._regexServerType,"$1")}_getTokenSvcUrl(t){let e,i,s;if(this._isRESTService(t)||this._isAdminResource(t)){const s=this._getServerInstanceRoot(t);return e=s+"/admin/generateToken",i=b(t=s+"/rest/info",{query:{f:"json"}}).then((t=>t.data)),{adminUrl:e,promise:i}}if(this._isPortalDomain(t)){let e="";if(this._gwDomains.some((i=>(i.regex.test(t)&&(e=i.tokenServiceUrl),!!e))),e||this._portals.some((i=>(this._hasSameServerInstance(i,t)&&(e=i+this._gwTokenUrl),!!e))),e||(s=t.toLowerCase().indexOf("/sharing"),-1!==s&&(e=t.substring(0,s)+this._gwTokenUrl)),e||(e=this._getOrigin(t)+this._gwTokenUrl),e){const i=new d(t).port;/^http:\/\//i.test(t)&&"7080"===i&&(e=e.replace(/:7080/i,":7443")),e=e.replace(/http:/i,"https:")}return e}if(-1!==t.toLowerCase().indexOf("premium.arcgisonline.com"))return"https://premium.arcgisonline.com/server/tokens"}_exchangeToken(t,e,i){return b(`${t}/sharing/rest/oauth2/exchangeToken`,{authMode:"anonymous",method:"post",query:{f:"json",client_id:e,token:i}}).then((t=>t.data.token))}_getPlatformSelf(t,e){return t=t.replace(/^http:/i,"https:"),b(`${t}/sharing/rest/oauth2/platformSelf`,{authMode:"anonymous",headers:{"X-Esri-Auth-Client-Id":e,"X-Esri-Auth-Redirect-Uri":window.location.href.replace(/#.*$/,"")},method:"post",query:{f:"json"},withCredentials:!0}).then((t=>t.data))}_getPortalSelf(t,e){let i;return this._gwDomains.some((e=>(e.regex.test(t)&&(i=e.customBaseUrl),!!i))),i?Promise.resolve({allSSL:!0,currentVersion:"4.4",customBaseUrl:i,portalMode:"multitenant",supportsOAuth:!0}):(this._appOrigin.startsWith("https:")?t=t.replace(/^http:/i,"https:").replace(/:7080/i,":7443"):/^http:/i.test(e)&&(t=t.replace(/^https:/i,"http:").replace(/:7443/i,":7080")),b(t,{query:{f:"json"},authMode:"anonymous",withCredentials:!0}).then((t=>t.data)))}_doPortalSignIn(t){const e=this._portalConfig,i=window.location.href,s=this.findServerInfo(t);return!(!e&&!this._isPortalDomain(i)||!(s?s.hasPortal||s.owningSystemUrl&&this._isPortalDomain(s.owningSystemUrl):this._isPortalDomain(t))||!(this._isIdProvider(i,t)||e&&(this._hasSameServerInstance(this._getServerInstanceRoot(e.restBaseUrl),t)||this._isIdProvider(e.restBaseUrl,t))||y(i,t,!0)))}_checkProtocol(t,e,i,s){let n=!0;const r=s?e.adminTokenServiceUrl:e.tokenServiceUrl;return r.trim().toLowerCase().startsWith("https:")&&!this._appOrigin.startsWith("https:")&&A(r)&&(n=!!this._protocolFunc&&!!this._protocolFunc({resourceUrl:t,serverInfo:e}),!n)&&i(new w("identity-manager:aborted","Aborted the Sign-In process to avoid sending password over insecure connection.")),n}_enqueue(t,e,i,s,n,r){return s||(s=p()),s.resUrl_=t,s.sinfo_=e,s.options_=i,s.admin_=n,s.refresh_=r,this._busy?this._hasSameServerInstance(this._getServerInstanceRoot(t),this._busy.resUrl_)?(this._oAuthDfd&&this._oAuthDfd.oAuthWin_&&this._oAuthDfd.oAuthWin_.focus(),this._soReqs.push(s)):this._xoReqs.push(s):this._doSignIn(s),s.promise}_doSignIn(t){this._busy=t,this._rejectOnPersistedPageShow=!1;const e=e=>{const i=t.options_&&t.options_.resource,s=t.resUrl_,n=t.refresh_;let r=!1;-1===this.credentials.indexOf(e)&&(n&&-1!==this.credentials.indexOf(n)?(n.userId=e.userId,n.token=e.token,n.expires=e.expires,n.validity=e.validity,n.ssl=e.ssl,n.creationTime=e.creationTime,r=!0,e=n):this.credentials.push(e)),e.resources||(e.resources=[]),e.resources.push(i||s),e.scope=this._isServerRsrc(s)?"server":"portal",e.emitTokenChange();const o=this._soReqs,a={};this._soReqs=[],o.forEach((t=>{if(!this._isIdenticalService(s,t.resUrl_)){const i=this._getSuffix(t.resUrl_);a[i]||(a[i]=!0,e.resources.push(t.resUrl_))}})),t.resolve(e),o.forEach((t=>{this._hasSameServerInstance(this._getServerInstanceRoot(s),t.resUrl_)?t.resolve(e):this._soReqs.push(t)})),this._busy=t.resUrl_=t.sinfo_=t.refresh_=null,r||this.emit("credential-create",{credential:e}),this._soReqs.length?this._doSignIn(this._soReqs.shift()):this._xoReqs.length&&this._doSignIn(this._xoReqs.shift())},i=e=>{t.reject(e),this._busy=t.resUrl_=t.sinfo_=t.refresh_=null,this._soReqs.length?this._doSignIn(this._soReqs.shift()):this._xoReqs.length&&this._doSignIn(this._xoReqs.shift())},s=(s,n,r,o)=>{var a,h;const l=t.sinfo_,u=!t.options_||!1!==t.options_.prompt,c=l.hasPortal&&this._findOAuthInfo(t.resUrl_);let d,f;if(s)e(new wt({userId:s,server:l.server,token:r||null,expires:null!=o?Number(o):null,ssl:!!n}));else if(window!==window.parent&&null!=(a=this._appUrlObj.query)&&a["arcgis-auth-origin"]&&null!=(h=this._appUrlObj.query)&&h["arcgis-auth-portal"]&&this._hasSameServerInstance(this._getServerInstanceRoot(this._appUrlObj.query["arcgis-auth-portal"]),t.resUrl_)){var v;window.parent.postMessage({type:"arcgis:auth:requestCredential"},this._appUrlObj.query["arcgis-auth-origin"]);const s=S(window,"message",(t=>{t.source===window.parent&&t.data&&("arcgis:auth:credential"===t.data.type?(s.remove(),t.data.credential.expires<Date.now()?i(new w("identity-manager:credential-request-failed","Parent application's token has expired.")):e(new wt(t.data.credential))):"arcgis:auth:error"===t.data.type&&(s.remove(),i("tokenExpiredError"===t.data.error.name?new w("identity-manager:credential-request-failed","Parent application's token has expired."):w.fromJSON(t.data.error))))}));m(null==(v=t.options_)?void 0:v.signal,(()=>{s.remove()}))}else if(c){let s=c._oAuthCred;if(!s){const t=new rt(c,vt),e=new rt(c,pt);t.isValid()&&e.isValid()?t.expires>e.expires?(s=t,e.destroy()):(s=e,t.destroy()):s=t.isValid()?t:e,c._oAuthCred=s}if(s.isValid())d=new wt({userId:s.userId,server:l.server,token:s.token,expires:s.expires,ssl:s.ssl,_oAuthCred:s}),c.appId!==s.appId&&this._doPortalSignIn(t.resUrl_)?t._pendingDfd=this._exchangeToken(d.server,c.appId,d.token).then((t=>{d.token=t,s.token=t,s.save(),e(d)})).catch((()=>{e(d)})):e(d);else if(this._oAuthHash&&this._hasSameServerInstance(c.portalUrl,this._oAuthHash.state.portalUrl)){const t=this._oAuthHash;d=new wt({userId:t.username,server:l.server,token:t.access_token,expires:Date.now()+1e3*Number(t.expires_in),ssl:"true"===t.ssl,oAuthState:t.state,_oAuthCred:s}),c.userId=d.userId,s.storage=t.persist?vt:pt,s.token=d.token,s.expires=d.expires,s.userId=d.userId,s.ssl=d.ssl,s.save(),this._oAuthHash=null,e(d)}else{const s=()=>{u?t._pendingDfd=this.oAuthSignIn(t.resUrl_,l,c,t.options_).then(e,i):(f=new w("identity-manager:not-authenticated","User is not signed in."),i(f))};this._doPortalSignIn(t.resUrl_)?t._pendingDfd=this._getPlatformSelf(l.server,c.appId).then((({portalUrl:t,token:i,username:n})=>{!t||y(t,this._appOrigin,!0)?(d=new wt({server:l.server,userId:n,token:i}),e(d)):s()})).catch(s):s()}}else if(u){if(this._checkProtocol(t.resUrl_,l,i,t.admin_)){let s=t.options_;t.admin_&&(s=s||{},s.isAdmin=!0),t._pendingDfd=this.signIn(t.resUrl_,l,s).then(e,i)}}else f=new w("identity-manager:not-authenticated","User is not signed in."),i(f)},n=()=>{const s=t.sinfo_,n=s.owningSystemUrl,r=t.options_;let o,a,h,l;if(r&&(o=r.token,a=r.error,h=r.prompt),l=this._findCredential(n,{token:o,resource:t.resUrl_}),!l)for(const t of this.credentials)if(this._isIdProvider(n,t.server)){l=t;break}if(l){const n=this.findCredential(t.resUrl_,l.userId);if(n)e(n);else if(ft(s,this._legacyFed)){const t=l.toJSON();t.server=s.server,t.resources=null,e(new wt(t))}else(t._pendingDfd=this.generateToken(this.findServerInfo(l.server),null,{serverUrl:t.resUrl_,token:l.token,signal:t.options_.signal,ssl:l.ssl})).then((i=>{e(new wt({userId:l.userId,server:s.server,token:i.token,expires:null!=i.expires?Number(i.expires):null,ssl:!!i.ssl,isAdmin:t.admin_,validity:i.validity}))}),i)}else this._busy=null,o&&(t.options_.token=null),(t._pendingDfd=this.getCredential(n.replace(/\/?$/,"/sharing"),{resource:t.resUrl_,owningTenant:s.owningTenant,signal:t.options_.signal,token:o,error:a,prompt:h})).then((()=>{this._enqueue(t.resUrl_,t.sinfo_,t.options_,t,t.admin_)}),(e=>{t.resUrl_=t.sinfo_=t.refresh_=null,t.reject(e)}))};this._errbackFunc=i;const r=t.sinfo_.owningSystemUrl,o=this._isServerRsrc(t.resUrl_),a=t.sinfo_._restInfoPms;a?a.promise.then((e=>{const i=t.sinfo_;if(i._restInfoPms){i.adminTokenServiceUrl=i._restInfoPms.adminUrl,i._restInfoPms=null,i.tokenServiceUrl=T("authInfo.tokenServicesUrl",e)||T("authInfo.tokenServiceUrl",e)||T("tokenServiceUrl",e),i.shortLivedTokenValidity=T("authInfo.shortLivedTokenValidity",e),i.currentVersion=e.currentVersion,i.owningTenant=e.owningTenant;const t=i.owningSystemUrl=e.owningSystemUrl;t&&this._portals.push(t)}o&&i.owningSystemUrl?n():s()}),(()=>{t.sinfo_._restInfoPms=null;const e=new w("identity-manager:server-identification-failed","Unknown resource - could not find token service endpoint.");i(e)})):o&&r?n():t.sinfo_._selfReq?t.sinfo_._selfReq.selfDfd.then((e=>{const i={};let s,n,r,o;return e&&(s=e.user&&e.user.username,i.username=s,i.allSSL=e.allSSL,n=e.supportsOAuth,r=e.currentVersion,"multitenant"===e.portalMode&&(o=e.customBaseUrl)),t.sinfo_.webTierAuth=!!s,s&&this.normalizeWebTierAuth?this.generateToken(t.sinfo_,null,{ssl:i.allSSL}).catch((()=>null)).then((t=>(i.portalToken=t&&t.token,i.tokenExpiration=t&&t.expires,i))):!s&&n&&parseFloat(r)>=4.4&&!this._findOAuthInfo(t.resUrl_)?this._generateOAuthInfo({portalUrl:t.sinfo_.server,customBaseUrl:o,owningTenant:t.sinfo_._selfReq.owningTenant}).catch((()=>null)).then((()=>i)):i})).catch((()=>null)).then((e=>{t.sinfo_._selfReq=null,e?s(e.username,e.allSSL,e.portalToken,e.tokenExpiration):s()})):s()}_generateOAuthInfo(t){let e,i,s=t.portalUrl;const n=t.customBaseUrl,r=t.owningTenant,o=!this.defaultOAuthInfo&&this._createDefaultOAuthInfo&&!this._hasTestedIfAppIsOnPortal;if(o){i=window.location.href;let t=i.indexOf("?");t>-1&&(i=i.slice(0,t)),t=i.search(/\/(apps|home)\//),i=t>-1?i.slice(0,t):null}return o&&i?(this._hasTestedIfAppIsOnPortal=!0,e=b(i+"/sharing/rest",{query:{f:"json"}}).then((()=>{this.defaultOAuthInfo=new ht({appId:"arcgisonline",popupCallbackUrl:i+"/home/oauth-callback.html"})}))):e=Promise.resolve(),e.then((()=>{if(this.defaultOAuthInfo)return s=s.replace(/^http:/i,"https:"),b(s+"/sharing/rest/oauth2/validateRedirectUri",{query:{accountId:r,client_id:this.defaultOAuthInfo.appId,redirect_uri:O(this.defaultOAuthInfo.popupCallbackUrl),f:"json"}}).then((t=>{if(t.data.valid){const e=this.defaultOAuthInfo.clone();e.portalUrl=t.data.urlKey&&n?"https://"+t.data.urlKey.toLowerCase()+"."+n:s,e.popup=window!==window.top||!(y(s,this._appOrigin)||this._gwDomains.some((t=>t.regex.test(s)&&t.regex.test(this._appOrigin)))),this.oAuthInfos.push(e)}}))}))}_doOAuthSignIn(t,e,i){const s={portalUrl:i.portalUrl};!i.popup&&i.preserveUrlHash&&window.location.hash&&(s.hash=window.location.hash);const n={client_id:i.appId,response_type:"token",state:JSON.stringify(s),expiration:i.expiration,locale:i.locale,redirect_uri:i.popup?O(i.popupCallbackUrl):window.location.href.replace(/#.*$/,"")};i.forceLogin&&(n.force_login=!0),i.forceUserId&&i.userId&&(n.prepopulatedusername=i.userId),!i.popup&&this._doPortalSignIn(t)&&(n.redirectToUserOrgUrl=!0);const r=i.portalUrl.replace(/^http:/i,"https:")+"/sharing/oauth2/authorize",o=r+"?"+x(n);if(i.popup){const t=window.open(o,"esriJSAPIOAuth",i.popupWindowFeatures);if(t)t.focus(),this._oAuthDfd.oAuthWin_=t,this._oAuthIntervalId=setInterval((()=>{if(t.closed){clearInterval(this._oAuthIntervalId),this._oAuthOnHashHandle.remove();const t=this._oAuthDfd;if(t){const e=new w("identity-manager:user-aborted","ABORTED");t.reject(e)}}}),500),this._oAuthOnHashHandle=S(f,"arcgis:auth:hash",(t=>{this.setOAuthResponseHash(t.detail)}));else{const t=new w("identity-manager:popup-blocked","ABORTED");this._oAuthDfd.reject(t)}}else this._rejectOnPersistedPageShow=!0,this._oAuthRedirectFunc?this._oAuthRedirectFunc({authorizeParams:n,authorizeUrl:r,resourceUrl:t,serverInfo:e,oAuthInfo:i}):window.location.href=o}}mt.prototype.declaredClass="esri.identity.IdentityManagerBase";let wt=class extends l.EventedAccessor{constructor(t){super(t),this._oAuthCred=null,this.tokenRefreshBuffer=2,t&&t._oAuthCred&&(this._oAuthCred=t._oAuthCred)}initialize(){this.resources=this.resources||[],null==this.creationTime&&(this.creationTime=Date.now())}refreshToken(){const t=u.findServerInfo(this.server),e=t&&t.owningSystemUrl,i=!!e&&"server"===this.scope,s=i&&ft(t,u._legacyFed),n=t.webTierAuth,r=n&&u.normalizeWebTierAuth,o=ct[this.server],a=o&&o[this.userId];let h,l=this.resources&&this.resources[0],c=i&&u.findServerInfo(e),d={username:this.userId,password:a};if(n&&!r)return;i&&!c&&u.serverInfos.some((t=>(u._isIdProvider(e,t.server)&&(c=t),!!c)));const f=c&&u.findCredential(c.server,this.userId);if(!i||f){if(!s){if(i)h={serverUrl:l,token:f&&f.token,ssl:f&&f.ssl};else if(r)d=null,h={ssl:this.ssl};else{if(!a){let e;return l&&(l=u._sanitizeUrl(l),this._enqueued=1,e=u._enqueue(l,t,null,null,this.isAdmin,this),e.then((()=>{this._enqueued=0,this.refreshServerTokens()})).catch((()=>{this._enqueued=0}))),e}this.isAdmin&&(h={isAdmin:!0})}return u.generateToken(i?c:t,i?null:d,h).then((t=>{this.token=t.token,this.expires=null!=t.expires?Number(t.expires):null,this.creationTime=Date.now(),this.validity=t.validity,this.emitTokenChange(),this.refreshServerTokens()})).catch((()=>{}))}f.refreshToken()}}refreshServerTokens(){"portal"===this.scope&&u.credentials.forEach((t=>{const e=u.findServerInfo(t.server),i=e&&e.owningSystemUrl;t!==this&&t.userId===this.userId&&i&&"server"===t.scope&&(u._hasSameServerInstance(this.server,i)||u._isIdProvider(i,this.server))&&(ft(e,u._legacyFed)?(t.token=this.token,t.expires=this.expires,t.creationTime=this.creationTime,t.validity=this.validity,t.emitTokenChange()):t.refreshToken())}))}emitTokenChange(t){clearTimeout(this._refreshTimer);const e=this.server&&u.findServerInfo(this.server),i=e&&e.owningSystemUrl,s=i&&u.findServerInfo(i);!1===t||i&&"portal"!==this.scope&&(!s||!s.webTierAuth||u.normalizeWebTierAuth)||null==this.expires&&null==this.validity||this._startRefreshTimer(),this.emit("token-change")}destroy(){this.userId=this.server=this.token=this.expires=this.validity=this.resources=this.creationTime=null,this._oAuthCred&&(this._oAuthCred.destroy(),this._oAuthCred=null);const t=u.credentials.indexOf(this);t>-1&&u.credentials.splice(t,1),this.emitTokenChange(),this.emit("destroy")}toJSON(){const t=c({userId:this.userId,server:this.server,token:this.token,expires:this.expires,validity:this.validity,ssl:this.ssl,isAdmin:this.isAdmin,creationTime:this.creationTime,scope:this.scope}),e=this.resources;return e&&e.length>0&&(t.resources=e.slice()),t}_startRefreshTimer(){clearTimeout(this._refreshTimer);const t=6e4*this.tokenRefreshBuffer,e=2**31-1;let i=(this.validity?this.creationTime+6e4*this.validity:this.expires)-Date.now();i<0?i=0:i>e&&(i=e),this._refreshTimer=setTimeout(this.refreshToken.bind(this),i>t?i-t:i)}};t([e()],wt.prototype,"creationTime",void 0),t([e()],wt.prototype,"expires",void 0),t([e()],wt.prototype,"isAdmin",void 0),t([e()],wt.prototype,"oAuthState",void 0),t([e()],wt.prototype,"resources",void 0),t([e()],wt.prototype,"scope",void 0),t([e()],wt.prototype,"server",void 0),t([e()],wt.prototype,"ssl",void 0),t([e()],wt.prototype,"token",void 0),t([e()],wt.prototype,"tokenRefreshBuffer",void 0),t([e()],wt.prototype,"userId",void 0),t([e()],wt.prototype,"validity",void 0),wt=t([s("esri.identity.Credential")],wt);class gt extends mt{}gt.prototype.declaredClass="esri.identity.IdentityManager";const yt=new gt;j(yt);export default yt;