import{e as t,d as s,i,p as e,A as r,c as o,I as a,_ as h,g as n,b as l,a as p,T as c,aE as m,V as u,af as d}from"./p-e58503d5.js";import"./p-b79fcce3.js";import{h as f}from"./p-54330161.js";import{c as j}from"./p-fb38a9d0.js";import{j as b}from"./p-db63fa0e.js";import{g as y,u as g,s as v,i as w}from"./p-1101e9dd.js";import{u as T,l as P}from"./p-f971b161.js";import{F as _}from"./p-d1a9be2d.js";import{l as x}from"./p-728f106f.js";import{u as S}from"./p-ea916a39.js";import{C as z,L as I}from"./p-6484267b.js";import{x as F,G as D,b as V}from"./p-1676d4c7.js";import{r as R}from"./p-1ccb0bf6.js";import{I as G,t as L}from"./p-e3500fdc.js";import{o as k}from"./p-a2b6db85.js";import{U,_ as C,S as A}from"./p-1eb62563.js";import{s as M,i as W}from"./p-b9aa4901.js";import{h as B,f as O}from"./p-19bc1e3d.js";import"./p-0bb84768.js";import{a as q}from"./p-1c2ff3a7.js";import{h as E}from"./p-75cd09f2.js";import{r as J,p as N}from"./p-6448f4dc.js";import{m as Q}from"./p-9f4258fa.js";import{u as H}from"./p-a63f7978.js";import{i as K}from"./p-07ab8db5.js";import{a as X}from"./p-b6fa3228.js";import{o as Y}from"./p-db4d63dc.js";import"./p-53bb6ab4.js";import"./p-93765525.js";import"./p-765e6c28.js";import"./p-a9a30646.js";import"./p-8747982c.js";import"./p-8bc9b36a.js";import"./p-7a658388.js";import"./p-e273719b.js";import"./p-74de0937.js";import"./p-2f398ed1.js";import"./p-d3105731.js";import"./p-f94762ac.js";import"./p-8a919d07.js";import"./p-efbca0ca.js";import"./p-c048b814.js";import"./p-01e5a461.js";import"./p-c93d2280.js";import"./p-ccdb8e80.js";import"./p-fea9512d.js";import"./p-56ca6f1f.js";import"./p-0bb41218.js";import"./p-a24f7752.js";import"./p-400ca3dc.js";import"./p-9b7a2176.js";import"./p-e654504b.js";import"./p-0eb619a6.js";import"./p-4d17d2cd.js";import"./p-b5b00e38.js";import"./p-e94b450b.js";import"./p-7731c620.js";import"./p-5d962998.js";import"./p-1189fa83.js";import"./p-37058f88.js";import"./p-3e39c093.js";import"./p-7a5bfd29.js";import"./p-7d081d01.js";import"./p-afac6fb2.js";import"./p-ca295674.js";import"./p-41f2b2dd.js";import"./p-612a2c14.js";import"./p-d443df87.js";import"./p-7ca40eac.js";import"./p-9087b4d3.js";import"./p-c1cd5521.js";import"./p-ca4492df.js";import"./p-9d34911e.js";import"./p-182bb5be.js";import"./p-db87794e.js";import"./p-2db4840f.js";import"./p-bba8b671.js";import"./p-5e833dfc.js";import"./p-a131049b.js";import"./p-a2324023.js";import"./p-dc852195.js";import"./p-ff2962f5.js";import"./p-da9e7ba9.js";import"./p-a8f0aa27.js";import"./p-4a96de15.js";import"./p-5032dfbd.js";import"./p-a87cccba.js";import"./p-dae095dd.js";import"./p-0e784e4d.js";import"./p-dbdf15fc.js";import"./p-e0d9ff4c.js";import"./p-08e5f531.js";import"./p-dfc6337f.js";import"./p-9f1c2d50.js";import"./p-6b2eb7a7.js";import"./p-889f7a78.js";import"./p-1f81b35d.js";import"./p-81b9df84.js";import"./p-5ce39624.js";import"./p-e9bae5e9.js";import"./p-b0565d49.js";import"./p-51a17e75.js";import"./p-d208934e.js";import"./p-480e5606.js";import"./p-22c9f19c.js";import"./p-c096b5df.js";import"./p-da33e926.js";import"./p-4a6dc5e4.js";import"./p-6a92ecb9.js";import"./p-1ab449fc.js";import"./p-a6c8fb32.js";import"./p-0edb3309.js";import"./p-e8160b60.js";import"./p-2e8ad983.js";import"./p-e3270d48.js";import"./p-e44bd0a6.js";import"./p-fe68aab5.js";import"./p-c6970847.js";import"./p-de86b3c9.js";import"./p-37d3434c.js";import"./p-120b7410.js";import"./p-b1eff69d.js";import"./p-612de336.js";import"./p-91fe06d4.js";import"./p-ab0e9273.js";import"./p-15a9486c.js";import"./p-2ae44317.js";import"./p-9f58a277.js";import"./p-9e860e7b.js";import"./p-f3659a34.js";import"./p-ca657fcf.js";import"./p-b312c1fd.js";import"./p-b8beb0d3.js";import"./p-2a99994a.js";import"./p-76f37e40.js";import"./p-eee9ef50.js";import"./p-6ded4c02.js";import"./p-1e473dab.js";import"./p-d1d9dbe4.js";import"./p-d57f9971.js";import"./p-e6fe5d89.js";import"./p-56ed1c7a.js";import"./p-746a9d8f.js";import"./p-47e1bd73.js";import"./p-09dd2137.js";import"./p-ad14ca1b.js";import"./p-b392deaf.js";import"./p-4414d64f.js";import"./p-a617738c.js";import"./p-b9c93bb2.js";import"./p-6fe4db61.js";import"./p-77b9a0fc.js";import"./p-2e5dd2d0.js";import"./p-97ec6ae5.js";import"./p-285c6a34.js";import"./p-e285e8f3.js";class Z extends R{constructor(t,s,i,e,r,o=null){super(t,s,i,e,r),this.bitmap=new F(o,null,null),this.bitmap.coordScale=[e,r],this.bitmap.once("isReady",(()=>this.ready()))}destroy(){super.destroy(),this.bitmap.destroy(),this.bitmap=null,this.stage=null}set stencilRef(t){this.bitmap.stencilRef=t}get stencilRef(){return this.bitmap.stencilRef}setTransform(t,s){super.setTransform(t,s),this.bitmap.transforms.dvs=this.transforms.dvs}_createTransforms(){return{dvs:z(),tileMat3:z()}}onAttach(){this.bitmap.stage=this.stage}onDetach(){this.bitmap.stage=null}}class $ extends k{constructor(){super(...arguments),this.isCustomTilingScheme=!1}createTile(t){const s=this._getTileBounds(t),[i,e]=this._tileInfoView.tileInfo.size;return new Z(t,s[0],s[3],i,e)}destroyTile(){}prepareRenderPasses(t){const s=t.registerRenderPass({name:"imagery (tile)",brushes:[D.raster],target:()=>this.children.map((t=>t.bitmap)),drawPhase:G.MAP});return[...super.prepareRenderPasses(t),s]}doRender(t){this.visible&&t.drawPhase===G.MAP&&super.doRender(t)}_getTileBounds(t){const s=this._tileInfoView.getTileBounds(S(),t);if(this.isCustomTilingScheme&&t.world){const{tileInfo:i}=this._tileInfoView,e=I(i.spatialReference);if(e){const{resolution:r}=i.lodAt(t.level),o=e/r%i.size[0],a=o?(i.size[0]-o)*r:0;s[0]-=a*t.world,s[2]-=a*t.world}}return s}}let tt=class extends e{constructor(){super(...arguments),this._emptyTilePixelBlock=null,this.container=null,this.layer=null,this.tileSize=null,this.useWebGLForProcessing=!0}fetchTile(t,s){return this.layer.fetchTile(t.level,t.row,t.col,s)}createEmptyTilePixelBlock(t=null){const s=null==t||t.join(",")===this.tileSize.join(",");if(s&&r(this._emptyTilePixelBlock))return this._emptyTilePixelBlock;t=t||this.tileSize;const[i,e]=t,o=new T({width:i,height:e,pixels:[new Uint8Array(i*e)],mask:new Uint8Array(i*e),pixelType:"u8"});return s&&(this._emptyTilePixelBlock=o),o}};t([s()],tt.prototype,"container",void 0),t([s()],tt.prototype,"layer",void 0),t([s()],tt.prototype,"tileSize",void 0),t([s()],tt.prototype,"type",void 0),t([s()],tt.prototype,"useWebGLForProcessing",void 0),tt=t([i("esri.views.2d.layers.imagery.BaseImageryTileSubView2D")],tt);let st=class extends tt{constructor(){super(...arguments),this.container=null,this.layer=null,this.tileSize=null,this.type="raster",this.useWebGLForProcessing=!0}canUseWebGLForProcessing(){return this.useWebGLForProcessing&&this.layer.symbolizer.canRenderInWebGL&&!("majority"===this.layer.interpolation&&this._canUseMajorityInterpolationOnDataSource())}fetchTile(t,s){return this.layer.fetchTile(t.level,t.row,t.col,s)}async updateTileSource(t,s){const{bandIds:i}=this.layer,e=this._getLayerInterpolation(),o=this.canUseWebGLForProcessing(),{source:a,symbolizerParams:h,globalSymbolizerParams:n,suspended:l,coords:p,resolution:c}=s,{bitmap:m}=t;if([m.x,m.y]=p,m.resolution=c,a&&r(a)&&r(a.pixelBlock)){const t={extent:a.extent,pixelBlock:a.pixelBlock};if(m.rawPixelData=t,o)m.source=a.pixelBlock,m.isRendereredSource=!1;else{const s=await this.layer.applyRenderer(t,"stretch"===(null==n?void 0:n.type)?n:null);m.source=s,m.isRendereredSource=!0}m.symbolizerParameters=o?h:null,o?m.transformGrid||(m.transformGrid=a.transformGrid):m.transformGrid=null}else{const t=this.createEmptyTilePixelBlock();m.source=t,m.symbolizerParameters=o?h:null,m.transformGrid=null}m.bandIds=o?i:null,m.width=this.tileSize[0],m.height=this.tileSize[1],m.interpolation=e,m.suspended=l,m.invalidateTexture()}async updateTileSymbolizerParameters(t,s){const{local:i,global:e}=s,{bandIds:o}=this.layer,a=this._getLayerInterpolation(),h=this.canUseWebGLForProcessing(),{bitmap:n}=t,{rawPixelData:l}=n;!h&&r(l)?(n.source=await this.layer.applyRenderer(l,"stretch"===(null==e?void 0:e.type)?e:null),n.isRendereredSource=!0):(n.isRendereredSource&&r(l)&&(n.source=l.pixelBlock),n.isRendereredSource=!1),n.symbolizerParameters=h?e||i:null,n.bandIds=h?o:null,n.interpolation=a,n.suspended=!1}install(t,s){this.container=new $(s.tileInfoView),this.container.isCustomTilingScheme=s.isCustomTilingScheme,t.addChild(this.container)}uninstall(){this.container.removeAllChildren(),this.container.remove()}_canUseMajorityInterpolationOnDataSource(){const{bandCount:t,attributeTable:s,colormap:i,pixelType:e}=this.layer.rasterInfo;return 1===t&&(null!=s||null!=i||"u8"===e||"s8"===e)}_getLayerInterpolation(){const t=this.layer.renderer.type;if("raster-colormap"===t||"unique-value"===t||"class-breaks"===t)return"nearest";const{interpolation:s}=this.layer,{renderer:i}=this.layer;return"raster-stretch"===i.type&&null!=i.colorRamp?"bilinear"===s||"cubic"===s?"bilinear":"nearest":s}};t([s()],st.prototype,"container",void 0),t([s()],st.prototype,"layer",void 0),t([s()],st.prototype,"tileSize",void 0),t([s()],st.prototype,"type",void 0),t([s()],st.prototype,"useWebGLForProcessing",void 0),st=t([i("esri.views.2d.layers.imagery.ImageryTileView2D")],st);const it=st;class et extends q{constructor(t=null){super(),this._source=null,this._symbolizerParameters=null,this._vaoInvalidated=!0,this.coordScale=[1,1],this.height=null,this.stencilRef=0,this.rawPixelData=null,this.width=null,this.source=t}destroy(){var t,s;r(this.vaoData)&&(null==(t=this.vaoData.magdir)||t.vao.dispose(),null==(s=this.vaoData.scalar)||s.vao.dispose(),this.vaoData=null)}get symbolizerParameters(){return this._symbolizerParameters}set symbolizerParameters(t){JSON.stringify(this._symbolizerParameters)!==JSON.stringify(t)&&(this._symbolizerParameters=t,this.invalidateVAO())}get source(){return this._source}set source(t){this._source=t,this.invalidateVAO()}invalidateVAO(){var t,s;!this._vaoInvalidated&&r(this.vaoData)&&(null==(t=this.vaoData.magdir)||t.vao.dispose(),null==(s=this.vaoData.scalar)||s.vao.dispose(),this.vaoData=null,this._vaoInvalidated=!0,this.requestRender())}updateVectorFieldVAO(t){if(this._vaoInvalidated){if(this._vaoInvalidated=!1,r(this.source)&&!r(this.vaoData)){const{style:s}=this.symbolizerParameters;switch(s){case"beaufort_ft":case"beaufort_km":case"beaufort_kn":case"beaufort_m":case"beaufort_mi":case"classified_arrow":case"ocean_current_kn":case"ocean_current_m":case"single_arrow":{const s=U(this.source,this.symbolizerParameters),i=this._createVectorFieldVAO(t.context,s);this.vaoData={magdir:i}}break;case"simple_scalar":{const s=C(this.source,this.symbolizerParameters),i=this._createVectorFieldVAO(t.context,s);this.vaoData={scalar:i}}break;case"wind_speed":{const s=U(this.source,this.symbolizerParameters),i=this._createVectorFieldVAO(t.context,s),e=C(this.source,this.symbolizerParameters),r=this._createVectorFieldVAO(t.context,e);this.vaoData={magdir:i,scalar:r}}}}this.ready(),this.requestRender()}}_createTransforms(){return{dvs:z()}}onAttach(){this.invalidateVAO()}onDetach(){this.invalidateVAO()}_createVectorFieldVAO(t,s){const{vertexData:i,indexData:e}=s,r=B.createVertex(t,35044,new Float32Array(i)),o=B.createIndex(t,35044,new Uint32Array(e)),a=L("vector-field",{geometry:[{location:0,name:"a_pos",count:2,type:5126,normalized:!1},{location:1,name:"a_offset",count:2,type:5126,normalized:!1},{location:2,name:"a_vv",count:2,type:5126,normalized:!1}]});return{vao:new O(t,a.attributes,a.bufferLayouts,{geometry:r},o),elementCount:e.length}}}class rt extends R{constructor(t,s,i,e,r,o=null){super(t,s,i,e,r),this.tileData=new et(o),this.tileData.coordScale=[e,r],this.tileData.once("isReady",(()=>this.ready()))}destroy(){super.destroy(),this.tileData.destroy(),this.tileData=null,this.stage=null}set stencilRef(t){this.tileData.stencilRef=t}get stencilRef(){return this.tileData.stencilRef}_createTransforms(){return{dvs:z(),tileMat3:z()}}setTransform(t,s){super.setTransform(t,s);const i=s/(t.resolution*t.pixelRatio),e=this.transforms.tileMat3,[r,o]=this.tileData.offset,a=[this.x+r*s,this.y-o*s],[h,n]=t.toScreenNoRotation([0,0],a),{symbolTileSize:l}=this.tileData.symbolizerParameters,p=Math.round((this.width-this.tileData.offset[0])/l)*l,c=Math.round((this.height-this.tileData.offset[1])/l)*l;M(e,p/this.rangeX*i,0,0,0,c/this.rangeY*i,0,h,n,1),W(this.transforms.dvs,t.displayViewMat3,e),this.tileData.transforms.dvs=this.transforms.dvs}onAttach(){this.tileData.stage=this.stage}onDetach(){this.tileData.stage=null}}class ot extends k{constructor(){super(...arguments),this.isCustomTilingScheme=!1,this.symbolTypes=["triangle"]}createTile(t){const s=this._tileInfoView.getTileBounds(S(),t),[i,e]=this._tileInfoView.tileInfo.size;return new rt(t,s[0],s[3],i,e)}destroyTile(){}prepareRenderPasses(t){const s=t.registerRenderPass({name:"imagery (vf tile)",brushes:[V],target:()=>this.children.map((t=>t.tileData)),drawPhase:G.MAP});return[...super.prepareRenderPasses(t),s]}doRender(t){this.visible&&t.drawPhase===G.MAP&&this.symbolTypes.forEach((s=>{t.renderPass=s,super.doRender(t)}))}}let at=class extends tt{constructor(){super(...arguments),this._handle=null,this.container=null,this.layer=null,this.tileSize=null,this.type="rasterVF",this.useWebGLForProcessing=!0}canUseWebGLForProcessing(){return!1}async fetchTile(t,s){const i=await this.layer.fetchTile(t.level,t.row,t.col,s);return"vector-magdir"===this.layer.rasterInfo.dataType&&null!=i&&i.pixelBlock&&(i.pixelBlock=await this.layer.convertVectorFieldData(i.pixelBlock,s)),i}updateTileSource(t,s){const i=s.symbolizerParams,{tileData:e}=t;e.key=t.key,e.width=this.tileSize[0],e.height=this.tileSize[1];const{symbolTileSize:o}=i,{source:a}=s;if(e.offset=this._getTileSymbolOffset(e.key,o),r(a)&&r(a.pixelBlock))e.rawPixelData={extent:a.extent,pixelBlock:a.pixelBlock},e.source=this._sampleVectorFieldData(a.pixelBlock,i,e.offset),e.symbolizerParameters=i;else{const t=[Math.round((this.tileSize[0]-e.offset[0])/o),Math.round((this.tileSize[1]-e.offset[1])/o)],s=this.createEmptyTilePixelBlock(t);e.source=s,e.symbolizerParameters=i}return e.invalidateVAO(),Promise.resolve(null)}updateTileSymbolizerParameters(t,s){var i;const e=s.local,{symbolTileSize:o}=e,{tileData:a}=t;a.offset=this._getTileSymbolOffset(a.key,o);const h=a.symbolizerParameters.symbolTileSize;return a.symbolizerParameters=e,r(null==(i=a.rawPixelData)?void 0:i.pixelBlock)&&h!==o&&(a.source=this._sampleVectorFieldData(a.rawPixelData.pixelBlock,a.symbolizerParameters,a.offset)),Promise.resolve(null)}install(t,s){this.container=new ot(s.tileInfoView),this.container.isCustomTilingScheme=s.isCustomTilingScheme,this._updateSymbolType(this.layer.renderer),this._handle=this.layer.watch("renderer",(t=>this._updateSymbolType(t))),t.addChild(this.container)}uninstall(){this.container.removeAllChildren(),this._handle.remove(),this._handle=null,this.container.remove()}_getTileSymbolOffset(t,s){const i=t.col*this.tileSize[0]%s,e=t.row*this.tileSize[1]%s;return[i>s/2?s-i:-i,e>s/2?s-e:-e]}_sampleVectorFieldData(t,s,i){const{symbolTileSize:e}=s;return A(t,"vector-uv",e,i)}_updateSymbolType(t){"vector-field"===t.type&&(this.container.symbolTypes="wind-barb"===t.style?["scalar","triangle"]:"simple-scalar"===t.style?["scalar"]:["triangle"])}};t([s()],at.prototype,"container",void 0),t([s()],at.prototype,"layer",void 0),t([s()],at.prototype,"tileSize",void 0),t([s()],at.prototype,"type",void 0),t([s()],at.prototype,"useWebGLForProcessing",void 0),at=t([i("esri.views.2d.layers.imagery.VectorFieldTileView2D")],at);const ht=at,nt=o.getLogger("esri.views.2d.layers.ImageryTileLayerView2D"),lt=[0,0];let pt=class extends(Q(K(x(H)))){constructor(){super(...arguments),this._tileStrategy=null,this._tileInfoView=null,this._fetchQueue=null,this._blockCacheRegistryUrl=null,this._blockCacheRegistryId=null,this._srcResolutions=null,this._previousLOD=null,this._needBlockCacheUpdate=!1,this._globalSymbolizerParams=null,this._symbolizerParams=null,this._abortController=null,this._globalUpdateRequested=!1,this._isCustomTilingScheme=!1,this.subview=null,this._redrawOrRefetch=a(((t,s)=>this._previousLOD?t?this.doRefresh():this._redrawImage(s):Promise.resolve()))}initialize(){const t=this.updateFullExtent();this.addResolvingPromise(t)}get useWebGLForProcessing(){var t;return null==(t=this._get("useWebGLForProcessing"))||t}set useWebGLForProcessing(t){this.subview&&(this.subview.useWebGLForProcessing=t),this._set("useWebGLForProcessing",t)}get useProgressiveUpdate(){return null==this._get("useProgressiveUpdate")||this._get("useProgressiveUpdate")}set useProgressiveUpdate(t){if(this._tileStrategy&&this.useProgressiveUpdate!==t){var s;this._tileStrategy.destroy(),null==(s=this.subview)||s.container.removeAllChildren();const i=this._getCacheSize(t);this._tileStrategy=new J({cachePolicy:"purge",acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),cacheSize:i,tileInfoView:this._tileInfoView}),this._set("useProgressiveUpdate",t),this.requestUpdate()}}hitTest(t,s){if(this.suspended)return Promise.resolve(null);const i=this.view.toMap(j(t,s));return Promise.resolve(new f({attributes:{},geometry:i}))}update(t){this._fetchQueue.pause(),this._fetchQueue.state=t.state,this._tileStrategy.update(t),this._fetchQueue.resume();const{extent:s,resolution:i,scale:e}=t.state,r=this._tileInfoView.getClosestInfoForScale(e);if(this.layer.raster){var o;if(!this.useProgressiveUpdate||this._needBlockCacheUpdate){const t=this._srcResolutions[r.level],e=s.toJSON?s:h.fromJSON(s);y(this._blockCacheRegistryUrl,this._blockCacheRegistryId,e,i,t,this.layer.raster.ioConfig.sampling)}this._needBlockCacheUpdate=!1,(null==(o=this._previousLOD)?void 0:o.level)!==r.level&&(this._previousLOD=r,null==this._symbolizerParams||this.hasTilingEffects||this._updateSymbolizerParams(),this._tileStrategy.updateCacheSize(0))}this.notifyChange("updating")}attach(){this.layer.increaseRasterJobHandlerUsage(),Y().supportsTextureFloat||(this.useWebGLForProcessing=!1),this._initializeTileInfo(),this._tileInfoView=new E(this.tileInfo,this.fullExtent);const t=this._computeFetchConcurrency();this._fetchQueue=new N({tileInfoView:this._tileInfoView,concurrency:t,process:(t,s)=>this.fetchTile(t,s)});const s=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy=new J({cachePolicy:"purge",acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),cacheSize:s,tileInfoView:this._tileInfoView}),this._updatesubview(),this.handles.add([n(this.layer,["bandIds","renderer","interpolation","multidimensionalDefinition"],((t,s,i)=>{const e="multidimensionalDefinition"===i,r="interpolation"===i&&("majority"===t||"majority"===s)&&this._canUseMajorityInterpolationOnDataSource(),o="renderer"===i&&"vector-field"===s.type!=("vector-field"===t.type);o&&this._updatesubview(),this._redrawOrRefetch(e||r||o).catch((t=>{l(t)||nt.error(t)}))})),p(this,["layer.blendMode"],(t=>{this.subview&&(this.subview.container.blendMode=t)}),!0),p(this,["layer.effect"],(t=>{this.subview&&(this.subview.container.effect=t)}),!0),p(this,"timeExtent",(()=>{this._redrawOrRefetch(!0).catch((t=>{l(t)||nt.error(t)}))}))],"attach"),this._updateBlockCacheRegistry()}detach(){var t;this.handles.remove("attach"),this.layer.decreaseRasterJobHandlerUsage(),null==(t=this.subview)||t.uninstall(),this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null,g(this._blockCacheRegistryUrl,this._blockCacheRegistryId)}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){!this.hasTilingEffects&&this.useProgressiveUpdate||(this._abortController&&this._abortController.abort(),this._abortController=new AbortController,0===this._fetchQueue.length&&this._redrawImage(this._abortController.signal).then((()=>{this._globalUpdateRequested=!1,this.requestUpdate()})));const t=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy.updateCacheSize(t),this.requestUpdate()}createFetchPopupFeaturesQueryGeometry(t,s){return X(t,s,this.view)}async doRefresh(){if(this.suspended)return;await this.layer.updateRenderer(),this.hasTilingEffects||this._updateSymbolizerParams(),this._updateBlockCacheRegistry(!0),this._fetchQueue.reset();const t=[];this._tileStrategy.tiles.forEach((s=>t.push(this._enqueueTileFetch(s)))),await c(t),this.notifyChange("updating")}isUpdating(){return this._fetchQueue.length>0||this._globalUpdateRequested}acquireTile(t){const s=this.subview.container.createTile(t);return this._enqueueTileFetch(s),this.requestUpdate(),this._needBlockCacheUpdate=!0,this._globalUpdateRequested=this.hasTilingEffects||!this.useProgressiveUpdate,s}releaseTile(t){var s;this._fetchQueue.abort(t.key.id),null==(s=this.subview)||s.container.removeChild(t),t.once("detach",(()=>{t.destroy(),this.requestUpdate()})),this.requestUpdate()}fetchTile(t,s){const i=!d(s)&&s.signal,e=this.subview.canUseWebGLForProcessing(),r={allowPartialFill:!0,datumTransformation:this.datumTransformation,interpolation:e?"nearest":this.layer.interpolation,registryId:this._blockCacheRegistryId,requestRawData:e,signal:u(i),srcResolution:this._srcResolutions[t.level],timeExtent:this.timeExtent,tileInfo:this.tileInfo};return this.subview.fetchTile(t,r)}_updatesubview(){const t=this._isVectorField()?"rasterVF":"raster";if(this.subview){if(this.subview.type===t)return;this.subview.uninstall()}const{layer:s}=this;this._tileStrategy.clear();const i=new("rasterVF"===t?ht:it)({layer:s,tileSize:this.tileInfo.size,useWebGLForProcessing:this.useWebGLForProcessing});i.install(this.container,{tileInfoView:this._tileInfoView,isCustomTilingScheme:this._isCustomTilingScheme}),i.container.blendMode=s.blendMode,i.container.effect=s.effect,this.subview=i}_isVectorField(){return"vector-field"===this.layer.renderer.type}_getCacheSize(t){return t?40:0}_initializeTileInfo(){const t=this.view.spatialReference,s=new m({x:this.fullExtent.xmin,y:this.fullExtent.ymax,spatialReference:t}),{scales:i,srcResolutions:e,isCustomTilingScheme:r}=_(this.layer.rasterInfo,t),o=b.create({spatialReference:t,size:512,scales:i});(0===o.origin.x||o.origin.x>s.x)&&(o.origin=s),this._isCustomTilingScheme=r,this._set("tileInfo",o),this._srcResolutions=null!=e?e:[]}_computeFetchConcurrency(){const{blockBoundary:t}=this.layer.rasterInfo.storageInfo,s=t[t.length-1];return(s.maxCol-s.minCol+1)*(s.maxRow-s.minRow+1)>64?2:10}async _enqueueTileFetch(t,s){if(!this._fetchQueue.has(t.key.id)){try{const s=await this._fetchQueue.push(t.key),{bandIds:i}=this.layer;let e=!this.useProgressiveUpdate||this.hasTilingEffects&&!this._globalSymbolizerParams;if(this._globalUpdateRequested&&!this.moving&&0===this._fetchQueue.length){e=!1;try{await this._redrawImage(this._abortController&&this._abortController.signal)}catch(t){l(t)&&nt.error(t)}this._globalUpdateRequested=!1}!this.subview.canUseWebGLForProcessing()&&!this._isVectorField()||this.hasTilingEffects||null!=this._symbolizerParams||this._updateSymbolizerParams();const r=this._tileInfoView.getTileCoords(lt,t.key),o=this._tileInfoView.getTileResolution(t.key);await this.subview.updateTileSource(t,{source:s,symbolizerParams:this._symbolizerParams,globalSymbolizerParams:this._globalSymbolizerParams,suspended:e,bandIds:i,coords:r,resolution:o}),t.once("attach",(()=>this.requestUpdate())),this.subview.container.addChild(t)}catch(t){l(t)||nt.error(t)}this.requestUpdate()}}async _redrawImage(t){if(0===this.subview.container.children.length)return;await this.layer.updateRenderer(),this.hasTilingEffects?await this._updateGlobalSymbolizerParams(t):(this._updateSymbolizerParams(),this._globalSymbolizerParams=null);const s=this.subview.container.children.map((async t=>this.subview.updateTileSymbolizerParameters(t,{local:this._symbolizerParams,global:this._globalSymbolizerParams})));await c(s),this.container.requestRender()}async _updateGlobalSymbolizerParams(t){const s={srcResolution:this._srcResolutions[this._previousLOD.level],registryId:this._blockCacheRegistryId,signal:t},i=await this.layer.fetchPixels(this.view.extent,this.view.width,this.view.height,s);if(!i||!i.pixelBlock)return;const e=this.layer.symbolizer.generateWebGLParameters({pixelBlock:P(i.pixelBlock,this.layer.bandIds),isGCS:this.view.spatialReference.isGeographic,resolution:{x:this._previousLOD.resolution,y:this._previousLOD.resolution},bandIds:this.layer.bandIds});!this.subview.canUseWebGLForProcessing()&&e&&"stretch"===e.type&&this.layer.renderer&&"raster-stretch"===this.layer.renderer.type&&(e.factor=e.factor.map((t=>255*t)),e.outMin=Math.round(255*e.outMin),e.outMax=Math.round(255*e.outMax)),this._globalSymbolizerParams=e}_updateSymbolizerParams(){this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null,isGCS:this.view.spatialReference.isGeographic,resolution:{x:this._previousLOD.resolution,y:this._previousLOD.resolution},bandIds:this.layer.bandIds})}_updateBlockCacheRegistry(t=!1){const{url:s,rasterInfo:i,raster:e}=this.layer,{multidimensionalDefinition:r}=this.layer.normalizeRasterFetchOptions({multidimensionalDefinition:this.layer.multidimensionalDefinition,timeExtent:this.timeExtent}),o=null!=i&&i.multidimensionalInfo?e.getSliceIndex(r):null,a=w(s,o);if(a!==this._blockCacheRegistryUrl){if(null!=this._blockCacheRegistryUrl&&g(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryId=v(a,this.layer.raster.rasterInfo),t){const t=this._tileInfoView.getClosestInfoForScale(this.view.scale);y(a,this._blockCacheRegistryId,this.view.extent,this.view.resolution,this._srcResolutions[t.level],this.layer.raster.ioConfig.sampling)}this._blockCacheRegistryUrl=a}}_canUseMajorityInterpolationOnDataSource(){const{bandCount:t,attributeTable:s,colormap:i,pixelType:e}=this.layer.rasterInfo;return 1===t&&(null!=s||null!=i||"u8"===e||"s8"===e)}};t([s()],pt.prototype,"subview",void 0),t([s()],pt.prototype,"useWebGLForProcessing",null),t([s()],pt.prototype,"useProgressiveUpdate",null),pt=t([i("esri.views.2d.layers.ImageryTileLayerView2D")],pt);const ct=pt;export default ct;