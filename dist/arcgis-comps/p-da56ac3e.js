import{O as o,H as e,b8 as n,bS as s,a5 as t}from"./p-9ae46e68.js";import{cB as r,k as i,bQ as c,bO as a,cC as f,bP as l,x as y}from"./p-566b0715.js";import{t as m}from"./p-6443bfb4.js";import u from"./p-98a14d68.js";const p={esriGeometryPoint:"points",esriGeometryPolyline:"polylines",esriGeometryPolygon:"polygons"};function G(o){const n=o.folders||[],s=n.slice(),t=new Map,r=new Map,i=new Map,c=new Map,a=new Map,f={esriGeometryPoint:r,esriGeometryPolyline:i,esriGeometryPolygon:c};(o.featureCollection&&o.featureCollection.layers||[]).forEach((o=>{const n=e(o);n.featureSet.features=[];const s=o.featureSet.geometryType;t.set(s,n);const a=o.layerDefinition.objectIdField;"esriGeometryPoint"===s?w(r,a,o.featureSet.features):"esriGeometryPolyline"===s?w(i,a,o.featureSet.features):"esriGeometryPolygon"===s&&w(c,a,o.featureSet.features)})),o.groundOverlays&&o.groundOverlays.forEach((o=>{a.set(o.id,o)})),n.forEach((e=>{e.networkLinkIds.forEach((n=>{const t=function(o,e,n){const s=function(o,e){let n;return e.some((e=>e.id===o&&(n=e,!0))),n}(o,n);return s&&(s.parentFolderId=e,s.networkLink=s),s}(n,e.id,o.networkLinks);t&&s.push(t)}))})),s.forEach((o=>{if(o.featureInfos){o.points=e(t.get("esriGeometryPoint")),o.polylines=e(t.get("esriGeometryPolyline")),o.polygons=e(t.get("esriGeometryPolygon")),o.mapImages=[];for(const e of o.featureInfos)switch(e.type){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryPolygon":{const n=f[e.type].get(e.id);n&&o[p[e.type]].featureSet.features.push(n);break}case"GroundOverlay":{const n=a.get(e.id);n&&o.mapImages.push(n);break}}o.fullExtent=g([o])}}));const l=g(s);return{folders:n,sublayers:s,extent:l}}function P(e,r,i,c){const a=n&&n.findCredential(e);return e=s(e,{token:a&&a.token}),o(t.kmlServiceUrl,{query:{url:e,model:"simple",folders:"",refresh:0!==i||void 0,outSR:JSON.stringify(r)},responseType:"json",signal:c})}function b(o,e,n=null,s=[]){const t=[],r={},i=e.sublayers,c=e.folders.map((o=>o.id));return i.forEach((e=>{const i=new o;if(n?i.read(e,n):i.read(e),s.length&&c.indexOf(i.id)>-1&&(i.visible=-1!==s.indexOf(i.id)),r[e.id]=i,null!=e.parentFolderId&&-1!==e.parentFolderId){const o=r[e.parentFolderId];o.sublayers||(o.sublayers=[]),o.sublayers.unshift(i)}else t.unshift(i)})),t}function w(o,e,n){n.forEach((n=>{o.set(n.attributes[e],n)}))}async function x(o){const e=u.fromJSON(o.featureSet).features,n=m(o.layerDefinition.drawingInfo.renderer),s=y.fromJSON(o.popupInfo),t=[];for(const o of e){const e=await n.getSymbolAsync(o);o.symbol=e,o.popupTemplate=s,o.visible=!0,t.push(o)}return t}function g(o){const e=c(a),n=c(a);for(const s of o){if(s.polygons&&s.polygons.featureSet&&s.polygons.featureSet.features)for(const o of s.polygons.featureSet.features)f(e,o.geometry),l(n,e);if(s.polylines&&s.polylines.featureSet&&s.polylines.featureSet.features)for(const o of s.polylines.featureSet.features)f(e,o.geometry),l(n,e);if(s.points&&s.points.featureSet&&s.points.featureSet.features)for(const o of s.points.featureSet.features)f(e,o.geometry),l(n,e);if(s.mapImages)for(const o of s.mapImages)f(e,o.extent),l(n,e)}return r(n,a)?null:{xmin:n[0],ymin:n[1],zmin:n[2],xmax:n[3],ymax:n[4],zmax:n[5],spatialReference:i.WGS84}}export{b as S,x as b,G as d,P as g,g as j}