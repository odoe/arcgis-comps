import{af as t,A as e,aW as i,V as s,b as r,cq as n,cQ as o,c as a,e as h,ce as l,_ as c,s as u,bv as d,ab as f,K as p,cD as m,aj as g,h as v,cs as y,r as b,aw as w,cR as P,ao as x,co as S,cA as C,cS as A,ap as z,E as F,ax as O,d as M,i as R,P as _}from"./p-e58503d5.js";import{o as T,t as D,d as E,p as L,w as j,z as V}from"./p-8bc9b36a.js";import{h as G}from"./p-e273719b.js";import{u as I,e as B}from"./p-fb38a9d0.js";import{V as U,X as N,I as $,Y as k,Z as W,$ as H,a0 as q,P as J,a1 as Z,a2 as X,a3 as K,a4 as Q,c as Y,a5 as tt,a6 as et,a7 as it,a8 as st,a9 as rt,aa as nt,ab as ot,ac as at,ad as ht,ae as lt,af as ct,ag as ut,ah as dt,ai as ft,aj as pt,ak as mt,W as gt,al as vt,u as yt,am as bt,an as wt,ao as Pt,ap as xt,aq as St,ar as Ct,as as At,at as zt,au as Ft,av as Ot,aw as Mt,ax as Rt,ay as _t,az as Tt,J as Dt,aA as Et,aB as Lt,aC as jt,l as Vt,aD as Gt,aE as It,aF as Bt,aG as Ut,aH as Nt,aI as $t,aJ as kt,aK as Wt,aL as Ht}from"./p-340cd100.js";import{n as qt,w as Jt,t as Zt,e as Xt,b as Kt,c as Qt,d as Yt,o as te,k as ee,a3 as ie,a5 as se,B as re,a7 as ne,a8 as oe,a9 as ae,f as he,aa as le,ar as ce,ad as ue,ae as de,af as fe,ah as pe,a0 as me,m as ge,N as ve,ax as ye,M as be,r as we,K as Pe,G as xe,a as Se,J as Ce,h as Ae,x as ze,y as Fe,X as Oe,ay as Me,az as Re,P as _e,R as Te,E as De,au as Ee,F as Le,I as je,al as Ve,av as Ge,ag as Ie}from"./p-eb48bb01.js";import{t as Be}from"./p-56ed1c7a.js";import{A as Ue}from"./p-a72732f2.js";import{g as Ne,l as $e,e as ke,r as We,u as He,c as qe,n as Je,b as Ze,d as Xe,s as Ke,f as Qe,h as Ye,j as ti}from"./p-bdf9e611.js";import{n as ei,a as ii}from"./p-e654504b.js";import{e as si}from"./p-3721667d.js";import{l as ri,r as ni,j as oi,z as ai,o as hi,s as li,v as ci,b as ui}from"./p-e6fe5d89.js";import{n as di,t as fi,r as pi}from"./p-746a9d8f.js";import{u as mi,d as gi,r as vi,q as yi,c as bi,a as wi,z as Pi,o as xi,I as Si,_ as Ci,e as Ai,B as zi,h as Fi,v as Oi,R as Mi,s as Ri,l as _i,U as Ti,V as Di,t as Ei,n as Li,H as ji,k as Vi}from"./p-2f398ed1.js";import{n as Gi,l as Ii,e as Bi,r as Ui,f as Ni,a as $i,s as ki}from"./p-d3105731.js";import{v as Wi,b as Hi}from"./p-b79fcce3.js";import{v as qi,x as Ji,d as Zi,w as Xi,j as Ki,t as Qi,B as Yi,b as ts}from"./p-c93d2280.js";import{a as es,q as is,w as ss,B as rs,p as ns,V as os,S as as,A as hs,H as ls,f as cs,l as us,G as ds,M as fs,R as ps,c as ms,E as gs,h as vs,g as ys,F as bs,u as ws}from"./p-f94762ac.js";import{u as Ps,M as xs,B as Ss,f as Cs,p as As}from"./p-ea916a39.js";import{J as zs,w as Fs,v as Os}from"./p-3bcc4805.js";import{e as Ms}from"./p-5032dfbd.js";import{L as Rs,w as _s,P as Ts,j as Ds}from"./p-95909347.js";import{x as Es}from"./p-97ec6ae5.js";import{j as Ls,a as js,o as Vs,u as Gs}from"./p-b9aa4901.js";import{e as Is}from"./p-8f986f60.js";import{n as Bs,h as Us,s as Ns,e as $s,i as ks,c as Ws,r as Hs,m as qs,b as Js,l as Zs,x as Xs,f as Ks}from"./p-ccdb8e80.js";import{e as Qs,a as Ys,n as tr}from"./p-2c84c65f.js";import{T as er,i as ir,b as sr,l as rr,u as nr,h as or,c as ar,d as hr,x as lr,a as cr}from"./p-f06611ed.js";import{a as ur,f as dr}from"./p-2f5c7e83.js";import{getVisualVariableValues as fr}from"./p-9f1c2d50.js";import{e as pr,r as mr,n as gr,l as vr,_ as yr}from"./p-4d38e149.js";import{l as br}from"./p-e72a43d7.js";import{T as wr,r as Pr,j as xr}from"./p-728dcbb0.js";import{y as Sr,E as Cr,$ as Ar,o as zr,l as Fr,m as Or,p as Mr,c as Rr}from"./p-d87e82bf.js";import{p as _r}from"./p-765e6c28.js";import{d as Tr}from"./p-2ae44317.js";import{s as Dr}from"./p-0923eebd.js";import{m as Er}from"./p-6b2eb7a7.js";import{f as Lr,c as jr}from"./p-568eb6e8.js";import{V as Vr,k as Gr,F as Ir,L as Br,B as Ur}from"./p-c7a58085.js";import{l as Nr,g as $r}from"./p-37f005a2.js";import{t as kr}from"./p-04a0cfca.js";import{i as Wr}from"./p-7f47b970.js";import{z as Hr,d as qr}from"./p-6ded4c02.js";import{h as Jr,f as Zr,i as Xr,s as Kr}from"./p-19bc1e3d.js";import{p as Qr,r as Yr}from"./p-0d1e969a.js";import{n as tn}from"./p-c2152437.js";import"./p-a131049b.js";import{W as en,R as sn,v as rn,D as nn,p as on,l as an,B as hn,A as ln,b as cn}from"./p-dcdb33cf.js";import{p as un,H as dn}from"./p-01e5a461.js";import{n as fn,o as pn}from"./p-0bb84768.js";import{n as mn}from"./p-b5b00e38.js";import{l as gn,v as vn}from"./p-1c99992b.js";import{f as yn}from"./p-ca295674.js";import{g as bn,a as wn}from"./p-76f37e40.js";function Pn(t,e,i,s){return function(t,e,i,s){s.clip[0]=0,s.clip[1]=i?s.len:Number.MAX_VALUE;for(let i=0;i<t.length;i++)if(!Cn(t[i],e,s))return!1;return!0}(t,e,i,function(t,e,i){const s=Sn;return t?(i&&(s.len=yi(e,i)),vi(s.dir,t)):(s.len=yi(e,i),bi(s.dir,i,e),gi(s.dir,s.dir,1/s.len)),s}(s,e,i))}function xn(t,e,i,s){const r=Pi(i,bi(t,s,e));return mi(t,e,gi(t,i,r))}const Sn={dir:Gi(),len:0,clip:di()};function Cn(t,e,i){const s=Pi(en(t),i.dir),r=-sn(t,e);if(r<0&&s>=0)return!1;if(s>-1e-6&&s<1e-6)return r>0;if((r<0||s<0)&&!(r<0&&s<0))return!0;const n=r/s;return s>0?n<i.clip[1]&&(i.clip[1]=n):n>i.clip[0]&&(i.clip[0]=n),i.clip[0]<=i.clip[1]}function An(t,e,i,s){const r=t.stageObject,n=i.spatialReference,o=r.geometryRecords,a="absolute-height"!==e.mode;let h=0;for(const t of o){const o=t.geometry,l=t.getShaderTransformation();_n[0]=l[12],_n[1]=l[13],_n[2]=l[14],o.invalidateBoundingInfo();const c=o.getMutableAttribute("position"),u=c.data,d=o.vertexAttributes.get("mapPos").data,f=c.size,p=u.length/f,m=new W(d,n);let g=0,v=!1,y=0;for(let t=0;t<p;t++){if(Tn[0]=u[g],Tn[1]=u[g+1],Tn[2]=u[g+2],U(m,i,e,s,Ln),a&&(y+=Ln.sampledElevation),$.TESTS_DISABLE_OPTIMIZATIONS)u[g]=m.array[m.offset],u[g+1]=m.array[m.offset+1],u[g+2]=Ln.z,Ji(u,n,g,u,s.spatialReference,g,1),u[g]-=_n[0],u[g+1]-=_n[1],u[g+2]-=_n[2],v=!0;else{Rn[0]=u[g]+_n[0],Rn[1]=u[g+1]+_n[1],Rn[2]=u[g+2]+_n[2],s.setAltitude(Rn,Ln.z),u[g]=Rn[0]-_n[0],u[g+1]=Rn[1]-_n[1],u[g+2]=Rn[2]-_n[2];const t=Mn/s.unitInMeters;(Math.abs(Tn[0]-u[g])>=t||Math.abs(Tn[1]-u[g+1])>=t||Math.abs(Tn[2]-u[g+2])>=t)&&(v=!0)}g+=f,m.offset+=3}h+=y/p,v&&r.geometryVertexAttrsUpdated(t)}return h/o.length}function zn(t,e,i,s){const r=t.stageObject,n=e.centerPointInElevationSR;let o=0;r.metadata.usesVerticalDistanceToGround?(U(n,i,e,s,Ln),N(r,Ln.verticalDistanceToGround),o=Ln.sampledElevation):(U(n,i,e,s,Ln),"absolute-height"!==e.mode&&(o=Ln.sampledElevation));const a=Bs(Fn,r.transformation),h=xi(En,a[12],a[13],a[14]);$.TESTS_DISABLE_OPTIMIZATIONS?(Rn[0]=n.x,Rn[1]=n.y,Rn[2]=Ln.z,qi(n.spatialReference,Rn,a,s.spatialReference)&&(r.transformation=a)):s.setAltitudeOfTransformation(Ln.z,a);const l=Mn/s.unitInMeters;return(Math.abs(a[12]-h[0])>=l||Math.abs(a[13]-h[1])>=l||Math.abs(a[14]-h[2])>=l)&&(r.transformation=a),o}const Fn=Qs();function On(e,i,s,r){const n=e.graphics3DSymbolLayer.lodRenderer;if(t(n))return 0;const o=i.centerPointInElevationSR;U(o,s,i,r,Ln);const a="absolute-height"!==i.mode?Ln.sampledElevation:0,h=n.instanceData,l=e.instanceIndex,c=Dn;h.getGlobalTransform(l,c);const u=xi(En,c[12],c[13],c[14]);$.TESTS_DISABLE_OPTIMIZATIONS?(Rn[0]=o.x,Rn[1]=o.y,Rn[2]=Ln.z,qi(o.spatialReference,Rn,c,r.spatialReference)&&h.setGlobalTransform(l,c)):r.setAltitudeOfTransformation(Ln.z,c);const d=Mn/r.unitInMeters;return($.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(c[12]-u[0])>=d||Math.abs(c[13]-u[1])>=d||Math.abs(c[14]-u[2])>=d)&&h.setGlobalTransform(l,c),a}const Mn=.01,Rn=Gi(),_n=Gi(),Tn=Gi(),Dn=Qs(),En=Gi(),Ln=new k;class jn{constructor(t,e,i,s,r,n,o,a=null){this.graphics3DSymbolLayer=t,this.stageObject=e,this._uniqueGeometries=i,this._uniqueMaterials=s,this._uniqueTextures=r,this.elevationAligner=n,this.elevationContext=o,this._edgeState=a,this.type="object3d",this._stageLayer=null,this._stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1,this.graphics3DSymbolLayer=t,this.stageObject=e}get isElevationSource(){return!(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)}initialize(t,e){this._stageLayer=e,this._stage=t,t.addMany(this._uniqueMaterials),t.addMany(this._uniqueGeometries),t.addMany(this._uniqueTextures),t.load(this._uniqueTextures),t.add(this.stageObject)}destroy(){const t=this._stage;this._stageLayer&&(t.removeMany(this._uniqueMaterials),t.removeMany(this._uniqueGeometries),t.removeMany(this._uniqueTextures)),t.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1);const e=this._stage.renderView.ensureEdgeView();e.hasObject(this.stageObject)&&e.removeObject(this.stageObject),this.stageObject.dispose(),this._visible=!1,this._stageLayer=null,this._stage=null}layerOpacityChanged(e,i){if(t(this._edgeState))return;const s=Vn(this._edgeState.baseMaterial);let r=!1;for(const t of this._edgeState.edgeMaterials)t.objectTransparency!==s&&(t.objectTransparency=s,r=!0);r&&this.resetEdgeObject(i),this._stage.renderView.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[e])}slicePlaneEnabledChanged(e,i){t(this._edgeState)||(this._stage.renderView.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{slicePlaneEnabled:e},!i),this._edgeState.properties.slicePlaneEnabled=e)}setVisibility(t){if(null!=this._stage&&this._visible!==t&&(this._visible=t,this._visible?this._addedToStage?this.stageObject.setVisible(!0):(this._stageLayer.add(this.stageObject),this._addedToStage=!0):this.stageObject.setVisible(!1),e(this._edgeState))){const e=this._stage.renderView.ensureEdgeView();e.hasObject(this.stageObject)?e.updateObjectVisibility(this.stageObject,t):t&&this.addOrUpdateEdgeObject(e,!1)}}get visible(){return this._visible}alignWithElevation(t,i,s,r){null!=this.elevationAligner&&(e(s)&&H(this.elevationContext.featureExpressionInfoContext,s),this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,t,i),this.resetEdgeObject(r))}getCenterObjectSpace(t=Gi()){return vi(t,Rs(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(t=es()){const e=this.stageObject.boundingVolumeObjectSpace;return is(t,e.min),ss(t,e.max),t}computeAttachmentOrigin(t){if(this.useObjectOriginAsAttachmentOrigin){const e=this.stageObject.transformation;t.render.origin[0]+=e[12],t.render.origin[1]+=e[13],t.render.origin[2]+=e[14],t.render.num++}else for(const e of this.stageObject.geometryRecords)e.computeAttachmentOrigin(Bn)&&(Si(Bn,Bn,this.stageObject.transformation),mi(t.render.origin,t.render.origin,Bn),t.render.num++)}async getProjectedBoundingBox(t,e,s,r,n){const o=this.getBoundingBoxObjectSpace(n),a=Un,h=as(o)?1:a.length;for(let t=0;t<h;t++){const e=a[t];In[0]=o[e[0]],In[1]=o[e[1]],In[2]=o[e[2]],Si(In,In,this.stageObject.transformation),Gn[3*t+0]=In[0],Gn[3*t+1]=In[1],Gn[3*t+2]=In[2]}if(!t(Gn,0,h))return null;rs(o);let l=null;this.calculateRelativeScreenBounds&&(l=this.calculateRelativeScreenBounds());for(let t=0;t<3*h;t+=3){for(let e=0;e<3;e++)o[e]=Math.min(o[e],Gn[t+e]),o[e+3]=Math.max(o[e+3],Gn[t+e]);l&&s.push({location:Gn.slice(t,t+3),screenSpaceBoundingRect:l})}if(e&&e.service&&"absolute-height"!==this.elevationContext.mode){ns(o,Bn);const t="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let s=0;if(e.useViewElevation)s=i(e.service.getElevation(Bn[0],Bn[1],t),0);else try{const n=q(o,e);s=i(await e.service.queryElevation(Bn[0],Bn[1],r,n,t),0)}catch(t){}os(o,0,0,-this.alignedSampledElevation+s)}return o}addObjectState(t,e){0===t&&e.addObject(this.stageObject,this.stageObject.highlight()),1===t&&e.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(t){t.removeObject(this.stageObject)}resetEdgeObject(e){if(t(this._edgeState))return;const i=this._stage.renderView.ensureEdgeView();this._visible?this.addOrUpdateEdgeObject(i,e):i.removeObject(this.stageObject)}addOrUpdateEdgeObject(e,i){const s=this._edgeState;if(t(s))return;const r=Vn(s.baseMaterial);for(const t of s.edgeMaterials)t.objectTransparency=r;e.addOrUpdateObject3D(this.stageObject,s.edgeMaterials,s.properties,!i).then((()=>{var t;return null==(t=this._stageLayer)?void 0:t.sync()}))}}function Vn(t){return t.isVisible?t.parameters.transparent?1:2:0}const Gn=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],In=Gi(),Bn=Gi(),Un=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];class Nn{constructor(t){this.schedule=t,this._loadStatus=0,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(e,i){return 1===this._loadStatus?(e&&e(),s(this._loader)):2===this._loadStatus?(i&&i(this._loadError),s(this._loader)):(t(this._loader)&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then((()=>{this._abortController=null,this._loadStatus=1}),(t=>{throw this._loadError=t,this._abortController=null,this._loadStatus=2,!r(t)&&this.logger&&t.message&&this.logger.warn(t.message),t}))),this._loader.then(e,i).catch((()=>{})),this._loader)}abortLoad(){e(this._abortController)?this._abortController=n(this._abortController):0===this._loadStatus&&(this._loadStatus=2),this._loader=null}}function $n(t,e){const i=(t,i,s=!1)=>({levels:t.map((t=>{const r=i(t.tesselation);return s&&J.cgToGIS(r),{components:[{geometry:r,material:e}],faceCount:r.indexCount/3,minScreenSpaceRadius:t.minScreenSpaceRadius}}))});switch(t){case"sphere":return i([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],(t=>J.createPolySphereGeometry(.5,t,!0)));case"cube":return i([{tesselation:0,minScreenSpaceRadius:0}],(()=>J.createBoxGeometry(1)));case"cone":return i(kn,(t=>J.createConeGeometry(1,.5,t,!1)),!0);case"inverted-cone":return i(kn,(t=>J.createConeGeometry(1,.5,t,!0)),!0);case"cylinder":return i(kn,(t=>J.createCylinderGeometry(1,.5,t,[0,0,1],[0,0,.5])));case"tetrahedron":return i([{tesselation:0,minScreenSpaceRadius:0}],(()=>J.createTetrahedronGeometry(1)),!0);case"diamond":return i([{tesselation:0,minScreenSpaceRadius:0}],(()=>J.createDiamondGeometry(1)),!0);default:return}}const kn=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];function Wn(t,e){return Hn(function(t){return t&&t.enabled&&t.edges||null}(t),e)}function Hn(i,s){if(t(i))return null;const r=e(i.color)?pr(G.toUnitRGBA(i.color)):mr(0,0,0,0),n=I(i.size),o=I(i.extensionLength);switch(i.type){case"solid":return qn({color:r,size:n,extensionLength:o,...s});case"sketch":return function(t){return{...Zn,...t,type:"sketch"}}({color:r,size:n,extensionLength:o,...s});default:return}}function qn(t){return{...Jn,...t,type:"solid"}}const Jn={color:mr(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:2},Zn={color:mr(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:2};function Xn(t){const e=[];return t.levels.forEach((t=>{t.components.forEach((t=>{e.push(t.material)}))})),o(e)}function Kn(t){const e=[];return t.components.forEach((t=>{e.push(t.geometry)})),o(e)}const Qn={primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:{bytesPerFeature:0,bytesPerCoordinate:0,bytesPerFeatureLabel:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}}};function Yn(t){return"web-style"===t.type?Qn:to(t.symbolLayers.toArray().map((e=>so(t,e))))}function to(e){let i=0,s=0,r=0,n=!1,o=0;const a={bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}};for(const h of e)t(h)||(i+=h.primitivesPerFeature,s+=h.primitivesPerCoordinate,r+=h.drawCallsPerFeature,a.bytesPerFeature+=h.memory.bytesPerFeature,a.bytesPerFeatureLabel+=h.memory.bytesPerFeatureLabel,a.bytesPerCoordinate+=h.memory.bytesPerCoordinate,a.draped.bytesPerFeature+=h.memory.bytesPerFeature,a.draped.bytesPerFeatureLabel+=h.memory.bytesPerFeatureLabel,a.draped.bytesPerCoordinate+=h.memory.bytesPerCoordinate,n=n||h.estimated,++o);return{primitivesPerFeature:i,primitivesPerCoordinate:s,drawCallsPerFeature:r,estimated:n,memory:a,numComplexities:o}}function eo(t){const e=to(t);return e.numComplexities>0&&(e.primitivesPerFeature/=e.numComplexities,e.primitivesPerCoordinate/=e.numComplexities,e.drawCallsPerFeature/=e.numComplexities,e.memory.bytesPerFeature/=e.numComplexities,e.memory.bytesPerFeatureLabel/=e.numComplexities,e.memory.bytesPerCoordinate/=e.numComplexities,e.memory.draped.bytesPerFeature/=e.numComplexities,e.memory.draped.bytesPerFeatureLabel/=e.numComplexities,e.memory.draped.bytesPerCoordinate/=e.numComplexities),e}const io={};function so(t,i){const s=ro(t,i),r=function(t){return t&&t.enabled&&("extrude"===t.type||function(t){return"fill"===t.type}(t))&&e(t.edges)}(i)?2:0;switch(i.type){case"extrude":return{primitivesPerFeature:-4,primitivesPerCoordinate:4,drawCallsPerFeature:r,estimated:!1,memory:s};case"fill":return"mesh-3d"===t.type?{primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:r,estimated:!1,memory:s}:e(i.outline)&&i.outline.size>0?{primitivesPerFeature:-4,primitivesPerCoordinate:3,drawCallsPerFeature:0,estimated:!1,memory:s}:{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:s};case"water":return{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:s};case"line":return{primitivesPerFeature:-2,primitivesPerCoordinate:2,drawCallsPerFeature:0,estimated:!1,memory:s};case"object":return i.resource&&i.resource.href?{primitivesPerFeature:16,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:s}:{...no(i.resource&&i.resource.primitive||T),memory:s};case"path":{const t=3,e=3,r=10;let n=0,o=0;switch(i.profile){case"circle":n=r;break;case"quad":n=4;break;default:return void mn()}switch(i.join){case"round":o=t;break;case"miter":case"bevel":o=1;break;default:return void mn()}const a=2*n,h=n*o*2;let l=-2*h-a;switch(i.cap){case"none":break;case"butt":case"square":l+=2*(n-1);break;case"round":l+=2*(n*(e-1)*2+n);break;default:return}return{primitivesPerFeature:l,primitivesPerCoordinate:h+a,drawCallsPerFeature:0,estimated:!1,memory:s}}case"text":case"icon":return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:s};default:return}}function ro(t,i){const s="point-3d"===t.type;switch(i.type){case"extrude":return i.edges&&i.edges.size>0?oo.EXTRUDE_EDGES:oo.EXTRUDE;case"fill":return e(i.outline)&&i.outline.size>0?oo.FILL_OUTLINE:oo.FILL;case"water":return oo.FILL;case"line":return"round"===i.join?oo.LINE_ROUND:oo.LINE_MITER;case"path":switch(i.join){case"round":switch(i.profile){case"circle":return oo.PATH_ROUND_CIRCLE;case"quad":return oo.PATH_ROUND_QUAD;default:return void mn()}case"miter":case"bevel":switch(i.profile){case"circle":return oo.PATH_MITER_CIRCLE;case"quad":return oo.PATH_MITER_QUAD;default:return void mn()}default:return void mn()}case"object":return s?oo.OBJECT_POINT:oo.OBJECT_POLYGON;case"icon":case"text":return s?oo.ICON_POINT:oo.ICON_POLYGON;default:return}}function no(t){let e=io[t];return e||(e={primitivesPerFeature:Kn($n(t,null).levels[0]).reduce(((t,e)=>t+e.indices.get("position").length/3),0),primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1},io[t]=e,e)}const oo={ICON_POINT:{bytesPerFeature:7127.413186968842,bytesPerFeatureLabel:4826.302896296296,bytesPerCoordinate:0,draped:{bytesPerFeature:3929.4396628895197,bytesPerFeatureLabel:3550.1332222222227,bytesPerCoordinate:0}},ICON_POLYGON:{bytesPerFeature:9329.452613976147,bytesPerFeatureLabel:3675.3372604938268,bytesPerCoordinate:60.177252982212096,draped:{bytesPerFeature:6190.247450139383,bytesPerFeatureLabel:3744.074358024691,bytesPerCoordinate:59.488211068026104}},OBJECT_POINT:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0,draped:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0}},OBJECT_POLYGON:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506,draped:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506}},LINE_MITER:{bytesPerFeature:7321.028181375921,bytesPerFeatureLabel:4048.0226716049388,bytesPerCoordinate:186.55621386363578,draped:{bytesPerFeature:4246.856619435009,bytesPerFeatureLabel:3852.3737679012347,bytesPerCoordinate:163.47884002621583}},LINE_ROUND:{bytesPerFeature:7482.205842738954,bytesPerFeatureLabel:4045.886987654321,bytesPerCoordinate:191.5452524171851,draped:{bytesPerFeature:4473.481387957992,bytesPerFeatureLabel:3842.1112395061728,bytesPerCoordinate:167.27703460226945}},PATH_MITER_CIRCLE:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275,draped:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275}},PATH_ROUND_CIRCLE:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957,draped:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957}},PATH_MITER_QUAD:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203,draped:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203}},PATH_ROUND_QUAD:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826,draped:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826}},FILL:{bytesPerFeature:9478.244183633637,bytesPerFeatureLabel:3713.816824691358,bytesPerCoordinate:95.9343604185578,draped:{bytesPerFeature:6287.911108168086,bytesPerFeatureLabel:3790.785032098766,bytesPerCoordinate:83.08783220478168}},FILL_OUTLINE:{bytesPerFeature:13085.871870349445,bytesPerFeatureLabel:3392.613241975309,bytesPerCoordinate:118.63968023169875,draped:{bytesPerFeature:8437.199992480122,bytesPerFeatureLabel:3973.5431172839503,bytesPerCoordinate:106.33556817014312}},EXTRUDE:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477,draped:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477}},EXTRUDE_EDGES:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312,draped:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312}}},ao=a.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class ho extends Nn{constructor(t,e,i,s){super(i.schedule),this._context=i,this._elevationInfoOverride=null,this.complexity=null,this.logger=ao,this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.symbol=t,this.symbolLayer=e,this._renderPriority=s.renderPriority,this._renderPriorityStep=s.renderPriorityStep,this._elevationContext=new Z,this.complexity=this.computeComplexity(),this._updateDrivenProperties(s.ignoreDrivers),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(t,e,i,s){const r="polygons"in t?t.polygons:null,n=`${s} geometry failed to be created`;let o=null;t.projectionSuccess?!e.length||1===e.length&&!e[0].length?o=`${n} (no ${i} were defined)`:Array.isArray(e)&&Array.isArray(e[0])?r&&0===r.length&&"rings"===i&&e.length>0&&e[0].length>2&&(o=`${n} (filled rings should use clockwise winding - try reversing the order of vertices)`):o=`${n} (${i} should be defined as a 2D array)`:o=`${n} (failed to project geometry to view spatial reference)`,o&&ao.warnOncePerTick(o)}_validateGeometry(t,i=null,s=null){if(e(i)&&!i.includes(t.type))return this.logger.warn("unsupported geometry type for "+s+` symbol: ${t.type}`),!1;if("point"===t.type){const e=t;if(!isFinite(e.x)||!isFinite(e.y))return ao.warn("point coordinate is not a valid number, graphic skipped"),!1}return!0}_defaultElevationInfoNoZ(){return co}_defaultElevationInfoZ(){return uo}_updateElevationContext(){e(this._elevationInfoOverride)?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(t){return t.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(t,e=this.getDefaultElevationInfo(t)){return this._elevationContext.mode||e.mode}setElevationInfoOverride(t){this._elevationInfoOverride=t,this._updateElevationContext()}setGraphicElevationContext(t,e){const r=s(t.geometry),n=this.getDefaultElevationInfo(r);e.unit=null!=this._elevationContext.unit?this._elevationContext.unit:n.unit,e.mode=this.getGeometryElevationMode(r,n),e.offsetMeters=i(this._elevationContext.meterUnitOffset,i(n.offset,0));const o=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===e.mode;return o&&(e.mode="relative-to-ground",e.offsetMeters=0),e.updateFeatureExpressionInfoContext(o?Q:this._elevationContext.featureExpressionInfoContext,t,this._context.layer),e}prepareSymbolLayerPatch(t){}updateGeometry(t,e){return!1}onRemoveGraphic(t){}_updateDrivenProperties(t){const e={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};if(t)return void(this._drivenProperties=e);const i=this._context.renderer;i&&"visualVariables"in i&&i.visualVariables&&i.visualVariables.forEach((t=>{switch(t.type){case"color":if(e.color=!0,t.stops)for(let i=0;i<t.stops.length;i++){const s=t.stops[i].color;s&&(e.opacity=!0,s.a<1&&(e.opacityAlwaysOpaque=!1))}break;case"opacity":e.opacity=!0,e.opacityAlwaysOpaque=!1;break;case"size":e.size=!0}})),this._drivenProperties=e}_getLayerOpacity(){if(this._context.layerView&&"fullOpacity"in this._context.layerView)return this._context.layerView.fullOpacity;const t=this._context.layer.opacity;return null==t?1:t}_getCombinedOpacity(t,i=fo){let s=1;return this.draped||(s*=this._getLayerOpacity()),this._drivenProperties.opacity||(e(t)?s*=t.a:i.hasIntrinsicColor||(s=0)),s}_getCombinedOpacityAndColor(t,i=fo){const s=this._getCombinedOpacity(t,i);if(this._drivenProperties.color)return X(null,s);const r=e(t)?G.toUnitRGB(t):Ii;return X(r,s)}_getVertexOpacityAndColor(t,i=null){const s=X(this._drivenProperties.color?t.color:null,this._drivenProperties.opacity?t.opacity:null);return e(i)&&(s[0]*=i,s[1]*=i,s[2]*=i,s[3]*=i),s}isFastUpdatesEnabled(){return this._fastUpdates&&this._fastUpdates.enabled}computeComplexity(){return so(this.symbol,this.symbolLayer)}globalPropertyChanged(t,e,i){switch(t){case"opacity":return this.layerOpacityChanged(e,i);case"elevationInfo":{const t=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(e,i,t)!==K.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(e,i);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged();default:return!1}}updateGraphics3DGraphicElevationInfo(t,i,s){let r=K.UPDATE;return t.forEach((t=>{const n=i(t);e(n)?(this.setGraphicElevationContext(t.graphic,n.elevationContext),n.needsElevationUpdates=s(n.elevationContext.mode)):r=K.RECREATE})),r}applyRendererDiff(t,e){return!1}getFastUpdateAttrValues(t){if(!this._fastUpdates.enabled)return null;const e=this._fastUpdates.visualVariables,i=e.size?lo(e.size.field,t):0,s=e.color?lo(e.color.field,t):0,r=e.opacity?lo(e.opacity.field,t):0;return mr(i,s,r,0)}get draped(){return this._draped}ensureDrapedStatus(t){return null==this._draped?(this._draped=t,!0):(t!==this.draped&&ao.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}}function lo(t,e){const i=null!=t?e.attributes[t]:0;return null!=i&&isFinite(i)?i:0}const co={mode:"on-the-ground",offset:0,unit:"meters"},uo={mode:"absolute-height",offset:0,unit:"meters"},fo={hasIntrinsicColor:!1};function po(t){const e=new qt;return e.include(Y),e.include(tt,t),e.include(Jt,t),e.attributes.add("uv0","vec2"),e.vertex.uniforms.add("lineSize","float").add("pixelToNDC","vec2").add("borderSize","float").add("screenOffset","vec2"),e.varyings.add("coverageSampling","vec4"),e.varyings.add("lineSizes","vec2"),t.multipassGeometryEnabled&&e.varyings.add("depth","float"),e.vertex.code.add(Zt`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 endPoint = projectPositionHUD(projectAux);

      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
    ${t.occlusionTestEnabled?Zt`
      if (!testVisibilityHUD(endPoint)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }`:""}

    ${t.screenSizePerspectiveEnabled?Zt`
      vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);
        `:Zt`
      vec2 screenOffsetScaled = screenOffset;
        `}
      // Add view dependent polygon offset to get exact same original starting point. This is mostly
      // used to get the correct depth value
      vec3 posView = (view * vec4(position, 1.0)).xyz;
      ${t.multipassGeometryEnabled?"depth = posView.z;":""}

      applyHUDViewDependentPolygonOffset(auxpos1.w, projectAux.absCosAngle, posView);
      vec4 startPoint = proj * vec4(posView, 1.0);
      // Apply screen offset to both start and end point
      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
      startPoint.xy += screenOffsetNorm * startPoint.w;
      endPoint.xy += screenOffsetNorm * endPoint.w;
      // Align start and end to pixel origin
      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${t.depthHudEnabled?t.depthHudAlignStartEnabled?Zt`endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);`:Zt`startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);`:""}
      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);
      // The direction of the line in screen space
      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${t.screenSizePerspectiveEnabled?Zt`
      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);
        `:Zt`
      float lineSizeScaled = lineSize;
      float borderSizeScaled = borderSize;
        `}
      float halfPixelSize = lineSizeScaled * 0.5;
      // Calculate a pixel offset from the edge of the pixel, s.t. we keep the line aligned
      // to pixels if it has a full pixel size. Since pixel aligned biases to the bottom-left,
      // we bias the size to the right (for odd sizes) to balance out the bias. Grow sub-pixel
      // sizes towards the left or right s.t. there is a smooth transition (e.g. from 2 to 3 px).
      float halfWholePixelSize = floor(lineSizeScaled) * 0.5;
      float halfPixelSizeInt = floor(halfWholePixelSize);

      // Sub-pixel offset if we need to grow sub-pixels to the left
      float subpixelOffset = -fract(lineSizeScaled) * float(halfWholePixelSize > 0.0);

      // Pixel offset aligning to whole pixels and adding subpixel offset if needed
      float pixelOffset = -halfPixelSizeInt + subpixelOffset;

      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
      float padding = 1.0 + borderSizeScaled;
      vec2 ndcOffset = (pixelOffset - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

      // Offset x/y from the center of the line in screen space
      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

      // Compute a coverage varying which we can use in the fragment shader to determine
      // how much a pixel is actually covered by the line (i.e. to anti alias the line).
      // This works by computing two coordinates that can be linearly interpolated and then
      // subtracted to find out how far away from the line edge we are.
      float edgeDirection = (uv0.x * 2.0 - 1.0);

      float halfBorderSize = 0.5 * borderSizeScaled;
      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

      coverageSampling = vec4(
        // Edge coordinate
        outerEdgeCoverageSampler,

        // Border edge coordinate
        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

        // Line offset
        halfPixelSize - 0.5,

        // Border offset
        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
      );

      lineSizes = vec2(lineSizeScaled, borderSizeScaled);

      gl_Position = projectedPosition;
    }
  `),e.fragment.uniforms.add("color","vec4"),e.fragment.uniforms.add("borderColor","vec4"),t.multipassGeometryEnabled&&(e.fragment.include(et,t),e.fragment.uniforms.add("inverseViewport","vec2")),e.fragment.code.add(Zt`
    void main() {
      ${t.multipassGeometryEnabled?"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }":""}

      // Mix between line and border coverage offsets depending on whether we need
      // a border (based on the sidedness).
      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

      // Mix between border and line color based on the line coverage (conceptually the line
      // blends on top of the border background).
      //
      // Anti-alias by blending final result using the full (including optional border) coverage
      // and the color alpha
      float borderAlpha = color.a * borderColor.a * coverage.y;
      float colorAlpha = color.a * coverage.x;

      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);

    ${t.depthHudEnabled?Zt`
      if (finalAlpha < 0.01) {
        discard;
      }
      `:Zt`
      // Compute the finalRgb, but keep it pre-multiplied (for unpre-multiplied you
      // need to divide by finalAlpha). We avoid the division here by setting the
      // appropriate blending function in the material.
      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, color.rgb, colorAlpha);
      gl_FragColor = vec4(finalRgb, finalAlpha);
      `}
  }
  `),e}var mo;function go(t,e,i){3===i.length?t.setUniform4f(e,i[0],i[1],i[2],1):t.setUniform4fv(e,i)}(mo||(mo={})).bindUniforms=function(t,e,i){go(t,"color",e.color),t.setUniform1f("pixelRatio",i),t.setUniform2f("screenOffset",e.screenOffset[0]*i,e.screenOffset[1]*i),null!==e.borderColor?(go(t,"borderColor",e.borderColor),t.setUniform1f("borderSize",i)):(t.setUniform4f("borderColor",0,0,0,0),t.setUniform1f("borderSize",0))};const vo=Object.freeze({__proto__:null,build:po,get LineCallout(){return mo}});class yo extends Qt{initializeProgram(t){const e=yo.shader.get(),i=this.configuration,s=e.build({occlusionTestEnabled:i.occlusionTestEnabled,verticalOffsetEnabled:i.verticalOffset,screenSizePerspectiveEnabled:i.screenSizePerspective,depthHudEnabled:i.depthHudEnabled,depthHudAlignStartEnabled:i.depthHudAlignStartEnabled,screenCenterOffsetUnitsEnabled:i.screenCenterOffsetUnitsEnabled,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,viewingMode:t.viewingMode,isDraped:!1,multipassGeometryEnabled:i.multipassGeometryEnabled});return new Yt(t.rctx,s,te)}bindPass(t,e){ee(this.program,e.camera.projectionMatrix),mo.bindUniforms(this.program,t,e.camera.pixelRatio||1),ie(this.program,t,e),it(this.program,e),this.program.setUniform2fv("cameraNearFar",e.camera.nearFar),this.program.setUniform2fv("inverseViewport",e.inverseViewport),st(this.program,e),this.program.bindTexture(e.hudVisibilityTexture,"hudVisibilityTexture"),this.program.setUniform1f("cameraGroundRelative",e.camera.aboveGround?1:-1),this.program.setUniform1f("polygonOffset",t.shaderPolygonOffset),se(this.program,e),this.program.setUniform1f("perDistancePixelRatio",Math.tan(e.camera.fovY/2)/(e.camera.fullViewport[2]/2)),this.program.setUniformMatrix4fv("viewNormal",e.camera.viewInverseTransposeMatrix),this.program.setUniform2f("pixelToNDC",2/e.camera.fullViewport[2],2/e.camera.fullViewport[3]);const i=e.camera.pixelRatio||1;this.program.setUniform1f("lineSize",Math.ceil(t.size)*i),re(t.screenSizePerspective,this.program,"screenSizePerspectiveAlignment")}bindDraw(t){ne(this.program,t),oe(this.program,t.origin,t.camera.viewInverseTransposeMatrix),ae(this.program,this.configuration,t),this.program.rebindTextures()}setPipelineState(t){const e=t?519:513;return Ne(this.configuration.depthHudEnabled?{depthTest:{func:e},depthWrite:$e}:{blending:ke(1,770,771,771),depthTest:{func:e},colorWrite:We})}initializePipeline(){return this.setPipelineState(this.configuration.multipassGeometryEnabled)}}yo.shader=new he(vo,(()=>import("./p-cfd47bc4.js")));class bo extends Kt{constructor(){super(...arguments),this.occlusionTestEnabled=!0,this.verticalOffset=!1,this.screenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.screenCenterOffsetUnitsEnabled=0,this.slicePlaneEnabled=!1,this.multipassGeometryEnabled=!1}}h([Xt()],bo.prototype,"occlusionTestEnabled",void 0),h([Xt()],bo.prototype,"verticalOffset",void 0),h([Xt()],bo.prototype,"screenSizePerspective",void 0),h([Xt()],bo.prototype,"depthHudEnabled",void 0),h([Xt()],bo.prototype,"depthHudAlignStartEnabled",void 0),h([Xt({count:2})],bo.prototype,"screenCenterOffsetUnitsEnabled",void 0),h([Xt()],bo.prototype,"slicePlaneEnabled",void 0),h([Xt()],bo.prototype,"multipassGeometryEnabled",void 0);class wo extends le{constructor(t){super(t,xo),this.techniqueConfig=new bo,this._uniqueMaterialIdentifier=wo.uniqueMaterialIdentifier(this.parameters)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}getPassParameters(){return this.parameters}getTechniqueConfig(t,e){const i=18!==(null==e?void 0:e.slot);return this.techniqueConfig.occlusionTestEnabled=this.parameters.occlusionTest,this.techniqueConfig.verticalOffset=!!this.parameters.verticalOffset,this.techniqueConfig.screenSizePerspective=!!this.parameters.screenSizePerspective,this.techniqueConfig.depthHudEnabled=i,this.techniqueConfig.depthHudAlignStartEnabled=!!this.parameters.depthHUDAlignStart,this.techniqueConfig.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits?1:0,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.multipassGeometryEnabled=!!e&&e.multipassGeometryEnabled,this.techniqueConfig}intersect(){}requiresSlot(t){switch(t){case 18:case 19:return!0}return!1}createGLMaterial(t){return 0===t.output?new Po(t):null}createBufferWriter(){return new Ao}validateParameters(t){const e=wo.uniqueMaterialIdentifier(t);e!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=e)}static uniqueMaterialIdentifier(t){return JSON.stringify({screenOffset:t.screenOffset||[0,0],centerOffsetUnits:t.centerOffsetUnits||"world"})}}class Po extends ce{updateParameters(t){return this.ensureTechnique(yo,t)}beginSlot(t){return this.updateParameters(t)}bind(t,e){e.bindPass(this._material.getPassParameters(),t)}}const xo={verticalOffset:null,screenSizePerspective:null,screenOffset:[0,0],color:[0,0,0,1],size:1,borderColor:null,occlusionTest:!1,shaderPolygonOffset:1e-5,depthHUDAlignStart:!1,centerOffsetUnits:"world",slicePlaneEnabled:!1,...ue},So=Ue().vec3f("position").vec3f("normal").vec2f("uv0").vec4f("auxpos1"),Co=[Be(0,0),Be(1,0),Be(0,1),Be(1,0),Be(1,1),Be(0,1)];class Ao{constructor(){this.vertexBufferLayout=So}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return 6*t.indices.get("position").length}write(t,e,i,s){de(e.indices.get("position"),e.vertexAttributes.get("position").data,t.transformation,i.position,s,6),fe(e.indices.get("normal"),e.vertexAttributes.get("normal").data,t.invTranspTransformation,i.normal,s,6),pe(e.indices.get("auxpos1"),e.vertexAttributes.get("auxpos1").data,i.auxpos1,s,6);for(let t=0;t<Co.length;++t)i.uv0.setVec(s+t,Co[t])}}class zo extends ho{constructor(t,e){super(t,null,e,Ro),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._material=new wo(this.materialParameters),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}perInstanceMaterialParameters(t){const e=this.materialParameters;return e.screenOffset=t.screenOffset||[0,0],e.centerOffsetUnits=t.centerOffsetUnits||"world",e}get materialParameters(){const t=this.symbol,i=t.callout,s=e(i.color)?G.toUnitRGBA(i.color):[0,0,0,0];s[3]*=this._getLayerOpacity();const r=I(i.size||0);let n=null;if(t.verticalOffset){const{screenLength:e,minWorldLength:i,maxWorldLength:s}=t.verticalOffset;n={screenLength:I(e),minWorldLength:i||0,maxWorldLength:null!=s?s:1/0}}const o=e(i.border)&&e(i.border.color)?G.toUnitRGBA(i.border.color):null,a="object"===t.symbolLayers.getItemAt(0).type;return{color:s,size:r,verticalOffset:n,screenSizePerspective:this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,screenOffset:[0,0],centerOffsetUnits:"world",borderColor:o,occlusionTest:!a,shaderPolygonOffset:a?0:void 0,depthHUDAlignStart:"label-3d"===t.type,slicePlaneEnabled:this._context.slicePlaneEnabled,renderOccluded:ue.renderOccluded}}_defaultElevationInfoNoZ(){return Mo}createGraphics3DGraphic(e){const i=e.renderingInfo,s=e.graphic,r=this.setGraphicElevationContext(s,new Z,i.elevationOffset||0),n=i.symbol,o="on-the-ground"===this._elevationContext.mode&&("cim"===n.type||!n.symbolLayers.some((t=>"object"===t.type||"text"===t.type)));if("label-3d"!==n.type&&o)return null;const a=rt(s.geometry);return t(a)?null:this._createAs3DShape(a,r,i,s.uid)}layerOpacityChanged(){return t(this._material)||this._material.setParameters(this.materialParameters),!0}layerElevationInfoChanged(t,i,s){const r=ht(zo.elevationModeChangeTypes,s,this._elevationContext.mode);return r!==K.UPDATE||t.forEach((t=>{const s=i(t);e(s)&&this.updateGraphicElevationContext(t.graphic,s)})),r}slicePlaneEnabledChanged(){return t(this._material)||this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}setGraphicElevationContext(t,e,i=0){const s=super.setGraphicElevationContext(t,e);return s.addOffsetRenderUnits(i),s}updateGraphicElevationContext(t,e){this.setGraphicElevationContext(t,e.elevationContext,e.metadata.elevationOffset),e.needsElevationUpdates=nt(e.elevationContext.mode)}updateGeometry(t,e){return!1}computeComplexity(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:Qn.memory}}createVertexData(t){const{translation:e,centerOffset:i}=t;return[["position",e?{size:3,data:[e[0],e[1],e[2]],exclusive:!0}:{size:3,data:[0,0,0],exclusive:!0}],["normal",{size:3,data:[0,0,1],exclusive:!0}],["auxpos1",i?{size:4,data:[i[0],i[1],i[2],i[3]],exclusive:!0}:{size:4,data:[0,0,0,1],exclusive:!0}]]}_getOrCreateMaterial(i){const s=this.perInstanceMaterialParameters(i),r=wo.uniqueMaterialIdentifier(s);if(e(this._material)&&r===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(i.materialCollection){let e=i.materialCollection.get(r);return t(e)&&(e=new wo(s),i.materialCollection.add(r,e)),{material:e,isUnique:!1}}return{material:new wo(s),isUnique:!0}}_createAs3DShape(t,e,i,s){const r=[new me(this.createVertexData(i),Oo,1)],n=this._getOrCreateMaterial(i),o=ot(this._context,t,r,[n.material],e,this._context.layer.uid,s);if(null===o)return null;const a=new jn(this,o.object,r,n.isUnique?[n.material]:null,null,zn,e);return a.metadata={elevationOffset:i.elevationOffset||0},a.alignedSampledElevation=o.sampledElevation,a.needsElevationUpdates=nt(e.mode),at(a,t,this._context.elevationProvider),a}}zo.elevationModeChangeTypes={definedChanged:K.UPDATE,staysOnTheGround:K.UPDATE,onTheGroundChanged:K.RECREATE};const Fo=new Uint16Array([0]),Oo=[["position",Fo],["normal",Fo],["auxpos1",Fo]],Mo={mode:"relative-to-ground",offset:0},Ro={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1},_o=a.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function To(t,e){if(!D(t))return _o.error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${t.type}' does not support callouts`),null;if(!t.callout)return null;const i=Do[t.callout.type];return i?new i(t,e):(_o.error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${t.callout.type}`),null)}const Do={line:zo};class Eo{constructor(t,e,i){this.graphic=t,this.renderingInfo=e,this.layer=i}}const Lo=new l(Array,(t=>hs(t,ls)),null,10,5),jo=Ps();class Vo{constructor(t,i,s,r,n){this.graphic=t,this.graphics3DSymbol=i,this.graphics=s,this._labelGraphics=new Array,this._auxiliaryGraphics=new Array,this._visibilityFlags=function(){const t=new Array(2);for(let e=0;e<t.length;e++)t[e]=new Array(4);return t}(),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++i.referenced,this._featureExpressionFeature=n?lt(n,t,r):null;for(const t of s)e(t)&&(this.isElevationSource=this.isElevationSource||t.isElevationSource)}get labelGraphics(){return this._labelGraphics}get extent(){return this._extent}initialize(t,e,i){this._layer=e,this._stage=t,this.forEachSymbolLayerGraphic((s=>{s.initialize(t,e,i),s.setVisibility(this.isVisible())}))}destroy(){this.forEachSymbolLayerGraphic((t=>t.destroy())),this.graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return null==this.graphics}clearLabelGraphics(){this.forEachLabelGraphic((t=>t.destroy())),this._labelGraphics.length=0}addLabelGraphic(t,e,i){this._labelGraphics.push(t),t.initialize(e,i),t.setVisibility(this.isVisible(1))}addAuxiliaryGraphic(t){this._auxiliaryGraphics.push(t),this._layer&&(t.initialize(this._stage,this._layer),t.setVisibility(this.isVisible()))}get isDraped(){let t=!1;return this.forEachSymbolLayerGraphic((e=>{"draped"===e.type&&(t=!0)})),t}isVisible(t=0,e){for(let i=0;i<=t;i++){const t=this._visibilityFlags[i];for(let i=0;i<t.length;++i)if(!1===t[i]&&i!==e)return!1}return!0}hasVisibilityFlag(t,e){return null!=this._visibilityFlags[e][t]}setVisibilityFlag(t,e,i){const s=this.isVisible(i);this._visibilityFlags[i][t]=e;const r=this.isVisible(i);if(s===r)return!1;if(1===i)this.forEachLabelGraphic((t=>t.setVisibility(r)));else{this.forEachSymbolLayerGraphic((t=>t.setVisibility(r)));const t=this.isVisible(1);this.forEachLabelGraphic((e=>e.setVisibility(t)))}return!0}clearVisibilityFlag(t,e=0){return this.setVisibilityFlag(t,void 0,e)}computeExtent(e){if(!this._extent){const i=this.graphic.geometry;if(t(i))return!1;this._extent=Ps(),zs(i,this._extent);const s=i.spatialReference;if(!s.equals(e)&&!Zi(this._extent,s,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(t,i){return e(this._optimizedGeometry.geometry)&&this._optimizedGeometry.hasZ===t&&this._optimizedGeometry.hasM===i||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,t,i),this._optimizedGeometry.hasZ=t,this._optimizedGeometry.hasM=i),this._optimizedGeometry.geometry}_convertGraphicToOptimizedGeometry(t,e,i){let s=t.geometry;return"mesh"!==s.type&&"extent"!==s.type||(s=Wi.fromExtent("mesh"===s.type?s.extent:s)),Ms(s,e,i)}get usedMemory(){let e=si(this.graphic.attributes);return this.forEachSymbolLayerGraphic((i=>{const s=i.graphics3DSymbolLayer.complexity;if(t(s))return;const r="draped"===i.type?s.memory.draped:s.memory;e+=r.bytesPerFeature,r.bytesPerCoordinate&&(e+=Fs(this.graphic.geometry)*r.bytesPerCoordinate)})),e}computeAttachmentOrigin(){const e={render:{origin:Gi(),num:0},draped:{origin:di(),num:0}};for(const i of this.graphics)t(i)||i.computeAttachmentOrigin(e);return e.render.num&&gi(e.render.origin,e.render.origin,1/e.render.num),e.draped.num&&ri(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,i,s,r,n){return n||(n={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),n.boundingBox?rs(n.boundingBox):n.boundingBox=rs(),n.requiresDrapedElevation=!1,await ei(this.graphics,(async o=>{if(t(o))return;const a="draped"===o.type?i:e,h=Lo.acquire(),l=await o.getProjectedBoundingBox(a,s,n.screenSpaceObjects,r,h);isFinite(l[2])&&isFinite(l[5])||(n.requiresDrapedElevation=!0),l&&cs(n.boundingBox,h),Lo.release(h)})),us(n.boundingBox)||xs(ds(n.boundingBox,jo))?n:null}needsElevationUpdates(){for(const t of this.graphics)if(e(t)&&("object3d"===t.type||"lod-instance"===t.type)&&t.needsElevationUpdates)return!0;for(const t of this._labelGraphics)if(t&&t.needsElevationUpdates)return!0;return!1}alignWithElevation(t,e,i){this.forEachRenderedGraphic((s=>{"object3d"!==s.type&&"lod-instance"!==s.type||s.alignWithElevation(t,e,this._featureExpressionFeature,i)}))}addObjectStateSet(t,e){this.forEachSymbolLayerGraphic((i=>i.addObjectState(t,e)))}removeObjectState(t){this.forEachSymbolLayerGraphic((e=>e.removeObjectState(t)))}forEachGraphicList(t,e){t.forEach((t=>t&&e(t)))}forEachSymbolLayerGraphic(t){this.forEachGraphicList(this.graphics,t),this.forEachGraphicList(this._auxiliaryGraphics,t)}forEachLabelGraphic(t){this.forEachGraphicList(this._labelGraphics,t)}forEachRenderedGraphic(t){this.forEachSymbolLayerGraphic(t),this.forEachLabelGraphic(t)}}function Go(t,i){if(!t||t.symbol)return null;const s=i&&i.renderer;return t&&e(s)&&s.getObservationRenderer?s.getObservationRenderer(t):s}function Io(i,s){const r=Go(i,s),n=function(t,i){if(e(t.symbol))return t.symbol;const s=Go(t,i);return e(s)&&"dot-density"!==s.type?s.getSymbol(t,i):null}(i,s);if(t(n))return null;const o={renderer:r,symbol:n};if(t(r)||!("visualVariables"in r)||!r.visualVariables)return o;const a=fr(r,i,s),h=["proportional","proportional","proportional"];for(const{variable:t,value:e}of a)switch(t.type){case"color":o.color=e.toRgba();break;case"size":if("outline"===t.target)o.outlineSize=e;else{const i=t.useSymbolValue?"symbol-value":e;switch(t.axis){case"width":h[0]=i;break;case"depth":h[1]=i;break;case"height":h[2]=i;break;case"width-and-depth":h[0]=h[1]=i;break;default:h[0]=h[1]=h[2]=i}}break;case"opacity":o.opacity=e;break;case"rotation":switch(t.axis){case"tilt":o.tilt=e;break;case"roll":o.roll=e;break;default:o.heading=e}}return"proportional"===h[0]&&"proportional"===h[1]&&"proportional"===h[2]||(o.size=h),o}async function Bo(t,i){const s=Go(t,i),r=await async function(t,i){if(e(t.symbol))return t.symbol;const s=Go(t,i);return e(s)&&s.getSymbolAsync(t,{...i,abortOptions:{signal:i.signal}})}(t,i);if(!r)return null;const n={renderer:s,symbol:r};if(!s||!("visualVariables"in s)||!s.visualVariables)return n;const o=fr(s,t,i),a=["proportional","proportional","proportional"];for(const{variable:t,value:e}of o)if("color"===t.type)n.color=G.toUnitRGBA(e);else if("size"===t.type)if("outline"===t.target)n.outlineSize=e;else{const i=t.axis,s=t.useSymbolValue?"symbol-value":e;"width"===i?a[0]=s:"depth"===i?a[1]=s:"height"===i?a[2]=s:a[0]=a[1]="width-and-depth"===i?s:a[2]=s}else"opacity"===t.type?n.opacity=e:"rotation"===t.type&&"tilt"===t.axis?n.tilt=e:"rotation"===t.type&&"roll"===t.axis?n.roll=e:"rotation"===t.type&&(n.heading=e);return(isFinite(a[0])||isFinite(a[1])||isFinite(a[2]))&&(n.size=a),n}function Uo(t){const i=[["position",t.indices]],s=[["position",{size:3,data:t.attributeData.position,exclusive:!0}]];return e(t.attributeData.color)&&(s.push(["color",{size:4,data:t.attributeData.color,exclusive:!0}]),i.push(["color",new Uint32Array(t.indices.length)])),e(t.attributeData.uvMapSpace)&&(s.push(["uvMapSpace",{size:4,data:t.attributeData.uvMapSpace,exclusive:!0}]),i.push(["uvMapSpace",t.indices])),e(t.attributeData.boundingRect)&&(s.push(["boundingRect",{size:9,data:t.attributeData.boundingRect,exclusive:!0}]),i.push(["boundingRect",t.indices])),e(t.attributeData.mapPosition)&&(s.push(["mapPos",{size:3,data:t.attributeData.mapPosition,exclusive:!0}]),i.push(["mapPos",t.indices])),new me(s,i)}function No(t){const i=[["position",t.indices],["uv0",t.indices]],s=[["position",{size:3,data:t.attributeData.position,exclusive:!0}],["uv0",{size:2,data:t.attributeData.uv0,exclusive:!0}]];return e(t.attributeData.mapPosition)&&(s.push(["mapPos",{size:3,data:t.attributeData.mapPosition,exclusive:!0}]),i.push(["mapPos",t.indices])),new me(s,i)}function $o(t){switch(t.type){case"extent":if(t instanceof c)return Wi.fromExtent(t);break;case"polygon":return t}return null}function ko(t,e,i,s){const r=br(t.rings,t.hasZ,1),n=new Float64Array(r.position.length),o=ct(r.position,t.spatialReference,0,n,0,r.position,0,r.position.length/3,e,i,s),a=null!=o;return{position:r.position,mapPosition:n,polygons:qo(r.polygons,r.position,n),outlines:Ho(r.outlines,r.position,n),projectionSuccess:a,sampledElevation:o}}function Wo(t,e){const i=br(t.rings,!1,1),s=Ji(i.position,t.spatialReference,0,i.position,e,0,i.position.length/3);for(let t=2;t<i.position.length;t+=3)i.position[t]=ut;return{position:i.position,polygons:qo(i.polygons,i.position),outlines:Ho(i.outlines,i.position),projectionSuccess:s}}function Ho(t,e,i){const s=new Array;for(const{index:r,count:n}of t){if(n<=1)continue;const t=3*r,o=t+3*n;s.push({index:r,count:n,position:e.subarray(t,o),mapPosition:i?i.subarray(t,o):void 0})}return s}function qo(t,e,i){const s=new Array;for(const{index:r,count:n,holeIndices:o,pathLengths:a}of t){if(n<=1)continue;const t=3*r,h=t+3*n,l=o.map((t=>t-r));s.push({index:r,count:n,holeIndices:l,pathLengths:a,position:e.subarray(t,h),mapPosition:i?i.subarray(t,h):void 0})}return s}const Jo=["polygon","extent"];function Zo(t,e,i,s,r,n,o,a,h,l,c,u,d,f){let p=0,m=2*s.count;(function(t,e,i,s,r,n,o,a,h,l,c,u,d,f,p,m,g,v){vi(ha,g);const y=m>0?1:-1;let b=3*i,w=u,P=3*w,x=u+s,S=3*x;for(let i=0;i<s;++i)v&&(ha[0]=t[b+0],ha[1]=t[b+1],ha[2]=t[b+2],wi(ha,ha)),a[P+0]=t[b+0],a[P+1]=t[b+1],a[P+2]=t[b+2],h[P+0]=e[b+0],h[P+1]=e[b+1],h[P+2]=e[b+2],l[P+0]=-y*ha[0],l[P+1]=-y*ha[1],l[P+2]=-y*ha[2],c[w]=0,a[S+0]=t[b+0]+m*ha[0],a[S+1]=t[b+1]+m*ha[1],a[S+2]=t[b+2]+m*ha[2],h[S+0]=e[b+0],h[S+1]=e[b+1],h[S+2]=e[b+2],l[S+0]=y*ha[0],l[S+1]=y*ha[1],l[S+2]=y*ha[2],c[x]=m,P+=3,S+=3,b+=3,w+=1,x+=1;b=0,P=0,S=3*p;const C=m<0?ua:ca,A=m<0?ca:ua;for(let t=0;t<o;++t)f[P+0]=r[b+C[0]],f[P+1]=r[b+C[1]],f[P+2]=r[b+C[2]],d[S+0]=r[b+A[0]]+s,d[S+1]=r[b+A[1]]+s,d[S+2]=r[b+A[2]]+s,P+=3,S+=3,b+=3})(t,e,s.index,s.count,i,0,i.length/3,r,n,o,a,h,l,c,m,u,d,f),m=0,Qo(r,n,a,o,p,s.pathLengths[0],s.count,h+=2*s.count,l,m,u),h+=4*s.pathLengths[0],m+=2*s.pathLengths[0],p+=s.pathLengths[0];for(let t=1;t<s.pathLengths.length;++t)Qo(r,n,a,o,p,s.pathLengths[t],s.count,h,l,m,u),h+=4*s.pathLengths[t],m+=2*s.pathLengths[t],p+=s.pathLengths[t]}function Xo(t,e,i,s,r,n,o){s[n]=s[o],t[0+(n*=3)]=t[0+(o*=3)],t[n+1]=t[o+1],t[n+2]=t[o+2],e[n+0]=e[o+0],e[n+1]=e[o+1],e[n+2]=e[o+2],i[n+0]=r[0],i[n+1]=r[1],i[n+2]=r[2]}const Ko=Gi();function Qo(t,e,i,s,r,n,o,a,h,l,c){let u=r,d=r+1,f=r+o,p=r+o+1,m=a,g=a+1,v=a+2*n,y=a+2*n+1;c<0&&(u=r+o+1,p=r),l*=3;for(let a=0;a<n;++a)a===n-1&&(c>0?(d=r,p=r+o):(d=r,u=r+o)),ra(t,u,d,f,Ko),Xo(t,e,s,i,Ko,m,u),Xo(t,e,s,i,Ko,g,d),Xo(t,e,s,i,Ko,v,f),Xo(t,e,s,i,Ko,y,p),h[l++]=m,h[l++]=v,h[l++]=y,h[l++]=m,h[l++]=y,h[l++]=g,u++,d++,f++,p++,m+=2,g+=2,v+=2,y+=2}const Yo=Gi(),ta=Gi(),ea=Gi(),ia=Gi(),sa=Gi();function ra(t,e,i,s,r){e*=3,i*=3,s*=3,xi(Yo,t[e++],t[e++],t[e++]),xi(ta,t[i++],t[i++],t[i++]),xi(ea,t[s++],t[s++],t[s++]),bi(ia,ta,Yo),bi(sa,ea,Yo),Ci(r,sa,ia),wi(r,r)}const na=Gi();function oa(t,e,i,s){const r=t.stageObject,n=r.geometryRecords,o=n.length,a="absolute-height"!==e.mode;let h=0;const l=r.transformation,c=Us(Qs(),l);for(let t=0;t<o;t+=2){const o=n[t].geometry,u=o.getMutableAttribute("position").data,d=o.vertexAttributes.get("size").data,f=o.vertexAttributes.get("mapPos").data,p=new W(f),m=u.length/3;let g=0,v=!1,y=0;const b=i.spatialReference;for(let t=0;t<m;t++){na[0]=u[g],na[1]=u[g+1],na[2]=u[g+2],U(p,i,e,s,la),a&&(y+=la.sampledElevation),$.TESTS_DISABLE_OPTIMIZATIONS?(xi(aa,p.array[p.offset+0],p.array[p.offset+1],la.z+d[g/3]),s.toRenderCoords(aa,b,aa),Si(aa,aa,c)):(xi(aa,u[g+0],u[g+1],u[g+2]),Si(aa,aa,l),s.setAltitude(aa,la.z+d[g/3]),Si(aa,aa,c)),u[g]=aa[0],u[g+1]=aa[1],u[g+2]=aa[2];const t=da/s.unitInMeters;(Math.abs(na[0]-u[g])>=t||Math.abs(na[1]-u[g+1])>=t||Math.abs(na[2]-u[g+2])>=t)&&(v=!0),p.offset+=3,g+=3}v&&(o.invalidateBoundingInfo(),r.geometryVertexAttrsUpdated(n[t]),n[t+1].geometry.invalidateBoundingInfo(),r.geometryVertexAttrsUpdated(n[t+1])),h+=y/m}return h/o}const aa=Gi(),ha=Gi(),la=new k,ca=[0,2,1],ua=[0,1,2],da=.01;class fa{constructor(t,e,i){this.graphics3DSymbolLayer=t,this.renderGeometries=e,this.boundingBox=i,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this._layerView=null,this.isElevationSource=!1}initialize(t,e,i){this.stage=t,this._layerView=i,this._overlayRenderer=this._layerView.view.basemapTerrain.overlayManager.renderer}setVisibility(t){if(null!=this.stage&&this._visible!==t){if(this._visible=t,t&&!this._addedToStage)return this._addedToStage=!0,void this._overlayRenderer.addGeometries(this.renderGeometries,this._layerView,1);if(t||this._addedToStage){for(const t of this.renderGeometries)t.instanceParameters.visible=this._visible;this._overlayRenderer.updateGeometries(this.renderGeometries,this._layerView,1)}}}destroy(){this.stage&&this._addedToStage&&this._overlayRenderer.removeGeometries(this.renderGeometries,this._layerView,4),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(t=Gi()){return xi(t,0,0,0)}getBoundingBoxObjectSpace(t=es()){return rs(t)}addObjectState(t,e){0===t&&(this.renderGeometries.forEach((t=>{const i=t.addHighlight();e.addRenderGeometry(t,i,this)})),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._layerView))}removeObjectState(t){this.renderGeometries.forEach((e=>{t.removeRenderGeometry(e)}))}removeRenderGeometryObjectState(t,e){t.removeHighlight(e),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._layerView)}computeAttachmentOrigin(t){for(const e of this.renderGeometries)e.computeAttachmentOrigin(ga)&&(t.draped.origin[0]+=ga[0],t.draped.origin[1]+=ga[1],t.draped.num++)}async getProjectedBoundingBox(t,i,s,r,n){rs(n);for(let e=0;e<this.renderGeometries.length;e++)this._getRenderGeometryProjectedBoundingRect(this.renderGeometries[e],t,pa,s),ms(n,pa);if(i){let t;ns(n,ga);const s=q(n,i);try{t=await i.service.queryElevation(ga[0],ga[1],r,s,"ground")}catch(t){}e(t)&&(n[2]=Math.min(n[2],t),n[5]=Math.max(n[5],t))}return n}_getRenderGeometryProjectedBoundingRect(t,e,i,s){if(this.boundingBox)hs(ma,this.boundingBox);else{const e=t.boundingSphere,i=e[3];ma[0]=e[0]-i,ma[1]=e[1]-i,ma[2]=e[2]-i,ma[3]=e[0]+i,ma[4]=e[1]+i,ma[5]=e[2]+i}return e(ma,0,2),this.calculateRelativeScreenBounds&&s.push({location:ns(ma),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),ds(ma,i)}}const pa=Ps(),ma=es(),ga=Gi();function va(t){return null!=t}function ya(t){return"number"==typeof t}function ba(t){return"string"==typeof t}function wa(t,e){t&&t.push(e)}function Pa(t,e,i,s,r){const n=t.minSize,o=t.maxSize;if(t.expression)return wa(r,"Could not convert size info: expression not supported"),!1;if(t.useSymbolValue){const t=s.symbolSize[i];return e.minSize[i]=t,e.maxSize[i]=t,e.offset[i]=e.minSize[i],e.factor[i]=0,e.type[i]=1,!0}if(va(t.field))return va(t.stops)?2===t.stops.length&&ya(t.stops[0].size)&&ya(t.stops[1].size)?(xa(t.stops[0].size,t.stops[1].size,t.stops[0].value,t.stops[1].value,e,i),e.type[i]=1,!0):(wa(r,"Could not convert size info: stops only supported with 2 elements"),!1):ya(n)&&ya(o)&&va(t.minDataValue)&&va(t.maxDataValue)?(xa(n,o,t.minDataValue,t.maxDataValue,e,i),e.type[i]=1,!0):null!=Er[t.valueUnit]?(e.minSize[i]=-1/0,e.maxSize[i]=1/0,e.offset[i]=0,e.factor[i]=1/Er[t.valueUnit],e.type[i]=1,!0):"unknown"===t.valueUnit?(wa(r,"Could not convert size info: proportional size not supported"),!1):(wa(r,"Could not convert size info: scale-dependent size not supported"),!1);if(!va(t.field)){if(t.stops&&t.stops[0]&&ya(t.stops[0].size))return e.minSize[i]=t.stops[0].size,e.maxSize[i]=t.stops[0].size,e.offset[i]=e.minSize[i],e.factor[i]=0,e.type[i]=1,!0;if(ya(n))return e.minSize[i]=n,e.maxSize[i]=n,e.offset[i]=n,e.factor[i]=0,e.type[i]=1,!0}return wa(r,"Could not convert size info: unsupported variant of sizeInfo"),!1}function xa(t,e,i,s,r,n){const o=Math.abs(s-i)>0?(e-t)/(s-i):0;r.minSize[n]=o>0?t:e,r.maxSize[n]=o>0?e:t,r.offset[n]=t-i*o,r.factor[n]=o}function Sa(t,e,i){t[4*e+0]=i.r/255,t[4*e+1]=i.g/255,t[4*e+2]=i.b/255,t[4*e+3]=i.a}function Ca(t,e,i){const s=2===i&&"arithmetic"===t.rotationType;e.offset[i]=s?90:0,e.factor[i]=s?-1:1,e.type[i]=1}function Aa(t,e,i){if(!t)return null;const s=!e.supportedTypes||!!e.supportedTypes.size,r=!e.supportedTypes||!!e.supportedTypes.color,n=!e.supportedTypes||!!e.supportedTypes.rotation,o=!!e.supportedTypes&&!!e.supportedTypes.opacity,a=t.reduce(((t,a)=>{if(!t)return t;if(a.valueExpression)return wa(i,"Could not convert visual variables: arcade expressions not supported"),null;switch(a.type){case"size":return s?function(t,e,i,s){if(t.normalizationField||t.valueRepresentation)return wa(s,"Could not convert size info: unsupported property"),null;if(!function(t){return null==t||ba(t)}(t.field))return wa(s,"Could not convert size info: field is not a string"),null;if(e.size){if(t.field)if(e.size.field){if(t.field!==e.size.field)return wa(s,"Could not convert size info: multiple fields in use"),null}else e.size.field=t.field}else e.size={field:t.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[0,0,0]};let r;switch(t.axis){case"width":return r=Pa(t,e.size,0,i,s),r?e:null;case"height":return r=Pa(t,e.size,2,i,s),r?e:null;case"depth":return r=Pa(t,e.size,1,i,s),r?e:null;case"width-and-depth":return r=Pa(t,e.size,0,i,s),r&&Pa(t,e.size,1,i,s),r?e:null;case null:case void 0:case"all":return r=Pa(t,e.size,0,i,s),r=r&&Pa(t,e.size,1,i,s),r=r&&Pa(t,e.size,2,i,s),r?e:null;default:return wa(s,`Could not convert size info: unknown axis "${t.axis}""`),null}}(a,t,e,i):t;case"color":return r?function(t,e,i){if(t.normalizationField)return wa(i,"Could not convert color info: unsupported property"),null;if(ba(t.field)){if(!t.stops)return wa(i,"Could not convert color info: missing stops or colors"),null;{if(t.stops.length>8)return wa(i,"Could not convert color info: too many color stops"),null;e.color={field:t.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};const s=t.stops;for(let t=0;t<8;++t){const i=s[Math.min(t,s.length-1)];e.color.values[t]=i.value,Sa(e.color.colors,t,i.color)}}}else{if(!(t.stops&&t.stops.length>=0))return wa(i,"Could not convert color info: no field and no colors/stops"),null;{const i=t.stops&&t.stops.length>=0&&t.stops[0].color;e.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let t=0;t<8;t++)e.color.values[t]=1/0,Sa(e.color.colors,t,i)}}return e}(a,t,i):t;case"opacity":return o?function(t,e,i){if(t.normalizationField)return wa(i,"Could not convert opacity info: unsupported property"),null;if(ba(t.field)){if(!t.stops)return wa(i,"Could not convert opacity info: missing stops or opacities"),null;{if(t.stops.length>8)return wa(i,"Could not convert opacity info: too many opacity stops"),null;e.opacity={field:t.field,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};const s=t.stops;for(let t=0;t<8;++t){const i=s[Math.min(t,s.length-1)];e.opacity.values[t]=i.value,e.opacity.opacityValues[t]=i.opacity}}}else{if(!(t.stops&&t.stops.length>=0))return wa(i,"Could not convert opacity info: no field and no opacities/stops"),null;{const i=t.stops&&t.stops.length>=0&&t.stops[0].opacity;e.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let t=0;t<8;t++)e.opacity.values[t]=1/0,e.opacity.opacityValues[t]=i}}return e}(a,t,i):null;case"rotation":return n?function(t,e,i){if(!ba(t.field))return wa(i,"Could not convert rotation info: field is not a string"),null;if(e.rotation){if(t.field)if(e.rotation.field){if(t.field!==e.rotation.field)return wa(i,"Could not convert rotation info: multiple fields in use"),null}else e.rotation.field=t.field}else e.rotation={field:t.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(t.axis){case"tilt":return Ca(t,e.rotation,0),e;case"roll":return Ca(t,e.rotation,1),e;case null:case void 0:case"heading":return Ca(t,e.rotation,2),e;default:return wa(i,`Could not convert rotation info: unknown axis "${t.axis}""`),null}}(a,t,i):t;default:return null}}),{size:null,color:null,opacity:null,rotation:null});return!(t.length>0&&a)||a.size||a.color||a.opacity||a.rotation?a&&a.size&&!function(t,e,i){for(let i=0;i<3;++i){let s=e.unitInMeters;1===t.type[i]&&(s*=e.modelSize[i],t.type[i]=2),t.minSize[i]=t.minSize[i]/s,t.maxSize[i]=t.maxSize[i]/s,t.offset[i]=t.offset[i]/s,t.factor[i]=t.factor[i]/s}let s;if(0!==t.type[0])s=0;else if(0!==t.type[1])s=1;else{if(0===t.type[2])return wa(i,"No size axis contains a valid size or scale"),!1;s=2}for(let e=0;e<3;++e)0===t.type[e]&&(t.minSize[e]=t.minSize[s],t.maxSize[e]=t.maxSize[s],t.offset[e]=t.offset[s],t.factor[e]=t.factor[s],t.type[e]=t.type[s]);return!0}(a.size,e,i)?null:a:null}function za(t){return t&&null!=t.size}function Fa(t,e){if(!t)return{enabled:!1};if($.TESTS_DISABLE_FAST_UPDATES)return{enabled:!1};const i=Aa(t.visualVariables,e);return i?{enabled:!0,visualVariables:i,materialParameters:Ra(i,e),requiresShaderTransformation:za(i)}:{enabled:!1}}function Oa(t,e,i){if(!e||!t.enabled)return!1;const s=t.visualVariables,r=Aa(e.visualVariables,i);return!!r&&!!(Ma(s.size,r.size,"size")&&Ma(s.color,r.color,"color")&&Ma(s.rotation,r.rotation,"rotation")&&Ma(s.opacity,r.opacity,"opacity"))&&(t.visualVariables=r,t.materialParameters=Ra(r,i),t.requiresShaderTransformation=za(r),!0)}function Ma(t,e,i){if(!!t!=!!e)return!1;if(t&&t.field!==e.field)return!1;if(t&&"rotation"===i){const i=t,s=e;for(let t=0;t<3;t++)if(i.type[t]!==s.type[t]||i.offset[t]!==s.offset[t]||i.factor[t]!==s.factor[t])return!1}return!0}function Ra(t,e){const i={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null,vvOpacityEnabled:!1,vvOpacityValues:null,vvOpacityOpacities:null,vvSymbolAnchor:null,vvSymbolRotationMatrix:null},s=za(t);return t&&t.size?(i.vvSizeEnabled=!0,i.vvSizeMinSize=t.size.minSize,i.vvSizeMaxSize=t.size.maxSize,i.vvSizeOffset=t.size.offset,i.vvSizeFactor=t.size.factor):t&&s&&(i.vvSizeValue=e.transformation.scale),t&&s&&(i.vvSymbolAnchor=e.transformation.anchor,i.vvSymbolRotationMatrix=Is(),Hs(Ta),function(t,e,i,s=Qs()){const r=t||0,n=e||0,o=i||0;0!==r&&qs(s,s,-r/180*Math.PI),0!==n&&Js(s,s,n/180*Math.PI),0!==o&&Zs(s,s,o/180*Math.PI)}(e.transformation.rotation[2],e.transformation.rotation[0],e.transformation.rotation[1],Ta),js(i.vvSymbolRotationMatrix,Ta)),t&&t.color&&(i.vvColorEnabled=!0,i.vvColorValues=t.color.values,i.vvColorColors=t.color.colors),t&&t.opacity&&(i.vvOpacityEnabled=!0,i.vvOpacityValues=t.opacity.values,i.vvOpacityOpacities=t.opacity.opacityValues),i}var _a;!function(t){const e=Qs(),i=Gi();t.evaluateModelTransform=function(t,s,r){if(!t.vvSizeEnabled)return r;Bs(e,r);const n=t.vvSymbolRotationMatrix;Ns(Ta,n[0],n[1],n[2],0,n[3],n[4],n[5],0,n[6],n[7],n[8],0,0,0,0,1),$s(e,e,Ta);for(let e=0;e<3;++e)i[e]=Ai(t.vvSizeOffset[e]+s[0]*t.vvSizeFactor[e],t.vvSizeMinSize[e],t.vvSizeMaxSize[e]);return ks(e,e,i),Ws(e,e,t.vvSymbolAnchor),e},t.evaluateModelTransformScale=function(t,e,i){if(!e.vvSizeEnabled)return xi(t,1,1,1);for(let s=0;s<3;++s)t[s]=Ai(e.vvSizeOffset[s]+i[0]*e.vvSizeFactor[s],e.vvSizeMinSize[s],e.vvSizeMaxSize[s]);return t}}(_a||(_a={}));const Ta=Qs(),Da=_a.evaluateModelTransform,Ea=_a.evaluateModelTransformScale,La=Qs(),ja=Ui(0,0,1),Va=[.25,.25,.75,.75];class Ga extends ho{constructor(t,e,i,s){super(t,e,i,s),this._cimLayers=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimRequiredFields=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}getCachedSize(){return{size:this._getIconSize()}}async doLoad(t){this._validateOrThrow();const i=this._prepareMaterialParameters(),s=this._getPrimitive();if(e(s))this._prepareResourcesPrimitive(i,s);else{const e=Tr(this.symbol,this.symbolLayer),s=f(e);s&&"application/json"===s.mediaType?await this._prepareResourcesCIM(i,JSON.parse(s.data),t):await this._prepareResourcesHref(i,e,t)}}_validateOrThrow(){if(this._drivenProperties.size)return;const t=dt(this._getIconSize());if(t)throw new u("graphics3diconsymbollayer:invalid-size",t)}_getIconSize(){const t=this.symbolLayer,e=Math.round(null!=t.size?I(t.size):16);return this._drivenProperties.size?Math.max(e,64):e}_generateTextureCIM(t){const e=this._getGraphicHash(t);let i=""===e?null:this._cimSymbolTextures.get(e);if(!i){const s=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol(this._cimLayers,t,"esriGeometryPoint",{scaleFactor:this._cimScaleFactorOrFunction},null,null);this._cimMaterialParametersInfo.anchorPos=this._getAnchorPos("relative",s.anchorPosition),i=new ge(s.imageData,{width:s.imageData.width,height:s.imageData.height,powerOfTwoResizeMode:2}),this._cimSymbolTextures.set(e,i),this._context.stage.add(i)}return i}_computeSize(t,e){const i=t.width/t.height;return i>1?[e,Math.round(e/i)]:[Math.round(e*i),e]}_prepareMaterialParameters(){const t={anchorPos:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},e=this.symbol;if(function(t){return t&&"point-3d"===t.type&&t.hasVisibleVerticalOffset()}(e)){const{screenLength:i,minWorldLength:s,maxWorldLength:r}=e.verticalOffset;t.verticalOffset={screenLength:I(i),minWorldLength:s||0,maxWorldLength:null!=r?r:1/0}}return this._context.screenSizePerspectiveEnabled&&(t.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),t.occlusionTest=!0,t.slicePlaneEnabled=this._context.slicePlaneEnabled,t}_prepareResourcesPrimitive(t,e){const i=this._getOutlineSize();if(Ia(e)&&0===i)throw new Error("Nothing to render");this._outlineSize=i,t.color=this._getFillColor(),t.outlineColor=this._getOutlineColor(),t.outlineSize=this._outlineSize;const s=this._context.sharedResources.textures.fromData(e,(()=>function(t){let e;const i=128,s=64;switch(t){case"circle":e=Ct(i,s);break;case"square":e=St(i,s);break;case"kite":e=xt(i,s);break;case"cross":e=Pt(i,s);break;case"x":e=wt(i,s);break;case"triangle":e=bt(i,s)}return new ge(e,{mipmap:!1,wrap:{s:33071,t:33071},width:128,height:128,components:4,noUnpackFlip:!0})}(e)));this._texture=s.texture,this._releaseTexture=s,t.textureIsSignedDistanceField=!0,t.distanceFieldBoundingBox=Va,t.textureId=this._texture.id;const r=this._getIconSize();this._size=[r,r],this._symbolTextureRatio=2,this._createMaterialAndAddToStage(t,this._context.stage)}async _prepareResourcesHref(t,e,i){if(!p("esri-canvas-svg-support")&&m(e))throw new u("graphics3diconsymbollayer:unsupported-image-format","IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)");this._outlineSize=this._getOutlineSize(),t.color=this._getFillColor(),t.outlineColor=this._getOutlineColor(),t.outlineSize=this._outlineSize,t.textureIsSignedDistanceField=!1;const s=this._getIconSize(),r=s*this._context.layerView.view.pixelRatio,n=await ii(this._context.sharedResources.textures.fromUrl(e,r,{signal:i}));if(!1===n.ok)throw g(n.error),new u("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${e})`);this._releaseTexture=n.value;const o=n.value.texture;this._size=this._computeSize(o.params,s),t.textureId=o.id,this._createMaterialAndAddToStage(t,this._context.stage)}async _prepareResourcesCIM(t,e,i){const s=new E({data:e});if(!this._context.sharedResources.cimSymbolRasterizer){const t=(await import("./p-a7668340.js")).CIMSymbolRasterizer;v(i),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new t(this._context.renderCoordsHelper.spatialReference,!0))}const r=this._context.layer.fields?this._context.layer.fields.map((t=>t.toJSON())):null;let n,o;if(this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(s,r,this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:i}),this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression){const t=this._context.renderer;if(isNaN(t.scaleExpression)){const e=t.scaleExpression,i=await _r(e,this._context.layer.spatialReference,r);o=(t,e,s)=>{const r=Dr(i,t,{$view:s},"esriGeometryPoint",e);return null!==r?r:1}}else n=Number(t.scaleExpression)}this._cimScaleFactorOrFunction=n||o||1;const a=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fieldsIndex):[];v(i);const h=this._context.layer.fieldsIndex;this._cimRequiredFields=a.map((t=>h.get(t).name)),this._cimMaterialParametersInfo=t,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||L}_getOutlineSize(){let t=0;const i=this.symbolLayer;return e(i.outline)&&null!=i.outline.size?Math.max(I(i.outline.size),0):(t=Ia(this._getPrimitive())?1.5:0,Math.max(t,0))}_getOutlineColor(){const t=this._getLayerOpacity(),i=d(this.symbolLayer,"outline","color");if(e(i)){const e=G.toUnitRGB(i);return[e[0],e[1],e[2],i.a*t]}return[0,0,0,0]}_getFillColor(){if(Ia(this._getPrimitive()))return pt;const e=t(this._getPrimitive()),i=d(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(i,{hasIntrinsicColor:e})}_getAnchorPos(t,e){return"relative"===t?fi((e.x||0)+.5,.5-(e.y||0)):t in mt?mt[t]:mt.center}_createMaterialAndAddToStage(t,e){if(this._fastUpdates=this._cimLayers?{enabled:!1}:Fa(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&Object.assign(t,this._fastUpdates.materialParameters),this._cimLayers){let i=this._cimSymbolMaterials.get(t.textureId);return i||(i=new gt(t),this._cimSymbolMaterials.set(t.textureId,i),e.add(i)),i}return this._material=new gt(t),e.add(this._material),this._material}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial((t=>{t.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,slicePlaneEnabled:!1,shaderPolygonOffset:0,isDraped:this.draped})})),this.layerOpacityChanged())}destroy(){super.destroy(),this._forEachMaterial((t=>this._context.stage.remove(t))),this._material=null,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach((t=>this._context.stage.remove(t))),this._cimSymbolTextures.clear(),this._releaseTexture=y(this._releaseTexture)}_getScaleFactor(t,e){if(this._drivenProperties.size&&t.size){for(let e=0;e<3;e++){const i=t.size[e];i&&"symbol-value"!==i&&"proportional"!==i&&(t.size[e]=I(i))}if("symbol-value"===t.size[0])return 1;if(isFinite(+t.size[0]))return+t.size[0]/e;if(isFinite(+t.size[2]))return+t.size[2]/e}return 1}createGraphics3DGraphic(e){const i=e.graphic;if(!this._validateGeometry(i.geometry))return null;let r,n;if(this._cimLayers){if(!this._cimLayers.length)return null;const t=this._generateTextureCIM(i),e={textureId:t.id,...this._cimMaterialParametersInfo};n=this._createMaterialAndAddToStage(e,this._context.stage),r=[t.params.width,t.params.height]}else r=this._size,n=s(this._material);const o=vt(i.geometry);if(t(o))return this.logger.warn(`unsupported geometry type for icon symbol: ${i.geometry.type}`),null;const a=e.renderingInfo,h=this._getVertexOpacityAndColor(a);let l=1;this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||(l=this._getScaleFactor(a,r[0]>r[1]?r[0]:r[1])),l*=this._symbolTextureRatio;const c=[r[0]*l,r[1]*l],u=this.setGraphicElevationContext(i,new Z);return this.ensureDrapedStatus("on-the-ground"===u.mode)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(i,o,n,h,c,e.layer.uid):this._createAs3DShape(i,o,n,h,c,u,i.uid)}layerOpacityChanged(){const t=this._getFillColor(),e=this._getOutlineColor();return this._forEachMaterial((i=>{i.setParameters({color:t}),i.setParameters({outlineColor:e})})),!0}layerElevationInfoChanged(t,e,i){const s=this._elevationContext.mode,r=ht(Ga.elevationModeChangeTypes,i,s);if(r!==K.UPDATE)return r;const n=nt(s)||"absolute-height"===s;return this.updateGraphics3DGraphicElevationInfo(t,e,(()=>n))}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial((t=>{t.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled})})),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!!this._getPrimitive()}applyRendererDiff(t,i){for(const s in t.diff){if("visualVariables"!==s)return!1;if(!Oa(this._fastUpdates,i,this._fastVisualVariableConvertOptions()))return!1;e(this._material)&&this._material.setParameters(this._fastUpdates.materialParameters)}return!0}_defaultElevationInfoNoZ(){return Ba}_createAs3DShape(t,e,i,s,r,n,o){const a=this.getFastUpdateAttrValues(t),h=a?t=>Da(this._fastUpdates.materialParameters,a,t):null,l=[J.createPointGeometry(ja,null,s,r,Ua,null,a)],c=ot(this._context,e,l,[i],n,this._context.layer.uid,o,h);if(null===c)return null;const u=new jn(this,c.object,l,null,null,zn,n);return u.alignedSampledElevation=c.sampledElevation,u.needsElevationUpdates=nt(n.mode)||"absolute-height"===n.mode,u.getScreenSize=this._createScreenSizeGetter(r,h),u.calculateRelativeScreenBounds=t=>i.calculateRelativeScreenBounds(u.getScreenSize(),1,t),at(u,e,this._context.elevationProvider),u}_createAsOverlay(t,i,s,r,n,o){s.renderPriority=this._renderPriority;const a=gr();Xi(i,a,this._context.overlaySR),a[2]=ut;const h=this._context.clippingExtent;if(e(h)&&!gs(h,a))return null;const l=this.getFastUpdateAttrValues(t),c=l?t=>Da(this._fastUpdates.materialParameters,l,t):null,u=J.createPointGeometry(ja,a,r,n,null,null,l),d=new yt(u,s,o,t.uid);a[3]=0,zi(d.boundingSphere,a),d.calculateShaderTransformation=c;const f=new fa(this,[d],null);return f.getScreenSize=this._createScreenSizeGetter(n,c),f.calculateRelativeScreenBounds=t=>s.calculateRelativeScreenBounds(f.getScreenSize(),1,t),f}_createScreenSizeGetter(t,e){const i=this._outlineSize+2;if(this._fastUpdates.enabled){const s=t[0]/this._symbolTextureRatio,r=t[1]/this._symbolTextureRatio;return(t=di())=>{const n=e(La);return t[0]=n[0]*s+i,t[1]=n[5]*r+i,t}}{const e=t[0]/this._symbolTextureRatio+i,s=t[1]/this._symbolTextureRatio+i;return(t=di())=>(t[0]=e,t[1]=s,t)}}_fastVisualVariableConvertOptions(){const t=this._size[0]>this._size[1]?this._size[0]:this._size[1],e=Ui(t,t,t),i=B(1),s=t*i;return{modelSize:e,symbolSize:Ui(s,s,s),unitInMeters:i,transformation:{anchor:Ni,scale:Ii,rotation:Ni}}}_getGraphicHash(t){let e="";for(const i of this._cimRequiredFields)e+=i+t.attributes[i];return e}_forEachMaterial(t){e(this._material)&&t(this._material),this._cimSymbolMaterials.forEach(t)}}function Ia(t){return!!e(t)&&("cross"===t||"x"===t)}Ga.PRIMITIVE_SIZE=[64,64],Ga.elevationModeChangeTypes={definedChanged:K.UPDATE,staysOnTheGround:K.NONE,onTheGroundChanged:K.RECREATE};const Ba={mode:"relative-to-ground",offset:0},Ua=mr(0,0,0,1),Na=["polyline","polygon","extent"];class $a extends ho{constructor(t,e,i,s){super(t,e,i,s),this._uniformSize=1}async doLoad(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._fastUpdates=this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?Fa(this._context.renderer,this._vvConvertOptions):{enabled:!1},!this._drivenProperties.size){const t=null!=this.symbolLayer.size?this.symbolLayer.size:B(1);if(t<0)throw new u("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._uniformSize=t}}getMaterialParameters(t){const e=d(this.symbolLayer,"material","color"),i=this._getCombinedOpacityAndColor(e);this._patternHidesLine&&(i[3]=0);const s=i[3],r={width:1,color:i,polygonOffset:!0,join:this.symbolLayer.join||"miter",cap:At(this.symbolLayer.cap||"butt"),transparent:s<1||this.needsDrivenTransparentPass,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:t,stipplePattern:zt(this.symbolLayer.pattern),stippleIntegerRepeats:!0,scaleStippleWithLineWidth:!0};if(this._drivenProperties.size)this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size&&(r.width=I(1));else{const t=null!=this.symbolLayer.size?this.symbolLayer.size:B(1);r.width=I(t)}return this._fastUpdates&&this._fastUpdates.visualVariables?{...r,...this._fastUpdates.materialParameters}:r}get lineMaterial(){return t(this._lineMaterial)&&(this._lineMaterial=new Ft(this.getMaterialParameters(!1)),this._context.stage.add(this._lineMaterial)),this._lineMaterial}get ringMaterial(){return t(this._ringMaterial)&&(this._ringMaterial=new Ft(this.getMaterialParameters(!0)),this._context.stage.add(this._ringMaterial)),this._ringMaterial}destroy(){super.destroy(),this._context.stage.remove(this._lineMaterial),this._lineMaterial=null,this._context.stage.remove(this._ringMaterial),this._ringMaterial=null}getDrivenSize(t){return this._drivenProperties.size&&t.size?I(function(t){for(let e=0;e<3;e++){const i=t[e];if("number"==typeof i)return isFinite(i)?i:0}return 0}(t.size)):1}getSizeFeatureAttributeData(t){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?lo(this._fastUpdates.visualVariables.size.field,t):null}getDrivenColor(t){const e=mr(1,1,1,1);return this._drivenProperties.color&&t.color&&(e[0]=t.color[0],e[1]=t.color[1],e[2]=t.color[2],t.color.length>0&&(e[3]=t.color[3])),this._drivenProperties.opacity&&t.opacity&&(e[3]=t.opacity),e}getColorFeatureAttributeData(t){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?lo(this._fastUpdates.visualVariables.color.field,t):null}getOpacityFeatureAttributeData(t){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?lo(this._fastUpdates.visualVariables.opacity.field,t):null}createGraphics3DGraphic(t){const e=t.graphic;if(!this._validateGeometry(e.geometry,Na,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(e,new Z);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.draped?this._createAsOverlay(t,this._context.layer.uid):this._createAs3DShape(t,i,e.uid)}applyRendererDiff(t,i){for(const s in t.diff){if("visualVariables"!==s)return!1;if(!Oa(this._fastUpdates,i,this._vvConvertOptions))return!1;e(this._lineMaterial)&&this._lineMaterial.setParameters(this._fastUpdates.materialParameters),e(this._ringMaterial)&&this._ringMaterial.setParameters(this._fastUpdates.materialParameters)}return!0}layerOpacityChanged(){return e(this._lineMaterial)&&this.updateMaterialLayerOpacity(this._lineMaterial),e(this._ringMaterial)&&this.updateMaterialLayerOpacity(this._ringMaterial),!0}updateMaterialLayerOpacity(t){const e=t.parameters.color,i=d(this.symbolLayer,"material","color"),s=this._patternHidesLine?0:this._getCombinedOpacity(i);t.setParameters({color:[e[0],e[1],e[2],s],transparent:s<1||this.needsDrivenTransparentPass})}layerElevationInfoChanged(t,e,i){const s=this._elevationContext.mode,r=ht($a.elevationModeChangeTypes,i,s);if(r!==K.UPDATE)return r;const n=nt(s);return this.updateGraphics3DGraphicElevationInfo(t,e,(()=>n))}slicePlaneEnabledChanged(){return e(this._lineMaterial)&&this._lineMaterial.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),e(this._ringMaterial)&&this._ringMaterial.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_getGeometryAsPolygonOrPolyline(t){switch(t.type){case"extent":if(t instanceof c)return Wi.fromExtent(t);break;case"polygon":case"polyline":return t}return null}_createAs3DShape(t,i,s){const r=this._getGeometryAsPolygonOrPolyline(t.graphic.geometry),n="polygon"===r.type?r.rings:r.paths,o=new Array,a=new Array,h=new Array,l=es(),c=Ot(r,this._context.elevationProvider,this._context.renderCoordsHelper,i);this._logGeometryCreationWarnings(c,n,"polygon"===r.type?"rings":"paths","LineSymbol3DLayer");for(let i=0;i<c.lines.length;i++){const{position:s,mapPosition:n}=c.lines[i];if(e(this._context.clippingExtent)&&(rs(l),fs(l,n),!ps(l,this._context.clippingExtent)))continue;const u=this._createGeometry(t,s,n,r.type);o.push(u),a.push("polygon"===r.type?this.ringMaterial:this.lineMaterial),h.push(Ys)}if(0===o.length)return null;const u=new wr({geometries:o,materials:a,transformations:h,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:s}}),d=new jn(this,u,o,null,null,An,i);return d.alignedSampledElevation=c.sampledElevation,d.needsElevationUpdates=nt(i.mode),d}_createGeometry(t,e,i,s){const r=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color;return Mt({removeDuplicateStartEnd:"polygon"===s?1:0,uniformSize:this._uniformSize,attributeData:{position:e,mapPosition:i,size:this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?null:this.getDrivenSize(t.renderingInfo),color:r?null:this.getDrivenColor(t.renderingInfo),sizeFeature:this.getSizeFeatureAttributeData(t.graphic),colorFeature:this.getColorFeatureAttributeData(t.graphic),opacityFeature:this.getOpacityFeatureAttributeData(t.graphic)}})}_createAsOverlay(t,e){const i=t.graphic,s=this._getGeometryAsPolygonOrPolyline(i.geometry),r="polygon"===s.type?s.rings:s.paths,n="polygon"===s.type?this.ringMaterial:this.lineMaterial;n.renderPriority=this._renderPriority;const o=new Array,a=es(),h=rs(),l=Rt(s,this._context.overlaySR);this._logGeometryCreationWarnings(l,r,"polygon"===s.type?"rings":"paths","LineSymbol3DLayer");for(const r of l.lines){if(rs(a),fs(a,r.position),!ps(a,this._context.clippingExtent))continue;cs(h,a);const l=this._createGeometry(t,r.position,null,s.type),c=new yt(l,n,e,i.uid);Fi(c.boundingSphere,.5*(a[0]+a[3]),.5*(a[1]+a[4]),0,.5*Math.sqrt((a[3]-a[0])*(a[3]-a[0])+(a[4]-a[1])*(a[4]-a[1]))),o.push(c)}return new fa(this,o,h)}get _patternHidesLine(){const t=this.symbolLayer.pattern;return e(t)&&"style"===t.type&&"none"===t.style}}function ka(t){switch(t){default:return 1;case"ignore":return 2;case"replace":return 3;case"tint":return 4}}function Wa(e,i,s){if(t(e)||2===i)return s[0]=255,s[1]=255,s[2]=255,void(s[3]=255);const r=Ai(Math.round(e[3]*qa),0,qa),n=0===r||4===i?0:3===i?Ja:Za;s[0]=Ai(Math.round(e[0]*Ha),0,Ha),s[1]=Ai(Math.round(e[1]*Ha),0,Ha),s[2]=Ai(Math.round(e[2]*Ha),0,Ha),s[3]=r+n}$a.elevationModeChangeTypes={definedChanged:K.RECREATE,staysOnTheGround:K.NONE,onTheGroundChanged:K.RECREATE};const Ha=255,qa=85,Ja=qa,Za=2*qa,Xa=["mesh"],Ka=Gi(),Qa=Gi(),Ya=Gi(),th=Gi(),eh=Gi(),ih=Qs(),sh=Is(),rh=es(),nh=[new Lr];class oh{constructor(t,e,i,s){this.graphics3DSymbolLayer=t,this.instanceIndex=e,this.elevationAligner=i,this.elevationContext=s,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(t){const e=this.lodRenderer.instanceData;t!==e.getVisible(this.instanceIndex)&&e.setVisible(this.instanceIndex,t)}destroy(){null!=this.instanceIndex&&(this.lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(t,i,s){if(this.elevationAligner){H(this.elevationContext.featureExpressionInfoContext,s);const r=this.elevationAligner(this,this.elevationContext,t,i);e(r)&&(this.alignedSampledElevation=r)}}getCenterObjectSpace(t=Gi()){return this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,uh),Si(t,this.lodRenderer.baseBoundingSphere.center,uh)}getBoundingBoxObjectSpace(t=es()){this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,uh);const e=this.lodRenderer.baseBoundingBox;rs(t);for(let i=0;i<8;++i)xi(hh,0==(1&i)?e[0]:e[3],0==(2&i)?e[1]:e[4],0==(4&i)?e[2]:e[5]),Si(hh,hh,uh),vs(t,hh);return t}computeAttachmentOrigin(t){this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,uh),t.render.origin[0]+=uh[12],t.render.origin[1]+=uh[13],t.render.origin[2]+=uh[14],t.render.num++}async getProjectedBoundingBox(t,i,s,r,n){const o=this.getBoundingBoxObjectSpace(n),a=ch,h=as(o)?1:a.length;this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,uh);for(let t=0;t<h;t++){const e=a[t];hh[0]=o[e[0]],hh[1]=o[e[1]],hh[2]=o[e[2]],Si(hh,hh,uh),ah[3*t+0]=hh[0],ah[3*t+1]=hh[1],ah[3*t+2]=hh[2]}if(!t(ah,0,h))return null;rs(o);let l=null;this.calculateRelativeScreenBounds&&(l=this.calculateRelativeScreenBounds());for(let t=0;t<3*h;t+=3){for(let e=0;e<3;e++)o[e]=Math.min(o[e],ah[t+e]),o[e+3]=Math.max(o[e+3],ah[t+e]);l&&s.push({location:ah.slice(t,t+3),screenSpaceBoundingRect:l})}if(i&&(ns(o,lh),"absolute-height"!==this.elevationContext.mode)){let t;const s=q(o,i);try{t=await i.service.queryElevation(lh[0],lh[1],r,s,"ground")}catch(t){}e(t)&&os(o,0,0,-this.alignedSampledElevation+t)}return o}addObjectState(t,e){if(0===t){const i=new Pr(t);this.addHighlightId(i),e.addExternal((t=>{this.removeHighlightId(t)}),i)}}removeObjectState(t){this._highlights.forEach((e=>t.remove(e)))}addHighlightId(t){this._highlights.add(t),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}removeHighlightId(t){this._highlights.delete(t),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0)}get lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}}const ah=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],hh=Gi(),lh=Gi(),ch=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],uh=Qs();const dh=.05;var fh,ph;(ph=fh||(fh={}))[ph.ALLOCATED=1]="ALLOCATED",ph[ph.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",ph[ph.VISIBLE=4]="VISIBLE",ph[ph.HIGHLIGHT=8]="HIGHLIGHT",ph[ph.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",ph[ph.REMOVE=32]="REMOVE",ph[ph.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",ph[ph.ACTIVE=18]="ACTIVE";class mh{constructor(t){this.localTransform=t.getField("localTransform",sr),this.globalTransform=t.getField("globalTransform",sr),this.modelOrigin=t.getField("modelOrigin",er),this.model=t.getField("model",rr),this.modelNormal=t.getField("modelNormal",rr),this.modelScaleFactors=t.getField("modelScaleFactors",nr),this.boundingSphere=t.getField("boundingSphere",or),this.color=t.getField("color",ar),this.featureAttribute=t.getField("featureAttribute",ar),this.state=t.getField("state",hr),this.lodLevel=t.getField("lodLevel",hr)}}class gh extends b{constructor(t,e){super(),this._capacity=0,this._size=0,this._next=0,this._layout=function(t){let e=Ue().mat4f64("localTransform").mat4f64("globalTransform").vec4f64("boundingSphere").vec3f64("modelOrigin").mat3f("model").mat3f("modelNormal").vec2f("modelScaleFactors");return t.indexOf("color")>=0&&(e=e.vec4f("color")),t.indexOf("featureAttribute")>=0&&(e=e.vec4f("featureAttribute")),e=e.u8("state").u8("lodLevel").alignTo(8),e}(t),this._shaderTransformation=e}get capacity(){return this._capacity}get size(){return this._size}get buffer(){return this._buffer.buffer}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this.grow();const t=this.findSlot();return this._view.state.set(t,fh.ALLOCATED),this._size++,this.emit("instance-added",{index:t}),t}removeInstance(t){Wr(t>=0&&t<this._capacity&&this._view.state.get(t)&fh.ALLOCATED,"invalid instance handle"),this.getStateFlag(t,fh.ACTIVE)?this.setStateFlags(t,fh.REMOVE):this.freeInstance(t),this.emit("instance-removed",{index:t})}freeInstance(t){const e=this._view.state;Wr(t>=0&&t<this._capacity&&e.get(t)&fh.ALLOCATED,"invalid instance handle"),e.set(t,0),this._size--}setLocalTransform(t,e,i=!0){this._view.localTransform.setMat(t,e),i&&this.updateModelTransform(t)}getLocalTransform(t,e){this._view.localTransform.getMat(t,e)}setGlobalTransform(t,e,i=!0){this._view.globalTransform.setMat(t,e),i&&this.updateModelTransform(t)}getGlobalTransform(t,e){this._view.globalTransform.getMat(t,e)}updateModelTransform(t){const e=this._view,i=bh,s=wh;e.localTransform.getMat(t,Ph),e.globalTransform.getMat(t,xh);const r=$s(xh,xh,Ph);xi(i,r[12],r[13],r[14]),e.modelOrigin.setVec(t,i),js(s,r),e.model.setMat(t,s);const n=Hr(bh,r);n.sort(),e.modelScaleFactors.set(t,0,n[1]),e.modelScaleFactors.set(t,1,n[2]),Gs(s,s),Vs(s,s),e.modelNormal.setMat(t,s),this.setStateFlags(t,fh.TRANSFORM_CHANGED),this.emit("instance-transform-changed",{index:t})}getModelTransform(t,e){const i=this._view;i.model.getMat(t,wh),i.modelOrigin.getVec(t,bh),e[0]=wh[0],e[1]=wh[1],e[2]=wh[2],e[3]=0,e[4]=wh[3],e[5]=wh[4],e[6]=wh[5],e[7]=0,e[8]=wh[6],e[9]=wh[7],e[10]=wh[8],e[11]=0,e[12]=bh[0],e[13]=bh[1],e[14]=bh[2],e[15]=1}applyShaderTransformation(t,e){this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e)}getCombinedModelTransform(t,e){return this.getModelTransform(t,e),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e),e}getCombinedLocalTransform(t,e){return this._view.localTransform.getMat(t,e),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e),e}getCombinedMaxScaleFactor(t){let e=this._view.modelScaleFactors.get(t,1);if(this._shaderTransformation){const i=this._shaderTransformation.scaleFactor(bh,this,t);e*=Math.max(i[0],i[1],i[2])}return e}getCombinedMedianScaleFactor(t){let e=this._view.modelScaleFactors.get(t,0);if(this._shaderTransformation){const i=this._shaderTransformation.scaleFactor(bh,this,t);i.sort(),e*=i[1]}return e}getModel(t,e){this._view.model.getMat(t,e)}setFeatureAttribute(t,e){this._view.featureAttribute.setVec(t,e)}getFeatureAttribute(t,e){this._view.featureAttribute.getVec(t,e)}setColor(t,e){this._view.color.setVec(t,e)}getColor(t,e){this._view.color.getVec(t,e)}setVisible(t,e){e!==this.getVisible(t)&&(this.setStateFlag(t,fh.VISIBLE,e),this.emit("instance-visibility-changed",{index:t}))}getVisible(t){return this.getStateFlag(t,fh.VISIBLE)}setHighlight(t,e){e!==this.getHighlight(t)&&(this.setStateFlag(t,fh.HIGHLIGHT,e),this.emit("instance-highlight-changed",{index:t}))}getHighlight(t){return this.getStateFlag(t,fh.HIGHLIGHT)}getState(t){return this._view.state.get(t)}getLodLevel(t){return this._view.lodLevel.get(t)}countFlags(t){let e=0;for(let i=0;i<this._capacity;++i)this.getState(i)&t&&++e;return e}setStateFlags(t,e){const i=this._view.state;e=i.get(t)|e,i.set(t,e)}clearStateFlags(t,e){const i=this._view.state;e=i.get(t)&~e,i.set(t,e)}setStateFlag(t,e,i){i?this.setStateFlags(t,e):this.clearStateFlags(t,e)}getStateFlag(t,e){return!!(this._view.state.get(t)&e)}grow(){const t=Math.max(vh,Math.floor(this._capacity*yh)),e=this._layout.createBuffer(t);if(this._buffer){const t=new Uint8Array(this._buffer.buffer);new Uint8Array(e.buffer).set(t)}this._capacity=t,this._buffer=e,this._view=new mh(this._buffer)}findSlot(){const t=this._view.state;let e=this._next;for(;t.get(e)&fh.ALLOCATED;)e=(e+1)%this._capacity;return this._next=(e+1)%this._capacity,e}}const vh=1024,yh=2,bh=Gi(),wh=Is(),Ph=Qs(),xh=Qs();class Sh extends Tt{constructor(t,e){super((t=>_s(this._instanceData.view.boundingSphere.getVec(t,this._tmpSphere))),{maximumDepth:25}),this._tmpSphere=Ts(),this._tmpMat4=Qs(),this._instanceData=t,this._boundingSphere=e}addInstance(t){const e=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(t,this._tmpMat4);Si(this._tmpSphere,this._boundingSphere.center,i),this._tmpSphere[3]=this._boundingSphere.radius*qr(i),e.setVec(t,this._tmpSphere),this.add([t])}removeInstance(t){this.remove([t])}}class Ch{constructor(t,e){this.thresholdScale=1,this._camera=new Dt,this._worldSpaceRadius=t,this._thresholds=e.map((t=>t))}updateCamera(t){this._camera.copyFrom(t)}selectLevel(t,e){const i=this._camera.computeScreenPixelSizeAt(t),s=this._worldSpaceRadius*e/i,r=this._thresholds;let n=-1;for(let t=0;t<r.length;++t)s>=r[t]*this.thresholdScale&&(n=t);return n}}class Ah{constructor(t,e){const i=t.renderContext.rctx,{geometry:s,material:r}=e;this.materialRep=t.materialRep,r.setParameters({instancedDoublePrecision:!0});const n=r.createBufferWriter(),o=n.vertexBufferLayout,a=n.elementCount(s),h=n.allocate(a);n.write({},s,h,0),this.geometry=s,this.material=r,this.glMaterials=new Et(r,this.materialRep),this.vertexBufferLayout=o,this.vbo=Jr.createVertex(i,35044,h.buffer),this.vao=new Zr(i,te,{geometry:kr(o)},{geometry:this.vbo}),this.vertexCount=a}destroy(){this.glMaterials.destroy(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(t,e,i,s,r,n){const o=this.geometry.id,a=r.toString();this.material.intersect(this.geometry,null,t.transform.transform,t,i,s,((i,s,h,l)=>{if(i>=0){if(null!=e&&!e(t.rayBeginPoint,t.rayEndPoint,i))return;const c={type:"external",metadata:{layerUid:n.layerUid,graphicUid:n.graphicUid(r)}};if((null==t.results.min.drapedLayerOrder||l>=t.results.min.drapedLayerOrder)&&(null==t.results.min.dist||i<t.results.min.dist)&&(t.results.min.set(c,a,i,s,t.transform.transform,l,null,o,h),t.results.min.intersector="LodRenderer"),0!==t.options.store&&(null==t.results.max.drapedLayerOrder||l>=t.results.max.drapedLayerOrder)&&(null==t.results.max.dist||i>t.results.max.dist)&&(t.results.max.set(c,a,i,s,t.transform.transform,l,null,o,h),t.results.min.intersector="LodRenderer"),2===t.options.store){const e=new xr(t.results.min.ray);e.set(c,a,i,s,t.transform.transform,l,null,o,h),e.intersector="LodRenderer",t.results.all.push(e)}}}))}}class zh{constructor(t,e){this.minScreenSpaceRadius=t,this.components=e}static async create(t,e,i){const s=await Promise.allSettled(e.components.map((e=>t.schedule((()=>new Ah(t,e)),i)))),r=s.map((t=>"fulfilled"===t.status?t.value:null)).filter((t=>t));if(w(i)||r.length!==s.length){r.forEach((t=>t.destroy())),v(i);for(const t of s)if("rejected"===t.status)throw t.reason}return new zh(e.minScreenSpaceRadius,r)}destroy(){this.components.forEach((t=>t.destroy()))}intersect(t,e,i,s,r,n){this.components.forEach((o=>o.intersect(t,e,i,s,r,n)))}get boundingBox(){if(t(this._boundingBox)){const t=rs();this.components.forEach((i=>{e(i.boundingInfo)&&(vs(t,i.boundingInfo.bbMin),vs(t,i.boundingInfo.bbMax))})),this._boundingBox=t}return this._boundingBox}get boundingSphere(){if(t(this._boundingSphere)){const t=this.boundingBox,e=Gi();ns(t,e),this._boundingSphere={center:e,radius:.5*ys(t)}}return this._boundingSphere}get triangleCount(){return this.components.reduce(((t,e)=>t+e.triangleCount),0)}}class Fh{constructor(t,e,i){this._elementSize=e,this._buffer=Jr.createVertex(t,35044),this.resize(i)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get memoryUsage(){return{cpu:this._capacity*this._elementSize,gpu:this._capacity*this._elementSize}}copyRange(t,e,i,s=0){const r=new Uint8Array(this.array,t*this.elementSize,(e-t)*this.elementSize);new Uint8Array(i.array,s*this.elementSize).set(r)}transferAll(){this._buffer.setData(this._array)}transferRange(t,e){const i=t*this._elementSize;this._buffer.setSubData(this._array,i,i,e*this._elementSize)}resize(t){const e=t*this._elementSize,i=new ArrayBuffer(e);this._array&&(t>=this._capacity?new Uint8Array(i).set(new Uint8Array(this._array)):new Uint8Array(i).set(new Uint8Array(this._array).subarray(0,t*this._elementSize))),this._array=i,this._buffer.setData(e),this._capacity=t}}class Oh{constructor(t){this.modelOriginHi=t.getField("modelOriginHi",ir),this.modelOriginLo=t.getField("modelOriginLo",ir),this.model=t.getField("model",rr),this.modelNormal=t.getField("modelNormal",rr),this.color=t.getField("instanceColor",ar),this.featureAttribute=t.getField("instanceFeatureAttribute",ar)}}class Mh{constructor(t,e){this._headIndex=0,this._tailIndex=0,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._rctx=t,this._instanceBufferLayout=e,this._elementSize=e.stride,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const t=this._headIndex,e=this._tailIndex;return t>=e?t-e:t+this._capacity-e}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get memoryUsage(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCylce(){this._captureFirstIndex=!0}beginUpdate(){Wr(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){Wr(this._updating,"not updating"),this.size<Th*this.capacity&&this.shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this.transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){Wr(this._updating,"not updating"),this.isFull&&this.grow();const t=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=t,this._captureFirstIndex=!1),this.incrementHead(),Wr(this._headIndex!==this._tailIndex,"invalid pointers"),t}freeTail(){Wr(this._updating,"not updating"),Wr(this.size>0,"invalid size");const t=this._tailIndex===this._firstIndex;this.incrementTail(),t&&(this._firstIndex=this._tailIndex)}grow(){const t=Math.max(Rh,Math.floor(this._capacity*_h));this.resize(t)}shrink(){const t=Math.max(Rh,Math.floor(this._capacity*Dh));this.resize(t)}resize(t){if(Wr(this._updating,"not updating"),t===this._capacity)return;const e=new Fh(this._rctx,this._elementSize,t);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const t=this.size,i=this.compactInstances(e);Wr(i===t,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=i,this._prevHeadIndex=0}this._resized=!0,this._capacity=t,this._buffer=e,this._view=new Oh(this._instanceBufferLayout.createView(this._buffer.array))}compactInstances(t){const e=this._headIndex,i=this._tailIndex;return i<e?(this._buffer.copyRange(i,e,t),e-i):i>e?(this._buffer.copyRange(i,this._capacity,t),e>0&&this._buffer.copyRange(0,e,t,this._capacity-i),e+(this._capacity-i)):0}incrementHead(t=1){this._headIndex=(this._headIndex+t)%this._capacity}incrementTail(t=1){this._tailIndex=(this._tailIndex+t)%this._capacity}transferRange(t,e){t<e?this._buffer.transferRange(t,e):t>e&&(e>0&&this._buffer.transferRange(0,e),this._buffer.transferRange(t,this._capacity))}}const Rh=1024,_h=2,Th=.3,Dh=.5;class Eh{constructor(t,e,i,s){this.type="Lod",this.isGround=!1,this._inverseViewport=di(),this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._enableLevelSelection=!0,this._lastCamera=new Dt,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.canRender=!0,this._symbol=t,this._optionalFields=e,this._metadata=i,this._instanceBufferLayout=Cr({instancedDoublePrecision:!0,instanced:e}),this._glInstanceBufferLayout=kr(this._instanceBufferLayout,1),this._instanceData=new gh(this._optionalFields,s),this._instanceData.on("instance-added",(()=>this.requestUpdateCycle())),this._instanceData.on("instance-removed",(()=>this.requestUpdateCycle())),this._instanceData.on("instance-transform-changed",(t=>{this.requestUpdateCycle(),this._metadata.notifyGraphicGeometryChanged(t.index)})),this._instanceData.on("instance-visibility-changed",(t=>{this.requestUpdateCycle(!0),this._metadata.notifyGraphicVisibilityChanged(t.index)})),this._instanceData.on("instance-highlight-changed",(()=>this.requestUpdateCycle(!0))),this._enableLevelSelection=this._symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlane(){return this._slicePlane}set slicePlane(t){this._slicePlane=t}get intersectionHandlerId(){return this._metadata.layerUid}get instanceData(){return this._instanceData}get memoryUsage(){const t={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach((e=>{const i=e.memoryUsage;t.cpu+=i.cpu,t.gpu+=i.gpu})),this._highlightRenderInstanceData.forEach((e=>{const i=e.memoryUsage;t.cpu+=i.cpu,t.gpu+=i.gpu})),t}get renderStats(){const t=this._instanceData.size,e=[];return this._levels.forEach(((t,i)=>{const s=this._defaultRenderInstanceData[i].size+this._highlightRenderInstanceData[i].size,r=t.triangleCount;e.push({renderedInstances:s,renderedTriangles:s*r,trianglesPerInstance:r})})),{totalInstances:t,renderedInstances:e.reduce(((t,e)=>t+e.renderedInstances),0),renderedTriangles:e.reduce(((t,e)=>t+e.renderedTriangles),0),levels:e}}async initializeRenderContext(t,e){this._context=t;const i=t.renderContext.rctx,s=await Promise.allSettled(this._symbol.levels.map((s=>(this._defaultRenderInstanceData.push(new Mh(i,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new Mh(i,this._instanceBufferLayout)),zh.create(t,s,e))))),r=s.map((t=>"fulfilled"===t.status?t.value:null)).filter((t=>t));if(w(e)||r.length!==s.length){r.forEach((t=>t.destroy())),v(e);for(const t of s)if("rejected"===t.status)throw t.reason}this._levels=r,this._levelSelector=function(t){const e=t.baseBoundingSphere.radius,i=t.levels.map((t=>t.minScreenSpaceRadius));return new Ch(e,i)}(this)}uninitializeRenderContext(){this.invalidateOctree(),this._levels.forEach((t=>t.destroy())),this._defaultRenderInstanceData.forEach((t=>t.destroy())),this._highlightRenderInstanceData.forEach((t=>t.destroy()))}get slots(){return[3,5]}get needsHighlight(){return this._highlightRenderInstanceData.reduce(((t,e)=>t+e.size),0)>0}prepareRender(t,e){if($.LOD_INSTANCE_RENDERER_DISABLE_UPDATES)return;if(this._enableLevelSelection){const t=e.equals(this._lastCamera);this._lastCamera.copyFrom(e),t||this.requestUpdateCycle()}const i=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this.updateInstances(e,i),this.needsUpdates&&this._context.requestRender()}render(t){var e,i;const s=3===t.slot?2:5===t.slot?4:null;if(!s||!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(t.pass))return!1;const r=t.camera;this._inverseViewport[0]=1/r.fullViewport[2],this._inverseViewport[1]=1/r.fullViewport[3];const n={slot:s,origin:[0,0,0],camera:r,inverseViewport:this._inverseViewport,shadowMap:t.shadowMap,shadowMappingEnabled:t.shadowMap.enabled,ssaoHelper:t.ssaoHelper,ssaoEnabled:t.ssaoHelper.enabled,screenToWorldRatio:null,screenToPCSRatio:null,slicePlane:t.sliceHelper&&t.sliceHelper.plane,hudVisibilityTexture:t.offscreenRenderingHelper?t.offscreenRenderingHelper.hudVisibilityTexture:null,highlightDepthTexture:null!=(e=null==(i=t.offscreenRenderingHelper)?void 0:i.depthTexture)?e:null,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:Ys,ssrEnabled:!1,lighting:t.scenelightingData,transparencyPassType:t.transparencyPassType,terrainLinearDepthTexture:t.multipassTerrainParams.terrainLinearDepthTexture,geometryLinearDepthTexture:t.multipassGeometryParams.geometryLinearDepthTexture,multipassTerrainEnabled:t.multipassTerrainParams.multipassTerrainEnabled,cullAboveGround:t.multipassTerrainParams.cullAboveGround,multipassGeometryEnabled:t.multipassGeometryParams.multipassGeometryEnabled,highlightColorTexture:null};t.rctx.bindVAO();const o=5!==t.pass&&7!==t.pass,a=6!==t.pass;return o&&this._renderComponents(t,s,n,this._defaultRenderInstanceData),a&&this._renderComponents(t,s,n,this._highlightRenderInstanceData),o||a}intersect(t,e,i,s){if(!this.baseMaterial.isVisible())return;const r=Gi();bi(r,s,i);const n=r=>{this._instanceData.getCombinedModelTransform(r,Gh),t.transform.set(Gh),Si(Ih,i,t.transform.inverse),Si(Bh,s,t.transform.inverse);const n=this._instanceData.getState(r),o=this._instanceData.getLodLevel(r);Wr(n&fh.ACTIVE,"invalid instance state"),Wr(o>=0&&o<this._levels.length,"invaid lod level"),this._levels[o].intersect(t,e,Ih,Bh,r,this._metadata)};this.baseMaterial.parameters.verticalOffset?this.octree.forEach(n):this.octree.forEachAlongRay(i,r,n)}queryDepthRange(t){return this.queryDepthRangeOctree(t)}notifyShaderTransformationChanged(){this.invalidateOctree()}requestUpdateCycle(t=!1){this._updateCyclesWithStaticCamera=-1,t&&(this._needFullCycle=!0),this.needsUpdates&&this._context.requestRender()}get needsUpdates(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}get octree(){return this._octree||(this._octree=this.buildOctree()),this._octree}invalidateOctree(){this._octree&&(this._octree.destroy(),this._octree=null)}buildOctree(){const t=new Sh(this._instanceData,this.baseBoundingSphere),e=this._instanceData,i=e.view?e.view.state:null;for(let e=0;e<this._instanceData.capacity;++e)i.get(e)&fh.ACTIVE&&t.addInstance(e);return t}queryDepthRangeOctree(t){const e=t.eye,i=t.viewForward,s=this.octree.findClosest(i,1,t.frustum),r=this.octree.findClosest(i,-1,t.frustum);if(null!=s&&null!=r){this._instanceData.view.boundingSphere.getVec(s,Vh),bi(Vh,Vh,e);const n=Pi(Vh,i)-Vh[3];this._instanceData.view.boundingSphere.getVec(r,Vh),bi(Vh,Vh,e);const o=Pi(Vh,i)+Vh[3];return{near:Math.max(t.near,n),far:Math.min(t.far,o)}}return{near:1/0,far:-1/0}}startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach((t=>{t.startUpdateCylce()})),this._highlightRenderInstanceData.forEach((t=>{t.startUpdateCylce()})),this.needsUpdates&&this._context.requestRender()}updateInstances(t,e){const i=this._enableLevelSelection,s=this._levelSelector;s.updateCamera(t),this._defaultRenderInstanceData.forEach((t=>{t.beginUpdate()})),this._highlightRenderInstanceData.forEach((t=>{t.beginUpdate()}));const r=this._instanceData,n=this._instanceData.view,o=r.capacity;let a=this._instanceIndex;e=Math.min(r.size,e);for(let t=0;t<e;++t){0===a&&this.startUpdateCycle();const t=n.state.get(a);let h=0;if(!(t&fh.ALLOCATED)){a=(a+1)%o,e++;continue}const l=n.lodLevel.get(a);if(t&fh.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[l].freeTail(),t&fh.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[l].freeTail(),t&fh.REMOVE)r.freeInstance(a);else if(t&fh.VISIBLE){let e=0;i&&(n.modelOrigin.getVec(a,jh),e=s.selectLevel(jh,r.getCombinedMedianScaleFactor(a))),h=t&~(fh.ACTIVE|fh.TRANSFORM_CHANGED),e>=0&&(t&fh.HIGHLIGHT?(Lh(this._highlightRenderInstanceData[e],n,a),h|=fh.HIGHLIGHT_ACTIVE):(Lh(this._defaultRenderInstanceData[e],n,a),h|=fh.DEFAULT_ACTIVE)),n.state.set(a,h),n.lodLevel.set(a,e)}else h=t&~(fh.ACTIVE|fh.TRANSFORM_CHANGED),n.state.set(a,h);if(this._octree){const e=!!(t&fh.ACTIVE),i=!!(h&fh.ACTIVE);!e&&i?this._octree.addInstance(a):e&&!i?this._octree.removeInstance(a):e&&i&&t&fh.TRANSFORM_CHANGED&&(this._octree.removeInstance(a),this._octree.addInstance(a))}a=(a+1)%o}this._instanceIndex=a,this._defaultRenderInstanceData.forEach((t=>{t.endUpdate()})),this._highlightRenderInstanceData.forEach((t=>{t.endUpdate()}))}_renderComponents(t,e,i,s){this.levels.forEach(((r,n)=>{r.components.forEach((r=>{this._renderComponent(t,e,i,s[n],r,n)}))}))}_renderComponent(e,i,s,r,n,o){if(0===r.size||!n.material.requiresSlot(i))return;const{rctx:a,pass:h}=e,l=n.glMaterials.load(a,h);if(t(l))return;const c=a.capabilities.instancing,u=l.beginSlot(s),d=u.program;u.bindPipelineState(a,i),a.useProgram(d),l.bind(s,u),a.bindVAO(n.vao),u.ensureAttributeLocations(n.vao),e.isHighlightPass&&ve(d,s),u.bindDraw(s),$.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===e.pass&&(d.setUniform4fv("externalColor",Uh[Math.min(o,Uh.length-1)]),d.setUniform1i("colorMixMode",ye.replace));const f=r.capacity,p=r.headIndex,m=r.tailIndex,g=r.firstIndex,v=this._glInstanceBufferLayout,y=(t,e)=>{Xr(a,te,r.buffer,v,t),c.drawArraysInstanced(u.primitiveType,0,n.vertexCount,e-t),Kr(a,te,r.buffer,v)};n.material.parameters.transparent&&null!=g?p>m?(Wr(g>=m&&g<=p,"invalid firstIndex"),y(g,p),y(m,g)):p<m&&(g<=p?(Wr(g>=0&&g<=p,"invalid firstIndex"),y(g,p),y(m,f),y(0,g)):(Wr(g>=m&&g<=f,"invalid firstIndex"),y(g,f),y(0,p),y(m,g))):p>m?y(m,p):p<m&&(y(0,p),y(m,f)),a.bindVAO(null)}}function Lh(t,e,i){const s=t.allocateHead();!function(t,e,i,s){Qr(t.modelOrigin,e,i.modelOriginHi,i.modelOriginLo,s),i.model.copyFrom(s,t.model,e),i.modelNormal.copyFrom(s,t.modelNormal,e),t.color&&i.color&&i.color.copyFrom(s,t.color,e),t.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(s,t.featureAttribute,e)}(e,i,t.view,s)}const jh=Gi(),Vh=gr(),Gh=Qs(),Ih=Gi(),Bh=Gi(),Uh=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]],Nh=Gi(),$h=Qs(),kh=Qs(),Wh=gr(),Hh=new k;function qh(t,e,i,s,r){return t[0]=e,t[1]=i,t[2]=s,t[3]=r,t}function Jh(t,e,i){const s=e[0],r=e[1],n=e[2],o=e[3],a=i[0],h=i[1],l=i[2],c=i[3];return t[0]=s*a+n*h,t[1]=r*a+o*h,t[2]=s*l+n*c,t[3]=r*l+o*c,t}function Zh(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t}Object.freeze({__proto__:null,copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},set:qh,transpose:function(t,e){if(t===e){const i=e[1];t[1]=e[2],t[2]=i}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t},invert:function(t,e){const i=e[0],s=e[1],r=e[2],n=e[3];let o=i*n-r*s;return o?(o=1/o,t[0]=n*o,t[1]=-s*o,t[2]=-r*o,t[3]=i*o,t):null},adjoint:function(t,e){const i=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=i,t},determinant:function(t){return t[0]*t[3]-t[2]*t[1]},multiply:Jh,rotate:function(t,e,i){const s=e[0],r=e[1],n=e[2],o=e[3],a=Math.sin(i),h=Math.cos(i);return t[0]=s*h+n*a,t[1]=r*h+o*a,t[2]=s*-a+n*h,t[3]=r*-a+o*h,t},scale:function(t,e,i){const s=e[1],r=e[2],n=e[3],o=i[0],a=i[1];return t[0]=e[0]*o,t[1]=s*o,t[2]=r*a,t[3]=n*a,t},fromRotation:function(t,e){const i=Math.sin(e),s=Math.cos(e);return t[0]=s,t[1]=i,t[2]=-i,t[3]=s,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t},str:function(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},frob:function(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2)},LDU:function(t,e,i,s){return t[2]=s[2]/s[0],i[0]=s[0],i[1]=s[1],i[3]=s[3]-t[2]*i[1],[t,e,i]},add:function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t},subtract:Zh,exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},equals:function(t,e){const i=t[0],s=t[1],r=t[2],n=t[3],o=e[0],a=e[1],h=e[2],l=e[3];return Math.abs(i-o)<=$i*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(s-a)<=$i*Math.max(1,Math.abs(s),Math.abs(a))&&Math.abs(r-h)<=$i*Math.max(1,Math.abs(r),Math.abs(h))&&Math.abs(n-l)<=$i*Math.max(1,Math.abs(n),Math.abs(l))},multiplyScalar:function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t},multiplyScalarAndAdd:function(t,e,i,s){return t[0]=e[0]+i[0]*s,t[1]=e[1]+i[1]*s,t[2]=e[2]+i[2]*s,t[3]=e[3]+i[3]*s,t},mul:Jh,sub:Zh});class Xh extends me{constructor(t,e,i,s,r,n){super(t,e),this.path=i,this.geometrySR=s,this.upVectorAlignment=r,this.stencilWidth=n}}function Kh(t){return"upVectorAlignment"in t}function Qh(){return{up:Gi(),right:Gi()}}function Yh(t,e,i){Si(t.up,e.up,i),Si(t.right,e.right,i)}function tl(t,e,i){ni(t,Pi(i,e.right),Pi(i,e.up))}Object.freeze({__proto__:null,create:function(){return[1,0,0,1]},clone:function(t){return[t[0],t[1],t[2],t[3]]},fromValues:function(t,e,i,s){return[t,e,i,s]},createView:function(t,e){return new Float64Array(t,e,4)}});class el{constructor(){this.pos=Gi(),this.posES=Gi(),this.posGS=Gi(),this.vRight=Gi(),this.vLeft=Gi(),this.frame=Qh(),this.rotationFrame=Qh(),this.rotationRight=di(),this.rotationAngle=0,this.miterStretch=[1,0,0,1]}setFrameFromUpVector(t){vi(this.frame.up,t),mi(wl,this.vLeft,this.vRight),wi(wl,wl),gi(bl,this.frame.up,Pi(wl,this.frame.up)),bi(Sl,wl,bl),wi(Sl,Sl),Ci(this.frame.right,Sl,this.frame.up)}computeRotationAxisAndAngleFromUpVector(){vi(this.rotationFrame.up,this.frame.up),vi(this.rotationFrame.right,this.frame.right),ni(this.rotationRight,1,0),gi(bl,this.frame.up,Pi(this.frame.up,this.vLeft)),bi(bl,this.vLeft,bl),Oi(bl,bl),wi(bl,bl),gi(wl,this.frame.up,Pi(this.frame.up,this.vRight)),bi(wl,this.vRight,wl),wi(wl,wl),Ci(Pl,this.rotationFrame.up,this.vLeft);const t=Math.sign(Pi(Pl,this.vRight));if(this.rotationAngle=t*(Math.PI-_i(Pi(bl,wl))),Math.abs(this.rotationAngle)>0){const t=Ti(Math.cos(.5*this.rotationAngle));qh(this.miterStretch,t-1+1,0,0,1)}const e=Math.PI-this.rotationAngle;this.maxStretchDistance=Math.abs(Math.min(this.vLeftLength,this.vRightLength)/Math.cos(.5*e))}}class il{constructor(){this.vertices=[],this.vertexIndices=[],this.vertexNormals=[],this.poles=[],this.poleIndices=[],this.uvs=null,this.uvIndices=null}addVertex(t,e){return this.vertices.push(pi(t)),this.vertexNormals.push(pi(e)),this.vertices.length-1}addUV(t){return this.uvs||(this.uvs=[],this.uvIndices=[]),this.uvs.push(t),this.uvs.length-1}addPole(t,e=null){return this.poles.push({position:pi(t),normal:e?pi(e):null}),this.poles.length-1}addSegment(t,e=null,i=null){this.vertexIndices.push(t.v0),this.vertexIndices.push(t.v1),e&&(this.uvIndices.push(e.v0),this.uvIndices.push(e.v1)),i&&(this.poleIndices.push(i.v0),this.poleIndices.push(i.v1))}get numSegments(){return this.vertexIndices.length/2}hasUV(){return null!=this.uvs}translate(t,e){for(const i of this.vertices)i[0]+=t,i[1]+=e;for(const i of this.poles)i.position[0]+=t,i.position[1]+=e}static circle(t=20){const e=new il,i={v0:0,v1:0};e.addPole(fi(0,0));for(let i=0;i<t;++i){const s=2*i*Math.PI/t,r=Math.cos(s),n=Math.sin(s),o=fi(.5*r,.5*n),a=fi(r,n);e.addVertex(o,a),e.addUV(i/t)}e.addUV(1);for(let s=0;s<t-1;++s){const t={v0:s,v1:s+1};e.addSegment(t,t,i)}return e.addSegment({v0:t-1,v1:0},{v0:t-1,v1:t},i),e}static rect(){const t=new il,e=fi(-.5,-.5),i=fi(.5,-.5),s=fi(.5,.5),r=fi(-.5,.5),n=fi(0,-1),o=fi(1,0),a=fi(0,1),h=fi(-1,0);t.addUV(0),t.addUV(1),t.addPole(fi(0,.5),a),t.addPole(fi(0,.5)),t.addPole(fi(0,-.5)),t.addPole(fi(0,-.5),n);const l={v0:0,v1:1};return t.addVertex(e,n),t.addVertex(i,n),t.addSegment({v0:0,v1:1},l,{v0:3,v1:3}),t.addVertex(i,o),t.addVertex(s,o),t.addSegment({v0:2,v1:3},l,{v0:2,v1:1}),t.addVertex(s,a),t.addVertex(r,a),t.addSegment({v0:4,v1:5},l,{v0:0,v1:0}),t.addVertex(r,h),t.addVertex(e,h),t.addSegment({v0:6,v1:7},l,{v0:1,v1:2}),t}}class sl{constructor(t){this.vertices=[],this.offset=Gi(),this.xform=Qs(),this.vertices=t;const e=Math.floor((t.length-1)/2);vi(this.offset,this.vertices[e].pos);for(const t of this.vertices)bi(t.pos,t.pos,this.offset);Ws(this.xform,this.xform,this.offset),this.updatePathVertexInformation()}updatePathVertexInformation(){const t=this.vertices.length;let e=this.vertices[0];e.index=0,xi(e.vLeft,0,0,0),e.vLeftLength=0,bi(e.vRight,this.vertices[1].pos,e.pos),e.vRightLength=Ri(e.vRight),wi(e.vRight,e.vRight);let i=e;for(let s=1;s<t;++s)e=this.vertices[s],e.index=s,vi(e.vLeft,i.vRight),e.vLeftLength=i.vRightLength,s<t-1?(bi(e.vRight,this.vertices[s+1].pos,e.pos),e.vRightLength=Ri(e.vRight),wi(e.vRight,e.vRight)):(vi(e.vRight,e.vLeft),e.vRightLength=e.vLeftLength),i=e}}class rl{numProfilesPerJoin(){return 1}extrude(t,e,i){for(let s=0;s<e.vertices.length;++s)i(t.index,t.frame,e.vertices[s],e.vertexNormals[s],!1)}}class nl{constructor(t=.8*Math.PI,e=1){this.cutoffAngle=t,this.numBendSubdivisions=e}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(t,e,i){const s=Cl;if(Math.abs(t.rotationAngle)>=this.cutoffAngle)for(let r=0;r<this.numBendSubdivisions+1;++r){Hs(Al),Ks(Al,Al,.5*-t.rotationAngle+r*t.rotationAngle/this.numBendSubdivisions,t.rotationFrame.up),Yh(s,t.frame,Al);for(let r=0;r<e.vertices.length;++r)oi(e.vertices[r],t.rotationRight)*t.rotationAngle>=0?i(t.index,s,e.vertices[r],e.vertexNormals[r],!1):(ai(gl,e.vertices[r],t.miterStretch),i(t.index,t.frame,gl,e.vertexNormals[r],!0))}else for(let s=0;s<this.numBendSubdivisions+1;++s)for(let s=0;s<e.vertices.length;++s){const r=oi(e.vertices[s],t.rotationRight)*t.rotationAngle>=0;ai(gl,e.vertices[s],t.miterStretch),i(t.index,t.frame,gl,e.vertexNormals[s],!r)}}}const ol={generateUV:!1};class al{rebuildConnectingProfileGeometry(t,e,i){for(let s=0;s<e.vertices.length;++s)i(t.index,t.frame,e.vertices[s],e.vertexNormals[s],0,0)}}class hl extends al{constructor(){super()}getNumVertices(){return 0}getNumIndices(){return 0}rebuildCapGeometry(){}buildTopology(){}}class ll extends al{constructor(t,e=0,i=!1){super(),this.profile=t,this.profilePlaneOffset=e,this.flip=i}getNumVertices(){return this.profile.vertices.length}getNumIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(t,e,i){for(let s=0;s<e.vertices.length;++s)i(t.index,t.frame,e.vertices[s],e.vertexNormals[s],this.profilePlaneOffset,0)}rebuildCapGeometry(t,e){const i=vl;ni(i,0,0);const s=this.flip?1:-1;for(let r=0;r<this.profile.vertices.length;++r)e(t.index,t.frame,this.profile.vertices[r],i,this.profilePlaneOffset,s)}buildTopology(t,e){const i=this.vertexBufferStart+this.profile.vertexIndices[0];for(let t=1;t<this.profile.numSegments;++t){const s=this.vertexBufferStart+this.profile.vertexIndices[2*t+0],r=this.vertexBufferStart+this.profile.vertexIndices[2*t+1];this.flip?e(r,s,i):e(i,s,r)}}}class cl extends al{constructor(t){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=t.profile,this.flip=t.flip,this.sign=this.flip?1:-1,this.breakNormals=t.breakNormals,this.numSegments=t.subdivisions}getNumVertices(){let t=0;return t=this.profile.vertices.length*(this.numSegments-1),this.breakNormals&&(t+=this.profile.vertices.length),t+=this.profile.poles.length,t}getNumIndices(){let t=0;t+=2*this.profile.numSegments*(this.numSegments-1);for(let e=0;e<this.profile.numSegments;++e)t+=this.profile.poleIndices[this.profile.vertexIndices[2*e+0]]===this.profile.poleIndices[this.profile.vertexIndices[2*e+1]]?1:2;return 3*t}rebuildCapGeometry(t,e){const i=t.frame,s=.5*this.sign,r=gl,n=vl;ni(n,0,0);for(let r=0;r<this.profile.poles.length;++r){const o=this.profile.poles[r];o.normal?e(t.index,i,o.position,o.normal,s,0):e(t.index,i,o.position,n,s,this.sign)}if(this.breakNormals)for(let s=0;s<this.profile.vertices.length;++s)e(t.index,i,this.profile.vertices[s],this.profile.vertexNormals[s],0,0);for(let o=0;o<this.numSegments-1;++o){const a=(1-(o+1)/this.numSegments)*Math.PI*.5,h=Math.sin(a),l=Math.cos(a);for(let o=0;o<this.profile.vertices.length;++o){const a=this.profile.poles[this.profile.poleIndices[o]];hi(r,this.profile.vertices[o],a.position),ri(r,r,h),a.normal?(li(r,r,a.position),e(t.index,i,r,a.normal,s*l,0)):(ci(n,r),ri(n,n,h),li(r,r,a.position),e(t.index,i,r,n,s*l,this.sign*l))}}}buildTopology(t,e){const i=this.breakNormals?this.vertexBufferStart+this.profile.poles.length:this.firstProfileVertexIndex,s=this.breakNormals?this.vertexBufferStart+this.profile.poles.length+this.profile.vertices.length:this.vertexBufferStart+this.profile.poles.length;for(let t=0;t<this.profile.numSegments;++t){const r=this.profile.vertexIndices[2*t+0],n=this.profile.vertexIndices[2*t+1],o=this.vertexBufferStart+this.profile.poleIndices[r],a=this.vertexBufferStart+this.profile.poleIndices[n];let h=i+r,l=i+n;for(let t=0;t<this.numSegments-1;++t){const i=s+t*this.profile.vertices.length+r,o=s+t*this.profile.vertices.length+n;this.flip?(e(i,l,h),e(l,i,o)):(e(h,l,i),e(o,i,l)),h=i,l=o}this.flip?(e(o,l,h),o!==a&&e(o,a,l)):(e(h,l,o),o!==a&&e(l,a,o))}}}class ul{constructor(t,e,i,s,r,n=ol){this.options=n,this._extrusionVertexCount=0,this._triangleCount=0,this.numExtrusionProfiles=0,this.numVerticesTotal=0,this.numNormalsTotal=0,this.numUVTotal=0,this.profile=e,this.path=t,this.extruder=i,this.startCap=s,this.endCap=r;const o=this.path.vertices.length-2;this.numExtrusionProfiles=i.numProfilesPerJoin()*o+2,this.numVerticesTotal=e.vertices.length*this.numExtrusionProfiles,this.numNormalsTotal=this.numVerticesTotal,this.startCap.vertexBufferStart=this.numVerticesTotal;const a=this.startCap.getNumVertices();this.numVerticesTotal+=a,this.numNormalsTotal+=a,this.endCap.vertexBufferStart=this.numVerticesTotal;const h=this.endCap.getNumVertices();this.numVerticesTotal+=h,this.numNormalsTotal+=h,this.pathVertexData=new Float32Array(1*this.numVerticesTotal),this.profileRightAxisData=new Float32Array(4*this.numVerticesTotal),this.profileUpAxisData=new Float32Array(4*this.numVerticesTotal),this.profileVertexAndNormalData=new Float32Array(4*this.numVerticesTotal),this.profile.hasUV()&&this.options.generateUV&&(this.numUVTotal=this.profile.uvs.length,this.uvData=new Float32Array(2*this.numUVTotal)),this.originData=new Float32Array(3*this.path.vertices.length),this.rebuildGeometry(),this.buildTopology()}emitVertex(t,e,i,s,r){if(this.profileRightAxisData[4*this._extrusionVertexCount+0]=e.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=e.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=e.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=e.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=e.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=e.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=i[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=i[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=s[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=t,r){const e=this.path.vertices[t];this.profileRightAxisData[4*this._extrusionVertexCount+3]=e.rotationRight[0]*e.maxStretchDistance,this.profileUpAxisData[4*this._extrusionVertexCount+3]=e.rotationRight[1]*e.maxStretchDistance}else this.profileRightAxisData[4*this._extrusionVertexCount+3]=0,this.profileUpAxisData[4*this._extrusionVertexCount+3]=0;++this._extrusionVertexCount}emitCapVertex(t,e,i,s,r,n){this.profileRightAxisData[4*this._extrusionVertexCount+0]=e.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=e.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=e.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=e.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=e.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=e.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=i[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=i[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=s[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=t,this.profileRightAxisData[4*this._extrusionVertexCount+3]=r,this.profileUpAxisData[4*this._extrusionVertexCount+3]=n,++this._extrusionVertexCount}emitTriangle(t,e,i){this.vertexIndices[3*this._triangleCount+0]=t,this.vertexIndices[3*this._triangleCount+1]=e,this.vertexIndices[3*this._triangleCount+2]=i,this.pathVertexIndices[3*this._triangleCount+0]=this.pathVertexData[t],this.pathVertexIndices[3*this._triangleCount+1]=this.pathVertexData[e],this.pathVertexIndices[3*this._triangleCount+2]=this.pathVertexData[i],this.normalIndices[3*this._triangleCount+0]=t,this.normalIndices[3*this._triangleCount+1]=e,this.normalIndices[3*this._triangleCount+2]=i,++this._triangleCount}rebuildGeometry(){const t=(t,e,i,s,r)=>this.emitVertex(t,e,i,s,r),e=(t,e,i,s,r,n)=>this.emitCapVertex(t,e,i,s,r,n);this._extrusionVertexCount=0;for(const t of this.path.vertices)this.originData[3*t.index+0]=t.pos[0],this.originData[3*t.index+1]=t.pos[1],this.originData[3*t.index+2]=t.pos[2];this.startCap.rebuildConnectingProfileGeometry(this.path.vertices[0],this.profile,e);for(let e=1;e<this.path.vertices.length-1;++e)this.extruder.extrude(this.path.vertices[e],this.profile,t);if(this.endCap.rebuildConnectingProfileGeometry(this.path.vertices[this.path.vertices.length-1],this.profile,e),this.startCap.rebuildCapGeometry(this.path.vertices[0],e),this.endCap.rebuildCapGeometry(this.path.vertices[this.path.vertices.length-1],e),this.profile.hasUV()&&this.options.generateUV)for(let t=0;t<this.profile.uvs.length;++t)this.uvData[2*t+0]=this.profile.uvs[t],this.uvData[2*t+1]=0}buildTopology(){const t=(t,e,i)=>this.emitTriangle(t,e,i);this._triangleCount=0;const e=this.profile.vertices.length,i=this.profile.numSegments,s=this.numExtrusionProfiles-1;let r=i*s*2*3;this.startCap.indexBufferStart=r,this.startCap.firstProfileVertexIndex=0,r+=this.startCap.getNumIndices(),this.endCap.indexBufferStart=r,this.endCap.firstProfileVertexIndex=e*(this.numExtrusionProfiles-1),r+=this.endCap.getNumIndices(),this.vertexIndices=new Uint32Array(r),this.normalIndices=new Uint32Array(r),this.pathVertexIndices=new Uint32Array(r),this.profile.hasUV()&&this.options.generateUV&&(this.uvIndices=new Uint32Array(r));for(let r=0;r<i;++r){const i=this.profile.vertexIndices[2*r],n=this.profile.vertexIndices[2*r+1];for(let r=0;r<s;++r){const s=r*e+i,o=(r+1)*e+n,a=r*e+n;t(s,(r+1)*e+i,o),t(s,o,a)}}this.startCap.buildTopology(this.path.vertices[0],t),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],t)}onPathChanged(){this.rebuildGeometry()}}class dl{constructor(t){this.builder=t}get xform(){return this.builder.path.xform}onPathChanged(){this.builder.onPathChanged()}}class fl extends dl{constructor(t){super(t),this.vertexAttributePosition=null,this.vertexAttributeNormal=null,this.vertexAttributeColor=null,this.vertexAttributePosition=new Float32Array(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=new Float32Array(3*this.builder.numNormalsTotal),this.vertexAttributeColor=new Uint8Array(4),this.vertexAttributeColor[0]=255,this.vertexAttributeColor[1]=255,this.vertexAttributeColor[2]=255,this.vertexAttributeColor[3]=255}bakeVertexColors(t){this.vertexAttributeColor[0]=255*t[0],this.vertexAttributeColor[1]=255*t[1],this.vertexAttributeColor[2]=255*t[2],this.vertexAttributeColor[3]=255*(t.length>3?t[3]:1)}bake(t){this.size=t;for(let e=0;e<this.builder.numVerticesTotal;++e){let i=this.builder.pathVertexData[e];const s=0===i||i===this.builder.path.vertices.length-1;i*=3;const r=ml;xi(r,this.builder.originData[i++],this.builder.originData[i++],this.builder.originData[i]);const n=4*e,o=bl,a=gl,h=wl,l=Pl,c=xl;let u=0,d=0;if(xi(l,this.builder.profileRightAxisData[n],this.builder.profileRightAxisData[n+1],this.builder.profileRightAxisData[n+2]),xi(c,this.builder.profileUpAxisData[n],this.builder.profileUpAxisData[n+1],this.builder.profileUpAxisData[n+2]),ni(a,this.builder.profileVertexAndNormalData[n]*t[0],this.builder.profileVertexAndNormalData[n+1]*t[1]),s)Ci(h,c,l),u=this.builder.profileRightAxisData[n+3]*t[0],d=this.builder.profileUpAxisData[n+3];else{const t=vl,e=yl;ni(t,this.builder.profileRightAxisData[n+3],this.builder.profileUpAxisData[n+3]);const i=ui(t);ci(t,t);const s=oi(a,t);if(Math.abs(s)>i){ni(e,-t[1],t[0]);const r=oi(a,e);ri(t,t,i*Math.sign(s)),ri(e,e,r),li(a,t,e)}xi(h,0,0,0)}xi(o,l[0]*a[0]+c[0]*a[1],l[1]*a[0]+c[1]*a[1],l[2]*a[0]+c[2]*a[1]),this.vertexAttributePosition[3*e+0]=r[0]+o[0]+h[0]*u,this.vertexAttributePosition[3*e+1]=r[1]+o[1]+h[1]*u,this.vertexAttributePosition[3*e+2]=r[2]+o[2]+h[2]*u;const f=gl;ni(f,this.builder.profileVertexAndNormalData[n+2],this.builder.profileVertexAndNormalData[n+3]),this.vertexAttributeNormal[3*e+0]=l[0]*f[0]+c[0]*f[1]+h[0]*d,this.vertexAttributeNormal[3*e+1]=l[1]*f[0]+c[1]*f[1]+h[1]*d,this.vertexAttributeNormal[3*e+2]=l[2]*f[0]+c[2]*f[1]+h[2]*d}}createGeometryData(){const t=[["position",this.builder.vertexIndices],["normal",this.builder.normalIndices]],e=[["position",{size:3,data:this.vertexAttributePosition,exclusive:!0}],["normal",{size:3,data:this.vertexAttributeNormal,exclusive:!0}]];return this.vertexAttributeColor&&(t.push(["color",new Uint32Array(this.builder.vertexIndices.length)]),e.push(["color",{size:4,data:this.vertexAttributeColor}])),{vertexAttributes:e,indices:t}}onPathChanged(){super.onPathChanged(),this.bake(this.size)}intersect(t,e,i){const s=this.builder.vertexIndices;be(t,e,0,s.length/3,s,{size:3,data:this.vertexAttributePosition},void 0,void 0,i)}}class pl extends dl{constructor(t,e,i,s){super(t),this.sizeAttributeValue=e,this.colorAttributeValue=i,this.opacityAttributeValue=s,this.vvData=null,this.baked=new fl(t),this.vvData=new Float32Array(4*this.builder.path.vertices.length);for(let t=0;t<this.builder.path.vertices.length;++t)this.vvData[4*t+0]=e,this.vvData[4*t+1]=i,this.vvData[4*t+2]=s,this.vvData[4*t+3]=0===t||t===this.builder.path.vertices.length-1?1:0}createGeometryData(){return{vertexAttributes:[["position",{size:3,data:this.builder.originData,exclusive:!0}],["profileRight",{size:4,data:this.builder.profileRightAxisData,exclusive:!0}],["profileUp",{size:4,data:this.builder.profileUpAxisData,exclusive:!0}],["profileVertexAndNormal",{size:4,data:this.builder.profileVertexAndNormalData,exclusive:!0}],["featureValue",{size:4,data:this.vvData,exclusive:!0}]],indices:[["position",this.builder.pathVertexIndices],["profileRight",this.builder.vertexIndices],["profileUp",this.builder.vertexIndices],["profileVertexAndNormal",this.builder.vertexIndices],["featureValue",this.builder.pathVertexIndices]]}}}const ml=Gi(),gl=di(),vl=di(),yl=di(),bl=Gi(),wl=Gi(),Pl=Gi(),xl=Gi(),Sl=Gi(),Cl=Qh(),Al=Qs();function zl(t,e){t.attributes.add("featureValue","vec4"),t.vertex.code.add(Zt`bool isCapVertex() {
return featureValue.w == 1.0;
}`),t.vertex.uniforms.add("size","vec3"),e.vvSize?(t.vertex.uniforms.add("vvSizeMinSize","vec3"),t.vertex.uniforms.add("vvSizeMaxSize","vec3"),t.vertex.uniforms.add("vvSizeOffset","vec3"),t.vertex.uniforms.add("vvSizeFactor","vec3"),t.vertex.code.add(Zt`vec2 getSize() {
return size.xy*clamp(vvSizeOffset + featureValue.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;
}`)):t.vertex.code.add(Zt`vec2 getSize(){
return size.xy;
}`),e.vvOpacity?(t.vertex.constants.add("vvOpacityNumber","int",8),t.vertex.code.add(Zt`uniform float vvOpacityValues[vvOpacityNumber];
uniform float vvOpacityOpacities[vvOpacityNumber];
vec4 applyOpacity(vec4 color) {
float value = featureValue.z;
if (value <= vvOpacityValues[0]) {
return vec4( color.xyz, vvOpacityOpacities[0]);
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));
}
}
return vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);
}`)):t.vertex.code.add(Zt`vec4 applyOpacity(vec4 color){
return color;
}`),e.vvColor?(t.vertex.constants.add("vvColorNumber","int",8),t.vertex.code.add(Zt`uniform float vvColorValues[vvColorNumber];
uniform vec4 vvColorColors[vvColorNumber];
vec4 getColor() {
float value = featureValue.y;
if (value <= vvColorValues[0]) {
return applyOpacity(vvColorColors[0]);
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));
}
}
return applyOpacity(vvColorColors[vvColorNumber - 1]);
}`)):t.vertex.code.add(Zt`vec4 getColor(){
return applyOpacity(vec4(1, 1, 1, 1));
}`),t.include(zr),t.attributes.add("profileRight","vec4"),t.attributes.add("profileUp","vec4"),t.attributes.add("profileVertexAndNormal","vec4"),t.vertex.code.add(Zt`vec3 calculateVPos() {
vec2 size = getSize();
vec3 origin = position;
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileVertex = profileVertexAndNormal.xy * size;
vec2 profileNormal = profileVertexAndNormal.zw;
float positionOffsetAlongProfilePlaneNormal = 0.0;
float normalOffsetAlongProfilePlaneNormal = 0.0;`),t.vertex.code.add(Zt`if(!isCapVertex()) {
vec2 rotationRight = vec2(profileRight.w, profileUp.w);
float maxDistance = length(rotationRight);`),t.vertex.code.add(Zt`rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);
float rx = dot(profileVertex, rotationRight);
if (abs(rx) > maxDistance) {
vec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);
float ry = dot(profileVertex, rotationUp);
profileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;
}
}else{
positionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];
normalOffsetAlongProfilePlaneNormal = profileUp.w;
}
vec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;
return origin + offset;
}`),t.vertex.code.add(Zt`vec3 localNormal() {
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileNormal = profileVertexAndNormal.zw;
vec3 normal = right * profileNormal.x + up * profileNormal.y;
if(isCapVertex()) {
normal += forward * profileUp.w;
}
return normal;
}`)}function Fl(t){const e=new qt;return e.vertex.uniforms.add("proj","mat4").add("view","mat4").add("camPos","vec3").add("localOrigin","vec3"),e.varyings.add("vpos","vec3"),e.include(zl,t),0!==t.output&&7!==t.output||(e.include(we,{linearDepth:!1}),t.receiveShadows&&e.include(Pe,t),e.include(xe,t),e.varyings.add("vnormal","vec3"),e.varyings.add("vcolor","vec4"),t.multipassTerrainEnabled&&e.varyings.add("depth","float"),e.vertex.code.add(Zt`
      void main() {
        vpos = calculateVPos();
        vnormal = normalize(localNormal());

        ${t.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
        gl_Position = transformPosition(proj, view, vpos);

        ${0===t.output?"forwardLinearDepth();":""}

        vcolor = getColor();
      }
    `)),t.multipassTerrainEnabled&&(e.fragment.include(Se),e.include(Ce,t)),7===t.output&&(e.include(Jt,t),e.fragment.uniforms.add("camPos","vec3"),e.fragment.uniforms.add("localOrigin","vec3"),e.fragment.uniforms.add("opacity","float"),e.fragment.code.add(Zt`
      void main() {
        discardBySlice(vpos);
        ${t.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        float combinedOpacity = vcolor.a * opacity;
        gl_FragColor = vec4(combinedOpacity);
      }
    `)),0===t.output&&(e.include(Jt,t),e.include(Fr,t),e.include(Or,t),t.receiveShadows&&e.include(Pe,t),e.include(Mr,t),e.fragment.uniforms.add("camPos","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("specular","vec3").add("opacity","float"),e.fragment.include(Ae),e.fragment.code.add(Zt`
      void main() {
        discardBySlice(vpos);
        ${t.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

        shadingParams.viewDirection = normalize(vpos - camPos);
        shadingParams.normalView = vnormal;
        vec3 normal = shadingNormal(shadingParams);
        float ssao = evaluateAmbientOcclusionInverse();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${t.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":1===t.viewingMode?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one
        float combinedOpacity = vcolor.a * opacity;
        albedo += 0.25 * specular; // don't completely ignore specular for now

        vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);
        gl_FragColor = vec4(shadedColor, combinedOpacity);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${t.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),1!==t.output&&3!==t.output||(e.include(we,{linearDepth:!0}),e.vertex.uniforms.add("nearFar","vec2"),e.varyings.add("depth","float"),e.vertex.code.add(Zt`void main() {
vpos = calculateVPos();
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
}`),e.include(Jt,t),e.include(ze,t),e.fragment.uniforms.add("timeElapsed","float"),e.fragment.code.add(Zt`void main() {
discardBySlice(vpos);
outputDepth(depth);
}`)),2===t.output&&(e.include(we,{linearDepth:!1}),e.include(Vt,t),e.vertex.uniforms.add("viewNormal","mat4"),e.varyings.add("vnormal","vec3"),e.vertex.code.add(Zt`void main(void) {
vpos = calculateVPos();
vnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);
gl_Position = transformPosition(proj, view, vpos);
}`),e.include(Jt,t),e.fragment.uniforms.add("waterColor","vec4"),e.fragment.code.add(Zt`void main() {
discardBySlice(vpos);
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) normal = -normal;
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
}`)),4===t.output&&(e.include(we,{linearDepth:!1}),e.include(Vt,t),e.vertex.uniforms.add("viewNormal","mat4"),e.varyings.add("vnormal","vec3"),e.vertex.code.add(Zt`void main(void) {
vpos = calculateVPos();
gl_Position = transformPosition(proj, view, vpos);
}`),e.include(Jt,t),e.include(Fe),e.fragment.code.add(Zt`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),e}const Ol=Object.freeze({__proto__:null,build:Fl}),Ml=new Map([["position",0],["profileRight",1],["profileUp",2],["profileVertexAndNormal",3],["featureValue",4]]);class Rl extends Qt{initializeProgram(t){const e=Rl.shader.get(),i=this.configuration,s=e.build({OITEnabled:0===i.transparencyPassType,output:i.output,viewingMode:t.viewingMode,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:i.receiveShadows,vvSize:i.vvSize,vvColor:i.vvColor,vvInstancingEnabled:!0,vvOpacity:i.vvOpacity,pbrMode:0,useCustomDTRExponentForWater:!1,receiveAmbientOcclusion:i.receiveSSAO,doubleSidedMode:i.doubleSidedMode,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new Yt(t.rctx,s,Ml)}bindPass(t,e){var i,s;ee(this.program,e.camera.projectionMatrix),this.program.setUniform3fv("size",t.size),e.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",e.camera.nearFar),this.program.setUniform2fv("inverseViewport",e.inverseViewport),Oe(this.program,e)),0!==this.configuration.output&&7!==this.configuration.output||this.program.setUniform1f("opacity",t.opacity),0===this.configuration.output?(e.lighting.setUniforms(this.program,!1),this.program.setUniform3fv("ambient",t.ambient),this.program.setUniform3fv("diffuse",t.diffuse),this.program.setUniform3fv("specular",t.specular),this.program.setUniform1f("opacity",t.opacity)):1!==this.configuration.output&&3!==this.configuration.output||Me(this.program,e.camera.nearFar),function(t,e){e.vvSizeEnabled&&(t.setUniform3fv("vvSizeMinSize",e.vvSizeMinSize),t.setUniform3fv("vvSizeMaxSize",e.vvSizeMaxSize),t.setUniform3fv("vvSizeOffset",e.vvSizeOffset),t.setUniform3fv("vvSizeFactor",e.vvSizeFactor)),e.vvColorEnabled&&(t.setUniform1fv("vvColorValues",e.vvColorValues),t.setUniform4fv("vvColorColors",e.vvColorColors)),e.vvOpacityEnabled&&(t.setUniform1fv("vvOpacityValues",e.vvOpacityValues),t.setUniform1fv("vvOpacityOpacities",e.vvOpacityOpacities))}(this.program,t),null==(i=e.shadowMap)||i.bind(this.program),null==(s=e.ssaoHelper)||s.bind(this.program,e.camera)}bindDraw(t){ne(this.program,t),ae(this.program,this.configuration,t),this.program.rebindTextures(),0!==this.configuration.output&&7!==this.configuration.output||oe(this.program,t.origin,t.camera.viewInverseTransposeMatrix),0===this.configuration.output&&Re(this.program,t),2===this.configuration.output&&Rr.bindUniforms(this.program,t.camera.viewInverseTransposeMatrix)}setPipelineState(t){const e=this.configuration,i=3===t,s=2===t;return Ne({blending:0!==e.output&&7!==e.output||!e.transparent?null:i?He:qe(t),culling:(t=>!t.slicePlaneEnabled&&!(t.transparent||0===t.doubleSidedMode))(e)&&Je,depthTest:{func:Ze(t)},depthWrite:i||s?$e:null,colorWrite:We,stencilWrite:e.sceneHasOcludees?_e:null,stencilTest:e.sceneHasOcludees?Te:null,polygonOffset:i||s?null:Xe})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}Rl.shader=new he(Ol,(()=>import("./p-1cd470ee.js")));class _l extends Kt{constructor(){super(...arguments),this.output=0,this.doubleSidedMode=0,this.receiveShadows=!1,this.receiveSSAO=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}h([Xt({count:8})],_l.prototype,"output",void 0),h([Xt({count:3})],_l.prototype,"doubleSidedMode",void 0),h([Xt()],_l.prototype,"receiveShadows",void 0),h([Xt()],_l.prototype,"receiveSSAO",void 0),h([Xt()],_l.prototype,"vvSize",void 0),h([Xt()],_l.prototype,"vvColor",void 0),h([Xt()],_l.prototype,"vvOpacity",void 0),h([Xt()],_l.prototype,"slicePlaneEnabled",void 0),h([Xt()],_l.prototype,"transparent",void 0),h([Xt()],_l.prototype,"sceneHasOcludees",void 0),h([Xt({count:4})],_l.prototype,"transparencyPassType",void 0),h([Xt()],_l.prototype,"multipassTerrainEnabled",void 0),h([Xt()],_l.prototype,"cullAboveGround",void 0);const Tl=Wr;class Dl extends le{constructor(t){super(t,Ll),this.supportsEdges=!0,this._vertexAttributeLocations=Ml,this.techniqueConfig=new _l,this.vertexBufferLayout=Dl.getVertexBufferLayout(this.parameters)}getTechniqueConfig(t,e){return this.techniqueConfig.output=t,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,0!==t&&7!==t||(this.techniqueConfig.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?1:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?2:0,this.techniqueConfig.receiveShadows=this.parameters.receiveShadows,this.techniqueConfig.receiveSSAO=!!e.ssaoEnabled&&this.parameters.receiveSSAO),this.techniqueConfig.transparencyPassType=e.transparencyPassType,this.techniqueConfig.multipassTerrainEnabled=e.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=e.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}isVisibleInPass(t){return 4!==t&&6!==t&&7!==t||this.parameters.castShadows}isVisible(){const t=this.parameters;return!!super.isVisible()&&t.opacity>0}intersect(e,i,s,r,n,o,a){const h=e;if(!Kh(h))return;const l=h.path,c=[this.parameters.size[0],this.parameters.size[1]];if(this.parameters.vvSizeEnabled){const t=this.parameters.vvSizeOffset,e=this.parameters.vvSizeFactor,i=this.parameters.vvSizeMinSize,s=this.parameters.vvSizeMaxSize,r=l.sizeAttributeValue;c[0]*=Ai(t[0]+r*e[0],i[0],s[0]),c[1]*=Ai(t[2]+r*e[2],i[2],s[2])}const u=Math.max(c[0],c[1]),d=e.boundingInfo;if(t(d))return void this._intersectTriangles(l,c,n,o,a);const f=ws(d.bbMin[0]-u,d.bbMin[1]-u,d.bbMin[2]-u,d.bbMax[0]+u,d.bbMax[1]+u,d.bbMax[2]+u),p=[o[0]-n[0],o[1]-n[1],o[2]-n[2]],m=Math.sqrt(p[0]*p[0]+p[1]*p[1]+p[2]*p[2]);De(f,n,[m/p[0],m/p[1],m/p[2]],r.tolerance)&&this._intersectTriangles(l,c,n,o,a)}_intersectTriangles(t,e,i,s,r){t.baked.size&&t.baked.size[0]===e[0]&&t.baked.size[1]===e[1]||t.baked.bake(e),t.baked.intersect(i,s,r)}computeAttachmentOrigin(t,e){const i=t.vertexAttributes;if(!i)return null;const s=i.get("position");return $r(s,null,!1,e)}createBufferWriter(){return new jl(this.vertexBufferLayout)}requiresSlot(t){return t===(this.parameters.transparent?4:2)||20===t}createGLMaterial(t){return 0===t.output||7===t.output||1===t.output||2===t.output||4===t.output||3===t.output&&this.parameters.castShadows?new El(t):null}static getVertexBufferLayout(t){let e=Ue().vec3f("position").vec4f("profileRight").vec4f("profileUp").vec4f("profileVertexAndNormal");return(t.vvColorEnabled||t.vvSizeEnabled||t.vvOpacityEnabled)&&(e=e.vec4f("featureValue")),e}}class El extends ce{updateParameters(t){return this.ensureTechnique(Rl,t)}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:t.hasOccludees})}_updateShadowState(e){(t(this.technique)||e.shadowMappingEnabled!==this.technique.configuration.receiveShadows)&&this._material.setParameters({receiveShadows:e.shadowMappingEnabled})}beginSlot(t){return 0!==this._output&&7!==this._output||(this._updateShadowState(t),this._updateOccludeeState(t)),this.updateParameters(t)}bind(t,e){e.bindPass(this._material.getPassParameters(),t)}}const Ll={size:[1,1,1],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],opacity:1,doubleSided:!1,doubleSidedType:"normal",receiveSSAO:!0,receiveShadows:!1,castShadows:!0,slicePlaneEnabled:!1,transparent:!1,sceneHasOcludees:!1,...Gt.Default,...ue};class jl{constructor(t){this.vertexBufferLayout=t}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get("position").length}write(t,e,i,s){const r=t=>{if(e.vertexAttributes.has(t)){const r=e.vertexAttributes.get(t),n=e.indices.get(t);Tl(4===r.size);const o=i.getField(t,ar);if(!o)throw new Error("unable to acquire view for "+t);pe(n,r.data,o,s)}};r("profileRight"),r("profileUp"),r("profileVertexAndNormal"),this.vertexBufferLayout.hasField("featureValue")&&r("featureValue"),Ee(e,this.vertexBufferLayout,t.transformation,t.invTranspTransformation,i,s)}}const Vl=["polyline"];function Gl(t,e,i){switch(e){case"world":for(const e of t.vertices)mi($l,e.pos,t.offset),i.worldUpAtPosition($l,Nl),e.setFrameFromUpVector(Nl),e.computeRotationAxisAndAngleFromUpVector();break;case"path":mi($l,t.vertices[0].pos,t.offset),i.worldUpAtPosition($l,Nl),function(t,e){let i=null;const s=t.vertices.length,r=.99619469809,n=Gi(),o=Gi(),a=Gi(),h=Gi(),l=Gi(),c=Gi(),u=on();let d=t.vertices[0];vi(o,e),xi(n,0,1,0),J.makeOrthoBasisDirUpFallback(d.vRight,o,n,n,a,o,r),vi(d.frame.up,o),vi(d.frame.right,a),i=d;for(let e=1;e<s;++e){d=t.vertices[e],mi(l,d.vLeft,d.vRight);let s=Ri(l);s>0?(s=1/Math.sqrt(s),l[0]=l[0]*s,l[1]=l[1]*s,l[2]=l[2]*s):(l[0]=d.vRight[0],l[1]=d.vRight[1],l[2]=d.vRight[2]),mi(c,i.pos,i.frame.up),rn(d.pos,l,u),nn(u,Ds(c,d.vLeft),h)?(bi(h,h,d.pos),wi(o,h),Ci(a,l,o),wi(a,a)):J.makeOrthoBasisDirUpFallback(l,i.frame.up,i.frame.right,n,a,o,r),vi(d.frame.up,o),vi(d.frame.right,a),i=d}}(t,Nl);for(const e of t.vertices){const t=Math.sign(Pi(e.frame.right,e.vRight));Ci(e.rotationFrame.up,e.vRight,e.vLeft),gi(e.rotationFrame.up,e.rotationFrame.up,t),wi(e.rotationFrame.up,e.rotationFrame.up);const i=Pi(e.rotationFrame.up,e.frame.up),s=Pi(e.rotationFrame.up,e.frame.right);if(gi($l,e.frame.up,-s),gi(kl,e.frame.right,i),mi($l,$l,kl),wi(e.rotationFrame.right,$l),tl(e.rotationRight,e.frame,e.rotationFrame.right),Oi($l,e.vLeft),e.rotationAngle=-t*(Math.PI-_i(Pi($l,e.vRight))),Math.abs(e.rotationAngle)>0){const t=Ti(Math.cos(.5*e.rotationAngle));qh(e.miterStretch,1+(t-1)*e.rotationRight[0]*e.rotationRight[0],(t-1)*e.rotationRight[0]*e.rotationRight[1],(t-1)*e.rotationRight[0]*e.rotationRight[1],1+(t-1)*e.rotationRight[1]*e.rotationRight[1])}const r=Math.PI-e.rotationAngle;e.maxStretchDistance=Math.abs(Math.min(e.vLeftLength,e.vRightLength)*Ti(Math.cos(.5*r)))}}}function Il(t,e,i){switch(t){case"symbol-value":return i;case"proportional":return e;default:return t}}function Bl(t,e,i,s){let r=0;for(const n of t.vertices)U(n.posES,i,e,s,Wl),r+=Wl.sampledElevation,mi(Nl,n.pos,t.offset),s.setAltitude(Nl,Wl.z),bi(n.pos,Nl,t.offset);return t.updatePathVertexInformation(),r/t.vertices.length}function Ul(t,e,i,s){const r=t.stageObject,n=r.geometryRecords;let o=0;for(const t of n){const n=t.geometry;if(!Kh(n))continue;const a=n.path,h=a.builder.path;o+=Bl(h,e,i,s),"world"!==n.upVectorAlignment&&Gl(h,n.upVectorAlignment,s),a.onPathChanged(),n.invalidateBoundingInfo(),r.geometryVertexAttrsUpdated(t)}return o/n.length}const Nl=Gi(),$l=tn(),kl=tn(),Wl=new k;function Hl(t,i,s,r,n=1){xi(Xl,1,0,0),xi(Kl,0,1,0),xi(Ql,0,0,1),function(t,e){xi(lc,0,0,0);for(let t=0;t<e.count-1;t++)e.getVec(t,Jl),mi(lc,lc,Jl);gi(t,lc,1/(e.count-1))}(ql,i),function(t){const e=t.count-1;return an(t,Zl,0,Math.floor(e/3),Math.floor(e*(2/3)))}(i)&&function(t,i,s,r,n,o){e(n)?(n.basisMatrixAtPosition(o,nc),xi(oc,nc[0],nc[1],nc[2]),xi(ac,nc[4],nc[5],nc[6]),xi(hc,nc[8],nc[9],nc[10])):(xi(oc,1,0,0),xi(ac,0,1,0),xi(hc,0,0,1));const a=en(t);Pi(a,hc)<0&&gi(a,a,-1),vi(r,a);const h=Pi(a,ac),l=Pi(a,oc);Math.abs(h)<Math.abs(l)?(Di(i,oc,a,-l),wi(i,i),Ci(s,i,a),wi(s,s),gi(s,s,-1)):(Di(s,ac,a,-h),wi(s,s),Ci(i,s,a),wi(i,i))}(Zl,Xl,Kl,Ql,s,ql),ni(Yl,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),ni(tc,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let t=0;t<i.count;t++){i.getVec(t,Jl);const e=Pi(Xl,Jl),s=Pi(Kl,Jl);Yl[0]=Math.min(Yl[0],e),Yl[1]=Math.min(Yl[1],s),tc[0]=Math.max(tc[0],e),tc[1]=Math.max(tc[1],s)}const o=Pi(Ql,ql);cc(ic,Yl[0],Yl[1],o,Xl,Kl,Ql),cc(sc,tc[0],Yl[1],o,Xl,Kl,Ql),cc(rc,Yl[0],tc[1],o,Xl,Kl,Ql),bi(sc,sc,ic),gi(sc,sc,.5),bi(rc,rc,ic),gi(rc,rc,.5),mi(ic,ic,sc),mi(ic,ic,rc);const a=Yl[1]%n;ec[0]=Yl[0]-Yl[0]%n,ec[1]=Yl[1]-a;for(let e=0;e<i.count;e++){i.getVec(e,Jl),t.setValues(e,(Pi(Xl,Jl)-ec[0])/n,(Pi(Kl,Jl)-ec[1])/n,ec[0]/n,ec[1]/n);for(let t=0;t<3;t++)r.set(e,t,ic[t]),r.set(e,t+3,sc[t]),r.set(e,t+6,rc[t])}}const ql=Gi(),Jl=Gi(),Zl=on(),Xl=Gi(),Kl=Gi(),Ql=Gi(),Yl=di(),tc=di(),ec=di(),ic=Gi(),sc=Gi(),rc=Gi(),nc=Qs(),oc=Gi(),ac=Gi(),hc=Gi(),lc=Gi();function cc(t,e,i,s,r,n,o){xi(t,e*r[0]+i*n[0]+s*o[0],e*r[1]+i*n[1]+s*o[1],e*r[2]+i*n[2]+s*o[2])}const uc=.70710678118,dc=uc;function fc(t){const e=new qt;t.draped||e.extensions.add("GL_OES_standard_derivatives");const i=1===t.output;e.include(we,{linearDepth:i}),e.include(Le,t),e.vertex.uniforms.add("proj","mat4"),e.vertex.uniforms.add("view","mat4"),i&&(e.include(ze,t),e.vertex.uniforms.add("cameraNearFar","vec2"),e.varyings.add("linearDepth","float")),t.draped?e.vertex.uniforms.add("worldToScreenRatio","float"):(e.vertex.uniforms.add("worldToScreenPerDistanceRatio","float"),e.vertex.uniforms.add("camPos","vec3"),e.attributes.add("boundingRect","mat3")),e.attributes.add("position","vec3"),e.attributes.add("uvMapSpace","vec4"),e.varyings.add("vpos","vec3"),e.varyings.add("vuv","vec2"),t.multipassTerrainEnabled&&e.varyings.add("depth","float");const s=3===t.style||4===t.style||5===t.style;return s&&e.vertex.code.add(Zt`
      const mat2 rotate45 = mat2(${Zt.float(uc)}, ${Zt.float(-dc)},
                                 ${Zt.float(dc)}, ${Zt.float(uc)});
    `),t.draped||(e.vertex.code.add(Zt`vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {
float projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);
return center + halfVector * clamp(projectedLength, -1.0, 1.0);
}`),e.vertex.code.add(Zt`vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {
float d = dot(planeNormal, planePoint);
float t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);
return rayOrigin + t * rayDir;
}`),e.vertex.code.add(Zt`
      float boundingRectDistanceToCamera() {
        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);
        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);
        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);
        vec3 n = normalize(cross(halfU, halfV));

        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);

        float viewAngle = dot(viewDir, n);
        float minViewAngle = ${Zt.float(.08715574274)};

        if (abs(viewAngle) < minViewAngle) {
          // view direction is (almost) parallel to plane -> clamp it to min angle
          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;
          viewDir = normalize(viewDir + normalComponent * n);
        }

        // intersect view direction with infinite plane that contains bounding rect
        vec3 planeProjected = intersectRayPlane(viewDir, camPos, n, center);

        // clip to bounds by projecting to u and v line segments individually
        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);
        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);

        // use to calculate the closest point to camera on bounding rect
        vec3 closestPoint = uProjected + vProjected - center;

        return length(closestPoint - camPos);
      }
    `)),e.vertex.code.add(Zt`
    vec2 scaledUV() {
      vec2 uv = uvMapSpace.xy ${s?" * rotate45":""};
      vec2 uvCellOrigin = uvMapSpace.zw ${s?" * rotate45":""};

      ${t.draped?"":Zt`
            float distanceToCamera = boundingRectDistanceToCamera();
            float worldToScreenRatio = worldToScreenPerDistanceRatio / distanceToCamera;
          `}

      // Logarithmically discretize ratio to avoid jittering
      float step = 0.1;
      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);

      vec2 uvOffset = mod(uvCellOrigin * discreteWorldToScreenRatio, ${Zt.float(t.patternSpacing)});
      return uvOffset + (uv * discreteWorldToScreenRatio);
    }
  `),e.vertex.code.add(Zt`
    void main(void) {
      vuv = scaledUV();
      vpos = position;
      ${t.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      forwardNormalizedVertexColor();
      gl_Position = ${i?Zt`transformPositionWithDepth(proj, view, vpos, cameraNearFar, linearDepth);`:Zt`transformPosition(proj, view, vpos);`}
    }
  `),e.include(Jt,t),e.fragment.include(Ae),e.fragment.uniforms.add("matColor","vec4"),t.draped&&e.fragment.uniforms.add("texelSize","float"),4===t.output&&e.include(Fe),t.multipassTerrainEnabled&&(e.fragment.include(Se),e.include(Ce,t)),4!==t.output&&(e.fragment.code.add(Zt`
      const float lineWidth = ${Zt.float(t.lineWidth)};
      const float spacing = ${Zt.float(t.patternSpacing)};
      const float spacingINV = ${Zt.float(1/t.patternSpacing)};

      float coverage(float p, float txlSize) {
        p = mod(p, spacing);

        float halfTxlSize = txlSize / 2.0;

        float start = p - halfTxlSize;
        float end = p + halfTxlSize;

        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;
        coverage -= min(lineWidth, mod(start, spacing));
        coverage -= max(lineWidth - mod(end, spacing), 0.0);

        return coverage / txlSize;
      }
    `),t.draped||e.fragment.code.add(Zt`const int maxSamples = 5;
float sample(float p) {
vec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));
float fwidth = dxdy.x + dxdy.y;
ivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));
vec2 invSamples = 1.0 / vec2(samples);
float accumulator = 0.0;
for (int j = 0; j < maxSamples; j++) {
if(j >= samples.y) {
break;
}
for (int i = 0; i < maxSamples; i++) {
if(i >= samples.x) {
break;
}
vec2 step = vec2(i,j) * invSamples - 0.5;
accumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);
}
}
accumulator /= float(samples.x * samples.y);
return accumulator;
}`)),e.fragment.code.add(Zt`
    void main() {
      discardBySlice(vpos);
      ${t.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
      vec4 color = ${t.attributeColor?"vColor * matColor;":"matColor;"}
      color = highlightSlice(color, vpos);

      ${4!==t.output?Zt`color.a *= ${function(t){function e(e){return t.draped?Zt`coverage(vuv.${e}, texelSize)`:Zt`sample(vuv.${e})`}switch(t.style){case 3:case 0:return e("y");case 4:case 1:return e("x");case 5:case 2:return Zt`
        1.0 - (1.0 - ${e("x")}) * (1.0 - ${e("y")})
      `;default:return"0.0"}}(t)};`:""}

      if (color.a < ${Zt.float(je)}) {
        discard;
      }

      ${7===t.output?Zt`gl_FragColor = vec4(color.a);`:""}

      ${0===t.output?Zt`gl_FragColor = color; ${t.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
      ${4===t.output?Zt`outputHighlight();`:""}
      ${1===t.output?Zt`outputDepth(linearDepth);`:""};
    }
  `),e}const pc=Object.freeze({__proto__:null,build:fc});class mc extends Qt{initializeProgram(t){const e=mc.shader.get(),i=this.configuration,s=e.build({output:i.output,attributeColor:i.vertexColors,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,style:i.style,patternSpacing:i.patternSpacing,lineWidth:i.lineWidth,draped:i.draped,OITEnabled:0===i.transparencyPassType,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new Yt(t.rctx,s,yc)}bindPass(t,e){ee(this.program,e.camera.projectionMatrix),this.program.setUniform4fv("matColor",t.color),this.configuration.draped?(this.program.setUniform1f("worldToScreenRatio",1/e.screenToPCSRatio),this.program.setUniform1f("texelSize",1/e.camera.pixelRatio)):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/e.camera.perScreenPixelRatio),4===this.configuration.output&&ve(this.program,e),(1===this.configuration.output||e.multipassTerrainEnabled)&&this.program.setUniform2fv("cameraNearFar",e.camera.nearFar),e.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",e.inverseViewport),Oe(this.program,e))}bindDraw(t){ne(this.program,t),oe(this.program,t.origin,t.camera.viewInverseTransposeMatrix),ae(this.program,this.configuration,t),this.program.rebindTextures()}setPipelineState(t,e){const i=this.configuration,s=3===t,r=2===t;return Ne({blending:0===i.output||7===i.output?s?He:qe(t):null,culling:Ke(i.cullFace),depthTest:{func:Ze(t)},depthWrite:s?i.writeDepth&&$e:Qe(t),colorWrite:We,stencilWrite:i.sceneHasOcludees?_e:null,stencilTest:i.sceneHasOcludees?e?Ve:Te:null,polygonOffset:s||r?i.polygonOffset&&gc:Ye(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this.setPipelineState(this.configuration.transparencyPassType,!0),this.setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(t,e){return e?this._occludeePipelineState:super.getPipelineState(t,e)}}mc.shader=new he(pc,(()=>import("./p-37d48179.js")));const gc={factor:1,units:1};class vc extends Kt{constructor(){super(...arguments),this.output=0,this.cullFace=0,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.polygonOffset=!1,this.writeDepth=!0,this.sceneHasOcludees=!1,this.enableOffset=!0,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}h([Xt({count:8})],vc.prototype,"output",void 0),h([Xt({count:3})],vc.prototype,"cullFace",void 0),h([Xt()],vc.prototype,"slicePlaneEnabled",void 0),h([Xt()],vc.prototype,"vertexColors",void 0),h([Xt()],vc.prototype,"polygonOffset",void 0),h([Xt()],vc.prototype,"writeDepth",void 0),h([Xt()],vc.prototype,"sceneHasOcludees",void 0),h([Xt({count:6})],vc.prototype,"style",void 0),h([Xt()],vc.prototype,"patternSpacing",void 0),h([Xt()],vc.prototype,"lineWidth",void 0),h([Xt()],vc.prototype,"enableOffset",void 0),h([Xt()],vc.prototype,"draped",void 0),h([Xt({count:4})],vc.prototype,"transparencyPassType",void 0),h([Xt()],vc.prototype,"multipassTerrainEnabled",void 0),h([Xt()],vc.prototype,"cullAboveGround",void 0);const yc=new Map([["position",0],["color",3],["uvMapSpace",4],["boundingRect",5]]);class bc extends le{constructor(t){super(t,xc),this.supportsEdges=!0,this._vertexAttributeLocations=yc,this.techniqueConfig=new vc}getTechniqueConfig(t,e){return this.techniqueConfig.output=t,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.vertexColors=this.parameters.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.polygonOffset=this.parameters.polygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.style=this.parameters.style,this.techniqueConfig.patternSpacing=this.parameters.patternSpacing,this.techniqueConfig.lineWidth=this.parameters.lineWidth,this.techniqueConfig.draped=this.parameters.draped,this.techniqueConfig.transparencyPassType=e.transparencyPassType,this.techniqueConfig.enableOffset=e.camera.relativeElevation<ti,this.techniqueConfig.multipassTerrainEnabled=e.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=e.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}intersect(t,e,i,s,r,n,o){Ge(t,e,s,r,n,void 0,o)}requiresSlot(t,e){return 20===t||(4===Ut(e)?2===t:t===(this.parameters.writeDepth?4:7))}createGLMaterial(t){return 0===t.output||7===t.output||4===t.output||1===t.output&&this.parameters.writeLinearDepth?new wc(t):null}createBufferWriter(){const t=Ue().vec3f("position").vec4u8("color").vec4f("uvMapSpace");return this.parameters.draped||t.mat3f("boundingRect"),new Pc(t)}}class wc extends ce{updateParameters(t){return this.ensureTechnique(mc,t)}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:t.hasOccludees})}beginSlot(t){return 0!==this._output&&7!==this._output||this._updateOccludeeState(t),this.updateParameters(t)}bind(t,e){e.bindPass(this._material.getPassParameters(),t)}}class Pc extends Nt{write(t,e,i,s){for(const r of this.vertexBufferLayout.fieldNames){const n=e.vertexAttributes.get(r),o=e.indices.get(r);if(n&&o)switch(r){case"position":{Wr(3===n.size);const e=i.getField(r,ir);e&&de(o,n.data,t.transformation,e,s);break}case"color":{Wr(3===n.size||4===n.size);const t=i.getField(r,lr);t&&Ie(o,n.data,n.size,t,s);break}case"uvMapSpace":{Wr(4===n.size);const t=i.getField(r,ar);t&&pe(o,n.data,t,s);break}case"boundingRect":{Wr(9===n.size);const e=i.getField(r,rr);e&&this.writeBoundingRect(o,n.data,t.transformation,e,s);break}}}}writeBoundingRect(t,e,i,s,r){const n=i,o=s.typedBuffer,a=s.typedBufferStride,h=t.length;r*=a;for(let i=0;i<h;++i){const s=9*t[i],h=e[s],l=e[s+1],c=e[s+2];o[r]=n[0]*h+n[4]*l+n[8]*c+n[12],o[r+1]=n[1]*h+n[5]*l+n[9]*c+n[13],o[r+2]=n[2]*h+n[6]*l+n[10]*c+n[14];for(let t=3;t<9;++t)o[r+t]=e[s+t];r+=a}}}const xc={color:[1,1,1,1],writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:0,sceneHasOcludees:!1,style:2,patternSpacing:10,lineWidth:1,draped:!0,...ue};function Sc(t,e){if(function(t){return t.material instanceof bc&&!t.material.parameters.draped}(t)){const i=t.geometry.vertexAttributes,s=i.get("position").data,r=i.get("uvMapSpace").data,n=i.get("boundingRect").data;Hl(ar.fromTypedArray(r),er.fromTypedArray(s),e,cr.fromTypedArray(n))}}function Cc(t,e,i,s){const r=An(t,e,i,s),n=t.stageObject.geometryRecords;for(let t=0;t<n.length;t++)Sc(n[t],s);return r}const Ac=["polyline","polygon","extent"];class zc extends ho{constructor(t,e,i,s){super(t,e,i,s),this._needsUV=!1,this._hasOutline=!1}async doLoad(){}ensureMaterials(){this.ensureFillMaterial(),this.ensureOutlineMaterial()}ensureFillMaterial(){if(e(this._material))return;const t=d(this.symbolLayer,"material","color"),i=this._getCombinedOpacityAndColor(t);this._material=function(t,i,s){return function(t,i,s){return e(t)?"none"===t.style||"solid"===t.style?("none"===t.style&&(i.color=mr(0,0,0,0),i.transparent=!0),new $t(i)):(i.style=function(t){switch(t){case"horizontal":return 0;case"vertical":return 1;case"cross":return 2;case"forward-diagonal":return 3;case"backward-diagonal":return 4;case"diagonal-cross":return 5;default:return}}(t.style),i.draped=s.isDraped,new bc(i)):new $t(i)}(function(t){return t&&t.pattern||null}(t),i,s)}(this.symbolLayer,{color:i,transparent:i[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,writeLinearDepth:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof bc,this._context.stage.add(this._material)}ensureOutlineMaterial(){const t=this.symbolLayer.outline;!e(this._outlineMaterial)&&this._isValidOutline(t)&&(this._hasOutline=!0,this._outlineMaterial=(e=>{const i=zt(t.pattern);return e>1.5?new Ft({width:e,color:this._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:i,stippleIntegerRepeats:!0,scaleStippleWithLineWidth:!0,cap:At(t.patternCap||"butt")}):new _t({color:this._getOutlineColor(),slicePlaneEnabled:this._context.slicePlaneEnabled,width:e,stipplePattern:i,stippleIntegerRepeats:!0})})(I(t.size)),this._context.stage.add(this._outlineMaterial))}_isValidOutline(i){return e(i)&&i.size&&i.size>0&&e(i.color)&&(t(i.pattern)||"style"!==i.pattern.type||"none"!==i.pattern.style)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null}createGraphics3DGraphic(t){const e=t.graphic;if(!this._validateGeometry(e.geometry,Ac,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(t.renderingInfo,255),s=this.setGraphicElevationContext(e,new Z);return this.ensureDrapedStatus("on-the-ground"===s.mode),this.ensureMaterials(),this.draped?this._createAsOverlay(e,i):this._createAs3DShape(e,i,s)}layerOpacityChanged(){if(e(this._material)){const t=this._material.parameters.color,e=d(this.symbolLayer,"material","color"),i=this._getCombinedOpacity(e);this._material.setParameters({color:[t[0],t[1],t[2],i],transparent:i<1||this.needsDrivenTransparentPass})}if(e(this._outlineMaterial)){const t=this._outlineMaterial.parameters.color;this._outlineMaterial.setParameters({color:[t[0],t[1],t[2],this._getOutlineOpacity()]})}return!0}layerElevationInfoChanged(t,e,i){const s=this._elevationContext.mode,r=ht(zc.elevationModeChangeTypes,i,s);if(r!==K.UPDATE)return r;const n=nt(s);return this.updateGraphics3DGraphicElevationInfo(t,e,(()=>n))}slicePlaneEnabledChanged(){return e(this._material)&&this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),e(this._outlineMaterial)&&this._outlineMaterial.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(e,i,s){const r=$o(e.geometry);if(t(r))return null;Oc.renderData=ko(r,this._context.elevationProvider,this._context.renderCoordsHelper,s),Oc.color=i;const n=Oc.renderData.position.length/3;if(this._needsUV&&(Oc.uvMapSpace=new Float32Array(4*n),Oc.boundingRect=new Float64Array(9*n)),Oc.outNum=0,Oc.outGeometries=[],Oc.outTransforms=[],Oc.outMaterials=[],this._createAs3DShapeFill(Oc),this._hasOutline&&this._createAs3DShapeOutline(Oc),this._logGeometryCreationWarnings(Oc.renderData,r.rings,"rings","FillSymbol3DLayer"),0===Oc.outNum)return null;this._needsUV&&Hl(ar.fromTypedArray(Oc.uvMapSpace),er.fromTypedArray(Oc.renderData.position),this._context.renderCoordsHelper,cr.fromTypedArray(Oc.boundingRect));const o=new wr({geometries:Oc.outGeometries,materials:Oc.outMaterials,transformations:Oc.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid}}),a=new jn(this,o,Oc.outGeometries,null,null,Cc,s);return a.alignedSampledElevation=Oc.renderData.sampledElevation,a.needsElevationUpdates=nt(s.mode),a}_createAs3DShapeFill(t){const i=t.renderData.polygons;for(const{position:r,mapPosition:n,holeIndices:o,index:a,count:h}of i){if(e(this._context.clippingExtent)&&(rs(Fc),fs(Fc,n),!ps(Fc,this._context.clippingExtent)))continue;const i=Es(n,o,3);if(0===i.length)continue;const l=Uo({indices:new Uint32Array(i),attributeData:{position:r,color:t.color,mapPosition:n,uvMapSpace:this._needsUV?new Float32Array(t.uvMapSpace.buffer,4*a*t.uvMapSpace.BYTES_PER_ELEMENT,4*h):null,boundingRect:this._needsUV?new Float64Array(t.boundingRect.buffer,9*a*t.boundingRect.BYTES_PER_ELEMENT,9*h):null}});t.outGeometries.push(l),t.outMaterials.push(s(this._material)),t.outTransforms.push(Ys),t.outNum++}}_createAs3DShapeOutline(t){if(!this._hasOutline)return;const i=t.renderData.outlines,r=this._outlineMaterial instanceof _t;for(let n=0;n<i.length;++n){const{mapPosition:o,position:a}=i[n];if(e(this._context.clippingExtent)&&(rs(Fc),fs(Fc,o),!ps(Fc,this._context.clippingExtent)))continue;const h=Mt({removeDuplicateStartEnd:r?0:1,attributeData:{position:a,mapPosition:o}}),l=h.vertexAttributes.get("position");l.data===a&&(l.data=new Float64Array(a)),t.outGeometries.push(h),t.outMaterials.push(s(this._outlineMaterial)),t.outTransforms.push(Ys),t.outNum++}}_createAsOverlay(i,r){const n=$o(i.geometry);return t(n)?null:(s(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,e(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority),Mc.renderData=Wo(n,this._context.overlaySR),Mc.color=r,this._needsUV&&(Mc.uvMapSpace=new Float32Array(Mc.renderData.position.length/3*4)),Mc.outNum=0,Mc.outGeometries=[],Mc.outBoundingBox=rs(),Mc.layerUid=this._context.layer.uid,Mc.graphicsUid=i.uid,this._createAsOverlayFill(Mc),this._hasOutline&&this._createAsOverlayOutline(Mc),this._logGeometryCreationWarnings(Mc.renderData,n.rings,"rings","FillSymbol3DLayer"),0===Mc.outNum?null:(this._needsUV&&function(t,e,i,s,r=1){if(i.isGeographic&&2!==s){const t=new Float64Array(e.typedBuffer.length),s=3*e.count;for(let r=0;r<s;r+=3)Yi(e.typedBuffer,r,t,r,un(i));e=er.fromTypedArray(t)}ni(Yl,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let t=0;t<e.count;t++)e.getVec(t,Jl),Yl[0]=Math.min(Yl[0],Jl[0]),Yl[1]=Math.min(Yl[1],Jl[1]);const n=Yl[1]%r;ec[0]=Yl[0]-Yl[0]%r,ec[1]=Yl[1]-n;for(let i=0;i<e.count;i++)e.getVec(i,Jl),t.setValues(i,(Jl[0]-ec[0])/r,(Jl[1]-ec[1])/r,ec[0]/r,ec[1]/r)}(ar.fromTypedArray(Mc.uvMapSpace),er.fromTypedArray(Mc.renderData.position),this._context.overlaySR,this._context.layerView.view.state.viewingMode),Mc.outNum>0?new fa(this,Mc.outGeometries,Mc.outBoundingBox):null))}_createAsOverlayFill(t){const e=t.renderData.polygons;for(const{position:i,holeIndices:r,index:n,count:o}of e){if(rs(Fc),fs(Fc,i),!ps(Fc,this._context.clippingExtent))continue;const e=Es(i,r,3);if(0===e.length)continue;cs(t.outBoundingBox,Fc);const a=Uo({indices:new Uint32Array(e),attributeData:{position:i,color:t.color,uvMapSpace:this._needsUV?new Float32Array(t.uvMapSpace.buffer,4*n*t.uvMapSpace.BYTES_PER_ELEMENT,4*o):null}}),h=new yt(a,s(this._material),t.layerUid,t.graphicsUid);Fi(h.boundingSphere,.5*(Fc[0]+Fc[3]),.5*(Fc[1]+Fc[4]),0,.5*Math.sqrt((Fc[3]-Fc[0])*(Fc[3]-Fc[0])+(Fc[4]-Fc[1])*(Fc[4]-Fc[1]))),t.outGeometries.push(h),t.outNum++}}_createAsOverlayOutline(t){if(!this._hasOutline)return;const e=t.renderData.outlines;for(let i=0;i<e.length;++i){const{position:r}=e[i];if(rs(Fc),fs(Fc,r),!ps(Fc,this._context.clippingExtent))continue;cs(t.outBoundingBox,Fc);const n=Mt({removeDuplicateStartEnd:this._outlineMaterial instanceof _t?0:1,attributeData:{position:r}}),o=new yt(n,s(this._outlineMaterial),t.layerUid,t.graphicsUid);Fi(o.boundingSphere,.5*(Fc[0]+Fc[3]),.5*(Fc[1]+Fc[4]),0,.5*Math.sqrt((Fc[3]-Fc[0])*(Fc[3]-Fc[0])+(Fc[4]-Fc[1])*(Fc[4]-Fc[1]))),t.outGeometries.push(o),t.outNum++}}_getOutlineOpacity(){const t=d(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(e(t)?t.a:0)}_getOutlineColor(){const t=d(this.symbolLayer,"outline","color"),i=this._getOutlineOpacity();return X(e(t)?G.toUnitRGB(t):null,i)}get test(){return{createAsOverlay:(t,e)=>this._createAsOverlay(t,e),createAs3DShape:(t,e,i)=>this._createAs3DShape(t,e,i)}}}zc.elevationModeChangeTypes={definedChanged:K.RECREATE,staysOnTheGround:K.NONE,onTheGroundChanged:K.RECREATE};const Fc=es(),Oc={renderData:null,color:null,uvMapSpace:null,boundingRect:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Mc={renderData:null,color:null,uvMapSpace:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};class Rc{constructor(t){this.definition=t,this.key=JSON.stringify(t),this.haloSize=Math.round(t.halo.size),this.fillStyle=this.colorToRGBA(t.color),this.haloStyle=this.colorToRGB(t.halo.color)}colorToRGB(t){return`rgb(${t.slice(0,3).map((t=>Math.floor(255*t))).toString()})`}colorToRGBA(t){return`rgba(${t.slice(0,3).map((t=>Math.floor(255*t))).toString()},${t[3]})`}static fromSymbol(t,i=1){const s=d(t,"material","color"),r=e(s)?G.toUnitRGBA(s):yr,n=t.halo,o=null!=t.size?I(t.size):12,a={family:t.font&&t.font.family?t.font.family:"sans-serif",weight:t.font&&t.font.weight?t.font.weight:"normal",style:t.font&&t.font.style?t.font.style:"normal"},h=e(n)&&e(n.color)&&n.size>0?{size:I(n.size),color:G.toUnitRGBA(n.color)}:{size:0,color:yr};return new Rc({size:o,color:r,font:a,halo:h,pixelRatio:i})}}class _c{constructor(t,e,i=2048){this.text=t,this._parameters=e,this.maxSize=i,this._lineWidths=new Array,this._renderPixelRatio=null,this._displayWidth=null,this.key=`${this._parameters.key}--${t}`,this._lines=t.split(/\r?\n/),this._lineHeight=this.computeLineHeight()}get displayWidth(){return this._ensureTextWidth()}get displayHeight(){return this._lineHeight*this._lines.length}get renderedWidth(){return Math.round(this.displayWidth*this.renderPixelRatio)}get renderedHeight(){return Math.round(this.displayHeight*this.renderPixelRatio)}get renderedLineHeight(){return Math.round(this._lineHeight*this.renderPixelRatio)}get renderedFontSize(){return this._parameters.definition.size*this.renderPixelRatio}get renderedHaloSize(){return this._parameters.haloSize*this.renderPixelRatio}get renderPixelRatio(){if(t(this._renderPixelRatio)){const t=this._parameters.definition.pixelRatio;this._renderPixelRatio=this.maxSize>0?Math.min(t,Math.min(this.maxSize/(this.displayWidth*t),this.maxSize/(this.displayHeight*t))):t}return this._renderPixelRatio}getLineXOffset(t){return Math.round((this.renderedWidth-this._lineWidths[t]*this.renderPixelRatio)/2)}render(t,e=0,i=0){const s=this.renderedLineHeight,r=this.renderedHaloSize,n=function(t,e){return"center"===t?.5*e:"right"===t?e:0}(t.textAlign,this.renderedWidth)+r,o=r+Tc;t.save(),r>0&&this.renderHalo(t,n,o,e,i),this.setFontProperties(t,this.renderedFontSize),i+=o,e+=n;for(let r=0;r<this._lines.length;++r){t.globalCompositeOperation="destination-out",t.fillStyle="rgb(0, 0, 0)";const n=this._lines[r],o=this.getLineXOffset(r);t.fillText(n,e+o,i),t.globalCompositeOperation="source-over",t.fillStyle=this._parameters.fillStyle,t.fillText(n,e+this.getLineXOffset(r),i),i+=s}t.restore()}renderHalo(t,e,i,s,r){const n=this.renderedWidth,o=this.renderedHeight,a=Ec(Lc,Math.max(n,jc),Math.max(o,jc)),h=a.getContext("2d");h.clearRect(0,0,n,o),this.setFontProperties(h,this.renderedFontSize),h.fillStyle=this._parameters.haloStyle,h.strokeStyle=this._parameters.haloStyle;const l=this.renderedHaloSize<3;h.lineJoin=l?"miter":"round",l?this.renderHaloEmulated(h,e,i):this.renderHaloNative(h,e,i),t.globalAlpha=this._parameters.definition.halo.color[3],t.drawImage(a,0,0,n,o,s,r,n,o),t.globalAlpha=1}renderHaloEmulated(t,e,i){const s=this.renderedLineHeight,r=this.renderedHaloSize;for(let n=0;n<this._lines.length;++n){const o=this._lines[n],a=this.getLineXOffset(n);for(const[s,n]of Dc)t.fillText(o,e+a+r*s,i+r*n);i+=s}}renderHaloNative(t,e,i){const s=this.renderedLineHeight,r=this.renderedHaloSize;for(let n=0;n<this._lines.length;++n){const o=2*r,a=this._lines[n],h=this.getLineXOffset(n),l=5,c=.1;for(let s=0;s<l;s++)t.lineWidth=(1-(l-1)*c+s*c)*o,t.strokeText(a,e+h,i);i+=s}}setFontProperties(t,e){const i=this._parameters.definition.font;t.font=`${i.style} ${i.weight} ${e}px ${i.family}, sans-serif`,t.textAlign="left",t.textBaseline="top"}_ensureTextWidth(){if(e(this._displayWidth))return this._displayWidth;const t=Ec(Lc,jc,jc).getContext("2d");this.setFontProperties(t,this._parameters.definition.size);let i=0,s=2*this._parameters.haloSize;this._lineWidths.length=0;const r=this._parameters.definition.font;("italic"===r.style||"oblique"===r.style||"string"==typeof r.weight&&("bold"===r.weight||"bolder"===r.weight)||"number"==typeof r.weight&&r.weight>600)&&(s+=.3*t.measureText("A").width);for(const e of this._lines){const r=Math.round(t.measureText(e).width+s);this._lineWidths.push(r),i=Math.max(i,r)}return this._displayWidth=i,this._displayWidth}computeLineHeight(){return Math.ceil(1.275*this._parameters.definition.size+2*this._parameters.haloSize)+Tc}}const Tc=1,Dc=[];{const t=16;for(let e=0;e<360;e+=360/t)Dc.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)])}function Ec(t,e,i){return t.canvas||(t.canvas=document.createElement("canvas")),t.canvas.width=e,t.canvas.height=i,t.canvas}const Lc={canvas:null},jc=512;class Vc extends Yr{constructor(t,e,i){super(),this.type=4,this._glTexture=null,this.events=new b,this._requiresPowerOfTwo=!fn(t.gl),this._renderer=new _c(e,i)}get width(){return this._renderer.renderedWidth}get height(){return this._renderer.renderedHeight}get textureWidth(){const t=this.width;return this._requiresPowerOfTwo?Ei(t):t}get textureHeight(){const t=this.height;return this._requiresPowerOfTwo?Ei(t):t}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}get texcoordScale(){return[this._renderer.renderedWidth/this.textureWidth,this._renderer.renderedHeight/this.textureHeight]}get requiresFrameUpdates(){return!1}createDescriptor(t){return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,flipped:!0,samplingMode:9987,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:t.parameters.maxMaxAnisotropy}}get glTexture(){return this._glTexture}load(t){if(e(this._glTexture))return this._glTexture;const i=Ec(Gc,this.textureWidth,this.textureHeight),s=i.getContext("2d");return s.save(),this._renderer.render(s,0,this.textureHeight-this._renderer.renderedHeight),this._glTexture=new pn(t,this.createDescriptor(t),i),s.restore(),this._glTexture}unload(){e(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),this.events.emit("unloaded")}}const Gc={canvas:null},Ic=[0,0,1];function Bc(t,i,s){t&&t.forEach((t=>{const r=i(t);e(r)&&s(r,t.graphic)}))}const Uc={mode:"relative-to-ground",offset:0},Nc={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],anchor:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawBorder:!1,displayWidth:0,displayHeight:0},$c=["polyline","polygon","extent"];class kc extends ho{constructor(t,e,i,s){super(t,e,i,s)}async doLoad(){}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(t){const e=t.graphic;if(!this._validateGeometry(e.geometry,$c,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(e,new Z);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(e):this._createAs3DShape(e,i,e.uid)}ensureMaterial(){if(e(this._material))return;const t={...Wt},i=this.symbolLayer.color;e(i)&&(t.color=G.toUnitRGBA(i));const s=this._getCombinedOpacity(i,{hasIntrinsicColor:!0});t.color=[t.color[0],t.color[1],t.color[2],s],t.transparent=s<1||this.needsDrivenTransparentPass,t.waveDirection=e(this.symbolLayer.waveDirection)?kc.headingVectorFromAngle(this.symbolLayer.waveDirection):fi(0,0);const r=Ht[this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize];t.waveStrength=r.waveStrength,t.waveTextureRepeat=r.textureRepeat,t.waveVelocity=r.waveVelocity,t.flowStrength=r.perturbationStrength,t.slicePlaneEnabled=this._context.slicePlaneEnabled,t.isDraped=this.draped,this._material=new kt(t),this._context.stage.add(this._material)}layerOpacityChanged(){if(t(this._material))return!0;const e=this._material.parameters.color,i=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0});return this._material.setParameters({color:[e[0],e[1],e[2],i],transparent:i<1||this.needsDrivenTransparentPass}),!0}layerElevationInfoChanged(t,e,i){const s=this._elevationContext.mode,r=ht(kc.elevationModeChangeTypes,i,s);if(r!==K.UPDATE)return r;const n=nt(s);return this.updateGraphics3DGraphicElevationInfo(t,e,(()=>n))}slicePlaneEnabledChanged(){return e(this._material)&&this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(e,i,s){const r=$o(e.geometry);if(t(r))return null;Zc.renderData=ko(r,this._context.elevationProvider,this._context.renderCoordsHelper,i);const n=Zc.renderData.position.length/3;if(Zc.uvCoords=new Float64Array(2*n),Zc.outNum=0,Zc.outGeometries=[],Zc.outTransforms=[],Zc.outMaterials=[],this._create3DShapeGeometries(Zc),this._logGeometryCreationWarnings(Zc.renderData,r.rings,"rings","WaterSymbol3DLayer"),0===Zc.outNum)return null;this._createUVCoordsFromVertices(Zc.uvCoords,Zc.renderData.mapPosition,n,this._context.elevationProvider.spatialReference);const o=new wr({geometries:Zc.outGeometries,materials:Zc.outMaterials,transformations:Zc.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:s}}),a=new jn(this,o,Zc.outGeometries,null,null,An,i);return a.alignedSampledElevation=Zc.renderData.sampledElevation,a.needsElevationUpdates=nt(i.mode),a}_createUVCoordsFromVertices(t,e,i,s){const r=dn(s);Ss(Hc);for(let t=0;t<i;t++)ni(qc,e[3*t+0],e[3*t+1]),Cs(Hc,qc);Li(Hc,Hc,r);const n=Hc[1]%kc.unitSizeOfTexture;Wc[0]=Hc[0]-Hc[0]%kc.unitSizeOfTexture,Wc[1]=Hc[1]-n;for(let s=0;s<i;s++)t[2*s+0]=(e[3*s+0]*r-Wc[0])/kc.unitSizeOfTexture,t[2*s+1]=(e[3*s+1]*r-Wc[1])/kc.unitSizeOfTexture}_create3DShapeGeometries(t){const i=t.renderData.polygons,r=t.uvCoords;for(const{count:n,index:o,position:a,mapPosition:h,holeIndices:l}of i){if(e(this._context.clippingExtent)&&(rs(Jc),fs(Jc,h),!ps(Jc,this._context.clippingExtent)))continue;const i=Es(h,l,3);if(0===i.length)continue;const c=No({indices:new Uint32Array(i),attributeData:{position:a,uv0:new Float64Array(r.buffer,2*o*r.BYTES_PER_ELEMENT,2*n),mapPosition:h}});t.outGeometries.push(c),t.outMaterials.push(s(this._material)),t.outTransforms.push(Ys),t.outNum++}}_createAsOverlay(e){const i=$o(e.geometry);if(t(i))return null;s(this._material).renderPriority=this._renderPriority,Xc.renderData=Wo(i,this._context.overlaySR);const r=Xc.renderData.position.length/3;return Xc.uvCoords=new Float64Array(2*r),Xc.outNum=0,Xc.outGeometries=[],Xc.outBoundingBox=rs(),Xc.layerUid=this._context.layer.uid,Xc.graphicsUid=e.uid,this._createAsOverlayWater(Xc),this._logGeometryCreationWarnings(Xc.renderData,i.rings,"rings","WaterSymbol3DLayer"),0===Xc.outNum?null:(this._createUVCoordsFromVertices(Xc.uvCoords,Xc.renderData.position,r,this._context.overlaySR),Xc.outNum>0?new fa(this,Xc.outGeometries,Xc.outBoundingBox):null)}_createAsOverlayWater(t){const e=t.uvCoords,i=t.renderData.polygons;for(const{position:r,holeIndices:n,index:o,count:a}of i){if(rs(Jc),fs(Jc,r),!ps(Jc,this._context.clippingExtent))continue;cs(t.outBoundingBox,Jc);const i=Es(r,n,3);if(0===i.length)continue;const h=No({indices:new Uint32Array(i),attributeData:{position:r,uv0:new Float64Array(e.buffer,2*o*e.BYTES_PER_ELEMENT,2*a)}}),l=new yt(h,s(this._material),t.layerUid,t.graphicsUid);Fi(l.boundingSphere,.5*(Jc[0]+Jc[3]),.5*(Jc[1]+Jc[4]),0,.5*Math.sqrt((Jc[3]-Jc[0])*(Jc[3]-Jc[0])+(Jc[4]-Jc[1])*(Jc[4]-Jc[1]))),t.outGeometries.push(l),t.outNum++}}static headingVectorFromAngle(t){const e=di(),i=ki(t);return e[0]=Math.sin(i),e[1]=Math.cos(i),e}get test(){return{create3DShape:t=>this._createAs3DShape(t.graphic,t.elevationContext,t.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}kc.unitSizeOfTexture=100,kc.elevationModeChangeTypes={definedChanged:K.RECREATE,staysOnTheGround:K.NONE,onTheGroundChanged:K.RECREATE};const Wc=di(),Hc=Ps(),qc=di(),Jc=es(),Zc={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Xc={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Kc=a.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory");function Qc(t,e,i,s){const r=tu[t.type]&&tu[t.type][e.type]||Yc[e.type];return r?new r(t,e,i,s):(Kc.error("GraphicsLayerFactory#make",`unknown symbol type ${e.type}`),null)}const Yc={icon:Ga,object:class extends ho{constructor(t,e,i,s){super(t,e,i,s),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this.hasLoadedPBRTextures=!1,this.ensureDrapedStatus(!1),this.hasLoadedPBRTextures=i.physicalBasedRenderingEnabled}getCachedSize(){const[t,i,s]=e(this._resources)?this._resources.symbolSize:[1,1,1];return{width:t,depth:i,height:s}}async doLoad(t){if(!this._drivenProperties.size&&dt(this.symbolLayer))throw new Error;const e=this.symbolLayer;if(this.isPrimitive){const i=e.resource?e.resource.primitive:T;this._resources=await this._createResourcesForPrimitive(i,t)}else this._resources=await this._createResourcesForUrl(e.resource.href,t);this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity()}get extentPadding(){return e(this._resources)?this._resources.extentPadding:0}get isPrimitive(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}get lodRenderer(){return d(this._resources,"lodRenderer")}setMaterialTransparencyParams(t,e=d(this.symbolLayer,"material","color")){const i=this._getCombinedOpacity(e),s=i<1||this.needsDrivenTransparentPass;return t.transparent=s,t.opacity=i,t.cullFace=s?0:2,t}async _createResourcesForPrimitive(t,i){if(!function(t){switch(t){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}(t))throw new Error(`Unknown object symbol primitive: ${t}`);const s=this.symbolLayer,r=es(V(t)),n=Bi(bs(r)),o=Bi(j(n,s)),a=Ri(o),h={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:Ii,diffuse:Ii,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},l=h.usePBR;this.setMaterialTransparencyParams(h);const c=this.symbol;if("point-3d"===c.type&&c.verticalOffset){const{screenLength:t,minWorldLength:e,maxWorldLength:i}=c.verticalOffset;h.verticalOffset={screenLength:I(t),minWorldLength:e||0,maxWorldLength:null!=i?i:1/0},h.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(h.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)h.externalColor=vr;else{const t=e(s.material)&&s.material.color,i=e(t)?G.toUnitRGBA(t):vr;h.externalColor=i}this._fastUpdates=Fa(this._context.renderer,this._fastVisualVariableConvertOptions(r,o,n,P)),this._fastUpdates.enabled?(Object.assign(h,this._fastUpdates.materialParameters),h.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(h.instanced.push("color"),this._optionalFields.push("color"));const u=$n(t,new Sr(h));if(!u)throw new Error(`Unknown object symbol primitive: ${t}`);const d=Xn(u).map((t=>({opacity:1,transparent:t.parameters.transparent}))),f=await this._createStageResources(u,l);return{lodResources:u,lodRenderer:await this._createLodRenderer(u,i),stageResources:f,symbolSize:o,extentPadding:a,isEsriSymbolResource:!1,isWosr:!1,originalMaterialParameters:d,physicalBasedRenderingEnabled:l,resourceBoundingBox:r,resourceSize:n,dispose:P,pivotOffset:P}}async _createResourcesForUrl(t,e){const i=["transformation"],s={materialParamsMixin:{instanced:i,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=Fa(this._context.renderer,this._fastVisualVariableConvertOptions(P,P,P,P)),this._fastUpdates.enabled?(Object.assign(s.materialParamsMixin,this._fastUpdates.materialParameters),i.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(i.push("color"),this._optionalFields.push("color"));const r=this.symbol;if("point-3d"===r.type&&r.verticalOffset){const{screenLength:t,minWorldLength:e,maxWorldLength:i}=r.verticalOffset;s.materialParamsMixin.verticalOffset={screenLength:I(t),minWorldLength:e||0,maxWorldLength:null!=i?i:1/0},s.materialParamsMixin.castShadows=!1}s.signal=e,s.usePBR=this._context.physicalBasedRenderingEnabled;const n=s.usePBR,o=await Ar(t,s),a=o.isEsriSymbolResource,h=o.isWosr,l=o.remove,c=function(t){return{levels:t.map((t=>function(t){const e=[];return t.stageResources.geometries.forEach(((i,s)=>{e.push({material:t.stageResources.materials[s],geometry:i,textures:t.stageResources.textures})})),{components:e,minScreenSpaceRadius:t.lodThreshold,pivotOffset:t.pivotOffset}}(t)))}}(o.lods);(function(t){t.levels.forEach((t=>{t.minScreenSpaceRadius||(t.minScreenSpaceRadius=function(t,e=dh){const i=function(t){return Kn(t).reduce(((t,e)=>t+e.indexCount/3),0)}(t);return Math.sqrt(i/(e*Math.PI))}(t))}))})(c),c.levels.sort(((t,e)=>t.minScreenSpaceRadius-e.minScreenSpaceRadius)),c.levels[0].minScreenSpaceRadius=Math.min(2,c.levels[0].minScreenSpaceRadius);const u=this._context,f=this._getExternalColorParameters(this.symbolLayer.material),p=d(this.symbolLayer,"material","color"),m=this._getCombinedOpacity(p,{hasIntrinsicColor:!0}),g=this.needsDrivenTransparentPass,v=Xn(c),y=Xn(c).map((t=>({opacity:t.parameters.opacity||1,transparent:t.parameters.transparent})));v.forEach((t=>{const e=t.parameters;t.setParameters(f);const i=e.opacity*m;t.setParameters({opacity:i,transparent:i<1||g||e.transparent}),u.screenSizePerspectiveEnabled&&t.setParameters({screenSizePerspective:u.sharedResources.screenSizePerspectiveSettings})}));const b=o.referenceBoundingBox,w=Bi(bs(b)),x=Bi(c.levels[0].pivotOffset),S=Bi(j(w,this.symbolLayer)),C=Ri(S);Oa(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(b,S,w,x))&&v.forEach((t=>t.setParameters(this._fastUpdates.materialParameters)));const A=await this._createStageResources(c,n);return{lodResources:c,lodRenderer:await this._createLodRenderer(c,e),stageResources:A,symbolSize:S,extentPadding:C,isEsriSymbolResource:a,isWosr:h,originalMaterialParameters:y,physicalBasedRenderingEnabled:n,resourceBoundingBox:b,resourceSize:w,dispose:l,pivotOffset:x}}async _createStageResources(t,e){const i=this._context.stage,s=Xn(t);e!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),i.addMany(s);const r=function(t){const e=new Array;return t.levels.forEach((t=>{t.components.forEach((t=>{t.textures&&e.push(...t.textures)}))})),o(e)}(t);i.addMany(r),await i.load(r);const n=function(t){const e=[];return t.levels.forEach((t=>{t.components.forEach((t=>{e.push(t.geometry)}))})),o(e)}(t);return i.addMany(n),{materials:s,textures:r,geometries:n}}async _createLodRenderer(t,e){const i=this._context.stage,s=this._fastUpdates.enabled?{applyTransform:(t,e,i)=>{t.getFeatureAttribute(e,Wh),Bs(i,Da(this._fastUpdates.materialParameters,Wh,i))},scaleFactor:(t,e,i)=>(e.getFeatureAttribute(i,Wh),Ea(t,this._fastUpdates.materialParameters,Wh))}:null,r=new Eh(t,this._optionalFields,{layerUid:this._context.layer.uid,graphicUid:t=>this._instanceIndexToGraphicUid.get(t),notifyGraphicGeometryChanged:t=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(t)),notifyGraphicVisibilityChanged:t=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(t))},s);return r.slicePlane=this._context.slicePlaneEnabled,await i.addRenderPlugin(r.slots,r,e),r}_getExternalColorParameters(t){const i={};return this._drivenProperties.color?i.externalColor=vr:e(t)&&e(t.color)?i.externalColor=G.toUnitRGBA(t.color):(i.externalColor=vr,i.colorMixMode="ignore"),i}destroy(){if(super.destroy(),e(this._resources)){const t=this._context.stage;t.removeRenderPlugin(this._resources.lodRenderer);const i=this._resources.stageResources;t.removeMany(i.materials),t.removeMany(i.textures),t.removeMany(i.geometries),e(this._resources.dispose)&&this._resources.dispose(),this._resources=null}}createGraphics3DGraphic(e){const i=e.graphic;if(!this._validateGeometry(i.geometry))return null;const s=vt(i.geometry);if(t(s))return this.logger.warn(`unsupported geometry type for icon symbol: ${i.geometry.type}`),null;const r=this.setGraphicElevationContext(i,new Z);return this._createAs3DShape(i,s,e.renderingInfo,r,i.uid)}notifyDestroyGraphicLayer(t){this._instanceIndexToGraphicUid.delete(t.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(t(this._resources))return!0;const e=this._drivenProperties.opacity,i=!this.isPrimitive,s=this._resources.stageResources.materials,r=this._resources.originalMaterialParameters;for(let t=0;t<s.length;t++){const n=s[t],o=d(this.symbolLayer,"material","color"),a=r[t],h=this._getCombinedOpacity(o,{hasIntrinsicColor:i})*a.opacity,l=h<1||e||a.transparent;n.setParameters({opacity:h,transparent:l}),this.isPrimitive&&n.setParameters({cullFace:l?0:2})}return!0}layerElevationInfoChanged(t,e){return this.updateGraphics3DGraphicElevationInfo(t,e,ft)}slicePlaneEnabledChanged(){if(t(this._resources))return!0;this._resources.lodRenderer.slicePlane=this._context.slicePlaneEnabled;for(const t of this._resources.stageResources.materials)t.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(t(this._resources))return!0;const{stageResources:e,isWosr:i}=this._resources;for(const t of e.materials)this.isPrimitive?t.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):i||t.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this.hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this.hasLoadedPBRTextures=!0,!1)}pixelRatioChanged(){return!0}applyRendererDiff(e,i){if(t(this._resources))return!0;const{stageResources:{materials:s},lodRenderer:r,resourceBoundingBox:n,symbolSize:o,resourceSize:a,pivotOffset:h}=this._resources;for(const t in e.diff){if("visualVariables"!==t)return!1;if(!Oa(this._fastUpdates,i,this._fastVisualVariableConvertOptions(n,o,a,h)))return!1;for(const t of s)t.setParameters(this._fastUpdates.materialParameters);r.notifyShaderTransformationChanged()}return!0}computeComplexity(){return t(this._resources)?super.computeComplexity():{primitivesPerFeature:Kn(this._resources.lodResources.levels[0]).reduce(((t,e)=>t+e.indices.get("position").length),0)/3,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:ro(this.symbol,this.symbolLayer)}}hasLodRenderer(){return e(this._resources)}_createAs3DShape(i,s,r,n,o){if(!this.hasLodRenderer()||t(this._resources))return null;const a=this.getFastUpdateAttrValues(i),h=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?X(r.color,r.opacity):null,l=this._context.clippingExtent;if(Xi(s,Nh,this._context.elevationProvider.spatialReference),e(l)&&!gs(l,Nh))return null;const c=this._requiresTerrainElevation(n),u=this._computeGlobalTransform(s,n,kh,Hh),d=this._computeLocalTransform(this._resources,this.symbolLayer,r,$h),f=this._resources.lodRenderer.instanceData,p=f.addInstance();this._instanceIndexToGraphicUid.set(p,o),f.setLocalTransform(p,d,!1),f.setGlobalTransform(p,u),a&&f.setFeatureAttribute(p,a),h&&f.setColor(p,h);const m=new oh(this,p,On,n);return c&&(m.alignedSampledElevation=Hh.sampledElevation),m.needsElevationUpdates=ft(n.mode),at(m,s,this._context.elevationProvider),m}_computeGlobalTransform(t,e,i,s){return U(t,this._context.elevationProvider,e,this._context.renderCoordsHelper,s),Nh[0]=t.x,Nh[1]=t.y,Nh[2]=s.z,qi(t.spatialReference,Nh,i,this._context.renderCoordsHelper.spatialReference),i}_computeLocalTransform(t,e,i,s){return Hs(s),this._applyObjectRotation(i,!1,s),this._applyObjectRotation(e,!0,s),this._applyObjectScale(t,i,s),this._applyAnchor(t,e,s),s}_applyObjectScale(t,e,i){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const s=Lt(this._drivenProperties.size&&e.size?e.size:t.symbolSize,t.symbolSize,t.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===s[0]&&1===s[1]&&1===s[2]||ks(i,i,s)}prepareSymbolLayerPatch(t){if("partial"!==t.diff.type)return;const e=t.diff.diff;this._preparePatchTransform(t,e),this._preparePatchColor(t,e)}updateGeometry(e,i){if(t(this._resources))return!0;const s=i&&vt(i);if(t(s))return!1;const r=this.getGeometryElevationMode(i);return e.elevationContext.mode===r&&(this._computeGlobalTransform(s,e.elevationContext,kh,Hh),this._requiresTerrainElevation(e.elevationContext)&&(e.alignedSampledElevation=Hh.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,kh,!0),at(e,s,this._context.elevationProvider),!0)}_preparePatchTransform(e,s){if(!(s.heading||s.tilt||s.roll||s.width||s.height||s.depth||s.anchor||s.anchorPosition))return;if(t(this._resources))return;const r=(t,e,s)=>i(null!=t&&"complete"===t.type?t.newValue:e,s),n=r(s.heading,this.symbolLayer.heading,0),o=r(s.tilt,this.symbolLayer.tilt,0),a=r(s.roll,this.symbolLayer.roll,0),h=r(s.width,this.symbolLayer.width,void 0),l=r(s.height,this.symbolLayer.height,void 0),c=r(s.depth,this.symbolLayer.depth,void 0),u=r(s.anchor,this.symbolLayer.anchor,void 0),d=r(s.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete s.heading,delete s.tilt,delete s.roll,delete s.width,delete s.height,delete s.depth,delete s.anchor,delete s.anchorPosition;const f={heading:n,tilt:o,roll:a,anchor:u,anchorPosition:d},p=this._resources;1===this.loadStatus&&e.symbolLayerStatePatches.push((()=>{p.symbolSize=Bi(j(p.resourceSize,{width:h,height:l,depth:c,isPrimitive:this.symbolLayer.isPrimitive}))})),e.graphics3DGraphicPatches.push(((t,e)=>{const i=this._computeLocalTransform(p,f,e,$h);p.lodRenderer.instanceData.setLocalTransform(t.instanceIndex,i,!0)}))}_preparePatchColor(i,s){if(!s.material||"partial"!==s.material.type)return;const r=s.material.diff;if(!r.color||"complete"!==r.color.type||null==r.color.newValue||null==r.color.oldValue)return;const n=r.color.newValue,o=e(n)?G.toUnitRGBA(n):vr;delete r.color;const a=this._resources;t(a)||i.graphics3DGraphicPatches.push((t=>{let e;this._hasPerInstanceColor()?(a.lodRenderer.instanceData.setColor(t.instanceIndex,o),e=this.setMaterialTransparencyParams({},n)):e=this.setMaterialTransparencyParams({externalColor:o},n);for(const t of a.stageResources.materials)t.setParameters(e)}))}_requiresTerrainElevation(t){return"absolute-height"!==t.mode}_applyObjectRotation(t,e,i){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&e))return jt(t.heading,t.tilt,t.roll,i)}_computeAnchor(t,i,s){const r=Gi();switch(s.anchor){case"center":vi(r,ns(t)),Oi(r,r);break;case"top":{const e=ns(t);xi(r,-e[0],-e[1],-t[5]);break}case"bottom":{const e=ns(t);xi(r,-e[0],-e[1],-t[2]);break}case"relative":{const e=ns(t),i=bs(t),n=s.anchorPosition,o=n?Ui(n.x,n.y,n.z):Ni;Mi(r,i,o),mi(r,r,e),Oi(r,r);break}default:e(i)?Oi(r,i):vi(r,Ni)}return r}_applyAnchor(t,e,i){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const s=this._computeAnchor(t.resourceBoundingBox,t.pivotOffset,e);s&&Ws(i,i,s)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(t,i,s,r){const n=e(t)?Bi(bs(t)):Ii,o=e(t)?this._computeAnchor(t,r,this.symbolLayer):Ni,a=this._context.renderCoordsHelper.unitInMeters,h=Lt(e(i)?i:void 0,i,s,a),l=Ui(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:n,symbolSize:e(i)?i:Ii,unitInMeters:a,transformation:{anchor:o,scale:h,rotation:l}}}},line:$a,path:class extends ho{constructor(t,e,i,s){super(t,e,i,s),this._intrinsicSize=fi(1,1),this.upVectorAlignment="path",this.stencilWidth=.1,this.ensureDrapedStatus(!1)}async doLoad(){const t=e(this.symbolLayer.width)?this.symbolLayer.width:this.symbolLayer.height,i=e(this.symbolLayer.height)?this.symbolLayer.height:t;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[t,1,i],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._fastUpdates=this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?Fa(this._context.renderer,this._vvConvertOptions):{enabled:!1};const s=this.symbolLayer.anchor||"center";this.upVectorAlignment="path","heading"===this.symbolLayer.profileRotation&&(this.upVectorAlignment="world");const r=this.symbolLayer.profile||"circle";this._profile="quad"===r?il.rect():il.circle(10);let n=[0,0];switch("center"!==s&&(n={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[s],this._profile.translate(n[0],n[1])),this.symbolLayer.join||"simple"){case"round":this._extruder=new nl(0,3);break;case"bevel":this._extruder=new nl(0,1);break;case"miter":this._extruder=new nl(.8*Math.PI,1);break;default:this._extruder=new rl}const o=this.symbolLayer.cap||"butt";switch(o){case"none":this._startCap=new hl,this._endCap=new hl;break;default:this._startCap=new ll(this._profile,0),this._endCap=new ll(this._profile,0,!0);break;case"square":this._startCap=new ll(this._profile,-.5),this._endCap=new ll(this._profile,.5,!0);break;case"round":{const t="quad"===r;this._startCap=new cl({profile:this._profile,flip:!1,breakNormals:t,subdivisions:3}),this._endCap=new cl({profile:this._profile,flip:!0,breakNormals:t,subdivisions:3});break}}const a=d(this.symbolLayer,"material","color"),h=this._getCombinedOpacityAndColor(a),l=Bi(h),c=h[3],f=c<1||this.needsDrivenTransparentPass,p={diffuse:l,ambient:l,opacity:c,transparent:f,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:f||"none"===o?0:2,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(ni(this._intrinsicSize,t,i),!It(this._intrinsicSize[0])||!It(this._intrinsicSize[1])))throw new u("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||ri(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled?(Object.assign(p,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new Dl(p)):(p.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new Sr(p)),this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(t){const e=t.graphic;if(!this._validateGeometry(e.geometry,Vl,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(e,new Z);return this._createAs3DShape(e,t.renderingInfo,i,e.uid)}layerOpacityChanged(){const t=d(this.symbolLayer,"material","color"),e=this._getCombinedOpacity(t);return this._material.setParameters({opacity:e,transparent:e<1||this.needsDrivenTransparentPass}),!0}layerElevationInfoChanged(t,e){return this.updateGraphics3DGraphicElevationInfo(t,e,ft)}slicePlaneEnabledChanged(){return this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}applyRendererDiff(t,e){for(const i in t.diff){if("visualVariables"!==i)return!1;if(!Oa(this._fastUpdates,e,this._vvConvertOptions))return!1;this._material.setParameters(this._fastUpdates.materialParameters)}return!0}getVertexData(t){let e=0;const i=t.paths,s=[],r=t.spatialReference,n=this._context.elevationProvider.spatialReference,o=this._context.renderCoordsHelper.spatialReference;for(const t of i)e+=t.length;const a=new Float64Array(3*e),h=new Float64Array(3*e),l=new Float64Array(3*e);let c=0;for(const e of i){s.push({index:c,numVertices:e.length});for(const i of e)a[c++]=i[0],a[c++]=i[1],a[c++]=t.hasZ?i[2]:0}let u=!0;return r.equals(n)?this._copyVertices(a,0,h,0,e):u=Ji(a,r,0,h,n,0,e),n.equals(o)?this._copyVertices(h,0,l,0,e):Ji(h,n,0,l,o,0,e),{pathVertexDataInfos:s,vertexDataGS:a,vertexDataES:h,vertexDataRS:l,projectionSuccess:u,terrainElevation:0}}_copyVertices(t,e,i,s,r){e*=3,s*=3;for(let n=0;n<r;++n)i[s++]=t[e++],i[s++]=t[e++],i[s++]=t[e++]}_createAs3DShape(t,i,s,r){const n=t.geometry,o=new Array,a=new Array,h=new Array,l=n.spatialReference,c=es(),u=this._context.renderCoordsHelper,d=this.getVertexData(n);if(!d.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(d.pathVertexDataInfos.length>0){for(let r=0;r<d.pathVertexDataInfos.length;++r){const n=d.pathVertexDataInfos[r],f=n.index,p=n.numVertices;if(p<2)continue;if(e(this._context.clippingExtent)&&(rs(c),fs(c,d.vertexDataES,3*f,p),!ps(c,this._context.clippingExtent)))continue;const m=[];for(let t=f;t<f+3*p;){const e=t++,i=t++,r=t++,n=new el;xi(n.posGS,d.vertexDataGS[e],d.vertexDataGS[i],d.vertexDataGS[r]),xi(n.posES,d.vertexDataES[e],d.vertexDataES[i],d.vertexDataES[r]);const o=Bt(n.posES,this._context.elevationProvider,s,u);xi(Nl,d.vertexDataRS[e],d.vertexDataRS[i],d.vertexDataRS[r]),u.setAltitude(Nl,o),xi(n.pos,Nl[0],Nl[1],Nl[2]),m.push(n)}const g=new sl(m);Gl(g,this.upVectorAlignment,this._context.renderCoordsHelper);const v=new ul(g,this._profile,this._extruder,this._startCap,this._endCap);let y=null;if(this._fastUpdates.enabled){const e=this._fastUpdates.visualVariables,i=e.size?lo(e.size.field,t):0,s=e.color?lo(e.color.field,t):0,r=e.opacity?lo(e.opacity.field,t):0;y=new pl(v,i,s,r)}else{const t=[this._intrinsicSize[0],this._intrinsicSize[1]];this._drivenProperties.size&&(t[0]*=Il(i.size[0],"symbol-value"===i.size[2]?this.symbolLayer.height||0:i.size[2],this.symbolLayer.width||0),t[1]*=Il(i.size[2],"symbol-value"===i.size[0]?this.symbolLayer.width||0:i.size[0],this.symbolLayer.height||0));let e=null;this._drivenProperties.color&&(e=i.color),this._drivenProperties.opacity&&null!=i.opacity&&(e=e?[e[0],e[1],e[2],i.opacity]:[1,1,1,i.opacity]);const s=new fl(v);s.bake(t),e&&s.bakeVertexColors(e),y=s}const{vertexAttributes:b,indices:w}=y.createGeometryData(),P=new Xh(b,w,y,l,this.upVectorAlignment,this.stencilWidth);o.push(P),a.push(this._material),h.push(y.xform)}if(o.length>0){const t=new wr({geometries:o,materials:a,transformations:h,metadata:{layerUid:this._context.layer.uid,graphicUid:r}}),e=new jn(this,t,o,null,null,Ul,s);return e.alignedSampledElevation=d.terrainElevation,e.needsElevationUpdates=ft(s.mode),e}}else 0!==n.paths.length&&n.paths.some((t=>t.length>0))||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null}},fill:zc,extrude:class extends ho{constructor(t,e,i,s){super(t,e,i,s),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const t=dt(this._getSymbolSize());if(t)throw new u("graphics3dextrudesymbollayer:invalid-size",t)}const t=d(this.symbolLayer,"material","color"),e=this._getCombinedOpacityAndColor(t),i=Bi(e),s=e[3],r=s<1||this.needsDrivenTransparentPass,n={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:i,ambient:i,opacity:s,transparent:r,cullFace:r?0:2,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new Sr(n),this._bottomMaterial=new Sr({...n,cullFace:2}),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial)}destroy(){super.destroy(),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))}createGraphics3DGraphic(t){const e=t.graphic;if(!this._validateGeometry(e.geometry,Jo,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(t.renderingInfo,255),s=this.setGraphicElevationContext(e,new Z);return this._createAs3DShape(e,t.renderingInfo,i,s,e.uid)}layerOpacityChanged(t,i){const s=d(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(s),n=r<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:r,transparent:n}),this._bottomMaterial.setParameters({opacity:r,transparent:n});const o=this._getLayerOpacity();return t.forEach((t=>{const s=i(t);e(s)&&s.layerOpacityChanged(o,this._context.isAsync)})),!0}layerElevationInfoChanged(t,e){return this.updateGraphics3DGraphicElevationInfo(t,e,ft)}slicePlaneEnabledChanged(t,i){return this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),t.forEach((t=>{const s=i(t);e(s)&&s.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}_getExtrusionSize(t){let e;var i;return e=t.size&&this._drivenProperties.size?null!=(i=function(t,e=0){const i=t[e];return"number"==typeof i&&isFinite(i)?i:null}(t.size,2))?i:0:this._getSymbolSize(),e/=this._context.renderCoordsHelper.unitInMeters,e}_getSymbolSize(){var t;return null!=(t=this.symbolLayer.size)?t:1}_createAs3DShape(i,s,r,n,o){const a=$o(i.geometry);if(t(a))return null;const h=ko(a,this._context.elevationProvider,this._context.renderCoordsHelper,n);if(this._logGeometryCreationWarnings(h,a.rings,"rings","ExtrudeSymbol3DLayer"),0===a.rings.length||!a.rings.some((t=>t.length>0)))return null;const l=rt(a);if(t(l))return null;const c=new Array,u=new Array,d=new Array,f=es(),p=Qs(),m=Gi(),g=1===this._context.renderCoordsHelper.viewingMode;g||this._context.renderCoordsHelper.worldUpAtPosition(null,m),qi(a.spatialReference,[l.x,l.y,0],p,this._context.renderCoordsHelper.spatialReference);const v=Qs();Us(v,p);const y=Is();Ls(y,v);const{polygons:b,mapPosition:w,position:P}=h,x=P.length/3,S=new Float64Array(3*x*6),C=new Float64Array(3*x*6),A=new Float64Array(3*x*6),z=new Float64Array(1*x*6);let F=0;for(let t=0;t<b.length;++t){const e=b[t],i=e.count;if(this._context.clippingExtent&&(rs(f),fs(f,e.mapPosition),!ps(f,this._context.clippingExtent)))continue;const n=Es(e.mapPosition,e.holeIndices,3);if(0===n.length)continue;const o=new Uint32Array(3*i*2+n.length),a=new Uint32Array(n.length),h=6*i,l=3*S.BYTES_PER_ELEMENT,p=new er(S.buffer,F*l,l,(F+h)*l),x=3*C.BYTES_PER_ELEMENT,O=new er(C.buffer,F*x,x,(F+h)*x),M=new Float64Array(A.buffer,3*F*A.BYTES_PER_ELEMENT,3*h),R=new Float64Array(z.buffer,1*F*z.BYTES_PER_ELEMENT,1*h),_=this._getExtrusionSize(s);Zo(P,w,n,e,p.typedBuffer,M,O.typedBuffer,R,0,o,a,_,m,g),ur(p,p,v),dr(O,O,y),F+=6*i;const T=this._createExtrudeGeometry(o,o.length-a.length,{positions:p.typedBuffer,elevation:M,normals:O.typedBuffer,heights:R},r);c.push(T),u.push(this._material),d.push(Ys);const D=this._createExtrudeGeometry(a,0,{positions:p.typedBuffer,elevation:M,normals:O.typedBuffer,heights:R},r);c.push(D),u.push(this._bottomMaterial),d.push(Ys)}if(0===c.length)return null;const O=new wr({geometries:c,materials:u,transformations:d,metadata:{layerUid:this._context.layer.uid,graphicUid:o,isElevationSource:!0}});O.transformation=p;const M=Wn(this.symbolLayer,{opacity:this._getLayerOpacity()}),R=e(M)?{baseMaterial:this._material,edgeMaterials:[M],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,_=new jn(this,O,c,null,null,oa,n,R);return _.alignedSampledElevation=h.sampledElevation,_.needsElevationUpdates=ft(n.mode),_}_createExtrudeGeometry(t,e,i,s){const r=new Uint32Array(t.length),n=[["position",{size:3,data:i.positions,exclusive:!0}],["normal",{size:3,data:i.normals,exclusive:!0}],["color",{size:4,data:s,exclusive:!0}],["size",{size:1,data:i.heights,exclusive:!0}]],o=[["position",t],["normal",t],["color",r]];return i.elevation&&(n.push(["mapPos",{size:3,data:i.elevation}]),o.push(["mapPos",t])),new me(n,o,0,e)}},text:class extends ho{constructor(t,e,i,s){super(t,e,i,s),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const t=dt(this.symbolLayer.size);if(t)throw new u("graphics3dtextsymbollayer:invalid-size",t)}this._createTextRenderParameters()}_createTextRenderParameters(){this._textRenderParameters=Rc.fromSymbol(this.symbolLayer,this._context.layerView.view.pixelRatio)}destroy(){super.destroy()}createGraphics3DGraphic(e){const i=e.graphic,s=vt(i.geometry);if(t(s))return this.logger.warn(`unsupported geometry type for text symbol: ${i.geometry.type}`),null;const r=this.symbolLayer.text;if(!r)return null;const n=D(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol:null;return this._createAs3DShape(i,s,r,n)}createLabel(e,i,s,r){const n=e.graphic,o=vt(n.geometry);if(t(o))return this.logger.warn(`unsupported geometry type for label: ${n.geometry.type}`),null;const a=i.text;return!a||/^\s+$/.test(a)?null:this._createAs3DShape(n,o,a,i,i,s,r)}setGraphicElevationContext(t,e,i=0){const s=super.setGraphicElevationContext(t,e);return s.addOffsetRenderUnits(i),s}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(t,e){return Bc(t,e,((t,e)=>{this.updateGraphicElevationContext(e,t)})),K.UPDATE}slicePlaneEnabledChanged(t,e){return Bc(t,e,(t=>{for(const e of t.stageObject.geometryRecords)e.material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled})})),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!1}updateGraphicElevationContext(t,e){this.setGraphicElevationContext(t,e.elevationContext,e.metadata.elevationOffset),e.needsElevationUpdates=nt(e.elevationContext.mode)||"absolute-height"===e.elevationContext.mode}_defaultElevationInfoNoZ(){return Uc}_createAs3DShape(i,s,r,n,o=Nc,a,h){const l=this.setGraphicElevationContext(i,new Z,o.elevationOffset),c="polyline"===d(i.geometry,"type"),u=i.uid,f=this._context.stage.renderView.renderingContext,p=mt[o.anchor in mt?o.anchor:"center"],m=t(h)?new Vc(f,r,this._textRenderParameters):null,g={occlusionTest:!0,screenOffset:o.screenOffset,anchorPos:p,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:o.centerOffsetUnits,debugDrawBorder:o.debugDrawBorder,drawInSecondSlot:!0};if(e(m)&&(g.textureId=m.id,g.texCoordScale=m.texcoordScale),e(h)&&(g.textureId=h.id),e(n)&&e(n.verticalOffset)){const{screenLength:t,minWorldLength:e,maxWorldLength:i}=n.verticalOffset;g.verticalOffset={screenLength:I(t),minWorldLength:e||0,maxWorldLength:null!=i?i:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:t,screenSizePerspectiveSettingsLabels:e}=this._context.sharedResources;g.screenSizePerspective=e.overridePadding(this._textRenderParameters.haloSize),g.screenSizePerspectiveAlignment=t}let v;if(c&&(g.shaderPolygonOffset=1e-4),g.slicePlaneEnabled=this._context.slicePlaneEnabled,e(a)){const e=JSON.stringify(g);v=a.get(e),t(v)&&(v=new gt(g),a.add(e,v))}else v=new gt(g);const y=[v],b=o.translation,w=e(m)?[m.displayWidth,m.displayHeight]:[0,0],P=[J.createPointGeometry(Ic,b,null,w,o.centerOffset,[0,0],null)],x=ot(this._context,s,P,y,l,this._context.layer.uid,u);if(null===x)return null;const S=new jn(this,x.object,P,t(a)?y:null,e(m)?[m]:null,zn,l);S.alignedSampledElevation=x.sampledElevation,S.needsElevationUpdates=nt(l.mode)||"absolute-height"===l.mode;const{displayWidth:C,displayHeight:A}=e(m)?m:o;return S.getScreenSize=(t=di())=>(t[0]=C,t[1]=A,t),S.metadata={labelText:r,elevationOffset:o.elevationOffset},at(S,s,this._context.elevationProvider),S}},water:kc},tu={"mesh-3d":{fill:class extends ho{constructor(t,e,i,s){super(t,e,i,s),this._materials=new Map,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){$.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new _t({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new _t({color:[0,1,1,1]}))}destroy(){super.destroy(),this._context.stage.removeMany(Array.from(this._materials.values(),(t=>t.material))),this._context.stage.removeMany(Array.from(this._textures.values())),this._materials.clear(),this._textures.clear()}createGraphics3DGraphic(t){const e=t.graphic;if(!this._validateGeometry(e.geometry,Xa,"fill on mesh-3d"))return null;const i=this.setGraphicElevationContext(e,new Z);return this._createAs3DShape(e,t.renderingInfo,i,e.uid)}layerOpacityChanged(t,i){const s=this._getLayerOpacity();return this._materials.forEach((t=>{t.material.setParameters({layerOpacity:s});const e=t.material.parameters;this._setMaterialTransparentParameter(e,t),t.material.setParameters({transparent:e.transparent})})),t.forEach((t=>{const r=i(t);e(r)&&r.layerOpacityChanged(s,this._context.isAsync)})),!0}layerElevationInfoChanged(t,e){return this.updateGraphics3DGraphicElevationInfo(t,e,ft)}slicePlaneEnabledChanged(t,i){return this._materials.forEach((t=>{t.material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled})})),t.forEach((t=>{const s=i(t);e(s)&&s.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){const t=this._usePBR();return this._materials.forEach((e=>e.material.setParameters({usePBR:t}))),!0}pixelRatioChanged(){return!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(e){return t(e)?"-":e instanceof G?e.toHex():e.contentHash}_materialPropertiesDefault(t,e){const i=this._requiresSymbolVertexColors(),s=!!t.vertexAttributes.color,r=!!t.vertexAttributes.tangent;return{hasSymbolVertexColors:i,hasVertexColors:s,hasVertexTangents:r,uid:`vc:${s},vt:${r},vct${e},svc:${i}`}}_materialProperties(t,e,i){const s=this._materialPropertiesDefault(t,i);if(!e.material)return s;const{color:r,colorTexture:n,normalTexture:o,doubleSided:a,alphaCutoff:h,alphaMode:l}=e.material,c=this._colorOrTextureUid(r),u=this._colorOrTextureUid(n),d=this._colorOrTextureUid(o);if(s.color=r,s.colorTexture=n,s.normalTexture=o,s.uid=`${s.uid},cmuid:${c},ctmuid:${u},ntmuid:${d},ds:${a},ac:${h},am:${l}`,e.material instanceof jr){const{metallic:t,roughness:i,metallicRoughnessTexture:r,emissiveColor:n,emissiveTexture:o,occlusionTexture:a}=e.material,h=this._colorOrTextureUid(r),l=this._colorOrTextureUid(n),c=this._colorOrTextureUid(o),u=this._colorOrTextureUid(a);s.metallic=t,s.roughness=i,s.metallicRoughnessTexture=r,s.emissiveColor=n,s.emissiveTexture=o,s.occlusionTexture=a,s.uid=`${s.uid},mrm:${t},mrr:${i},mrt:${h},emuid:${l},etmuid:${c},otmuid:${u}`}return s}_setInternalColorValueParameters(t,e){e.diffuse=G.toUnitRGB(t),e.opacity=t.a}_getLoadableTextureResource(t){return t.data?t.data:t.url}_getInternalTextureId(t){const i=this._getInternalTexture(t,1);return e(i)?i.id:null}_getInternalTexture(t,e){const i=this._getLoadableTextureResource(t);if(!i)return null;const s=`${t.contentHash}/${e}`;let r=this._textures.get(s);return r||(r=new ge(i,{mipmap:!0,wrap:this._castTextureWrap(t.wrap),noUnpackFlip:!0,preMultiplyAlpha:1!==e}),this._textures.set(s,r),this._context.stage.add(r),this._context.stage.loadSynchronous(r)),r}_castTextureWrap(t="repeat"){if("string"==typeof t){const e=this._castTextureWrapIndividual(t);return{s:e,t:e}}return{s:this._castTextureWrapIndividual(t.horizontal),t:this._castTextureWrapIndividual(t.vertical)}}_castTextureWrapIndividual(t){switch(t){case"clamp":return 33071;case"mirror":return 33648;default:return 10497}}_setInternalMaterialParameters(t,i){if(e(t.color)&&this._setInternalColorValueParameters(t.color,i),e(t.colorTexture)){const s=this._getInternalTexture(t.colorTexture,i.textureAlphaMode);e(s)?(i.textureId=s.id,i.textureAlphaPremultiplied=!!s.params.preMultiplyAlpha):i.textureId=void 0}e(t.normalTexture)&&(i.normalTextureId=this._getInternalTextureId(t.normalTexture)),e(t.emissiveColor)&&(i.emissiveFactor=G.toUnitRGB(t.emissiveColor)),e(t.emissiveTexture)&&(i.emissiveTextureId=this._getInternalTextureId(t.emissiveTexture)),e(t.occlusionTexture)&&(i.occlusionTextureId=this._getInternalTextureId(t.occlusionTexture)),e(t.metallicRoughnessTexture)&&(i.metallicRoughnessTextureId=this._getInternalTextureId(t.metallicRoughnessTexture))}_setExternalMaterialParameters(t){const i=this._drivenProperties.color;let s=e(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;if(i)t.externalColor=vr;else{const i=e(this.symbolLayer.material)?this.symbolLayer.material.color:null;e(i)?t.externalColor=G.toUnitRGBA(i):(s=null,t.externalColor=vr)}s&&(t.colorMixMode=s),t.castShadows=!!this.symbolLayer.castShadows}_hasTransparentVertexColors(e){const i=e.vertexAttributes.color;if(t(i))return!1;for(let t=3;t<i.length;t+=4)if(255!==i[t])return!0;return!1}_getOrCreateMaterial(t,i){var s,r,n;const o=null==(s=i.material)?void 0:s.color,a=null==(r=i.material)?void 0:r.colorTexture,h=null==(n=i.material)?void 0:n.alphaMode,l="blend"===h,c=!("opaque"===h)&&(this._hasTransparentVertexColors(t)||e(o)&&o.a<1||e(a)&&a.transparent||l),u=this._materialProperties(t,i,c),d=this._materials.get(u.uid);if(d)return d.material;const f={material:null,isComponentTransparent:c,alphaMode:i.material?i.material.alphaMode:"opaque"},p=null==u.metallicRoughnessTexture&&null==u.metallic&&null==u.roughness,m={usePBR:this._usePBR(),isSchematic:p,vertexColors:u.hasVertexColors,symbolColors:u.hasSymbolVertexColors,vertexTangents:u.hasVertexTangents,ambient:Ni,diffuse:Ii,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:0,layerOpacity:this._getLayerOpacity(),slicePlaneEnabled:this._context.slicePlaneEnabled,initTextureTransparent:!0};p||(m.mrrFactors=[null!=u.metallic?u.metallic:1,null!=u.roughness?u.roughness:1,.5]),i.material&&(m.doubleSided=i.material.doubleSided,m.cullFace=i.material.doubleSided?0:2,m.textureAlphaCutoff=i.material.alphaCutoff),this._setExternalMaterialParameters(m),this._setMaterialTransparentParameter(m,f),this._setInternalMaterialParameters(u,m);const g=new Sr(m);return f.material=g,this._materials.set(u.uid,f),this._context.stage.add(g),g}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(t,e){t.transparent=this.needsDrivenTransparentPass||e.isComponentTransparent||t.layerOpacity<1||t.opacity<1||t.externalColor&&t.externalColor[3]<1,t.textureAlphaMode="auto"===e.alphaMode?t.transparent?3:1:"opaque"===e.alphaMode?1:"mask"===e.alphaMode?2:0}_addDebugNormals(t,e,i,s){const r=e.length,n=t.spatialReference.isGeographic?20015077/180:1,o=.1*Math.max(t.extent.width*n,t.extent.height*n,t.extent.zmax-t.extent.zmin),a=[],h=[],l=[],c=[];for(let t=0;t<r;t++){const i=e[t],s=i.vertexAttributes.get("position"),r=i.vertexAttributes.get("normal"),n=i.indices.get("position"),u=i.indices.get("normal"),d=s.data,f=r.data;for(let t=0;t<n.length;t++){const e=3*n[t],i=3*u[t];for(let t=0;t<3;t++)a.push(d[e+t]);for(let t=0;t<3;t++)a.push(d[e+t]+f[i+t]*o);if(h.push(h.length),h.push(h.length),t%3==0){this._calculateFaceNormal(d,n,t,eh),this._getFaceVertices(d,n,t,Qa,Ya,th),mi(Qa,Qa,Ya),mi(Qa,Qa,th),gi(Qa,Qa,1/3);for(let t=0;t<3;t++)l.push(Qa[t]);for(let t=0;t<3;t++)l.push(Qa[t]+eh[t]*o);c.push(c.length),c.push(c.length)}}}const u=new me([["position",{data:a,size:3,exclusive:!0}]],[["position",new Uint32Array(h)]],2);e.push(u),i.push(this._debugVertexNormalMaterial),s.push(tr(s[0]));const d=new me([["position",{data:l,size:3,exclusive:!0}]],[["position",new Uint32Array(c)]],2);e.push(d),i.push(this._debugFaceNormalMaterial),s.push(tr(s[0]))}_createAs3DShape(t,i,s,r){const n=t.geometry;if("mesh"!==n.type)return null;const o=this._createGeometryInfo(n,i);if(!o)return null;const{geometries:a,materials:h,transformations:l,objectTransformation:c}=o;$.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(n,a,h,l);const u=new wr({geometries:a,materials:h,transformations:l,metadata:{layerUid:this._context.layer.uid,graphicUid:r}});u.transformation=c;const d=this._createEdgeMaterial(),f=e(d)?{baseMaterial:h[0],edgeMaterials:[d],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,p=new jn(this,u,a,null,null,zn,s,f);return p.needsElevationUpdates=ft(s.mode),p.useObjectOriginAsAttachmentOrigin=!0,p.elevationContext.centerPointInElevationSR=this.getCenterPointInElevationSR(u),p.alignedSampledElevation=zn(p,p.elevationContext,this._context.elevationProvider,this._context.renderCoordsHelper),p}getCenterPointInElevationSR(t){const e=Os(0,0,0,this._context.elevationProvider.spatialReference);return Ki([t.transformation[12],t.transformation[13],t.transformation[14]],this._context.renderCoordsHelper.spatialReference,e),e}_createComponentNormals(t,e,i,s){switch(i.shading||"flat"){case"source":return this._createComponentNormalsSource(t,e,i,s);case"flat":return this._createComponentNormalsFlat(t,s);case"smooth":return this._createComponentNormalsSmooth(t,s);default:return}}_createComponentNormalsSource(e,i,s,r){if(t(i))return this._createComponentNormalsFlat(e,r);let n=!1;if(!s.trustSourceNormals)for(let t=0;t<r.length;t+=3){this._calculateFaceNormal(e,r,t,eh);for(let e=0;e<3;e++){const s=3*r[t+e];Qa[0]=i[s+0],Qa[1]=i[s+1],Qa[2]=i[s+2],Pi(eh,Qa)<0&&(i[s+0]=-i[s+0],i[s+1]=-i[s+1],i[s+2]=-i[s+2],n=!0)}}return{normals:i,indices:r,didFlipNormals:n}}_createComponentNormalsFlat(t,e){const i=new Float32Array(e.length),s=new Uint32Array(3*e.length);for(let r=0;r<e.length;r+=3){const n=this._calculateFaceNormal(t,e,r,eh);for(let t=0;t<3;t++)i[r+t]=n[t],s[r+t]=r/3}return{normals:i,indices:s,didFlipNormals:!1}}_createComponentNormalsSmooth(t,e){const i={};for(let s=0;s<e.length;s+=3){const r=this._calculateFaceNormal(t,e,s,eh);for(let t=0;t<3;t++){const n=e[s+t];let o=i[n];o||(o={normal:Gi(),count:0},i[n]=o),mi(o.normal,o.normal,r),o.count++}}const s=new Float32Array(3*e.length),r=new Uint32Array(3*e.length);for(let t=0;t<e.length;t++){const n=i[e[t]];1!==n.count&&(wi(n.normal,n.normal),n.count=1);for(let e=0;e<3;e++)s[3*t+e]=n.normal[e];r[t]=t}return{normals:s,indices:r,didFlipNormals:!1}}_getFaceVertices(t,e,i,s,r,n){const o=3*e[i+0],a=3*e[i+1],h=3*e[i+2];s[0]=t[o+0],s[1]=t[o+1],s[2]=t[o+2],r[0]=t[a+0],r[1]=t[a+1],r[2]=t[a+2],n[0]=t[h+0],n[1]=t[h+1],n[2]=t[h+2]}_calculateFaceNormal(t,e,i,s){return this._getFaceVertices(t,e,i,Qa,Ya,th),bi(Ya,Ya,Qa),bi(th,th,Qa),Ci(Qa,Ya,th),wi(s,Qa),s}_getOrCreateComponents(t){return t.components?t.components:nh}_createPositionBuffer(t,i){let s=t.vertexAttributes.position;const r=1===i.reprojection?i.transformBeforeProject:null;if(e(r)&&(s=Vr(s,new Float64Array(s.length),r)),0===i.reprojection)return i.needsBufferCopy?new Float64Array(s):s;const n=e(r)?s:new Float64Array(s.length);return Ji(s,t.spatialReference,0,n,this._context.renderCoordsHelper.spatialReference,0,s.length/3),n}_createNormalBuffer(i,s,r){let n=i.vertexAttributes.normal;if(t(n))return null;const o=1===r.reprojection?r.transformBeforeProject:null;if(e(o)&&(n=Gr(n,new Float32Array(n.length),o)),"local"===this._context.layerView.view.viewingMode||0===r.reprojection)return r.needsBufferCopy&&i.vertexAttributes.normal===n?new Float32Array(n):n;const a=i.vertexAttributes.position,h=e(o)?n:new Float32Array(n.length);return Ir(n,a,s,i.spatialReference,h)}_createTangentBuffer(i,s,r){let n=i.vertexAttributes.tangent;if(t(n))return null;const o=1===r.reprojection?r.transformBeforeProject:null;if(e(o)&&(n=Br(n,new Float32Array(n.length),o)),"local"===this._context.layerView.view.viewingMode||0===r.reprojection)return r.needsBufferCopy&&i.vertexAttributes.normal===n?new Float32Array(n):n;const a=i.vertexAttributes.position,h=e(o)?n:new Float32Array(n.length);return Ur(n,a,s,i.spatialReference,h)}_createColorBuffer(t){return t.vertexAttributes.color}_createSymbolColorBuffer(t){if(this._requiresSymbolVertexColors()){const e=this._getVertexOpacityAndColor(t),i=ka(d(this.symbolLayer,"material","colorMixMode")),s=new Uint8Array(4);return Wa(e,i,s),s}return null}_createBuffers(t,i){const s=t.vertexAttributes&&t.vertexAttributes.position;if(!s)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const r=t.vertexAttributes.normal,n=t.vertexAttributes.uv,o=t.vertexAttributes.tangent;if(e(r)&&r.length!==s.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(e(o)&&o.length/4!=s.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(e(n)&&n.length/2!=s.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const a=this._computeReprojectionInfo(t),h=this._createPositionBuffer(t,a),l=this._createColorBuffer(t),c=this._createSymbolColorBuffer(i),u=this._createNormalBuffer(t,h,a),d=this._createTangentBuffer(t,h,a);return{positionBuffer:h,normalBuffer:u,tangentBuffer:d,uvBuffer:n,colorBuffer:l,symbolColorBuffer:c,objectTransformation:0===a.reprojection&&e(a.objectTransformation)?a.objectTransformation:this._transformOriginLocal(t,h,u,d),geometryTransformation:0===a.reprojection&&e(a.geometryTransformation)?a.geometryTransformation:Qs()}}_computeReprojectionInfo(t){const i=e(t.transform)&&t.transform.geographic||2===this._context.renderCoordsHelper.viewingMode?0:1;let s=null;if(e(t.transform)){if(0===i){const e=Qs();return qi(t.spatialReference,t.transform.origin,e,this._context.renderCoordsHelper.spatialReference),{reprojection:i,objectTransformation:e,geometryTransformation:tr(t.transform.localMatrix),needsBufferCopy:!1}}return s=Xs(Qs(),t.transform.origin),$s(s,s,t.transform.localMatrix),{reprojection:i,transformBeforeProject:s,needsBufferCopy:!0}}return{reprojection:i,needsBufferCopy:!0}}_transformOriginLocal(t,i,s,r){const n=this._context.renderCoordsHelper.spatialReference,o=t.anchor;Ka[0]=o.x,Ka[1]=o.y,Ka[2]=o.z;const a=Qs();qi(t.spatialReference,Ka,a,n);const h=er.fromTypedArray(i);if(Us(ih,a),ur(h,h,ih),e(s)||e(r)){if(js(sh,a),Vs(sh,sh),e(s)){const t=ir.fromTypedArray(s);dr(t,t,sh)}if(e(r)){const t=ir.fromTypedArray(r,4*r.BYTES_PER_ELEMENT);dr(t,t,sh)}}return a}_validateFaces(t,e){const i=t.vertexAttributes.position.length/3,s=e.faces;if(s){let t=-1;for(let e=0;e<s.length;e++){const i=s[e];i>t&&(t=i)}if(i<=t)return this.logger.warn(`Vertex index ${t} is out of bounds of the mesh position buffer`),!1}else if(i%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_getOrCreateFaces(t,e){return e.faces?e.faces:Nr(t.vertexAttributes.position.length/3)}_isOutsideClippingArea(t){if(!this._context.clippingExtent)return!1;const e=t.vertexAttributes&&t.vertexAttributes.position;if(!e)return!1;const i=this._context.elevationProvider.spatialReference;let s;const r=e.length/3;return t.spatialReference.equals(i)?s=e:(s=new Float64Array(e.length),Ji(t.vertexAttributes.position,t.spatialReference,0,s,i,0,r)),rs(rh),fs(rh,s,0,r),!ps(rh,this._context.clippingExtent)}_createGeometryInfo(i,s){if(!Qi(i.spatialReference,this._context.layerView.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(i))return null;const r=this._createBuffers(i,s);if(t(r))return null;const{positionBuffer:n,uvBuffer:o,colorBuffer:a,symbolColorBuffer:h,normalBuffer:l,tangentBuffer:c,objectTransformation:u,geometryTransformation:d}=r,f=this._getOrCreateComponents(i),p=[],m=[],g=[];let v=!1;for(const t of f){if(!this._validateFaces(i,t))return null;const s=this._getOrCreateFaces(i,t);if(0===s.length)continue;const r=this._createComponentNormals(n,l,t,s);r.didFlipNormals&&(v=!0);const u=[["position",{size:3,data:n,exclusive:!0}],["normal",{size:3,data:r.normals,exclusive:!0}]],f=[["position",s],["normal",r.indices]];e(a)&&(u.push(["color",{size:4,data:a,exclusive:!0}]),f.push(["color",s])),e(h)&&(u.push(["symbolColor",{size:4,data:h,exclusive:!0}]),f.push(["symbolColor",new Uint16Array(s.length)])),e(o)&&(u.push(["uv0",{size:2,data:o,exclusive:!0}]),f.push(["uv0",s])),e(c)&&(u.push(["tangent",{size:4,data:c,exclusive:!0}]),f.push(["tangent",s]));const y=new me(u,f);p.push(y),m.push(d),g.push(this._getOrCreateMaterial(i,t))}return v&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:p,transformations:m,materials:g,objectTransformation:u}}_createEdgeMaterial(){const t={opacity:this._getLayerOpacity()};return Wn(this.symbolLayer,t)}}}};class eu extends Nn{constructor(t,e,i){super(e.schedule),this._symbol=t,this._context=e,this._backgroundLayers=i,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}set symbol(e){this._symbol=e;for(let i=0;i<e.symbolLayers.length;i++){const s=this.symbolLayers[i];t(s)||(s.symbol=e,s.symbolLayer=e.symbolLayers.items[i])}}get symbol(){return this._symbol}async doLoad(t){let i=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(i=this._backgroundLayers.concat(i));const s=i.length;for(;this.symbolLayers.length<i.length;)this.symbolLayers.push(null);this.symbolLayers.length=i.length;const r=[];for(let e=0;e<s;e++){const n=i.getItemAt(e);if(!1===n.enabled)continue;iu.renderPriority=1-(1+e)/s,iu.renderPriorityStep=1/s,iu.ignoreDrivers=n._ignoreDrivers;const o=Qc(this.symbol,n,this._context,iu);r.push(x(t,(()=>{this.symbolLayers[e]=null,o.destroy()}))),this.symbolLayers[e]=o}await ei(this.symbolLayers,(async(t,i)=>{if(e(t))try{await t.load(),this._extentPadding+=Math.max(this._extentPadding,t.extentPadding)}catch{this.symbolLayers[i]=null}}));for(const t of r)null==t||t.remove();if(r.length=0,v(t),this.symbolLayers.length&&!this.symbolLayers.some((t=>!!t)))throw new Error}getSymbolLayerSize(t){const i=this.symbolLayers[t];return e(i)?i.getCachedSize():null}get extentPadding(){return this._extentPadding}createGraphics3DGraphic(t,i){const s=t.graphic,r=new Array(this.symbolLayers.length);for(let i=0;i<this.symbolLayers.length;i++){const s=this.symbolLayers[i];r[i]=e(s)?s.createGraphics3DGraphic(t):null}return new Vo(s,i||this,r,t.layer,this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null)}get complexity(){return to(this.symbolLayers.map((t=>d(t,"complexity"))))}globalPropertyChanged(t,i){const s=this.symbolLayers.length;for(let r=0;r<s;r++){const s=this.symbolLayers[r],n=t=>{const e=t.graphics[r];return e instanceof jn?e:null};if(e(s)&&!s.globalPropertyChanged(t,i,n))return!1}return!0}applyRendererDiff(e,i){return 1===this.loadStatus&&this.symbolLayers.reduce(((s,r)=>s&&(t(r)||r.applyRendererDiff(e,i))),!0)}prepareSymbolPatch(i){if(2===this.loadStatus)return;if("partial"!==i.diff.type)return;const s=i.diff.diff;if(!s.symbolLayers||"partial"!==s.symbolLayers.type)return;const r=s.symbolLayers.diff;this.symbolLayers.forEach(((s,n)=>{if(t(s))return;const o=r[n];if(o){const t={diff:o,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};s.prepareSymbolLayerPatch(t),i.symbolStatePatches.push(...t.symbolLayerStatePatches),t.graphics3DGraphicPatches.length&&i.graphics3DGraphicPatches.push(((i,s)=>{const r=i.graphics[n];e(r)&&t.graphics3DGraphicPatches.forEach((t=>t(r,s)))}))}}))}updateGeometry(e,i){for(let s=0;s<this.symbolLayers.length;s++){const r=this.symbolLayers[s];if(t(r))continue;const n=e.graphics[s];if(t(n)||!r.updateGeometry(n,i))return!1}return!0}onRemoveGraphic(i){for(let s=0;s<this.symbolLayers.length;s++){const r=this.symbolLayers[s];if(t(r))continue;const n=i.graphics[s];e(n)&&r.onRemoveGraphic(n)}}getFastUpdateStatus(){let e=0,i=0,s=0;return this.symbolLayers.forEach((r=>{t(r)||(0===r.loadStatus?e++:r.isFastUpdatesEnabled()?s++:i++)})),{loading:e,slow:i,fast:s}}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{super.destroy();for(const t of this.symbolLayers)e(t)&&t.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}}const iu={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};class su extends Nn{constructor(t,e,i){super(e),this.symbol=t,this.convert=i,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(t){return e(this.graphics3DSymbol)?this.graphics3DSymbol.getSymbolLayerSize(t):null}get symbolLayers(){return e(this.graphics3DSymbol)?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return e(this.graphics3DSymbol)?this.graphics3DSymbol.extentPadding:0}async doLoad(t){const e=await this.symbol.fetchSymbol({signal:t});e.id=this.symbol.id,this.graphics3DSymbol=this.convert(e),await this.graphics3DSymbol.load()}createGraphics3DGraphic(t){return e(this.graphics3DSymbol)?this.graphics3DSymbol.createGraphics3DGraphic(t,this):null}get complexity(){return e(this.graphics3DSymbol)?this.graphics3DSymbol.complexity:Qn}globalPropertyChanged(t,i){return!!e(this.graphics3DSymbol)&&this.graphics3DSymbol.globalPropertyChanged(t,i)}applyRendererDiff(t,i){return!!e(this.graphics3DSymbol)&&this.graphics3DSymbol.applyRendererDiff(t,i)}prepareSymbolPatch(t){e(this.graphics3DSymbol)&&this.graphics3DSymbol.prepareSymbolPatch(t)}updateGeometry(t,i){return!!e(this.graphics3DSymbol)&&this.graphics3DSymbol.updateGeometry(t,i)}onRemoveGraphic(){}getFastUpdateStatus(){return e(this.graphics3DSymbol)?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){e(this.graphics3DSymbol)&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return void 0===this.graphics3DSymbol}}const ru=.5*Math.PI,nu=ru/Math.PI*180;class ou{constructor(t){this.renderCoordsHelper=t.renderCoordsHelper,this.extent=new Array(4),this.planes=new Array(6),this.maxSpan=0,this.center={origin:Gi(),direction:Gi()};for(let t=0;t<4;t++)this.extent[t]={origin:Gi(),direction:Gi(),cap:{next:null,direction:Gi()}},this.planes[t]=on();this.planes[4]=on(),this.planes[5]=on(),this.planesWithoutFar=this.planes.slice(0,5)}update(t,e,i,s=!0){const r=this.extent;this.toRenderBoundingExtent(t,e,i),mi(this.center.origin,r[0].origin,r[2].origin),gi(this.center.origin,this.center.origin,.5),this.renderCoordsHelper.worldUpAtPosition(this.center.origin,this.center.direction),s||gi(this.center.direction,this.center.direction,-1);for(let t=0;t<4;t++){const e=r[t];this.renderCoordsHelper.worldUpAtPosition(e.origin,e.direction);const i=r[3===t?0:t+1];e.cap.next=i.origin,ji(e.cap.direction,e.origin,i.origin),hn(e.direction,e.cap.direction,e.origin,this.planes[t]),s||gi(e.direction,e.direction,-1)}hn(r[0].cap.direction,r[1].cap.direction,r[0].origin,this.planes[4]),s?ln(this.planes[4],this.planes[5]):(cn(this.planes[4],this.planes[5]),ln(this.planes[4],this.planes[4])),this.maxSpan=Math.max(Math.abs(t[0]-t[2]),Math.abs(t[1]-t[3])),this.maxSpanSpatialReference=e,this.minGlobalAltitude=.9*un(this.maxSpanSpatialReference).radius}isVisibleInFrustum(t,e,i=!1){if(null==t)return!1;if(1===this.renderCoordsHelper.viewingMode){if(this.maxSpan>(this.maxSpanSpatialReference.isGeographic?nu:ru*e))return!0;if(t.altitude>=this.minGlobalAltitude)return this.isVisibleInFrustumGlobal(t)}if(0===this.maxSpan){const e=this.extent[0];return!(i||!t.intersectsRay(Ds(e.origin,e.direction)))}for(let e=0;e<this.extent.length;e++){const s=this.extent[e];if(!i&&t.intersectsRay(Ds(s.origin,s.direction)))return!0;if(t.intersectsLineSegment(gn(s.origin,s.cap.next,fu),s.cap.direction))return!0}const s=i?this.planes:this.planesWithoutFar;for(let e=0;e<t.lines.length;e++){const i=t.lines[e];if(Pn(s,i.origin,i.endpoint,i.direction))return!0}return!1}toRenderBoundingExtentGlobal(t,e,i){As(t,hu),hu[2]=i,qi(e,hu,lu,this.renderCoordsHelper.spatialReference),Us(cu,lu),rs(uu);for(const{x0:s,x1:r,y0:n,y1:o}of au)for(let a=0;a<5;a++){const h=a/4;hu[0]=Vi(t[s],t[r],h),hu[1]=Vi(t[n],t[o],h),hu[2]=i,ts(hu,e,hu,this.renderCoordsHelper.spatialReference),Si(hu,hu,cu),vs(uu,hu)}xi(this.extent[0].origin,uu[0],uu[1],uu[2]),xi(this.extent[1].origin,uu[3],uu[1],uu[2]),xi(this.extent[2].origin,uu[3],uu[4],uu[2]),xi(this.extent[3].origin,uu[0],uu[4],uu[2]);for(let t=0;t<4;++t)Si(this.extent[t].origin,this.extent[t].origin,lu)}toRenderBoundingExtentLocal(t,e,i){Zi(t,e,du,this.renderCoordsHelper.spatialReference),xi(this.extent[0].origin,du[0],du[1],i),xi(this.extent[1].origin,du[2],du[1],i),xi(this.extent[2].origin,du[2],du[3],i),xi(this.extent[3].origin,du[0],du[3],i)}toRenderBoundingExtent(t,e,i){switch(this.renderCoordsHelper.viewingMode){case 1:this.toRenderBoundingExtentGlobal(t,e,i);break;case 2:this.toRenderBoundingExtentLocal(t,e,i)}}isVisibleInFrustumGlobal(t){if(Pi(this.center.direction,t.direction)<0)return!0;for(let e=0;e<4;e++)if(Pi(this.extent[e].direction,t.direction)<0)return!0;return!1}}const au=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],hu=Gi(),lu=Qs(),cu=Qs(),uu=es(),du=Ps(),fu=vn();function pu(e,i,s){if(t(e)||t(s))return!1;let r=!0;return gu[0]=null!=e.xmin?e.xmin:0,gu[1]=null!=e.ymin?e.ymin:0,gu[2]=null!=e.zmin?e.zmin:0,r=r&&Ji(gu,e.spatialReference,0,i,s,0,1),gu[0]=null!=e.xmax?e.xmax:0,gu[1]=null!=e.ymax?e.ymax:0,gu[2]=null!=e.zmax?e.zmax:0,r=r&&Ji(gu,e.spatialReference,0,i,s,3,1),null==e.xmin&&(i[0]=-1/0),null==e.ymin&&(i[1]=-1/0),null==e.zmin&&(i[2]=-1/0),null==e.xmax&&(i[3]=1/0),null==e.ymax&&(i[4]=1/0),null==e.zmax&&(i[5]=1/0),r}function mu(e,i,s){if(t(e)||t(s))return!1;let r=!0;return gu[0]=null!=e.xmin?e.xmin:0,gu[1]=null!=e.ymin?e.ymin:0,gu[2]=null!=e.zmin?e.zmin:0,r=r&&Ji(gu,e.spatialReference,0,gu,s,0,1),i[0]=gu[0],i[1]=gu[1],gu[0]=null!=e.xmax?e.xmax:0,gu[1]=null!=e.ymax?e.ymax:0,gu[2]=null!=e.zmax?e.zmax:0,r=r&&Ji(gu,e.spatialReference,0,gu,s,0,1),i[2]=gu[0],i[3]=gu[1],null==e.xmin&&(i[0]=-1/0),null==e.ymin&&(i[1]=-1/0),null==e.xmax&&(i[2]=1/0),null==e.ymax&&(i[3]=1/0),r}const gu=Gi();class vu{constructor(t,e){this.owner=e,this.properties={},this.afterDispatchHandle=null;for(const e in t){const i=new S(t[e],null,null,2,2);this.properties[e]={pool:i,acquired:[]}}this.afterDispatchHandle=C((()=>this.release()))}destroy(){this.afterDispatchHandle&&(this.afterDispatchHandle.remove(),this.afterDispatchHandle=null);for(const t in this.properties){const e=this.properties[t];for(const t of e.acquired)A(t)||e.pool.release(t);e.pool.destroy(),e.pool=null,e.acquired=null}this.properties=null,this.owner=null}get(t){const e=this.owner._get(t),i=this.properties[t];let s=i.pool.acquire();for(i.acquired.push(s);s===e;)i.acquired.push(s),s=i.pool.acquire();return s}release(){for(const t in this.properties){const e=this.properties[t];let i=0;for(const t of e.acquired)A(t)?e.acquired[i++]=t:e.pool.release(t);e.acquired.length=i}}}class yu{constructor(t,e){this.spatialReference=t,this.view=e}getElevation(t,e,i){return this.view.elevationProvider.getElevation(t,e,0,this.spatialReference,i)}async queryElevation(t,e,i,s,r){return this.view.elevationProvider.queryElevation(t,e,0,this.spatialReference,r,i,s)}}class bu{constructor(t,e,i,s){this.spatialReference=e,this._getElevationQueryProvider=i,this._queries=new Array,this._queryOptions={...s,ignoreInvisibleLayers:!0},this._frameTask=t.registerTask(yn.ELEVATION_QUERY,this)}destroy(){this._frameTask.remove()}queryElevation(t,e,i,s=0){return new Promise(((r,n)=>{const o={x:t,y:e,minDemResolution:s,result:{resolve:r,reject:n},signal:i};this._queries.push(o),z(i,(()=>{F(this._queries,o),n(O())}))}))}get running(){return this._queries.length>0}runTask(){const t=this._queries;this._queries=[];const i=this._getElevationQueryProvider();if(!i)return void t.forEach((t=>t.result.reject()));const s=t.map((t=>[t.x,t.y])),r=t.reduce(((t,e)=>Math.min(t,e.minDemResolution)),1/0),n=new Hi({points:s,spatialReference:this.spatialReference}),o=t.length>1&&t.some((t=>!!t.signal))?new AbortController:null,a=e(o)?o.signal:t[0].signal;if(e(o)){let e=0;t.forEach((i=>z(i.signal,(()=>{e++,i.result.reject(O()),e===t.length&&o.abort()}))))}const h={...this._queryOptions,minDemResolution:r,signal:a};i.queryElevation(n,h).then((i=>{t.forEach(((t,s)=>{e(t.signal)&&t.signal.aborted?t.result.reject(O()):t.result.resolve(i.geometry.points[s][2])}))})).catch((e=>{t.forEach((t=>t.result.reject(e)))}))}get test(){const t=this;return{update:()=>t._queries.length>0&&t.runTask()}}}const wu=t=>{let e=class extends t{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(t){super.postscript(t),bn(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const t=_(this.view.defaultsFromMap,"isHeightModelInfoSearching");this.handles.add(t),await t;const e=wn(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(e)throw e}};return h([M()],e.prototype,"view",void 0),h([M()],e.prototype,"slicePlaneEnabled",void 0),e=h([R("esri.views.3d.layers.LayerView3D")],e),e};export{_c as a,mu as b,eu as c,bu as d,To as e,Wa as f,eo as g,Yn as h,su as i,xn as j,ou as k,Hn as l,qn as m,yu as n,vu as o,wu as p,ka as q,Eo as r,Rc as s,Io as t,Bo as u,mo as v,po as w,pu as x,Fl as y,fc as z}