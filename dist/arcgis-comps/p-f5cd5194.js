import{z as e,$ as n,s as t,c as r,U as o,V as i,a,d as s,Z as l,A as f,e as p,J as u,ai as c,aj as m,a4 as d,ak as j}from"./p-1ce5adcc.js";import{D as E,q as b,r as w,P as y,G as N,y as I,_ as $,e as g,a as D,b as A,g as h,w as x,T as L,j as T,c as O,C as S,v as F,E as P,d as M}from"./p-52f4befd.js";import{c as v,E as G}from"./p-0910f78f.js";import{bT as B,c8 as C}from"./p-e58503d5.js";import{WhereClause as H}from"./p-61f47d2b.js";import{G as R}from"./p-dae095dd.js";import{y as V}from"./p-a131049b.js";import"./p-b79fcce3.js";import"./p-6f4b0bc8.js";import"./p-a184d75f.js";import"./p-5a4bf917.js";import"./p-c048b814.js";import"./p-5032dfbd.js";import"./p-182bb5be.js";import"./p-db87794e.js";import"./p-01e5a461.js";import"./p-c0f84cd3.js";import"./p-8925cd73.js";import"./p-dfc6337f.js";import"./p-54330161.js";import"./p-93765525.js";import"./p-765e6c28.js";import"./p-a9a30646.js";import"./p-8747982c.js";import"./p-8bc9b36a.js";import"./p-7a658388.js";import"./p-e273719b.js";import"./p-74de0937.js";import"./p-2f398ed1.js";import"./p-d3105731.js";import"./p-fb38a9d0.js";import"./p-f94762ac.js";import"./p-ea916a39.js";import"./p-8a919d07.js";import"./p-efbca0ca.js";import"./p-e991a11e.js";import"./p-612de336.js";import"./p-ca4492df.js";import"./p-9d34911e.js";import"./p-dc852195.js";import"./p-53bb6ab4.js";import"./p-a2324023.js";import"./p-5e833dfc.js";import"./p-7a5bfd29.js";import"./p-4a96de15.js";import"./p-7ca40eac.js";import"./p-d443df87.js";import"./p-9087b4d3.js";import"./p-c1cd5521.js";import"./p-2db4840f.js";import"./p-bba8b671.js";import"./p-ff2962f5.js";import"./p-a87cccba.js";import"./p-120b7410.js";import"./p-0eb619a6.js";import"./p-e392251d.js";import"./p-480e5606.js";import"./p-0e784e4d.js";import"./p-dbdf15fc.js";import"./p-e0d9ff4c.js";import"./p-08e5f531.js";import"./p-9f1c2d50.js";import"./p-6b2eb7a7.js";import"./p-889f7a78.js";import"./p-1f81b35d.js";import"./p-81b9df84.js";import"./p-5ce39624.js";import"./p-e9bae5e9.js";import"./p-b0565d49.js";import"./p-51a17e75.js";import"./p-d208934e.js";import"./p-afac6fb2.js";import"./p-3e39c093.js";import"./p-7731c620.js";import"./p-5d962998.js";import"./p-22c9f19c.js";import"./p-c096b5df.js";import"./p-da33e926.js";import"./p-a24f7752.js";import"./p-ccdb8e80.js";import"./p-4a6dc5e4.js";import"./p-6a92ecb9.js";import"./p-1ab449fc.js";import"./p-a6c8fb32.js";import"./p-0edb3309.js";import"./p-e8160b60.js";import"./p-2e8ad983.js";import"./p-e3270d48.js";import"./p-e44bd0a6.js";import"./p-e654504b.js";import"./p-fe68aab5.js";import"./p-c6970847.js";import"./p-de86b3c9.js";import"./p-37d3434c.js";import"./p-b1eff69d.js";import"./p-91fe06d4.js";import"./p-ab0e9273.js";import"./p-15a9486c.js";function k(e,n,t){const r=e.getVariables();if(r.length>0){const o=[];for(let e=0;e<r.length;e++)o.push(n.evaluateIdentifier(t,{name:r[e]}));return B(o).then((n=>{const t={};for(let e=0;e<r.length;e++)t[r[e]]=n[e];return e.parameters=t,e}))}return C(e)}function z(e,n,t=null){for(const t in e)if(t.toLowerCase()===n.toLowerCase())return e[t];return t}function W(e){if(null===e)return null;const n={type:z(e,"type",""),name:z(e,"name","")};if("range"===n.type)n.range=z(e,"range",[]);else{n.codedValues=[];for(const t of z(e,"codedValues",[]))n.codedValues.push({name:z(t,"name",""),code:z(t,"code",null)})}return n}function J(e){if(null===e)return null;const n={},t=z(e,"wkt",null);null!==t&&(n.wkt=t);const r=z(e,"wkid",null);return null!==r&&(n.wkid=r),n}function _(e){if(null===e)return null;const n={hasZ:z(e,"hasz",!1),hasM:z(e,"hasm",!1)},t=z(e,"spatialreference",null);t&&(n.spatialReference=J(t));const r=z(e,"x",null);if(null!==r)return n.x=r,n.y=z(e,"y",null),n;const o=z(e,"rings",null);if(null!==o)return n.rings=o,n;const i=z(e,"paths",null);if(null!==i)return n.paths=i,n;const a=z(e,"points",null);if(null!==a)return n.points=a,n;for(const t of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const r=z(e,t,null);null!==r&&(n[t]=r)}return n}function q(q){"async"===q.mode&&(q.functions.getuser=function(o,a){return q.standardFunctionAsync(o,a,((a,s,l)=>{e(l,1,2);let p=i(l[1],""),u=!0===p;if(p=!0===p||!1===p?"":n(p),l[0]instanceof t){let e=null;return o.services&&o.services.portal&&(e=o.services.portal),e=E(l[0],e),b(e,p,u).then((e=>{if(e){const n=JSON.parse(JSON.stringify(e));for(const e of["lastLogin","created","modified"])null!=n[e]&&(n[e]=new Date(n[e]));return r.convertObjectToArcadeDictionary(n)}return null}))}let c=null;if(f(l[0])&&(c=l[0]),c)return u=!1,p?null:c.load().then((()=>c.getOwningSystemUrl())).then((e=>{if(!e)return p?null:c.getIdentityUser().then((e=>e?r.convertObjectToArcadeDictionary({username:e}):null));let n=null;return o.services&&o.services.portal&&(n=o.services.portal),n=E(new t(e),n),b(n,p,u).then((e=>{if(e){const n=JSON.parse(JSON.stringify(e));for(const e of["lastLogin","created","modified"])null!=n[e]&&(n[e]=new Date(n[e]));return r.convertObjectToArcadeDictionary(n)}return null}))}));throw new Error("Invalid Parameter")}))},q.signatures.push({name:"getuser",min:"1",max:"2"}),q.functions.featuresetbyid=function(t,r){return q.standardFunctionAsync(t,r,((t,r,s)=>{if(e(s,2,4),s[0]instanceof w){const e=n(s[1]);let t=i(s[2],null);const r=o(i(s[3],!0));if(null===t&&(t=["*"]),!1===a(t))throw new Error("Invalid Parameter");return s[0].featureSetById(e,r,t)}throw new Error("Invalid Parameter")}))},q.signatures.push({name:"featuresetbyid",min:"2",max:"4"}),q.functions.getfeatureset=function(t,r){return q.standardFunctionAsync(t,r,((r,o,a)=>{if(e(a,1,2),a[0]instanceof s){let e=i(a[1],"datasource");return null===e&&(e="datasource"),e=n(e).toLowerCase(),y(a[0]._layer,e,t.lrucache,t.interceptor,t.spatialReference)}throw new Error("Invalid Parameter")}))},q.signatures.push({name:"getfeatureset",min:"1",max:"2"}),q.functions.featuresetbyportalitem=function(r,s){return q.standardFunctionAsync(r,s,((s,f,p)=>{if(e(p,2,5),null===p[0])throw new Error("Portal is required");if(p[0]instanceof t){const e=n(p[1]),t=n(p[2]);let s=i(p[3],null);const l=o(i(p[4],!0));if(null===s&&(s=["*"]),!1===a(s))throw new Error("Invalid Parameter");let f=null;return r.services&&r.services.portal&&(f=r.services.portal),f=E(p[0],f),N(e,t,r.spatialReference,s,l,f,r.lrucache,r.interceptor)}if(!1===l(p[0]))throw new Error("Portal is required");const u=n(p[0]),c=n(p[1]);let m=i(p[2],null);const d=o(i(p[3],!0));if(null===m&&(m=["*"]),!1===a(m))throw new Error("Invalid Parameter");if(r.services&&r.services.portal)return N(u,c,r.spatialReference,m,d,r.services.portal,r.lrucache,r.interceptor);throw new Error("Portal is required")}))},q.signatures.push({name:"featuresetbyportalitem",min:"2",max:"5"}),q.functions.featuresetbyname=function(t,r){return q.standardFunctionAsync(t,r,((t,r,s)=>{if(e(s,2,4),s[0]instanceof w){const e=n(s[1]);let t=i(s[2],null);const r=o(i(s[3],!0));if(null===t&&(t=["*"]),!1===a(t))throw new Error("Invalid Parameter");return s[0].featureSetByName(e,r,t)}throw new Error("Invalid Parameter")}))},q.signatures.push({name:"featuresetbyname",min:"2",max:"4"}),q.functions.featureset=function(n,t){return q.standardFunction(n,t,((t,o,i)=>{e(i,1,1);let s=i[0];const f={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(l(s))s=JSON.parse(s),void 0!==s.layerDefinition?(f.layerDefinition=s.layerDefinition,f.featureSet=s.featureSet,s.layerDefinition.spatialReference&&(f.layerDefinition.spatialReference=s.layerDefinition.spatialReference)):(f.featureSet.features=s.features,f.featureSet.geometryType=s.geometryType,f.layerDefinition.geometryType=f.featureSet.geometryType,f.layerDefinition.objectIdField=s.objectIdFieldName,f.layerDefinition.typeIdField=s.typeIdFieldName,f.layerDefinition.globalIdField=s.globalIdFieldName,f.layerDefinition.fields=s.fields,s.spatialReference&&(f.layerDefinition.spatialReference=s.spatialReference));else{if(!(i[0]instanceof r))throw new Error("Invalid Parameter");{s=JSON.parse(i[0].castToText());const e=z(s,"layerdefinition");if(null!==e){f.layerDefinition.geometryType=z(e,"geometrytype",""),f.featureSet.geometryType=f.layerDefinition.geometryType,f.layerDefinition.globalIdField=z(e,"globalidfield",""),f.layerDefinition.objectIdField=z(e,"objectidfield",""),f.layerDefinition.typeIdField=z(e,"typeidfield","");const n=z(e,"spatialreference",null);n&&(f.layerDefinition.spatialReference=J(n));for(const n of z(e,"fields",[])){const e={name:z(n,"name",""),alias:z(n,"alias",""),type:z(n,"type",""),nullable:z(n,"nullable",!0),editable:z(n,"editable",!0),length:z(n,"length",null),domain:W(z(n,"domain"))};f.layerDefinition.fields.push(e)}const t=z(s,"featureset",null);if(t){const e={};for(const n of f.layerDefinition.fields)e[n.name.toLowerCase()]=n.name;for(const n of z(t,"features",[])){const t={},r=z(n,"attributes",{});for(const n in r)t[e[n.toLowerCase()]]=r[n];f.featureSet.features.push({attributes:t,geometry:_(z(n,"geometry",null))})}}}else{f.layerDefinition.geometryType=z(s,"geometrytype",""),f.featureSet.geometryType=f.layerDefinition.geometryType,f.layerDefinition.objectIdField=z(s,"objectidfieldname",""),f.layerDefinition.typeIdField=z(s,"typeidfieldname","");const e=z(s,"spatialreference",null);e&&(f.layerDefinition.spatialReference=J(e));for(const e of z(s,"fields",[])){const n={name:z(e,"name",""),alias:z(e,"alias",""),type:z(e,"type",""),nullable:z(e,"nullable",!0),editable:z(e,"editable",!0),length:z(e,"length",null),domain:W(z(e,"domain"))};f.layerDefinition.fields.push(n)}const n={};for(const e of f.layerDefinition.fields)n[e.name.toLowerCase()]=e.name;for(const e of z(s,"features",[])){const t={},r=z(e,"attributes",{});for(const e in r)t[n[e.toLowerCase()]]=r[e];f.featureSet.features.push({attributes:t,geometry:_(z(e,"geometry",null))})}}}}if(!1===function(e){return!!e.layerDefinition&&!!e.featureSet&&!1!==function(e){for(const n of["","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])if(n===e)return!0;return!1}(e.layerDefinition.geometryType)&&null!==e.layerDefinition.objectIdField&&""!==e.layerDefinition.objectIdField&&!1!==a(e.layerDefinition.fields)&&!1!==a(e.featureSet.features)}(f))throw new Error("Invalid Parameter");return I.create(f,n.spatialReference)}))},q.signatures.push({name:"featureset",min:"1",max:"1"}),q.functions.filter=function(n,t){return q.standardFunctionAsync(n,t,((t,r,o)=>(e(o,2,2),f(o[0])?o[0].load().then((e=>{const t=H.create(o[1],e.getFieldsIndex()),r=t.getVariables();if(r.length>0){const e=[];for(let t=0;t<r.length;t++)e.push(q.evaluateIdentifier(n,{name:r[t]}));return B(e).then((e=>{const n={};for(let t=0;t<r.length;t++)n[r[t]]=e[t];return t.parameters=n,new $({parentfeatureset:o[0],whereclause:t})}))}return C(new $({parentfeatureset:o[0],whereclause:t}))})):q.failDefferred("Filter cannot accept this parameter type"))))},q.signatures.push({name:"filter",min:"2",max:"2"}),q.functions.orderby=function(n,t){return q.standardFunctionAsync(n,t,((n,t,r)=>{if(e(r,2,2),f(r[0])){const e=new g(r[1]);return C(new D({parentfeatureset:r[0],orderbyclause:e}))}return q.failDefferred("Order cannot accept this parameter type")}))},q.signatures.push({name:"orderby",min:"2",max:"2"}),q.functions.top=function(n,t){return q.standardFunctionAsync(n,t,((n,t,r)=>(e(r,2,2),f(r[0])?C(new A({parentfeatureset:r[0],topnum:r[1]})):a(r[0])?p(r[1])>=r[0].length?r[0].slice(0):r[0].slice(0,p(r[1])):u(r[0])?p(r[1])>=r[0].length()?r[0].slice(0):r[0].slice(0,p(r[1])):q.failDefferred("Top cannot accept this parameter type"))))},q.signatures.push({name:"top",min:"2",max:"2"}),q.functions.first=function(n,t){return q.standardFunctionAsync(n,t,((n,t,r)=>(e(r,1,1),f(r[0])?r[0].first(n.abortSignal).then((e=>{if(null!==e){const n=s.createFromGraphicLikeObject(e.geometry,e.attributes,r[0]);n._underlyingGraphic=e,e=n}return e})):a(r[0])?C(0===r[0].length?null:r[0][0]):u(r[0])?0===r[0].length()?C(null):C(r[0].get(0)):null)))},q.signatures.push({name:"first",min:"1",max:"1"}),q.functions.attachments=function(n,t){return q.standardFunctionAsync(n,t,((t,i,a)=>{e(a,1,2);const l={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(a.length>1)if(a[1]instanceof r){if(a[1].hasField("minsize")&&(l.minsize=p(a[1].field("minsize"))),a[1].hasField("metadata")&&(l.returnMetadata=o(a[1].field("metadata"))),a[1].hasField("maxsize")&&(l.maxsize=p(a[1].field("maxsize"))),a[1].hasField("types")){const e=c(a[1].field("types"),!1);e.length>0&&(l.types=e)}}else if(null!==a[1])throw new Error("Invalid Parameter");if(a[0]instanceof s){let e=a[0]._layer;return e instanceof R&&(e=h(e,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),null===e||!1===f(e)?[]:e.load().then((()=>e.queryAttachments(a[0].field(e.objectIdField),l.minsize,l.maxsize,l.types,l.returnMetadata)))}if(null===a[0])return[];throw new Error("Invalid Parameter")}))},q.signatures.push({name:"attachments",min:"1",max:"2"}),q.functions.featuresetbyrelationshipname=function(t,r){return q.standardFunctionAsync(t,r,((r,l,p)=>{e(p,2,4);const u=p[0],c=n(p[1]);let m=i(p[2],null);const d=o(i(p[3],!0));if(null===m&&(m=["*"]),!1===a(m))throw new Error("Invalid Parameter");if(null===p[0])return null;if(!(p[0]instanceof s))throw new Error("Invalid Parameter");let j=u._layer;return j instanceof R&&(j=h(j,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),null===j||!1===f(j)?null:j.load().then((e=>{const n=e.relationshipMetaData().filter((e=>e.name===c));if(0===n.length)return null;if(null!=n[0].relationshipTableId&&n[0].relationshipTableId>-1)return x(e,n[0],u.field(e.objectIdField),e.spatialReference,m,d,t.lrucache,t.interceptor);let r=e.serviceUrl();return r?(r="/"===r.charAt(r.length-1)?r+n[0].relatedTableId.toString():r+"/"+n[0].relatedTableId.toString(),L(r,e.spatialReference,m,d,t.lrucache,t.interceptor).then((t=>t.load().then((()=>t.relationshipMetaData())).then((r=>{if(r=r.filter((e=>e.id===n[0].id)),!1===u.hasField(n[0].keyField)||null===u.field(n[0].keyField))return e.getFeatureByObjectId(u.field(e.objectIdField),[n[0].keyField]).then((e=>{if(e){const o=H.create(r[0].keyField+"= @id",t.getFieldsIndex());return o.parameters={id:e.attributes[n[0].keyField]},t.filter(o)}return new v({parentfeatureset:t})}));const o=H.create(r[0].keyField+"= @id",t.getFieldsIndex());return o.parameters={id:u.field(n[0].keyField)},t.filter(o)}))))):null}))}))},q.signatures.push({name:"featuresetbyrelationshipname",min:"2",max:"4"}),q.functions.featuresetbyassociation=function(t,r){return q.standardFunctionAsync(t,r,((r,o,a)=>{e(a,2,3);const p=a[0],u=n(i(a[1],"")).toLowerCase(),c=l(a[2])?n(a[2]):null;if(null===a[0])return null;if(!(a[0]instanceof s))throw new Error("Invalid Parameter");let j=p._layer;return j instanceof R&&(j=h(j,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),null===j||!1===f(j)?null:j.load().then((()=>{const e=j.serviceUrl();return T(e,t.spatialReference)})).then((e=>{let n=null,t=null,r=!1;if(null!==c&&""!==c&&void 0!==c){for(const n of e.terminals)n.terminalName===c&&(t=n.terminalId);null===t&&(r=!0)}const o=e.associations.getFieldsIndex(),i=o.get("TOGLOBALID").name,a=o.get("FROMGLOBALID").name,s=o.get("TOTERMINALID").name,l=o.get("FROMTERMINALID").name,f=o.get("FROMNETWORKSOURCEID").name,E=o.get("TONETWORKSOURCEID").name,b=o.get("ASSOCIATIONTYPE").name,w=o.get("ISCONTENTVISIBLE").name,y=o.get("OBJECTID").name;for(const e of j.fields)if("global-id"===e.type){n=p.field(e.name);break}let N=null,I=new O(new V({name:"percentalong",alias:"percentalong",type:"double"}),H.create("0",e.associations.getFieldsIndex())),$=new O(new V({name:"side",alias:"side",type:"string"}),H.create("''",e.associations.getFieldsIndex()));const g="globalid",D="globalId",A={};for(const n in e.lkp)A[n]=e.lkp[n].sourceId;const h=new S(new V({name:"classname",alias:"classname",type:"string"}),null,A);let x="";switch(u){case"midspan":{x=`((${i}='${n}') OR ( ${a}='${n}')) AND (${b} IN (5))`,h.codefield=H.create(`CASE WHEN (${i}='${n}') THEN ${f} ELSE ${E} END`,e.associations.getFieldsIndex());const t=d(P.findField(e.associations.fields,a));t.name=g,t.alias=g,N=new O(t,H.create(`CASE WHEN (${a}='${n}') THEN ${i} ELSE ${a} END`,e.associations.getFieldsIndex())),I=e.unVersion>=4?new M(P.findField(e.associations.fields,o.get("PERCENTALONG").name)):new O(new V({name:"percentalong",alias:"percentalong",type:"double"}),H.create("0",e.associations.getFieldsIndex()));break}case"junctionedge":{x=`((${i}='${n}') OR ( ${a}='${n}')) AND (${b} IN (4,6))`,h.codefield=H.create(`CASE WHEN (${i}='${n}') THEN ${f} ELSE ${E} END`,e.associations.getFieldsIndex());const t=d(P.findField(e.associations.fields,a));t.name=g,t.alias=g,N=new O(t,H.create(`CASE WHEN (${a}='${n}') THEN ${i} ELSE ${a} END`,e.associations.getFieldsIndex())),$=new O(new V({name:"side",alias:"side",type:"string"}),H.create(`CASE WHEN (${b}=4) THEN 'from' ELSE 'to' END`,e.associations.getFieldsIndex()));break}case"connected":{let r=`${i}='@T'`,o=`${a}='@T'`;null!==t&&(r+=` AND ${s}=@A`,o+=` AND ${l}=@A`),x="(("+r+") OR ("+o+"))",x=m(x,"@T",n),r=m(r,"@T",n),null!==t&&(r=m(r,"@A",t.toString()),x=m(x,"@A",t.toString())),h.codefield=H.create("CASE WHEN "+r+` THEN ${f} ELSE ${E} END`,e.associations.getFieldsIndex());const p=d(P.findField(e.associations.fields,a));p.name=g,p.alias=g,N=new O(p,H.create("CASE WHEN "+r+` THEN ${a} ELSE ${i} END`,e.associations.getFieldsIndex()));break}case"container":x=`${i}='${n}' AND ${b} = 2`,null!==t&&(x+=` AND ${s} = `+t.toString()),h.codefield=f,x="( "+x+" )",N=new F(P.findField(e.associations.fields,a),g,g);case"content":x=`(${a}='${n}' AND ${b} = 2)`,null!==t&&(x+=` AND ${l} = `+t.toString()),h.codefield=E,x="( "+x+" )",N=new F(P.findField(e.associations.fields,i),g,g);break;case"structure":x=`(${i}='${n}' AND ${b} = 3)`,null!==t&&(x+=` AND ${s} = `+t.toString()),h.codefield=f,x="( "+x+" )",N=new F(P.findField(e.associations.fields,a),g,D);break;case"attached":x=`(${a}='${n}' AND ${b} = 3)`,null!==t&&(x+=` AND ${l} = `+t.toString()),h.codefield=E,x="( "+x+" )",N=new F(P.findField(e.associations.fields,i),g,D);break;default:throw new Error("Invalid Parameter")}return r&&(x="1 <> 1"),new P({parentfeatureset:e.associations,adaptedFields:[new M(P.findField(e.associations.fields,y)),new M(P.findField(e.associations.fields,w)),N,$,h,I],extraFilter:x?H.create(x,e.associations.getFieldsIndex()):null})}))}))},q.signatures.push({name:"featuresetbyassociation",min:"2",max:"6"}),q.functions.groupby=function(t,o){return q.standardFunctionAsync(t,o,((o,i,s)=>(e(s,3,3),f(s[0])?s[0].load().then((e=>{const o=[],i=[];let f=!1,p=[];if(l(s[1]))p.push(s[1]);else if(s[1]instanceof r)p.push(s[1]);else if(a(s[1]))p=s[1];else{if(!u(s[1]))return q.failDefferred("Illegal Value: GroupBy");p=s[1].toArray()}for(const t of p)if(l(t)){const r=H.create(n(t),e.getFieldsIndex()),i=!0===G(r)?n(t):"%%%%FIELDNAME";o.push({name:i,expression:r}),"%%%%FIELDNAME"===i&&(f=!0)}else{if(!(t instanceof r))return q.failDefferred("Illegal Value: GroupBy");{const n=t.hasField("name")?t.field("name"):"%%%%FIELDNAME",r=t.hasField("expression")?t.field("expression"):"";if("%%%%FIELDNAME"===n&&(f=!0),!n)return q.failDefferred("Illegal Value: GroupBy");o.push({name:n,expression:H.create(r||n,e.getFieldsIndex())})}}if(p=[],l(s[2]))p.push(s[2]);else if(a(s[2]))p=s[2];else if(u(s[2]))p=s[2].toArray();else{if(!(s[2]instanceof r))return q.failDefferred("Illegal Value: GroupBy");p.push(s[2])}for(const n of p){if(!(n instanceof r))return q.failDefferred("Illegal Value: GroupBy");{const t=n.hasField("name")?n.field("name"):"",r=n.hasField("statistic")?n.field("statistic"):"",o=n.hasField("expression")?n.field("expression"):"";if(!t||!r||!o)return q.failDefferred("Illegal Value: GroupBy");i.push({name:t,statistic:r.toLowerCase(),expression:H.create(o,e.getFieldsIndex())})}}if(f){const n={};for(const t of e.fields)n[t.name.toLowerCase()]=1;for(const e of o)"%%%%FIELDNAME"!==e.name&&(n[e.name.toLowerCase()]=1);for(const e of i)"%%%%FIELDNAME"!==e.name&&(n[e.name.toLowerCase()]=1);let t=0;for(const e of o)if("%%%%FIELDNAME"===e.name){for(;1===n["field_"+t.toString()];)t++;n["field_"+t.toString()]=1,e.name="FIELD_"+t.toString()}}const c=[];for(const e of o)c.push(k(e.expression,q,t));for(const e of i)c.push(k(e.expression,q,t));return c.length>0?B(c).then((()=>C(s[0].groupby(o,i)))):C(s[0].groupby(o,i))})):q.failDefferred("Illegal Value: GroupBy"))))},q.signatures.push({name:"groupby",min:"3",max:"3"}),q.functions.distinct=function(t,o){return q.standardFunctionAsync(t,o,((o,i,s)=>f(s[0])?(e(s,2,2),s[0].load().then((e=>{const o=[];let i=[];if(l(s[1]))i.push(s[1]);else if(s[1]instanceof r)i.push(s[1]);else if(a(s[1]))i=s[1];else{if(!u(s[1]))return q.failDefferred("Illegal Value: GroupBy");i=s[1].toArray()}let f=!1;for(const t of i)if(l(t)){const r=H.create(n(t),e.getFieldsIndex()),i=!0===G(r)?n(t):"%%%%FIELDNAME";o.push({name:i,expression:r}),"%%%%FIELDNAME"===i&&(f=!0)}else{if(!(t instanceof r))return q.failDefferred("Illegal Value: GroupBy");{const n=t.hasField("name")?t.field("name"):"%%%%FIELDNAME",r=t.hasField("expression")?t.field("expression"):"";if("%%%%FIELDNAME"===n&&(f=!0),!n)return q.failDefferred("Illegal Value: GroupBy");o.push({name:n,expression:H.create(r||n,e.getFieldsIndex())})}}if(f){const n={};for(const t of e.fields)n[t.name.toLowerCase()]=1;for(const e of o)"%%%%FIELDNAME"!==e.name&&(n[e.name.toLowerCase()]=1);let t=0;for(const e of o)if("%%%%FIELDNAME"===e.name){for(;1===n["field_"+t.toString()];)t++;n["field_"+t.toString()]=1,e.name="FIELD_"+t.toString()}}const p=[];for(const e of o)p.push(k(e.expression,q,t));return p.length>0?B(p).then((()=>C(s[0].groupby(o,[])))):C(s[0].groupby(o,[]))}))):function(e,n,t,r){if(1===r.length){if(a(r[0]))return j(e,r[0],-1);if(u(r[0]))return j(e,r[0].toArray(),-1)}return j(e,r,-1)}("distinct",0,0,s)))})}export{q as registerFunctions}