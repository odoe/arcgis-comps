import{e,d as t,i as n,W as r,p as i,P as a,O as s,aA as o,b7 as l,r as u,a_ as c,a3 as p,b8 as d,a5 as f,b5 as y,m}from"./p-9ae46e68.js";import{k as b,M as h,aK as g,v,_ as P,bi as w}from"./p-566b0715.js";import{getSize as G,getColor as S,getOpacity as M,getRotationAngle as j,getSizeRangeAtScale as L}from"./p-77e6a663.js";import{v as x}from"./p-8031c809.js";import{y as D}from"./p-8e03c038.js";import{a as F}from"./p-fe01b82b.js";import{n as T,e as V}from"./p-41655335.js";import R from"./p-98a14d68.js";import{a as k}from"./p-ec378dda.js";import{o as A}from"./p-03d6250d.js";import{l as I}from"./p-a7080451.js";import"./p-84bf99cb.js";import"./p-c5b7f7c3.js";import"./p-dfc6337f.js";import"./p-32462343.js";let $=class extends i{constructor(){super(...arguments),this.outSpatialReference=null,this.processExtent=null,this.processSpatialReference=null,this.returnFeatureCollection=!1,this.returnM=!1,this.returnZ=!1}};e([t({type:b})],$.prototype,"outSpatialReference",void 0),e([t({type:h})],$.prototype,"processExtent",void 0),e([t({type:b})],$.prototype,"processSpatialReference",void 0),e([t({nonNullable:!0})],$.prototype,"returnFeatureCollection",void 0),e([t({nonNullable:!0})],$.prototype,"returnM",void 0),e([t({nonNullable:!0})],$.prototype,"returnZ",void 0),$=e([n("esri/rest/geoprocessor/GPOptions")],$),$.from=r($);const O=$;let J=class extends F{constructor(){super(...arguments),this.extent=null,this.height=null,this.href=null,this.opacity=1,this.rotation=0,this.scale=null,this.visible=!0,this.width=null}};e([t({type:h})],J.prototype,"extent",void 0),e([t()],J.prototype,"height",void 0),e([t()],J.prototype,"href",void 0),e([t()],J.prototype,"opacity",void 0),e([t()],J.prototype,"rotation",void 0),e([t()],J.prototype,"scale",void 0),e([t()],J.prototype,"visible",void 0),e([t()],J.prototype,"width",void 0),J=e([n("esri.layer.support.MapImage")],J);const N=J;let C=class extends F{constructor(e){super(e),this.itemId=null,this.url=null}};e([t({type:String,json:{read:{source:"itemID"},write:{target:"itemID"}}})],C.prototype,"itemId",void 0),e([t({type:String,json:{write:!0}})],C.prototype,"url",void 0),C=e([n("esri.rest.support.DataFile")],C);const E=C,U=new a({esriMeters:"meters",esriFeet:"feet",esriKilometers:"kilometers",esriMiles:"miles",esriNauticalMiles:"nautical-miles",esriYards:"yards"},{ignoreUnknown:!1});let _=class extends F{constructor(e){super(e),this.distance=0,this.units=null}};e([t({json:{write:!0}})],_.prototype,"distance",void 0),e([t({json:{read:U.read,write:U.write}})],_.prototype,"units",void 0),_=e([n("esri/rest/support/LinearUnit")],_);const B=_,q=new a({GPBoolean:"boolean",GPDataFile:"data-file",GPDate:"date",GPDouble:"double",GPFeatureRecordSetLayer:"feature-record-set-layer",GPField:"field",GPLinearUnit:"linear-unit",GPLong:"long",GPRasterData:"raster-data",GPRasterDataLayer:"raster-data-layer",GPRecordSet:"record-set",GPString:"string","GPMultiValue:GPBoolean":"multi-value","GPMultiValue:GPDataFile":"multi-value","GPMultiValue:GPDate":"multi-value","GPMultiValue:GPDouble":"multi-value","GPMultiValue:GPFeatureRecordSetLayer":"multi-value","GPMultiValue:GPField":"multi-value","GPMultiValue:GPLinearUnit":"multi-value","GPMultiValue:GPLong":"multi-value","GPMultiValue:GPRasterData":"multi-value","GPMultiValue:GPRasterDataLayer":"multi-value","GPMultiValue:GPRecordSet":"multi-value","GPMultiValue:GPString":"multi-value"});let K=class extends F{constructor(e){super(e),this.dataType=null,this.value=null}};e([t({json:{read:q.read,write:q.write}})],K.prototype,"dataType",void 0),e([t()],K.prototype,"value",void 0),K=e([n("esri.rest.support.ParameterValue")],K);const Z=K;let z=class extends F{constructor(e){super(e),this.format=null,this.itemId=null,this.url=null}};e([t()],z.prototype,"format",void 0),e([t({json:{read:{source:"itemID"},write:{target:"itemID"}}})],z.prototype,"itemId",void 0),e([t()],z.prototype,"url",void 0),z=e([n("esri/rest/support/RasterData")],z);const W=z;async function Y(e,t,n,r,i){const a={},o={},l=[];return function(e,t,n){for(const r in e){const i=e[r];if(i&&"object"==typeof i&&i instanceof R){const{features:e}=i;n[r]=[t.length,t.length+e.length],e.forEach((e=>{t.push(e.geometry)}))}}}(r,l,a),x(l).then((l=>{const{outSpatialReference:u,processExtent:c,processSpatialReference:p,returnFeatureCollection:d,returnM:f,returnZ:y}=n,{path:m}=V(e);for(const e in a){const t=a[e];o[e]=l.slice(t[0],t[1])}const b=u?u.wkid||u:null,h=p?p.wkid||p:null,g="execute"===t?{returnFeatureCollection:d||void 0,returnM:f||void 0,returnZ:y||void 0}:null,v=Q({...c?{context:{extent:c,outSR:b,processSR:h}}:{"env:outSR":b,"env:processSR":h},...r,...g,f:"json"},null,o),P={...i,query:v};return s(`${m}/${t}`,P)}))}function H(e){const t=e.dataType,n=Z.fromJSON(e);switch(t){case"GPBoolean":case"GPDouble":case"GPLong":case"GPString":case"GPMultiValue:GPBoolean":case"GPMultiValue:GPDouble":case"GPMultiValue:GPLong":case"GPMultiValue:GPString":return n;case"GPDate":n.value=new Date(n.value);break;case"GPDataFile":n.value=E.fromJSON(n.value);break;case"GPLinearUnit":n.value=B.fromJSON(n.value);break;case"GPFeatureRecordSetLayer":case"GPRecordSet":n.value=e.value.url?E.fromJSON(n.value):R.fromJSON(n.value);break;case"GPRasterData":case"GPRasterDataLayer":{const t=e.value.mapImage;n.value=t?N.fromJSON(t):W.fromJSON(n.value);break}case"GPField":n.value=D.fromJSON(n.value);break;case"GPMultiValue:GPDate":n.value=n.value.map((e=>new Date(e)));break;case"GPMultiValue:GPDataFile":n.value=n.value.map((e=>E.fromJSON(e)));break;case"GPMultiValue:GPLinearUnit":n.value=n.value.map((e=>B.fromJSON(e)));break;case"GPMultiValue:GPFeatureRecordSetLayer":case"GPMultiValue:GPRecordSet":n.value=n.value.map((e=>R.fromJSON(e)));break;case"GPMultiValue:GPRasterData":case"GPMultiValue:GPRasterDataLayer":n.value=n.value.map((e=>e?N.fromJSON(e):W.fromJSON(n.value)));break;case"GPMultiValue:GPField":n.value=n.value.map((e=>D.fromJSON(e)))}return n}function Q(e,t,n){for(const t in e){const n=e[t];Array.isArray(n)?e[t]=JSON.stringify(n.map((e=>Q({item:e},!0).item))):n instanceof Date&&(e[t]=n.getTime())}return T(e,t,n)}var X;const ee=new a({esriJobCancelled:"job-cancelled",esriJobCancelling:"job-cancelling",esriJobDeleted:"job-deleted",esriJobDeleting:"job-deleting",esriJobTimedOut:"job-timed-out",esriJobExecuting:"job-executing",esriJobFailed:"job-failed",esriJobNew:"job-new",esriJobSubmitted:"job-submitted",esriJobSucceeded:"job-succeeded",esriJobWaiting:"job-waiting"});let te=X=class extends F{constructor(e){super(e),this.jobId=null,this.jobStatus=null,this.messages=null,this.requestOptions=null,this.sourceUrl=null,this._timer=null}cancelJob(e){const{jobId:t,sourceUrl:n}=this,{path:r}=V(n),i={...this.requestOptions,...e,query:{f:"json"}};return this._clearTimer(),s(`${r}/jobs/${t}/cancel`,i).then((e=>{const t=X.fromJSON(e.data);return this.messages=t.messages,this.jobStatus=t.jobStatus,this}))}destroy(){clearInterval(this._timer)}checkJobStatus(e){const{path:t}=V(this.sourceUrl),n={...this.requestOptions,...e,query:{f:"json"}};return s(`${t}/jobs/${this.jobId}`,n).then((({data:e})=>{const t=X.fromJSON(e);return this.messages=t.messages,this.jobStatus=t.jobStatus,this}))}fetchResultData(e,t,n){t=O.from(t||{});const{returnFeatureCollection:r,returnM:i,returnZ:a,outSpatialReference:o}=t,{path:l}=V(this.sourceUrl),u=Q({returnFeatureCollection:r,returnM:i,returnZ:a,outSR:o,returnType:"data",f:"json"},null),c={...this.requestOptions,...n,query:u};return s(`${l}/jobs/${this.jobId}/results/${e}`,c).then((e=>H(e.data)))}fetchResultImage(e,t,n){const{path:r}=V(this.sourceUrl),i=Q({...t.toJSON(),f:"json"}),a={...this.requestOptions,...n,query:i};return s(`${r}/jobs/${this.jobId}/results/${e}`,a).then((e=>H(e.data)))}async fetchResultMapImageLayer(){const{path:e}=V(this.sourceUrl),t=e.indexOf("/GPServer/"),n=`${e.substring(0,t)}/MapServer/jobs/${this.jobId}`;return new((await import("./p-8cd20493.js")).default)({url:n})}async waitForJobCompletion(e={}){const{interval:t=1e3,signal:n,statusCallback:r}=e;return new Promise(((e,i)=>{o(n,(()=>{this._clearTimer(),i(l())})),this._clearTimer();const a=setInterval((()=>{this._timer||i(l()),this.checkJobStatus(this.requestOptions).then((t=>{const{jobStatus:n}=t;switch(this.jobStatus=n,n){case"job-succeeded":this._clearTimer(),e(this);break;case"job-submitted":case"job-executing":case"job-waiting":case"job-new":r&&r(this);break;case"job-cancelled":case"job-cancelling":case"job-deleted":case"job-deleting":case"job-timed-out":case"job-failed":this._clearTimer(),i(this)}}))}),t);this._timer=a}))}_clearTimer(){this._timer&&(clearInterval(this._timer),this._timer=null)}};e([t()],te.prototype,"jobId",void 0),e([t({json:{read:ee.read}})],te.prototype,"jobStatus",void 0),e([t({type:[k]})],te.prototype,"messages",void 0),e([t()],te.prototype,"requestOptions",void 0),e([t({json:{write:!0}})],te.prototype,"sourceUrl",void 0),te=X=e([n("esri.rest.support.JobInfo")],te);const ne=te,re=new a({PDF:"pdf",PNG32:"png32",PNG8:"png8",JPG:"jpg",GIF:"gif",EPS:"eps",SVG:"svg",SVGZ:"svgz"});re.fromJSON.bind(re);const ie=re.toJSON.bind(re),ae=new a({MAP_ONLY:"map-only","A3 Landscape":"a3-landscape","A3 Portrait":"a3-portrait","A4 Landscape":"a4-landscape","A4 Portrait":"a4-portrait","Letter ANSI A Landscape":"letter-ansi-a-landscape","Letter ANSI A Portrait":"letter-ansi-a-portrait","Tabloid ANSI B Landscape":"tabloid-ansi-b-landscape","Tabloid ANSI B Portrait":"tabloid-ansi-b-portrait"});ae.fromJSON.bind(ae);const se=ae.toJSON.bind(ae),oe="simple-marker",le="simple-line";function ue(e,t){const{graphic:n,renderer:r,symbol:i}=t,a=i.type;if("text"===a||"shield-label-symbol"===a||!("visualVariables"in r)||!r.visualVariables)return;const s=r.getVisualVariablesForType("size"),o=r.getVisualVariablesForType("color"),l=r.getVisualVariablesForType("opacity"),u=r.getVisualVariablesForType("rotation"),c=s[0],p=o[0],d=l[0],f=u[0];if(c){const t=G(c,n,{shape:a===oe?i.style:null});null!=t&&(a===oe?e.size=g(t):"picture-marker"===a?(e.width=g(t),e.height=g(t)):a===le?e.width=g(t):e.outline&&(e.outline.width=g(t)))}if(p){const t=S(p,n);(t&&a===oe||a===le||"simple-fill"===a)&&(e.color=t?t.toJSON():void 0)}if(d){const t=M(d,n);null!=t&&e.color&&(e.color[3]=Math.round(255*t))}f&&(e.angle=-j(r,n))}function ce(e){return e&&"bing-maps"===e.type}function pe(e){return e&&"csv"===e.type}function de(e){return e&&"feature"===e.type}function fe(e){return e&&"geojson"===e.type}function ye(e){return e&&"graphics"===e.type}function me(e){return e&&"group"===e.type}function be(e){return e&&"esri.views.2d.layers.GroupLayerView2D"===e.declaredClass}function he(e){return e&&"imagery"===e.type}function ge(e){return e&&"imagery-tile"===e.type}function ve(e){return e&&"kml"===e.type}function Pe(e){return e&&"map-image"===e.type}function we(e){return e&&"map-notes"===e.type}function Ge(e){return e&&"open-street-map"===e.type}function Se(e){return e&&"stream"===e.type}function Me(e){return e&&"tile"===e.type}function je(e){return e&&"vector-tile"===e.type}function Le(e){return e&&"web-tile"===e.type}function xe(e){return e&&"wms"===e.type}function De(e){return e&&"wmts"===e.type}let Fe=class extends i{constructor(e){super(e),this.attributionVisible=!0,this.exportOptions={width:800,height:1100,dpi:96},this.forceFeatureAttributes=!1,this.format="png32",this.label=null,this.layout="map-only",this.layoutOptions=null,this.outScale=0,this.scalePreserved=!0,this.showLabels=!0}};e([t()],Fe.prototype,"attributionVisible",void 0),e([t()],Fe.prototype,"exportOptions",void 0),e([t()],Fe.prototype,"forceFeatureAttributes",void 0),e([t()],Fe.prototype,"format",void 0),e([t()],Fe.prototype,"label",void 0),e([t()],Fe.prototype,"layout",void 0),e([t()],Fe.prototype,"layoutOptions",void 0),e([t()],Fe.prototype,"outScale",void 0),e([t()],Fe.prototype,"scalePreserved",void 0),e([t()],Fe.prototype,"showLabels",void 0),Fe=e([n("esri.rest.support.PrintTemplate")],Fe);const Te=Fe,Ve={Feet:"ft",Kilometers:"km",Meters:"m",Miles:"mi"},Re=new a({esriFeet:"Feet",esriKilometers:"Kilometers",esriMeters:"Meters",esriMiles:"Miles"}),ke=new a({esriExecutionTypeSynchronous:"sync",esriExecutionTypeAsynchronous:"async"}),Ae=new Map;async function Ie(e,t){t=t||{is11xService:!1,legendLayerNameMap:{},legendLayers:[]};const n=e.template||new Te;null==n.showLabels&&(n.showLabels=!0);const r=n.exportOptions;let i;const a=se(n.layout);r&&(i={dpi:r.dpi},"map_only"===a.toLowerCase()||""===a)&&(i.outputSize=[r.width,r.height]);const s=n.layoutOptions;let o;if(s){let e,t;"Miles"===s.scalebarUnit||"Kilometers"===s.scalebarUnit?(e="Kilometers",t="Miles"):"Meters"!==s.scalebarUnit&&"Feet"!==s.scalebarUnit||(e="Meters",t="Feet"),o={titleText:s.titleText,authorText:s.authorText,copyrightText:s.copyrightText,customTextElements:s.customTextElements,scaleBarOptions:{metricUnit:Re.toJSON(e),metricLabel:Ve[e],nonMetricUnit:Re.toJSON(t),nonMetricLabel:Ve[t]}}}let l=null;null!=s&&s.legendLayers&&(l=s.legendLayers.map((e=>{t.legendLayerNameMap[e.layerId]=e.title;const n={id:e.layerId};return e.subLayerIds&&(n.subLayerIds=e.subLayerIds),n})));const c=await async function(e,t,n){const r=e.view;let i=r.spatialReference;const a={operationalLayers:await Oe(r,t,n)};let s=n.ssExtent||e.extent||r.extent;if(i&&i.isWrappable&&(s=s.clone()._normalize(!0),i=s.spatialReference),a.mapOptions={extent:s&&s.toJSON(),spatialReference:i&&i.toJSON(),showAttribution:t.attributionVisible},n.ssExtent=null,r.background&&(a.background=r.background.toJSON()),r.rotation&&(a.mapOptions.rotation=-r.rotation),t.scalePreserved&&(a.mapOptions.scale=t.outScale||r.scale),r.timeExtent){const e=u(r.timeExtent.start)?r.timeExtent.start.getTime():null,t=u(r.timeExtent.end)?r.timeExtent.end.getTime():null;a.mapOptions.time=[e,t]}return a}(e,n,t);if(c.operationalLayers){const e=new RegExp("[\\u4E00-\\u9FFF\\u0E00-\\u0E7F\\u0900-\\u097F\\u3040-\\u309F\\u30A0-\\u30FF\\u31F0-\\u31FF]"),n=/[\u0600-\u06FF]/,r=t=>{const r=t.text,i=t.font,a=i&&i.family&&i.family.toLowerCase();r&&i&&("arial"===a||"arial unicode ms"===a)&&(i.family=e.test(r)?"Arial Unicode MS":"Arial","normal"!==i.style&&n.test(r)&&(i.family="Arial Unicode MS"))},i=()=>{throw new m("print-task:cim-symbol-unsupported","CIMSymbol is not supported by a print service published from ArcMap")};c.operationalLayers.forEach((e=>{var n,a,s;null!=(n=e.featureCollection)&&n.layers?e.featureCollection.layers.forEach((e=>{var n,a,s,o;if(null!=(n=e.layerDefinition)&&null!=(a=n.drawingInfo)&&null!=(s=a.renderer)&&s.symbol){const n=e.layerDefinition.drawingInfo.renderer;"esriTS"===n.symbol.type?r(n.symbol):"CIMSymbolReference"!==n.symbol.type||t.is11xService||i()}null!=(o=e.featureSet)&&o.features&&e.featureSet.features.forEach((e=>{e.symbol&&("esriTS"===e.symbol.type?r(e.symbol):"CIMSymbolReference"!==e.symbol.type||t.is11xService||i())}))})):!t.is11xService&&null!=(a=e.layerDefinition)&&null!=(s=a.drawingInfo)&&s.renderer&&JSON.stringify(e.layerDefinition.drawingInfo.renderer).includes('"type":"CIMSymbolReference"')&&i()}))}e.outSpatialReference&&(c.mapOptions.spatialReference=e.outSpatialReference.toJSON()),Object.assign(c,{exportOptions:i,layoutOptions:o||{}}),Object.assign(c.layoutOptions,{legendOptions:{operationalLayers:null!=l?l:t.legendLayers.slice()}}),t.legendLayers.length=0,Ae.set(t.gpServerUrl,t);const p={Web_Map_as_JSON:JSON.stringify(c),Format:ie(n.format),Layout_Template:a};return e.extraParameters&&Object.assign(p,e.extraParameters),p}function $e(e){let t=e;const n=t.lastIndexOf("/GPServer/");return n>0&&(t=t.slice(0,n+9)),t}async function Oe(e,t,n){const r=[],i={layerView:null,printTemplate:t,view:e};let a=0;t.scalePreserved&&(a=t.outScale||e.scale);const s=function(e,t){const n=e.allLayerViews.items;if(t===e.scale)return n.filter((e=>!e.suspended));const r=new Array;for(const e of n)be(e.parent)&&!r.includes(e.parent)||!e.visible||t&&"isVisibleAtScale"in e&&!e.isVisibleAtScale(t)||r.push(e);return r}(e,a);for(const e of s){const t=e.layer;if(!t.loaded||me(t))continue;let a;i.layerView=e,a=ce(t)?Je(t):pe(t)?await Ne(t,i,n):de(t)?await Ee(t,i,n):fe(t)?await Ue(t,i,n):ye(t)?await _e(t,i,n):he(t)?Be(t,n):ge(t)?qe(t,n):ve(t)?await Ke(t,i,n):Pe(t)?Ze(t,i,n):we(t)?await ze(i,n):Ge(t)?{type:"OpenStreetMap"}:Se(t)?await Ye(t,i,n):Me(t)?He(t):je(t)?await Qe(t,i,n):Le(t)?Xe(t):xe(t)?et(t):De(t)?tt(t):await We(t,i,n),a&&(Array.isArray(a)?r.push(...a):(a.id=t.id,a.title=n.legendLayerNameMap[t.id]||t.title,a.opacity=t.opacity,a.minScale=t.minScale||0,a.maxScale=t.maxScale||0,r.push(a)))}if(a&&r.forEach((e=>{e.minScale=0,e.maxScale=0})),e.graphics&&e.graphics.length){const i=await Ce(null,e.graphics,t,n);i&&r.push(i)}return r}function Je(e){return{culture:e.culture,key:e.key,type:"BingMaps"+("aerial"===e.style?"Aerial":"hybrid"===e.style?"Hybrid":"Road")}}async function Ne(e,t,n){e.legendEnabled&&n.legendLayers.push({id:e.id});const r=t.layerView,i=t.printTemplate;let a;return!n.is11xService||r.filter?Ce(e,await at(r),i,n):(a={type:"CSV"},e.write(a,{origin:"web-map"}),delete a.popupInfo,delete a.layerType,a.showLabels=i.showLabels&&e.labelsVisible,a)}async function Ce(e,t,n,r){let i;const a={layerDefinition:{name:"polygonLayer",geometryType:"esriGeometryPolygon",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryPolygon",features:[]}},s={layerDefinition:{name:"polylineLayer",geometryType:"esriGeometryPolyline",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryPolyline",features:[]}},o={layerDefinition:{name:"pointLayer",geometryType:"esriGeometryPoint",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryPoint",features:[]}},l={layerDefinition:{name:"multipointLayer",geometryType:"esriGeometryMultipoint",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryMultipoint",features:[]}},u={layerDefinition:{name:"pointLayer",geometryType:"esriGeometryPoint",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryPoint",features:[]}};if(u.layerDefinition.name="textLayer",delete u.layerDefinition.drawingInfo,e){if("esri.layers.FeatureLayer"===e.declaredClass||"esri.layers.StreamLayer"===e.declaredClass?a.layerDefinition.name=s.layerDefinition.name=o.layerDefinition.name=l.layerDefinition.name=r.legendLayerNameMap[e.id]||e.get("arcgisProps.title")||e.title:"esri.layers.GraphicsLayer"===e.declaredClass&&(t=e.graphics.items),e.renderer){const t=e.renderer.toJSON();a.layerDefinition.drawingInfo.renderer=t,s.layerDefinition.drawingInfo.renderer=t,o.layerDefinition.drawingInfo.renderer=t,l.layerDefinition.drawingInfo.renderer=t}if(n.showLabels&&e.labelsVisible&&"function"==typeof e.write){var c,p;const t=null==(c=e.write({},{origin:"web-map"}).layerDefinition)||null==(p=c.drawingInfo)?void 0:p.labelingInfo;t&&(i=!0,a.layerDefinition.drawingInfo.labelingInfo=t,s.layerDefinition.drawingInfo.labelingInfo=t,o.layerDefinition.drawingInfo.labelingInfo=t,l.layerDefinition.drawingInfo.labelingInfo=t)}}let d;null!=e&&e.renderer||i||(delete a.layerDefinition.drawingInfo,delete s.layerDefinition.drawingInfo,delete o.layerDefinition.drawingInfo,delete l.layerDefinition.drawingInfo);const f=null==e?void 0:e.fieldsIndex,y=null==e?void 0:e.renderer;if(f){if(y&&"function"==typeof y.collectRequiredFields){const e=new Set;await y.collectRequiredFields(e,f),d=Array.from(e)}const e=f.fields.map((e=>e.toJSON()));a.layerDefinition.fields=e,s.layerDefinition.fields=e,o.layerDefinition.fields=e,l.layerDefinition.fields=e}const m=t&&t.length;let b;for(let i=0;i<m;i++){const c=t[i]||t.getItemAt(i);if(!1===c.visible||!c.geometry)continue;if(b=c.toJSON(),b.hasOwnProperty("popupTemplate")&&delete b.popupTemplate,b.geometry&&b.geometry.z&&delete b.geometry.z,b.symbol&&b.symbol.outline&&"esriCLS"===b.symbol.outline.type&&!r.is11xService)continue;!r.is11xService&&b.symbol&&b.symbol.outline&&b.symbol.outline.color&&b.symbol.outline.color[3]&&(b.symbol.outline.color[3]=255);const p=e&&e.renderer&&("valueExpression"in e.renderer&&e.renderer.valueExpression||"hasVisualVariables"in e.renderer&&e.renderer.hasVisualVariables());if(!b.symbol&&e&&e.renderer&&p&&!r.is11xService){const t=e.renderer,n=await t.getSymbolAsync(c);if(!n)continue;b.symbol=n.toJSON(),"hasVisualVariables"in t&&t.hasVisualVariables()&&ue(b.symbol,{renderer:t,graphic:c,symbol:n})}if(b.symbol&&(b.symbol.angle||delete b.symbol.angle,st(b.symbol)?b.symbol=await rt(b.symbol,r):b.symbol.text&&delete b.attributes),(!n||!n.forceFeatureAttributes)&&d&&d.length){const e={};d.forEach((t=>{b.attributes&&b.attributes.hasOwnProperty(t)&&(e[t]=b.attributes[t])})),b.attributes=e}"polygon"===c.geometry.type?a.featureSet.features.push(b):"polyline"===c.geometry.type?s.featureSet.features.push(b):"point"===c.geometry.type?b.symbol&&b.symbol.text?u.featureSet.features.push(b):o.featureSet.features.push(b):"multipoint"===c.geometry.type?l.featureSet.features.push(b):"extent"===c.geometry.type&&(b.geometry=v.fromExtent(c.geometry).toJSON(),a.featureSet.features.push(b))}const h=[a,s,l,o,u].filter((e=>e.featureSet.features.length>0));for(const e of h){const t=e.featureSet.features.every((e=>e.symbol));!t||n&&n.forceFeatureAttributes||e.featureSet.features.forEach((e=>{delete e.attributes})),t&&delete e.layerDefinition.drawingInfo,e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer&&await it(e.layerDefinition.drawingInfo.renderer,r)}return h.length?{featureCollection:{layers:h},showLabels:i}:null}async function Ee(e,t,n){var r,i;let a;e.legendEnabled&&n.legendLayers.push({id:e.id});const s=e.renderer,o=parseFloat(n.cimVersion);if(e.featureReduction&&(!n.is11xService||o<2.9)||"dot-density"===(null==s?void 0:s.type)&&(!n.is11xService||o<2.6))return We(e,t,n);const l=t.layerView,{printTemplate:u,view:c}=t,p=s&&("valueExpression"in s&&s.valueExpression||"hasVisualVariables"in s&&s.hasVisualVariables()),d="feature-layer"!==(null==(r=e.source)?void 0:r.type)&&"ogc-feature"!==(null==(i=e.source)?void 0:i.type);if(!n.is11xService&&p||l.filter||d||!s||"field"in s&&null!=s.field&&("string"!=typeof s.field||!e.getField(s.field))){const t=await at(l);a=await Ce(e,t,u,n)}else{var f,y;if(a={id:(m=e.write()).id,title:m.title,opacity:m.opacity,minScale:m.minScale,maxScale:m.maxScale,url:m.url,layerType:m.layerType,customParameters:m.customParameters,layerDefinition:m.layerDefinition},a.showLabels=u.showLabels&&e.labelsVisible,nt(a,e),null!=(f=a.layerDefinition)&&null!=(y=f.drawingInfo)&&y.renderer&&(delete a.layerDefinition.minScale,delete a.layerDefinition.maxScale,await it(a.layerDefinition.drawingInfo.renderer,n),"visualVariables"in s&&s.visualVariables&&s.visualVariables[0])){const e=s.visualVariables[0];if("size"===e.type&&e.maxSize&&"number"!=typeof e.maxSize&&e.minSize&&"number"!=typeof e.minSize){const t=L(e,c.scale);a.layerDefinition.drawingInfo.renderer.visualVariables[0].minSize=t.minSize,a.layerDefinition.drawingInfo.renderer.visualVariables[0].maxSize=t.maxSize}}const t=A(l);t&&(a.layerDefinition||(a.layerDefinition={}),a.layerDefinition.definitionExpression=a.layerDefinition.definitionExpression?`(${a.layerDefinition.definitionExpression}) AND (${t})`:t)}var m;return a}async function Ue(e,{layerView:t,printTemplate:n},r){return e.legendEnabled&&r.legendLayers.push({id:e.id}),Ce(e,await at(t),n,r)}async function _e(e,{printTemplate:t},n){return Ce(e,null,t,n)}function Be(e,t){e.legendEnabled&&t.legendLayers.push({id:e.id});const n={layerType:(r=e.write()).layerType,customParameters:r.customParameters};var r;if(n.bandIds=e.bandIds,n.compressionQuality=e.compressionQuality,n.format=e.format,n.interpolation=e.interpolation,(e.mosaicRule||e.definitionExpression)&&(n.mosaicRule=e.exportImageServiceParameters.mosaicRule.toJSON()),e.renderingRule||e.renderer)if(t.is11xService)e.renderingRule&&(n.renderingRule=e.renderingRule.toJSON()),e.renderer&&(n.layerDefinition=n.layerDefinition||{},n.layerDefinition.drawingInfo=n.layerDefinition.drawingInfo||{},n.layerDefinition.drawingInfo.renderer=e.renderer.toJSON());else{const t=e.exportImageServiceParameters.combineRendererWithRenderingRule();t&&(n.renderingRule=t.toJSON())}return nt(n,e),n}function qe(e,t){e.legendEnabled&&t.legendLayers.push({id:e.id});const n={bandIds:(r=e.write()||{}).bandIds,customParameters:r.customParameters,interpolation:r.interpolation,layerDefinition:r.layerDefinition};var r;return n.layerType="ArcGISImageServiceLayer",nt(n,e),n}async function Ke(e,t,n){const r=t.printTemplate;if(n.is11xService){const t={type:"kml"};return e.write(t,{origin:"web-map"}),delete t.layerType,t.url=c(e.url),t}{const i=[],a=t.layerView;a.allVisibleMapImages.forEach(((t,n)=>{const r={id:`${e.id}_image${n}`,type:"image",title:e.id,minScale:e.minScale||0,maxScale:e.maxScale||0,opacity:e.opacity,extent:t.extent};"data:image/png;base64,"===t.href.substr(0,22)?r.imageData=t.href.substr(22):r.url=t.href,i.push(r)}));const s=[...a.allVisiblePoints.items,...a.allVisiblePolylines.items,...a.allVisiblePolygons.items],o={id:e.id,...await Ce(null,s,r,n)};return i.push(o),i}}function Ze(e,{view:t},n){let r;const i={id:e.id,subLayerIds:[]};let a=[];const s=t.scale,o=e=>{if(e.visible&&(0===s||(0===e.minScale||s<=e.minScale)&&(0===e.maxScale||s>=e.maxScale)))if(e.sublayers)e.sublayers.forEach(o);else{const t=e.toExportImageJSON();a.unshift({id:e.id,name:e.title,layerDefinition:{drawingInfo:t.drawingInfo,definitionExpression:t.definitionExpression,source:t.source}}),i.subLayerIds.push(e.id)}};var l;return e.sublayers&&e.sublayers.forEach(o),a.length&&(a=a.map((({id:e,name:t,layerDefinition:n})=>({id:e,name:t,layerDefinition:n}))),r={layerType:(l=e.write()).layerType,customParameters:l.customParameters},r.layers=a,r.visibleLayers=e.capabilities.exportMap.supportsDynamicLayers?void 0:i.subLayerIds,nt(r,e),e.legendEnabled&&n.legendLayers.push(i)),r}async function ze({layerView:e,printTemplate:t},n){const r=[],i=e.layer;if(u(i.featureCollections))for(const e of i.featureCollections){const i=await Ce(e,e.source,t,n);i&&r.push(...i.featureCollection.layers)}else if(u(i.sublayers))for(const e of i.sublayers){const i=await Ce(null,e.graphics,t,n);i&&r.push(...i.featureCollection.layers)}return{featureCollection:{layers:r}}}async function We(e,{printTemplate:t,view:n},r){const i={type:"image"},a={format:"png",ignoreBackground:!0,layers:[e],rotation:0},s=r.ssExtent||n.extent.clone();let o=96,l=!0,u=!0;if(t.exportOptions){const e=t.exportOptions;e.dpi>0&&(o=e.dpi),e.width>0&&(l=e.width%2==n.width%2),e.height>0&&(u=e.height%2==n.height%2)}if("map-only"===t.layout&&t.scalePreserved&&(!t.outScale||t.outScale===n.scale)&&96===o&&(!l||!u)&&(a.area={x:0,y:0,width:n.width,height:n.height},l||(a.area.width-=1),u||(a.area.height-=1),!r.ssExtent)){const e=n.toMap(P(a.area.width,a.area.height));s.ymin=e.y,s.xmax=e.x,r.ssExtent=s}i.extent=s.clone()._normalize(!0).toJSON();const c=await n.takeScreenshot(a),{data:d}=p(c.dataUrl);return i.imageData=d,i}async function Ye(e,{layerView:t,printTemplate:n},r){return e.legendEnabled&&r.legendLayers.push({id:e.id}),Ce(e,await at(t),n,r)}function He(e){const t={layerType:(n=e.write()).layerType,customParameters:n.customParameters};var n;return nt(t,e),t}async function Qe(e,t,n){if(n.is11xService&&e.serviceUrl&&e.styleUrl){const t=d&&d.findCredential(e.styleUrl),r=d&&d.findCredential(e.serviceUrl);if(!t&&!r||"2.1.0"!==n.cimVersion){const n={type:"VectorTileLayer"};return n.styleUrl=c(e.styleUrl),t&&(n.token=t.token),r&&r.token!==n.token&&(n.additionalTokens=[{url:e.serviceUrl,token:r.token}]),n}}return We(e,t,n)}function Xe(e){const t={type:"WebTiledLayer",urlTemplate:e.urlTemplate.replace(/\${/g,"{"),credits:e.copyright};return e.subDomains&&e.subDomains.length>0&&(t.subDomains=e.subDomains),t}function et(e){let t;const n=[],r=e=>{e.visible&&(e.sublayers?e.sublayers.forEach(r):e.name&&n.unshift(e.name))};return e.sublayers&&e.sublayers.forEach(r),n.length&&(t={type:"wms",customLayerParameters:e.customLayerParameters,customParameters:e.customParameters,transparentBackground:e.imageTransparency,visibleLayers:n,url:c(e.url),version:e.version}),t}function tt(e){const t=e.activeLayer;return{type:"wmts",customLayerParameters:e.customLayerParameters,customParameters:e.customParameters,format:t.imageFormat,layer:t.id,style:t.styleId,tileMatrixSet:t.tileMatrixSetId,url:c(e.url)}}function nt(e,t){if(t.url)if(e.url=c(e.url||t.url),"apiKey"in t&&t.apiKey)e.token=t.apiKey;else if(f.apiKey&&y(t.url))e.token=f.apiKey;else{var n,r;e.token=null==(n=d)||null==(r=n.findCredential(t.url))?void 0:r.token}}async function rt(e,t){t.canvas||(t.canvas=document.createElement("canvas"));const n=1024;t.canvas.width=n,t.canvas.height=n;const r=t.canvas.getContext("2d");let i,a;if(e.path){var o;const t=new Path2D(e.path);t.closePath(),r.fillStyle=Array.isArray(e.color)?`rgba(${e.color[0]},${e.color[1]},${e.color[2]},${e.color[3]/255})`:"rgb(0,0,0)",r.fill(t);const s=function(e,t=15){const n=e.canvas.width,r=e.canvas.height,i=e.getImageData(0,0,n,r).data;let a,s,o,l,u,c;e:for(s=r;s--;)for(a=n;a--;)if(i[4*(n*s+a)+3]>t){c=s;break e}if(!c)return null;e:for(a=n;a--;)for(s=c+1;s--;)if(i[4*(n*s+a)+3]>t){u=a;break e}e:for(a=0;a<=u;++a)for(s=c+1;s--;)if(i[4*(n*s+a)+3]>t){o=a;break e}e:for(s=0;s<=c;++s)for(a=o;a<=u;++a)if(i[4*(n*s+a)+3]>t){l=s;break e}return{x:o,y:l,width:u-o,height:c-l}}(r);if(!s)return null;r.clearRect(0,0,n,n);const l=w(e.size)/Math.max(s.width,s.height);r.scale(l,l);const u=n/l;if(r.translate(u/2-s.width/2-s.x,u/2-s.height/2-s.y),Array.isArray(e.color)&&r.fill(t),null!=(o=e.outline)&&o.width&&Array.isArray(e.outline.color)){const n=e.outline;r.lineWidth=w(n.width)/l,r.lineJoin="round",r.strokeStyle=`rgba(${n.color[0]},${n.color[1]},${n.color[2]},${n.color[3]/255})`,r.stroke(t),s.width+=r.lineWidth,s.height+=r.lineWidth}s.width*=l,s.height*=l;const c=r.getImageData(512-s.width/2,512-s.height/2,Math.ceil(s.width),Math.ceil(s.height));i=c.width,a=c.height,r.canvas.width=i,r.canvas.height=a,r.putImageData(c,0,0)}else{const t="image/svg+xml"===e.contentType?"data:image/svg+xml;base64,"+e.imageData:e.url,n=(await s(t,{responseType:"image"})).data;i=w(e.width),a=w(e.height),r.canvas.width=i,r.canvas.height=a,r.drawImage(n,0,0,r.canvas.width,r.canvas.height)}return{type:"esriPMS",imageData:r.canvas.toDataURL("image/png").substr(22),angle:e.angle,contentType:"image/png",height:g(a),width:g(i),xoffset:e.xoffset,yoffset:e.yoffset}}async function it(e,t){const n=e.type;if("simple"===n&&st(e.symbol))e.symbol=await rt(e.symbol,t);else if("uniqueValue"===n||"classBreaks"===n){st(e.defaultSymbol)&&(e.defaultSymbol=await rt(e.defaultSymbol,t));const r=e["uniqueValue"===n?"uniqueValueInfos":"classBreakInfos"];if(r)for(const e of r)st(e.symbol)&&(e.symbol=await rt(e.symbol,t))}}async function at(e){return e.queryFeatures(e.createQuery()).then((e=>e.features))}function st(e){return e&&(e.path||"image/svg+xml"===e.contentType||e.url&&e.url.endsWith(".svg"))}const ot=new a({esriExecutionTypeSynchronous:"sync",esriExecutionTypeAsynchronous:"async"});let lt=class extends I{constructor(...e){super(...e),this._gpMetadata=null,this.updateDelay=1e3}get mode(){return this._gpMetadata&&this._gpMetadata.executionType?ot.fromJSON(this._gpMetadata.executionType):"sync"}execute(e,t){return e&&(e.updateDelay=this.updateDelay),async function(e,t,n){const r=$e(e);let i=Ae.get(r);return Promise.resolve().then((()=>i?{data:i.gpMetadata}:(i={gpServerUrl:r,is11xService:!1,legendLayerNameMap:{},legendLayers:[]},s(r,{query:{f:"json"}})))).then((e=>(i.gpMetadata=e.data,i.cimVersion=i.gpMetadata.cimVersion,i.is11xService=!!i.cimVersion,Ae.set(r,i),Ie(t,i)))).then((r=>{const a=function(e){return e.gpMetadata&&e.gpMetadata.executionType?ke.fromJSON(e.gpMetadata.executionType):"sync"}(i);let s;const o=e=>"sync"===a?e.results&&e.results[0]&&e.results[0].value:s.fetchResultData("Output_File",null,n).then((e=>e.value));return"async"===a?async function(e,t,n,r){return n=O.from(n||{}),Y(e,"submitJob",n,t,r).then((t=>{const n=ne.fromJSON(t.data);return n.sourceUrl=e,n}))}(e,r,null,n).then((e=>(s=e,e.waitForJobCompletion({interval:t.updateDelay}).then(o)))):async function(e,t,n,r){return Y(e,"execute",n=O.from(n||{}),t,r).then((e=>{const t=e.data.messages||[];return{results:(e.data.results||[]).map(H),messages:t.map((e=>k.fromJSON(e)))}}))}(e,r,null,n).then(o)}))}(this.url,e,{...this.requestOptions,...t})}async _getGpPrintParams(e){const t=$e(this.url);return Ie(e,Ae.get(t))}};e([t()],lt.prototype,"_gpMetadata",void 0),e([t({readOnly:!0})],lt.prototype,"mode",null),e([t()],lt.prototype,"updateDelay",void 0),lt=e([n("esri.tasks.PrintTask")],lt);const ut=lt;export default ut;