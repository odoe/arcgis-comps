import{r as t,t as s,bF as i,cG as r,bc as e,a7 as h,c0 as o,e as n,i as p,N as a}from"./p-9ae46e68.js";import{u as c}from"./p-81e5b36e.js";import{s as u}from"./p-fb9c0392.js";import{a as f,n as d,i as m,o as l}from"./p-d6725707.js";import{D as j}from"./p-d925341f.js";import{n as b}from"./p-56ed1c7a.js";import{r as g,E as w,I as y}from"./p-16def889.js";import{i as v,f as A,o as x}from"./p-da4ee59d.js";import{h as M,f as C}from"./p-81abd5fc.js";import"./p-7c7c5507.js";import{s as _}from"./p-58fed22f.js";import{o as U}from"./p-ad183b72.js";import{m as k}from"./p-0509f8e7.js";import{G as T}from"./p-d40c97c9.js";import"./p-84bf99cb.js";import"./p-566b0715.js";import"./p-fe01b82b.js";import"./p-39da60a5.js";import"./p-7a648ea5.js";import"./p-b2a0fae5.js";import"./p-6ebb24ba.js";import"./p-4fd6e394.js";import"./p-4681e856.js";import"./p-a0e42f29.js";import"./p-41655335.js";import"./p-3ffd0931.js";import"./p-8031c809.js";import"./p-3048cc18.js";import"./p-c7a0a732.js";import"./p-b2d0e2de.js";import"./p-db87794e.js";import"./p-22c8d854.js";import"./p-3d1b25b6.js";import"./p-f42060e0.js";import"./p-79553c8d.js";import"./p-8e03c038.js";import"./p-32462343.js";import"./p-98a14d68.js";import"./p-32824614.js";import"./p-40d3b500.js";import"./p-c8f716a9.js";import"./p-57ae469d.js";import"./p-27ef204b.js";import"./p-3a2e88bf.js";import"./p-9e860e7b.js";import"./p-ada83011.js";import"./p-98ce0cca.js";import"./p-4003c7ae.js";import"./p-a7080451.js";import"./p-7e9d2371.js";import"./p-94f8dc11.js";import"./p-bb07d873.js";import"./p-8ac97b63.js";import"./p-a0a931f0.js";import"./p-dfc6337f.js";import"./p-77e6a663.js";import"./p-c5b7f7c3.js";import"./p-30ddb3a0.js";import"./p-74fc1b7f.js";import"./p-b3024dec.js";import"./p-4fcbc3c5.js";import"./p-4b3ae2cf.js";import"./p-6443bfb4.js";import"./p-8e6daf54.js";import"./p-c0757461.js";import"./p-93d9099f.js";import"./p-d3898fd7.js";import"./p-844dad6c.js";import"./p-c59d0a4d.js";import"./p-3a5fe179.js";import"./p-138c2b2c.js";import"./p-ae0b06e3.js";import"./p-a293872e.js";import"./p-f271906a.js";import"./p-cf2267f9.js";import"./p-d2e19070.js";import"./p-e5429b9e.js";import"./p-cf8dc9be.js";import"./p-f17028ec.js";import"./p-5c89c68e.js";import"./p-725fd184.js";import"./p-0c91ebaf.js";import"./p-72355290.js";import"./p-d68829c1.js";import"./p-81102839.js";import"./p-2f7c985e.js";import"./p-00b9ea57.js";import"./p-5a0fe1d0.js";import"./p-7818def0.js";import"./p-da143060.js";import"./p-15bb2887.js";import"./p-1f10277d.js";import"./p-2b250922.js";import"./p-285c6a34.js";import"./p-1d6f3ddb.js";import"./p-789e71c1.js";import"./p-523f37cd.js";import"./p-a198d6d0.js";import"./p-15515b8a.js";import"./p-264c75ac.js";import"./p-c431b12a.js";import"./p-b0f556d6.js";import"./p-8b767e6c.js";import"./p-8d03d70f.js";import"./p-9658240e.js";import"./p-c3efb223.js";import"./p-bae36c84.js";import"./p-d18723b0.js";import"./p-b62a8a4f.js";import"./p-f614dce4.js";import"./p-47e1bd73.js";import"./p-dd4e6b8b.js";import"./p-6ab16fcc.js";import"./p-0c60bcc4.js";import"./p-ffe0d3ad.js";import"./p-9739c166.js";import"./p-128c292d.js";import"./p-2d0c34e5.js";import"./p-b392deaf.js";import"./p-9790d1b4.js";import"./p-6e4caa55.js";import"./p-6c45ae96.js";import"./p-685003b3.js";import"./p-d30fd87a.js";import"./p-e991a11e.js";import"./p-eb19a862.js";import"./p-4414d64f.js";import"./p-a617738c.js";import"./p-9dbf3f05.js";import"./p-97ec6ae5.js";const E=4294967296;class S{constructor(t){this._head=t,this._cursor=t}static from(t){const s=X.from(new Float32Array(t));return new S(s)}get id(){return this._cursor.id}get baseZoom(){return this._cursor.baseZoom}get anchorX(){return this._cursor.anchorX}get anchorY(){return this._cursor.anchorY}get directionX(){return this._cursor.directionX}get directionY(){return this._cursor.directionY}get size(){return this._cursor.size}get materialKey(){return this._cursor.materialKey}get boundsCount(){return this._cursor.boundsCount}computedMinZoom(){return this._cursor.computedMinZoom()}setComputedMinZoom(t){return this._cursor.setComputedMinZoom(t)}boundsComputedAnchorX(t){return this._cursor.boundsComputedAnchorX(t)}boundsComputedAnchorY(t){return this._cursor.boundsComputedAnchorY(t)}setBoundsComputedAnchorX(t,s){return this._cursor.setBoundsComputedAnchorX(t,s)}setBoundsComputedAnchorY(t,s){return this._cursor.setBoundsComputedAnchorY(t,s)}boundsX(t){return this._cursor.boundsX(t)}boundsY(t){return this._cursor.boundsY(t)}boundsWidth(t){return this._cursor.boundsWidth(t)}boundsHeight(t){return this._cursor.boundsHeight(t)}link(s){if(t(s._head))return this._cursor.link(s._head)}getCursor(){return this.copy()}copy(){var t;const s=new S(null==(t=this._head)?void 0:t.copy());if(!s._head)return s;let i=s._head,r=s._head._link;for(;r;)i._link=r.copy(),i=r,r=i._link;return s}peekId(){var t;return null!=(t=this._cursor.peekId())?t:this._cursor._link.peekId()}nextId(){const t=this.id;for(;t===this.id;)if(!this.next())return!1;return!0}save(){this._savedCursor=this._cursor,this._savedOffset=this._cursor._offset}restore(){this._cursor=this._savedCursor,this._cursor._offset=this._savedOffset}next(){if(!this._cursor)return!1;if(!this._cursor.next()){if(!this._cursor._link)return!1;this._cursor=this._cursor._link,this._cursor._offset=0}return!0}lookup(t){for(this._cursor=this._head;this._cursor&&!this._cursor.lookup(t);){if(!this._cursor._link)return!1;this._cursor=this._cursor._link}return!!this._cursor}delete(s){let i=this._head,r=null;for(;i;){if(i.delete(s))return i.isEmpty()&&t(r)&&(r._link=i._link),!0;r=i,i=i._link}return!1}}class X{constructor(t){this._offset=-1,this._link=null,this._count=0,this._deletedCount=0,this._offsets={instance:null},this._buffer=t}static from(t){return new X(new Float32Array(t))}isEmpty(){return this._deletedCount===this.count}get count(){return this._count||(this._count=this._computeCount()),this._count}get id(){return this._buffer[this._offset+0]}set id(t){this._buffer[this._offset+0]=t}get baseZoom(){return this._buffer[this._offset+1]}get anchorX(){return this._buffer[this._offset+2]}get anchorY(){return this._buffer[this._offset+3]}get directionX(){return this._buffer[this._offset+4]}get directionY(){return this._buffer[this._offset+5]}get size(){return this._buffer[this._offset+6]}get materialKey(){return this._buffer[this._offset+7]}computedMinZoom(){return this._buffer[this._offset+8]}setComputedMinZoom(t){this._buffer[this._offset+8]=t}get boundsCount(){return this._buffer[this._offset+9]}boundsComputedAnchorX(t){return this._buffer[this._offset+10+6*t+0]}boundsComputedAnchorY(t){return this._buffer[this._offset+10+6*t+1]}setBoundsComputedAnchorX(t,s){this._buffer[this._offset+10+6*t+0]=s}setBoundsComputedAnchorY(t,s){this._buffer[this._offset+10+6*t+1]=s}boundsX(t){return this._buffer[this._offset+10+6*t+2]}boundsY(t){return this._buffer[this._offset+10+6*t+3]}boundsWidth(t){return this._buffer[this._offset+10+6*t+4]}boundsHeight(t){return this._buffer[this._offset+10+6*t+5]}link(t){let s=this;for(;s._link;)s=s._link;s._link=t}getCursor(){return this.copy()}copy(){const t=new X(this._buffer);return t._link=this._link,t._offset=this._offset,t._deletedCount=this._deletedCount,t._offsets=this._offsets,t._count=this._count,t}peekId(){const t=this._offset+10+6*this.boundsCount+0;return t>=this._buffer.length?0:this._buffer[t]}next(){let t=0;for(;this._offset<this._buffer.length&&t++<100&&(-1===this._offset?this._offset=0:this._offset+=10+6*this.boundsCount,this.id===E););return this.id!==E&&this._offset<this._buffer.length}delete(t){const s=this._offset,i=this.lookup(t);if(i)for(this.id=4294967295,++this._deletedCount;this.next()&&this.id===t;)this.id=4294967295,++this._deletedCount;return this._offset=s,i}lookup(t){const i=this._offset;if(s(this._offsets.instance)){this._offsets.instance=new Map;const t=this.copy();t._offset=-1;let s=0;for(;t.next();)t.id!==s&&(this._offsets.instance.set(t.id,t._offset),s=t.id)}return!!this._offsets.instance.has(t)&&(this._offset=this._offsets.instance.get(t),this.id!==E||(this._offset=i,!1))}_computeCount(){const t=this._offset;let s=0;for(this._offset=-1;this.next();)s++;return this._offset=t,s}}class Y{constructor(t){if(!Array.isArray(t))return void(this.data=t);this.data=t[0];let s=this;for(let i=1;i<t.length;i++)s.next=new Y([t[i]]),s=s.next}*values(){let t=this;for(;t;)yield t.data,t=t.next}forEach(t){let s=this;for(;s;)t(s.data),s=s.next}find(t){var s;return t(this.data)?this:null==(s=this.next)?void 0:s.find(t)}max(t,s=this){const i=t(this.data)>t(s.data)?this:s;return this.next?this.next.max(t,i):i}remove(t,s=null){return this===t?s?(s.next=this.next,s):this.next:this.next.remove(t,this)}get last(){return this.next?this.next.last:this}}class B{constructor(t){this._head=null,s(t)||(this._head=new Y(t))}get head(){return this._head}maxAvailableSpace(){if(s(this._head))return 0;const t=this._head.max((t=>t.end-t.start));return t.data.end-t.data.start}firstFit(t){if(s(this._head))return null;let i=null,r=this._head;for(;r;){const s=r.data.end-r.data.start;if(s===t)return i?i.next=r.next:this._head=r.next,r.data.start;if(s>t){const s=r.data.start;return r.data.start+=t,s}i=r,r=r.next}return null}free(t,i){const r=t+i;if(s(this._head)){const s=new Y({start:t,end:r});return void(this._head=s)}if(r<=this._head.data.start){if(r===this._head.data.start)return void(this._head.data.start-=i);const s=new Y({start:t,end:r});return s.next=this._head,void(this._head=s)}let e=this._head,h=e.next;for(;h;){if(h.data.start>=r){if(e.data.end===t)return void(e.data.end+=i);if(h.data.start===r)return void(h.data.start-=i);const s=new Y({start:t,end:r});return s.next=e.next,void(e.next=s)}e=h,h=h.next}if(t===e.data.end)return void(e.data.end+=i);const o=new Y({start:t,end:r});e.next=o}}class F{constructor(t,s,i,r,e){this.target=t,this.geometryType=s,this.materialKey=i,this.indexFrom=r,this.indexCount=e}get indexEnd(){return this.indexFrom+this.indexCount}extend(t){this.indexCount+=t}draw(t,s,i){this.target.draw(t,s,i,this.indexFrom,this.indexCount)}}class R{constructor(t,s){this.geometryType=0,this._target=t,this.geometryType=s}static from(s,i,r,e){const h=new R(s,i);if(t(e))for(const t of e)r.seekIndex(t),h.addRecord(r);else for(;r.next();)h.addRecord(r);return h}addRecord(t){const i=this._target,r=this.geometryType,e=t.materialKey,h=t.indexFrom,o=t.indexCount;if(s(this._head)){const t=new F(i,r,e,h,o);return void(this._head=new Y(t))}let n=null,p=this._head;for(;p;){if(h<p.data.indexFrom)return this._insert(e,h,o,n,p);n=p,p=p.next}this._insert(e,h,o,n,null)}forEach(s){t(this._head)&&this._head.forEach(s)}*infos(){if(t(this._head))for(const t of this._head.values())yield t}_insert(i,r,e,h,o){if(s(h)&&s(o)){const t=new F(this._target,this.geometryType,i,r,e);this._head=new Y(t)}return s(h)&&t(o)?this._insertAtHead(i,r,e,o):t(h)&&s(o)?this._insertAtEnd(i,r,e,h):t(h)&&t(o)?this._insertAtMiddle(i,r,e,h,o):void 0}_insertAtHead(t,s,i,r){if(t===r.data.materialKey&&s+i===r.data.indexFrom)r.data.indexFrom=s,r.data.indexCount+=i;else{const e=new F(this._target,this.geometryType,t,s,i);this._head=new Y(e),this._head.next=r}}_insertAtEnd(t,s,i,r){if(r.data.materialKey===t&&r.data.indexEnd===s)r.data.indexCount+=i;else{const e=new F(this._target,this.geometryType,t,s,i),h=new Y(e);r.next=h}}_insertAtMiddle(t,s,i,r,e){const h=s+i;if(r.data.materialKey===t&&r.data.indexEnd===s)r.data.indexCount+=i,r.data.materialKey===e.data.materialKey&&r.data.indexEnd===e.data.indexFrom&&(r.data.indexCount+=e.data.indexCount,r.next=e.next);else if(t===e.data.materialKey&&h===e.data.indexFrom)e.data.indexFrom=s,e.data.indexCount+=i;else{const h=new F(this._target,this.geometryType,t,s,i),o=new Y(h);r.next=o,o.next=e}}}class P{constructor(t,s,i){const r=new Uint32Array(s*i);this.strideInt=i,this.bufferType=t,this.dirty={start:1/0,end:0},this.gpu=null,this._cpu=r,this.clear()}get elementSize(){return this._cpu.length/this.strideInt}destroy(){i(this.gpu,(t=>t.dispose()))}clear(){this.dirty.start=1/0,this.dirty.end=0,this.freeList=new B({start:0,end:this._cpu.length/this.strideInt}),this.fillPointer=0}ensure(s){if(this.maxAvailableSpace()>=s)return;const i=s*this.strideInt;if(i>this._cpu.length-this.fillPointer){t(this.gpu)&&(this.gpu=null);const s=Math.round(1.5*(this._cpu.length+i)),r=new Uint32Array(s),e=this._cpu.length/this.strideInt;this.freeList.free(e,s/this.strideInt-e),r.set(this._cpu),this._cpu=r}}set(t,s){this._cpu[t]!==s&&(this._cpu[t]=s,this.dirty.start=Math.min(t,this.dirty.start),this.dirty.end=Math.max(t,this.dirty.end))}getBuffer(){if(!this._cpu2||this._cpu2.length!==this._cpu.length){const t=this._cpu.slice();this._cpu2=t}return this._cpu2.set(this._cpu),this._cpu2}get bufferSize(){return this._cpu.length/this.strideInt}maxAvailableSpace(){return this.freeList.maxAvailableSpace()}insert(t,s,i,e){const h=i*this.strideInt,o=s*this.strideInt*Uint32Array.BYTES_PER_ELEMENT,n=new Uint32Array(t,o,h),p=r(this.freeList.firstFit(i),"First fit region must be defined")*this.strideInt,a=h,c=p/this.strideInt-s;if(0!==e)for(let t=0;t<n.length;t++)n[t]+=e;return this._cpu.set(n,p),this.dirty.start=Math.min(this.dirty.start,p),this.dirty.end=Math.max(this.dirty.end,p+a),this.fillPointer=Math.max(this.fillPointer,p+a),c}free(t,s,i){const r=t*this.strideInt,e=(t+s)*this.strideInt;if(!0===i)for(let i=t;i!==t+s;i++)this._cpu[i*this.strideInt]=2147450879;this.dirty.start=Math.min(this.dirty.start,r),this.dirty.end=Math.max(this.dirty.end,e),this.freeList.free(t,s)}upload(t){if(this.dirty.end){if(s(this.gpu))return this.gpu=this._createBuffer(t),this.dirty.start=1/0,void(this.dirty.end=0);this.gpu.setSubData(this._cpu,this.dirty.start,this.dirty.start,this.dirty.end),this.dirty.start=1/0,this.dirty.end=0}}_createBuffer(t){return"index"===this.bufferType?M.createIndex(t,35048,this._cpu):M.createVertex(t,35048,this._cpu)}}class D{constructor(t,s){this._indicesInvalid=!1,this.geometryType=t}destroy(){this._vao&&(this._vao.dispose(),this._vao=null)}insert(t,s,i){if(!t.records.byteLength)return;const e=t.stride;if(this._vertexBuffer&&this._indexBuffer){const i=t.vertices.byteLength/e;this._indexBuffer.ensure(4*t.indices.byteLength),this._vertexBuffer.ensure(i);const{vertices:h,indices:o}=t,n=v.from(t.records),p=this._vertexBuffer.insert(h,0,h.byteLength/e,0),a=this._indexBuffer.insert(o,0,o.byteLength/4,p);if(n.forEach((t=>{t.indexFrom+=a,t.vertexFrom+=p})),r(this._records,"Expected records to be defined").link(n),s)this._indicesInvalid=!0;else if(this._displayList){const t=n.getCursor();for(;t.next();)this._displayList.addRecord(t)}}else{const i=4*t.indices.byteLength,r=t.vertices.byteLength/e,h=e/Uint32Array.BYTES_PER_ELEMENT;this._records=v.from(t.records),this._indexBuffer=new P("index",i,1),this._vertexBuffer=new P("vertex",r,h),this._indexBuffer.insert(t.indices,0,t.indices.byteLength/4,0),this._vertexBuffer.insert(t.vertices,0,t.vertices.byteLength/e,0),s&&(this._indicesInvalid=!0)}}remove(t){if(!s(this._records))for(const s of t){const t=this._records.getCursor();if(!t.lookup(s))continue;const i=t.indexFrom,r=t.vertexFrom;let e=t.indexCount,h=t.vertexCount;for(;t.next()&&t.id===s;)e+=t.indexCount,h+=t.vertexCount;this._indexBuffer.free(i,e),this._vertexBuffer.free(r,h,!0),this._records.delete(s)}}draw(t,i,r,e,h){if(!this._vertexBuffer||!this._indexBuffer||s(this._records))return;if((s(this._vertexBuffer.gpu)||s(this._indexBuffer.gpu))&&(this._vao&&(this._vao.dispose(),this._vao=null),this._vertexBuffer.gpu=null,this._indexBuffer.gpu=null),this._vertexBuffer.upload(t),this._indexBuffer.upload(t),!this._vao){const s=this._vertexBuffer.gpu,e=this._indexBuffer.gpu;if(!e||!s)return;this._vao=new C(t,r,i,{geometry:s},e)}const o=e*Uint32Array.BYTES_PER_ELEMENT;t.bindVAO(this._vao),t.drawElements(4,h,5125,o)}forEachCommand(t){if(!s(this._records)){if(this._sortIndices(this._records),!this._displayList){const t=this._cursorIndexOrder;this._displayList=R.from(this,this.geometryType,this._records.getCursor(),t)}this._displayList.forEach(t)}}_sortIndices(t){if(!this._indicesInvalid)return;this._indicesInvalid=!1;let s=0;const i=t.getCursor(),r=this._indexBuffer.getBuffer(),e=[],h=[],o=[];for(;i.next();)h.push(i.index),o.push(i.sortKey),e.push(i.id);h.sort(((t,s)=>{const i=o[s],r=o[t];return r===i?e[s]-e[t]:i-r}));const n=t.getCursor();for(const t of h){if(!n.seekIndex(t))throw new Error("Expected to find index");const{indexFrom:i,indexCount:e}=n;n.indexFrom=s;for(let t=0;t<e;t++)this._indexBuffer.set(s++,r[i+t])}this._cursorIndexOrder=h,this._displayList=null}}let Z=0;class z extends A{constructor(t,s,i,r){super(t,s,i),this.instanceId=Z++,this.patchCount=0,this._renderState={current:{geometry:new Map,metrics:null},next:null,swap:!1,swapFrames:0,locked:!1},this._patches=new u(100),this._bufferPatches=new u(100),this._lastCommitTime=0,this._lastMessageWasClear=!1,this.transforms.labelMat2d=f(),this._store=r}destroy(){super.destroy(),this._renderState.current.geometry.forEach((t=>t.destroy()))}get labelMetrics(){return this._renderState.current.metrics}get hasData(){return!!this._renderState.current.geometry.size}getGeometry(t){return this._renderState.current.geometry.get(t)}setTransform(t,s){super.setTransform(t,s);const i=this.transforms.labelMat2d,r=t.getScreenTransform(i,s),e=b();j(e,[this.x,this.y],r),d(i),m(i,i,e),l(i,t.viewMat2d,i)}patch(t,s){if(this.patchCount++,t.clear&&this._lastMessageWasClear)return;this._lastMessageWasClear=t.clear,t.clear&&this._patches.size>=50&&this._dropPatches();const i=t;s&&i.addOrUpdate&&this.key.id!==i.addOrUpdate.tileKeyOrigin?this._bufferPatches.enqueue(i):(i.sort=i.sort&&!s,this._patches.enqueue(i)),this.requestRender()}commit(t){if(this._lastCommitTime!==t.time){this._lastCommitTime=t.time;for(let t=0;t<4;t++)this._updateMesh(),this.isReady&&this._updateBufferMesh();this._renderState.swap&&(this._swapRenderStates(),this.requestRender())}}lock(){this._renderState.locked=!0}unlock(){this._renderState.locked=!1,this._flushUpdates(),this._swap()}_swapRenderStates(){if(this._renderState.next){if(this._renderState.locked)return this._renderState.swap=!0,void this.requestRender();if(this._renderState.swap=!0,0===this._renderState.swapFrames)return this._renderState.swapFrames=8,void this.requestRender();1==this._renderState.swapFrames--?this._swap():this.requestRender()}}_swap(){this._renderState.swap&&(this._renderState.swap=!1,t(this._renderState.next)&&(this._renderState.current.geometry.forEach((t=>t.destroy())),this._renderState.current=this._renderState.next,this._renderState.next=null))}_flushUpdates(){let t=this._patches.maxSize;for(;this._patches.size&&t--;)this._updateMesh(),this._swap()}_updateBufferMesh(){const s=this._bufferPatches.peek();if(!t(s)||!s.clear||null===this._renderState.next)for(;this._bufferPatches.size;){const s=this._bufferPatches.dequeue();t(s)&&this._patchBuffer(s)}}_updateMesh(){const s=this._patches.peek();if(t(s)&&s.clear&&null!==this._renderState.next)return;const i=this._patches.dequeue();if(t(i)){if(!0===i.clear){if(!this.isReady)return;return void(this._renderState.next={geometry:new Map,metrics:null})}this.requestRender(),this._patch(i),i.end&&(this.ready(),this._swapRenderStates())}}_patch(t){g((s=>{this._remove(s,t.remove),this._insert(s,t,!1)}))}_patchBuffer(t){g((s=>{this._insert(s,t,!0)}))}_insert(t,i,r){try{var h;const o=e(this._renderState.next,this._renderState.current),n=null==(h=i.addOrUpdate)?void 0:h.data[t],p=o.geometry;if(s(n))return;p.has(t)||p.set(t,new D(t,this.stage)),p.get(t).insert(n,i.sort,r),t===w.LABEL&&this._insertLabelMetrics(i.type,n.metrics,i.clear)}catch(t){}}_insertLabelMetrics(t,i,r){const h=e(this._renderState.next,this._renderState.current);if(s(i))return;const o=S.from(i);if(s(h.metrics))h.metrics=o;else{if("update"===t){const t=o.getCursor();for(;t.next();)h.metrics.delete(t.id)}h.metrics.link(o)}}_remove(t,s){const i=e(this._renderState.next,this._renderState.current).geometry.get(t);s&&s.length&&i&&(i.remove(s),this._removeLabelMetrics(s))}_removeLabelMetrics(t){const{metrics:i}=e(this._renderState.next,this._renderState.current);if(!s(i)&&t.length)for(const s of t)for(;i.delete(s););}_dropPatches(){const t=new Array;let i=!1;for(;this._patches.size;){const r=this._patches.dequeue();if(s(r))break;if(r.clear){if(i)break;i=!0}t.push(r)}this._patches.clear(),t.forEach((t=>this._patches.enqueue(t)))}}const I=h("featurelayer-order-by-server-enabled");class G extends x{constructor(t,s,i,r){super(t),this._pointToCallbacks=new Map,this._layer=i,this._layerView=s,this._onUpdate=r}renderChildren(t){this.attributeView.update(),this.hasAnimation&&t.painter.effects.integrate.draw(t,t.attributeView),super.renderChildren(t)}isUpdating(){return this.attributeView.isUpdating()}hitTest(t,s){const i=[t,s],r=o();return this._pointToCallbacks.set(i,r),this.requestRender(),r.promise}onTileData(t,s){const i=I&&"orderBy"in this._layer&&this._layer.orderBy;t.patch(s,i&&this._layerView.orderByFields===((null==i?void 0:i.length)&&!i[0].valueExpression&&i[0].field)),this.contains(t)||this.addChild(t),this.requestRender()}onTileError(t){this.contains(t)||this.addChild(t)}doRender(t){const{minScale:s,maxScale:i}=this._layer,r=t.state.scale;r<=(s||1/0)&&r>=i&&super.doRender(t)}onAttributeStoreUpdate(){this.hasLabels&&this._layerView.view.labelManager.requestUpdate(),this._onUpdate()}get hasAnimation(){return this.hasLabels}get hasLabels(){if("sublayers"in this._layer)return this._layer.sublayers.some((t=>t.labelingInfo&&t.labelingInfo.length&&t.labelsVisible));const t=this._layer.featureReduction;return this._layer.labelingInfo&&this._layer.labelingInfo.length&&this._layer.labelsVisible||!!(t&&"cluster"===t.type&&t.labelsVisible&&t.labelingInfo&&t.labelingInfo.length)}prepareRenderPasses(t){const s=t.registerRenderPass({name:"label",brushes:[T.label],target:()=>this.hasLabels?this.children:null,drawPhase:y.LABEL|y.LABEL_ALPHA}),i=t.registerRenderPass({name:"geometry",brushes:[T.fill,T.line,T.marker,T.text],target:()=>this.children,enableDefaultDraw:()=>!this._layerView.hasEffects,effects:[{apply:t.effects.outsideEffect,enable:()=>this._layerView.hasEffects,args:()=>this._layerView.effectLists.excluded},{apply:t.effects.insideEffect,enable:()=>this._layerView.hasEffects,args:()=>this._layerView.effectLists.included},{apply:t.effects.hittest,enable:()=>!!this._pointToCallbacks.size,args:()=>this._pointToCallbacks}]}),r=t.registerRenderPass({name:"highlight",brushes:[T.fill,T.line,T.marker,T.text],target:()=>this.children,drawPhase:y.HIGHLIGHT,enableDefaultDraw:()=>!1,effects:[{apply:t.effects.highlight,enable:()=>!!this._layerView.hasHighlight()}]});return[...super.prepareRenderPasses(t),i,r,s]}}let L=class extends U{install(t){const s=new G(this.tileInfoView,this.layerView,this.layer,(()=>this.notifyChange("updating")));this.featuresView=s,t.addChild(s)}uninstall(t){t.removeChild(this.featuresView),this.featuresView.destroy()}fetchResource(t,s){const{url:i}=t,r=this.featuresView.stage;try{return r.resourceManager.fetchResource(i,{signal:s.signal})}catch(t){return a(t)?Promise.resolve({width:0,height:0}):Promise.reject(t)}}isUpdating(){const t=super.isUpdating(),s=!this.featuresView||this.featuresView.isUpdating(),i=t||s;return h("esri-2d-log-updating")&&console.log(`Updating SymbolTileRenderer ${i}\n  -> updatingTiles ${t}\n  -> updatingFeaturesView ${s}`),i}hitTest(t,s){return this.featuresView.hitTest(t,s)}supportsRenderer(t){return null!=t&&-1!==["simple","class-breaks","unique-value","dot-density","dictionary"].indexOf(t.type)}onConfigUpdate(t){let s=null;if("visualVariables"in t){const i=(_(t).visualVariables||[]).map((t=>{const s=t.clone();return"normalizationField"in t&&(s.normalizationField=null),t.valueExpression&&"$view.scale"!==t.valueExpression&&(s.valueExpression=null,s.field="nop"),s}));s=k(i)}this.featuresView.setRendererInfo(t,s,this.layerView.featureEffect)}onTileData(t){const s=this.tiles.get(t.tileKey);s&&t.data&&this.featuresView.onTileData(s,t.data),this.layerView.view.labelManager.requestUpdate()}onTileError(t){const s=this.tiles.get(t.tileKey);s&&this.featuresView.onTileError(s)}forceAttributeTextureUpload(){this.featuresView.attributeView.forceTextureUpload()}lockGPUUploads(){this.featuresView.attributeView.lockTextureUpload(),this.tiles.forEach((t=>t.lock()))}unlockGPUUploads(){this.featuresView.attributeView.unlockTextureUpload(),this.tiles.forEach((t=>t.unlock()))}async getMaterialItems(t){return this.featuresView.getMaterialItems(t)}invalidateLabels(){this.featuresView.hasLabels&&this.layerView.view.labelManager.requestUpdate()}createTile(t){const s=this.tileInfoView.getTileBounds(c(),t);return new z(t,s[0],s[3],this.featuresView.attributeView)}disposeTile(t){this.featuresView.removeChild(t),t.destroy(),this.layerView.view.labelManager.requestUpdate()}};L=n([p("esri.views.2d.layers.features.tileRenderers.SymbolTileRenderer")],L);const $=L;export default $;