import{s as e,gR as n,g as t,a7 as i,H as a,aS as s,dM as o,ad as r,dr as l,W as c,dF as u,dp as f,ev as p,eP as d,gS as g}from"./p-7b6f6c18.js";import{O as m,T as y,L as w}from"./p-761b5073.js";import{u as h}from"./p-a666c421.js";const b=e.getLogger("esri.layers.graphics.sources.ogcfeature"),j="http://www.opengis.net/def/crs/",I=`${j}OGC/1.3/CRS84`;async function F(e,n,r={},l=5){const{links:c}=e,u=M(c,"items","application/geo+json")||M(c,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(t(u))throw new i("ogc-feature-layer:missing-items-page","Missing items url");const{data:f}=await a(u.href,{signal:r.signal,query:{limit:l,...r.customParameters,token:r.apiKey},headers:{accept:"application/geo+json"}});await m(f);const p=y(f,{geometryType:n.geometryType}),d=n.fields||p.fields||[],g=null!=n.hasZ?n.hasZ:p.hasZ,w=p.geometryType,j=n.objectIdField||p.objectIdFieldName||"OBJECTID";let I=n.timeInfo;const F=d.find((e=>e.name===j));if(F)F.type="esriFieldTypeOID",F.editable=!1,F.nullable=!1;else{if(!p.objectIdFieldType)throw new i("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");d.unshift({name:j,alias:j,type:"esriFieldTypeOID",editable:!1,nullable:!1})}if(j!==p.objectIdFieldName){const e=d.find((e=>e.name===p.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}d===p.fields&&p.unknownFields.length>0&&b.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:p.unknownFields}});for(const e of d){if(null==e.name&&(e.name=e.alias),null==e.alias&&(e.alias=e.name),"esriFieldTypeOID"!==e.type&&"esriFieldTypeGlobalID"!==e.type&&(e.editable=null==e.editable||!!e.editable,e.nullable=null==e.nullable||!!e.nullable),!e.name)throw new i("ogc-feature-layer:invalid-field-name","field name is missing",{field:e});if(-1===s.jsonValues.indexOf(e.type))throw new i("ogc-feature-layer:invalid-field-type",`invalid type for field "${e.name}"`,{field:e})}if(I){const e=new o(d);if(I.startTimeField){const n=e.get(I.startTimeField);n?(I.startTimeField=n.name,n.type="esriFieldTypeDate"):I.startTimeField=null}if(I.endTimeField){const n=e.get(I.endTimeField);n?(I.endTimeField=n.name,n.type="esriFieldTypeDate"):I.endTimeField=null}if(I.trackIdField){const n=e.get(I.trackIdField);n?I.trackIdField=n.name:(I.trackIdField=null,b.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:I}}))}I.startTimeField||I.endTimeField||(b.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:I}}),I=null)}return{drawingInfo:w?h(w):null,geometryType:w,fields:d,hasZ:!!g,objectIdField:j,timeInfo:I}}async function k(e,n={}){const{links:s}=e,o=M(s,"data","application/json")||M(s,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(t(o))throw new i("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:r,customParameters:l,signal:c}=n,{data:u}=await a(o.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:r}});return u}async function v(e,n={}){const{links:s}=e,o=M(s,"conformance","application/json")||M(s,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(t(o))throw new i("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:r,customParameters:l,signal:c}=n,{data:u}=await a(o.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:r}});return u}async function T(e,n={}){const{apiKey:t,customParameters:i,signal:s}=n,{data:o}=await a(e,{signal:s,headers:{accept:"application/json"},query:{...i,token:t}});return o}async function x(e,n={}){const i="application/vnd.oai.openapi+json;version=3.0",s=M(e.links,"service-desc",i);if(t(s))return b.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:o,customParameters:r,signal:l}=n,{data:c}=await a(s.href,{signal:l,headers:{accept:i},query:{...r,token:o}});return c}function q(e){const n=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),t=null==n?void 0:n.groups;if(!t)return null;const{authority:i,code:a}=t;switch(i.toLowerCase()){case"ogc":switch(a.toLowerCase()){case"crs27":return r.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return r.WGS84.wkid;default:return null}case"esri":case"epsg":{const e=Number.parseInt(a,10);return Number.isNaN(e)?null:e}default:return null}}async function $(e,t,i){const a=await P(e,t,i);return n(a)}async function P(e,n,s){const{capabilities:{query:{maxRecordCount:o}},collection:m,layerDefinition:y,queryParameters:{apiKey:h,customParameters:b},spatialReference:j,supportedCrs:I}=e,{links:F}=m,k=M(F,"items","application/geo+json")||M(F,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(t(k))throw new i("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:v,num:T,start:x,timeExtent:q,where:$}=n;if(n.objectIds)throw new i("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const P=r.fromJSON(j),O=l(n.outSpatialReference,P),K=O.isWGS84?null:D(O,I),R=C(v,I),N=function(e){if(t(e))return null;const{start:n,end:i}=e;return`${c(n)?n.toISOString():".."}/${c(i)?i.toISOString():".."}`}(q),S=function(e){return t(e)||!e||"1=1"===e?null:e}($),G=null!=T?T:null!=x&&void 0!==x?10:o,{data:Z}=await a(k.href,{...s,query:{...b,...R,crs:K,datetime:N,query:S,limit:G,startindex:x,token:h},headers:{accept:"application/geo+json"}});let A=!1;Z.links&&(A=!!Z.links.find((e=>"next"===e.rel))),!A&&Number.isInteger(Z.numberMatched)&&Number.isInteger(Z.numberReturned)&&(A=Z.numberReturned<Z.numberMatched);const{fields:E,globalIdField:W,hasM:B,hasZ:H,objectIdField:J}=y,Q=y.geometryType,z=w(Z,{geometryType:Q,hasZ:H,objectIdField:J});if(!K&&O.isWebMercator)for(const e of z)if(c(e.geometry)){const n=u(e.geometry,Q,H,!1);n.spatialReference=r.WGS84,e.geometry=f(p(n,O))}for(const e of z)e.objectId=e.attributes[J];const L=K||!K&&O.isWebMercator?O.toJSON():d,U=new g;return U.exceededTransferLimit=A,U.features=z,U.fields=E,U.geometryType=Q,U.globalIdFieldName=W,U.hasM=B,U.hasZ=H,U.objectIdFieldName=J,U.spatialReference=L,U}function D(e,n){var t,i,a;const{isWebMercator:s,wkid:o}=e;if(!o)return null;const r=s?null!=(t=null!=(i=null!=(a=n[3857])?a:n[102100])?i:n[102113])?t:n[900913]:n[e.wkid];return r?`${j}${r}`:null}function O(e){if(t(e))return"";const{xmin:n,ymin:i,xmax:a,ymax:s}=e;return`${n},${i},${a},${s}`}function C(e,n){if(!function(e){return c(e)&&"extent"===e.type}(e))return null;const{spatialReference:t}=e;if(!t||t.isWGS84)return{bbox:O(e)};const i=D(t,n);return c(i)?{bbox:O(e),"bbox-crs":i}:t.isWebMercator?{bbox:O(p(e,r.WGS84))}:null}function M(e,n,t){return e.find((e=>e.rel===n&&e.type===t))||e.find((e=>e.rel===n&&!e.type))}export{I as F,F as I,$ as N,x as S,k as T,j,v as k,P as q,q as v,T as x}