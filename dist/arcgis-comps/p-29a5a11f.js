import{al as t,r as e,v as s,bJ as i,ba as n,bc as r,t as o,O as h,N as l,aB as a,e as u,d as c,i as d,R as p,E as m,J as y,a9 as f,aa as b}from"./p-9ae46e68.js";import{l as v,b as w}from"./p-8e6daf54.js";import{i as g}from"./p-4fd6e394.js";import{b_ as j,bZ as x,bW as S,bd as V,ad as R,c1 as N,F as P,c8 as q,bY as M,bw as _,c2 as L,bx as T,c0 as I,c6 as C,c5 as D,bX as A,cM as W,bv as B,b$ as k,cN as z,cO as F,cP as O,D as U,z as E,o as G}from"./p-566b0715.js";import{h as $,o as J,f as H,r as Z,n as Q,e as X}from"./p-138c2b2c.js";import{e as Y,n as K,a as tt}from"./p-01158f1c.js";import{r as et,c as st,s as it,v as nt,A as rt,b as ot,n as ht}from"./p-7571af29.js";import{e as lt,h as at,r as ut,i as ct,f as dt,u as pt,P as mt,C as yt,d as ft,l as bt}from"./p-2455867d.js";import{d as vt}from"./p-789e71c1.js";import{i as wt}from"./p-93d9099f.js";import{p as gt}from"./p-d3898fd7.js";import{y as jt}from"./p-cf8dc9be.js";import{w as xt}from"./p-5c89c68e.js";import{s as St}from"./p-72355290.js";import{N as Vt}from"./p-bb0deecf.js";import{p as Rt,c as Nt}from"./p-f271906a.js";import{a as Pt}from"./p-fe01b82b.js";import"./p-84bf99cb.js";import"./p-2794293b.js";import"./p-c3efb223.js";import"./p-d925341f.js";import"./p-844dad6c.js";import"./p-57ae469d.js";import"./p-725fd184.js";import"./p-207b5a2e.js";import"./p-c0757461.js";import"./p-8074619d.js";import"./p-79553c8d.js";import"./p-c5b7f7c3.js";function qt(e){return t(`esri/libs/vxl/${e}`)}function Mt(t=Bt){return[t[0],t[1],t[2],t[3]]}function _t(t,e=Mt()){return Lt(t[0],t[1],t[2],t[3],e)}function Lt(t,e,s,i,n=Mt()){return n[0]=t,n[1]=e,n[2]=s,n[3]=i,n}const Tt=V();function It(t,e,s,i){return j(Tt,e,t),function(t,e,s){const i=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],n=Math.abs(i-1)>1e-5&&i>1e-12?1/Math.sqrt(i):1;return s[0]=e[0]*n,s[1]=e[1]*n,s[2]=e[2]*n,s[3]=-(s[0]*t[0]+s[1]*t[1]+s[2]*t[2]),s}(s,Tt,i)}function Ct(t,e,s){return Wt(t,e.origin,e.vector,0,s)}function Dt(t,e,s){return Wt(t,e.origin,e.vector,1,s)}function At(t,e){return function(t,e){return x(t,e)+t[3]}(t,e)>=0}function Wt(t,e,s,i,n){const r=x(t,s);if(0===r)return!1;let o=-(x(t,e)+t[3])/r;return 1&i&&(o=P(o,0,1)),!(!(4&i)&&o<0||!(8&i)&&o>1||(S(n,e,R(n,s,o)),0))}const Bt=[0,0,1,0],kt=s.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");function zt(t=ne){return{plane:Mt(t.plane),origin:q(t.origin),basis1:q(t.basis1),basis2:q(t.basis2)}}function Ft(t,e=zt()){return Ot(t.origin,t.basis1,t.basis2,e)}function Ot(t,e,s,i=zt()){return M(i.origin,t),M(i.basis1,e),M(i.basis2,s),Ut(i),function(t,e){Math.abs(x(t.basis1,t.basis2)/(T(t.basis1)*T(t.basis2)))>1e-6&&kt.warn(e,"Provided basis vectors are not perpendicular"),Math.abs(x(t.basis1,Kt(t)))>1e-6&&kt.warn(e,"Basis vectors and plane normal are not perpendicular"),Math.abs(-x(Kt(t),t.origin)-t.plane[3])>1e-6&&kt.warn(e,"Plane offset is not consistent with plane origin")}(i,"fromValues()"),i}function Ut(t){It(t.basis2,t.basis1,t.origin,t.plane)}function Et(t,e,s){t!==s&&Ft(t,s);const i=R(st.get(),Kt(t),e);return S(s.origin,s.origin,i),s.plane[3]-=e,s}function Gt(t,e=zt()){const s=(t[2]-t[0])/2,i=(t[3]-t[1])/2;return _(e.origin,t[0]+s,t[1]+i,0),_(e.basis1,s,0,0),_(e.basis2,0,i,0),Lt(0,0,1,0,e.plane),e}function $t(t,s,i){return!!function(t,s,i){return!!e(s)&&Wt(t,s.origin,s.direction,8,i)}(t.plane,s,i)&&te(t,i)}function Jt(t,e,s){const i=re.get();ie(t,e,i,re.get());let n=Number.POSITIVE_INFINITY;for(const r of ae){const o=se(t,r,oe.get()),h=st.get();if(Ct(i,o,h)){const t=I(st.get(),e.origin,h),i=Math.abs(k(x(e.direction,t)));i<n&&(n=i,M(s,h))}}return n===Number.POSITIVE_INFINITY?Ht(t,e,s):s}function Ht(t,e,s){if($t(t,e,s))return s;const i=re.get(),n=re.get();ie(t,e,i,n);let r=Number.POSITIVE_INFINITY;for(const o of ae){const h=se(t,o,oe.get()),l=st.get();if(Dt(i,h,l)){const t=at(e,l);if(!At(n,l))continue;t<r&&(r=t,M(s,l))}}return Xt(t,e.origin)<r&&Zt(t,e.origin,s),s}function Zt(t,e,s){const i=function(t,e,s){const i=R(st.get(),t,-t[3]),n=function(t,e,s){const i=R(st.get(),t,x(t,e));return N(s,e,i),s}(t,N(st.get(),e,i),st.get());return S(s,n,i),s}(t.plane,e,st.get()),n=rt(ee(t,t.basis1),i,-1,1,st.get()),r=rt(ee(t,t.basis2),i,-1,1,st.get());return N(s,S(st.get(),n,r),t.origin),s}function Qt(t,e,s){const{origin:i,basis1:n,basis2:r}=t,o=N(st.get(),e,i),h=lt(n,o),l=lt(r,o),a=lt(Kt(t),o);return _(s,h,l,a)}function Xt(t,e){const s=Qt(t,e,st.get()),{basis1:i,basis2:n}=t,r=T(i),o=T(n),h=Math.max(Math.abs(s[0])-r,0),l=Math.max(Math.abs(s[1])-o,0),a=s[2];return h*h+l*l+a*a}function Yt(t,e){const s=-t.plane[3];return lt(Kt(t),e)-s}function Kt(t){return t.plane}function te(t,e){const s=N(st.get(),e,t.origin),i=W(t.basis1),n=W(t.basis2),r=x(t.basis1,s),o=x(t.basis2,s);return-r-i<0&&r-i<0&&-o-n<0&&o-n<0}function ee(t,e){const s=oe.get();return M(s.origin,t.origin),M(s.vector,e),s}function se(t,e,s){const{basis1:i,basis2:n,origin:r}=t,o=R(st.get(),i,e.origin[0]),h=R(st.get(),n,e.origin[1]);S(s.origin,o,h),S(s.origin,s.origin,r);const l=R(st.get(),i,e.direction[0]),a=R(st.get(),n,e.direction[1]);return R(s.vector,S(l,l,a),2),s}function ie(t,e,s,i){const n=Kt(t);It(n,e.direction,e.origin,s),It(s,n,e.origin,i)}const ne={plane:Mt(),origin:B(0,0,0),basis1:B(1,0,0),basis2:B(0,1,0)},re=new it(Mt),oe=new it(nt),he=V(),le=new it((()=>({origin:null,basis1:null,basis2:null,plane:null}))),ae=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],ue=Y(),ce=Y();Object.freeze({__proto__:null,BoundedPlaneClass:class{constructor(){this.plane=Mt(),this.origin=V(),this.basis1=V(),this.basis2=V()}},create:zt,wrap:function(t,e,s){const i=le.get();return i.origin=t,i.basis1=e,i.basis2=s,i.plane=Lt(0,0,0,0,et.get()),Ut(i),i},copy:Ft,copyWithoutVerify:function(t,e){M(e.origin,t.origin),M(e.basis1,t.basis1),M(e.basis2,t.basis2),_t(t.plane,e.plane)},fromValues:Ot,updateUnboundedPlane:Ut,elevate:Et,setExtent:function(t,e,s){return Gt(e,s),Et(s,Yt(t,t.origin),s),s},fromAABoundingRect:Gt,intersectRay:$t,intersectRayClosestSilhouette:function(t,e,s){if($t(t,e,s))return s;const i=Jt(t,e,st.get());return S(s,e.origin,R(st.get(),e.direction,L(e.origin,i)/T(e.direction))),s},closestPointOnSilhouette:Jt,closestPoint:Ht,projectPoint:Zt,projectPointLocal:Qt,distance2:Xt,distance:function(t,e){return Math.sqrt(Xt(t,e))},distanceToSilhouette:function(t,e){let s=Number.NEGATIVE_INFINITY;for(const i of ae){const n=se(t,i,oe.get()),r=ot(n,e);r>s&&(s=r)}return Math.sqrt(s)},extrusionContainsPoint:function(t,e){return At(t.plane,e)&&te(t,e)},axisAt:function(t,e,s,i){return function(t,e,s){switch(e){case 0:M(s,t.basis1),A(s,s);break;case 1:M(s,t.basis2),A(s,s);break;case 2:M(s,Kt(t))}return s}(t,s,i)},altitudeAt:Yt,setAltitudeAt:function(t,e,s,i){const n=Yt(t,e),r=R(he,Kt(t),s-n);return S(i,e,r),i},equals:function(t,e){return C(t.basis1,e.basis1)&&C(t.basis2,e.basis2)&&C(t.origin,e.origin)},transform:function(t,e,s){return t!==s&&Ft(t,s),$(ue,e),J(ue,ue),D(s.basis1,t.basis1,ue),D(s.basis2,t.basis2,ue),D(s.plane,t.plane,ue),D(s.origin,t.origin,e),function(t,e,s){t!==s&&_t(t,s),s[3]=-x(s,e)}(s.plane,s.origin,s.plane),s},rotate:function(t,e,s,i){return t!==i&&Ft(t,i),H(ce,Z(ce),e,s),D(i.basis1,t.basis1,ce),D(i.basis2,t.basis2,ce),Ut(i),i},normal:Kt,UP:ne});class de{constructor(){this._disposed=!1}get disposed(){return this._disposed}get shaderTransformation(){return this._shaderTransformation}acquire(t,e,s,i,r,o){this.id=n(),this.geometry=t,this.material=e,this.transformation=s,this.instanceParameters=i,this.origin=r,this._shaderTransformation=o,this._disposed=!1}release(){this._disposed=!1}dispose(){this._disposed=!0}getStaticTransformation(){return this.transformation}getShaderTransformation(){return e(this._shaderTransformation)?this._shaderTransformation(this.transformation):this.transformation}computeAttachmentOrigin(t){return!!(this.material.computeAttachmentOrigin?this.material.computeAttachmentOrigin(this.geometry,t):this.geometry.computeAttachmentOrigin(t))&&(D(t,t,this.getStaticTransformation()),!0)}}de.pool=new i(de);class pe{constructor(t){this.channel=t,this.id=n()}}class me extends ut{constructor(t={}){super(),this.type=1,this._geometryRecords=new Array,this._geometries=new Array,this._objectTransformation=Y(),this._bvObjectSpace=new fe,this._bvWorldSpace=new fe,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._visible=!0,this.castShadow=null==t.castShadow||t.castShadow,this.metadata=t.metadata,this.metadata&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new ye),this.transformation=Y();const{geometries:e,materials:s,transformations:i,origins:n}=t;if(Array.isArray(e)){ct(s.length===e.length,"Object3D: materials don't match geometries"),ct(i.length===e.length,"Object3D: transformations don't match geometries"),this._geometryRecords.length=e.length,this._geometries.length=e.length;for(let t=0;t<e.length;t++)this._geometries[t]=e[t],this._geometryRecords[t]=de.pool.acquire(e[t],s[t],K(i[t]),{highlights:null,occludees:null,visible:this._visible},n&&n[t])}}get geometryRecords(){return this._geometryRecords}get geometries(){return this._geometries}get transformation(){return this._objectTransformation}set transformation(t){Q(this._objectTransformation,t),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}dispose(){this._geometryRecords.length=0,this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(t){ct(null==this._parentLayer||null==t,"Object3D can only be added to a single Layer"),this._parentLayer=t}addGeometry(t,s,i,n,r){i=i||tt,this._geometries.push(t);const o=de.pool.acquire(t,s,i,{highlights:null,occludees:null,visible:this._visible},n,r);return this._geometryRecords.push(o),this._hasVolatileTransformation=this._hasVolatileTransformation||e(o.shaderTransformation),this._emit("objectGeometryAdded",{object:this,record:o}),this._invalidateBoundingVolume(),o}removeGeometry(t){const s=this._geometryRecords.splice(t,1)[0];return this._hasVolatileTransformation=e(s.shaderTransformation)?this._geometryRecords.some((t=>e(t.shaderTransformation))):this._hasVolatileTransformation,s.dispose(),this._geometries.splice(t,1),this._emit("objectGeometryRemoved",{object:this,record:s}),this._invalidateBoundingVolume(),s}removeAllGeometries(){for(;this.geometryRecords.length>0;)this.removeGeometry(0)}geometryVertexAttrsUpdated(t){this._emit("vertexAttrsUpdated",{object:this,record:t}),this._invalidateBoundingVolume()}get isVisible(){return this._visible}setVisible(t){if(this._visible!==t){this._visible=t;for(const t of this._geometryRecords)t.instanceParameters.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const t=new pe(1);for(const e of this._geometryRecords)e.instanceParameters.occludees=dt(e.instanceParameters.occludees,t);return this._emit("occlusionChanged",this),t}removeOcclude(t){for(const e of this._geometryRecords)e.instanceParameters.occludees=pt(e.instanceParameters.occludees,t);this._emit("occlusionChanged",this)}highlight(){const t=new pe(0);for(const e of this._geometryRecords)e.instanceParameters.highlights=dt(e.instanceParameters.highlights,t);return this._emit("highlightChanged",this),t}removeHighlight(t){for(const e of this._geometryRecords)e.instanceParameters.highlights=pt(e.instanceParameters.highlights,t);this._emit("highlightChanged",this)}getCombinedStaticTransformation(t,e){return X(r(e,Y()),this.transformation,t.getStaticTransformation())}getCombinedShaderTransformation(t,e){return e=e||Y(),X(e,this.transformation,t.getShaderTransformation()),e}hasVolativeTransformation(){return this._hasVolatileTransformation}get boundingVolumeWorldSpace(){return this._validateBoundingVolume(),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._validateBoundingVolume(),this._bvObjectSpace}_validateBoundingVolume(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(let t=0;t<this._geometryRecords.length;++t){const s=this._geometryRecords[t],i=this._geometries[t].boundingInfo;e(i)&&(this._calculateTransformedBoundingVolume(i,this._bvObjectSpace,s.getShaderTransformation()),this._calculateTransformedBoundingVolume(i,this._bvWorldSpace,this.getCombinedShaderTransformation(s)))}z(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),z(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);const t=V(),s=V(),i=vt(this.transformation);for(let e=0;e<this._geometryRecords.length;++e){const n=this._geometries[e].boundingInfo;if(o(n))continue;const r=this._geometryRecords[e].getShaderTransformation(),h=vt(r);D(t,n.getCenter(),r);const l=L(t,this._bvObjectSpace.bounds),a=n.getBSRadius()*h;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],l+a),D(s,t,this.transformation);const u=L(s,this._bvWorldSpace.bounds);this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],u+a*i)}this._bvDirty=!1}_calculateTransformedBoundingVolume(t,e,s){const i=t.getBBMin(),n=t.getBBMax(),r=q(i),o=q(n);D(r,r,s),D(o,o,s);for(let t=0;t<3;++t)e.min[t]=Math.min(e.min[t],r[t],o[t]),e.max[t]=Math.max(e.max[t],r[t],o[t]);for(let t=0;t<3;++t){M(r,i),M(o,n),r[t]=n[t],o[t]=i[t],D(r,r,s),D(o,o,s);for(let t=0;t<3;++t)e.min[t]=Math.min(e.min[t],r[t],o[t]),e.max[t]=Math.max(e.max[t],r[t],o[t])}}_invalidateBoundingVolume(){this._bvDirty=!0,e(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)}_emit(t,s){e(this._parentLayer)&&this._parentLayer.events.emit(t,s)}get test(){const t=this;return{hasGeometry:e=>t._geometries.indexOf(e)>-1,getGeometryIndex:e=>t._geometries.indexOf(e)}}}class ye{constructor(){this.min=B(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=B(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class fe extends ye{constructor(){super(...arguments),this.bounds=mt()}init(){_(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),_(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),yt(this.bounds)}}class be{constructor(t){this.normal=V(),this.transformation=Y(),this._ray=ft(),this.init(t)}get ray(){return this._ray}get hasIntersectionPoint(){return null!=this.dist}get distanceInRenderSpace(){if(null!=this.dist)return R(ve,this.ray.direction,this.dist),T(ve)}getIntersectionPoint(t){return!!this.hasIntersectionPoint&&(R(ve,this.ray.direction,this.dist),S(t,this.ray.origin,ve),!0)}getTransformedNormal(t){return M(we,this.normal),we[3]=0,F(we,we,this.transformation),M(t,we),A(t,t),t}init(t){this.dist=void 0,this.target=void 0,this.name=void 0,this.drapedLayerOrder=void 0,this.drapedLayerGraphicOrder=void 0,this.center=null,this.geometryId=null,this.triangleNr=null,this.intersector="Stage",t?bt(t,this._ray):this._ray=ft()}set(t,e,s,i,n,r,o,h,l,a){t instanceof me&&(t={type:"stage",obj:t}),this.dist=s,M(this.normal,i),Q(this.transformation,n),this.target=t,this.name=e,this.drapedLayerOrder=r,this.center=o?q(o):null,this.geometryId=h,this.triangleNr=l,this.drapedLayerGraphicOrder=a}copyFrom(t){bt(t.ray,this._ray),this.dist=t.dist,this.target=t.target,this.name=t.name,this.drapedLayerOrder=t.drapedLayerOrder,this.center=t.center?q(t.center):null,this.geometryId=t.geometryId,this.triangleNr=t.triangleNr,this.intersector=t.intersector,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,M(this.normal,t.normal),Q(this.transformation,t.transformation)}}const ve=V(),we=ht(),ge=s.getLogger("esri.layers.VoxelWasmPerScene");class je{constructor(t){this._halfIntTexturesAvailable=!1,this._useDepthPass=!1,this._havePreparedWithAllLayers=!1,this._renderPluginContext=null,this._vxl=null,this._pluginIsActive=!1,this._moreToLoad=!1,this._viewportWidth=-1,this._viewportHeight=-1,this._newLayers=[],this._layers=new Map,this._renderPass=0,this._renderSlot=3,this._rctx=null,this._renderTargetToRestore=null,this._wasmMemBlockSizes=[512,1024,2048,4096,8192,16384,32768,65536],this._wasmMemBlocks=new Map,this._dbgFlags=new Set,this._dbgFlags.add(4),this._view=t,this.initialize()}get canRender(){return!!this._vxl&&"local"===this._view.viewingMode}dbg(t,e){this._dbgFlags.has(t)&&(4===t?ge.error(e):ge.warn(e))}removeRenderPlugin(){this._pluginIsActive&&this._view._stage&&(this.dbg(1,"--removeRenderPlugin--"),this._view._stage.removeRenderPlugin(this)),this._pluginIsActive=!1}initialize(){this.dbg(1,"--initialize--");for(const t of this._wasmMemBlockSizes)this._wasmMemBlocks.set(t,0);this._readyWatchHandle=g((()=>this._view.ready),(t=>{t&&"local"===this._view.viewingMode?(this.dbg(1,"view ready status changed to ready on a local view, calling addRenderPlugin"),this._view._stage.addRenderPlugin([this._renderSlot],this),this._pluginIsActive=!0):(this.dbg(1,"view ready status changed, not ready or not a local view!"),this.removeRenderPlugin())}),{initial:!0}),this._qualityWatchHandle=g((()=>{var t;return null==(t=this._view)?void 0:t.qualityProfile}),(t=>{this.dbg(3,"qualityProfile changed to "+t),this._vxl&&this._vxl.set_quality(this.toWasmQuality(t))}),{initial:!0}),this._timeExtentWatchHandle=g((()=>{var t;return null==(t=this._view)?void 0:t.timeExtent}),(()=>{if(this._vxl){var t;const e=this._getTimeArgs(null==(t=this._view)?void 0:t.timeExtent);this.dbg(3,"sceneView timeExtent changed to useTime="+e.useTime+" st="+e.startTime+" et="+e.endTime),this._vxl.set_scene_time_extent(e.startTime,e.endTime,e.useTime),this._renderPluginContext.requestRender()}}),{initial:!0})}initializeRenderContext(t){this.dbg(1,"--initializeRenderContext--");const e=t.renderContext.rctx;"webgl2"===e.webglVersion?(this._renderPluginContext=t,this._rctx=t.renderContext.rctx,this._halfIntTexturesAvailable=!!this._rctx.capabilities.textureNorm16,this.initializeWasm(e.gl)):this.dbg(4,"WebGL 1 context only!")}uninitializeRenderContext(){this._renderPluginContext=null,this._rctx=null,this.dbg(1,"--uninitializeRenderContext--")}restoreFramebuffer(){if(!this._renderTargetToRestore)return;const t=this._renderTargetToRestore.fbo;if(!this._rctx)return void this.dbg(4,"no context in restoreFramebuffer!");this._rctx.bindFramebuffer(t,!0);const e=this._renderTargetToRestore.viewport;this._rctx.setViewport(e.x,e.y,e.width,e.height)}bindPreviousDepthToSlot(t,e){if(!this._rctx||!this._renderTargetToRestore)return 0;const s=this._renderTargetToRestore.fbo.depthStencilTexture;return s?(this._rctx.bindTexture(0===e?null:s,t,!0),1):(this.dbg(4,"no depth/stencil texture exists!"),0)}setBlendState(t,e,s,i){this._rctx?(this._rctx.setBlendingEnabled(1===t),this._rctx.setBlendFunction(e,s),this._rctx.setBlendEquation(i)):this.dbg(4,"setBlendState callback has no rendering context!")}setFrontFace(t){this._rctx?this._rctx.setFrontFace(t):this.dbg(4,"setFrontFace callback has no rendering context!")}setDepthStencilStateFunction(t,e,s){this._rctx?(this._rctx.setDepthFunction(s),this._rctx.setDepthTestEnabled(1===t),this._rctx.setDepthWriteEnabled(1===e),this._rctx.setStencilTestEnabled(!1),this._rctx.setStencilFunction(519,0,255),this._rctx.setStencilOpSeparate(1028,7680,7682,7680),this._rctx.setStencilOpSeparate(1029,7680,7683,7680)):this.dbg(4,"setDepthStencilStateFunction callback has no rendering context!")}setRasterizerState(t){if(this._rctx)switch(t){case 1:this._rctx.setFaceCullingEnabled(!1);break;case 3:this._rctx.setCullFace(1029),this._rctx.setFaceCullingEnabled(!0);break;case 2:this._rctx.setCullFace(1028),this._rctx.setFaceCullingEnabled(!0)}else this.dbg(4,"setRasterizerState callback has no rendering context!")}setViewport(t,e,s,i){this._rctx?this._rctx.setViewport(t,e,s,i):this.dbg(4,"setViewport callback has no rendering context!")}_syncRequestsResponses(){this._layers.forEach(((t,e)=>{const s=[];t.responses.forEach(((t,i)=>{s.push(i),this.dbg(2,"responding for requestID:"+i+" size:"+t.size),this._vxl.respond(e,i,t)}));const i=t.responses;for(const t of s)i.delete(t);const n=this._vxl.get_new_requests(e),r=t.abortController.signal;for(const e in n){t.outstandingRequestCount+=1,1===t.outstandingRequestCount&&t.layerView.updatingFlagChanged();const s=n[e],o={responseType:"array-buffer",signal:r};this.dbg(2,"making requestID:"+e+" url:"+s.url),h(s.url,o).then((n=>{t.outstandingRequestCount-=1,0===t.outstandingRequestCount&&t.layerView.updatingFlagChanged(),this.dbg(2,"have response for requestID:"+e);let r=0;if(n.data.byteLength>0){r=this._vxl._malloc(n.data.byteLength);const t=new Uint8Array(this._vxl.HEAPU8.buffer,r,n.data.byteLength),e=new Uint8Array(n.data);for(let s=0;s<n.data.byteLength;++s)t[s]=e[s]}i.set(+e,{type:s.type,ptr:r,size:n.data.byteLength,success:!0})})).catch((n=>{t.outstandingRequestCount-=1,0===t.outstandingRequestCount&&t.layerView.updatingFlagChanged(),l(n)||(this.dbg(4,`requestID:${e} failed, error=${n.toString()}`),i.set(+e,{type:s.type,ptr:0,size:0,success:!1}))}))}}))}updateWasmCamera(t){this._vxl.set_projection_matrix.apply(this._vxl,t.projectionMatrix),this._vxl.set_view_matrix.apply(this._vxl,t.viewMatrix),this._vxl.set_near_far(t.near,t.far)}isUpdating(t){return!(this._vxl||!this._vxlPromise)||!!this._layers.has(t)&&this._layers.get(t).outstandingRequestCount>0}setEnabled(t,e){this._layers.forEach(((s,i)=>{s.layerView===t&&(this._vxl.set_enabled(i,e),this._renderPluginContext.requestRender())}))}setSlices(t,e){return this._doMaskedUIUpdate(t,{mask:2,slices:{planes:e,currentEditPlane:-1}},!0)}setDynamicSections(t,e){return this._doMaskedUIUpdate(t,{mask:4,dynamicSections:{planes:e,currentEditPlane:-1}},!0)}setStaticSections(t,e){return this._doMaskedUIUpdate(t,{mask:1,staticSections:e},!0)}setCurrentVariable(t,e){return this._doMaskedUIUpdate(t,{mask:1024,currentVariable:e},!0)}setRenderMode(t,e){return this._doMaskedUIUpdate(t,{mask:8192,renderMode:e},!0)}_doMaskedUIUpdate(t,e,s){if(!this._vxl)return!1;let i=!1;return this._layers.forEach(((s,n)=>{if(s.layerView===t){const t={str:JSON.stringify(e),byteCount:0,ptr:0,isReusable:!1};this._AllocateBlock(t)&&(i=1===this._vxl.handle_masked_ui_update(n,t.ptr,t.byteCount),t.isReusable||this._vxl._free(t.ptr))}})),i&&s&&this._renderPluginContext.requestRender(),i}addVoxelLayer(t){if(!this._vxl){const e={layerView:t,resolveCallback:null,rejectCallback:null},s=new Promise(((t,s)=>{e.resolveCallback=t,e.rejectCallback=s}));return this._newLayers.push(e),s}const e=this._addVoxelLayer(t);return e<0?Promise.reject(-1):Promise.resolve(e)}removeVoxelLayer(t){if(!this._vxl){const e=this._newLayers.findIndex((e=>t===e.layerView));e>=0&&(this._newLayers[e].resolveCallback(-1),this._newLayers.splice(e,1));const s=this._newLayers.length;return 0===s&&(this.dbg(1," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),s}let e=-1;this._layers.forEach(((s,i)=>{s.layerView===t&&(e=i,s.abortController.abort(),this._vxl.remove_layer(e))})),e>=0&&this._layers.delete(e);const s=this._layers.size;return 0===s&&(this.dbg(1," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),s}_getBlockSize(t){for(const e of this._wasmMemBlockSizes)if(t<e)return e;return-1}_AllocateBlock(t){t.byteCount=this._vxl.lengthBytesUTF8(t.str)+1;const e=this._getBlockSize(t.byteCount);return e<0?(t.isReusable=!1,t.ptr=this._vxl._malloc(t.byteCount)):(t.isReusable=!0,t.ptr=this._wasmMemBlocks.get(e),0===t.ptr&&(t.ptr=this._vxl._malloc(e),this._wasmMemBlocks.set(e,t.ptr))),0!==t.ptr&&(this._vxl.stringToUTF8(t.str,t.ptr,t.byteCount),!0)}_getTimeArgs(t){let s=-Number.MAX_VALUE,i=Number.MAX_VALUE,n=!1;return e(t)&&(t.isAllTime?n=!0:(e(t.start)&&(n=!0,s=t.start.getTime()/1e3),e(t.end)&&(n=!0,i=t.end.getTime()/1e3))),{startTime:s,endTime:i,useTime:n}}_addVoxelLayer(t){var e;const s=t.layer;let i=-1;const n=s.getConfiguration();if(n.length<1)return-1;const r={str:n,byteCount:0,ptr:0,isReusable:!1};if(!this._AllocateBlock(r))return-1;const o=this._getTimeArgs(null==(e=this._view)?void 0:e.timeExtent),h=this._view.spatialReference.isWGS84&&s.spatialReference.isWGS84?111319.49079327357:1;if(i=this._vxl.add_layer(s.serviceRoot,r.ptr,r.byteCount,h,h,o.startTime,o.endTime,o.useTime),r.isReusable||this._vxl._free(r.ptr),i>=0){const e=new AbortController;if(this._layers.set(i,{layerView:t,responses:new Map,outstandingRequestCount:0,abortController:e}),!this._halfIntTexturesAvailable){const e=[];let s="";for(const i of t.layer.variables)"Int16"!==i.renderingFormat.type&&"UInt16"!==i.renderingFormat.type||(e.push(i.name),i.id===t.layer.style.currentVariableId&&(s=i.name));""!==s&&ge.error("#addVoxelLayer_error()",t.layer,`The voxel layer '${t.layer.title}' cannot render the current variable '${s}' in the this browser`),e.length>0&&ge.warn("#addVoxelLayer_warning()",t.layer,`The voxel layer '${t.layer.title}' cannot render the variables '${e.toString()}' in the this browser`)}return i}return-1}prepareRender(t){if(!this._vxl)return;const e=t.viewForward,s=t.eye;this._vxl.update_camera_pos_and_direction(s[0],s[1],s[2],e[0],e[1],e[2]);const i=this._vxl.cull();this.dbg(2,"missingResourceCount="+i),this._moreToLoad=i>0,this._havePreparedWithAllLayers=0===this._newLayers.length}render(t){if(!this._vxl||t.pass!==this._renderPass||t.slot!==this._renderSlot)return!1;for(const t of this._newLayers){const e=this._addVoxelLayer(t.layerView);-1===e?t.rejectCallback(-1):t.resolveCallback(e)}if(this._newLayers=[],0===this._layers.size)return this.dbg(4,"No voxel layers but RenderPlugin instance is being asked to render!"),!1;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()},this._syncRequestsResponses(),this._vxl.begin_frame();const e=this._renderTargetToRestore.viewport;return e.width===this._viewportWidth&&e.height===this._viewportHeight||(this._viewportWidth=e.width,this._viewportHeight=e.height,this._vxl.set_viewport(e.width,e.height)),0===e.x&&0===e.y||this.dbg(4,"Unsupported viewport parameters detected!"),this.updateWasmCamera(t.camera),this._vxl.draw(),this._renderTargetToRestore.fbo=null,t.rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),t.rctx.externalVertexArrayObjectUpdate(),t.rctx.externalVertexBufferUpdate(),(this._moreToLoad||!this._havePreparedWithAllLayers&&this._layers.size>0)&&this._renderPluginContext.requestRender(),!0}queryDepthRange(t){this.dbg(1,"--queryDepthRange--");const e=t.viewForward,s=t.eye;this._vxl.update_camera_pos_and_direction(s[0],s[1],s[2],e[0],e[1],e[2]),this._vxl.cull();const i={near:5,far:1e4};return i.near=this._vxl.get_near(),i.far=this._vxl.get_far(),i}destroy(){this.dbg(1,"--destroy--"),this.removeRenderPlugin(),this._readyWatchHandle=a(this._readyWatchHandle),this._qualityWatchHandle=a(this._qualityWatchHandle),this._timeExtentWatchHandle=a(this._timeExtentWatchHandle),this._vxl&&(this._layers.forEach((t=>{t.abortController.abort()})),this._wasmMemBlocks.forEach((t=>{0!==t&&this._vxl._free(t)})),this._vxl.uninitialize_voxel_wasm(),this._vxl=null)}initializeWasm(t){return this._vxl?Promise.resolve():(this._vxlPromise||(this._vxlPromise=function(t){return new Promise((e=>import("./p-f9c7a059.js").then((t=>t.v)).then((({default:s})=>{const i=s({locateFile:qt,preinitializedWebGLContext:t,onRuntimeInitialized:()=>e(i)})})))).catch((t=>Promise.reject(t)))}(t).then((t=>{var e;if(this._vxl=t,this._vxlPromise=null,this._newLayers.length<=0)return this.dbg(1," no voxel layers left after WASM downloaded, removing RenderPlugin and destroying"),void this.destroy();const s=this._getTimeArgs(null==(e=this._view)?void 0:e.timeExtent),i=this._vxl.addFunction(this.restoreFramebuffer.bind(this),"v"),n=this._vxl.addFunction(this.setBlendState.bind(this),"viiii"),r=this._vxl.addFunction(this.setFrontFace.bind(this),"vi"),o=this._vxl.addFunction(this.setRasterizerState.bind(this),"vi"),h=this._vxl.addFunction(this.setDepthStencilStateFunction.bind(this),"viii"),l=this._vxl.addFunction(this.setViewport.bind(this),"viiii"),a=this._vxl.addFunction(this.bindPreviousDepthToSlot.bind(this),"iii");this._vxl.initialize_voxel_wasm(i,n,r,o,h,l,a,s.startTime,s.endTime,s.useTime),this._vxl.set_quality(this.toWasmQuality(this._view.qualityProfile)),this._renderPluginContext&&this._renderPluginContext.requestRender()})).catch((()=>{for(const t of this._newLayers)t.rejectCallback(-2);this.dbg(4," WASM failed to download, removing RenderPlugin and destroying"),this.destroy()}))),this._vxlPromise)}get type(){return"external"}get isGround(){return!1}get slicePlane(){return!1}get intersectionHandlerId(){return"unj"}intersect(t,e,s,i,n){if(!this._vxl)return;if(!this._rctx)return;if(0===this._layers.size)return;if(n[0]<0||n[0]>t.camera.viewport[2]||n[1]<0||n[1]>t.camera.viewport[3])return;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()};const r=t.camera.viewForward,o=t.camera.eye;this._vxl.update_camera_pos_and_direction(o[0],o[1],o[2],r[0],r[1],r[2]),this.updateWasmCamera(t.camera),this._vxl.begin_frame(),this._useDepthPass?this.intersectDepth(t,e,s,i,n):this.intersectObject(t,e,s,i,n),this._renderTargetToRestore.fbo=null,this._rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),this._rctx.externalVertexArrayObjectUpdate(),this._rctx.externalVertexBufferUpdate()}intersectObject(t,e,s,i,n){const r=this._vxl.pick_object(n[0],n[1]);if(r.success){const n=V();O(n,i,s),A(n,n);const o=L(s,i),h=V();_(h,r.worldX,r.worldY,r.worldZ);const l=V();O(l,h,s);const a=V();R(a,n,x(l,n));const u=V();S(u,s,a);const c=L(s,u),d=P(c/o,0,1),p=t=>{t.intersector="Voxel",t.dist=d,t.target={type:"external",metadata:{layerUid:this.intersectionHandlerId}}},m=t.results.min;(null==m.dist||d<m.dist)&&(null==e||e(s,i,d))&&p(m);const y=t.results.max;if(0!==t.options.store&&(null==y.dist||d>y.dist)&&(null==e||e(s,i,d))&&p(y),2===t.options.store){const e=new be(t.ray);p(e),t.results.all.push(e)}}}intersectDepth(t,e,s,i,n){const r=this._vxl.pick_depth(n[0],n[1]);if(r.success){const n=V();O(n,i,s),A(n,n);const o=L(s,i),h=V();_(h,r.worldX,r.worldY,r.worldZ);const l=V();O(l,h,s);const a=V();R(a,n,x(l,n));const u=V();S(u,s,a);const c=L(s,u),d=P(c/o,0,1),p=t=>{t.intersector="Voxel",t.dist=d,t.target={type:"external",metadata:{layerUid:this.intersectionHandlerId}}},m=t.results.min;(null==m.dist||d<m.dist)&&(null==e||e(s,i,d))&&p(m);const y=t.results.max;if(0!==t.options.store&&(null==y.dist||d>y.dist)&&(null==e||e(s,i,d))&&p(y),2===t.options.store){const e=new be(t.ray);p(e),t.results.all.push(e)}}}toWasmQuality(t){switch(t){case"low":return 0;case"medium":return 1;case"high":return 2}}}class xe{constructor(){this.view2WASM=new Map}static getInstance(){return xe.instance||(xe.instance=new xe),xe.instance}isUpdating(t,e){return!!this.view2WASM.has(t)&&this.view2WASM.get(t).isUpdating(e)}addLayer(t,e){return this.view2WASM.has(t)||this.view2WASM.set(t,new je(t)),this.view2WASM.get(t).addVoxelLayer(e)}removeLayer(t,e){this.view2WASM.has(t)&&this.view2WASM.get(t).removeVoxelLayer(e)<1&&this.view2WASM.delete(t)}setLayerEnabled(t,e,s){this.view2WASM.has(t)&&this.view2WASM.get(t).setEnabled(e,s)}setLayerSlices(t,e){let s=!1;return this.view2WASM.forEach(((i,n)=>{n.allLayerViews.filter((t=>"voxel-3d"===t.type)).forEach((n=>{n.layer===t&&(s=i.setSlices(n,e))}))})),s}setLayerDynamicSections(t,e){let s=!1;return this.view2WASM.forEach(((i,n)=>{n.allLayerViews.filter((t=>"voxel-3d"===t.type)).forEach((n=>{n.layer===t&&(s=i.setDynamicSections(n,e))}))})),s}setLayerCurrentVariable(t,e){let s=!1;return this.view2WASM.forEach(((i,n)=>{n.allLayerViews.filter((t=>"voxel-3d"===t.type)).forEach((n=>{n.layer===t&&(s=i.setCurrentVariable(n,e))}))})),s}setLayerRenderMode(t,e){let s=!1;return this.view2WASM.forEach(((i,n)=>{n.allLayerViews.filter((t=>"voxel-3d"===t.type)).forEach((n=>{n.layer===t&&(s=i.setRenderMode(n,e))}))})),s}setLayerStaticSections(t,e){let s=!1;return this.view2WASM.forEach(((i,n)=>{n.allLayerViews.filter((t=>"voxel-3d"===t.type)).forEach((n=>{n.layer===t&&(s=i.setStaticSections(n,e))}))})),s}}let Se=class extends Pt{constructor(){super(...arguments),this.enabled=!0,this.label="",this.normal=null,this.point=null}};u([c({type:Boolean,json:{default:!0,write:!0}})],Se.prototype,"enabled",void 0),u([c({type:String,json:{write:!0}})],Se.prototype,"label",void 0),u([c({type:[Number],json:{write:!0}})],Se.prototype,"normal",void 0),u([c({type:[Number],json:{write:!0}})],Se.prototype,"point",void 0),Se=u([d("esri.layers.support.VoxelDynamicSection")],Se);const Ve=Se;let Re=class extends Pt{constructor(){super(...arguments),this.enabled=!0,this.label="",this.normal=null,this.point=null}};u([c({type:Boolean,json:{write:!0}})],Re.prototype,"enabled",void 0),u([c({type:String,json:{write:!0}})],Re.prototype,"label",void 0),u([c({type:[Number],json:{write:!0}})],Re.prototype,"normal",void 0),u([c({type:[Number],json:{write:!0}})],Re.prototype,"point",void 0),Re=u([d("esri.layers.support.VoxelSlice")],Re);const Ne=Re;let Pe=class extends Pt{constructor(){super(...arguments),this.enabled=!0,this.href=null,this.id=null,this.label="",this.normal=null,this.point=null,this.sizeInPixel=null,this.slices=null,this.timeId=0,this.variableId=null}};u([c({type:Boolean,json:{default:!0,write:!0}})],Pe.prototype,"enabled",void 0),u([c({type:String,json:{write:{enabled:!0,isRequired:!0}}})],Pe.prototype,"href",void 0),u([c({type:p,json:{write:{enabled:!0,isRequired:!0}}})],Pe.prototype,"id",void 0),u([c({type:String,json:{write:!0}})],Pe.prototype,"label",void 0),u([c({type:[Number],json:{write:{enabled:!0,isRequired:!0}}})],Pe.prototype,"normal",void 0),u([c({type:[Number],json:{write:{enabled:!0,isRequired:!0}}})],Pe.prototype,"point",void 0),u([c({type:[p],json:{write:{enabled:!0,isRequired:!0}}})],Pe.prototype,"sizeInPixel",void 0),u([c({type:[Ne],json:{write:!0}})],Pe.prototype,"slices",void 0),u([c({type:p,json:{default:0,write:!0}})],Pe.prototype,"timeId",void 0),u([c({type:p,json:{write:{enabled:!0,isRequired:!0}}})],Pe.prototype,"variableId",void 0),Pe=u([d("esri.layers.support.VoxelSection")],Pe);const qe=Pe;let Me=class extends Pt{constructor(){super(...arguments),this.diffuseFactor=.5,this.specularFactor=.5}};u([c({type:Number,range:{min:0,max:1},json:{default:.5,write:!0}})],Me.prototype,"diffuseFactor",void 0),u([c({type:Number,range:{min:0,max:1},json:{default:.5,write:!0}})],Me.prototype,"specularFactor",void 0),Me=u([d("esri.layers.support.VoxelSimpleShading")],Me);const _e=Me;let Le=class extends Pt{constructor(){super(...arguments),this.color=null,this.value=null,this.enabled=!0,this.label=null}};u([c({type:U,json:{type:[p],write:{enabled:!0,isRequired:!0}}})],Le.prototype,"color",void 0),u([c({type:Number,json:{write:{enabled:!0,isRequired:!0}}})],Le.prototype,"value",void 0),u([c({type:Boolean,json:{default:!0,write:!0}})],Le.prototype,"enabled",void 0),u([c({type:String,json:{write:!0}})],Le.prototype,"label",void 0),Le=u([d("esri.layers.support.VoxelIsosurface")],Le);const Te=Le;let Ie=class extends Pt{constructor(){super(...arguments),this.alpha=0,this.position=0}};u([c({type:Number,json:{write:{enabled:!0,isRequired:!0}}})],Ie.prototype,"alpha",void 0),u([c({type:Number,json:{write:{enabled:!0,isRequired:!0}}})],Ie.prototype,"position",void 0),Ie=u([d("esri.layers.support.VoxelAlphaStop")],Ie);const Ce=Ie;let De=class extends Pt{constructor(){super(...arguments),this.color=null,this.position=0}};u([c({type:U,json:{type:[p],write:{enabled:!0,isRequired:!0}}})],De.prototype,"color",void 0),u([c({type:Number,json:{write:{enabled:!0,isRequired:!0}}})],De.prototype,"position",void 0),De=u([d("esri.layers.support.VoxelColorStop")],De);const Ae=De;let We=class extends Pt{constructor(){super(...arguments),this.enabled=!1,this.range=null}};u([c({type:Boolean,json:{default:!1,write:!0}})],We.prototype,"enabled",void 0),u([c({type:[Number],json:{write:!0}})],We.prototype,"range",void 0),We=u([d("esri.layers.support.VoxelRangeFilter")],We);const Be=We;let ke=class extends Pt{constructor(t){super(t),this.interpolation=null,this.stretchRange=null,this.rangeFilter=null,this.colorStops=new m,this.alphaStops=new m}set colorStops(t){this._set("colorStops",E(t,this._get("colorStops"),m.ofType(Ae)))}set alphaStops(t){this._set("alphaStops",E(t,this._get("alphaStops"),m.ofType(Ce)))}};u([c({type:["linear","nearest"],json:{write:!0}})],ke.prototype,"interpolation",void 0),u([c({type:[Number],json:{write:{enabled:!0,isRequired:!0}}})],ke.prototype,"stretchRange",void 0),u([c({type:m.ofType(Ae),json:{write:{enabled:!0,overridePolicy(){return{enabled:!!this.colorStops&&this.colorStops.length>0}}}}})],ke.prototype,"colorStops",null),u([c({type:m.ofType(Ce),json:{write:{enabled:!0,overridePolicy(){return{enabled:!!this.alphaStops&&this.alphaStops.length>0}}}}})],ke.prototype,"alphaStops",null),u([c({type:Be,json:{write:!0}})],ke.prototype,"rangeFilter",void 0),ke=u([d("esri.layers.support.VoxelTransferFunctionStyle")],ke);const ze=ke;let Fe=class extends Pt{constructor(){super(...arguments),this.color=null,this.value=0,this.enabled=!0,this.label=null}};u([c({type:U,json:{type:[p],write:{enabled:!0,isRequired:!0}}})],Fe.prototype,"color",void 0),u([c({type:p,json:{write:{enabled:!0,isRequired:!0}}})],Fe.prototype,"value",void 0),u([c({type:Boolean,json:{default:!0,write:!0}})],Fe.prototype,"enabled",void 0),u([c({type:String,json:{write:!0}})],Fe.prototype,"label",void 0),Fe=u([d("esri.layers.support.VoxelUniqueValue")],Fe);const Oe=Fe;let Ue=class extends Pt{constructor(t){super(t),this.variableId=0,this.label=null,this.transferFunction=null,this.uniqueValues=new m,this.isosurfaces=new m}set uniqueValues(t){this._set("uniqueValues",E(t,this._get("uniqueValues"),m.ofType(Oe)))}set isosurfaces(t){this._set("isosurfaces",E(t,this._get("isosurfaces"),m.ofType(Te)))}};u([c({type:p,json:{write:{enabled:!0,isRequired:!0}}})],Ue.prototype,"variableId",void 0),u([c({type:String,json:{write:!0}})],Ue.prototype,"label",void 0),u([c({type:ze,json:{write:{enabled:!0,overridePolicy(){return{enabled:!this.uniqueValues||this.uniqueValues.length<1}}}}})],Ue.prototype,"transferFunction",void 0),u([c({type:m.ofType(Oe),json:{write:{enabled:!0,overridePolicy(){return{enabled:!!this.uniqueValues&&this.uniqueValues.length>0}}}}})],Ue.prototype,"uniqueValues",null),u([c({type:m.ofType(Te),json:{write:{enabled:!0,overridePolicy(){return{enabled:(!this.uniqueValues||this.uniqueValues.length<1)&&!!this.isosurfaces&&this.isosurfaces.length>0}}}}})],Ue.prototype,"isosurfaces",null),Ue=u([d("esri.layers.support.VoxelVariableStyle")],Ue);const Ee=Ue;let Ge=class extends Pt{constructor(t){super(t),this.volumeId=0,this.verticalExaggeration=1,this.exaggerationMode="scale-height",this.verticalOffset=0,this.slices=new m,this.dynamicSections=new m}set slices(t){this._set("slices",E(t,this._get("slices"),m.ofType(Ne)))}set dynamicSections(t){this._set("dynamicSections",E(t,this._get("dynamicSections"),m.ofType(Ve)))}};u([c({type:p,json:{write:{enabled:!0,isRequired:!0}}})],Ge.prototype,"volumeId",void 0),u([c({type:Number,json:{default:1,write:!0}})],Ge.prototype,"verticalExaggeration",void 0),u([c({type:["scale-position","scale-height"],json:{default:"scale-height",write:!0}})],Ge.prototype,"exaggerationMode",void 0),u([c({type:Number,json:{default:0,write:!0}})],Ge.prototype,"verticalOffset",void 0),u([c({type:m.ofType(Ne),json:{write:{enabled:!0,overridePolicy(){return{enabled:!!this.slices&&this.slices.length>0}}}}})],Ge.prototype,"slices",null),u([c({type:m.ofType(Ve),json:{write:{enabled:!0,overridePolicy(){return{enabled:!!this.dynamicSections&&this.dynamicSections.length>0}}}}})],Ge.prototype,"dynamicSections",null),Ge=u([d("esri.layers.support.VoxelVolumeStyle")],Ge);const $e=Ge;let Je=class extends Pt{constructor(t){super(t),this.currentVariableId=0,this.renderMode="volume",this.enableSlices=!0,this.enableSections=!0,this.enableDynamicSections=!0,this.enableIsosurfaces=!0,this.shading=new _e,this.volumeStyles=new m,this.variableStyles=new m}set volumeStyles(t){this._set("volumeStyles",E(t,this._get("volumeStyles"),m.ofType($e)))}set variableStyles(t){this._set("variableStyles",E(t,this._get("variableStyles"),m.ofType(Ee)))}};u([c({type:m.ofType($e),json:{write:!0}})],Je.prototype,"volumeStyles",null),u([c({type:p,json:{write:{enabled:!0,isRequired:!0}}})],Je.prototype,"currentVariableId",void 0),u([c({type:["volume","surfaces"],json:{write:!0}})],Je.prototype,"renderMode",void 0),u([c({type:m.ofType(Ee),json:{write:!0}})],Je.prototype,"variableStyles",null),u([c({type:Boolean,json:{write:!0}})],Je.prototype,"enableSlices",void 0),u([c({type:Boolean,json:{write:!0}})],Je.prototype,"enableSections",void 0),u([c({type:Boolean,json:{write:!0}})],Je.prototype,"enableDynamicSections",void 0),u([c({type:Boolean,json:{write:!0}})],Je.prototype,"enableIsosurfaces",void 0),u([c({type:_e,json:{write:!0}})],Je.prototype,"shading",void 0),Je=u([d("esri.layers.support.VoxelStyle")],Je);const He=Je;let Ze=class extends Pt{constructor(){super(...arguments),this.continuity=null,this.hasNoData=!1,this.noData=0,this.offset=0,this.scale=1,this.type=null}};u([c({type:["discrete","continuous"],json:{write:!0}})],Ze.prototype,"continuity",void 0),u([c({type:Boolean,json:{write:!0}})],Ze.prototype,"hasNoData",void 0),u([c({type:Number,json:{write:!0}})],Ze.prototype,"noData",void 0),u([c({type:Number,json:{write:!0}})],Ze.prototype,"offset",void 0),u([c({type:Number,json:{write:!0}})],Ze.prototype,"scale",void 0),u([c({type:String,json:{write:{enabled:!0,isRequired:!0}}})],Ze.prototype,"type",void 0),Ze=u([d("esri.layers.support.VoxelFormat")],Ze);const Qe=Ze;let Xe=class extends Pt{constructor(){super(...arguments),this.id=null,this.description="",this.name=null,this.originalFormat=null,this.renderingFormat=null,this.unit="",this.volumeId=0,this.type=null}};u([c({type:Number,json:{write:{enabled:!0,isRequired:!0}}})],Xe.prototype,"id",void 0),u([c({type:String,json:{write:!0}})],Xe.prototype,"description",void 0),u([c({type:String,json:{write:{enabled:!0,isRequired:!0}}})],Xe.prototype,"name",void 0),u([c({type:Qe,json:{write:!0}})],Xe.prototype,"originalFormat",void 0),u([c({type:Qe,json:{write:{enabled:!0,isRequired:!0}}})],Xe.prototype,"renderingFormat",void 0),u([c({type:String,json:{write:!0}})],Xe.prototype,"unit",void 0),u([c({type:Number,json:{write:!0}})],Xe.prototype,"volumeId",void 0),u([c({type:["stc-hot-spot-results","stc-cluster-outlier-results","stc-estimated-bin","generic-nearest-interpolated"],json:{write:!0}})],Xe.prototype,"type",void 0),Xe=u([d("esri.layers.support.VoxelVariable")],Xe);const Ye=Xe;let Ke=class extends Pt{constructor(){super(...arguments),this.values=null}};u([c({type:[Number],json:{write:!0}})],Ke.prototype,"values",void 0),Ke=u([d("esri.layers.support.VoxelIrregularSpacing")],Ke);const ts=Ke;let es=class extends Pt{constructor(){super(...arguments),this.scale=1,this.offset=0}};u([c({type:Number,json:{write:!0}})],es.prototype,"scale",void 0),u([c({type:Number,json:{write:!0}})],es.prototype,"offset",void 0),es=u([d("esri.layers.support.VoxelRegularSpacing")],es);const ss=es;let is=class extends Pt{constructor(){super(...arguments),this.irregularSpacing=null,this.isPositiveUp=null,this.isWrappedDateLine=null,this.label=null,this.name=null,this.quantity=null,this.regularSpacing=null,this.size=0,this.unit=null}};u([c({type:ts,json:{write:!0}})],is.prototype,"irregularSpacing",void 0),u([c({type:Boolean,json:{write:!0}})],is.prototype,"isPositiveUp",void 0),u([c({type:Boolean,json:{write:!0}})],is.prototype,"isWrappedDateLine",void 0),u([c({type:String,json:{write:!0}})],is.prototype,"label",void 0),u([c({type:String,json:{write:!0}})],is.prototype,"name",void 0),u([c({type:String,json:{write:!0}})],is.prototype,"quantity",void 0),u([c({type:ss,json:{write:!0}})],is.prototype,"regularSpacing",void 0),u([c({type:Number,json:{write:!0}})],is.prototype,"size",void 0),u([c({type:String,json:{write:!0}})],is.prototype,"unit",void 0),is=u([d("esri.layers.support.VoxelDimension")],is);const ns=is;let rs=class extends Pt{constructor(){super(...arguments),this.id=0,this.dimensions=null}getZDimension(){if(!this.dimensions)return-1;if(!Array.isArray(this.dimensions))return-1;if(4!==this.dimensions.length)return-1;for(let t=2;t<4;++t)if(this.dimensions[t].size>0)return t;return-1}isVolumeValid(){return!!this.dimensions&&!!Array.isArray(this.dimensions)&&4===this.dimensions.length&&!(this.dimensions[0].size<1||this.dimensions[1].size<1)&&-1!==this.getZDimension()}};u([c({type:Number,json:{write:{enabled:!0,isRequired:!0}}})],rs.prototype,"id",void 0),u([c({type:[ns],json:{write:{enabled:!0,isRequired:!0}}})],rs.prototype,"dimensions",void 0),rs=u([d("esri.layers.support.VoxelVolume")],rs);const os=rs;var hs;let ls=hs=class extends Pt{constructor(){super(...arguments),this.apronWidth=1,this.brickSize=[32,32,32],this.maxLodLevel=0,this.nodeSize=[4,4,4]}isValid(){const t=new hs;return t.apronWidth===this.apronWidth&&t.maxLodLevel===this.maxLodLevel&&!!this.brickSize&&!!this.nodeSize&&!(!Array.isArray(this.brickSize)||!Array.isArray(this.nodeSize))&&3===this.brickSize.length&&3===this.nodeSize.length&&32===this.brickSize[0]&&32===this.brickSize[1]&&32===this.brickSize[2]&&4===this.nodeSize[0]&&4===this.nodeSize[1]&&4===this.nodeSize[2]}};u([c({type:Number,json:{write:{enabled:!0,isRequired:!0}}})],ls.prototype,"apronWidth",void 0),u([c({type:[Number],json:{write:{enabled:!0,isRequired:!0}}})],ls.prototype,"brickSize",void 0),u([c({type:Number,json:{write:{enabled:!0,isRequired:!0}}})],ls.prototype,"maxLodLevel",void 0),u([c({type:[Number],json:{write:{enabled:!0,isRequired:!0}}})],ls.prototype,"nodeSize",void 0),ls=hs=u([d("esri.layers.support.VoxelVolumeIndex")],ls);const as=ls,us=s.getLogger(" esri.layers.VoxelLayer");let cs=class extends(Vt(gt(jt(xt(St(v(wt(w)))))))){constructor(t){super(t),this.serviceRoot="",this.popupEnabled=!0,this.operationalLayerType="Voxel",this.legendEnabled=!0,this.title=null,this.url=null,this.sections=new m,this.style=null,this.opacity=1,this.variables=new m,this.volumes=new m,this.index=null,this.minScale=0,this.maxScale=0,this.type="voxel",this._dbgFlags=new Set,this._handles=new y,this.version={major:Number.NaN,minor:Number.NaN,versionString:""},this._dbgFlags.add(3)}destroy(){this._handles=f(this._handles)}dbg(t,e){this._dbgFlags.has(t)&&(3===t?us.error(e):us.warn(e))}load(t){const s=e(t)?t.signal:null,i=this.loadFromPortal({supportedTypes:["Scene Service"]},t).catch(b).then((()=>this._fetchService(s))).then((()=>this.serviceRoot=this.url));return this.addResolvingPromise(i),Promise.resolve(this)}getConfiguration(){this._handles.add([g((()=>this._getRenderMode()),(t=>this._pushRenderModeToWasm(t))),g((()=>this._getCurrentVariableId()),(t=>this._pushCurrentVariableIdToWasm(t))),g((()=>this._getDynamicSections()),(t=>this._pushDynamicSectionsToWasm(t))),g((()=>this._getSlices()),(t=>this._pushSlicesToWasm(t))),g((()=>this._getSections()),(t=>this._pushSectionsToWasm(t)))]);const t={layerType:this.operationalLayerType,version:this.version.versionString,name:this.title,spatialReference:this.spatialReference,fullExtent:this.fullExtent,volumes:this.volumes.toJSON(),variables:this.variables.toJSON(),index:this.index.toJSON(),sections:this.sections.toJSON(),style:this.style};return t.index&&this.index.isValid()?JSON.stringify(t):""}readVersion(t,e){return super.parseVersionString(t)}_getSections(){const t=[];for(const e of this.sections)t.push(new qe({enabled:e.enabled,href:e.href,id:e.id,label:e.label,normal:e.normal,point:e.point,sizeInPixel:e.sizeInPixel,slices:e.slices,timeId:e.timeId,variableId:e.variableId}));return t}_pushSectionsToWasm(t){this.dbg(2,"VoxelLayer._pushSectionsToWasm() called"),xe.getInstance().setLayerStaticSections(this,t)||this.dbg(3,"VoxelLayer._pushSectionsToWasm() failed!")}_isPlaneValid(t,e,s){if(!t.point)return!1;if(!Array.isArray(t.point)||3!==t.point.length)return!1;if(!t.normal)return!1;if(!Array.isArray(t.normal)||3!==t.normal.length)return!1;for(let i=0;i<3;++i){const n=t.point[i];if(n<0||n>=s[e[i]].size)return!1}const i=B(t.normal[0],t.normal[1],t.normal[2]);return A(i,i),!(Math.abs(i[0])+Math.abs(i[1])+Math.abs(i[2])<1e-6||(t.normal[0]=i[0],t.normal[1]=i[1],t.normal[2]=i[2],0))}getVariableStyle(t){let s=-1;if(s=e(t)?t:this._getCurrentVariableId(),!(null==this?void 0:this.style.variableStyles)||-1===s)return null;const i=this.style.variableStyles.findIndex((t=>t.variableId===s));return i<0?null:this.style.variableStyles.getItemAt(i)}getVariable(t){let s=-1;if(s=e(t)?t:this._getCurrentVariableId(),!this.variables||-1===s)return null;const i=this.variables.findIndex((t=>t.id===s));return i<0?null:this.variables.getItemAt(i)}_getVolume(t){const s=this.getVariable(t);return e(s)?this.volumes.find((({id:t})=>t===s.volumeId)):null}_getVolumeStyle(t){const s=this.getVariable(t);return e(s)?this.style.volumeStyles.find((({volumeId:t})=>t===s.volumeId)):null}_getSlices(){const t=[],s=this._getVolume(null);if(!e(s)||!s.isVolumeValid())return t;const i=this._getVolumeStyle(null);if(!e(i))return t;for(const e of i.slices)this._isPlaneValid(e,[0,1,s.getZDimension()],s.dimensions)?t.push(new Ne({enabled:e.enabled,label:e.label,point:e.point,normal:e.normal})):t.push(new Ne({enabled:!1,label:"invalid",point:e.point,normal:e.normal}));return t}_pushSlicesToWasm(t){this.dbg(2,"VoxelLayer._pushSlicesToWasm() called!"),xe.getInstance().setLayerSlices(this,t)||this.dbg(3,"VoxelLayer._pushSlicesToWasm() failed!")}_getDynamicSections(){const t=[],s=this._getVolume(null);if(!e(s)||!s.isVolumeValid())return t;const i=this._getVolumeStyle(null);if(!e(i))return t;for(const e of i.dynamicSections)this._isPlaneValid(e,[0,1,s.getZDimension()],s.dimensions)?t.push(new Ve({enabled:e.enabled,label:e.label,point:e.point,normal:e.normal})):t.push(new Ve({enabled:!1,label:"invalid",point:e.point,normal:e.normal}));return t}_pushDynamicSectionsToWasm(t){this.dbg(2,"VoxelLayer._pushDynamicSectionsToWasm() called!"),xe.getInstance().setLayerDynamicSections(this,t)||this.dbg(3,"VoxelLayer._updateDynamicSections() failed!")}_getCurrentVariableId(){return this.style?this.style.currentVariableId:-1}_pushCurrentVariableIdToWasm(t){this.dbg(2,"VoxelLayer._pushCurrentVariableIdToWasm() called!"),xe.getInstance().setLayerCurrentVariable(this,t)||this.dbg(3,"VoxelLayer._pushCurrentVariableIdToWasm() failed!")}_getRenderMode(){return this.style?this.style.renderMode:"volume"}_pushRenderModeToWasm(t){this.dbg(2,"VoxelLayer._pushRenderModeToWasm() called!"),xe.getInstance().setLayerRenderMode(this,t)||this.dbg(3,"VoxelLayer.setLayerRenderMode() failed!")}};u([c(Rt)],cs.prototype,"popupEnabled",void 0),u([c({type:["Voxel"]})],cs.prototype,"operationalLayerType",void 0),u([c(Nt)],cs.prototype,"legendEnabled",void 0),u([c({json:{write:!0}})],cs.prototype,"title",void 0),u([c({type:String,json:{write:!0}})],cs.prototype,"url",void 0),u([c({type:m.ofType(qe),json:{write:!0,origins:{"web-scene":{name:"layerDefinition.sections",write:!0},service:{write:!1}}}})],cs.prototype,"sections",void 0),u([c({type:He,json:{write:!0,origins:{"web-scene":{name:"layerDefinition.style",write:!0},service:{write:!1}}}})],cs.prototype,"style",void 0),u([c({type:["show","hide"]})],cs.prototype,"listMode",void 0),u([c({type:Number,range:{min:0,max:1},nonNullable:!0,json:{read:!1,write:!1,origins:{"web-scene":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],cs.prototype,"opacity",void 0),u([c({type:m.ofType(Ye)})],cs.prototype,"variables",void 0),u([c({type:m.ofType(os)})],cs.prototype,"volumes",void 0),u([c({type:as})],cs.prototype,"index",void 0),u([c({type:Number,json:{name:"layerDefinition.minScale",read:!1,write:!1,origins:{service:{read:!1,write:!1}}}})],cs.prototype,"minScale",void 0),u([c({type:Number,json:{name:"layerDefinition.maxScale",read:!1,write:!1,origins:{service:{read:!1,write:!1}}}})],cs.prototype,"maxScale",void 0),u([c({json:{read:!1},readOnly:!0})],cs.prototype,"type",void 0),u([c({readOnly:!0,json:{name:"serviceVersion"}})],cs.prototype,"version",void 0),u([G("service","version")],cs.prototype,"readVersion",null),cs=u([d("esri.layers.VoxelLayer")],cs);const ds=cs;export default ds;