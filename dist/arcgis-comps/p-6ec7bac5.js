import{e as t,d as e,_ as i,i as r,a1 as s,a2 as n,S as l,c6 as o,s as a,aE as u,A as c,u as d,aj as m,bi as h,Q as p,D as f,Z as y,d4 as g,a3 as v}from"./p-e58503d5.js";import{l as w}from"./p-d208934e.js";import{b as x}from"./p-3e39c093.js";import{a as S,x as T}from"./p-154b00b9.js";import{i as M}from"./p-a24f7752.js";import{y as I}from"./p-1ab449fc.js";import{w as b}from"./p-e44bd0a6.js";import{n as j}from"./p-fe68aab5.js";import{s as E}from"./p-c6970847.js";import{j as L}from"./p-db63fa0e.js";import{u as R}from"./p-01e5a461.js";import{o as V}from"./p-9a8fa752.js";import"./p-53bb6ab4.js";import"./p-b79fcce3.js";import"./p-8747982c.js";import"./p-efbca0ca.js";import"./p-74de0937.js";import"./p-fb38a9d0.js";import"./p-ccdb8e80.js";import"./p-d3105731.js";import"./p-7a5bfd29.js";import"./p-8a919d07.js";import"./p-a6c8fb32.js";import"./p-765e6c28.js";import"./p-6b2eb7a7.js";import"./p-e654504b.js";import"./p-0eb619a6.js";import"./p-ea916a39.js";import"./p-2f398ed1.js";var P;let F=P=class extends s{constructor(t){super(t),this.fullExtent=null,this.id=null,this.tileInfo=null}clone(){const t=new P;return this.hasOwnProperty("fullExtent")&&(t.fullExtent=this.fullExtent&&this.fullExtent.clone()),this.hasOwnProperty("id")&&(t.id=this.id),this.hasOwnProperty("tileInfo")&&(t.tileInfo=this.tileInfo&&this.tileInfo.clone()),t}};t([e({type:i,json:{read:{source:"fullExtent"}}})],F.prototype,"fullExtent",void 0),t([e({type:String,json:{read:{source:"id"}}})],F.prototype,"id",void 0),t([e({type:L,json:{read:{source:"tileInfo"}}})],F.prototype,"tileInfo",void 0),F=P=t([r("esri.layer.support.TileMatrixSet")],F);const C=F;var A;let U=A=class extends s{constructor(t){super(t),this.id=null,this.title=null,this.description=null,this.legendUrl=null}clone(){const t=new A;return this.hasOwnProperty("description")&&(t.description=this.description),this.hasOwnProperty("id")&&(t.id=this.id),this.hasOwnProperty("isDefault")&&(t.isDefault=this.isDefault),this.hasOwnProperty("keywords")&&(t.keywords=this.keywords&&this.keywords.slice()),this.hasOwnProperty("legendUrl")&&(t.legendUrl=this.legendUrl),this.hasOwnProperty("title")&&(t.title=this.title),t}};t([e({json:{read:{source:"id"}}})],U.prototype,"id",void 0),t([e({json:{read:{source:"title"}}})],U.prototype,"title",void 0),t([e({json:{read:{source:"abstract"}}})],U.prototype,"description",void 0),t([e({json:{read:{source:"legendUrl"}}})],U.prototype,"legendUrl",void 0),t([e({json:{read:{source:"isDefault"}}})],U.prototype,"isDefault",void 0),t([e({json:{read:{source:"keywords"}}})],U.prototype,"keywords",void 0),U=A=t([r("esri.layer.support.WMTSStyle")],U);const W=U;var O;let K=O=class extends s{constructor(t){super(t),this.fullExtent=null,this.fullExtents=null,this.imageFormats=null,this.id=null,this.layer=null,this.styles=null,this.tileMatrixSetId=null,this.tileMatrixSets=null}get description(){return this._get("description")}set description(t){this._set("description",t)}readFullExtent(t,e){return(t=e.fullExtent)?i.fromJSON(t):null}readFullExtents(t,e){var r;return null!=(r=e.fullExtents)&&r.length?e.fullExtents.map((t=>i.fromJSON(t))):e.tileMatrixSets.map((t=>i.fromJSON(t.fullExtent))).filter((t=>t))}get imageFormat(){let t=this._get("imageFormat");return t||(t=this.imageFormats&&this.imageFormats.length?this.imageFormats[0]:""),t}set imageFormat(t){const e=this.imageFormats;t&&(t.indexOf("image/")>-1||e&&-1===e.indexOf(t))&&(-1===t.indexOf("image/")&&(t="image/"+t),e&&-1===e.indexOf(t))?console.error("The layer doesn't support the format of "+t):this._set("imageFormat",t)}get styleId(){let t=this._get("styleId");return t||(t=this.styles&&this.styles.length?this.styles.getItemAt(0).id:""),t}set styleId(t){this._set("styleId",t)}get title(){return this._get("title")}set title(t){this._set("title",t)}get tileMatrixSet(){return this.tileMatrixSets?this.tileMatrixSets.find((t=>t.id===this.tileMatrixSetId)):null}clone(){const t=new O;return this.hasOwnProperty("description")&&(t.description=this.description),this.hasOwnProperty("imageFormats")&&(t.imageFormats=this.imageFormats&&this.imageFormats.slice()),this.hasOwnProperty("imageFormat")&&(t.imageFormat=this.imageFormat),this.hasOwnProperty("fullExtent")&&(t.fullExtent=this.fullExtent&&this.fullExtent.clone()),this.hasOwnProperty("id")&&(t.id=this.id),this.hasOwnProperty("layer")&&(t.layer=this.layer),this.hasOwnProperty("styleId")&&(t.styleId=this.styleId),this.hasOwnProperty("styles")&&(t.styles=this.styles&&this.styles.clone()),this.hasOwnProperty("tileMatrixSetId")&&(t.tileMatrixSetId=this.tileMatrixSetId),this.hasOwnProperty("tileMatrixSets")&&(t.tileMatrixSets=this.tileMatrixSets.clone()),this.hasOwnProperty("title")&&(t.title=this.title),t}};t([e()],K.prototype,"description",null),t([e()],K.prototype,"fullExtent",void 0),t([n("fullExtent",["fullExtent"])],K.prototype,"readFullExtent",null),t([e({readOnly:!0})],K.prototype,"fullExtents",void 0),t([n("fullExtents",["fullExtents","tileMatrixSets"])],K.prototype,"readFullExtents",null),t([e()],K.prototype,"imageFormat",null),t([e({json:{read:{source:"formats"}}})],K.prototype,"imageFormats",void 0),t([e()],K.prototype,"id",void 0),t([e()],K.prototype,"layer",void 0),t([e()],K.prototype,"styleId",null),t([e({type:l.ofType(W),json:{read:{source:"styles"}}})],K.prototype,"styles",void 0),t([e({value:null,json:{write:{ignoreOrigin:!0}}})],K.prototype,"title",null),t([e()],K.prototype,"tileMatrixSetId",void 0),t([e({readOnly:!0})],K.prototype,"tileMatrixSet",null),t([e({type:l.ofType(C),json:{read:{source:"tileMatrixSets"}}})],K.prototype,"tileMatrixSets",void 0),K=O=t([r("esri.layers.support.WMTSSublayer")],K);const D=K,k=90.71428571428571,_=[[3819,3819],[3821,3824],[3889,3889],[3906,3906],[4001,4025],[4027,4036],[4039,4047],[4052,4055],[4074,4075],[4080,4081],[4120,4176],[4178,4185],[4188,4216],[4218,4289],[4291,4304],[4306,4319],[4322,4326],[4463,4463],[4470,4470],[4475,4475],[4483,4483],[4490,4490],[4555,4558],[4600,4646],[4657,4765],[4801,4811],[4813,4821],[4823,4824],[4901,4904],[5013,5013],[5132,5132],[5228,5229],[5233,5233],[5246,5246],[5252,5252],[5264,5264],[5324,5340],[5354,5354],[5360,5360],[5365,5365],[5370,5373],[5381,5381],[5393,5393],[5451,5451],[5464,5464],[5467,5467],[5489,5489],[5524,5524],[5527,5527],[5546,5546],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3038,3051],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3150,3151],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,3366],[3389,3390],[3416,3417],[3833,3841],[3844,3850],[3854,3854],[3873,3885],[3907,3910],[4026,4026],[4037,4038],[4417,4417],[4434,4434],[4491,4554],[4839,4839],[5048,5048],[5105,5130],[5253,5259],[5269,5275],[5343,5349],[5479,5482],[5518,5519],[5520,5520],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700]];function B(t){return t.nodeType===Node.ELEMENT_NODE}function N(t,e){for(let i=0;i<e.childNodes.length;i++){const r=e.childNodes[i];if(B(r)&&r.nodeName===t)return r}return null}function $(t,e){const i=[];for(let r=0;r<e.childNodes.length;r++){const s=e.childNodes[r];B(s)&&s.nodeName===t&&i.push(s)}return i}function G(t,e){const i=[];for(let r=0;r<e.childNodes.length;r++){const s=e.childNodes[r];B(s)&&s.nodeName===t&&i.push(s)}return i.map((t=>t.textContent))}function H(t,e){return t.split(">").forEach((t=>{e&&(e=N(t,e))})),e&&e.textContent}function q(t,e,i,r){let s;return Array.prototype.slice.call(r.childNodes).some((r=>{if(r.nodeName.indexOf(t)>-1){const t=N(e,r),n=t&&t.textContent;if(n===i||i.split(":")&&i.split(":")[1]===n)return s=r,!0}return!1})),s}function z(t,e,i,r,s){const n=H("Abstract",e),l=G("Format",e);return{id:t,fullExtent:X(e),fullExtents:Y(e),description:n,formats:l,styles:Z(e,r),title:H("Title",e),tileMatrixSets:J(s,e,i)}}function Q(t,e){var i;const r=[],s=null==(i=t.layerMap)?void 0:i.get(e);if(!s)return;const n=$("ResourceURL",s),l=$("Dimension",s);let o,a,u,c;return l.length&&(o=H("Identifier",l[0]),a=G("Default",l[0])||G("Value",l[0])),l.length>1&&(u=H("Identifier",l[1]),c=G("Default",l[1])||G("Value",l[1])),t.dimensionMap.set(e,{dimensions:a,dimensions2:c}),n.forEach((t=>{let e=t.getAttribute("template");if("tile"===t.getAttribute("resourceType")){if(o&&a.length)if(e.indexOf("{"+o+"}")>-1)e=e.replace("{"+o+"}","{dimensionValue}");else{const t=e.toLowerCase().indexOf("{"+o.toLowerCase()+"}");t>-1&&(e=e.substring(0,t)+"{dimensionValue}"+e.substring(t+o.length+2))}if(u&&c.length)if(e.indexOf("{"+u+"}")>-1)e=e.replace("{"+u+"}","{dimensionValue2}");else{const t=e.toLowerCase().indexOf("{"+u.toLowerCase()+"}");t>-1&&(e=e.substring(0,t)+"{dimensionValue2}"+e.substring(t+u.length+2))}r.push({template:e,format:t.getAttribute("format"),resourceType:"tile"})}})),r}function X(t){const e=N("WGS84BoundingBox",t),i=e?H("LowerCorner",e).split(" "):["-180","-90"],r=e?H("UpperCorner",e).split(" "):["180","90"];return{xmin:parseFloat(i[0]),ymin:parseFloat(i[1]),xmax:parseFloat(r[0]),ymax:parseFloat(r[1]),spatialReference:{wkid:4326}}}function Y(t){const e=[];return V(t,{BoundingBox:t=>{const i=t.getAttribute("crs"),r=tt(i),s=i.includes("epsg")&&et(r.wkid);let n,l,o,a;V(t,{LowerCorner:t=>{[n,l]=t.textContent.split(" ").map((t=>Number.parseFloat(t))),s&&([n,l]=[l,n])},UpperCorner:t=>{[o,a]=t.textContent.split(" ").map((t=>Number.parseFloat(t))),s&&([o,a]=[a,o])}}),e.push({xmin:n,ymin:l,xmax:o,ymax:a,spatialReference:r})}}),e}function Z(t,e){return $("Style",t).map((t=>{const i=N("LegendURL",t),r=N("Keywords",t),s=r&&G("Keyword",r);let n=i&&i.getAttribute("xlink:href");return e&&(n=n&&n.replace(/^http:/i,"https:")),{abstract:H("Abstract",t),id:H("Identifier",t),isDefault:"true"===t.getAttribute("isDefault"),keywords:s,legendUrl:n,title:H("Title",t)}}))}function J(t,e,r){return $("TileMatrixSetLink",e).map((t=>N("TileMatrixSet",t).textContent)).map((s=>function(t,e,r,s){const n=G("TileMatrix",q("TileMatrixSetLink","TileMatrixSet",e,r)),l=s.find((t=>{const i=N("Identifier",t),r=i&&i.textContent;return!!(r===e||e.split(":")&&e.split(":")[1]===r)})),o=function(t){const e=H("SupportedCRS",t).toLowerCase(),i=tt(e),r=H("TopLeftCorner",N("TileMatrix",t)).split(" "),s=r[0].split("E").map((t=>Number(t))),n=r[1].split("E").map((t=>Number(t))),l=s.length>1?s[0]*10**s[1]:s[0],o=n.length>1?n[0]*10**n[1]:n[0];return e.includes("epsg")&&et(i.wkid)?new u({x:o,y:l,spatialReference:i}):new u({x:l,y:o,spatialReference:i})}(l),a=o.spatialReference,c=a.wkid,d=N("TileMatrix",l),m=[parseInt(H("TileWidth",d),10),parseInt(H("TileHeight",d),10)],h=[];n.length?n.forEach(((t,i)=>{const r=q("TileMatrix","Identifier",t,l);h.push(it(r,c,i,e))})):$("TileMatrix",l).forEach(((t,i)=>{h.push(it(t,c,i,e))}));const p=function(t,e,r,s,n){const l=N("BoundingBox",e);let o,a,u,c,d,m;if(l&&(o=H("LowerCorner",l).split(" "),a=H("UpperCorner",l).split(" ")),o&&o.length>1&&a&&a.length>1)u=parseFloat(o[0]),d=parseFloat(o[1]),c=parseFloat(a[0]),m=parseFloat(a[1]);else{const t=N("TileMatrix",e),i=parseInt(H("MatrixWidth",t),10),l=parseInt(H("MatrixHeight",t),10);u=r.x,m=r.y,c=u+i*s[0]*n.resolution,d=m-l*s[1]*n.resolution}return function(t,e){return"1.0.0"===t&&et(e.wkid)}(t,r.spatialReference)?new i(d,u,m,c,r.spatialReference):new i(u,d,c,m,r.spatialReference)}(t,l,o,m,h[0]).toJSON(),f=new L({dpi:96,spatialReference:a,size:m,origin:o,lods:h}).toJSON();return{id:e,fullExtent:p,tileInfo:f}}(t,s,e,r)))}function tt(t){t=t.toLowerCase();let e=parseInt(t.split(":").pop(),10);900913!==e&&3857!==e||(e=102100);const i=function(t){return t.includes("crs84")||t.includes("crs:84")?4326:t.includes("crs83")||t.includes("crs:83")?4269:t.includes("crs27")||t.includes("crs:27")?4267:null}(t);return c(i)&&(e=i),{wkid:e}}function et(t){return _.some((([e,i])=>t>=e&&t<=i))}function it(t,e,i,r){const s=H("Identifier",t),n=H("ScaleDenominator",t).split("E").map((t=>Number(t)));let l;l=n.length>1?n[0]*10**n[1]:n[0];const o=rt(e,l,r);return l*=96/k,{cols:parseInt(H("MatrixWidth",t),10),level:i,levelValue:s,scale:l,resolution:o,rows:parseInt(H("MatrixHeight",t),10)}}function rt(t,e,i){let r;return r=o.hasOwnProperty(String(t))?o.values[o[t]]:"default028mm"===i?6370997*Math.PI/180:R(t).metersPerDegree,7*e/25e3/r}const st={"image/png":".png","image/png8":".png","image/png24":".png","image/png32":".png","image/jpg":".jpg","image/jpeg":".jpeg","image/gif":".gif","image/bmp":".bmp","image/tiff":".tif","image/jpgpng":"","image/jpegpng":"","image/unknown":""},nt=new Set(["version","service","request","layer","style","format","tilematrixset","tilematrix","tilerow","tilecol"]);let lt=class extends(M(j(E(I(b(w(x))))))){constructor(...t){super(...t),this._sublayersHandles=new d,this.copyright="",this.customParameters=null,this.customLayerParameters=null,this.fullExtent=null,this.operationalLayerType="WebTiledLayer",this.resourceInfo=null,this.serviceMode="RESTful",this.sublayers=null,this.type="wmts",this.version="1.0.0",this.watch("activeLayer",((t,e)=>{e&&(e.layer=null),t&&(t.layer=this)}),!0),this.watch("sublayers",((t,e)=>{e&&(e.forEach((t=>{t.layer=null})),this._sublayersHandles.removeAll(),this._sublayersHandles=null),t&&(t.forEach((t=>{t.layer=this})),this._sublayersHandles||(this._sublayersHandles=new d),this._sublayersHandles.add([t.on("after-add",(({item:t})=>{t.layer=this})),t.on("after-remove",(({item:t})=>{t.layer=null}))]))}),!0)}normalizeCtorArgs(t,e){return"string"==typeof t?{url:t,...e}:t}load(t){if("KVP"===this.serviceMode||"RESTful"===this.serviceMode)return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WMTS"]},t).catch(m).then((()=>this._fetchService(t))).catch((t=>{throw m(t),new a("wmtslayer:unsupported-service-data","Invalid response from the WMTS service.",{error:t})}))),Promise.resolve(this);console.error("WMTS mode could only be 'KVP' or 'RESTful'")}get activeLayer(){return this._get("activeLayer")}set activeLayer(t){this._set("activeLayer",t)}readActiveLayerFromService(t,e,i){this.activeLayer||(this.activeLayer=new D);let r=e.layers.find((t=>t.id===this.activeLayer.id));return r||(r=e.layers[0]),this.activeLayer.read(r,i),this.activeLayer}readActiveLayerFromItemOrWebDoc(t,e){const{templateUrl:i,wmtsInfo:r}=e,s=i?this._getLowerCasedUrlParams(i):null,n=null==r?void 0:r.layerIdentifier;let l=null;const o=null==r?void 0:r.tileMatrixSet;return o&&(Array.isArray(o)?o.length&&(l=o[0]):l=o),new D({id:n,imageFormat:null==s?void 0:s.format,styleId:null==s?void 0:s.style,tileMatrixSetId:l})}writeActiveLayer(t,e,i,r){const s=this.activeLayer;e.templateUrl=this.getUrlTemplate(s.id,s.tileMatrixSetId,s.imageFormat,s.styleId);const n=h("tileMatrixSet.tileInfo",s);e.tileInfo=n?n.toJSON(r):null,e.wmtsInfo={...e.wmtsInfo,layerIdentifier:s.id,tileMatrixSet:s.tileMatrixSetId}}readCustomParameters(t,e){const i=e.wmtsInfo;return i?this._mergeParams(i.customParameters,i.url):null}get fullExtents(){return this.activeLayer.fullExtents}readServiceMode(t,e){return e.templateUrl.indexOf("?")>-1?"KVP":"RESTful"}readSublayersFromService(t,e,i){return function(t,e){return t.map((t=>{const i=new D;return i.read(t,e),i}))}(e.layers,i)}get supportedSpatialReferences(){return this.activeLayer.tileMatrixSets.map((t=>t.tileInfo.spatialReference)).toArray()}get title(){var t,e;return null!=(t=null==(e=this.activeLayer)?void 0:e.title)?t:"Layer"}set title(t){t?this._override("title",t):this._clearOverride("title")}get url(){return this._get("url")}set url(t){t&&"/"===t.substr(-1)?this._set("url",t.slice(0,-1)):this._set("url",t)}createWebTileLayer(t){const e=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId),i=this._getTileMatrixSetById(t.tileMatrixSetId).tileInfo,r=t.fullExtent,s=new S({layerIdentifier:t.id,tileMatrixSet:t.tileMatrixSetId,url:this.url});return this.customLayerParameters&&(s.customLayerParameters=this.customLayerParameters),this.customParameters&&(s.customParameters=this.customParameters),new T({fullExtent:r,urlTemplate:e,tileInfo:i,wmtsInfo:s})}fetchTile(t,e,i){const r=this.getTileUrl(t,e,i);return p(r,{responseType:"image"}).then((t=>t.data))}findSublayerById(t){return this.sublayers.find((e=>e.id===t))}getTileUrl(t,e,i){const r=this._getTileMatrixSetById(this.activeLayer.tileMatrixSetId).tileInfo.lods[t],s=r?r.levelValue?r.levelValue:`${r.level}`:`${t}`;let n=this.resourceInfo?"":function(t,e,i,r,s,n,l,o){const{dimensionMap:a}=t,u=Q(t,e),c=a.get(e).dimensions&&a.get(e).dimensions[0],d=a.get(e).dimensions2&&a.get(e).dimensions2[0];let m="";if(u&&u.length>0){let t=null;u.some((e=>e.format===r&&(t=e,!0))),t||(t=u[l%u.length]),m=t.template.replace(/\{Style\}/gi,s).replace(/\{TileMatrixSet\}/gi,i).replace(/\{TileMatrix\}/gi,n).replace(/\{TileRow\}/gi,""+l).replace(/\{TileCol\}/gi,""+o).replace(/\{dimensionValue\}/gi,c).replace(/\{dimensionValue2\}/gi,d)}return m}({dimensionMap:this.dimensionMap,layerMap:this.layerMap},this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId,s,e,i);return n||(n=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId).replace(/\{level\}/gi,s).replace(/\{row\}/gi,`${e}`).replace(/\{col\}/gi,`${i}`)),n=this._appendCustomLayerParameters(n),n}getUrlTemplate(t,e,i,r){if(!this.resourceInfo){const i=function(t,e,i,r){const{dimensionMap:s}=t,n=Q(t,e);let l="";if(n&&n.length>0){const t=s.get(e).dimensions&&s.get(e).dimensions[0],o=s.get(e).dimensions2&&s.get(e).dimensions2[0];l=n[0].template,l.indexOf(".xxx")===l.length-4&&(l=l.slice(0,l.length-4)),l=l.replace(/\{Style\}/gi,r),l=l.replace(/\{TileMatrixSet\}/gi,i),l=l.replace(/\{TileMatrix\}/gi,"{level}"),l=l.replace(/\{TileRow\}/gi,"{row}"),l=l.replace(/\{TileCol\}/gi,"{col}"),l=l.replace(/\{dimensionValue\}/gi,t),l=l.replace(/\{dimensionValue2\}/gi,o)}return l}({dimensionMap:this.dimensionMap,layerMap:this.layerMap},t,e,r);if(i)return i}if("KVP"===this.serviceMode)return this.url+"?SERVICE=WMTS&VERSION="+this.version+"&REQUEST=GetTile&LAYER="+t+"&STYLE="+r+"&FORMAT="+i+"&TILEMATRIXSET="+e+"&TILEMATRIX={level}&TILEROW={row}&TILECOL={col}";if("RESTful"===this.serviceMode){let s="";return st[i.toLowerCase()]&&(s=st[i.toLowerCase()]),this.url+t+"/"+r+"/"+e+"/{level}/{row}/{col}"+s}return""}async _fetchService(t){let e;if(this.resourceInfo)"KVP"===this.resourceInfo.serviceMode&&(this.url+=this.url.indexOf("?")>-1?"":"?"),e={ssl:!1,data:this.resourceInfo};else try{e=await this._getCapabilities(this.serviceMode,t)}catch{const i="KVP"===this.serviceMode?"RESTful":"KVP";try{e=await this._getCapabilities(i,t),this.serviceMode=i}catch(t){throw new a("wmtslayer:unsupported-service-data","Services does not support RESTful or KVP service modes.",{error:t})}}e.data=this.resourceInfo?function(t){return t.layers.forEach((t=>{t.tileMatrixSets.forEach((t=>{const e=t.tileInfo;96!==e.dpi&&(e.lods.forEach((i=>{i.scale=96*i.scale/e.dpi,i.resolution=rt(e.spatialReference.wkid,i.scale*k/96,t.id)})),e.dpi=96)}))})),t}(e.data):function(t,e){var i,r;t=t.replace(/ows:/gi,"");const s=(new DOMParser).parseFromString(t,"text/xml").documentElement,n=new Map,l=new Map,o=N("Contents",s);if(!o)throw new a("wmtslayer:wmts-capabilities-xml-is-not-valid");const u=N("OperationsMetadata",s),c=null==u?void 0:u.querySelector("[name='GetTile']"),d=null==c?void 0:c.getElementsByTagName("Get"),m=d&&Array.prototype.slice.call(d),h=null!=(i=(null==e||null==(r=e.url)?void 0:r.indexOf("https"))>-1)&&i;let p,f,y=e.serviceMode,g=e&&e.url;if(m&&m.length&&m.some((t=>{const e=N("Constraint",t);return!e||q("AllowedValues","Value",y,e)?(g=t.attributes[0].nodeValue,!0):(!e||q("AllowedValues","Value","RESTful",e)||q("AllowedValues","Value","REST",e)?f=t.attributes[0].nodeValue:e&&!q("AllowedValues","Value","KVP",e)||(p=t.attributes[0].nodeValue),!1)})),!g)if(f)g=f,y="RESTful";else if(p)g=p,y="KVP";else{const t=N("ServiceMetadataURL",s);g=t&&t.getAttribute("xlink:href")}const v=g.indexOf("1.0.0/");-1===v&&"RESTful"===y?g+="/":v>-1&&(g=g.substring(0,v)),"KVP"===y&&(g+=v>-1?"":"?"),h&&(g=g.replace(/^http:/i,"https:"));const w=H("ServiceIdentification>ServiceTypeVersion",s),x=H("ServiceIdentification>AccessConstraints",s),S=$("Layer",o),T=$("TileMatrixSet",o),M=S.map((t=>{const e=H("Identifier",t);return n.set(e,t),z(e,t,T,h,w)}));return{copyright:x,dimensionMap:l,layerMap:n,layers:M,serviceMode:y,tileUrl:g}}(e.data,{serviceMode:this.serviceMode,url:this.url}),e.data&&this.read(e.data,{origin:"service"})}async _getCapabilities(t,e){const i=this._getCapabilitiesUrl(t);return await p(i,{...e,responseType:"text"})}_getTileMatrixSetById(t){return this.findSublayerById(this.activeLayer.id).tileMatrixSets.find((e=>e.id===t))}_appendCustomParameters(t){return this._appendParameters(t,this.customParameters)}_appendCustomLayerParameters(t){return this._appendParameters(t,{...f(this.customParameters),...this.customLayerParameters})}_appendParameters(t,e){const i=y(t),r={...i.query,...e},s=g(r);return""===s?i.path:`${i.path}?${s}`}_getCapabilitiesUrl(t){let e;return this.url=this.url.split("?")[0],"KVP"===t?e=this.url+"?request=GetCapabilities&service=WMTS&version="+this.version:"RESTful"===t&&(e=this.url+"/"+this.version+"/WMTSCapabilities.xml"),e=this._appendCustomParameters(e),e}_getLowerCasedUrlParams(t){if(!t)return null;const e=y(t).query;if(!e)return null;const i={};return Object.keys(e).forEach((t=>{i[t.toLowerCase()]=e[t]})),i}_mergeParams(t,e){const i=this._getLowerCasedUrlParams(e);if(i){const e=Object.keys(i);e.length&&(t=t?f(t):{},e.forEach((e=>{t.hasOwnProperty(e)||nt.has(e)||(t[e]=i[e])})))}return t}};t([e()],lt.prototype,"dimensionMap",void 0),t([e()],lt.prototype,"layerMap",void 0),t([e({type:D,json:{origins:{"web-document":{write:{ignoreOrigin:!0}}}}})],lt.prototype,"activeLayer",null),t([n("service","activeLayer",["layers"])],lt.prototype,"readActiveLayerFromService",null),t([n(["web-document","portal-item"],"activeLayer",["wmtsInfo"])],lt.prototype,"readActiveLayerFromItemOrWebDoc",null),t([v(["web-document","portal-item"],"activeLayer",{templateUrl:{type:String},tileInfo:{type:L},"wmtsInfo.layerIdentifier":{type:String},"wmtsInfo.tileMatrixSet":{type:String}})],lt.prototype,"writeActiveLayer",null),t([e({type:String,value:"",json:{write:!0}})],lt.prototype,"copyright",void 0),t([e({type:["show","hide"]})],lt.prototype,"listMode",void 0),t([e({json:{origins:{"web-document":{read:{source:["wmtsInfo.customParameters","wmtsInfo.url"]},write:{target:"wmtsInfo.customParameters"}},"portal-item":{read:{source:["wmtsInfo.customParameters","wmtsInfo.url"]},write:{target:"wmtsInfo.customParameters"}}}}})],lt.prototype,"customParameters",void 0),t([n(["portal-item","web-document"],"customParameters")],lt.prototype,"readCustomParameters",null),t([e({json:{origins:{"web-document":{read:{source:"wmtsInfo.customLayerParameters"},write:{target:"wmtsInfo.customLayerParameters"}},"portal-item":{read:{source:"wmtsInfo.customLayerParameters"},write:{target:"wmtsInfo.customLayerParameters"}}}}})],lt.prototype,"customLayerParameters",void 0),t([e({type:i,json:{write:{ignoreOrigin:!0},origins:{"web-document":{read:{source:"fullExtent"}},"portal-item":{read:{source:"fullExtent"}}}}})],lt.prototype,"fullExtent",void 0),t([e({readOnly:!0})],lt.prototype,"fullExtents",null),t([e({type:["WebTiledLayer"]})],lt.prototype,"operationalLayerType",void 0),t([e()],lt.prototype,"resourceInfo",void 0),t([e()],lt.prototype,"serviceMode",void 0),t([n(["portal-item","web-document"],"serviceMode",["templateUrl"])],lt.prototype,"readServiceMode",null),t([e({type:l.ofType(D)})],lt.prototype,"sublayers",void 0),t([n("service","sublayers",["layers"])],lt.prototype,"readSublayersFromService",null),t([e({readOnly:!0})],lt.prototype,"supportedSpatialReferences",null),t([e({json:{read:{source:"title"}}})],lt.prototype,"title",null),t([e({json:{read:!1},readOnly:!0,value:"wmts"})],lt.prototype,"type",void 0),t([e({json:{origins:{service:{read:{source:"tileUrl"}},"web-document":{read:{source:"wmtsInfo.url"},write:{target:"wmtsInfo.url"}},"portal-item":{read:{source:"wmtsInfo.url"},write:{target:"wmtsInfo.url"}}}}})],lt.prototype,"url",null),t([e()],lt.prototype,"version",void 0),lt=t([r("esri.layers.WMTSLayer")],lt);const ot=lt;export default ot;