import{e as t,d as e,i as s,p as i,aq as r,bE as a,bd as n,J as o,A as h,c as p,I as u,c9 as l,a as c,V as d,s as f,S as m,_ as y,bm as j,a7 as b,K as g,D as w,b as v,af as _,P as F,aF as q}from"./p-e58503d5.js";import{h as S}from"./p-54330161.js";import"./p-b79fcce3.js";import{r as R}from"./p-0bb41218.js";import{y as I}from"./p-6a92ecb9.js";import{s as x,a as E}from"./p-b6fa3228.js";import O from"./p-dc852195.js";import{b as C}from"./p-5e833dfc.js";import{N as T}from"./p-47e1bd73.js";import{l as V}from"./p-728f106f.js";import{e as P,a as U,b as A,f as $,m as N,i as M,M as L}from"./p-c5443b47.js";import{a as H,b as D}from"./p-75cd09f2.js";import{u as k}from"./p-480e5606.js";import{e as J}from"./p-77b9a0fc.js";import{O as B}from"./p-0d085df1.js";import{u as z}from"./p-a63f7978.js";import{i as G}from"./p-07ab8db5.js";import{o as K}from"./p-db4d63dc.js";import"./p-53bb6ab4.js";import"./p-93765525.js";import"./p-765e6c28.js";import"./p-a9a30646.js";import"./p-8747982c.js";import"./p-8bc9b36a.js";import"./p-7a658388.js";import"./p-e273719b.js";import"./p-74de0937.js";import"./p-2f398ed1.js";import"./p-d3105731.js";import"./p-fb38a9d0.js";import"./p-f94762ac.js";import"./p-ea916a39.js";import"./p-8a919d07.js";import"./p-efbca0ca.js";import"./p-c048b814.js";import"./p-a24f7752.js";import"./p-ccdb8e80.js";import"./p-7a5bfd29.js";import"./p-1ab449fc.js";import"./p-a6c8fb32.js";import"./p-6b2eb7a7.js";import"./p-01e5a461.js";import"./p-0edb3309.js";import"./p-e8160b60.js";import"./p-2e8ad983.js";import"./p-1f81b35d.js";import"./p-a131049b.js";import"./p-a2324023.js";import"./p-56ca6f1f.js";import"./p-6484267b.js";import"./p-400ca3dc.js";import"./p-9b7a2176.js";import"./p-e654504b.js";import"./p-0eb619a6.js";import"./p-4d17d2cd.js";import"./p-b5b00e38.js";import"./p-e94b450b.js";import"./p-7731c620.js";import"./p-5d962998.js";import"./p-1189fa83.js";import"./p-37058f88.js";import"./p-3e39c093.js";import"./p-7d081d01.js";import"./p-afac6fb2.js";import"./p-ca295674.js";import"./p-41f2b2dd.js";import"./p-612a2c14.js";import"./p-d443df87.js";import"./p-7ca40eac.js";import"./p-9087b4d3.js";import"./p-c1cd5521.js";import"./p-ca4492df.js";import"./p-9d34911e.js";import"./p-182bb5be.js";import"./p-db87794e.js";import"./p-2db4840f.js";import"./p-bba8b671.js";import"./p-ff2962f5.js";import"./p-da9e7ba9.js";import"./p-a8f0aa27.js";import"./p-4a96de15.js";import"./p-5032dfbd.js";import"./p-a87cccba.js";import"./p-dae095dd.js";import"./p-0e784e4d.js";import"./p-dbdf15fc.js";import"./p-e0d9ff4c.js";import"./p-08e5f531.js";import"./p-dfc6337f.js";import"./p-9f1c2d50.js";import"./p-889f7a78.js";import"./p-81b9df84.js";import"./p-5ce39624.js";import"./p-e9bae5e9.js";import"./p-b0565d49.js";import"./p-51a17e75.js";import"./p-d208934e.js";import"./p-22c9f19c.js";import"./p-c096b5df.js";import"./p-da33e926.js";import"./p-4a6dc5e4.js";import"./p-e3270d48.js";import"./p-e44bd0a6.js";import"./p-fe68aab5.js";import"./p-c6970847.js";import"./p-de86b3c9.js";import"./p-37d3434c.js";import"./p-120b7410.js";import"./p-b1eff69d.js";import"./p-612de336.js";import"./p-91fe06d4.js";import"./p-ab0e9273.js";import"./p-15a9486c.js";import"./p-2ae44317.js";import"./p-9f58a277.js";import"./p-9e860e7b.js";import"./p-f3659a34.js";import"./p-ca657fcf.js";import"./p-b312c1fd.js";import"./p-b8beb0d3.js";import"./p-2a99994a.js";import"./p-76f37e40.js";import"./p-eee9ef50.js";import"./p-6ded4c02.js";import"./p-1e473dab.js";import"./p-d1d9dbe4.js";import"./p-d57f9971.js";import"./p-b9aa4901.js";import"./p-e6fe5d89.js";import"./p-56ed1c7a.js";import"./p-746a9d8f.js";import"./p-1c2ff3a7.js";import"./p-e3500fdc.js";import"./p-0bb84768.js";import"./p-b9c93bb2.js";import"./p-3a6cfd25.js";import"./p-1a7268a2.js";import"./p-2d0c34e5.js";import"./p-025c0c8e.js";import"./p-b392deaf.js";import"./p-9790d1b4.js";import"./p-8acbca5b.js";import"./p-dc15ecc1.js";import"./p-0923eebd.js";import"./p-4019eec3.js";import"./p-b05e75b2.js";import"./p-e991a11e.js";import"./p-285c6a34.js";import"./p-e285e8f3.js";import"./p-03d6250d.js";var Q;let W=Q=class extends S{constructor(){super(...arguments),this.isAggregate=!0}getEffectivePopupTemplate(t=!1){if(this.popupTemplate)return this.popupTemplate;const e=this.sourceLayer&&this.sourceLayer.featureReduction;return e&&"popupTemplate"in e&&e.popupEnabled?e.popupTemplate:null}getObjectId(){return this.objectId}clone(){return new Q({objectId:this.objectId,...this.cloneProperties()})}};t([e({type:Boolean})],W.prototype,"isAggregate",void 0),t([e({type:Number,json:{read:!0}})],W.prototype,"objectId",void 0),W=Q=t([s("esri.AggregateGraphic")],W);const X=W;function Y(t){return t.some((t=>t.globalId))}function Z(t){return t.filter((t=>!t.error)).map((t=>{var e;return null!=(e=t.objectId)?e:t.globalId}))}function tt(t,e){const s=new Set(t);for(const t of e.values())s.add(t);return s}function et(t,e){const s=new Set(t);for(const t of e.values())s.delete(t);return s}let st=class extends i{constructor(t){super(),this._hasGlobalIds=!1,this._queueProcessor=new H({concurrency:1,process:t.process})}destroy(){this._queueProcessor.clear()}get updating(){return this._queueProcessor.length>0}push(t){const e=this._queueProcessor,s=e.last();switch(t.type){case"update":case"refresh":if((null==s?void 0:s.type)===t.type)return;e.push(t).finally((()=>this.notifyChange("updating")));break;case"edit":{const i="processed-edit"===(null==s?void 0:s.type)?s:null;i&&e.popLast();const r=this._mergeEdits(i,t);for(const t of r)e.push(t).finally((()=>this.notifyChange("updating")));break}}this.notifyChange("updating")}_mergeEdits(t,e){var s,i;const{addedFeatures:r,deletedFeatures:a,updatedFeatures:n}=e.edits;if(this._hasGlobalIds=this._hasGlobalIds||Y(r)||Y(n)||Y(a),this._hasGlobalIds)return[t,{type:"processed-edit",edits:{addOrModified:[...r,...n],removed:a}}];const o=new Set(Z(null!=(s=null==t?void 0:t.edits.addOrModified)?s:[])),h=new Set(Z(null!=(i=null==t?void 0:t.edits.removed)?i:[])),p=new Set([...Z(r),...Z(n)]),u=new Set(Z(a));return[{type:"processed-edit",edits:{addOrModified:Array.from(tt(et(o,u),p)).map((t=>({objectId:t}))),removed:Array.from(tt(et(h,p),u)).map((t=>({objectId:t})))}}]}};t([e({readOnly:!0})],st.prototype,"updating",null),st=t([s("esri.views.2d.layers.support.FeatureCommandQueue")],st);const it=st;let rt=class extends r{constructor(t){super(t),this._startupResolver=a(),this.isReady=!1}initialize(){this._controller=new AbortController,this.addResolvingPromise(this._startWorker(this._controller.signal))}destroy(){this._controller.abort(),this._connection&&this._connection.close()}set tileRenderer(t){this.client.tileRenderer=t}get closed(){return this._connection.closed}async startup(t,e,s,i){await this.when();const r=this._controller.signal,a=function(t){return Array.isArray(t)}(s.source)?{transferList:s.source,signal:r}:void 0,n={service:s,config:e,tileInfo:t.tileInfo.toJSON(),tiles:i};await this._connection.invoke("startup",n,a),this._startupResolver.resolve(),this._set("isReady",!0)}async updateTiles(t){return await this._startupResolver.promise,n(this._connection.invoke("updateTiles",t))}async update(t){const e={config:t};return await this._startupResolver.promise,this._connection.invoke("update",e)}async applyUpdate(t){return await this._startupResolver.promise,this._connection.invoke("applyUpdate",t)}async setHighlight(t){return await this._startupResolver.promise,n(this._connection.invoke("controller.setHighlight",t))}async refresh(){return await this._startupResolver.promise,n(this._connection.invoke("controller.refresh"))}async querySummaryStatistics(t,e,s){return await this._startupResolver.promise,this._connection.invoke("controller.querySummaryStatistics",{query:t.toJSON(),params:e},s)}async queryUniqueValues(t,e,s){return await this._startupResolver.promise,this._connection.invoke("controller.queryUniqueValues",{query:t.toJSON(),params:e},s)}async queryClassBreaks(t,e,s){return await this._startupResolver.promise,this._connection.invoke("controller.queryClassBreaks",{query:t.toJSON(),params:e},s)}async queryFeatures(t,e){return await this._startupResolver.promise,this._connection.invoke("controller.queryFeatures",t.toJSON(),e)}async queryObjectIds(t,e){return await this._startupResolver.promise,this._connection.invoke("controller.queryObjectIds",t.toJSON(),e)}async queryFeatureCount(t,e){return await this._startupResolver.promise,this._connection.invoke("controller.queryFeatureCount",t.toJSON(),e)}async queryExtent(t,e){return this._connection.invoke("controller.queryExtent",t.toJSON(),e)}async queryLatestObservations(t,e){return await this._startupResolver.promise,this._connection.invoke("controller.queryLatestObservations",t.toJSON(),e)}async queryStatistics(t){return await this._startupResolver.promise,this._connection.invoke("controller.queryStatistics",t)}async getObjectId(t){return await this._startupResolver.promise,this._connection.invoke("controller.getObjectId",t)}async getDisplayId(t){return await this._startupResolver.promise,this._connection.invoke("controller.getDisplayId",t)}async getFeature(t){return await this._startupResolver.promise,this._connection.invoke("controller.getFeature",t)}async getAggregate(t){return await this._startupResolver.promise,this._connection.invoke("controller.getAggregate",t)}async getAggregates(){return await this._startupResolver.promise,this._connection.invoke("controller.getAggregates")}async getAggregateValueRanges(){return await this._startupResolver.promise,this._connection.invoke("controller.getAggregateValueRanges")}async mapValidDisplayIds(t){return await this._startupResolver.promise,this._connection.invoke("controller.mapValidDisplayIds",t)}async onEdits(t){return await this._startupResolver.promise,n(this._connection.invoke("controller.onEdits",t))}async enableEvent(t,e){return await this._startupResolver.promise,n(this._connection.invoke("controller.enableEvent",{name:t,value:e}))}async _startWorker(t){try{this._connection=await k("Pipeline",{client:this.client,strategy:"dedicated",signal:t})}catch(t){o(t)}}};t([e()],rt.prototype,"isReady",void 0),t([e()],rt.prototype,"client",void 0),t([e()],rt.prototype,"tileRenderer",null),rt=t([s("esri.views.2d.layers.support.FeatureLayerProxy")],rt);const at=rt;class nt{constructor(t){this._tiles=new Map,this.buffer=0,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,this.buffer=t.buffer}destroy(){}clear(){this._tiles.forEach((t=>this._releaseTile(t)))}tileKeys(){const t=[];return this._tiles.forEach(((e,s)=>t.push(s))),t}update(t){const e=this.tileInfoView.getTileCoverage(t.state,this.buffer,"closest"),{spans:s,lodInfo:i}=e,{level:r}=i,a=[],n=[],o=new Set,h=new Set;for(const{row:t,colFrom:e,colTo:n}of s)for(let s=e;s<=n;s++){const e=J.getId(r,t,i.normalizeCol(s),i.getWorldForColumn(s)),n=this._getOrAcquireTile(a,e);o.add(e),n.isReady?n.visible=!0:h.add(n.key)}return h.forEach((t=>this._addPlaceholders(o,t))),this._tiles.forEach((t=>{o.has(t.key.id)||(n.push(t.key.id),this._releaseTile(t))})),D.pool.release(e),{hasMissingTiles:h.size>0,added:a,removed:n}}_getOrAcquireTile(t,e){if(!this._tiles.has(e)){const s=this.acquireTile(new J(e));t.push(e),this._tiles.set(e,s),s.visible=!1}return this._tiles.get(e)}_getTile(t){return this._tiles.get(t)}_releaseTile(t){this._tiles.delete(t.key.id),this.releaseTile(t)}_addPlaceholders(t,e){const s=this._addPlaceholderChildren(t,e);Math.abs(1-s)<1e-6||this._addPlaceholderParent(t,e)||(this._getTile(e.id).visible=!0)}_addPlaceholderChildren(t,e){let s=0;return this._tiles.forEach((i=>{s+=this._addPlaceholderChild(t,i,e)})),s}_addPlaceholderChild(t,e,s){return e.key.level<=s.level||!e.hasData||!s.contains(e.key)?0:(e.visible=!0,t.add(e.key.id),1/(1<<2*(e.key.level-s.level)))}_addPlaceholderParent(t,e){let s=e.getParentKey(),i=0,r=null;for(;h(s);){if(t.has(s.id))return!0;const e=this._getTile(s.id);if(null!=e&&e.isReady)return e.visible=!0,t.add(e.key.id),!0;null!=e&&e.hasData&&e.patchCount>i&&(i=e.patchCount,r=e),s=s.getParentKey()}return!!r&&(r.visible=!0,t.add(r.key.id),!0)}}function ot(t){return t&&"openPorts"in t}const ht=p.getLogger("esri.views.2d.layers.FeatureLayerView2D");let pt=class extends(B(G(V(z)))){constructor(){super(...arguments),this._pipelineIsUpdating=!0,this._commandsQueue=new it({process:t=>{switch(t.type){case"processed-edit":return this._doEdit(t);case"refresh":return this._doRefresh();case"update":return this._doUpdate()}}}),this._visibilityOverrides=new Set,this._highlightIds=new Map,this._lastPixelBuffer=0,this._updateHighlight=u((async()=>this._proxy.setHighlight(Array.from(this._highlightIds.keys())))),this._uploadsLocked=!1,this._needsClusterSizeUpdate=!1,this.effectLists={included:new R,excluded:new R}}destroy(){var t,e;l(this._updateClusterSizeTask,(t=>t.remove())),null==(t=this._proxy)||t.destroy(),null==(e=this.tileRenderer)||e.destroy(),this._commandsQueue.destroy()}initialize(){this.addResolvingPromise(Promise.all([this._initProxy(),this._initServiceOptions()])),this.handles.add([this.on("valueRangesChanged",(t=>{this._set("_aggregateValueRanges",t.valueRanges)})),c(this,"featureEffect",(t=>{var e,s;this.effectLists.included.effect=d(null==(e=d(t))?void 0:e.includedEffect),this.effectLists.excluded.effect=d(null==(s=d(t))?void 0:s.excludedEffect)}))])}async _initProxy(){if("isTable"in this.layer&&this.layer.isTable)throw new f("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:this.layer});this._proxy&&this._proxy.destroy();const t=this._createClientOptions();return this._set("_proxy",new at({client:t})),this._proxy.when()}async _initServiceOptions(){this._set("_serviceOptions",await this._createServiceOptions())}get orderByFields(){return"stream"!==this._serviceOptions.type&&this._serviceOptions.orderByFields}get labelsVisible(){return!this.suspended&&("subtype-group"===this.layer.type?this.layer.sublayers.items:[this.layer]).some((t=>t.labelingInfo&&t.labelsVisible))}get queryMode(){return this._serviceOptions.type}get renderingConfigHash(){if(!this.layer)return null;const t=this.availableFields,e=this.layer,s=this.view.floors,{definitionExpression:i}=e,r="subtype-group"!==this.layer.type&&this.layer.labelsVisible&&this.layer.labelingInfo,a="renderer"in e&&e.renderer,n="feature"===e.type?e.gdbVersion:void 0,o="feature"===e.type&&e.historicMoment?e.historicMoment.getTime():void 0,{timeExtent:p}=this,u="customParameters"in e?JSON.stringify(e.customParameters):void 0,l="apiKey"in e?e.apiKey:void 0,c="stream"===e.type?`${JSON.stringify(e.geometryDefinition)}${e.definitionExpression}`:null,d=JSON.stringify(this.clips),f=e.featureReduction&&e.featureReduction.toJSON(),m="orderBy"in this.layer&&JSON.stringify(this.layer.orderBy),y="sublayers"in this.layer&&this.layer.sublayers.items.reduce(((t,e)=>t+`${e.visible?1:0}.${JSON.stringify(e.renderer)}.${e.labelsVisible}\n.${JSON.stringify(e.labelingInfo)}`),"");return JSON.stringify({orderBy:m,sublayerHash:y,filterHash:h(this.filter)&&this.filter.toJSON(),effectHash:h(this.featureEffect)&&this.featureEffect.toJSON(),streamFilter:c,gdbVersion:n,definitionExpression:i,historicMoment:o,availableFields:t,renderer:a,labelingInfo:r,timeExtent:p,floors:s,clipsHash:d,featureReduction:f,customParameters:u,apiKey:l})}get hasEffects(){return this.effectLists.included.hasEffects||this.effectLists.excluded.hasEffects}highlight(t){let e;return t instanceof S?e=[t.getObjectId()]:"number"==typeof t||"string"==typeof t?e=[t]:m.isCollection(t)?e=t.map((t=>t&&t.getAttribute(this.layer.objectIdField))).toArray():Array.isArray(t)&&t.length>0&&(e="number"==typeof t[0]||"string"==typeof t[0]?t:t.map((t=>t&&t.getAttribute(this.layer.objectIdField)))),e&&e.length?(e=e.filter((t=>null!=t)),this._addHighlight(e),{remove:()=>this._removeHighlight(e)}):{remove:()=>{}}}hasHighlight(){return!!this._highlightIds.size}hitTest(t,e){return this._hitTest(t,e)}async queryAggregates(){return(await this._proxy.getAggregates()).map((t=>X.fromJSON(t)))}queryStatistics(){return this._proxy.queryStatistics()}async querySummaryStatistics(t,e,s){const i={...e,scale:this.view.scale};return this._proxy.querySummaryStatistics(this._cleanUpQuery(t),i,s)}async queryUniqueValues(t,e,s){const i={...e,scale:this.view.scale};return this._proxy.queryUniqueValues(this._cleanUpQuery(t),i,s)}async queryClassBreaks(t,e,s){const i={...e,scale:this.view.scale};return this._proxy.queryClassBreaks(this._cleanUpQuery(t),i,s)}queryFeatures(t,e){return this.queryFeaturesJSON(t,e).then((t=>{const e=O.fromJSON(t);return e.features.forEach((t=>this._setLayersForFeature(t))),e}))}queryFeaturesJSON(t,e){return this._proxy.queryFeatures(this._cleanUpQuery(t),e)}queryObjectIds(t,e){return this._proxy.queryObjectIds(this._cleanUpQuery(t),e)}queryFeatureCount(t,e){return this._proxy.queryFeatureCount(this._cleanUpQuery(t),e)}queryExtent(t,e){return this._proxy.queryExtent(this._cleanUpQuery(t),e).then((t=>({count:t.count,extent:y.fromJSON(t.extent)})))}setVisibility(t,e){e?this._visibilityOverrides.delete(t):this._visibilityOverrides.add(t),this._update()}update(t){if(!this._tileStrategy||!this.tileRenderer)return;const{hasMissingTiles:e,added:s,removed:i}=this._tileStrategy.update(t);(s.length||i.length)&&this._proxy.updateTiles({added:s,removed:i}),e&&this.requestUpdate(),this.notifyChange("updating")}attach(){this.view.timeline.record(`${this.layer.title} (FeatureLayer) Attach`),this._tileStrategy=new nt({acquireTile:t=>this._acquireTile(t),releaseTile:t=>this._releaseTile(t),tileInfoView:this.view.featuresTilingScheme,buffer:0}),this.handles.add(c(this,"renderingConfigHash",(()=>this._update())),"attach"),"stream"!==this.layer.type&&this.handles.add(this.layer.on("edits",(t=>this._edit(t))),"attach")}detach(){this.container.removeAllChildren(),this.handles.remove("attach"),this.tileRenderer&&(this.tileRenderer.uninstall(this.container),this.tileRenderer=null),this._tileStrategy&&(this._tileStrategy.destroy(),this._tileStrategy=null),this._tileRendererHash=null}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}async fetchPopupFeatures(t,e){if(h(e)&&e.clientGraphics.length){const t=e.clientGraphics[0];if(t instanceof X)return[t];e.clientGraphics=e.clientGraphics.filter((t=>{const{layer:e}=t;return"popupEnabled"in e&&e.popupEnabled&&("popupTemplate"in e&&e.popupTemplate||this.view.popup.defaultPopupTemplateEnabled)}))}const s=this.validateFetchPopupFeatures(e);if(s)throw s;if(h(e)&&0===e.clientGraphics.length)return[];const i=this.fetchClientPopupFeatures(e);if(!t)return i;const r=this._fetchServicePopupFeatures(t,e);return j([i,r]).then(b)}async _fetchServicePopupFeatures(t,e){if("stream"===this.layer.type||"ogc-feature"===this.layer.type)return[];const s=await this.createPopupQuery(e),{layer:i}=this,r="renderer"in i&&i.renderer,a=h(e)?e.event:null,n=x({renderer:r,event:a});s.geometry=this.createFetchPopupFeaturesQueryGeometry(t,n);const o=new Set,{objectIdField:p}=i,u=h(e)?e.clientGraphics:null;if(u)for(const t of u)o.add(t.attributes[p]);return i.queryFeatures(s).then((t=>t.features.filter((t=>!o.has(t.attributes[p])))))}createFetchPopupFeaturesQueryGeometry(t,e){return E(t,e,this.view)}isUpdating(){var t;const e="renderer"in this.layer&&null!=this.layer.renderer,s=this._commandsQueue.updating,i=null!=this._updatingRequiredFieldsPromise,r=!this._proxy||!this._proxy.isReady,a=this._pipelineIsUpdating,n=null===this.tileRenderer||(null==(t=this.tileRenderer)?void 0:t.updating),o=e&&(s||i||r||a||n);return g("esri-2d-log-updating")&&console.log(`Updating FLV2D: ${o}\n  -> hasRenderer ${e}\n  -> hasPendingCommand ${s}\n  -> updatingRequiredFields ${i}\n  -> updatingProxy ${r}\n  -> updatingPipeline ${a}\n  -> updatingTileRenderer ${n}\n`),o}_createClientOptions(){return{setUpdating:t=>{this._set("_pipelineIsUpdating",t)},emitEvent:t=>{this.emit(t.name,t.event)}}}async _detectQueryMode(t){if("path"in t&&("feature"===this.layer.type||"subtype-group"===this.layer.type)&&"point"===this.layer.geometryType&&this.layer.capabilities.query.supportsPagination&&!this.layer.capabilities.operations.supportsEditing&&g("featurelayer-snapshot-enabled"))try{const t=await this.layer.queryFeatureCount();if(t<=g("featurelayer-snapshot-point-min-threshold"))return{mode:"snapshot",featureCount:t};const e=g("featurelayer-snapshot-point-max-threshold"),s=g("featurelayer-snapshot-point-coverage"),i=this.view.extent,r=d(this.layer.fullExtent),a=null==r?void 0:r.clone().intersection(i),n=h(a)?a.width*a.height:0,o=(null==r?void 0:r.width)*(null==r?void 0:r.height),p=0===o?0:n/o;if(t<=e&&p>=s)return{mode:"snapshot",featureCount:t}}catch(t){ht.warn("mapview-feature-layer","Encountered an error when querying for featureCount",{error:t})}return{mode:"on-demand"}}async _createServiceOptions(){var t;const e=this.layer;if("stream"===e.type)return null;const{capabilities:s,objectIdField:i}=e,r=e.fields.map((t=>t.toJSON())),a=h(e.fullExtent)&&e.fullExtent.toJSON(),n=P(e.geometryType),o=e.timeInfo&&e.timeInfo.toJSON()||null,p=e.spatialReference?e.spatialReference.toJSON():null,u="feature"===e.type?e.globalIdField:null;let l;"ogc-feature"===e.type?l=e.source.getFeatureDefinition():ot(e.source)?l=await e.source.openPorts():e.parsedUrl&&(l=w(e.parsedUrl),"dynamicDataSource"in e&&e.dynamicDataSource&&(l.query={layer:JSON.stringify({source:e.dynamicDataSource})}));const c="datesInUnknownTimezone"in this.layer&&this.layer.datesInUnknownTimezone,d=null!=(t="subtypeField"in this.layer&&this.layer.subtypeField)?t:null,{mode:f,featureCount:m}=await this._detectQueryMode(l);let y=this.layer.objectIdField;if("feature"===this.layer.type&&h(this.layer.orderBy)&&this.layer.orderBy.length){const t=!this.layer.orderBy[0].valueExpression&&this.layer.orderBy[0].field;t&&(y=t)}return{type:f,timeReferenceUnknownClient:c,subtypeField:d,featureCount:m,globalIdField:u,maxRecordCount:s.query.maxRecordCount,tileMaxRecordCount:s.query.tileMaxRecordCount,capabilities:s,fields:r,fullExtent:a,geometryType:n,objectIdField:i,source:l,timeInfo:o,spatialReference:p,orderByFields:y}}async _createMemoryServiceOptions(t){const e=await t.openPorts();return{...this._createServiceOptions(),type:"memory",source:e}}_cleanUpQuery(t){const e=C.from(t)||this.createQuery();return e.outSpatialReference||(e.outSpatialReference=this.view.spatialReference),e}async _update(){return this._commandsQueue.push({type:"update"})}async _edit(t){if(this._validateEdit(t))return this._commandsQueue.push({type:"edit",edits:t})}async doRefresh(){return this._commandsQueue.push({type:"refresh"})}_validateEdit(t){const e="globalIdField"in this.layer&&this.layer.globalIdField,s=t.deletedFeatures.some((t=>-1===t.objectId||!t.objectId)),i=e&&this.availableFields.includes(e);return s&&!i?(ht.error(new f("mapview-apply-edits",`Editing the specified service requires the layer's globalIdField, ${e} to be included the layer's outFields for updates to be reflected on the map`)),null):t}async _doUpdate(){try{if(this.destroyed||!this._hasRequiredSupport(this.layer)||!this._tileStrategy)return;const{featureEffect:t,filter:e}=this;await this._updateRequiredFields();const{renderer:s}=this._getEffectiveRenderer();this._set("_effectiveRenderer",s);const i=this._createSchemaConfig(),r=P(this.layer.geometryType),a=await U(s,r,this.container.stage.resourceManager,this.layer.fields,this.layer.spatialReference,this.layer.featureReduction),n=this._createConfiguration(i,e,t);this._lastPixelBuffer=0===a?0:Math.max(a,this._lastPixelBuffer),n.schema.source.pixelBuffer=this._lastPixelBuffer;const o=this._createTileRendererHash(s);if(o!==this._tileRendererHash){await this._initTileRenderer(s);const t=this._serviceOptions;this.tileRenderer.onConfigUpdate(s);const e={added:this._tileStrategy.tileKeys(),removed:[]},i=this.layer;"stream"!==i.type&&ot(i.source)&&(t.source=await i.source.openPorts()),"stream"===i.type&&await this._initServiceOptions(),await this._proxy.startup(this.view.featuresTilingScheme,n,t,e),this.hasHighlight()&&await this._proxy.setHighlight(Array.from(this._highlightIds.keys())),await this._onceTilesUpdated(),this.tileRenderer.onConfigUpdate(s)}else{const t=await this._proxy.update(n);(t.mesh||t.targets.aggregate)&&this._lockGPUUploads();try{await this._proxy.applyUpdate(t)}catch(t){v(t)||ht.error(t)}(t.mesh||t.targets.aggregate)&&this._unlockGPUUploads(),this.tileRenderer.onConfigUpdate(s),this._updateClusterSizeVariable(),this._forceAttributeTextureUpload()}this._tileRendererHash=o,this.tileRenderer.invalidateLabels(),this.requestUpdate()}catch(t){}}async _doEdit(t){try{await this._proxy.onEdits(t)}catch(t){}}async _doRefresh(){this._lockGPUUploads();try{await this._proxy.refresh()}catch(t){}this._unlockGPUUploads()}_updateClusterSizeVariable(){this._needsClusterSizeUpdate&&(this.tileRenderer.onConfigUpdate(this._effectiveRenderer),this._needsClusterSizeUpdate=!1)}_createUpdateClusterSizeTask(t,e){return this.watch("_aggregateValueRanges",(async s=>{this._updateClusterEffectiveRendererSizeVariable(t,e,s),this._needsClusterSizeUpdate=!0,this._uploadsLocked||this._updateClusterSizeVariable()}))}async _updateClusterEffectiveRendererSizeVariable(t,e,s){if(t.dynamicClusterSize&&"visualVariables"in t&&t.visualVariables){const i=A(t.visualVariables);if(h(i)&&"cluster_count"===i.field){const r=t.visualVariables.indexOf(i);t.visualVariables[r]=$(e,s);const a=t.clone();a.dynamicClusterSize=!0,this._set("_effectiveRenderer",a)}}}_getEffectiveRenderer(){const t="renderer"in this.layer&&this.layer.renderer,e=this.layer.featureReduction;if(h(this._updateClusterSizeTask)&&(this._updateClusterSizeTask.remove(),this._updateClusterSizeTask=null),e&&"cluster"===e.type&&N(t)){const s=e,i=[],r=M(i,t,s,this._aggregateValueRanges);return l(this._updateClusterSizeTask,(t=>t.remove())),this._updateClusterSizeTask=this._createUpdateClusterSizeTask(r,s),{renderer:r,aggregateFields:i,featureReduction:e}}return{renderer:t,aggregateFields:[],featureReduction:null}}_acquireTile(t){const e=this.tileRenderer.acquireTile(t);return e.once("attach",(()=>{this.requestUpdate()})),e}_releaseTile(t){this.tileRenderer.releaseTile(t)}async _initTileRenderer(t){const e=await async function(t,e){if(!t)return null;switch(t.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":return new((await import("./p-0c5e2e6f.js")).default)(e);case"heatmap":return new((await import("./p-e3a62ffb.js")).default)(e)}}(t,{layerView:this,tileInfoView:this.view.featuresTilingScheme,layer:this.layer});return this.tileRenderer&&(this._tileStrategy.clear(),this.tileRenderer.uninstall(this.container),this.tileRenderer.destroy(),this.tileRenderer=null),this.destroyed?null:(this._proxy.tileRenderer=e,this._set("tileRenderer",e),this.tileRenderer.install(this.container),this.tileRenderer.onConfigUpdate(t),this.requestUpdate(),this.tileRenderer)}_createTileRendererHash(t){return`${"heatmap"===t.type?"heatmap":"symbol"}.${"dot-density"===t.type}`}_createFeatureDataHash(t,e,s){const i=t.getAttributeHash(),r=JSON.stringify(e),a=h(s)&&JSON.stringify(s.filter),n=JSON.stringify(this.timeExtent);let o="";return this._visibilityOverrides.forEach((t=>o+=t)),`${i}.${r}.${a}.${n}.${o}`}get hasFilter(){return!!(this.filter||"floorInfo"in this.layer&&this.layer.floorInfo&&this.view.floors&&this.view.floors.length||this._visibilityOverrides.size||this.timeExtent)}_injectOverrides(t){const e=h(t)?t.timeExtent:null,s=h(this.timeExtent)&&h(e)?this.timeExtent.intersection(e):this.timeExtent||e;let i=null;const r="floorInfo"in this.layer&&this.layer.floorInfo;if(r){const e=h(t)&&t.where;i=this._addFloorFilterClause(e)}if(!this._visibilityOverrides.size&&!s&&!r)return h(t)?t.toJSON():null;(t=h(t)&&t.clone()||new I).timeExtent=s,i&&(t.where=i);const a=t.toJSON();return a.hiddenIds=Array.from(this._visibilityOverrides),a}_addFloorFilterClause(t){const e=this.layer;let s=t||"";if("floorInfo"in e&&e.floorInfo){var i;let t=this.view.floors;if(!t||!t.length)return s;null!=(i=e.floorInfo.viewAllLevelIds)&&i.length&&(t=e.floorInfo.viewAllLevelIds);const r=t.filter((t=>""!==t)).map((t=>"'"+t+"'"));r.push("''");const a=e.floorInfo.floorField;let n="("+a+" IN ({ids}) OR "+a+" IS NULL)";if(n=n.replace("{ids}",r.join(", ")),h(s)&&s.includes(a)){let t=new RegExp("AND \\("+a+".*NULL\\)","g");s=s.replace(t,""),t=new RegExp("\\("+a+".*NULL\\)","g"),s=s.replace(t,""),s=s.replace(/\s+/g," ").trim()}s=""!==s?"("+s+") AND "+n:n}return""!==s?s:null}_createConfiguration(t,e,s){const i="feature"===this.layer.type&&this.layer.historicMoment?this.layer.historicMoment.getTime():void 0,r="feature"===this.layer.type?this.layer.gdbVersion:void 0,a=new Array(T),n=this._injectOverrides(e);a[0]=n,a[1]=h(s)&&h(s.filter)?s.filter.toJSON():null;const o=L(t);if(_(o))return null;const p=K();return{definitionExpression:this.layer.definitionExpression,availableFields:this.availableFields,gdbVersion:r,historicMoment:i,devicePixelRatio:window.devicePixelRatio||1,filters:a,schema:o,supportsTextureFloat:p.supportsTextureFloat,maxTextureSize:p.maxTextureSize}}_hasRequiredSupport(t){var e;return!("renderer"in t&&"dot-density"===(null==(e=t.renderer)?void 0:e.type)&&!K().supportsTextureFloat&&(ht.error(new f("webgl-missing-extension","Missing WebGL extension OES_Texture_Float which is required for DotDensity")),1))}_onceTilesUpdated(){return this.requestUpdate(),F(this,"_pipelineIsUpdating",!1)}_lockGPUUploads(){this.tileRenderer&&(this._uploadsLocked=!0,this.tileRenderer.lockGPUUploads())}_unlockGPUUploads(){this.tileRenderer&&(this._uploadsLocked=!1,this.tileRenderer.unlockGPUUploads())}_forceAttributeTextureUpload(){this.tileRenderer&&this.tileRenderer.forceAttributeTextureUpload()}_createSchemaConfig(){return{renderer:"renderer"in this.layer&&this.layer.renderer,spatialReference:this.layer.spatialReference,timeExtent:this.layer.timeExtent,definitionExpression:this.layer.definitionExpression,featureReduction:this.layer.featureReduction,fields:this.layer.fields,geometryType:this.layer.geometryType,historicMoment:"feature"===this.layer.type?this.layer.historicMoment:null,labelsVisible:"labelsVisible"in this.layer&&this.layer.labelsVisible,labelingInfo:"labelingInfo"in this.layer&&this.layer.labelingInfo,availableFields:this.availableFields,featureEffect:this.featureEffect,filter:this.filter,gdbVersion:"feature"===this.layer.type?this.layer.gdbVersion:null,pixelBuffer:0,orderBy:"orderBy"in this.layer&&this.layer.orderBy?this.layer.orderBy:null,customParameters:{..."customParameters"in this.layer?this.layer.customParameters:void 0,token:"apiKey"in this.layer?this.layer.apiKey:void 0}}}_addHighlight(t){for(const e of t)if(this._highlightIds.has(e)){const t=this._highlightIds.get(e);this._highlightIds.set(e,t+1)}else this._highlightIds.set(e,1);this._updateHighlight().catch((t=>{v(t)||ht.error(t)}))}_removeHighlight(t){for(const e of t)if(this._highlightIds.has(e)){const t=this._highlightIds.get(e)-1;0===t?this._highlightIds.delete(e):this._highlightIds.set(e,t)}this._updateHighlight().catch((t=>{v(t)||ht.error(t)}))}_setLayersForFeature(t){const e=this.layer;t.layer=e,t.sourceLayer=e}_createHittestResult(t){return this._setLayersForFeature(t),h(t.geometry)&&(t.geometry.spatialReference=this.view.spatialReference),t}async _hitTest(t,e){if(this.suspended||!this.tileRenderer)return null;const s=await this.tileRenderer.hitTest(t,e);if(0===s.length)return await q(1),null;const i=s[0];if(!(t=>(2147483648&t)>>>31==1)(i)){const t=await this._proxy.getFeature(i);return l(t,(t=>this._createHittestResult(S.fromJSON(t))))}const r=await this._proxy.getAggregate(i);if(_(r))return null;if(h(r.referenceId)){const t=await this._proxy.getFeature(r.referenceId);return l(t,(t=>this._createHittestResult(S.fromJSON(t))))}return this._createHittestResult(X.fromJSON(r))}};t([e()],pt.prototype,"_serviceOptions",void 0),t([e()],pt.prototype,"_proxy",void 0),t([e()],pt.prototype,"_pipelineIsUpdating",void 0),t([e()],pt.prototype,"_effectiveRenderer",void 0),t([e()],pt.prototype,"_aggregateValueRanges",void 0),t([e()],pt.prototype,"_commandsQueue",void 0),t([e()],pt.prototype,"labelsVisible",null),t([e({readOnly:!0})],pt.prototype,"queryMode",null),t([e()],pt.prototype,"renderingConfigHash",null),t([e()],pt.prototype,"tileRenderer",void 0),t([e()],pt.prototype,"updating",void 0),pt=t([s("esri.views.2d.layers.FeatureLayerView2D")],pt);const ut=pt;export default ut;