import{O as t,a7 as s,N as i,a0 as e,t as h,r,_ as n,k as o,c0 as a,v as c,m as l,a as f,H as u,e as p,d,i as m}from"./p-9ae46e68.js";import{h as y}from"./p-566b0715.js";import{m as w,a as g}from"./p-30ddb3a0.js";import{u as b}from"./p-81e5b36e.js";import{u as j}from"./p-4681e856.js";import{h as M,f as v}from"./p-81abd5fc.js";import{o as A}from"./p-7c7c5507.js";import{t as T}from"./p-2d0c34e5.js";import{a as x}from"./p-c7a0a732.js";import{O as _}from"./p-128c292d.js";import{e as S}from"./p-2b250922.js";import{e as U}from"./p-4b3ae2cf.js";import{b as I,h as D}from"./p-1f10277d.js";import{r as k,M as P,h as R,f as C}from"./p-39da60a5.js";import{n as L,g as O}from"./p-7a648ea5.js";import{e as F,t as z,c as B}from"./p-4414d64f.js";import{r as q,o as V}from"./p-dd4e6b8b.js";import{I as N}from"./p-16def889.js";import{a as $}from"./p-b4a5d2e9.js";import{l as H,u as K}from"./p-ebe5e529.js";import{g as G}from"./p-fe4caffe.js";import{t as W}from"./p-71e3657b.js";import{j as J}from"./p-523f37cd.js";import{p as Q}from"./p-d18723b0.js";import"./p-84bf99cb.js";import"./p-fe01b82b.js";import"./p-47e1bd73.js";import"./p-d6725707.js";import"./p-d925341f.js";import"./p-56ed1c7a.js";import"./p-b392deaf.js";import"./p-9790d1b4.js";import"./p-3a2e88bf.js";import"./p-285c6a34.js";import"./p-f42060e0.js";import"./p-79553c8d.js";import"./p-8e03c038.js";import"./p-32462343.js";import"./p-b2a0fae5.js";import"./p-6ebb24ba.js";import"./p-4fd6e394.js";import"./p-a0e42f29.js";import"./p-41655335.js";import"./p-3ffd0931.js";import"./p-8031c809.js";import"./p-3048cc18.js";import"./p-b2d0e2de.js";import"./p-db87794e.js";import"./p-22c8d854.js";import"./p-3d1b25b6.js";import"./p-98a14d68.js";import"./p-32824614.js";import"./p-40d3b500.js";import"./p-c8f716a9.js";import"./p-57ae469d.js";import"./p-27ef204b.js";import"./p-9e860e7b.js";import"./p-ada83011.js";import"./p-98ce0cca.js";import"./p-4003c7ae.js";import"./p-a7080451.js";import"./p-7e9d2371.js";import"./p-94f8dc11.js";import"./p-bb07d873.js";import"./p-8ac97b63.js";import"./p-a0a931f0.js";import"./p-dfc6337f.js";import"./p-77e6a663.js";import"./p-c5b7f7c3.js";import"./p-74fc1b7f.js";import"./p-b3024dec.js";import"./p-4fcbc3c5.js";import"./p-6443bfb4.js";import"./p-8e6daf54.js";import"./p-c0757461.js";import"./p-93d9099f.js";import"./p-d3898fd7.js";import"./p-844dad6c.js";import"./p-c59d0a4d.js";import"./p-3a5fe179.js";import"./p-138c2b2c.js";import"./p-ae0b06e3.js";import"./p-a293872e.js";import"./p-f271906a.js";import"./p-cf2267f9.js";import"./p-d2e19070.js";import"./p-e5429b9e.js";import"./p-cf8dc9be.js";import"./p-f17028ec.js";import"./p-5c89c68e.js";import"./p-725fd184.js";import"./p-0c91ebaf.js";import"./p-72355290.js";import"./p-d68829c1.js";import"./p-81102839.js";import"./p-2f7c985e.js";import"./p-00b9ea57.js";import"./p-5a0fe1d0.js";import"./p-7818def0.js";import"./p-da143060.js";import"./p-15bb2887.js";import"./p-1d6f3ddb.js";import"./p-789e71c1.js";import"./p-a198d6d0.js";import"./p-15515b8a.js";import"./p-264c75ac.js";import"./p-c431b12a.js";import"./p-b0f556d6.js";import"./p-8b767e6c.js";import"./p-8d03d70f.js";import"./p-9658240e.js";import"./p-c3efb223.js";import"./p-bae36c84.js";import"./p-b62a8a4f.js";import"./p-f614dce4.js";import"./p-6ab16fcc.js";import"./p-0c60bcc4.js";import"./p-d40c97c9.js";import"./p-eb19a862.js";import"./p-a617738c.js";import"./p-ffe0d3ad.js";import"./p-9dbf3f05.js";import"./p-97ec6ae5.js";import"./p-e4802f24.js";class E{constructor(t,s){this._width=0,this._height=0,this._free=[],this._width=t,this._height=s,this._free.push(new T(0,0,t,s))}get width(){return this._width}get height(){return this._height}allocate(t,s){if(t>this._width||s>this._height)return new T;let i=null,e=-1;for(let h=0;h<this._free.length;++h){const r=this._free[h];t<=r.width&&s<=r.height&&(null===i||r.y<=i.y&&r.x<=i.x)&&(i=r,e=h)}return null===i?new T:(this._free.splice(e,1),i.width<i.height?(i.width>t&&this._free.push(new T(i.x+t,i.y,i.width-t,s)),i.height>s&&this._free.push(new T(i.x,i.y+s,i.width,i.height-s))):(i.width>t&&this._free.push(new T(i.x+t,i.y,i.width-t,i.height)),i.height>s&&this._free.push(new T(i.x,i.y+s,t,i.height-s))),new T(i.x,i.y,t,s))}release(t){for(let s=0;s<this._free.length;++s){const i=this._free[s];if(i.y===t.y&&i.height===t.height&&i.x+i.width===t.x)i.width+=t.width;else if(i.x===t.x&&i.width===t.width&&i.y+i.height===t.y)i.height+=t.height;else if(t.y===i.y&&t.height===i.height&&t.x+t.width===i.x)i.x=t.x,i.width+=t.width;else{if(t.x!==i.x||t.width!==i.width||t.y+t.height!==i.y)continue;i.y=t.y,i.height+=t.height}this._free.splice(s,1),this.release(t)}this._free.push(t)}}class X{constructor(t,s,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphIndex={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=s,this._glyphSource=i,this._binPack=new E(t-4,s-4),this._glyphData.push(new Uint8Array(t*s)),this._dirties.push(!0),this._textures.push(void 0)}getGlyphItems(t,s){const i=[],e=this._glyphSource,h=new Set;for(const t of s){const s=Math.floor(.00390625*t);h.add(s)}const r=[];return h.forEach((s=>{if(s<=256){const i=t+s;if(this._rangePromises.has(i))r.push(this._rangePromises.get(i));else{const h=e.getRange(t,s).then((()=>{this._rangePromises.delete(i)}),(()=>{this._rangePromises.delete(i)}));this._rangePromises.set(i,h),r.push(h)}}})),Promise.all(r).then((()=>{let h=this._glyphIndex[t];h||(h={},this._glyphIndex[t]=h);for(const r of s){const s=h[r];if(s){i[r]={sdf:!0,rect:s.rect,metrics:s.metrics,page:s.page,code:r};continue}const n=e.getGlyph(t,r);if(!n||!n.metrics)continue;const o=n.metrics;let a;if(0===o.width)a=new T(0,0,0,0);else{const t=3,s=o.width+2*t,i=o.height+2*t;let e=s%4?4-s%4:4,h=i%4?4-i%4:4;1===e&&(e=5),1===h&&(h=5),a=this._binPack.allocate(s+e,i+h),a.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(void 0),this._binPack=new E(this.width-4,this.height-4),a=this._binPack.allocate(s+e,i+h));const r=this._glyphData[this._currentPage],c=n.bitmap;let l,f;if(c)for(let t=0;t<i;t++){l=s*t,f=this.width*(a.y+t+1)+a.x;for(let t=0;t<s;t++)r[f+t+1]=c[l+t]}}h[r]={rect:a,metrics:o,tileIDs:null,page:this._currentPage},i[r]={sdf:!0,rect:a,metrics:o,page:this._currentPage,code:r},this._dirties[this._currentPage]=!0}return i}))}removeGlyphs(t){for(const s in this._glyphIndex){const i=this._glyphIndex[s];if(!i)continue;let e;for(const s in i)if(e=i[s],e.tileIDs.delete(t),0===e.tileIDs.size){const t=this._glyphData[e.page],h=e.rect;let r,n;for(let s=0;s<h.height;s++)for(r=this.width*(h.y+s)+h.x,n=0;n<h.width;n++)t[r+n]=0;delete i[s],this._dirties[e.page]=!0}}}bind(t,s,i,e=0){this._textures[i]||(this._textures[i]=new A(t,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height)));const h=this._textures[i];h.setSamplingMode(s),this._dirties[i]&&h.setData(this._glyphData[i]),t.bindTexture(h,e),this._dirties[i]=!1}dispose(){this._binPack=null;for(const t of this._textures)t&&t.dispose();this._textures.length=0}}class Y{constructor(t){if(this._metrics=[],this._bitmaps=[],t)for(;t.next();)switch(t.tag()){case 1:{const s=t.getMessage();for(;s.next();)switch(s.tag()){case 3:{const t=s.getMessage();let i,e,h,r,n,o,a;for(;t.next();)switch(t.tag()){case 1:i=t.getUInt32();break;case 2:e=t.getBytes();break;case 3:h=t.getUInt32();break;case 4:r=t.getUInt32();break;case 5:n=t.getSInt32();break;case 6:o=t.getSInt32();break;case 7:a=t.getUInt32();break;default:t.skip()}t.release(),i&&(this._metrics[i]={width:h,height:r,left:n,top:o,advance:a},this._bitmaps[i]=e);break}default:s.skip()}s.release();break}default:t.skip()}}getMetrics(t){return this._metrics[t]}getBitmap(t){return this._bitmaps[t]}}class Z{constructor(){this._ranges=[]}getRange(t){return this._ranges[t]}addRange(t,s){this._ranges[t]=s}}class tt{constructor(t){this._glyphInfo={},this._baseURL=t}getRange(s,i){const e=this._getFontStack(s);if(e.getRange(i))return Promise.resolve();const h=256*i,r=h+255,n=this._baseURL.replace("{fontstack}",s).replace("{range}",h+"-"+r);return t(n,{responseType:"array-buffer"}).then((t=>{e.addRange(i,new Y(new x(new Uint8Array(t.data),new DataView(t.data))))})).catch((()=>{e.addRange(i,new Y)}))}getGlyph(t,s){const i=this._getFontStack(t);if(!i)return;const e=Math.floor(s/256);if(e>256)return;const h=i.getRange(e);return h?{metrics:h.getMetrics(s),bitmap:h.getBitmap(s)}:void 0}_getFontStack(t){let s=this._glyphInfo[t];return s||(s=this._glyphInfo[t]=new Z),s}}class st{constructor(t,s,i=0){this._size=[],this._mosaicsData=[],this._textures=[],this._dirties=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects={},this.pixelRatio=1,(t<=0||s<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=s,i>0&&(this._maxItemSize=i),this._binPack=new E(t-4,s-4)}dispose(){this._binPack=null,this._mosaicRects={};for(const t of this._textures)t&&t.dispose();this._textures.length=0}getWidth(t){return t>=this._size.length?-1:this._size[t][0]}getHeight(t){return t>=this._size.length?-1:this._size[t][1]}getPageSize(t){return t>=this._size.length?null:this._size[t]}setSpriteSource(t){if(this.dispose(),this.pixelRatio=t.devicePixelRatio,0===this._mosaicsData.length){this._binPack=new E(this._pageWidth-4,this._pageHeight-4);const t=Math.floor(this._pageWidth),s=Math.floor(this._pageHeight),i=new Uint32Array(t*s);this._mosaicsData[0]=i,this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0)}this._sprites=t}getSpriteItem(t,s=!1){let i,e,h=this._mosaicRects[t];if(h)return h;if(!this._sprites||"loaded"!==this._sprites.loadStatus)return null;if(t&&t.startsWith("dasharray-")?([i,e]=this._rasterizeDash(t),s=!0):i=this._sprites.getSpriteInfo(t),!i||!i.width||!i.height||i.width<0||i.height<0)return null;const r=i.width,n=i.height,[o,a,c]=this._allocateImage(r,n);return o.width<=0?null:(this._copy(o,i,a,c,s,e),h={rect:o,width:r,height:n,sdf:i.sdf,simplePattern:!1,pixelRatio:i.pixelRatio,page:a},this._mosaicRects[t]=h,h)}getSpriteItems(t){const s={};for(const i of t)s[i.name]=this.getSpriteItem(i.name,i.repeat);return s}getMosaicItemPosition(t,s){const i=this.getSpriteItem(t,s),e=i&&i.rect;return e?(e.width=i.width,e.height=i.height,{tl:[e.x+2,e.y+2],br:[e.x+2+i.width,e.y+2+i.height],page:i.page}):null}bind(t,s,i=0,e=0){this._textures[i]||(this._textures[i]=new A(t,{pixelFormat:6408,dataType:5121,wrapMode:33071,width:this._size[i][0],height:this._size[i][1]},new Uint8Array(this._mosaicsData[i].buffer)));const h=this._textures[i];h.setSamplingMode(s),this._dirties[i]&&h.setData(new Uint8Array(this._mosaicsData[i].buffer)),t.bindTexture(h,e),this._dirties[i]=!1}static _copyBits(t,s,i,e,h,r,n,o,a,c,l){let f=e*s+i,u=o*r+n;if(l){u-=r;for(let n=-1;n<=c;n++,f=((n+c)%c+e)*s+i,u+=r)for(let s=-1;s<=a;s++)h[u+s]=t[f+(s+a)%a]}else for(let i=0;i<c;i++){for(let s=0;s<a;s++)h[u+s]=t[f+s];f+=s,u+=r}}_copy(t,s,i,e,h,r){if(!this._sprites||"loaded"!==this._sprites.loadStatus||i>=this._mosaicsData.length)return;const n=new Uint32Array(r?r.buffer:this._sprites.image.buffer),o=this._mosaicsData[i];o&&n||console.error("Source or target images are uninitialized!"),st._copyBits(n,r?s.width:this._sprites.width,s.x,s.y,o,e[0],t.x+2,t.y+2,s.width,s.height,h),this._dirties[i]=!0}_allocateImage(t,s){t+=2,s+=2;const i=Math.max(t,s);if(this._maxItemSize&&this._maxItemSize<i){const i=new T(0,0,t,s);return this._mosaicsData.push(new Uint32Array(t*s)),this._dirties.push(!0),this._size.push([t,s]),this._textures.push(void 0),[i,this._mosaicsData.length-1,[t,s]]}let e=t%4?4-t%4:4,h=s%4?4-s%4:4;1===e&&(e=5),1===h&&(h=5);const r=this._binPack.allocate(t+e,s+h);return r.width<=0?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new E(this._pageWidth-4,this._pageHeight-4),this._allocateImage(t,s)):[r,this._currentPage,[this._pageWidth,this._pageHeight]]}_rasterizeDash(t){const s=t.match(/\[(.*?)\]/);if(!s)return null;const i=s[1].split(",").map(Number),e=t.slice(t.lastIndexOf("-")+1),[h,r,n]=_.rasterizeDash(i,e);return[{x:0,y:0,width:r,height:n,sdf:!0,pixelRatio:1},new Uint8Array(h.buffer)]}}function it(t,s,i,e,h,r){t.fillStyle=s,t.fillRect(i,e,h,r)}function et(t,s,i,e,h,r){t.strokeStyle=s,t.strokeRect(i,e,h,r)}function ht(t,s){const i=window.COLLISION_XRAY;for(let e=0;e<s.length;++e){const h=!s[e].unique.show;if(i||!h)for(const r of s[e].colliders){if(!r.enabled)continue;const n=!s[e].unique.parts[r.partIndex].show;if(!i&&n)continue;const o=r.xScreen,a=r.yScreen,c=r.dxScreen,l=r.dyScreen;t.globalAlpha=h||n?.2:1,it(t,"green",o-1,a-1,3,3),et(t,"red",o+c,a+l,r.width,r.height),it(t,"blue",o+c-1,a+l-1,3,3),t.globalAlpha=1}}}class rt{constructor(t,s,i){this._layer=t,this._styleRepository=s,this.devicePixelRatio=i,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null}destroy(){this._connection&&(this._connection.close(),this._connection=null),this._styleRepository=null,this._layer=null,this._spriteMosaic&&(this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic=null)}get spriteMosaic(){return this._spriteSourcePromise.then((()=>this._spriteMosaic))}get glyphMosaic(){return this._glyphMosaic}async start(t){this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,t),this._spriteSourcePromise.then((t=>{this._spriteMosaic=new st(1024,1024,250),this._spriteMosaic.setSpriteSource(t)}));const i=new tt(this._styleRepository.glyphs);this._glyphMosaic=new X(1024,1024,i),this._broadcastPromise=j("WorkerTileHandler",{client:this,schedule:t.schedule,signal:t.signal}).then((i=>(this._connection=i,Promise.all(this._connection.broadcast("setStyle",{style:this._layer.currentStyleInfo.style,vectorTileLayerMaxBuffers:s("vectortilelayer-max-buffers")},t)))))}async updateStyle(t){return await this._broadcastPromise,this._broadcastPromise=Promise.all(this._connection.broadcast("updateStyle",t)),this._broadcastPromise}async setStyle(t,i){await this._broadcastPromise,this._styleRepository=t,this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,null),this._spriteSourcePromise.then((t=>{this._spriteMosaic=new st(1024,1024,250),this._spriteMosaic.setSpriteSource(t)}));const e=new tt(t.glyphs);return this._glyphMosaic=new X(1024,1024,e),this._broadcastPromise=Promise.all(this._connection.broadcast("setStyle",{style:i,vectorTileLayerMaxBuffers:s("vectortilelayer-max-buffers")})),this._broadcastPromise}fetchTileData(t,s){return this._getRefKeys(t,s).then((t=>{const i=this._layer.sourceNameToSource,e=[];for(const t in i)e.push(t);return this._getSourcesData(e,t,s)}))}parseTileData(t,s){const i=t&&t.data;if(!i)return Promise.resolve(null);const{sourceName2DataAndRefKey:e,transferList:h}=i;return 0===Object.keys(e).length?Promise.resolve(null):this._broadcastPromise.then((()=>this._connection.getAvailableClient().then((i=>i.invoke("createTileAndParse",{key:t.key.id,sourceName2DataAndRefKey:e,styleLayerUIDs:t.styleLayerUIDs},{...s,transferList:h}).then((t=>({tileData:t})))))))}async getSprites(t){return await this._spriteSourcePromise,this._spriteMosaic.getSpriteItems(t)}getGlyphs(t){return this._glyphMosaic.getGlyphItems(t.font,t.codePoints)}perfReport({key:t,milliseconds:s}){!function(t,s){if(!window.PERFORMANCE_RECORDING_STORAGE)return;const i=window.PERFORMANCE_RECORDING_STORAGE;i.perf=i.perf||{};const e=i.perf;e[t]=e[t]||{start:null,time:0,min:void 0,max:void 0,samples:[],unit:"ms"},e[t].time+=s,e[t].samples.push(s),(null==e[t].min||s<e[t].min)&&(e[t].min=s),(null==e[t].max||s>e[t].max)&&(e[t].max=s)}(t,s)}async _getTilePayload(t,s,e){const h=S.pool.acquire(t.id),r=this._layer.sourceNameToSource[s].getSourceTileUrl(h.level,h.row,h.col);S.pool.release(h);try{return{protobuff:await this.request(r,e),sourceName:s}}catch(t){if(i(t))throw t;return{protobuff:null,sourceName:s}}}request(s,i){return t(s,{responseType:"array-buffer",...i}).then((({data:t})=>t))}_getRefKeys(t,s){const i=this._layer.sourceNameToSource,h=new Array;for(const e in i){const r=i[e].getRefKey(t,s);h.push(r)}return e(h)}_getSourcesData(t,s,i){const h=[];for(let e=0;e<s.length;e++)if(null==s[e].value||null==t[e])h.push(null);else{const r=this._getTilePayload(s[e].value,t[e],i);h.push(r)}return e(h).then((t=>{const i={},e=[];for(let h=0;h<t.length;h++)t[h].value&&t[h].value&&t[h].value.protobuff&&t[h].value.protobuff.byteLength>0&&(i[t[h].value.sourceName]={refKey:s[h].value.id,protobuff:t[h].value.protobuff},e.push(t[h].value.protobuff));return{sourceName2DataAndRefKey:i,transferList:e}}))}}const nt=(t,s)=>t+1/(1<<2*s);class ot{constructor(t,s){this._tiles=new Map,this._tileCache=new U(40,(t=>t.dispose())),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,this._container=s}destroy(){for(const[t,s]of this._tiles)s.dispose();this._tiles=null,this._tileCache.clear(),this._tileCache=null}update(t){this._updateCacheSize(t);const s=this.tileInfoView,i=s.getTileCoverage(t.state,0,"smallest"),{spans:e,lodInfo:h}=i,{level:r}=h,n=this._tiles,o=new Set,a=new Set;for(const{row:t,colFrom:s,colTo:i}of e)for(let e=s;e<=i;e++){const s=S.getId(r,t,h.normalizeCol(e),h.getWorldForColumn(e)),i=this._getOrAcquireTile(s);o.add(s),i.processed()?this._addToContainer(i):a.add(new S(s))}for(const[t,s]of n)s.isCoverage=o.has(t);for(const t of a)this._findPlaceholdersForMissingTiles(t,o);let c=!1;for(const[t,e]of n)e.neededForCoverage=o.has(t),e.neededForCoverage||e.isHoldingForFade&&s.intersects(i,e.key)&&o.add(t),e.isFading&&(c=!0);for(const[t,s]of this._tiles)o.has(t)||this._releaseTile(t);return I.pool.release(i),!c}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}clearCache(){this._tileCache.clear()}_findPlaceholdersForMissingTiles(t,s){const i=[];for(const[e,h]of this._tiles)this._addPlaceholderChild(i,h,t,s);const e=i.reduce(nt,0);Math.abs(1-e)<1e-6||this._addPlaceholderParent(t.id,s)}_addPlaceholderChild(t,s,i,e){s.key.level<=i.level||!s.hasData()||function(t,s){const i=s.level-t.level;return t.row===s.row>>i&&t.col===s.col>>i&&t.world===s.world}(i,s.key)&&(this._addToContainer(s),e.add(s.id),t.push(s.key.level-i.level))}_addPlaceholderParent(t,s){const i=this._tiles;let e=t;for(;;){if(e=at(e),!e||s.has(e))return;const t=i.get(e);if(t&&t.hasData())return this._addToContainer(t),void s.add(t.id)}}_getOrAcquireTile(t){let s=this._tiles.get(t);return s||(s=this._tileCache.pop(t),s||(s=this.acquireTile(new S(t))),this._tiles.set(t,s),s)}_releaseTile(t){const s=this._tiles.get(t);this.releaseTile(s),this._removeFromContainer(s),this._tiles.delete(t),s.hasData()?this._tileCache.put(t,s,1):s.dispose()}_addToContainer(t){let s;const i=[],e=this._container;if(e.contains(t))return;const n=this._visibleTiles;for(const[e,r]of n)this._canConnectDirectly(t,r)&&i.push(r),h(s)&&this._canConnectDirectly(r,t)&&(s=r);if(r(s)){for(const e of i)s.childrenTiles.delete(e),t.childrenTiles.add(e),e.parentTile=t;s.childrenTiles.add(t),t.parentTile=s}else for(const s of i)t.childrenTiles.add(s),s.parentTile=t;n.set(t.id,t),e.addChild(t)}_removeFromContainer(t){if(this._visibleTiles.delete(t.id),this._container.removeChild(t),r(t.parentTile)){t.parentTile.childrenTiles.delete(t);for(const s of t.childrenTiles)r(t.parentTile)&&t.parentTile.childrenTiles.add(s)}for(const s of t.childrenTiles)s.parentTile=t.parentTile;t.parentTile=null,t.childrenTiles.clear()}_canConnectDirectly(t,s){const i=t.key;let{level:e,row:h,col:r,world:n}=s.key;const o=this._visibleTiles;for(;e>0;){if(e--,h>>=1,r>>=1,i.level===e&&i.row===h&&i.col===r&&i.world===n)return!0;if(o.has(`${e}/${h}/${r}/${n}`))return!1}return!1}_updateCacheSize(t){const s=t.state.size;if(s[0]===this._viewSize[0]&&s[1]===this._viewSize[1])return;const i=Math.ceil(s[0]/512)+1,e=Math.ceil(s[1]/512)+1;this._viewSize[0]=s[0],this._viewSize[1]=s[1],this._tileCache.maxSize=5*i*e}}function at(t){const[s,i,e,h]=t.split("/"),r=parseInt(s,10);return 0===r?null:`${r-1}/${parseInt(i,10)>>1}/${parseInt(e,10)>>1}/${parseInt(h,10)}`}class ct{constructor(t){this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=t}}class lt{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}}function ft(t,s,i,e,h,r){const n=i-h;if(n>=0)return(s>>n)+(e-(r<<n))*(t>>n);const o=-n;return s-(r-(e<<o))*(t>>o)<<o}class ut{constructor(t,s,i){this._rows=Math.ceil(s/i),this._columns=Math.ceil(t/i),this._cellSize=i,this.cells=new Array(this._rows);for(let t=0;t<this._rows;t++){this.cells[t]=new Array(this._columns);for(let s=0;s<this._columns;s++)this.cells[t][s]=[]}}getCell(t,s){const i=Math.min(Math.max(Math.floor(s/this._cellSize),0),this._rows-1),e=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._columns-1);return this.cells[i]&&this.cells[i][e]||null}getCellSpan(t,s,i,e){return[Math.min(Math.max(Math.floor(t/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(e/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}}function pt(t,s,i,e,h){const r=t.layerData.get(h);if(3===r.type){for(const s of e){const e=s.unique;let h;if(s.selectedForRendering){const s=e.parts[0],r=s.startOpacity,n=s.targetOpacity;t.allSymbolsFadingOut=t.allSymbolsFadingOut&&0===n;const o=i?Math.floor(127*r)|n<<7:n?255:0;h=o<<24|o<<16|o<<8|o}else h=0;for(const[t,i]of s.iconVertexRanges)for(let s=t;s<t+i;s+=4)r.iconOpacity[s/4]=h;if(s.selectedForRendering){const s=e.parts[1],r=s.startOpacity,n=s.targetOpacity;t.allSymbolsFadingOut=t.allSymbolsFadingOut&&0===n;const o=i?Math.floor(127*r)|n<<7:n?255:0;h=o<<24|o<<16|o<<8|o}else h=0;for(const[t,i]of s.textVertexRanges)for(let s=t;s<t+i;s+=4)r.textOpacity[s/4]=h}r.lastOpacityUpdate=s,r.opacityChanged=!0}}class dt{constructor(t,s){this.layerUIDs=[],this.isDestroyed=!1,this.data=t,this.memoryUsed=t.byteLength;let i=1;const e=new Uint32Array(t);this.layerUIDs=[];const h=e[i++];for(let t=0;t<h;t++)this.layerUIDs[t]=e[i++];this.bufferDataOffset=i,s&&(this.layer=s.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return h(this.data)}get offset(){return this.bufferDataOffset}destroy(){this.isDestroyed||(this.doDestroy(),this.isDestroyed=!0)}prepareForRendering(t){h(this.data)||(this.doPrepareForRendering(t,this.data,this.bufferDataOffset),this.data=null)}}class mt extends dt{constructor(t,s){super(t,s),this.type=2,this.lineIndexStart=0,this.lineIndexCount=0;const i=new Uint32Array(t);let e=this.bufferDataOffset;this.lineIndexStart=i[e++],this.lineIndexCount=i[e++];const h=i[e++];if(h>0){const t=new Map;for(let s=0;s<h;s++){const s=i[e++],h=i[e++],r=i[e++];t.set(s,[h,r])}this.patternMap=t}this.bufferDataOffset=e}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){r(this.lineVertexArrayObject)&&this.lineVertexArrayObject.dispose(),r(this.lineVertexBuffer)&&this.lineVertexBuffer.dispose(),r(this.lineIndexBuffer)&&this.lineIndexBuffer.dispose(),this.lineVertexArrayObject=null,this.lineVertexBuffer=null,this.lineIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(t,s,i){const e=new Uint32Array(s),h=new Int32Array(e.buffer),r=e[i++];this.lineVertexBuffer=M.createVertex(t,35044,new Int32Array(h.buffer,4*i,r)),i+=r;const n=e[i++];this.lineIndexBuffer=M.createIndex(t,35044,new Uint32Array(e.buffer,4*i,n)),i+=n;const o=this.layer.lineMaterial;this.lineVertexArrayObject=new v(t,o.getAttributeLocations(),o.getLayoutInfo(),{geometry:this.lineVertexBuffer},this.lineIndexBuffer)}}class yt extends dt{constructor(t,s){super(t,s),this.type=1,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const i=new Uint32Array(t);let e=this.bufferDataOffset;this.fillIndexStart=i[e++],this.fillIndexCount=i[e++],this.outlineIndexStart=i[e++],this.outlineIndexCount=i[e++];const h=i[e++];if(h>0){const t=new Map;for(let s=0;s<h;s++){const s=i[e++],h=i[e++],r=i[e++];t.set(s,[h,r])}this.patternMap=t}this.bufferDataOffset=e}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){r(this.fillVertexArrayObject)&&this.fillVertexArrayObject.dispose(),r(this.fillVertexBuffer)&&this.fillVertexBuffer.dispose(),r(this.fillIndexBuffer)&&this.fillIndexBuffer.dispose(),this.fillVertexArrayObject=null,this.fillVertexBuffer=null,this.fillIndexBuffer=null,r(this.outlineVertexArrayObject)&&this.outlineVertexArrayObject.dispose(),r(this.outlineVertexBuffer)&&this.outlineVertexBuffer.dispose(),r(this.outlineIndexBuffer)&&this.outlineIndexBuffer.dispose(),this.outlineVertexArrayObject=null,this.outlineVertexBuffer=null,this.outlineIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(t,s,i){const e=new Uint32Array(s),h=new Int32Array(e.buffer),r=e[i++];this.fillVertexBuffer=M.createVertex(t,35044,new Int32Array(h.buffer,4*i,r)),i+=r;const n=e[i++];this.fillIndexBuffer=M.createIndex(t,35044,new Uint32Array(e.buffer,4*i,n)),i+=n;const o=e[i++];this.outlineVertexBuffer=M.createVertex(t,35044,new Int32Array(h.buffer,4*i,o)),i+=o;const a=e[i++];this.outlineIndexBuffer=M.createIndex(t,35044,new Uint32Array(e.buffer,4*i,a)),i+=a;const c=this.layer,l=c.fillMaterial,f=c.outlineMaterial;this.fillVertexArrayObject=new v(t,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:this.fillVertexBuffer},this.fillIndexBuffer),this.outlineVertexArrayObject=new v(t,f.getAttributeLocations(),f.getLayoutInfo(),{geometry:this.outlineVertexBuffer},this.outlineIndexBuffer)}}class wt extends dt{constructor(t,s,i){super(t,s),this.type=3,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const e=new Uint32Array(t),h=new Int32Array(t),r=new Float32Array(t);let n=this.bufferDataOffset;this.isIconSDF=!!e[n++];const o=e[n++];for(let t=0;t<o;t++){const t=e[n++],s=e[n++],i=e[n++];this.iconPerPageElementsMap.set(t,[s,i])}const a=e[n++];for(let t=0;t<a;t++){const t=e[n++],s=e[n++],i=e[n++];this.glyphPerPageElementsMap.set(t,[s,i])}const c=e[n++],l=e[n++];this.iconOpacity=new Int32Array(c),this.textOpacity=new Int32Array(l),n=function(t,s,i,e,h,r){const n=s[e++];for(let o=0;o<n;o++){const n=new ct(r);n.xTile=s[e++],n.yTile=s[e++],n.hash=s[e++],n.priority=s[e++];const o=s[e++];for(let t=0;t<o;t++){const t=s[e++],h=s[e++],r=s[e++],o=s[e++],a=!!s[e++],c=s[e++],l=i[e++],f=i[e++],u=s[e++],p=s[e++];n.colliders.push({xTile:t,yTile:h,dxPixels:r,dyPixels:o,hard:a,partIndex:c,width:u,height:p,minLod:l,maxLod:f})}const a=t[e++];for(let s=0;s<a;s++)n.textVertexRanges.push([t[e++],t[e++]]);const c=t[e++];for(let s=0;s<c;s++)n.iconVertexRanges.push([t[e++],t[e++]]);h.push(n)}return e}(e,h,r,n,this.symbols,i),this.bufferDataOffset=n}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let t=0;for(const[s,i]of this.iconPerPageElementsMap)t+=i[1];for(const[s,i]of this.glyphPerPageElementsMap)t+=i[1];return t/3}doDestroy(){r(this.iconVertexArrayObject)&&this.iconVertexArrayObject.dispose(),r(this.iconVertexBuffer)&&this.iconVertexBuffer.dispose(),r(this.iconOpacityBuffer)&&this.iconOpacityBuffer.dispose(),r(this.iconIndexBuffer)&&this.iconIndexBuffer.dispose(),this.iconVertexArrayObject=null,this.iconVertexBuffer=null,this.iconOpacityBuffer=null,this.iconIndexBuffer=null,r(this.textVertexArrayObject)&&this.textVertexArrayObject.dispose(),r(this.textVertexBuffer)&&this.textVertexBuffer.dispose(),r(this.textOpacityBuffer)&&this.textOpacityBuffer.dispose(),r(this.textIndexBuffer)&&this.textIndexBuffer.dispose(),this.textVertexArrayObject=null,this.textVertexBuffer=null,this.textOpacityBuffer=null,this.textIndexBuffer=null,this.memoryUsed=0}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const t=n(this.iconOpacity),s=n(this.iconOpacityBuffer);t.length>0&&t.byteLength===s.size&&s.setSubData(t);const i=n(this.textOpacity),e=n(this.textOpacityBuffer);i.length>0&&i.byteLength===e.size&&e.setSubData(i)}doPrepareForRendering(t,s,i){const e=new Uint32Array(s),h=new Int32Array(e.buffer),r=e[i++];this.iconVertexBuffer=M.createVertex(t,35044,new Int32Array(h.buffer,4*i,r)),i+=r;const o=e[i++];this.iconIndexBuffer=M.createIndex(t,35044,new Uint32Array(e.buffer,4*i,o)),i+=o;const a=e[i++];this.textVertexBuffer=M.createVertex(t,35044,new Int32Array(h.buffer,4*i,a)),i+=a;const c=e[i++];this.textIndexBuffer=M.createIndex(t,35044,new Uint32Array(e.buffer,4*i,c)),i+=c,this.iconOpacityBuffer=M.createVertex(t,35044,n(this.iconOpacity).buffer),this.textOpacityBuffer=M.createVertex(t,35044,n(this.textOpacity).buffer);const l=this.layer,f=l.iconMaterial,u=l.textMaterial;this.iconVertexArrayObject=new v(t,f.getAttributeLocations(),f.getLayoutInfo(),{geometry:this.iconVertexBuffer,opacity:this.iconOpacityBuffer},this.iconIndexBuffer),this.textVertexArrayObject=new v(t,u.getAttributeLocations(),u.getLayoutInfo(),{geometry:this.textVertexBuffer,opacity:this.textOpacityBuffer},this.textIndexBuffer)}}class gt extends dt{constructor(t,s){super(t,s),this.type=4,this.circleIndexStart=0,this.circleIndexCount=0;const i=new Uint32Array(t);let e=this.bufferDataOffset;this.circleIndexStart=i[e++],this.circleIndexCount=i[e++],this.bufferDataOffset=e}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){r(this.circleVertexArrayObject)&&this.circleVertexArrayObject.dispose(),r(this.circleVertexBuffer)&&this.circleVertexBuffer.dispose(),r(this.circleIndexBuffer)&&this.circleIndexBuffer.dispose(),this.circleVertexArrayObject=null,this.circleVertexBuffer=null,this.circleIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(t,s,i){const e=new Uint32Array(s),h=new Int32Array(e.buffer),r=e[i++];this.circleVertexBuffer=M.createVertex(t,35044,new Int32Array(h.buffer,4*i,r)),i+=r;const n=e[i++];this.circleIndexBuffer=M.createIndex(t,35044,new Uint32Array(e.buffer,4*i,n)),i+=n;const o=this.layer.circleMaterial;this.circleVertexArrayObject=new v(t,o.getAttributeLocations(),o.getLayoutInfo(),{geometry:this.circleVertexBuffer},this.circleIndexBuffer)}}class bt extends q{constructor(t,s,i,e,h,r,n=null){super(t,s,i,e,h,4096,4096),this._memCache=n,this.type="vector-tile",this._referenced=0,this._hasSymbolBuckets=!1,this._memoryUsedByLayerData=0,this.layerData=new Map,this.layerCount=0,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.invalidating=!1,this.parentTile=null,this.childrenTiles=new Set,this._processed=!1,this._referenced=1,this.styleRepository=r,this.id=t.id}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<F}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<F)}get wasRequested(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}setData(t){this.changeDataImpl(t),this.requestRender(),this.ready(),this.invalidating=!1,this._processed=!0}deleteLayerData(t){let s=!1;for(const i of t)if(this.layerData.has(i)){const t=this.layerData.get(i);this._memoryUsedByLayerData-=t.memoryUsed,3===t.type&&this.symbols.has(i)&&(this.symbols.delete(i),s=!0),t.destroy(),this.layerData.delete(i),this.layerCount--}r(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData),s&&this.emit("symbols-changed"),this.requestRender()}processed(){return this._processed}hasData(){return this.layerCount>0}dispose(){"unloaded"!==this.status&&(jt.delete(this),bt._destroyRenderBuckets(this.layerData),this.layerData=null,this.layerCount=0,this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")}release(){return 0==--this._referenced&&(this.dispose(),this.stage=null,!0)}retain(){++this._referenced}get referenced(){return this._referenced}get memoryUsage(){return(this._memoryUsedByLayerData+256)/(this._referenced||1)}changeDataImpl(t){let s=!1;if(t){const i=this._createRenderBuckets(t);for(const[t,e]of i){if(this.layerData.has(t)){const s=this.layerData.get(t);this._memoryUsedByLayerData-=e.memoryUsed,s.destroy(),this.layerData.delete(t),this.layerCount--}3===e.type&&(this.symbols.set(t,e.symbols),s=!0),this._memoryUsedByLayerData+=e.memoryUsed,this.layerData.set(t,e),this.layerCount++}r(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData)}this._hasSymbolBuckets=!1;for(const[t,s]of this.layerData)3===s.type&&(this._hasSymbolBuckets=!0);s&&this.emit("symbols-changed")}attachWithContext(t){this.stage={context:t,trashDisplayObject(t){t.processDetach()},untrashDisplayObject:()=>!1}}setTransform(t,s){super.setTransform(t,s);const i=s/(t.resolution*t.pixelRatio),e=this.width/this.rangeX*i,h=this.height/this.rangeY*i,r=[0,0];t.toScreen(r,[this.x,this.y]);const n=this.transforms.tileUnitsToPixels;k(n),P(n,n,r),R(n,n,Math.PI*t.rotation/180),C(n,n,[e,h,1])}_createTransforms(){return{dvs:L(),tileMat3:L(),tileUnitsToPixels:L()}}static _destroyRenderBuckets(t){if(!t)return;const s=new Set;t.forEach((t=>{s.has(t)||(t.destroy(),s.add(t))})),t.clear()}_createRenderBuckets(t){const s=new Map,i=new Map;for(const e of t){const t=this._deserializeBucket(e,i);for(const i of t.layerUIDs)s.set(i,t)}return s}_deserializeBucket(t,s){let i=s.get(t);if(i)return i;switch(new Uint32Array(t)[0]){case 1:i=new yt(t,this.styleRepository);break;case 2:i=new mt(t,this.styleRepository);break;case 3:i=new wt(t,this.styleRepository,this);break;case 4:i=new gt(t,this.styleRepository)}return s.set(t,i),i}}const jt=new Map;function Mt(t,s,i,e,h,r){const{iconRotationAlignment:n,textRotationAlignment:o,iconTranslate:a,iconTranslateAnchor:c,textTranslate:l,textTranslateAnchor:f}=e;let u=0;for(const e of t.colliders){const[t,p]=0===e.partIndex?a:l,d=0===e.partIndex?c:f,m=e.minLod<=r&&r<=e.maxLod;u+=m?0:1,e.enabled=m,e.xScreen=e.xTile*h[0]+e.yTile*h[3]+h[6],e.yScreen=e.xTile*h[1]+e.yTile*h[4]+h[7],0===d?(e.xScreen+=i*t-s*p,e.yScreen+=s*t+i*p):(e.xScreen+=t,e.yScreen+=p),1===(0===e.partIndex?n:o)?(e.dxScreen=e.dxPixels,e.dyScreen=e.dyPixels):(e.dxScreen=i*(e.dxPixels+e.width/2)-s*(e.dyPixels+e.height/2)-e.width/2,e.dyScreen=s*(e.dxPixels+e.width/2)+i*(e.dyPixels+e.height/2)-e.height/2)}t.colliders.length>0&&u===t.colliders.length&&(t.unique.show=!1)}class vt{constructor(t,s,i,e,h,r){this._symbols=t,this._styleRepository=e,this._zoom=h,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new ut(s,i,z),this._si=Math.sin(Math.PI*r/180),this._co=Math.cos(Math.PI*r/180);for(const s of t)for(const t of s.symbols)this._allNeededMatrices.has(t.tile)||this._allNeededMatrices.set(t.tile,O(t.tile.transforms.tileUnitsToPixels))}work(t){const s=this._gridIndex;function i(t){const i=t.xScreen+t.dxScreen,e=t.yScreen+t.dyScreen,h=i+t.width,r=e+t.height,[n,o,a,c]=s.getCellSpan(i,e,h,r);for(let t=o;t<=c;t++)for(let o=n;o<=a;o++){const n=s.cells[t][o];for(const t of n){const s=t.xScreen+t.dxScreen,n=t.yScreen+t.dyScreen,o=s+t.width,a=n+t.height;if(!(h<s||i>o||r<n||e>a))return!0}}return!1}const e=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const s=this._symbols[this._currentLayerCursor],h=this._getProperties(s.styleLayerUID);for(;this._currentSymbolCursor<s.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-e>t)return!1;const r=s.symbols[this._currentSymbolCursor];if(!r.unique.show)continue;Mt(r,this._si,this._co,h,this._allNeededMatrices.get(r.tile),this._zoom);const n=r.unique;if(!n.show)continue;const{iconAllowOverlap:o,iconIgnorePlacement:a,textAllowOverlap:c,textIgnorePlacement:l}=h;for(const t of r.colliders){if(!t.enabled)continue;const s=n.parts[t.partIndex];s.show&&!(t.partIndex?c:o)&&i(t)&&(t.hard?n.show=!1:s.show=!1)}if(n.show)for(const t of r.colliders){if(!t.enabled)continue;if(t.partIndex?l:a)continue;if(!n.parts[t.partIndex].show)continue;const s=t.xScreen+t.dxScreen,i=t.yScreen+t.dyScreen,e=s+t.width,h=i+t.height,[r,o,c,f]=this._gridIndex.getCellSpan(s,i,e,h);for(let s=o;s<=f;s++)for(let i=r;i<=c;i++)this._gridIndex.cells[s][i].push(t)}}}return!0}_getProperties(t){const s=this._styleProps.get(t);if(s)return s;const i=this._zoom,e=this._styleRepository.getStyleLayerByUID(t),h=0!==e.getLayoutValue("symbol-placement",i);let r=e.getLayoutValue("icon-rotation-alignment",i);2===r&&(r=h?0:1);let n=e.getLayoutValue("text-rotation-alignment",i);2===n&&(n=h?0:1);const o=e.getPaintValue("icon-translate",i),a=e.getPaintValue("icon-translate-anchor",i),c=e.getPaintValue("text-translate",i),l=e.getPaintValue("text-translate-anchor",i),f={iconAllowOverlap:e.getLayoutValue("icon-allow-overlap",i),iconIgnorePlacement:e.getLayoutValue("icon-ignore-placement",i),textAllowOverlap:e.getLayoutValue("text-allow-overlap",i),textIgnorePlacement:e.getLayoutValue("text-ignore-placement",i),iconRotationAlignment:r,textRotationAlignment:n,iconTranslateAnchor:a,iconTranslate:o,textTranslateAnchor:l,textTranslate:c};return this._styleProps.set(t,f),f}}function At(t,s){if(t.priority-s.priority)return t.priority-s.priority;const i=t.tile.key,e=s.tile.key;return i.world-e.world?i.world-e.world:i.level-e.level?i.level-e.level:i.row-e.row?i.row-e.row:i.col-e.col?i.col-e.col:t.xTile-s.xTile?t.xTile-s.xTile:t.yTile-s.yTile}class Tt{constructor(t,s,i,e,h,r){this._visibleTiles=t,this._symbolRepository=s,this._createCollisionJob=i,this._assignTileSymbolsOpacity=e,this._symbolLayerSorter=h,this._isLayerVisible=r,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}get running(){return this._running}setScreenSize(t,s){this._screenWidth===t&&this._screenHeight===s||this.restart(),this._screenWidth=t,this._screenHeight=s}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(t){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const s=performance.now();if(!this._selectionJob.work(t))return!1;if(this._selectionJobCompleted=!0,0===(t=Math.max(0,t-(performance.now()-s))))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const s=performance.now();if(!this._collisionJob.work(t))return!1;if(this._collisionJobCompleted=!0,0===(t=Math.max(0,t-(performance.now()-s))))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const s=performance.now();if(!this._opacityJob.work(t))return!1;if(this._opacityJobCompleted=!0,0===(t=Math.max(0,t-(performance.now()-s))))return!1}return this._running=!1,!0}_createSelectionJob(){const t=this._symbolRepository.uniqueSymbols;for(let s=0;s<t.length;s++){const i=t[s];for(let t=0;t<i.uniqueSymbols.length;t++){const s=i.uniqueSymbols[t];for(const t of s.tileSymbols)t.selectedForRendering=!1}}const s=[];let i=0,e=0;const h=this._isLayerVisible,r=this._symbolLayerSorter;return{work:function(r){let n;const o=performance.now();for(;e<t.length;e++,i=0){const a=t[e],c=a.styleLayerUID;if(!h(c)){s[e]||(s[e]={styleLayerUID:c,symbols:[]});continue}s[e]=s[e]||{styleLayerUID:c,symbols:[]};const l=s[e];for(;i<a.uniqueSymbols.length;i++){if(n=a.uniqueSymbols[i],i%100==99&&performance.now()-o>r)return!1;let t=null,s=!1,e=!1;for(const i of n.tileSymbols)if(!e||!s){const h=i.tile;(!t||h.isCoverage||h.neededForCoverage&&!s)&&(t=i,(h.neededForCoverage||h.isCoverage)&&(e=!0),h.isCoverage&&(s=!0))}if(t.selectedForRendering=!0,e){l.symbols.push(t),n.show=!0;for(const t of n.parts)t.show=!0}else n.show=!1}}for(const t of s)t.symbols.sort(At);return!0},get sortedSymbols(){return s.sort(r)}}}_createOpacityJob(){const t=this._assignTileSymbolsOpacity,s=this._visibleTiles;let i=0;function e(s,i){const h=s.symbols;for(const[t,s]of h)xt(s,i);t(s,i);for(const t of s.childrenTiles)e(t,i)}return{work(t){const h=performance.now();for(;i<s.length;i++){if(performance.now()-h>t)return!1;const n=s[i];r(n.parentTile)||e(n,performance.now())}return!0}}}}function xt(t,s){for(const i of t){const t=i.unique;for(const i of t.parts)i.startOpacity+=(s-i.startTime)/F*(i.targetOpacity>.5?1:-1),i.startOpacity=Math.min(Math.max(i.startOpacity,0),1),i.startTime=s,i.targetOpacity=t.show&&i.show?1:0}}class _t{constructor(t,s,i){this.tileCoordRange=t,this._visibleTiles=s,this._createUnique=i,this._tiles=new Map,this._uniqueSymbolsReferences=new Map}get uniqueSymbols(){return h(this._uniqueSymbolLayerArray)&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}add(t,s){this._uniqueSymbolLayerArray=null;let i=this._tiles.get(t.id);i||(i={symbols:new Map},this._tiles.set(t.id,i));const e=new Map;if(s)for(const t of s)i.symbols.has(t)&&(e.set(t,i.symbols.get(t)),i.symbols.delete(t));else for(const[s,h]of t.layerData)i.symbols.has(s)&&(e.set(s,i.symbols.get(s)),i.symbols.delete(s));this._removeSymbols(e);const h=t.symbols,r=new Map;for(const[t,s]of h){let e=s.length;if(e>=32){let h=this.tileCoordRange;do{h/=2,e/=4}while(e>8&&h>64);const n=new ut(this.tileCoordRange,this.tileCoordRange,h);r.set(t,{flat:s,index:n}),i.symbols.set(t,{flat:s,index:n});for(const t of s)n.getCell(t.xTile,t.yTile).push(t)}else r.set(t,{flat:s}),i.symbols.set(t,{flat:s})}this._addSymbols(t.key,h)}deleteStyleLayers(t){this._uniqueSymbolLayerArray=null;for(const[s,i]of this._tiles){const e=new Map;for(const s of t)i.symbols.has(s)&&(e.set(s,i.symbols.get(s)),i.symbols.delete(s));this._removeSymbols(e),0===i.symbols.size&&this._tiles.delete(s)}}removeTile(t){this._uniqueSymbolLayerArray=null;const s=this._tiles.get(t.id);if(!s)return;const i=new Map;for(const[e,h]of t.symbols)s.symbols.has(e)&&(i.set(e,s.symbols.get(e)),s.symbols.delete(e));this._removeSymbols(i),0===s.symbols.size&&this._tiles.delete(t.id)}_removeSymbols(t){for(const[s,{flat:i}]of t)for(const t of i){const i=t.unique,e=i.tileSymbols,h=e.length-1;for(let s=0;s<h;s++)if(e[s]===t){e[s]=e[h];break}if(e.length=h,0===h){const t=this._uniqueSymbolsReferences.get(s);t.delete(i),0===t.size&&this._uniqueSymbolsReferences.delete(s)}t.unique=null}}_addSymbols(t,s){if(0===s.size)return;const i=this._visibleTiles;for(const e of i)e.parentTile||e.key.world!==t.world||e.key.level===t.level&&!e.key.equals(t)||this._matchSymbols(e,t,s);for(const[t,i]of s)for(const s of i)if(h(s.unique)){const i=this._createUnique();s.unique=i,i.tileSymbols.push(s);let e=this._uniqueSymbolsReferences.get(t);e||(e=new Set,this._uniqueSymbolsReferences.set(t,e)),e.add(i)}}_matchSymbols(t,s,i){if(t.key.level>s.level){const i=t.key.level-s.level;if(t.key.row>>i!==s.row||t.key.col>>i!==s.col)return}if(s.level>t.key.level){const i=s.level-t.key.level;if(s.row>>i!==t.key.row||s.col>>i!==t.key.col)return}if(s.equals(t.key)){for(const e of t.childrenTiles)this._matchSymbols(e,s,i);return}const e=new Map;for(const[h,n]of i){const i=[];for(const e of n){const h=ft(this.tileCoordRange,e.xTile,s.level,s.col,t.key.level,t.key.col),r=ft(this.tileCoordRange,e.yTile,s.level,s.row,t.key.level,t.key.row);h>=0&&h<this.tileCoordRange&&r>=0&&r<this.tileCoordRange&&i.push({symbol:e,xTransformed:h,yTransformed:r})}const o=[],a=t.key.level<s.level?1:1<<t.key.level-s.level,c=this._tiles.get(t.id).symbols.get(h);if(c){const t=c.flat;for(const s of i){let i,e=!1;const h=s.xTransformed,n=s.yTransformed;i=r(c.index)?c.index.getCell(h,n):t;const l=s.symbol,f=l.hash;for(const t of i)if(f===t.hash&&Math.abs(h-t.xTile)<=a&&Math.abs(n-t.yTile)<=a){const s=t.unique;l.unique=s,s.tileSymbols.push(l),e=!0;break}e||o.push(l)}}o.length>0&&e.set(h,o)}for(const i of t.childrenTiles)this._matchSymbols(i,s,e)}_createUniqueSymbolLayerArray(){const t=this._uniqueSymbolsReferences,s=new Array(t.size);let i,e=0;for(const[h,r]of t){const t=new Array(r.size);i=0;for(const s of r)t[i++]=s;s[e]={styleLayerUID:h,uniqueSymbols:t},e++}return s}}const St=1e-6;class Ut extends o{constructor(t,s){super(),this.styleRepository=t,this._tileToHandle=new Map,this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._completed=!1,this._symbolRepository=new _t(4096,s,(()=>new lt)),this._symbolDeclutterer=new Tt(s,this._symbolRepository,((t,s,i)=>new vt(t,s,i,this.styleRepository,this._zoom,this._viewState.rotation)),((t,s)=>{t.allSymbolsFadingOut=!0,t.lastOpacityUpdate=s,function(t,s){for(const[i,e]of t.symbols)pt(t,s,true,e,i)}(t,s),t.decluttered=!0,t.requestRender()}),((t,s)=>this.styleRepository.getStyleLayerByUID(t.styleLayerUID).z-this.styleRepository.getStyleLayerByUID(s.styleLayerUID).z),(t=>{const s=this.styleRepository.getStyleLayerByUID(t);if(this._zoom+St<s.minzoom||this._zoom-St>=s.maxzoom)return!1;const i=s.getLayoutProperty("visibility");return!i||1!==i.getValue()}))}addTile(t){t.decluttered=!1,this._tileToHandle.set(t,t.on("symbols-changed",(()=>{this._symbolRepository.add(t),this.restartDeclutter()}))),this._symbolRepository.add(t),this.restartDeclutter()}removeTile(t){const s=this._tileToHandle.get(t);s&&(this._symbolRepository.removeTile(t),this.restartDeclutter(),s.remove(),this._tileToHandle.delete(t))}update(t,s){return this._zoom=t,this._viewState={scale:s.scale,rotation:s.rotation,center:[s.center[0],s.center[1]],size:[s.size[0],s.size[1]]},this._continueDeclutter(),this._completed}restartDeclutter(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}clear(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach((t=>t.remove())),this._tileToHandle.clear()}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(t){this._symbolRepository.deleteStyleLayers(t)}_continueDeclutter(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(B),this._completed&&this._scheduleNotifyStable())}_scheduleNotifyStable(){r(this._stableNotificationHandle)&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout((()=>{this._stableNotificationHandle=null,this.emit("fade-complete")}),1.5*F)}_notifyUnstable(){r(this._stableNotificationHandle)&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this.emit("fade-start")}}class It extends q{_createTransforms(){return{dvs:L(),tileMat3:L()}}}const Dt=1e-6;function kt(t,s){if(t){const i=t.getLayoutProperty("visibility");if(!i||1!==i.getValue()&&(void 0===t.minzoom||t.minzoom<s+Dt)&&(void 0===t.maxzoom||t.maxzoom>=s-Dt))return!0}return!1}class Pt extends V{constructor(t){super(t),this._backgroundTiles=[],this._pointToCallbacks=new Map}destroy(){this.removeAllChildren(),this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null),r(this._symbolFader)&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[],this._pointToCallbacks.clear()}setStyleResources(t,s,i){if(this._spriteMosaic=t,this._glyphMosaic=s,this._styleRepository=i,h(this._symbolFader)){const t=new Ut(this._styleRepository,this.children);t.on("fade-start",(()=>{this.emit("fade-start"),this.requestRender()})),t.on("fade-complete",(()=>{this.emit("fade-complete"),this.requestRender()})),this._symbolFader=t}n(this._symbolFader).styleRepository=i}deleteStyleLayers(t){r(this._symbolFader)&&this._symbolFader.deleteStyleLayers(t)}async hitTest(t,s){const i=[t,s],e=a();return this._pointToCallbacks.set(i,e),this.requestRender(),e.promise}enterTileInvalidation(){for(const t of this.children)t.invalidating=!0}createRenderParams(t){return{...super.createRenderParams(t),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}}doRender(t){!this.visible||t.drawPhase!==N.MAP&&t.drawPhase!==N.DEBUG||void 0===this._spriteMosaic||super.doRender(t)}addChild(t){return super.addChild(t),r(this._symbolFader)?this._symbolFader.addTile(t):t.decluttered=!0,this.requestRender(),t}removeChild(t){return r(this._symbolFader)&&this._symbolFader.removeTile(t),this.requestRender(),super.removeChild(t)}renderChildren(t){const{drawPhase:s}=t;if(s!==N.DEBUG){if(this._doRender(t),this._pointToCallbacks.size>0){t.drawPhase=N.HITTEST;const i=t.painter.effects.hittest;i.bind(t),this._doRender(t),i.draw(t,this._pointToCallbacks),i.unbind(t),t.drawPhase=s}}else super.renderChildren(t)}removeAllChildren(){for(let t=0;t<this.children.length;t++){const s=this.children[t];r(this._symbolFader)&&this._symbolFader.removeTile(s),s.dispose()}super.removeAllChildren()}getStencilTarget(){return this.children.filter((t=>t.neededForCoverage&&t.hasData()))}restartDeclutter(){r(this._symbolFader)&&this._symbolFader.restartDeclutter()}_doRender(t){const{context:s}=t,i=this._styleRepository;if(!i)return;const e=i.layers;let h=!0;t.drawPhase===N.HITTEST&&(h=!1),i.backgroundBucketIds.length>0&&(t.renderPass="background",this._renderBackgroundLayers(t,i.backgroundBucketIds)),super.renderChildren(t),t.drawPhase===N.MAP&&this._fade(t.displayLevel,t.state);const r=this.children.filter((t=>t.visible&&t.hasData()));if(!r||0===r.length)return s.bindVAO(),s.setStencilTestEnabled(!0),void s.setBlendingEnabled(!0);for(const t of r)t.triangleCount=0;s.setStencilWriteMask(0),s.setColorMask(!0,!0,!0,!0),s.setStencilOp(7680,7680,7681),s.setStencilTestEnabled(!0),s.setBlendingEnabled(!1),s.setDepthTestEnabled(!0),s.setDepthWriteEnabled(!0),s.setDepthFunction(515),s.setClearDepth(1),s.clear(s.gl.DEPTH_BUFFER_BIT),t.renderPass="opaque";for(let s=e.length-1;s>=0;s--)this._renderStyleLayer(e[s],t,r);s.setDepthWriteEnabled(!1),s.setBlendingEnabled(h),s.setBlendFunctionSeparate(1,771,1,771),t.renderPass="translucent";for(let s=0;s<e.length;s++)this._renderStyleLayer(e[s],t,r);s.setDepthTestEnabled(!1),t.renderPass="symbol";for(let s=0;s<e.length;s++)this._renderStyleLayer(e[s],t,r);s.bindVAO(),s.setStencilTestEnabled(!0),s.setBlendingEnabled(!0)}_fade(t,s){r(this._symbolFader)&&(this._symbolFader.update(t,s)||this.requestRender())}_renderStyleLayer(t,s,i){const{painter:e,renderPass:h}=s;if(void 0===t)return;const r=t.getLayoutProperty("visibility");if(r&&1===r.getValue())return;let n;switch(t.type){case 0:return;case 1:if("opaque"!==h&&"translucent"!==s.renderPass)return;n="vtlFill";break;case 2:if("translucent"!==h)return;n="vtlLine";break;case 4:if("symbol"!==h)return;n="vtlCircle";break;case 3:if("symbol"!==h)return;n="vtlSymbol"}if(i=i.filter(3===t.type?t=>t.decluttered:t=>t.neededForCoverage),"vtlSymbol"!==n){const e=s.displayLevel;if(0===i.length||void 0!==t.minzoom&&t.minzoom>=e+Dt||void 0!==t.maxzoom&&t.maxzoom<e-Dt)return}const o=t.uid;s.styleLayerUID=o,s.styleLayer=t;for(const t of i)if(t.layerData.has(o)){e.renderObjects(s,i,n);break}}_renderBackgroundLayers(t,s){const{context:i,displayLevel:e,painter:h,state:n}=t,o=this._styleRepository;let a=!1;for(const t of s)if(0===o.getLayerById(t).type&&kt(o.getLayerById(t),e)){a=!0;break}if(!a)return;const c=this._tileInfoView.getTileCoverage(t.state,0,"smallest"),{spans:l,lodInfo:f}=c,{level:u}=f,p=b(),d=[];if(this._renderPasses){const s=this._renderPasses[0];r(this._clippingInfos)&&(s.brushes[0].prepareState(t,this._clippingInfos[0]),s.brushes[0].drawMany(t,this._clippingInfos))}const m=this._backgroundTiles;let y,w=0;for(const{row:t,colFrom:s,colTo:i}of l)for(let e=s;e<=i;e++){if(w<m.length)y=m[w],y.key.set(u,t,f.normalizeCol(e),f.getWorldForColumn(e)),this._tileInfoView.getTileBounds(p,y.key,!1),y.x=p[0],y.y=p[3];else{const s=new S(u,t,f.normalizeCol(e),f.getWorldForColumn(e)),i=this._tileInfoView.getTileBounds(b(),s);y=new It(s,i[0],i[3],512,512,4096,4096),m.push(y)}y.setTransform(n,this._tileInfoView.getTileResolution(y.key)),d.push(y),w++}i.setStencilWriteMask(0),i.setColorMask(!0,!0,!0,!0),i.setStencilOp(7680,7680,7681),i.setStencilFunction(514,0,255);let g=!0;t.drawPhase===N.HITTEST&&(g=!1),i.setStencilTestEnabled(g);for(const i of s){const s=o.getLayerById(i);0===s.type&&kt(s,e)&&(t.styleLayerUID=s.uid,t.styleLayer=s,h.renderObjects(t,d,"vtlBackground"))}I.pool.release(c)}}class Rt extends W{constructor(t){super(),this.requestRender=this.requestRender.bind(this),this._layerView=t,this._canvas=document.createElement("canvas"),this._context=this._canvas.getContext("2d"),this._bitmap=new G(null,"standard",!1),this.addChild(this._bitmap)}doRender(t){const s=t.state,i=this._createCustomRenderParams(t),e=i.pixelRatio,h=this._canvas,r=this._bitmap;h.width=s.size[0]*e,h.height=s.size[1]*e,r.resolution=s.resolution,r.pixelRatio=e,r.x=s.viewpoint.targetGeometry.x-Math.abs(s.extent.xmax-s.extent.xmin)/2,r.y=s.viewpoint.targetGeometry.y+Math.abs(s.extent.ymax-s.extent.ymin)/2,this._layerView.render(i),r.source=h,r.rotation=s.rotation,super.doRender(t)}_createCustomRenderParams(t){const s=window.devicePixelRatio,i={...t.state,pixelRatio:s};return{...t,pixelRatio:s,context:this._context,state:i}}}class Ct extends D{constructor(){super(...arguments),this._fullCacheLodInfos=null,this._levelByScale={}}getTileParentId(t){const s=S.pool.acquire(t),i=0===s.level?null:S.getId(s.level-1,s.row>>1,s.col>>1,s.world);return S.pool.release(s),i}getTileCoverage(t,s,i){const e=super.getTileCoverage(t,s,i);if(!e)return e;const h=1<<e.lodInfo.level;return e.spans=e.spans.filter((t=>t.row>=0&&t.row<h)),e}scaleToLevel(t){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[t])return this._levelByScale[t];{const s=this._fullCacheLodInfos;if(t>s[0].scale)return s[0].level;let i,e;for(let h=0;h<s.length-1;h++)if(e=s[h+1],t>e.scale)return i=s[h],i.level+(i.scale-t)/(i.scale-e.scale);return s[s.length-1].level}}_initializeFullCacheLODs(t){let s;s=0===t[0].level?t.map((t=>({level:t.level,resolution:t.resolution,scale:t.scale}))):J.create({size:this.tileInfo.size[0],spatialReference:this.tileInfo.spatialReference}).lods.map((t=>({level:t.level,resolution:t.resolution,scale:t.scale})));for(let t=0;t<s.length;t++)this._levelByScale[s[t].scale]=s[t].level;this._fullCacheLodInfos=s}}const Lt=c.getLogger("esri.views.2d.layers.VectorTileLayerView2D");let Ot=class extends(H(K)){constructor(){super(...arguments),this._styleChanges=[],this._fetchQueue=null,this._parseQueue=null,this._isTileHandlerReady=!1,this.fading=!1}initialize(){const t=this.layer.tileInfo;if(!(t&&t.spatialReference).equals(this.view.spatialReference))return void this.addResolvingPromise(Promise.reject(new l("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer})));const{style:s,spriteUrl:i,glyphsUrl:e}=this.layer.currentStyleInfo;this._styleRepository=new $(s,{spriteUrl:i,glyphsUrl:e}),this._tileInfoView=new Ct(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new Pt(this._tileInfoView),this._tileHandler=new rt(this.layer,this._styleRepository,window.devicePixelRatio||1),this.container.addChild(this._vectorTileContainer),this.handles.add([this._vectorTileContainer.on("fade-start",(()=>{this.fading=!0,this.notifyChange("updating"),this.requestUpdate()})),this._vectorTileContainer.on("fade-complete",(()=>{this._collisionBoxesDisplay&&this._collisionBoxesDisplay.requestRender(),this.fading=!1,this.notifyChange("updating"),this.requestUpdate()})),f(this.layer,"symbolCollisionBoxesVisible",(t=>{t?(this._collisionBoxesDisplay=new Rt({render:t=>this._renderCollisionBoxes(t.context)}),this.container.addChild(this._collisionBoxesDisplay)):(this.container.removeChild(this._collisionBoxesDisplay),this._collisionBoxesDisplay=null)}))])}destroy(){var t;this._stop(),this.container.removeAllChildren(),this._vectorTileContainer&&(this._vectorTileContainer.destroy(),this._vectorTileContainer=null),null==(t=this._tileHandler)||t.destroy(),this._tileHandler=null}async hitTest(t,s){if(this.suspended||!this._tileHandlerPromise)return null;await this._tileHandlerPromise;const i=await this._vectorTileContainer.hitTest(t,s);if(!i||0===i.length)return null;const e=i[0]-1,h=this._styleRepository,r=h.getStyleLayerByUID(e);if(!r)return null;const n=h.getStyleLayerIndex(r.id),o=new y({attributes:{layerId:n,layerName:r.id,layerUID:e}});return o.layer=this.layer,o.sourceLayer=this.layer,o}update(t){if(this._tileHandlerPromise&&this._isTileHandlerReady)return t.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=t.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.state=t.state,this._parseQueue.state=t.state,this._tileManager.update(t)||this.requestUpdate(),this._parseQueue.resume(),this._fetchQueue.resume()))}attach(){this._start(),this.handles.add([this.layer.on("paint-change",(t=>{if(t.isDataDriven)this._styleChanges.push({type:0,data:t}),this.notifyChange("updating"),this.requestUpdate();else{const s=this._styleRepository,i=s.getLayerById(t.layer);if(!i)return;const e=3===i.type;s.setPaintProperties(t.layer,t.paint),e&&this._vectorTileContainer.restartDeclutter(),this._vectorTileContainer.requestRender()}})),this.layer.on("layout-change",(t=>{const s=this._styleRepository,i=s.getLayerById(t.layer);if(!i)return;const e=w(i.layout,t.layout);if(!h(e)){if(g(e,"visibility")&&1===function(t){if(h(t))return 0;switch(t.type){case"partial":return Object.keys(t.diff).length;case"complete":return Math.max(Object.keys(t.oldValue).length,Object.keys(t.newValue).length);case"collection":return Object.keys(t.added).length+Object.keys(t.changed).length+Object.keys(t.removed).length}}(e))return s.setLayoutProperties(t.layer,t.layout),3===i.type&&this._vectorTileContainer.restartDeclutter(),void this._vectorTileContainer.requestRender();this._styleChanges.push({type:1,data:t}),this.notifyChange("updating"),this.requestUpdate()}})),this.layer.on("style-layer-visibility-change",(t=>{const s=this._styleRepository,i=s.getLayerById(t.layer);i&&(s.setStyleLayerVisibility(t.layer,t.visibility),3===i.type&&this._vectorTileContainer.restartDeclutter(),this._vectorTileContainer.requestRender())})),this.layer.on("style-layer-change",(t=>{this._styleChanges.push({type:2,data:t}),this.notifyChange("updating"),this.requestUpdate()})),this.layer.on("delete-style-layer",(t=>{this._styleChanges.push({type:3,data:t}),this.notifyChange("updating"),this.requestUpdate()})),this.layer.on("load-style",(()=>this._loadStyle()))],this.declaredClass)}detach(){this._stop(),this.handles.remove(this.declaredClass)}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this._collisionBoxesDisplay&&this._vectorTileContainer.restartDeclutter(),this.requestUpdate()}canResume(){let t=super.canResume();const s=this.layer;if(t&&s.currentStyleInfo){const i=this.view.scale,e=s.currentStyleInfo;if(e&&e.layerDefinition){const s=e.layerDefinition;s.minScale&&s.minScale<i&&(t=!1),s.maxScale&&s.maxScale>i&&(t=!1)}}return t}isUpdating(){const t=this._vectorTileContainer.children;return!this._isTileHandlerReady||!this._fetchQueue||!this._parseQueue||this._fetchQueue.updating||this._parseQueue.updating||t.length>0&&t.filter((t=>t.invalidating)).length>0||this.fading}acquireTile(t){const s=this._createVectorTile(t);return this._tileHandlerPromise.then((()=>{this._fetchQueue.push(s.key).then((t=>this._parseQueue.push({key:s.key,data:t}))).then((t=>{s.once("attach",(()=>this.requestUpdate())),t&&(s.setData(t.tileData),this.requestUpdate(),this.notifyChange("updating"))})).catch((t=>{this.notifyChange("updating"),i(t)||Lt.error(t)}))})),s}releaseTile(t){const s=t.key.id;this._fetchQueue.abort(s),this._parseQueue.abort(s),this.requestUpdate()}_start(){if(this._stop(),this._tileManager=new ot({acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),tileInfoView:this._tileInfoView},this._vectorTileContainer),!this.layer.currentStyleInfo)return;const t=new AbortController,s=this._tileHandler.start({signal:t.signal}).then((()=>{this._fetchQueue=new Q({tileInfoView:this._tileInfoView,process:(t,s)=>this._getTileData(t,s),concurrency:15}),this._parseQueue=new Q({tileInfoView:this._tileInfoView,process:(t,s)=>this._parseTileData(t,s),concurrency:8}),this.requestUpdate(),this._isTileHandlerReady=!0}));this._tileHandler.spriteMosaic.then((t=>{this._vectorTileContainer.setStyleResources(t,this._tileHandler.glyphMosaic,this._styleRepository),this.requestUpdate()})),this._tileHandlerAbortController=t,this._tileHandlerPromise=s}_stop(){if(!this._tileHandlerAbortController||!this._vectorTileContainer)return;const t=this._tileHandlerAbortController;t&&t.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue&&(this._fetchQueue.destroy(),this._fetchQueue=null),this._parseQueue&&(this._parseQueue.destroy(),this._parseQueue=null),this._tileManager&&(this._tileManager.destroy(),this._tileManager=null),this._vectorTileContainer.removeAllChildren()}async _getTileData(t,s){const i=await this._tileHandler.fetchTileData(t,s);return this.notifyChange("updating"),i}async _parseTileData(t,s){return this._tileHandler.parseTileData(t,s)}async _applyStyleChanges(){this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this._tileManager.clearCache();const t=this._styleChanges;try{await this._tileHandler.updateStyle(t)}catch(t){Lt.error("error applying vector-tiles style update",t.message),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0}const s=this._styleRepository,i=[];t.forEach((t=>{if(3!==t.type)return;const e=s.getLayerById(t.data.layer);e&&i.push(e.uid)}));const e=[];let h;t.forEach((t=>{const i=t.data;switch(t.type){case 0:s.setPaintProperties(i.layer,i.paint),h=i.layer;break;case 1:s.setLayoutProperties(i.layer,i.layout),h=i.layer;break;case 3:return void s.deleteStyleLayer(i.layer);case 2:s.setStyleLayer(i.layer,i.index),h=i.layer.id}const r=s.getLayerById(h);r&&e.push(r.uid)}));const r=this._vectorTileContainer.children;if(i.length>0){this._vectorTileContainer.deleteStyleLayers(i);for(const t of r)t.deleteLayerData(i)}if(this._fetchQueue.resume(),this._parseQueue.resume(),e.length>0){const t=[];for(const s of r){const i=this._fetchQueue.push(s.key).then((t=>this._parseQueue.push({key:s.key,data:t,styleLayerUIDs:e}))).then((t=>s.setData(t.tileData)));t.push(i)}await Promise.all(t)}this._styleChanges=[],this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate()}async _loadStyle(){const{style:t,spriteUrl:s,glyphsUrl:e}=this.layer.currentStyleInfo,h=u(t);this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this.notifyChange("updating"),this._styleRepository=new $(h,{spriteUrl:s,glyphsUrl:e}),this._vectorTileContainer.destroy(),this._tileManager.clear(),this._tileHandlerAbortController.abort(),this._tileHandlerAbortController=new AbortController;const{signal:r}=this._tileHandlerAbortController;try{this._tileHandlerPromise=this._tileHandler.setStyle(this._styleRepository,h),await this._tileHandlerPromise}catch(t){if(!i(t))throw t}if(r.aborted)return this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),void this.requestUpdate();const n=await this._tileHandler.spriteMosaic;this._vectorTileContainer.setStyleResources(n,this._tileHandler.glyphMosaic,this._styleRepository),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate()}_createVectorTile(t){const s=this._tileInfoView.getTileBounds(b(),t);return new bt(t,s[0],s[3],512,512,this._styleRepository)}_renderCollisionBoxes(t){for(const s of this._vectorTileContainer.children)if(s.symbols){const i=[];for(const[t,e]of s.symbols)i.push(...e);ht(t,i)}}};p([d()],Ot.prototype,"_fetchQueue",void 0),p([d()],Ot.prototype,"_parseQueue",void 0),p([d()],Ot.prototype,"_isTileHandlerReady",void 0),p([d()],Ot.prototype,"fading",void 0),Ot=p([m("esri.views.2d.layers.VectorTileLayerView2D")],Ot);const Ft=Ot;export default Ft;