import"./p-0e784e4d.js";import"./p-5ce39624.js";import{p as e}from"./p-51a17e75.js";import{b as t,l as n}from"./p-dbdf15fc.js";import{V as r,c as i,e as s,d as a,a3 as l,i as o,D as u,K as c,af as f,s as d,N as p,A as m,aW as y}from"./p-e58503d5.js";import{u as b,o as g}from"./p-fb38a9d0.js";import{l as h}from"./p-1f81b35d.js";import{A as v,E as x,V as w}from"./p-e3500fdc.js";import{L as S,M}from"./p-b9c93bb2.js";import{o as V}from"./p-3a6cfd25.js";import{n as F,A as z,d as I,e as E,E as T,t as j}from"./p-1a7268a2.js";import{b as k,s as _,k as R}from"./p-47e1bd73.js";import{v as D}from"./p-b79fcce3.js";import{u as O}from"./p-ea916a39.js";import{a as $}from"./p-c1cd5521.js";import{l as K}from"./p-8acbca5b.js";import{x as P}from"./p-e991a11e.js";import{n as C}from"./p-dfc6337f.js";const G=512,N=50;function L(e,t){if(!t.isWrappable)return null;const[n,r]=$(t);return e[2]>r?[O([e[0],e[1],r,e[3]]),O([n,e[1],n+e[2]-r,e[3]])]:e[0]<n?[O([n,e[1],e[2],e[3]]),O([r-(n-e[0]),e[1],r,e[3]])]:null}function A(e){return"text"===e||"esriTS"===e}function B(e){return"simple-marker"===e||"picture-marker"===e||"esriSMS"===e||"esriPMS"===e}function U(e){switch(r(e.geometry).type){case"point":case"multipoint":return 0;case"polyline":return 1;case"polygon":case"extent":return 2}return 0}function q(e){if(!e)return null;const{xmin:t,ymin:n,xmax:r,ymax:i,spatialReference:s}=e;return new D({rings:[[[t,n],[t,i],[r,i],[r,n],[t,n]]],spatialReference:s})}const W={"simple-marker":1,"picture-marker":1,text:0,"simple-line":0,"simple-fill":0,"picture-fill":0,cim:1,"web-style":1};function H(e){if(!("visualVariables"in e))return 0;if(!e.hasVisualVariables("size"))return 0;const t=e.getVisualVariablesForType("size");if(!t[0])return 0;const n=t[0];if("outline"===n.target)return 0;if("stops"===n.transformationType)return n.stops.map((e=>e.size)).reduce(ne,0);if("clamped-linear"===n.transformationType){let e=-1/0,t=-1/0;return e="number"==typeof n.maxSize?n.maxSize:n.maxSize.stops.map((e=>e.size)).reduce(ne,0),t="number"==typeof n.minSize?n.minSize:n.minSize.stops.map((e=>e.size)).reduce(ne,0),Math.max(e,t)}return"real-world-size"===n.transformationType?30:void 0}async function J(e,t,n,r,i,s){if(!e||s&&"cluster"===s.type)return 0;if("heatmap"===e.type)return Math.round(3*e.blurRadius);if("dot-density"===e.type)return 0;if("dictionary"===e.type)return"esriGeometryPoint"===t||"esriGeometryMultipoint"===t?100:200;const a=e.getSymbols(),l=H(e),o=[];for(const e of a)o.push(ee(e,l,n,t,r,i));const u=await Promise.all(o);return b(u.reduce(ne,0))}const Q=[0,0,0,0];function X(e,t){return null==e?t:e}const Y={sdf:!0,code:99,metrics:R.metrics,rect:new j(0,0,24,24),page:0,textureBinding:2};async function Z(e,t,n,r,i,s){if("simple-marker"===e.type){const n=Math.max(X(e.size,12),t);return te(e)+.707*n}if("picture-marker"===e.type){const n=Math.max(X(e.height,12),t),r=X(e.width,12)*(n/X(e.height,12))/2,i=n/2;return te(e)+Math.sqrt(r*r+i*i)}if("text"===e.type){const t=function(e){const t=e.text&&e.text.length;if(!t)return{glyphMosaicItems:[Y]};const n=[];for(let r=0;r<t;r++)n.push({...Y,code:e.text.charCodeAt(r)});return{glyphMosaicItems:n}}(e);!function(e,t,n){var r,i,s;if(!n||0===n.glyphMosaicItems.length)return e;const a=F(t.text)[1],l=z(n.glyphMosaicItems,a,{scale:b(t.font.size)/k,angle:null!=(r=t.angle)?r:0,xOffset:null!=(i=t.xoffset)?i:0,yOffset:null!=(s=t.yoffset)?s:0,hAlign:I(t.horizontalAlignment||"center"),vAlign:E(t.verticalAlignment||"baseline"),maxLineWidth:Math.max(32,Math.min(t.lineWidth||512,512)),lineHeight:_*Math.max(.25,Math.min(t.lineHeight||1,4)),decoration:t.font.decoration||"none",isCIM:!1}).bounds;e[0]=b(l.x-l.halfWidth),e[1]=b(l.y-l.halfHeight),e[2]=b(l.width),e[3]=b(l.height)}(Q,e.toJSON(),t);const n=Math.abs(Q[0]),r=Math.abs(Q[1]),i=Q[2],s=Q[3];return Math.max(n,r)+Math.max(i,s)}if("simple-line"===e.type){const n=e,r=Math.max(X(n.width,.75),t)/2;return n.marker?Math.max(6*n.width,2*t):r}if("simple-fill"===e.type||"picture-fill"===e.type)return Math.max(function(e){return null==e.outline?0:X(e.outline.width,0)}(e),t)/2;if("cim"===e.type){const a={geometryType:r,fields:i,spatialReference:s},l={type:"cim",rendererKey:0,data:e.data,maxVVSize:t};await K(l,a,n);const o=T.getEnvelope(e.data,n);return o?Math.sqrt(o.width*o.width+o.height*o.height):0}return"web-style"===e.type?Z(await e.fetchCIMSymbol(),t,n,r,i,s):0}async function ee(e,t,n,r,i,s){return function(e){return e.type in W}(e)?Math.min(await Z(e,t,n,r,i,s),75):0}function te(e){const t=X(e.xoffset,0),n=X(e.yoffset,0);return Math.sqrt(t*t+n*n)}function ne(e,t){return Math.max(e,t)}const re=i.getLogger("esri.renderers.visualVariables.support.utils"),ie=e=>{if(!("visualVariables"in e)||!e.visualVariables||!e.visualVariables.length)return e;const t=e.clone(),n=t.visualVariables.map((e=>ae(e)?le(e):e));return t.visualVariables=n,t};function se(e){return e.map((e=>ae(e)?le(e.clone()):e))}function ae(e){return("size"===e.type||"color"===e.type||"opacity"===e.type)&&null!=e.stops}function le(e){return e.stops=function(e,t){return t.length<=8?t:(re.warn(`Found ${t.length} Visual Variable stops, but MapView only supports 8. Displayed stops will be simplified.`),t.length>16?function(e,t){const[n,...r]=t,i=r.pop(),s=r[0].value,a=r[r.length-1].value,l=(a-s)/6,o=[];for(let n=s;n<a;n+=l){let i=0;for(;n>=r[i].value;)i++;const s=r[i],a=t[i-1],l=n-a.value,u=s.value===a.value?1:l/(s.value-a.value);if("color"===e){const e=r[i],s=t[i-1],a=e.color.clone();a.r=oe(s.color.r,a.r,u),a.g=oe(s.color.g,a.g,u),a.b=oe(s.color.b,a.b,u),a.a=oe(s.color.a,a.a,u),o.push({value:n,color:a,label:e.label})}else if("size"===e){const e=r[i],s=t[i-1],a=g(e.size),l=oe(g(s.size),a,u);o.push({value:n,size:l,label:e.label})}else{const e=r[i],s=oe(t[i-1].opacity,e.opacity,u);o.push({value:n,opacity:s,label:e.label})}}return[n,...o,i]}(e,t):function(e){const[t,...n]=e,r=n.pop();for(;n.length>6;){let e=0,t=0;for(let r=1;r<n.length;r++){const i=Math.abs(n[r].value-n[r-1].value);i>t&&(t=i,e=r)}n.splice(e,1)}return[t,...n,r]}(t))}(e.type,e.stops),e}function oe(e,t,n){return(1-n)*e+n*t}var ue;let ce=ue=class extends t{writeLevels(e,t,n){for(const n in e)return void(t.stops=this.levels[n])}clone(){return new ue({axis:this.axis,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,maxDataValue:this.maxDataValue,maxSize:C(this.maxSize)?this.maxSize.clone():this.maxSize,minDataValue:this.minDataValue,minSize:C(this.minSize)?this.minSize.clone():this.minSize,normalizationField:this.normalizationField,stops:this.stops&&this.stops.map((e=>e.clone())),target:this.target,useSymbolValue:this.useSymbolValue,valueRepresentation:this.valueRepresentation,valueUnit:this.valueUnit,legendOptions:this.legendOptions&&this.legendOptions.clone(),levels:u(this.levels)})}};s([a()],ce.prototype,"levels",void 0),s([l("levels")],ce.prototype,"writeLevels",null),ce=ue=s([o("esri.views.2d.engine.LevelDependentSizeVariable")],ce);const fe=i.getLogger("esri.views.2d.layers.support.clusterUtils");c.add("esri-cluster-arcade-enabled",!0);const de=c("esri-cluster-arcade-enabled"),pe=(e,t,n,r)=>{const i=t.clone();if(!ge(i))return i;if(n.fields)for(const t of n.fields)he(e,t);if("visualVariables"in i){const t=(i.visualVariables||[]).filter((e=>"$view.scale"!==e.valueExpression)),s=me(t);t.forEach((t=>{"rotation"===t.type?t.field?t.field=xe(e,t.field,"avg_angle"):t.valueExpression&&(t.field=ve(e,t.valueExpression,"avg_angle"),t.valueExpression=null):t.normalizationField?(t.field=xe(e,t.field,"norm",t.normalizationField),t.normalizationField=null):t.field?t.field=xe(e,t.field,"avg"):(t.field=ve(e,t.valueExpression,"avg"),t.valueExpression=null)})),f(s)&&!ye(t)&&(t.push(be(n,r)),i.dynamicClusterSize=!0),i.visualVariables=t}switch(i.type){case"simple":break;case"unique-value":i.field?i.field=xe(e,i.field,"mode"):i.valueExpression&&(i.field=ve(e,i.valueExpression,"mode"),i.valueExpression=null);break;case"class-breaks":i.normalizationField?(i.field=xe(e,i.field,"norm",i.normalizationField),i.normalizationField=null):i.field?i.field=xe(e,i.field,"avg"):(i.field=ve(e,i.valueExpression,"avg"),i.valueExpression=null)}return i},me=e=>{for(const t of e)if("size"===t.type)return t;return null},ye=e=>{for(const t of e)if("cluster_count"===t.field)return!0;return!1},be=(e,r)=>{const i=[new n({value:0,size:0}),new n({value:1})];if(f(r))return new t({field:"cluster_count",stops:[...i,new n({value:2,size:0})]});const s=Object.keys(r).reduce(((t,s)=>({...t,[s]:[...i,new n({value:Math.max(2,r[s].minValue),size:e.clusterMinSize}),new n({value:Math.max(3,r[s].maxValue),size:e.clusterMaxSize})]})),{});return new ce({field:"cluster_count",levels:s})},ge=e=>{const t=t=>fe.error(new d("Unsupported-renderer",t,{renderer:e}));if("unique-value"===e.type){if(e.field2||e.field3)return t("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1}else if("class-breaks"===e.type){if(e.normalizationField){const n=e.normalizationType;if("field"!==n)return t(`FeatureReductionCluster does not support a normalizationType of ${n}`),!1}}else if("simple"!==e.type)return t(`FeatureReductionCluster does not support renderers of type ${e.type}`),!1;if(!de){if("valueExpression"in e&&e.valueExpression)return t("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in e&&e.visualVariables||[]).some((e=>!(!("valueExpression"in e)||!e.valueExpression))))return t("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};function he(e,t){const{name:n,outStatistic:r}=t,{onStatisticField:i,onStatisticValueExpression:s,statisticType:a}=r;if(s){const t=P(s.toLowerCase());e.push({name:n,outStatistic:{onStatisticField:t,onStatisticValueExpression:s,statisticType:a}})}else i?e.push({name:n,outStatistic:{onStatisticField:i,statisticType:a}}):fe.error(new d("mapview-unsupported-field","Unable to handle field",{field:t}))}function ve(e,t,n){const r=P(t),i="mode"===n?`cluster_type_${r}`:`cluster_avg_${r}`;return e.some((e=>e.name===i))||e.push({name:i,outStatistic:{onStatisticField:r,onStatisticValueExpression:t,statisticType:n}}),i}function xe(e,t,n,r){if("cluster_count"===t||e.some((e=>e.name===t)))return t;const i=function(e,t,n){switch(e){case"avg":case"avg_angle":return`cluster_avg_${t}`;case"mode":return`cluster_type_${t}`;case"norm":{const e=n,r="field",i=t.toLowerCase()+",norm:"+r+","+e.toLowerCase();return"cluster_avg_"+P(i)}}}(n,t,r);return e.some((e=>e.name===i))||e.push("norm"===n?{name:i,outStatistic:{onStatisticField:t,onStatisticNormalizationField:r,statisticType:n}}:{name:i,outStatistic:{onStatisticField:t,statisticType:n}}),i}const we=new p({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch",mesh:"mesh"});function Se(e){return we.toJSON(e)}const Me=i.getLogger("esri.views.2d.layers.features.schemaUtils"),Ve="ValidationError",Fe={esriGeometryPoint:["above-right","above-center","above-left","center-center","center-left","center-right","below-center","below-left","below-right"],esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:["center-along"],esriGeometryMultipoint:null};function ze(e){return S(e)}function Ie(e){var t;return"line-marker"===e.type?{type:"line-marker",color:null==(t=e.color)?void 0:t.toJSON(),placement:e.placement,style:e.style}:h(e.toJSON()).toJSON()}function Ee(e){let t=0,n=0,r=!1,i=!1;if(m(e)&&(n=H(e),"visualVariables"in e&&(t=function(e){if(!e)return v.NONE;let t=0;for(const n of e)if("size"===n.type){const e=V(n);t|=e,"outline"===n.target&&(t|=e<<4)}else"color"===n.type?t|=v.COLOR:"opacity"===n.type?t|=v.OPACITY:"rotation"===n.type&&(t|=v.ROTATION);return t}(e.visualVariables||[]),r="dot-density"===e.type),!r)){const t=e.getSymbols();"backgroundFillSymbol"in e&&e.backgroundFillSymbol&&t.push(e.backgroundFillSymbol);for(const e of t)if(("simple-fill"===e.type||"picture-fill"===e.type)&&e.outline&&"none"!==e.outline.style){if("solid"!==e.outline.style){i=!1;break}i=!0}}return{vvFlags:t,maxVVSize:n,isDD:r,isOutlinedFill:i}}function Te(e,t,n){return je(e,Ee(t),n)}function je(e,t,n){if(!e)return null;switch(e.type){case"simple-fill":case"picture-fill":return function(e,t,n,r){const i=M(x.FILL,t,r),s=n?ze(i):i,a=e.clone(),l=a.outline;r.isOutlinedFill||(a.outline=null);const o={materialKey:s,hash:a.hash(),isOutlinedFill:!!r.isOutlinedFill,...Ie(a)};if(r.isOutlinedFill)return o;const u=[];if(u.push(o),l){const e=M(x.LINE,t,{isOutline:!0}),r={materialKey:n?ze(e):e,hash:l.hash(),...Ie(l)};u.push(r)}return{type:"composite-symbol",layers:u,hash:u.reduce(((e,t)=>t.hash+e),"")}}(e,t.vvFlags,n,{isDD:t.isDD,isOutlinedFill:t.isOutlinedFill});case"simple-marker":case"picture-marker":return function(e,t,n,r){const i=M(x.MARKER,t),s=r?ze(i):i,a=Ie(e);return{materialKey:s,hash:e.hash(),...a,angle:e.angle,maxVVSize:n}}(e,t.vvFlags,t.maxVVSize,n);case"simple-line":return function(e,t,n){const r=M(x.LINE,t),i=n?ze(r):r,s=e.clone(),a=s.marker;s.marker=null;const l=[];if(l.push({materialKey:i,hash:s.hash(),...Ie(s)}),a){var o;const e=M(x.MARKER,t),r=n?ze(e):e;a.color=null!=(o=a.color)?o:s.color,l.push({materialKey:r,hash:a.hash(),lineWidth:s.width,...Ie(a)})}return{type:"composite-symbol",layers:l,hash:l.reduce(((e,t)=>t.hash+e),"")}}(e,t.vvFlags,n);case"text":return function(e,t,n,r){const i=M(x.TEXT,t),s=r?ze(i):i,a=Ie(e);return{materialKey:s,hash:e.hash(),...a,angle:e.angle,maxVVSize:n}}(e,t.vvFlags,t.maxVVSize,n);case"label":return function(e,t,n){const r=e.toJSON(),i=M(x.LABEL,t,{placement:r.labelPlacement});return{materialKey:n?ze(i):i,hash:e.hash(),...r,labelPlacement:r.labelPlacement}}(e,t.vvFlags,n);case"cim":return{type:"cim",rendererKey:t.vvFlags,data:e.data,maxVVSize:t.maxVVSize};case"CIMSymbolReference":return{type:"cim",rendererKey:t.vvFlags,data:e,maxVVSize:t.maxVVSize};case"web-style":return{...Ie(e),type:"web-style",hash:e.hash(),rendererKey:t.vvFlags,maxVVSize:t.maxVVSize};default:throw new Error(`symbol not supported ${e.type}`)}}function ke(e,t){const n=u(e);return n.some((e=>function(e,t){const n=e.labelPlacement,r=Fe[t];if(!e.symbol)return Me.warn("No ILabelClass symbol specified."),!0;if(!r)return Me.error(new d("mapview-labeling:unsupported-geometry-type",`Unable to create labels for Feature Layer, ${t} is not supported`)),!0;if(!r.some((e=>e===n))){const i=r[0];n&&Me.warn(`Found invalid label placement type ${n} for ${t}. Defaulting to ${i}`),e.labelPlacement=i}return!1}(e,t)))?[]:n}function _e(e){return c("esri-2d-update-debug")&&console.debug("Created new schema",Re(e,!0)),Re(e)}function Re(e,t=!1){try{var n,r;const i=function(e,t=!1){const n=new Array;return n.push(Ge(e,t)),n}(e,t),s={};return i.map((t=>function(e,t,n){switch(n.target){case"feature":return void $e(e,Oe(t),n);case"aggregate":{if(!("featureReduction"in t))return;const r=t.featureReduction;if("selection"===r.type)throw new d(Ve,"Mapview does not support `selection` reduction type",r);return $e(e,Oe(t),n),void function(e,t,n){e.aggregate||(e.aggregate={name:"aggregate",input:"feature",filters:null,attributes:{},params:{clusterRadius:b(t.clusterRadius/2),clusterPixelBuffer:64*Math.ceil(b(t.clusterMaxSize)/64),fields:n.aggregateFields}}),De(e.aggregate,n.attributes.fields)}(e,r,n)}}}(s,e,t))),{source:{definitionExpression:e.definitionExpression,fields:e.fields.map((e=>e.toJSON())),gdbVersion:e.gdbVersion,historicMoment:null==(n=e.historicMoment)?void 0:n.getTime(),outFields:e.availableFields,pixelBuffer:e.pixelBuffer,spatialReference:e.spatialReference.toJSON(),timeExtent:null==(r=e.timeExtent)?void 0:r.toJSON(),customParameters:e.customParameters},attributes:{fields:{},indexCount:0},processors:i,targets:s}}catch(e){if(e.fieldName===Ve)return Me.error(e),null;throw e}}function De(e,t){for(const n in t){const r=t[n];if(r.target!==e.name)continue;const i=e.attributes[n];i?(i.context.mesh=i.context.mesh||r.context.mesh,i.context.storage=i.context.storage||r.context.storage):e.attributes[n]=r}return e}function Oe(e){var t,n,i,s,a;return[null!=(t=null==(n=r(e.filter))?void 0:n.toJSON())?t:null,null!=(i=null==(s=r(null==(a=r(e.featureEffect))?void 0:a.filter))?void 0:s.toJSON())?i:null]}function $e(e,t,n){return e.feature||(e.feature={name:"feature",input:"source",filters:t,attributes:{}}),De(e.feature,n.attributes.fields),e}function Ke(e,t){return t.field?Pe(e,{...t,type:"field",field:t.field}):t.valueExpression?Pe(e,{...t,type:"expression",valueExpression:t.valueExpression}):{field:null,fieldIndex:null}}function Pe(e,t){switch(t.type){case"expression":{const n=t.valueExpression;if(!e.fields[n]){const r=e.indexCount++;e.fields[n]={...t,name:n,fieldIndex:r}}return{fieldIndex:e.fields[n].fieldIndex}}case"label-expression":{const n=JSON.stringify(t.label);if(!e.fields[n]){const r=e.indexCount++;e.fields[n]={...t,name:n,fieldIndex:r}}return{fieldIndex:e.fields[n].fieldIndex}}case"field":{const n=t.field;return"aggregate"===t.target&&e.fields[n]||(e.fields[n]={...t,name:n}),{field:n}}case"statistic":return e.fields[t.name]={...t},{field:t.name}}}function Ce(e,t,n,r,i,s=!1){const a=Pe(t,{type:"label-expression",target:r,context:{mesh:!0},resultType:"string",label:{labelExpression:n.labelExpression,labelExpressionInfo:n.labelExpressionInfo?{expression:n.labelExpressionInfo.expression}:null,symbol:!!n.symbol,where:n.where}}),{fieldIndex:l}=a;return{...Te(n,e,s),fieldIndex:l,target:r,index:i}}function Ge(t,n,r=!1){const i={indexCount:0,fields:{}},s="featureReduction"in t&&t.featureReduction,a=s?"aggregate":"feature";if("sublayers"in t){const e={type:"subtype",subtypeField:t.subtypeField,renderers:{}},n={type:"subtype",mapping:{},target:"feature"},s={type:"subtype",classes:{}},l={type:"symbol",target:"feature",aggregateFields:[],attributes:i,storage:n,mesh:{matcher:e,aggregateMatcher:null,labels:s,sortKey:null}},o=new Set;let u=0;for(const{renderer:l,subtypeCode:c,labelingInfo:f,labelsVisible:p}of t.sublayers){const t=Ae(i,a,l,r),y=Le(i,a,l),b=p&&f;if("visualVariables"in l&&l.visualVariables&&l.visualVariables.length)throw new d(Ve,"Visual variables are currently not supported for subtype layers");if("dictionary"===t.type)throw new d(Ve,"Dictionary renderer is not supported in subtype layers");if("subtype"===t.type)throw new d(Ve,"Nested subtype renderers is not supported");if(m(y)&&"subtype"===y.type)throw new d(Ve,"Nested subtype storage is not supported");if(m(y)&&"dot-density"===y.type)throw new d(Ve,"Dot density attributes are not supported in subtype layers");if(o.has(c))throw new d(Ve,"Subtype codes for sublayers must be unique");o.add(c),e.renderers[c]=t,n.mapping[c]=y,b&&(s.classes[c]=b.map((e=>Ce(l,i,e,"feature",u++,r))))}return l}if("heatmap"===t.renderer.type){const{blurRadius:e,fieldOffset:n,field:r}=t.renderer;return{type:"heatmap",aggregateFields:[],attributes:i,target:a,storage:null,mesh:{blurRadius:e,fieldOffset:n,field:Ke(i,{target:a,field:r,resultType:"numeric"}).field}}}{const n=[],l="aggregate"===a?pe(n,t.renderer,s,null):t.renderer;Ne(i,n);const o=Ae(i,a,l,r);let u=null;const c=Le(i,a,l),p=Se(t.geometryType);let m=t.labelsVisible&&t.labelingInfo||[],y=[];if(s){if("selection"===s.type)throw new d(Ve,"Mapview does not support `selection` reduction type",s);if(s.symbol){const t=new e({symbol:s.symbol,visualVariables:"visualVariables"in l?l.visualVariables:null});u=Ae(i,a,t,r)}y=s&&s.labelsVisible&&s.labelingInfo||[]}m=ke(m,p),y=ke(y,p);let b=0;const g=[...m.map((e=>Ce(l,i,e,"feature",b++,r))),...y.map((e=>Ce(l,i,e,"aggregate",b++,r)))],h=function(e,t){if(f(t)||!t.length)return null;t.length>1&&Me.warn(`Layer rendering currently only supports ordering by 1 orderByInfo, but found ${t.length}. All but the first will be discarded`);const n=t[0],r="ascending"===n.order?"asc":"desc";return n.field?{field:n.field,order:r}:n.valueExpression?{fieldIndex:Pe(e,{type:"expression",target:"feature",valueExpression:n.valueExpression,resultType:"numeric"}).fieldIndex,order:r}:(Me.error(new d(Ve,"Expected to find a field or valueExpression for OrderByInfo",n)),null)}(i,t.orderBy);return{type:"symbol",target:a,attributes:i,aggregateFields:n,storage:c,mesh:{matcher:o,labels:{type:"simple",classes:g},aggregateMatcher:u,sortKey:h}}}}function Ne(e,t){const n={mesh:!0,storage:!0};for(const r of t){const{name:t,outStatistic:i}=r,{statisticType:s,onStatisticField:a}=i;let l=null,o=null,u=null;const c="numeric",f="feature";"onStatisticValueExpression"in i?o=Pe(e,{type:"expression",target:f,valueExpression:i.onStatisticValueExpression,resultType:c}).fieldIndex:"onStatisticNormalizationField"in i?(l=Pe(e,{type:"field",target:f,field:a,resultType:c}).field,u=i.onStatisticNormalizationField):l=Pe(e,{type:"field",target:f,field:a,resultType:c}).field,Pe(e,{type:"statistic",target:"aggregate",name:t,context:n,inField:l,inNormalizationField:u,inFieldIndex:o,statisticType:s})}}function Le(e,t,n){switch(n.type){case"dot-density":return function(e,t,n){return n&&n.length?{type:"dot-density",mapping:n.map(((n,r)=>{const{field:i,fieldIndex:s}=Ke(e,{valueExpression:n.valueExpression,field:n.field,resultType:"numeric",target:t});return{binding:r,field:i,fieldIndex:s}})),target:t}:{type:"dot-density",mapping:[],target:t}}(e,t,n.attributes);case"simple":case"class-breaks":case"unique-value":case"dictionary":return function(e,t,n){if(!n||!n.length)return{type:"visual-variable",mapping:[],target:t};const r={storage:!0},i="numeric";return{type:"visual-variable",mapping:se(n).map((n=>{var s;const a=w(n.type),{field:l,fieldIndex:o}=Ke(e,{target:t,valueExpression:n.valueExpression,field:n.field,context:r,resultType:i});switch(n.type){case"size":return"$view.scale"===n.valueExpression?null:{type:"size",binding:a,field:l,fieldIndex:o,normalizationField:Ke(e,{target:t,field:n.normalizationField,context:r,resultType:i}).field,valueRepresentation:null!=(s=n.valueRepresentation)?s:null};case"color":return{type:"color",binding:a,field:l,fieldIndex:o,normalizationField:Ke(e,{target:t,field:n.normalizationField,context:r,resultType:i}).field};case"opacity":return{type:"opacity",binding:a,field:l,fieldIndex:o,normalizationField:Ke(e,{target:t,field:n.normalizationField,context:r,resultType:i}).field};case"rotation":return{type:"rotation",binding:a,field:l,fieldIndex:o}}})).filter((e=>e)),target:t}}(e,t,n.visualVariables);case"heatmap":return null}}function Ae(e,t,n,r=!1){const i=y(e,{indexCount:0,fields:{}});switch(n.type){case"simple":case"dot-density":return function(e,t,n,r=!1){const i=t.getSymbols();return{type:"simple",symbol:Te(i.length?i[0]:null,t,r),isDotDensity:n}}(0,n,"dot-density"===n.type,r);case"class-breaks":return function(e,t,n,r=!1){const i=n.backgroundFillSymbol,{field:s,fieldIndex:a}=Ke(e,{target:t,field:n.field,valueExpression:n.valueExpression,resultType:"numeric",context:{mesh:!0,use:"renderer.field"}}),l=n.normalizationType,o="log"===l?"esriNormalizeByLog":"percent-of-total"===l?"esriNormalizeByPercentOfTotal":"field"===l?"esriNormalizeByField":null,u=Ee(n),c=n.classBreakInfos.map((e=>({symbol:je(e.symbol,u,r),min:e.minValue,max:e.maxValue}))).sort(((e,t)=>e.min-t.min));return{type:"interval",attributes:e.fields,field:s,fieldIndex:a,backgroundFillSymbol:je(i,u,r),defaultSymbol:je(n.defaultSymbol,u,r),intervals:c,normalizationField:n.normalizationField,normalizationTotal:n.normalizationTotal,normalizationType:o,isMaxInclusive:n.isMaxInclusive}}(i,t,n,r);case"unique-value":return function(e,t,n,r=!1){const i=[],s=n.backgroundFillSymbol,a={target:t,context:{mesh:!0},resultType:"string"};if(n.field&&"string"!=typeof n.field)throw new d(Ve,"Expected renderer.field to be a string",n);const{field:l,fieldIndex:o}=Ke(e,{...a,field:n.field,valueExpression:n.valueExpression}),u=Ee(n);for(const e of n.uniqueValueInfos)i.push({value:""+e.value,symbol:je(e.symbol,u,r)});return{type:"map",attributes:e.fields,field:l,fieldIndex:o,field2:Ke(e,{...a,field:n.field2}).field,field3:Ke(e,{...a,field:n.field3}).field,fieldDelimiter:n.fieldDelimiter,backgroundFillSymbol:je(s,u),defaultSymbol:je(n.defaultSymbol,u),map:i}}(i,t,n,r);case"dictionary":return function(e,t){return{type:"dictionary",renderer:t.toJSON()}}(0,n)}}const Be=Object.freeze({__proto__:null,addAggregateFields:Ne,createMatcherSchema:Ae,createSchema:_e,createSymbolSchema:Te,getSymbolSchemaOptsFromRenderer:Ee});export{_e as M,Ae as _,J as a,me as b,G as c,q as d,Se as e,be as f,L as g,B as h,pe as i,Be as j,ge as m,A as p,ie as s,N as u,U as y,Te as z}