import{c as e,e as t,d as i,i as r,a as s,$ as n,at as a,A as u,T as o,af as l,s as f}from"./p-e58503d5.js";import{g as d}from"./p-1ab449fc.js";import{a as h,y as m}from"./p-6a92ecb9.js";import{y as p,I as c,a as y,v as F,A as w,V as g,N as v,_ as E,g as b,F as x,e as q}from"./p-765e6c28.js";import{b as P}from"./p-5e833dfc.js";import{d as I,t as O}from"./p-e285e8f3.js";import{o as j}from"./p-03d6250d.js";const N=e.getLogger("esri.views.layers.FeatureLayerView"),R=e=>{let R=class extends e{constructor(...e){super(...e),this._updatingRequiredFieldsPromise=null,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){s(this,["layer.renderer","layer.labelingInfo","layer.elevationInfo.featureExpressionInfo","layer.displayField","filter","featureEffect","layer.timeInfo","layer.floorInfo","timeExtent"],(()=>this._handleRequiredFieldsChange()),!0),n(this,"view.floors","change",(()=>this._handleRequiredFieldsChange())),n(this,"layer.sublayer","change",(()=>this._handleRequiredFieldsChange()))}get availableFields(){const{layer:e,layer:{fieldsIndex:t},requiredFields:i}=this;return p(t,"outFields"in e&&e.outFields?[...c(t,e.outFields),...i]:i)}set effect(e){a(N,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect=e}get effect(){return a(N,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(e){void 0!==e?this._override("featureEffect",e):this._clearOverride("featureEffect")}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){N.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=u(this.filter)?this.filter.createQuery(e):new P(e);if("feature"===this.layer.type){const e=j(this);u(e)&&(t.where=t.where?`(${t.where}) AND (${e})`:e)}return u(this.timeExtent)&&(t.timeExtent=u(t.timeExtent)?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}_loadArcadeModules(e){if(e.get("expressionInfos.length"))return y()}_handleRequiredFieldsChange(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then((()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null)}))}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fieldsIndex:i,objectIdField:r}}=this,s="renderer"in t&&t.renderer,n="orderBy"in t&&t.orderBy,a=t.featureReduction,l=new Set,f=await o([s?s.collectRequiredFields(l,i):null,F(l,t),e?w(l,t):null,u(this.filter)?g(l,t,this.filter):null,u(this.featureEffect)?g(l,t,this.featureEffect.filter):null,a?v(l,t,a):null,n?E(l,t,n):null]);if(t.timeInfo&&this.timeExtent&&b(l,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),"feature"===t.type&&t.floorInfo&&b(l,t.fieldsIndex,[t.floorInfo.floorField]),"subtype-group"===t.type){x(l,i,t.subtypeField);const e=t.sublayers.map((e=>{var t;return Promise.all([null==(t=e.renderer)?void 0:t.collectRequiredFields(l,i),F(l,e)])}));await o(e)}for(const e of f)e.error&&N.error(e.error);x(l,i,r),e&&"displayField"in t&&t.displayField&&x(l,i,t.displayField);const d=Array.from(l).sort();this._set("requiredFields",d)}validateFetchPopupFeatures(e){if(l(e))return null;for(const t of e.clientGraphics){const i=t.layer;if("popupEnabled"in i&&!i.popupEnabled)return new f("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:i});if("popupTemplate"in i&&!I(i,e))return new f("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:i})}}async fetchClientPopupFeatures(e){const t=u(e)?e.clientGraphics:null;if(!t||0===t.length)return Promise.resolve([]);const i=[],r=[],s=await this.createPopupQuery(e);for(const n of t){const{layer:t}=n;if(!("popupEnabled"in t))continue;const a=c(this.layer.fieldsIndex,s.outFields),o=I(t,e);if(!u(o))continue;const l=await this._loadArcadeModules(o);l&&l.arcadeUtils.hasGeometryOperations(o)||!q(a,n)?r.push(n):i.push(n)}return"stream"===this.layer.type||0===r.length?Promise.resolve(i):(s.objectIds=r.map((e=>e.attributes[this.layer.objectIdField])),this.layer.queryFeatures(s).then((e=>i.concat(e.features))).catch((()=>r)))}async createPopupQuery(e){const t=this.layer.createQuery(),i=new Set;let r=!1;const s=u(e)&&e.clientGraphics?e.clientGraphics.map((e=>e.layer)):[this.layer];for(const t of s){if(!("popupEnabled"in t))continue;const s=I(t,e);if(!u(s))continue;const n=await this._loadArcadeModules(s),a=n&&n.arcadeUtils.hasGeometryOperations(s);r=!("point"!==this.layer.geometryType&&!a);const o=await O(this.layer,s);for(const e of o)i.add(e)}if(t.returnGeometry=r,t.returnZ=r,t.returnM=r,t.outFields=Array.from(i),t.outSpatialReference=this.view.spatialReference,"feature"===this.layer.type){const e=j(this);u(e)&&(t.where=t.where?`(${t.where}) AND (${e})`:e)}return t}canResume(){return!(!super.canResume()||u(this.timeExtent)&&this.timeExtent.isEmpty)}};return t([i()],R.prototype,"_updatingRequiredFieldsPromise",void 0),t([i({readOnly:!0})],R.prototype,"availableFields",null),t([i()],R.prototype,"effect",null),t([i({type:h})],R.prototype,"featureEffect",null),t([i({type:m})],R.prototype,"filter",void 0),t([i(d)],R.prototype,"timeExtent",void 0),t([i()],R.prototype,"layer",void 0),t([i({type:Number})],R.prototype,"maximumNumberOfFeatures",null),t([i({readOnly:!0,type:Boolean})],R.prototype,"maximumNumberOfFeaturesExceeded",null),t([i({readOnly:!0})],R.prototype,"requiredFields",void 0),t([i()],R.prototype,"suspended",void 0),t([i()],R.prototype,"view",void 0),R=t([r("esri.views.layers.FeatureLayerView")],R),R};export{R as O}