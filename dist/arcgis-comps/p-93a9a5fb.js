import{n as t}from"./p-e3f0e7de.js";import{y as n,u as r,i as e,c as s,l as o,p as a,o as i,m as c,T as f,h as u,a as l,b as d,d as p,A as g,O as h,x as w,g as m,w as y,E as A,L as b,B as v,F as I,I as j,U,j as L,V as M,M as F,S,k,q as x,v as D,z as E,C as N,D as z,G as P,H as W}from"./p-19c767c2.js";import{c3 as $,ck as B,cl as O}from"./p-9ae46e68.js";import{A as _}from"./p-aaefdd7f.js";import{bW as G,bX as H,bd as T,bw as V,bY as X,bZ as Y,b_ as Z,b$ as q,c0 as C,c1 as J,c2 as K,bg as Q}from"./p-566b0715.js";import"./p-d925341f.js";import"./p-84bf99cb.js";import"./p-50875f24.js";import"./p-fe01b82b.js";function R(t,n,r){const e=n/3,s=new Uint32Array(r+1),o=new Uint32Array(r+1),a=(t,n)=>{t<n?s[t+1]++:o[n+1]++};for(let n=0;n<e;n++){const r=t[3*n],e=t[3*n+1],s=t[3*n+2];a(r,e),a(e,s),a(s,r)}let i=0,c=0;for(let t=0;t<r;t++){const n=s[t+1],r=o[t+1];s[t+1]=i,o[t+1]=c,i+=n,c+=r}const f=new Uint32Array(6*e),u=s[r],l=(t,n,r)=>{if(t<n){const e=s[t+1]++;f[2*e]=n,f[2*e+1]=r}else{const e=o[n+1]++;f[2*u+2*e]=t,f[2*u+2*e+1]=r}};for(let n=0;n<e;n++){const r=t[3*n],e=t[3*n+1],s=t[3*n+2];l(r,e,n),l(e,s,n),l(s,r,n)}const d=(t,n)=>{const r=2*t,e=n-t;for(let t=1;t<e;t++){const n=f[r+2*t],e=f[r+2*t+1];let s=t-1;for(;s>=0&&f[r+2*s]>n;s--)f[r+2*s+2]=f[r+2*s],f[r+2*s+3]=f[r+2*s+1];f[r+2*s+2]=n,f[r+2*s+3]=e}};for(let t=0;t<r;t++)d(s[t],s[t+1]),d(u+o[t],u+o[t+1]);const p=new Int32Array(3*e),g=(n,r)=>n===t[3*r]?0:n===t[3*r+1]?1:n===t[3*r+2]?2:-1,h=(t,n)=>{const r=g(t,n);p[3*n+r]=-1},w=(t,n,r,e)=>{const s=g(t,n);p[3*n+s]=e;const o=g(r,e);p[3*e+o]=n};for(let t=0;t<r;t++){let n=s[t];const r=s[t+1];let e=o[t];const a=o[t+1];for(;n<r&&e<a;){const r=f[2*n],s=f[2*u+2*e];r===s?(w(t,f[2*n+1],s,f[2*u+2*e+1]),n++,e++):r<s?(h(t,f[2*n+1]),n++):(h(s,f[2*u+2*e+1]),e++)}for(;n<r;)h(t,f[2*n+1]),n++;for(;e<a;)h(f[2*u+2*e],f[2*u+2*e+1]),e++}return p}function tt(t,n){return n.push(t.buffer),{buffer:t.buffer,layout:nt(t.layout)}}function nt(t){const n=new Array;return t.fields.forEach(((t,r)=>{const e={...t,constructor:et(t.constructor)};n.push([r,e])})),{stride:t.stride,fields:n,fieldNames:t.fieldNames}}const rt=[n,r,e,s,o,a,i,c,f,u,l,d,p,g,h,w,m,y,A,b,v,I,j,U,L,M,F,S,k,x,D,E,N,z,P,W];function et(t){return`${t.ElementType}_${t.ElementCount}`}const st=new Map;function ot(t,n=0){const r=t.stride;return t.fieldNames.filter((n=>{const r=t.fields.get(n).optional;return!(r&&r.glPadding)})).map((e=>{const s=t.fields.get(e),o=s.constructor.ElementCount,a=at(s.constructor.ElementType);return{name:e,stride:r,count:o,type:a,offset:s.offset,normalized:!(!s.optional||!s.optional.glNormalized),divisor:n}}))}function at(t){const n=it[t];if(n)return n;throw new Error("BufferType not supported in WebGL")}rt.forEach((t=>st.set(et(t),t)));const it={u8:5121,u16:5123,u32:5125,i8:5120,i16:5122,i32:5124,f32:5126},ct=_().vec3f("position").u16("componentIndex").u16("u16padding");ot(_().vec2u8("sideness"));const ft=_().vec3f("position0").vec3f("position1").u16("componentIndex").u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).u8("u8padding",{glPadding:!0}).u16("u16padding",{glPadding:!0}),ut=ft.clone().vec3f("normal"),lt=ft.clone().vec3f("normalA").vec3f("normalB");class dt{updateSettings(t){this.settings=t,this.edgeHashFunction=t.reducedPrecision?mt:wt}write(t,n,r){const e=this.edgeHashFunction(r);It.seed=e;const s=It.getIntRange(0,255),o=It.getIntRange(0,this.settings.variants-1),a=It.getFloat(),i=255*(.5*function(t){const n=t<0?-1:1;return Math.abs(t)**1.2*n}(-(1-Math.min(a/.7,1))+Math.max(0,a-.7)/(1-.7))+.5);t.position0.setVec(n,r.position0),t.position1.setVec(n,r.position1),t.componentIndex.set(n,r.componentIndex),t.variantOffset.set(n,s),t.variantStroke.set(n,o),t.variantExtension.set(n,i)}trim(t,n){return t.slice(0,n)}}const pt=new Float32Array(6),gt=new Uint32Array(pt.buffer),ht=new Uint32Array(1);function wt(t){const n=pt;n[0]=t.position0[0],n[1]=t.position0[1],n[2]=t.position0[2],n[3]=t.position1[0],n[4]=t.position1[1],n[5]=t.position1[2],ht[0]=5381;for(let t=0;t<gt.length;t++)ht[0]=31*ht[0]+gt[t];return ht[0]}function mt(t){const n=pt;n[0]=yt(t.position0[0]),n[1]=yt(t.position0[1]),n[2]=yt(t.position0[2]),n[3]=yt(t.position1[0]),n[4]=yt(t.position1[1]),n[5]=yt(t.position1[2]),ht[0]=5381;for(let t=0;t<gt.length;t++)ht[0]=31*ht[0]+gt[t];return ht[0]}function yt(t){return Math.round(1e4*t)/1e4}class At{constructor(){this.commonWriter=new dt}updateSettings(t){this.commonWriter.updateSettings(t)}allocate(t){return ut.createBuffer(t)}write(t,n,r){this.commonWriter.write(t,n,r),G(vt,r.faceNormal0,r.faceNormal1),H(vt,vt),t.normal.setVec(n,vt)}trim(t,n){return this.commonWriter.trim(t,n)}}At.Layout=ut,At.glLayout=ot(ut,1);class bt{constructor(){this.commonWriter=new dt}updateSettings(t){this.commonWriter.updateSettings(t)}allocate(t){return lt.createBuffer(t)}write(t,n,r){this.commonWriter.write(t,n,r),t.normalA.setVec(n,r.faceNormal0),t.normalB.setVec(n,r.faceNormal1)}trim(t,n){return this.commonWriter.trim(t,n)}}bt.Layout=lt,bt.glLayout=ot(lt,1);const vt=T(),It=new $,jt=-1;function Ut(t,n){return t.cosAngle<n}function Lt(t,n){return t.cosAngle>n}function Mt(t,n){const r=q(t.cosAngle),e=St.fwd,s=St.ortho;return C(e,t.position1,t.position0),r*(Y(Z(s,t.faceNormal0,t.faceNormal1),e)>0?-1:1)>n}function Ft(t){const n=t.faces.length/3,r=t.vertices.position,e=t.faces,s=kt.v0,o=kt.v1,a=kt.v2,i=new Float32Array(3*n);for(let t=0;t<n;t++){const n=e[3*t+1],c=e[3*t+2];r.getVec(e[3*t+0],s),r.getVec(n,o),r.getVec(c,a),J(o,o,s),J(a,a,s),Z(s,o,a),H(s,s),i[3*t+0]=s[0],i[3*t+1]=s[1],i[3*t+2]=s[2]}return i}const St={edge:{position0:T(),position1:T(),faceNormal0:T(),faceNormal1:T(),componentIndex:0,cosAngle:0},ortho:T(),fwd:T()},kt={v0:T(),v1:T(),v2:T()},xt={anglePlanar:4,angleSignificantEdge:35};async function Dt(t){const n=Nt(t),r=Et(n),e=[n.data.buffer];return{result:zt(r,e),transferList:e}}function Et(t){const n=Pt(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return Wt.updateSettings(t.writerSettings),$t.updateSettings(t.writerSettings),function(t,n,r,e=xt){const s=t.vertices.position,o=t.vertices.componentIndex,a=Q(e.anglePlanar),i=Q(e.angleSignificantEdge),c=Math.cos(i),f=Math.cos(a),u=St.edge,l=u.position0,d=u.position1,p=u.faceNormal0,g=u.faceNormal1,h=Ft(t),w=function(t){const n=t.faces.length/3,r=t.faces,e=t.neighbors;let s=0;for(let t=0;t<n;t++){const n=r[3*t+0],o=r[3*t+1],a=r[3*t+2];s+=e[3*t+0]===jt||n<o?1:0,s+=e[3*t+1]===jt||o<a?1:0,s+=e[3*t+2]===jt||a<n?1:0}const o=new Int32Array(4*s);let a=0;for(let t=0;t<n;t++){const n=e[3*t+0],s=e[3*t+1],i=e[3*t+2],c=r[3*t+0],f=r[3*t+1],u=r[3*t+2];(n===jt||c<f)&&(o[a++]=c,o[a++]=f,o[a++]=t,o[a++]=n),(s===jt||f<u)&&(o[a++]=f,o[a++]=u,o[a++]=t,o[a++]=s),(i===jt||u<c)&&(o[a++]=u,o[a++]=c,o[a++]=t,o[a++]=i)}return o}(t),m=w.length/4,y=n.allocate(m);let A=0;const b=r.allocate(m);let v=0,I=0,j=0;const U=B(0,m),L=new Float32Array(m);O(L,((t,n,r)=>{s.getVec(w[4*n+0],l),s.getVec(w[4*n+1],d),r[n]=K(l,d)})),U.sort(((t,n)=>L[n]-L[t]));const M=new Array,F=new Array;for(let t=0;t<m;t++){const e=U[t],i=L[e],m=w[4*e+0],S=w[4*e+1],k=w[4*e+2],x=w[4*e+3],D=x===jt;if(s.getVec(m,l),s.getVec(S,d),D)V(p,h[3*k+0],h[3*k+1],h[3*k+2]),X(g,p),u.componentIndex=o.get(m),u.cosAngle=Y(p,g);else{if(V(p,h[3*k+0],h[3*k+1],h[3*k+2]),V(g,h[3*x+0],h[3*x+1],h[3*x+2]),u.componentIndex=o.get(m),u.cosAngle=Y(p,g),Lt(u,f))continue;u.cosAngle<-.9999&&X(g,p)}I+=i,j++,D||Ut(u,c)?(n.write(y,A++,u),M.push(i)):Mt(u,a)&&(r.write(b,v++,u),F.push(i))}const S=new Float32Array(M.reverse()),k=new Float32Array(F.reverse());return{regular:{instancesData:n.trim(y,A),lodInfo:{lengths:S}},silhouette:{instancesData:r.trim(b,v),lodInfo:{lengths:k}},averageEdgeLength:I/j}}(n,Wt,$t)}function Nt(t){return{data:ct.createView(t.dataBuffer),indices:"Uint32Array"===t.indicesType?new Uint32Array(t.indicesBuffer):"Uint16Array"===t.indicesType?new Uint16Array(t.indicesBuffer):void 0,indicesLength:t.indicesLength,writerSettings:t.writerSettings,skipDeduplicate:t.skipDeduplicate}}function zt(t,n){return n.push(t.regular.lodInfo.lengths.buffer),n.push(t.silhouette.lodInfo.lengths.buffer),{regular:{instancesData:tt(t.regular.instancesData,n),lodInfo:{lengths:t.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:tt(t.silhouette.instancesData,n),lodInfo:{lengths:t.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:t.averageEdgeLength}}function Pt(n,r,e,s){if(r)return{faces:e,facesLength:s,neighbors:R(e,s,n.count),vertices:n};const o=t(n.buffer,n.stride/4,{originalIndices:e,originalIndicesLength:s}),a=R(o.indices,s,o.uniqueCount);return{faces:o.indices,facesLength:o.indices.length,neighbors:a,vertices:ct.createView(o.buffer)}}const Wt=new At,$t=new bt;export{Et as work,Dt as wrappedWork}