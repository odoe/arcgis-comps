import"./p-6448f4dc.js";import"./p-75cd09f2.js";import{e as t}from"./p-77b9a0fc.js";import{Z as s,$ as i,o as e,s as r,b as n,e as h,j as o,Y as a,i as c,S as l}from"./p-47e1bd73.js";import{E as u,C as f,b as m,P as d}from"./p-e3500fdc.js";import{R as p,B as M}from"./p-cd36fe2a.js";import{l as w}from"./p-237460e0.js";import{s as y,c9 as g,af as x,A as b,V as _,c as v,aW as S,bE as P,b as I,aw as L}from"./p-e58503d5.js";import{n as k,r as z,a as C,b as T}from"./p-f94ceb31.js";import{e as F}from"./p-2f398ed1.js";import{u as j,o as A}from"./p-fb38a9d0.js";import{g as G,o as R,A as B,b as E,p as N,r as W,c as V,d as O,e as D,n as U,f as q,h as K,i as $}from"./p-1a7268a2.js";import{f as J,i as H}from"./p-9b76ac50.js";import{w as X,m as Z}from"./p-b392deaf.js";import{_ as Q,e as Y,R as tt,U as st,f as it,F as et,B as rt,M as nt}from"./p-b9c93bb2.js";import{w as ht,e as ot}from"./p-5032dfbd.js";import{n as at}from"./p-d1d9dbe4.js";import{t as ct,n as lt}from"./p-56ed1c7a.js";import{n as ut,i as ft,c as mt}from"./p-1e473dab.js";import{r as dt,D as pt}from"./p-e6fe5d89.js";import{r as Mt,s as wt,y as yt}from"./p-2e8ad983.js";import{h as gt,M as xt}from"./p-a617738c.js";import"./p-97ec6ae5.js";import{t as bt}from"./p-182bb5be.js";import{G as _t}from"./p-dc15ecc1.js";import{e as vt,n as St}from"./p-9e860e7b.js";import{i as Pt,l as It}from"./p-8acbca5b.js";import{e as Lt}from"./p-e9bae5e9.js";import{p as kt}from"./p-765e6c28.js";import{s as zt}from"./p-0923eebd.js";function Ct(t,s){if(t&&"name"in t){const i=t;return s&&s.error(new y(i.name,i.message,i.details)),!1}return!0}class Tt{constructor(t,s){this._pos=0;const i=s?this._roundToNearest(s,t.BYTES_PER_ELEMENT):40;this._array=new ArrayBuffer(i),this._buffer=new t(this._array),this._ctor=t,this._i16View=new Int16Array(this._array)}get length(){return this._pos}_roundToNearest(t,s){const i=Math.round(t);return i+(s-i%s)}_ensureSize(t){if(this._pos+t>=this._buffer.length){const s=this._roundToNearest(1.5*(this._array.byteLength+t*this._buffer.BYTES_PER_ELEMENT),this._buffer.BYTES_PER_ELEMENT),i=new ArrayBuffer(s),e=new this._ctor(i);e.set(this._buffer,0),this._array=i,this._buffer=e,this._i16View=new Int16Array(this._array)}}ensureSize(t){this._ensureSize(t)}writeF32(t){this._ensureSize(1);const s=this._pos;return new Float32Array(this._array,4*this._pos,1)[0]=t,this._pos++,s}push(t){this._ensureSize(1);const s=this._pos;return this._buffer[this._pos++]=t,s}writeFixed(t){this._buffer[this._pos++]=t}setValue(t,s){this._buffer[t]=s}i1616Add(t,s,i){this._i16View[2*t]+=s,this._i16View[2*t+1]+=i}getValue(t){return this._buffer[t]}incr(t){if(this._buffer.length<t)throw new Error("Increment index overflows the target buffer");this._buffer[t]++}decr(t){this._buffer[t]--}writeRegion(t){this._ensureSize(t.length);const s=this._pos;return this._buffer.set(t,this._pos),this._pos+=t.length,s}writeManyFrom(t,s,i){this._ensureSize(i-s);for(let e=s;e!==i;e++)this.writeFixed(t._buffer[e])}buffer(){const t=this._array.slice(0,4*this._pos);return this.destroy(),t}toArray(){const t=this._array,s=[];for(let i=0;i<t.byteLength/4;i++)s.push(t[i]);return s}seek(t){this._pos=t}destroy(){this._array=null,this._buffer=null}}const Ft=new Map;Ft.set(u.MARKER,{multiplier:1,indicesPerRecord:6,verticesPerRecord:4}),Ft.set(u.LINE,{multiplier:1,indicesPerRecord:24,verticesPerRecord:8}),Ft.set(u.FILL,{multiplier:1,indicesPerRecord:10,verticesPerRecord:10}),Ft.set(u.TEXT,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4}),Ft.set(u.LABEL,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4});class jt{constructor(t,i,e){this._start={index:0,vertex:0};const r=function(t,i,e){const{indicesPerRecord:r,multiplier:n,verticesPerRecord:h}=Ft.get(t);return{recordBytes:e*s*Uint32Array.BYTES_PER_ELEMENT,indexBytes:n*r*e*Uint32Array.BYTES_PER_ELEMENT,vertexBytes:n*h*e*i}}(t,i,e),n=i/4;this.geometryType=t,this._records=new Tt(Int32Array,r.recordBytes),this._indices=new Tt(Uint32Array,r.indexBytes),this._vertices=new Tt(Uint32Array,r.vertexBytes),this._metrics=new Tt(Float32Array,0),this._strideInt=n}serialize(t){const s=this._records.buffer(),i=this._indices.buffer(),e=this._vertices.buffer(),r=this._metrics.length?this._metrics.buffer():null,n=4*this._strideInt;return t.push(s,i,e),{stride:n,records:s,indices:i,vertices:e,metrics:r}}get strideInt(){return this._strideInt}get recordCount(){return this._records.length/s}get vertexCount(){return this._vertices.length/this._strideInt}get indexCount(){return this._indices.length}get indexWriter(){return this._indices}get vertexWriter(){return this._vertices}get metricWriter(){return this._metrics}vertexEnsureSize(t){this._vertices.ensureSize(t)}indexEnsureSize(t){this._indices.ensureSize(t)}recordStart(){this._start.index=this._indices.length,this._start.vertex=this._vertices.length}recordEnd(t,s,i,e,r,n,h,o){this._records.push(t),this._records.push(s),this._records.push(i),this._records.push(e),this._records.push(r),this._records.push(n),this._records.push(h),this._records.writeF32(o)}writeIndex(t){this._indices.push(t)}writeVertex(t){this._vertices.push(t)}writeVertexF32(t){this._vertices.writeF32(t)}copyLastFrom(t,i,e){const r=t._records.length-s,n=t._records.getValue(r),h=t._records.getValue(r+1),o=t._records.getValue(r+2),a=t._records.getValue(r+4),c=t._records.getValue(r+6),l=t._records.getValue(r+7),u=this._vertices.length,f=(t._start.vertex-this._vertices.length)/this._strideInt,m=this._indices.length,d=this.vertexCount;for(let s=t._start.index;s!==t._indices.length;s++){const i=t._indices.getValue(s);this._indices.push(i-f)}for(let s=t._start.vertex;s!==t._vertices.length;s++){const i=t._vertices.getValue(s);this._vertices.push(i)}for(let t=u;t<=this._vertices.length;t+=this._strideInt)this._vertices.i1616Add(t,i,e);this._records.push(n),this._records.push(h),this._records.push(o),this._records.push(m),this._records.push(a),this._records.push(d),this._records.push(c),this._records.push(l)}}function At(t){switch(t){case 1:case 8:case 32:return-1;case 2:case 64:return 0;case 4:case 16:case 128:return 1}}function Gt(t){switch(t){case 1:case 2:case 4:return-1;case 8:case 16:return 0;case 32:case 64:case 128:return 1}}class Rt{constructor(t,s,i,e,r){this._hasDotDensity=!1,this._hasAggregate=!1,this.hasRecords=!1,this._data={self:new Map,neighbors:new Array},this._current={geometryType:0,writer:null,overlaps:0,start:0,insertAfter:0,sortKey:0,id:0,materialKey:0,indexStart:0,vertStart:0,isDotDensity:!1,bufferingEnabled:!1,metricBoxLenPointer:0},this.hint=s,this.tileKey=t,this._hasDotDensity=i,this._hasAggregate=e,this._pixelBufferEnabled=r}get hasAggregates(){return this._hasAggregate}get hasPixelBufferEnabled(){return this._pixelBufferEnabled}serialize(s){const i=[];return i.push(this._serializeTileVertexData(this.tileKey,this.tileKey,this._data.self)),this._data.neighbors.forEach(((e,r)=>{const n=1<<r,h=At(n),o=Gt(n),a=w(new t(this.tileKey),h,o,s),c=this._serializeTileVertexData(this.tileKey,a.id,e.vertexData);c.message.bufferIds=e.displayIds,i.push(c)})),i}_serializeTileVertexData(t,s,i){var e,r,n,h,o;const a=new Array;return{message:{tileKeyOrigin:t,tileKey:s,data:{[u.MARKER]:null==(e=i.get(u.MARKER))?void 0:e.serialize(a),[u.FILL]:null==(r=i.get(u.FILL))?void 0:r.serialize(a),[u.LINE]:null==(n=i.get(u.LINE))?void 0:n.serialize(a),[u.TEXT]:null==(h=i.get(u.TEXT))?void 0:h.serialize(a),[u.LABEL]:null==(o=i.get(u.LABEL))?void 0:o.serialize(a)}},transferList:a}}featureStart(t,s){this._current.insertAfter=t,this._current.sortKey=s}featureEnd(){}recordStart(t,s,i,e,r){this._current.writer=this._getVertexWriter(i,e),this._current.overlaps=0,this._current.indexStart=this._current.writer.indexCount,this._current.vertStart=this._current.writer.vertexCount,this._current.bufferingEnabled=r,this._current.id=t,this._current.materialKey=s,this._current.geometryType=i,this._current.isDotDensity=!1,this._current.writer.recordStart()}recordCount(){return this._current.writer.recordCount}vertexCount(){return this._current.writer.vertexCount}indexCount(){return this._current.writer.indexCount}vertexEnsureSize(t){this._current.writer.vertexEnsureSize(t)}indexEnsureSize(t){this._current.writer.indexEnsureSize(t)}vertexBounds(t,s,i,e){this._current.bufferingEnabled&&this._addOverlap(t,s,i,e)}vertexWrite(t){this._current.writer.writeVertex(t)}vertexWriteF32(t){this._current.writer.writeVertexF32(t)}vertexEnd(){}vertexWriter(){return this._current.writer.vertexWriter}indexWrite(t){this._current.writer.writeIndex(t)}indexWriter(){return this._current.writer.indexWriter}metricWriter(){return this._current.writer.metricWriter}metricStart(t,s,i,e,r,n,h,o){this._current.writer=this._getVertexWriter(u.LABEL,!1);const a=this._current.writer.metricWriter;a.push(p(t)),a.push(s),a.push(i),a.push(e),a.push(r),a.push(n),a.push(h),a.push(o),a.push(255),this._current.metricBoxLenPointer=a.push(0)}metricEnd(){const t=this._current.writer.metricWriter;0===t.getValue(this._current.metricBoxLenPointer)&&t.seek(t.length-10)}metricBoxWrite(t,s,i,e){const r=this._current.writer.metricWriter;r.incr(this._current.metricBoxLenPointer),r.push(0),r.push(0),r.push(t),r.push(s),r.push(i),r.push(e)}recordEnd(){const t=this._current.indexStart,s=this._current.writer.indexCount;if(t===s)return!1;this.hasRecords=!0;const e=this._current.vertStart;if(this._current.writer.recordEnd(this._current.id,this._current.materialKey,this._current.insertAfter,t,s-t,e,this._current.writer.vertexCount-e,this._current.sortKey),!this._pixelBufferEnabled||this._hasAggregate||0===this._current.overlaps||this._current.geometryType===u.LABEL)return!0;const r=this._current.writer;for(let t=0;t<8;t++){const s=1<<t;if(this._current.overlaps&s){this._data.neighbors[t]||(this._data.neighbors[t]={vertexData:new Map,displayIds:new Set});const e=this._data.neighbors[t],n=this._current.geometryType;if(!e.vertexData.has(n)){const t=f(n,this._current.isDotDensity).geometry,s=new jt(n,t,i);e.vertexData.set(n,s)}const h=e.vertexData.get(this._current.geometryType),o=8,a=512*-At(s)*o,c=512*-Gt(s)*o;h.copyLastFrom(r,a,c),e.displayIds.add(this._current.id)}}return!0}_addOverlap(t,s,i,r){this._current.overlaps|=255^((t<0+i?148:t>=e-i?41:189)|(s<0+r?224:s>=e-r?7:231))}_getVertexWriter(t,s){if(!this._data.self.has(t)){const s=this._data.self,i=f(t,this._hasDotDensity).geometry;s.set(t,new jt(t,i,this.hint.records))}return this._data.self.get(t)}}function Bt(t,s,i){return t[0]=s[0]-i[0],t[1]=s[1]-i[1],t}function Et(t,s){return Math.sqrt(t*t+s*s)}function Nt(t){const s=Et(t[0],t[1]);t[0]/=s,t[1]/=s}function Wt(t,s){return Et(t[0]-s[0],t[1]-s[1])}function Vt(t){return"function"==typeof t}function Ot(t=2){return 1/Math.max(t,1)}function Dt(t,s){return[!!t.minScale&&s.scaleToZoom(t.minScale)||0,!!t.maxScale&&s.scaleToZoom(t.maxScale)||100]}function Ut(t){return t.length-1}function qt(t,s,i=1){const[e,r]=function(t,s){return t[s+1]}(t,s);return Math.sqrt(e*e+r*r)*i}class Kt{constructor(t,s,i,e,r){this._segments=t,this._index=s,this._distance=i,this._xStart=e,this._yStart=r,this._done=!1}static create(t){return new Kt(t,0,0,t[0][0],t[0][1])}clone(){return new Kt(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(t){return this._index===t._index||t._index===this._index-1&&(0===this._distance||1===t._distance)||t._index===this._index+1&&(1===this._distance||0===t._distance)}leq(t){return this._index<t._index||this._index===t._index&&this._distance<=t._distance}geq(t){return this._index>t._index||this._index===t._index&&this._distance>=t._distance}get _segment(){return this._segments[this._index+1]}get angle(){const t=this.dy;let s=Math.acos((0*t+-1*-this.dx)/(1*this.length));return t>0&&(s=2*Math.PI-s),s}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:t,dy:s}=this;return Math.sqrt(t*t+s*s)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<Ut(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(t,s){const i=this.backwardLength;if(t<=i)return this._distance=(i-t)/this.length,this;let e=this.backwardLength;for(;this.prev();){if(e+this.length>t)return this._seekBackwards(t-e);e+=this.length}return this._distance=0,s?this:null}seek(t,s=!1){if(t<0)return this._seekBackwards(Math.abs(t),s);if(t<=this.remainingLength)return this._distance=(this.backwardLength+t)/this.length,this;let i=this.remainingLength;for(;this.next();){if(i+this.length>t)return this.seek(t-i,s);i+=this.length}return this._distance=1,s?this:null}}function $t(t,s,i){const e=function(t){let s=0;for(let i=0;i<Ut(t);i++)s+=qt(t,i);return s}(t),r=Kt.create(t),n=e/2,h=Math.floor((e-s)/2/s);r.seek(n-h*s);for(let t=-h;t<=h;t++)r.x<512&&r.x>=0&&r.y<512&&r.y>=0&&i(r.clone(),t,n+t*s,e),r.seek(s)}function Jt(t,s){const i=1e-6;if(s<=0)return;const e=t.length;if(e<3)return;const r=[];let n=0;r.push(0);for(let s=1;s<e;s++)n+=Wt(t[s],t[s-1]),r.push(n);s=Math.min(s,.2*n);const h=[];h.push(t[0][0]),h.push(t[0][1]);const o=t[e-1][0],a=t[e-1][1],c=Bt([0,0],t[0],t[1]);Nt(c),t[0][0]+=s*c[0],t[0][1]+=s*c[1],Bt(c,t[e-1],t[e-2]),Nt(c),t[e-1][0]+=s*c[0],t[e-1][1]+=s*c[1];for(let t=1;t<e;t++)r[t]+=s;r[e-1]+=s;const l=.5*s;for(let n=1;n<e-1;n++){let o=0,a=0,c=0;for(let e=n-1;e>=0&&!(r[e+1]<r[n]-l);e--){const h=l+r[e+1]-r[n],u=r[e+1]-r[e],f=r[n]-r[e]<l?1:h/u;if(Math.abs(f)<i)break;const m=f*f,d=f*h-.5*m*u,p=f*u/s,M=t[e+1],w=t[e][0]-M[0],y=t[e][1]-M[1];o+=p/d*(M[0]*f*h+.5*m*(h*w-u*M[0])-m*f*u*w/3),a+=p/d*(M[1]*f*h+.5*m*(h*y-u*M[1])-m*f*u*y/3),c+=p}for(let h=n+1;h<e&&!(r[h-1]>r[n]+l);h++){const e=l-r[h-1]+r[n],u=r[h]-r[h-1],f=r[h]-r[n]<l?1:e/u;if(Math.abs(f)<i)break;const m=f*f,d=f*e-.5*m*u,p=f*u/s,M=t[h-1],w=t[h][0]-M[0],y=t[h][1]-M[1];o+=p/d*(M[0]*f*e+.5*m*(e*w-u*M[0])-m*f*u*w/3),a+=p/d*(M[1]*f*e+.5*m*(e*y-u*M[1])-m*f*u*y/3),c+=p}h.push(o/c),h.push(a/c)}h.push(o),h.push(a);for(let s=0,i=0;s<e;s++)t[s][0]=h[i++],t[s][1]=h[i++]}class Ht{static getPlacement(t,s,i){const e=G(s);if(!e)return null;const r=R(t);return e.execute(r,s,i)}}const Xt=t=>class extends t{constructor(...t){super(...t),this._isCIM=!1,this._vertexBoundsScale=1,this.geometryType=u.TEXT,this._aux=X(0,0,this._referenceSize,this._bitset)}bindTextInfo(t,s){this._shapingInfo=t&&t.length?g(t,(t=>B(t,s,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:r*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM}))):null}_write(t,s,i){const e=s.getDisplayId();this._writeGeometry(t,s,e,i)}_writeGeometry(t,s,i,e){const r=this._shapingInfo;if(x(r))return;if(b(this._textPlacement)){const n=null!=e?e:s.readLegacyGeometryForDisplay();return this._writePlacedText(t,i,n,r)}const n=e?ht(ot(e),2):"esriGeometryPolygon"===s.geometryType?s.readCentroid():s.readGeometryForDisplay();if(!x(n)){if(n.isPoint){const[s,e]=n.coords;return this._writeGlyphs(t,i,{x:s,y:e},r)}n.forEachVertex(((s,e)=>this._writeGlyphs(t,i,{x:s,y:e},r)))}}_writePlacedText(t,s,i,e){const r=_(this._textPlacement),n=Ht.getPlacement(i,r,j(1));if(!n)return;let h=n.next();for(;null!=h;){const i=h.getAngle();e.setRotation(i);const r=h.tx,o=h.ty;r<0||r>=512||o<0||o>=512||(this._writeGlyphs(t,s,{x:r,y:o},e),e.setRotation(-i)),h=n.next()}}_writeGlyphs(t,s,i,e){const r=Q.load(this._materialKey),n=Z(Math.round(8*i.x),Math.round(8*i.y)),h=this._vertexBoundsScale,o=e.bounds,a=2*Math.max(o.width,o.height);for(const c of e.glyphs)r.textureBinding=c.textureBinding,t.recordStart(s,r.data,this.geometryType,!1,!0),t.vertexBounds(i.x+o.x+this._xOffset,i.y+o.y-this._yOffset,a*h,a*h),this._writeVertices(t,s,n,c),t.recordEnd()}_writeGlyph(t,s,i,e,r){const n=Q.load(this._materialKey),h=Z(Math.round(8*i),Math.round(8*e));n.textureBinding=r.textureBinding,t.recordStart(s,n.data,this.geometryType,!1,!0);const o=r.bounds,a=this._vertexBoundsScale;t.vertexBounds(i+o.x*a,e+o.y*a,o.width*a,o.height*a),this._writeVertices(t,s,h,r),t.recordEnd()}_writeVertices(t,s,i,e){const r=t.vertexCount();this._writeVertexCommon(t,s,i,e),t.vertexWrite(e.offsets.upperLeft),t.vertexWrite(e.texcoords.upperLeft),t.vertexEnd(),this._writeVertexCommon(t,s,i,e),t.vertexWrite(e.offsets.upperRight),t.vertexWrite(e.texcoords.upperRight),t.vertexEnd(),this._writeVertexCommon(t,s,i,e),t.vertexWrite(e.offsets.lowerLeft),t.vertexWrite(e.texcoords.lowerLeft),t.vertexEnd(),this._writeVertexCommon(t,s,i,e),t.vertexWrite(e.offsets.lowerRight),t.vertexWrite(e.texcoords.lowerRight),t.vertexEnd(),t.indexWrite(r+0),t.indexWrite(r+1),t.indexWrite(r+2),t.indexWrite(r+1),t.indexWrite(r+3),t.indexWrite(r+2)}_writeVertexCommon(t,s,i,e){const r=this._color,n=this._haloColor,h=X(0,0,this._referenceSize,this._bitset),o=X(0,0,this._size,this._haloSize);t.vertexWrite(i),t.vertexWrite(s),t.vertexWrite(r),t.vertexWrite(n),t.vertexWrite(o),t.vertexWrite(h),t.vertexWrite(this._minMaxZoom)}};class Zt{static executeEffects(t,s){const i=R(s);let e=new W(i);for(const s of t){const t=E(s);t&&(e=t.execute(e,s,1.3333333333333333))}return e}static next(t){const s=t.next();return N(s),s}}class Qt{bindFeature(t,s,i){}write(t,s,i){var e;if(x(this._effects)||0===(null==(e=this._effects)?void 0:e.length))return this._write(t,s);const r=Zt.executeEffects(this._effects,s.readLegacyGeometryForDisplay());let n=Zt.next(r);for(;n;)this._write(t,s,n),n=Zt.next(r)}_write(t,s,i){}}class Yt extends(Xt(Qt)){constructor(t,s,i,e,r,o,a,c,l,u,f,m,d,p,M,w,y,g=!1,x,b){super(),this._xOffset=j(m),this._yOffset=j(d),this._decoration=l||"none",this._color=e,this._haloColor=r,this._haloSize=Math.min(Math.floor(5*j(A(i))),127),this._size=Math.min(Math.round(j(s)),127);const _=Math.min(Math.round(j(s)),127);this._referenceSize=Math.round(Math.sqrt(256*_)),this._scale=this._size/n,this._angle=f,this._justify=V(o||"center"),this._xAlignD=O(o||"center"),this._yAlignD=D(a||"baseline"),this._baseline="baseline"===(a||"baseline"),this._bitset=(1===c?1:0)|(u?1:0)<<1;const v=Q.load(t);v.sdf=!0,this._materialKey=v.data,this._lineWidth=j(p)||512,this._lineHeight=M||1,this._textPlacement=w,this._effects=y,this._isCIM=g,this._minMaxZoom=Z(Math.round(x*h),Math.round(b*h))}static fromText(t,s){const i=new Yt(t.materialKey,t.font.size,t.haloSize||0,t.color&&J(t.color)||0,t.haloColor&&J(t.haloColor)||0,t.horizontalAlignment,t.verticalAlignment,0,t.font.decoration,!1,t.angle||0,t.xoffset,t.yoffset,t.lineWidth,t.lineHeight,null,null,!1,0,100),[,e]=U(t.text);return i.bindTextInfo(s,e),i._vertexBoundsScale=t.maxVVSize?t.maxVVSize/t.font.size:1,i}static fromCIMText(t,s,i){const e=t.scaleFactor||1,r=t.size*t.sizeRatio*e,[n,h]=Dt(t.scaleInfo,i),o=new Yt(t.materialKey,r,t.outlineSize*t.sizeRatio,H(t.color),H(t.outlineColor),t.horizontalAlignment,t.verticalAlignment,t.alignment,t.decoration,t.colorLocked,t.angle,t.offsetX*t.sizeRatio*e,t.offsetY*t.sizeRatio*e,512,1,t.markerPlacement,t.effects,!0,n,h),[,a]=U(t.text);return o.bindTextInfo(s,a),o._vertexBoundsScale=t.maxVVSize?t.maxVVSize/r:1,o}}const ts=v.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),ss=function(){const t=new Map;return s=>(t.has(s)||t.set(s,(t=>{let s=0;if(0===t)return 1/0;for(;!(t%2);)s++,t/=2;return s})(s)),t.get(s))}(),is=t=>Math.floor(127*t+127),es=t=>Math.floor(10*t),rs=t=>Math.round(t*(254/360));class ns extends Yt{constructor(t,s,i,e){super(t,i.font.size,i.haloSize||0,i.color&&J(i.color)||0,i.haloColor&&J(i.haloColor)||0,i.horizontalAlignment,i.verticalAlignment,Y(s.labelPlacement)?1:0,i.font.decoration,!1,i.angle||0,i.xoffset,i.yoffset,i.lineWidth,i.lineHeight,null,null,null,null,null),this._outLineLabelAngle=0,this._refPlacementPadding=0,this._refPlacementDirX=0,this._refPlacementDirY=0,this._refOffsetX=0,this._refOffsetY=0,this._zoomLevel=0,this.geometryType=u.LABEL;const r=function(t,s){const i=!!t.minScale&&s.scaleToZoom(t.minScale)||0;return F(i,0,25.5)}(s,e),n=function(t,s){const i=!!t.maxScale&&s.scaleToZoom(t.maxScale)||255;return F(i,0,25.5)}(s,e),h=s.labelPlacement,[a,c]=q(h);this._xAlignD=a,this._yAlignD=c,this._minZoom=r,this._maxZoom=n,this._refPlacementPadding=j(i.haloSize)+o;const l=tt.load(t);l.sdf=!0,this._materialKey=l.data}static fromLabelClass(t,s){if("esriServerLinePlacementCenterAlong"===t.labelPlacement){const s=t.symbol;s.xoffset=0,s.yoffset=0,s.angle=0,s.font.decoration="none"}return new ns(t.materialKey,t,t.symbol,s)}get _shapedBox(){return _(this._shapingInfo).bounds}setZoomLevel(t){this._zoomLevel=t}bindReferenceTemplate(t){let s=K(this._xAlignD),i=$(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,x(t))return void(this._refSymbolAndPlacementOffset=X(0,0,is(s),is(i)));if("circle"===t.boundsType&&(s||i)){const t=Math.sqrt(s*s+i*i);s/=t,i/=t}const e=Math.max(t.height,t.width);this._refSymbolAndPlacementOffset=X(4*this._refPlacementPadding,e,is(s),is(i)),this._referenceSize=e,this._refPlacementDirX=s,this._refPlacementDirY=i,this._refOffsetX=t.xOffset,this._refOffsetY=t.yOffset}_write(t,s){if(x(this._shapingInfo))return;const i=this._shapingInfo,e=s.getDisplayId(),r="esriGeometryPolygon"===s.geometryType?s.readLegacyCentroid():s.readLegacyGeometry();if(r)switch(this.current={out:t,inId:e,inShaping:i,zoomLevel:this._zoomLevel},s.geometryType){case"esriGeometryPolyline":this._placeLineLabels(r);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(r);break;default:((t,s="mapview-labeling")=>{ts.error(new y(s,"mapview-labeling"))})(0,`Geometry of type ${s.geometryType} is not supported`)}}_isVisible(t,s){const i=es(this.current.zoomLevel);return es(t)<=i&&i<=es(s)}_placePointLabels(t){const{out:s,inId:i,inShaping:e}=this.current;this._writeGlyphs(s,i,t,e)}_placeLineLabels(t){const s=function(t,s){const i=s;for(let s=0;s<t.length;s++){let e=t[s];const r=[];r.push(e[0]);for(let t=1;t<e.length;t++){let[s,i]=r[t-1];s+=e[t][0],i+=e[t][1],r.push([s,i])}Jt(r,i);const n=[];n.push(r[0]);for(let t=1;t<r.length;t++){const[s,i]=r[t-1],[e,h]=r[t],o=Math.round(e-s),a=Math.round(h-i);n.push([o,a])}t[s]=n,e=n}return t}(t.paths,this.current.inShaping.bounds.width),i=this._placeSubdivGlyphs.bind(this),e=(this._shapedBox.width+128)/2;for(const t of s)$t(t,e,i)}_placeSubdivGlyphs(t,s,i,e){const r=ss(s),n=this._shapedBox.width/2,h=Math.min(i,e-i),o=Math.log2(h/(8+n/2)),a=0===s?o:Math.min(r,o),c=Math.max(this._minZoom,this.current.zoomLevel+1-a),l=this._shapedBox.width/2*2**(this.current.zoomLevel-c);this.current.inShaping.isMultiline?0===s&&this._placeStraight(t,c):this._placeCurved(t,c,l)}_placeStraight(t,s){const{out:i,inId:e,inShaping:r}=this.current;this._writeGlyphs(i,e,t,r,s)}_placeCurved(t,s,i){const{out:e,inId:r}=this.current;e.metricStart(r,s,t.x,t.y,0,0,0,0);const n=t.clone(),h=t.angle*(180/Math.PI)%360,o=(t.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=rs(h),this._placeFirst(n,s,1),this._placeBack(t,n,s,i,1),this._placeForward(t,n,s,i,1),this._outLineLabelAngle=rs(o),this._placeFirst(n,s,0),this._placeBack(t,n,s,i,0),this._placeForward(t,n,s,i,0),e.metricEnd()}_placeBack(t,s,i,e,r){const n=t.clone();let h=t.backwardLength+0;for(;n.prev()&&!(h>=e);)this._placeOnSegment(n,s,h,i,-1,r),h+=n.length+0}_placeForward(t,s,i,e,r){const n=t.clone();let h=t.remainingLength+0;for(;n.next()&&!(h>=e);)this._placeOnSegment(n,s,h,i,1,r),h+=n.length+0}_placeFirst(t,s,i){const e=t,r=this.current.inShaping,n=r.glyphs,h=this.current.zoomLevel,{out:o,inId:a}=this.current;for(const c of n){const n=c.x>r.bounds.x?i:1-i,l=n*t.remainingLength+(1-n)*t.backwardLength,u=Math.abs(c.x+c.width/2-r.bounds.x),f=Math.max(0,h+Math.log2(u/(l+0))),m=Math.max(s,f);if(c.maxZoom=25,c.angle=t.angle+(1-i)*Math.PI,c.minZoom=m,this._writeGlyph(o,a,e.x,e.y,c),i&&this._isVisible(c.minZoom,c.maxZoom)){const t=c.bounds;o.metricBoxWrite(t.center[0],t.center[1],t.width,t.height)}}}_placeOnSegment(t,s,i,e,r,n){const h=this.current.inShaping.glyphs,{out:o,inId:a}=this.current,c=this.current.inShaping,l=this.current.zoomLevel,u={x:t.x+i*-r*(t.dx/t.length),y:t.y+i*-r*(t.dy/t.length)};for(const f of h){const h=f.x>c.bounds.x?n:1-n;if(!(h&&1===r||!h&&-1===r))continue;const m=Math.abs(f.x+f.width/2-c.bounds.x),d=Math.max(0,l+Math.log2(m/i)-.1),p=Math.max(e,l+Math.log2(m/(i+t.length+0)));if(0!==d&&(f.angle=t.angle+(1-n)*Math.PI,f.minZoom=p,f.maxZoom=d,this._writeGlyph(o,a,u.x,u.y,f),n&&this._isVisible(f.minZoom,f.maxZoom))){const i=f.bounds;o.metricBoxWrite(i.center[0]+(t.x-s.x),i.center[1]+(t.y-s.y),i.width,i.height)}}}_writeGlyphs(t,s,i,e,r=this._minZoom){if(i.x<0||i.x>=512||i.y<0||i.y>=512)return;const n=i.x+this._refOffsetX,h=i.y-this._refOffsetY;for(const i of e.glyphs)i.minZoom=r,i.maxZoom=this._maxZoom,this._writeGlyph(t,s,n,h,i);const o=e.boundsT;t.metricStart(s,r,n,h,this._refPlacementDirX,this._refPlacementDirY,this._referenceSize,this._materialKey),t.metricBoxWrite(o.center[0],o.center[1],o.width,o.height),t.metricEnd()}_writeVertexCommon(t,s,i,e){const r=this._color,n=this._haloColor,h=X(0,0,this._size,this._haloSize),o=Math.max(e.minZoom,this._minZoom),a=Math.min(e.maxZoom,this._maxZoom),c=X(es(o),es(a),this._outLineLabelAngle,0);t.vertexWrite(i),t.vertexWrite(s),t.vertexWrite(r),t.vertexWrite(n),t.vertexWrite(h),t.vertexWrite(this._refSymbolAndPlacementOffset),t.vertexWrite(c)}}const hs=3.14159265359/180,os=t=>class extends t{constructor(...t){super(...t),this.angle=0,this.xOffset=0,this.yOffset=0,this.width=0,this.height=0,this.boundsType="square",this._anchorX=0,this._anchorY=0,this._computedWidth=0,this._computedHeight=0,this._vertexBoundsScaleX=1,this._vertexBoundsScaleY=1,this._offsets={xUpperLeft:0,yUpperLeft:0,xUpperRight:0,yUpperRight:0,xBottomLeft:0,yBottomLeft:0,xBottomRight:0,yBottomRight:0},this.geometryType=u.MARKER}_write(t,s,i){const e=s.getDisplayId();t.recordStart(e,this._materialKey,this.geometryType,!1,!0),this._writeGeometry(t,s,e,i),t.recordEnd()}_writeGeometry(t,s,i,e){if(b(this._markerPlacement))return this._writePlacedMarkers(t,s,e);const r=e?ht(ot(e),2):"esriGeometryPolygon"===s.geometryType?s.readCentroid():s.readGeometryForDisplay();if(!x(r)){if(r.isPoint){const[s,e]=r.coords;if(!t.hasAggregates&&t.hasPixelBufferEnabled&&(s<-1||s>=513||e<-1||e>=513))return;return this._writeVertices(t,i,this._getPos(s,e),s,e)}r.forEachVertex(((s,e)=>this._writeVertices(t,i,this._getPos(s,e),s,e)))}}_writePlacedMarkers(t,s,i){const e=null!=i?i:s.readLegacyGeometryForDisplay(),r=Ht.getPlacement(e,_(this._markerPlacement),j(1));if(!r)return;const n=s.getDisplayId(),h=lt(),o=at();let a=r.next();for(;null!=a;){const{tx:s,ty:i}=a;s>=-128&&s<=640&&i>=-128&&i<=640&&(this._applyTransformation(o,h,a.getAngle()/hs),this._writeVertices(t,n,this._getPos(s,i),s,i)),a=r.next()}}_writeVertices(t,s,i,e,r){const n=t.vertexCount();t.vertexBounds(e+this.xOffset,r-this.yOffset,this._computedWidth*this._vertexBoundsScaleX,this._computedHeight*this._vertexBoundsScaleY),t.vertexWrite(i),t.vertexWrite(this._offsetUpperLeft),t.vertexWrite(this._texUpperLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(s),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetUpperRight),t.vertexWrite(this._texUpperRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(s),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomLeft),t.vertexWrite(this._texBottomLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(s),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomRight),t.vertexWrite(this._texBottomRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(s),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.indexWrite(n+0),t.indexWrite(n+1),t.indexWrite(n+2),t.indexWrite(n+1),t.indexWrite(n+3),t.indexWrite(n+2)}_applyTransformation(t,s,i=0){ut(t),ft(t,t,ct(this.xOffset,-this.yOffset)),this.angle+i!==0&&mt(t,t,hs*(this.angle+i));const e=this._computedWidth,r=this._computedHeight,n=(this._anchorX-.5)*e,h=(this._anchorY-.5)*r;dt(s,n,h),pt(s,s,t),this._offsetUpperLeft=Z(16*s[0],16*s[1]),this._offsets.xUpperLeft=s[0],this._offsets.yUpperLeft=s[1],dt(s,n+e,h),pt(s,s,t),this._offsetUpperRight=Z(16*s[0],16*s[1]),this._offsets.xUpperRight=s[0],this._offsets.yUpperRight=s[1],dt(s,n,h+r),pt(s,s,t),this._offsetBottomLeft=Z(16*s[0],16*s[1]),this._offsets.xBottomLeft=s[0],this._offsets.yBottomLeft=s[1],dt(s,n+e,h+r),pt(s,s,t),this._offsetBottomRight=Z(16*s[0],16*s[1]),this._offsets.xBottomRight=s[0],this._offsets.yBottomRight=s[1]}_getPos(t,s){return Z(Math.round(8*t),Math.round(8*s))}};class as extends(os(Qt)){constructor(t,s,i,e,r,n,o,c,l,u,f,m,d,p,M,w,y,g,x,b,_,v,S){super(),this.angle=e,this.height=o,this.width=n,this.xOffset=s*x,this.yOffset=i*x,this._markerPlacement=b,this._effects=_,this._anchorX=.5-(.5+w)*M.width/M.width,this._anchorY=.5-(.5+y)*M.height/M.height,this._minMaxZoom=Z(Math.round(v*h),Math.round(S*h));const P=(1===p?1:0)|(f?1:0)<<1|(d?1:0)<<2|(m?1:0)<<3,I=M&&M.sdf,L=st.load(t);L.sdf=I,L.pattern=!0,L.textureBinding=M.textureBinding,this._materialKey=L.data,this._fillColor=r,this._outlineColor=l,this._sizeOutlineWidth=X(Math.round(Math.min(Math.sqrt(128*n),255)),Math.round(Math.min(Math.sqrt(128*o),255)),Math.round(Math.min(Math.sqrt(128*u),255)),Math.round(Math.min(Math.sqrt(128*c),255)));const k=M.rect.x+a,z=M.rect.y+a,C=k+M.width,T=z+M.height;this._offsets.xUpperLeft=k,this._offsets.yUpperLeft=z,this._offsets.xUpperRight=C,this._offsets.yUpperRight=z,this._offsets.xBottomLeft=k,this._offsets.yBottomLeft=T,this._offsets.xBottomRight=C,this._offsets.yBottomRight=T,this._texUpperLeft=Z(k,z),this._texUpperRight=Z(C,z),this._texBottomLeft=Z(k,T),this._texBottomRight=Z(C,T),n*=g,o*=g,n*=x,o*=x;const F=Math.round(64*g);this._bitestAndDistRatio=Z(P,F),this._computedWidth=n,this._computedHeight=o;const j=lt(),A=at();this._applyTransformation(A,j)}static fromCIMMarker(t,s,i){const e=t.size,r=(s&&s.width||1)/(s&&s.height||1)*t.scaleX,n=t.scaleSymbolsProportionally&&t.frameHeight?e/t.frameHeight:1;let h=H(t.color);const o=H(t.outlineColor),a=j(e),c=a*r,l=j(t.offsetX||0),u=j(t.offsetY||0),f=j(t.outlineWidth||0)*n,m=t.alignment||0,d=j(t.referenceSize),[p,M]=Dt(t.scaleInfo,i);s.sdf||0!==h||(h=-1);let w=t.rotation||0;t.rotateClockwise||(w=-w);let y=0,g=0;const x=t.anchorPoint;x&&(t.isAbsoluteAnchorPoint?e&&(y=-x.x/(e*r),g=x.y/e):(y=x.x,g=x.y));const b=new as(t.materialKey,l,u,w,h,c,a,d,o,f,t.colorLocked,t.scaleSymbolsProportionally,!1,m,s,y,g,t.sizeRatio,S(t.scaleFactor,1),t.markerPlacement,t.effects,p,M);return b._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/c:1,b._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/a:1,b}static fromPictureMarker(t,s){const i=Math.round(j(t.width)),e=Math.round(j(t.height)),r=c,n=Math.round(j(t.xoffset||0)),h=Math.round(j(t.yoffset||0)),o=new as(t.materialKey,n,h,t.angle,r,i,e,e,0,0,!1,!1,!1,0,s,0,0,1,1,null,null,0,100);return o._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/t.width:1,o._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/t.height:1,o}static fromSimpleMarker(t,s){const i=J(t.color),e=Math.round(j(t.size)),r=e,n=Math.round(j(t.xoffset||0)),h=Math.round(j(t.yoffset||0)),o=t.style,a=t.outline,c=0|(a&&a.color&&J(a.color)),l=0|(a&&a.width&&Math.round(j(a.width))),u=new as(t.materialKey,n,h,t.angle,i,e,r,r,c,l,!1,!1,"esriSMSCross"===o||"esriSMSX"===o,0,s,0,0,126/64,1,null,null,0,100);return u.boundsType="esriSMSCircle"===o?"circle":"square",u._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/t.size:1,u._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/t.size:1,u}static fromLineSymbolMarker(t,s){const i=J(t.color),e=Math.round(j(6*t.lineWidth)),r=e,n="cross"===t.style||"x"===t.style;let h;switch(t.placement){case"begin-end":h="Both";break;case"begin":h="JustBegin";break;case"end":h="JustEnd";break;default:h="None"}const o={type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:h,offsetAlongLine:0},a=new as(t.materialKey,0,0,0,i,e,r,r/6,i,n?Math.round(j(t.lineWidth)):0,!1,!1,n,1,s,0,0,126/64,1,o,null,0,100);return a.boundsType="circle"===t.style?"circle":"square",a}}function cs(t,s,i,e,r,n,h){js=0;const o=(e-i)*n,a=r&&r.length,c=a?(r[0]-i)*n:o;let l,u,f,m,d,p=ls(s,i,0,0,c,n,!0);if(p&&p.next!==p.prev){if(a&&(p=function(t,s,i,e,r,n){const h=new Array;for(let r=0,o=e.length;r<o;r++){const a=ls(t,s,0,e[r]*n,r<o-1?e[r+1]*n:i*n,n,!1);a===a.next&&(a.steiner=!0),h.push(ws(a))}h.sort(Is);for(const t of h)ys(t,r),r=us(r,r.next);return r}(s,i,e,r,p,n)),o>80*n){l=f=s[0+i*n],u=m=s[1+i*n];for(let t=n;t<c;t+=n){const e=s[t+i*n],r=s[t+1+i*n];l=Math.min(l,e),u=Math.min(u,r),f=Math.max(f,e),m=Math.max(m,r)}d=Math.max(f-l,m-u),d=0!==d?1/d:0}fs(p,t,n,l,u,d,h,0)}}function ls(t,s,i,e,r,n,h){let o;if(h===function(t,s,i,e,r,n){let h=0;for(let i=e,o=r-n;i<r;i+=n)h+=(t[o+s*n]-t[i+s*n])*(t[i+1+s*n]+t[o+1+s*n]),o=i;return h}(t,s,0,e,r,n)>0)for(let i=e;i<r;i+=n)o=ps(i+s*n,t[i+s*n],t[i+1+s*n],o);else for(let i=r-n;i>=e;i-=n)o=ps(i+s*n,t[i+s*n],t[i+1+s*n],o);return o&&Ps(o,o.next)&&(Ms(o),o=o.next),o}function us(t,s=t){if(!t)return t;let i,e=t;do{if(i=!1,e.steiner||!Ps(e,e.next)&&0!==xs(e.prev,e,e.next))e=e.next;else{if(Ms(e),e=s=e.prev,e===e.next)break;i=!0}}while(i||e!==s);return s}function fs(t,s,i,e,r,n,h,o){if(!t)return;!o&&n&&(t=gs(t,e,r,n));let a=t;for(;t.prev!==t.next;){const c=t.prev,l=t.next;if(n?ds(t,e,r,n):ms(t))s.push(c.index/i+h),s.push(t.index/i+h),s.push(l.index/i+h),Ms(t),t=l.next,a=l.next;else if((t=l)===a){o?1===o?fs(t=Ls(t,s,i,h),s,i,e,r,n,h,2):2===o&&ks(t,s,i,e,r,n,h):fs(us(t),s,i,e,r,n,h,1);break}}}function ms(t){const s=t.prev,i=t,e=t.next;if(xs(s,i,e)>=0)return!1;let r=t.next.next;const n=r;let h=0;for(;r!==t.prev&&(0===h||r!==n);){if(h++,_s(s.x,s.y,i.x,i.y,e.x,e.y,r.x,r.y)&&xs(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function ds(t,s,i,e){const r=t.prev,n=t,h=t.next;if(xs(r,n,h)>=0)return!1;const o=r.x>n.x?r.x>h.x?r.x:h.x:n.x>h.x?n.x:h.x,a=r.y>n.y?r.y>h.y?r.y:h.y:n.y>h.y?n.y:h.y,c=Ss(r.x<n.x?r.x<h.x?r.x:h.x:n.x<h.x?n.x:h.x,r.y<n.y?r.y<h.y?r.y:h.y:n.y<h.y?n.y:h.y,s,i,e),l=Ss(o,a,s,i,e);let u=t.prevZ,f=t.nextZ;for(;u&&u.z>=c&&f&&f.z<=l;){if(u!==t.prev&&u!==t.next&&_s(r.x,r.y,n.x,n.y,h.x,h.y,u.x,u.y)&&xs(u.prev,u,u.next)>=0)return!1;if(u=u.prevZ,f!==t.prev&&f!==t.next&&_s(r.x,r.y,n.x,n.y,h.x,h.y,f.x,f.y)&&xs(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(;u&&u.z>=c;){if(u!==t.prev&&u!==t.next&&_s(r.x,r.y,n.x,n.y,h.x,h.y,u.x,u.y)&&xs(u.prev,u,u.next)>=0)return!1;u=u.prevZ}for(;f&&f.z<=l;){if(f!==t.prev&&f!==t.next&&_s(r.x,r.y,n.x,n.y,h.x,h.y,f.x,f.y)&&xs(f.prev,f,f.next)>=0)return!1;f=f.nextZ}return!0}function ps(t,s,i,e){const r=Ts.create(t,s,i);return e?(r.next=e.next,r.prev=e,e.next.prev=r,e.next=r):(r.prev=r,r.next=r),r}function Ms(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function ws(t){let s=t,i=t;do{(s.x<i.x||s.x===i.x&&s.y<i.y)&&(i=s),s=s.next}while(s!==t);return i}function ys(t,s){if(s=function(t,s){let i=s;const e=t.x,r=t.y;let n,h=-1/0;do{if(r<=i.y&&r>=i.next.y&&i.next.y!==i.y){const t=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(t<=e&&t>h){if(h=t,t===e){if(r===i.y)return i;if(r===i.next.y)return i.next}n=i.x<i.next.x?i:i.next}}i=i.next}while(i!==s);if(!n)return null;if(e===h)return n.prev;const o=n,a=n.x,c=n.y;let l,u=1/0;for(i=n.next;i!==o;)e>=i.x&&i.x>=a&&e!==i.x&&_s(r<c?e:h,r,a,c,r<c?h:e,r,i.x,i.y)&&(l=Math.abs(r-i.y)/(e-i.x),(l<u||l===u&&i.x>n.x)&&vs(i,t)&&(n=i,u=l)),i=i.next;return n}(t,s)){const i=Cs(s,t);us(i,i.next)}}function gs(t,s,i,e){for(let r;r!==t;r=r.next){if(r=r||t,null===r.z&&(r.z=Ss(r.x,r.y,s,i,e)),r.prev.next!==r||r.next.prev!==r)return r.prev.next=r,r.next.prev=r,gs(t,s,i,e);r.prevZ=r.prev,r.nextZ=r.next}return t.prevZ.nextZ=null,t.prevZ=null,function(t){let s,i=1;for(;;){let e,r=t;t=null,s=null;let n=0;for(;r;){n++,e=r;let h=0;for(;h<i&&e;h++)e=e.nextZ;let o=i;for(;h>0||o>0&&e;){let i;0===h?(i=e,e=e.nextZ,o--):0!==o&&e?r.z<=e.z?(i=r,r=r.nextZ,h--):(i=e,e=e.nextZ,o--):(i=r,r=r.nextZ,h--),s?s.nextZ=i:t=i,i.prevZ=s,s=i}r=e}if(s.nextZ=null,i*=2,n<2)return t}}(t)}function xs(t,s,i){return(s.y-t.y)*(i.x-s.x)-(s.x-t.x)*(i.y-s.y)}function bs(t,s,i,e){return!!(Ps(t,s)&&Ps(i,e)||Ps(t,e)&&Ps(i,s))||xs(t,s,i)>0!=xs(t,s,e)>0&&xs(i,e,t)>0!=xs(i,e,s)>0}function _s(t,s,i,e,r,n,h,o){return(r-h)*(s-o)-(t-h)*(n-o)>=0&&(t-h)*(e-o)-(i-h)*(s-o)>=0&&(i-h)*(n-o)-(r-h)*(e-o)>=0}function vs(t,s){return xs(t.prev,t,t.next)<0?xs(t,s,t.next)>=0&&xs(t,t.prev,s)>=0:xs(t,s,t.prev)<0||xs(t,t.next,s)<0}function Ss(t,s,i,e,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*r)|t<<8))|t<<4))|t<<2))|t<<1))|(s=1431655765&((s=858993459&((s=252645135&((s=16711935&((s=32767*(s-e)*r)|s<<8))|s<<4))|s<<2))|s<<1))<<1}function Ps(t,s){return t.x===s.x&&t.y===s.y}function Is(t,s){return t.x-s.x}function Ls(t,s,i,e){let r=t;do{const n=r.prev,h=r.next.next;!Ps(n,h)&&bs(n,r,r.next,h)&&vs(n,h)&&vs(h,n)&&(s.push(n.index/i+e),s.push(r.index/i+e),s.push(h.index/i+e),Ms(r),Ms(r.next),r=t=h),r=r.next}while(r!==t);return r}function ks(t,s,i,e,r,n,h){let o=t;do{let t=o.next.next;for(;t!==o.prev;){if(o.index!==t.index&&zs(o,t)){let a=Cs(o,t);return o=us(o,o.next),a=us(a,a.next),fs(o,s,i,e,r,n,h,0),void fs(a,s,i,e,r,n,h,0)}t=t.next}o=o.next}while(o!==t)}function zs(t,s){return t.next.index!==s.index&&t.prev.index!==s.index&&!function(t,s){let i=t;do{if(i.index!==t.index&&i.next.index!==t.index&&i.index!==s.index&&i.next.index!==s.index&&bs(i,i.next,t,s))return!0;i=i.next}while(i!==t);return!1}(t,s)&&vs(t,s)&&vs(s,t)&&function(t,s){let i=t,e=!1;const r=(t.x+s.x)/2,n=(t.y+s.y)/2;do{i.y>n!=i.next.y>n&&i.next.y!==i.y&&r<(i.next.x-i.x)*(n-i.y)/(i.next.y-i.y)+i.x&&(e=!e),i=i.next}while(i!==t);return e}(t,s)}function Cs(t,s){const i=Ts.create(t.index,t.x,t.y),e=Ts.create(s.index,s.x,s.y),r=t.next,n=s.prev;return t.next=s,s.prev=t,i.next=r,r.prev=i,e.next=i,i.prev=e,n.next=e,e.prev=n,e}class Ts{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,s,i){const e=js<Fs.length?Fs[js++]:new Ts;return e.index=t,e.x=s,e.y=i,e.prev=null,e.next=null,e.z=null,e.prevZ=null,e.nextZ=null,e.steiner=!1,e}}const Fs=new Array;let js=0;for(let t=0;t<8096;t++)Fs.push(new Ts);const As=new k(0,0,0,1,0),Gs=new k(0,0,0,1,0);function Rs(t,s,i){let e=0;for(let r=1;r<i;r++)e+=(t[2*(s+r)]-t[2*(s+r-1)])*(t[2*(s+r)+1]+t[2*(s+r-1)+1]);return e}function Bs(t,s,i,e,r){let n=0;for(let h=i;h<e;h+=3){const i=2*(t.getValue(h)-r),e=2*(t.getValue(h+1)-r),o=2*(t.getValue(h+2)-r);n+=Math.abs((s[i]-s[o])*(s[e+1]-s[i+1])-(s[i]-s[e])*(s[o+1]-s[i+1]))}return n}function Es(t,s){const{coords:i,lengths:e,hasIndeterminateRingOrder:r}=s,n=t.indexWriter(),h=t.vertexCount();if(r)return!1;const o=n.length;let a=0;for(let t=0;t<e.length;){let s=t,r=e[t],c=Rs(i,a,r);const l=[];for(;++s<e.length;){const t=e[s],n=Rs(i,a+r,t);if(!(n>0))break;c+=n,l.push(a+r),r+=t}const u=n.length;cs(n,i,a,a+r,l,2,h);const f=Bs(n,i,u,n.length,h),m=Math.abs(c);if(Math.abs((f-m)/Math.max(1e-7,m))>1e-5)return n.seek(o),!1;t=s,a+=r}return!0}As.setExtent(e),Gs.setExtent(e);const Ns=t=>class extends t{constructor(...t){super(...t),this.tessellationProperties={},this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0},this.geometryType=u.LINE}writeGeometry(t,s,i,e){this._writeGeometry(t,s,i,e)}_initializeTessellator(t){const s=it.load(this._materialKey),i=this._tessellationOptions,e=s.vvSizeFieldStops||s.vvSizeMinMaxValue||s.vvSizeScaleStops||s.vvSizeUnitValue,r=this.tessellationProperties._halfWidth<l;this.tessellationProperties.minMaxZoom=this._minMaxZoom;const n=r&&!t&&!e;i.wrapDistance=65535,i.textured=this._isDashed||this._hasPattern,i.offset=this.tessellationProperties.offset,i.halfWidth=this.tessellationProperties._halfWidth;const h=n?0:1,o=et.load(this._materialKey).outlinedFill?Vs:Ws;this._lineTessellator=new C(o(this.tessellationProperties,h,h),Os(this.tessellationProperties),n)}_write(t,s,i){const e="esriGeometryPoint"===s.geometryType;t.recordStart(s.getDisplayId(),this._materialKey,this.geometryType,!1,e),this._writeGeometry(t,s,i,e),t.recordEnd()}_writeGeometry(t,s,i,e){const r=null!=i?i:s.readLegacyGeometryForDisplay(),n=this._getLines(r,e);x(n)||this._writeVertices(t,s,n)}_getLines(t,s){if(x(t))return null;const i=t.paths||t.rings;return x(i)?null:function(t,s){Gs.setPixelMargin(s);const i=Gs,r=-s,n=e+s;let h=[],o=!1,a=0;for(;a<t.length;){const s=[],e=t[a];if(!e)return null;i.reset(2);let[c,l]=e[0];if(o)i.moveTo(c,l);else{if(c<r||c>n||l<r||l>n){o=!0;continue}s.push({x:c,y:l})}let u=!1;const f=e.length;for(let t=1;t<f;++t)if(c+=e[t][0],l+=e[t][1],o)i.lineTo(c,l);else{if(c<r||c>n||l<r||l>n){u=!0;break}s.push({x:c,y:l})}if(u)o=!0;else{if(o){const t=i.resultWithStarts();if(t)for(const s of t)h.push(s)}else h.push({line:s,start:0});a++,o=!1}}return h=h.filter((t=>t.line.length>1)),0===h.length?null:h}(i,s?256:16)}_writeVertices(t,s,i){const e=s.getDisplayId(),r=t.vertexCount(),n=this.tessellationProperties,h=this._tessellationOptions;n.out=t,n.id=e,n.indexCount=0,n.vertexCount=0,n.offset=r,h.capType=this._capType,h.joinType=this._joinType;for(const{line:t,start:s}of i)h.initialDistance=s%65535,this._lineTessellator.tessellate(t,h)}},Ws=(t,s,i)=>(e,r,n,h,o,a,c,l,u,f,m)=>{const d=Z(m,Math.ceil(1024*t._halfWidth)),p=X(Math.round(31*c),Math.round(31*l),Math.round(31*u),Math.round(31*f)),M=X(31*o,31*a,0,t._bitset),w=t.out;return w.vertexBounds(e,r,s,i),w.vertexWrite(Z(8*e,8*r)),w.vertexWrite(t.id),w.vertexWrite(t._fillColor),w.vertexWrite(p),w.vertexWrite(d),w.vertexWrite(t._tl),w.vertexWrite(t._br),w.vertexWrite(M),w.vertexWrite(Z(Math.ceil(1024*t._halfReferenceWidth),0)),w.vertexWrite(t.minMaxZoom),w.vertexEnd(),t.offset+t.vertexCount++},Vs=(t,s,i)=>(e,r,n,h,o,a,c,l,u,f)=>{const m=128,d=X(Math.round(31*c)+m,Math.round(31*l)+m,Math.round(31*u)+m,Math.round(31*f)+m),p=Z(Math.ceil(1024*t._halfWidth),Math.ceil(1024*t._halfReferenceWidth)),M=X(t._bitset,0,0,2),w=t.out;return w.vertexBounds(e,r,s,i),w.vertexWrite(Z(8*e,8*r)),w.vertexWrite(t.id),w.vertexWrite(t._fillColor),w.vertexWrite(0),w.vertexWrite(0),w.vertexWrite(d),w.vertexWrite(p),w.vertexWrite(M),w.vertexWrite(t.minMaxZoom),w.vertexEnd(),t.offset+t.vertexCount++},Os=t=>(s,i,e)=>{const r=t.out;r.indexWrite(s),r.indexWrite(i),r.indexWrite(e),t.indexCount+=3},Ds=v.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate");class Us extends(Ns(Qt)){constructor(t,s,i,e,r,n,o,a,c,l,u,f,m,d,p,M,w,y){super();const g=it.load(t);s&&(g.sdf=s.sdf,g.pattern=!0,g.textureBinding=s.textureBinding),this._capType=e,this._joinType=r,this._miterLimitCosine=Ot(n),this.tessellationProperties._fillColor=o,this.tessellationProperties._tl=a,this.tessellationProperties._br=c,this._hasPattern=l,this._isDashed=u,this._zOrder=p,this._effects=M,this._minMaxZoom=Z(Math.round(w*h),Math.round(y*h)),this._materialKey=g.data,this.tessellationProperties._bitset=(m?1:0)|(f?1:0)<<1,this.tessellationProperties._halfWidth=.5*i,this.tessellationProperties._halfReferenceWidth=.5*d,this.tessellationProperties.offset=0,this._initializeTessellator(!1)}static fromCIMLine(t,s,i){const e=t.color,r=t.scaleFactor||1,n=!!t.dashTemplate;let h=t.cap;n&&1===h&&(h=2);const o=t.join,c=j(t.width)*r,l=j(t.referenceWidth),u=j(t.miterLimit),f=e&&H(e)||0,[m,d]=Dt(t.scaleInfo,i);if(!s)return new Us(t.materialKey,s,c,h,o,u,f,0,0,!1,n,t.scaleDash,t.colorLocked,l,t.zOrder,t.effects,m,d);const{rect:p,width:M,height:w}=s,y=p.x+a,g=p.y+a,x=y+M,b=g+w,_=Z(y,g),v=Z(x,b);return new Us(t.materialKey,s,c,h,o,u,f,_,v,!0,n,t.scaleDash,t.colorLocked,l,t.zOrder,t.effects,m,d)}static fromFillOutline(t){var s;return t.isOutlinedFill&&t.outline&&"esriSLSSolid"===(null==(s=t.outline)?void 0:s.style)?Us.fromSimpleLine({hash:"",materialKey:t.materialKey,...t.outline},null):null}static fromSimpleLine(t,s){const{color:i}=t,e="esriSLSSolid"!==t.style&&"esriSLSNull"!==t.style,r=m(t.cap||"round"),n=d(t.join||"round");let h=i&&"esriSLSNull"!==t.style&&J(i)||0;"esriSLSNull"===t.style&&(h=0);const o=j(t.width),c=t.miterLimit;if(!s)return new Us(t.materialKey,s,o,r,n,c,h,0,0,!1,e,!0,!1,o,0,null,0,100);const{rect:l,width:u,height:f}=s,p=l.x+a,M=l.y+a,w=p+u,y=M+f,g=Z(p,M),x=Z(w,y);return new Us(t.materialKey,s,o,r,n,c,h,g,x,!0,e,!0,!1,o,0,null,0,100)}static fromPictureLineSymbol(t,s,i,e){return Ds.error("PictureLineSymbol support does not exist!"),null}}const qs=t=>class extends t{constructor(...t){super(...t),this.forceLibtess=!1,this._lineTemplate=null,this.geometryType=u.FILL}_maybeAddLineTemplate(t){this._lineTemplate=Us.fromFillOutline(t)}_write(t,s,i){const e="esriGeometryPoint"===s.geometryType,r=et.load(this._materialKey);t.recordStart(s.getDisplayId(),this._materialKey,this.geometryType,r.dotDensity,e),this._writeGeometry(t,s,r,i,e),r.outlinedFill&&b(this._lineTemplate)&&this._lineTemplate.writeGeometry(t,s,i,e),t.recordEnd()}_writeGeometry(t,s,i,e,r){const n=this._getGeometry(s,e,r);if(x(n))return;const h=t.indexCount();if(!(n.maxLength>100)&&!this.forceLibtess&&Es(t,n))return void(!(h===t.indexCount())&&this._writeVertices(t,s,n.coords,n.lengths,i));const o=function(t,s){const i=t.indexWriter(),e=t.vertexCount(),{coords:r,lengths:n}=s,{buffer:h,vertexCount:o}=z(r,n);i.ensureSize(o);for(let t=0;t<o;t++)i.push(t+e);return h}(t,n);h!==t.indexCount()&&this._writeVertices(t,s,o,[o.length/2],i)}_writeVertices(t,s,i,e,r){const n=s.getDisplayId();let h=0;const o=e.reduce(((t,s)=>t+s));t.vertexEnsureSize((r.dotDensity?4:10)*o);for(const o of e){const e=o+h;for(let o=h;o<e;o++){const e=i[2*o],h=i[2*o+1],a=Z(1*e,1*h);t.vertexBounds(e,h,0,0),t.vertexWrite(a),t.vertexWrite(n),r.dotDensity?t.vertexWriteF32(1/Math.abs(s.readGeometryArea())):(t.vertexWrite(this.fillColor),t.vertexWrite(this.tl),t.vertexWrite(this.br),t.vertexWrite(this.aux2),t.vertexWrite(this.aux3),t.vertexWrite(this.aux4),t.vertexWrite(this._minMaxZoom))}h+=o}}_getGeometry(t,s,i){const r=s?ht(ot(s),2):t.readGeometryForDisplay();return r?function(t,s){if(x(t))return null;if(!function(t,s,i){let e=0;for(let s=0;s<t.lengths.length;s++){const r=t.lengths[s];for(let s=0;s<r;s++){const r=t.coords[2*(s+e)],n=t.coords[2*(s+e)+1];if(r<-128||r>i||n<-128||n>i)return!0}e+=r}return!1}(t,0,e+128))return t;As.setPixelMargin(s),As.reset(3);let i=0;for(let s=0;s<t.lengths.length;s++){const e=t.lengths[s];let r=t.coords[2*(0+i)],n=t.coords[2*(0+i)+1];As.moveTo(r,n);for(let s=1;s<e;s++)r=t.coords[2*(s+i)],n=t.coords[2*(s+i)+1],As.lineTo(r,n);As.close(),i+=e}const r=As.result(!1);if(!r)return null;const n=[],h=[];for(const t of r){let s=0;for(const i of t)h.push(i.x),h.push(i.y),s++;n.push(s)}return new bt(n,h)}(r,i?256:8):null}},Ks=v.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");class $s extends Qt{constructor(t){super(),this._ongoingMaterialRequestMap=new Map,this._materialCache=new Map,this._dynamicPropertyMap=new Map,this._cimLayer=t}analyze(t,s,i,e,r){const n=s.readLegacyFeature(),h=this._materialCache,o=this._cimLayer.materialHash;if(!o)return Ks.error("A Dynamic mesh template must have a material hash value or function!"),Promise.reject(null);const a="function"==typeof o?o(n,i,e):o;if(h.has(a)){const t=h.get(a);return Promise.resolve(t)}if(this._ongoingMaterialRequestMap.has(a))return this._ongoingMaterialRequestMap.get(a);const c=this._cimLayer,l=_t(c.cim,this._cimLayer.materialOverrides),{type:u,url:f}=c,m={cim:l,type:u,mosaicHash:a,url:f,size:null,dashTemplate:null,text:null,fontName:null};switch(u){case"marker":m.size=vt(c.size,n,i,e);break;case"line":m.dashTemplate=c.dashTemplate;break;case"text":m.text=vt(c.text,n,i,e),m.fontName=vt(c.fontName,n,i,e)}const d=t.getMosaicItem(m,r).then((t=>(this._ongoingMaterialRequestMap.delete(a),h.set(a,t),t))).catch((t=>(this._ongoingMaterialRequestMap.delete(a),Ks.error(".analyze()",t.message),null)));return this._ongoingMaterialRequestMap.set(a,d),d}}class Js extends(qs($s)){constructor(t,s,i){var e;if(super(t),this._minMaxZoom=Z(Math.round(s*h),Math.round(i*h)),Vt(t.color))this._dynamicPropertyMap.set("fillColor",((s,i,e)=>{const r=t.color(s,i,e);return r&&H(r)||0}));else{const s=t.color;this.fillColor=s&&H(s)||0}let r=0;Vt(t.height)||(r=t.height||0);const n="CIMMarkerPlacementInsidePolygon"===(null==(e=t.cim.placement)?void 0:e.type)&&t.cim.placement.shiftOddRows?2:1;this._dynamicPropertyMap.set("_height",((s,i,e)=>Vt(t.height)?t.height(s,i,e)*n:r*n));let o=0;Vt(t.offsetX)||(o=j(t.offsetX||0)+128,o>255&&(o=255)),this._dynamicPropertyMap.set("_offsetX",((s,i,e)=>{if(Vt(t.offsetX)){let r=j(t.offsetX(s,i,e))+128;return r>255&&(r=255),r}return o}));let a=1;Vt(t.scaleX)||(a=t.scaleX||1),this._dynamicPropertyMap.set("_scaleX",((s,i,e)=>Vt(t.scaleX)?t.scaleX(s,i,e):a));let c=0;Vt(t.offsetY)||(c=j(-t.offsetY||0)+128,c>255&&(c=255)),this._dynamicPropertyMap.set("_offsetY",((s,i,e)=>{if(Vt(t.offsetY)){let r=j(-t.offsetY(s,i,e))+128;return r>255&&(r=255),r}return c}));let l=0;Vt(t.angle)||(l=gt(t.angle)||0),this._dynamicPropertyMap.set("_angle",((s,i,e)=>Vt(t.angle)?gt(t.angle(s,i,e)):l)),this._effects=t.effects,this._cimFillLayer=t,this._fillMaterialKey=et.load(t.materialKey)}static fromCIMFill(t,s){const[i,e]=Dt(t.scaleInfo,s);return new Js(t,i,e)}bindFeature(t,s,i){const e=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,r)=>{this[r]=t(e,s,i)}));const r=this._fillMaterialKey,n=this._materialCache,h=this._cimFillLayer;this.aux4=X(0,0,this._angle,h.colorLocked?1:0);const o=(0,h.materialHash)(e,s,i),c=n.get(o);let l=null;if(c&&Ct(c.spriteMosaicItem)&&(l=c.spriteMosaicItem),l){const{rect:t,width:s,height:i}=l,e=t.x+a,n=t.y+a,h=e+s,o=n+i;let c=Math.round(j(this._height));c>255?c=255:c<=0&&(c=o-n);let u=Math.round(j(this._height/i*s||0));u>255?u=255:u<=0&&(u=h-e);const f=this._scaleX,m=1;this.tl=Z(e,n),this.br=Z(h,o),this.aux2=X(u,c,this._offsetX,this._offsetY),this.aux3=Z(128*f,128*m),r.sdf=l.sdf,r.pattern=!0,r.textureBinding=l.textureBinding}else this.tl=0,this.br=0,this.aux2=0,this.aux3=0,r.sdf=!1,r.pattern=!1,r.textureBinding=0;this._materialKey=r.data}}class Hs extends(Ns($s)){constructor(t,s,i){super(t),this._minMaxZoom=Z(Math.round(s*h),Math.round(i*h)),this._cimLineLayer=t;let e=0;if(Vt(t.width)||(e=.5*j(t.width)),this._dynamicPropertyMap.set("_halfWidth",((s,i,r)=>Vt(t.width)?.5*j(t.width(s,i,r)):e)),Vt(t.cap)?this._dynamicPropertyMap.set("_capType",t.cap):this._capType=t.cap,Vt(t.join)?this._dynamicPropertyMap.set("_joinType",t.join):this._joinType=t.join,Vt(t.color))this._dynamicPropertyMap.set("_fillColor",((s,i,e)=>{const r=t.color(s,i,e);return r&&H(r)||0}));else{const s=t.color;this._fillColor=s&&H(s)||0}Vt(t.miterLimit)?this._dynamicPropertyMap.set("_miterLimitCosine",((s,i,e)=>Ot(t.miterLimit(s,i,e)))):this._miterLimitCosine=Ot(t.miterLimit),this._scaleFactor=t.scaleFactor||1,this._isDashed=null!=t.dashTemplate,this._effects=t.effects,this.tessellationProperties._bitset=(t.colorLocked?1:0)|(t.scaleDash?1:0)<<1,this._materialKey=t.materialKey,this._initializeTessellator(!0)}static fromCIMLine(t,s){const[i,e]=Dt(t.scaleInfo,s);return new Hs(t,i,e)}bindFeature(t,s,i){const e=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,r)=>{this[r]=t(e,s,i)})),this._halfWidth*=this._scaleFactor;const r=this._materialCache,n=(0,this._cimLineLayer.materialHash)(e,s,i),h=r.get(n);let o=null;if(h&&Ct(h.spriteMosaicItem)&&(o=h.spriteMosaicItem),o){this._hasPattern=!0;const{rect:t,width:s,height:i}=o,e=t.x+a,r=t.y+a,n=e+s,h=r+i;this.tessellationProperties._tl=Z(e,r),this.tessellationProperties._br=Z(n,h)}else this._hasPattern=!1,this.tessellationProperties._tl=0,this.tessellationProperties._br=0;this.tessellationProperties._fillColor=this._fillColor,this.tessellationProperties._halfWidth=this._halfWidth,this.tessellationProperties.offset=0,this.tessellationProperties._halfReferenceWidth=this.tessellationProperties._halfWidth;const c=it.load(this._materialKey);o&&(c.sdf=o.sdf,c.pattern=!0,c.textureBinding=o.textureBinding),this._materialKey=c.data}}const Xs=lt(),Zs=at(),Qs=v.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate");class Ys extends(os($s)){constructor(t,s,i){super(t),this._cimMarkerLayer=t,this._minMaxZoom=Z(Math.round(s*h),Math.round(i*h)),Vt(t.color)?this._dynamicPropertyMap.set("_fillColor",((s,i,e)=>H(t.color(s,i,e)))):this._fillColor=H(t.color),Vt(t.outlineColor)?this._dynamicPropertyMap.set("_outlineColor",((s,i,e)=>H(t.outlineColor(s,i,e)))):this._outlineColor=H(t.outlineColor),Vt(t.size)?this._dynamicPropertyMap.set("_size",((s,i,e)=>j(t.size(s,i,e)))):this._size=j(t.size)||0,Vt(t.scaleX)?this._dynamicPropertyMap.set("_scaleX",t.scaleX):this._scaleX=t.scaleX||1,Vt(t.offsetX)?this._dynamicPropertyMap.set("xOffset",((s,i,e)=>j(t.offsetX(s,i,e)))):this.xOffset=j(t.offsetX)||0,Vt(t.offsetY)?this._dynamicPropertyMap.set("yOffset",((s,i,e)=>j(t.offsetY(s,i,e)))):this.yOffset=j(t.offsetY)||0,Vt(t.outlineWidth)?this._dynamicPropertyMap.set("_outlineWidth",((s,i,e)=>j(t.outlineWidth(s,i,e)))):this._outlineWidth=j(t.outlineWidth)||0,Vt(t.rotation)?this._dynamicPropertyMap.set("_angle",t.rotation):this._angle=t.rotation||0,this._scaleFactor=S(t.scaleFactor,1),this._markerPlacement=t.markerPlacement,this._effects=t.effects,this._bitSet=(1===t.alignment?1:0)|(t.colorLocked?1:0)<<1|(t.scaleSymbolsProportionally?1:0)<<3,this._materialKey=t.materialKey}static fromCIMMarker(t,s){const[i,e]=Dt(t.scaleInfo,s);return new Ys(t,i,e)}bindFeature(t,s,i){const e=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,r)=>{this[r]=t(e,s,i)}));const r=this._cimMarkerLayer.materialHash,n="function"==typeof r?r(e,s,i):r,h=this._materialCache.get(n);if(!h||!Ct(h.spriteMosaicItem)||!h.spriteMosaicItem)return void Qs.error(new y("mapview-cim","Encountered an error when binding feature"));const o=h.spriteMosaicItem,c=this._cimMarkerLayer.sizeRatio,l=o.width/o.height*this._scaleX,u=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle;let f=this._size,m=f*l;const d=this.xOffset,p=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const M=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/j(this._cimMarkerLayer.frameHeight):1,w=this._outlineWidth*M,g=j(this._cimMarkerLayer.referenceSize);let x=0,b=0;const _=this._cimMarkerLayer.anchorPoint;_&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(x=-_.x/(this._size*l),b=_.y/this._size):(x=_.x,b=_.y)),this._sizeOutlineWidth=X(Math.round(Math.min(Math.sqrt(128*m),255)),Math.round(Math.min(Math.sqrt(128*f),255)),Math.round(Math.min(Math.sqrt(128*w),255)),Math.round(Math.min(Math.sqrt(128*g),255))),this.angle=u;const v=Math.round(64*c);this._bitestAndDistRatio=Z(this._bitSet,v);const S=o.rect.x+a,P=o.rect.y+a,I=S+o.width,L=P+o.height;this._texUpperLeft=Z(S,P),this._texUpperRight=Z(I,P),this._texBottomLeft=Z(S,L),this._texBottomRight=Z(I,L);const k=st.load(this._materialKey);k.sdf=o.sdf,k.pattern=!0,k.textureBinding=o.textureBinding,this._materialKey=k.data,this._anchorX=.5-(.5+x)*o.width/o.width,this._anchorY=.5-(.5+b)*o.height/o.height,m*=c,f*=c,m*=this._scaleFactor,f*=this._scaleFactor,m*=o.rect.width/o.width,f*=o.rect.height/o.height,this._computedWidth=m,this._computedHeight=f,this._applyTransformation(Zs,Xs),this.xOffset=d,this.yOffset=p}}function ti(t){const s=new Array(t.length);for(let i=0;i<t.length;i++)s[i]=t.charCodeAt(i);return s}class si extends(Xt($s)){constructor(t,s,i){super(t),this._horizontalAlignment="center",this._verticalAlignment="middle",this._textToGlyphs=new Map,this._minMaxZoom=Z(Math.round(s*h),Math.round(i*h));const e=t.scaleFactor||1;let r,n,o;this._cimTextLayer=t,Vt(t.color)?this._dynamicPropertyMap.set("_color",((s,i,e)=>H(t.color(s,i,e)))):this._color=H(t.color),Vt(t.color)?this._dynamicPropertyMap.set("_haloColor",((s,i,e)=>H(t.outlineColor(s,i,e)))):this._haloColor=H(t.outlineColor),Vt(t.size)||(r=Math.min(Math.round(j(t.size*t.sizeRatio)),127)),this._dynamicPropertyMap.set("_size",((s,i,e)=>Vt(t.size)?Math.min(Math.round(j(t.size(s,i,e)*t.sizeRatio)),127):r)),Vt(t.outlineSize)?this._dynamicPropertyMap.set("_haloSize",((s,i,e)=>Math.min(Math.floor(5*j(t.outlineSize(s,i,e)*t.sizeRatio)),127))):this._haloSize=Math.min(Math.floor(5*j(t.outlineSize*t.sizeRatio)),127),Vt(t.offsetX)||(n=Math.round(j(t.offsetX*t.sizeRatio))),this._dynamicPropertyMap.set("_xOffset",((s,i,e)=>Vt(t.offsetX)?Math.round(j(t.offsetX(s,i,e)*t.sizeRatio)):n)),Vt(t.offsetY)||(o=Math.round(j(t.offsetY*t.sizeRatio))),this._dynamicPropertyMap.set("_yOffset",((s,i,e)=>Vt(t.offsetY)?Math.round(j(t.offsetY(s,i,e)*t.sizeRatio)):o)),Vt(t.angle)?this._dynamicPropertyMap.set("_angle",t.angle):this._angle=t.angle,Vt(t.horizontalAlignment)?this._dynamicPropertyMap.set("_horizontalAlignment",t.horizontalAlignment):this._horizontalAlignment=t.horizontalAlignment,Vt(t.verticalAlignment)?this._dynamicPropertyMap.set("_verticalAlignment",t.verticalAlignment):this._verticalAlignment=t.verticalAlignment,this._scaleFactor=e,Vt(t.text)?this._dynamicPropertyMap.set("_text",t.text):this._text=t.text;const a=Math.min(Math.round(j(t.referenceSize*t.sizeRatio)),127);this._referenceSize=Math.round(Math.sqrt(256*a)),this._materialKey=t.materialKey;const c=rt.load(this._materialKey);c.sdf=!0,this._bitset=(1===t.alignment?1:0)|(t.colorLocked?1:0)<<1,this._materialKey=c.data,this._decoration="none",this._lineHeight=1,this._lineWidth=512,this._textPlacement=t.markerPlacement,this._effects=t.effects,this._isCIM=!0}static fromCIMText(t,s){const[i,e]=Dt(t.scaleInfo,s);return new si(t,i,e)}async analyze(t,s,i,e){const r=s.readLegacyFeature(),n=function(t,s,i,e){return"string"==typeof t.text?t.text:"function"==typeof t.text?t.text(s,i,e):""}(this._cimTextLayer,r,i,e),h=await super.analyze(t,s,i,e,ti(n));return this._textToGlyphs.set(n,h.glyphMosaicItems),h}bindFeature(t,s,i){const e=t.readLegacyFeature();if(this._dynamicPropertyMap.forEach(((t,r)=>{this[r]=t(e,s,i)})),!this._text||0===this._text.length)return void(this._shapingInfo=null);this._size*=this._scaleFactor,this._scale=this._size/n,this._xOffset*=this._scaleFactor,this._yOffset*=this._scaleFactor,this._xAlignD=O(this._horizontalAlignment||"center"),this._yAlignD=D(this._verticalAlignment||"baseline");const r=this._textToGlyphs.get(this._text);this.bindTextInfo(r,!1)}}class ii extends(qs(Qt)){constructor(t,s,i,e,r,n,o,a,c,l,u,f,m,d,p,M){super(),this._effects=d;const w=et.load(t);s&&(w.sdf=s.sdf,w.pattern=!0,w.textureBinding=s.textureBinding),this.fillColor=i,this.tl=e,this.br=r,this.aux2=X(n,o,a,c),this.aux3=Z(l,u),this.aux4=X(0,0,f,m),this._minMaxZoom=Z(Math.round(p*h),Math.round(M*h)),this._materialKey=w.data}static fromCIMFill(t,s,i){const e=t.color,r=e&&H(e)||0,n=t.materialKey,[h,o]=Dt(t.scaleInfo,i);if(!s)return new ii(n,null,r,0,0,0,0,0,0,0,0,0,t.colorLocked?1:0,t.effects,h,o);const{rect:c,width:l,height:u}=s,f=c.x+a,m=c.y+a,d=f+l,p=m+u,M=t.height,w=(t.scaleX||1)*M;let y=Math.round(M);y>255?y=255:y<=0&&(y=p-m);let g=Math.round(w);g>255?g=255:g<=0&&(g=d-f);let x=j(t.offsetX||0)+128;x>255&&(x=255);let b=j(-t.offsetY||0)+128;b>255&&(b=255);const _=Z(f,m),v=Z(d,p);return new ii(n,s,r,_,v,g,y,x,b,128,128,xt(t.angle),t.colorLocked?1:0,t.effects,h,o)}static fromSimpleFill(t,s,i=!1){const{color:e}=t,r=e&&"esriSFSNull"!==t.style&&J(e)||0,n=i?1:0,h=t.materialKey;let o;if(s){const{rect:t,width:i,height:e}=s,c=t.x+a,l=t.y+a,u=c+i,f=l+e,m=Z(c,l),d=Z(u,f);o=new ii(h,s,r,m,d,i,e,0,0,128,128,0,n,null,0,100)}else o=new ii(h,null,r,0,0,0,0,0,0,0,0,0,n,null,0,100);return o._maybeAddLineTemplate(t),o}static fromPictureFill(t,s,i=!1){const e=c,{rect:r,width:n,height:h}=s,o=r.x+a,l=r.y+a,u=o+n,f=l+h,m=Z(o,l),d=Z(u,f);let p=Math.round(j(t.width));p>255&&(p=255);let M=Math.round(j(t.height));M>255&&(M=255);let w=j(t.xoffset)+128;w>255&&(w=255);let y=j(-t.yoffset)+128;y>255&&(y=255);const g=new ii(t.materialKey,s,e,m,d,p,M,w,y,128*t.xscale,128*t.yscale,0,i?1:0,null,0,100);return g._maybeAddLineTemplate(t),g}}class ei{constructor(){this._resolver=null}isHeld(){return!!this._resolver}async acquire(){if(!this._resolver)return this._resolver=P(),Promise.resolve();await this._resolver.promise,await this.acquire()}release(){const t=this._resolver;this._resolver=null,t.resolve()}}const ri=v.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),ni=new Array,hi={...Mt,hash:JSON.stringify(Mt),materialKey:nt(u.MARKER,0)},oi={...wt,hash:JSON.stringify(wt),materialKey:nt(u.LINE,0)},ai={...yt,hash:JSON.stringify(yt),materialKey:nt(u.FILL,0)};function ci(t,s){const i=t.length;return t.push(null),s.then((s=>t[i]=s)),t}function li(t){return!!(1&t)}class ui{constructor(t,s){this._idCounter=1,this._templateIdCounter=1,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new ei,this._fetchResource=t,this._tileInfo=s}get _markerError(){return this._errorTemplates.marker[0]}get _fillError(){return this._errorTemplates.fill[0]}get _lineError(){return this._errorTemplates.line[0]}get _textError(){return this._errorTemplates.line[0]}createTemplateGroup(t,s){this._initErrorTemplates();const i=t.hash;if(this._symbolToTemplate.has(i))return this._symbolToTemplate.get(i);const e=new Array;s&&this._createMeshTemplates(e,s,!0),this._createMeshTemplates(e,t,!1);const r=this._createGroupId("expanded-cim"===t.type&&fi(t));return this._idToTemplateGroup.set(r,e),this._symbolToTemplate.set(i,r),r}getTemplateGroup(t){return this._idToTemplateGroup.has(t)?this._idToTemplateGroup.get(t):ni}getDynamicTemplateGroup(t){return this._idToTemplateGroup.has(t)?(li(t)||ri.error("mapview-template-store",`Id ${t} does not refer to a dynamic template`),this._idToTemplateGroup.get(t)):ni}getMosaicItem(t,s){const i=this._createTemplateId(),e=new Promise((t=>this._idToResolver.set(i,t)));return this._fetchQueue.push({symbol:t,id:i,glyphIds:s}),e}finalize(t){return this._fetchQueue.length||this._lock.isHeld()?async function(t,s,i){try{await t.acquire(),await s(i),t.release()}catch(s){throw t.release(),s}}(this._lock,this._fetchAllQueuedResources.bind(this),t):Promise.resolve()}_initErrorTemplates(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],ai,!1),marker:this._createMeshTemplates([],hi,!1),line:this._createMeshTemplates([],oi,!1)})}_fetchAllQueuedResources(t){if(!this._fetchQueue.length)return Promise.resolve();const s=this._fetchQueue,i=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],Promise.all(i).then((()=>this._fetchResource(s,t).then((t=>{for(const{id:s,mosaicItem:i}of t)this._idToResolver.get(s)(i),this._idToResolver.delete(s)})))).catch((t=>{I(t)?this._fetchQueue=this._fetchQueue.concat(s):function(t){return"worker:port-closed"===t.name}(t)||ri.error(new y("mapview-template-store","Unable to fetch requested texture resources",t))}))}_createGroupId(t){return this._idCounter++<<1|(t?1:0)}_createTemplateId(){return this._templateIdCounter++}async _createSMS(t){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return Ct(s,ri)?as.fromSimpleMarker(t,s):this._markerError}async _createPMS(t){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return Ct(s,ri)?as.fromPictureMarker(t,s):this._markerError}async _createSFS(t,s){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return Ct(i,ri)?ii.fromSimpleFill(t,i,s):this._fillError}async _createPFS(t,s){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return Ct(i,ri)?ii.fromPictureFill(t,i,s):this._fillError}async _createSLS(t,s){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return Ct(i,ri)?Us.fromSimpleLine(t,i):this._lineError}async _createLMS(t){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return Ct(s,ri)?as.fromLineSymbolMarker(t,s):this._markerError}async _createTS(t){const{glyphMosaicItems:s}=await this.getMosaicItem(t);return Yt.fromText(t,s)}async _createCIMText(t){const{glyphMosaicItems:s}=await this.getMosaicItem(Pt(t),ti(t.text));return Ct(s,ri)?Yt.fromCIMText(t,s,this._tileInfo):this._textError}async _createCIMFill(t){const{spriteMosaicItem:s}=await this.getMosaicItem(Pt(t));return Ct(s,ri)?ii.fromCIMFill(t,s,this._tileInfo):this._fillError}async _createCIMLine(t){const{spriteMosaicItem:s}=await this.getMosaicItem(Pt(t));return Ct(s,ri)?Us.fromCIMLine(t,s,this._tileInfo):this._lineError}async _createCIMMarker(t){const{spriteMosaicItem:s}=await this.getMosaicItem(Pt(t));return Ct(s,ri)?as.fromCIMMarker(t,s,this._tileInfo):this._markerError}async _createCIM(t){const s=t.templateHash;if(this._cimTemplateCache.has(s))return this._cimTemplateCache.get(s);let i;switch(t.type){case"marker":i=this._createCIMMarker(t);break;case"line":i=this._createCIMLine(t);break;case"fill":i=this._createCIMFill(t);break;case"text":i=this._createCIMText(t)}return i.then((t=>this._cimTemplateCache.set(s,t))),i}_createDynamicCIM(t){const s=t.templateHash;if(this._cimTemplateCache.has(s))return this._cimTemplateCache.get(s);let i;switch(t.type){case"marker":i=Ys.fromCIMMarker(t,this._tileInfo);break;case"line":i=Hs.fromCIMLine(t,this._tileInfo);break;case"fill":i=Js.fromCIMFill(t,this._tileInfo);break;case"text":i=si.fromCIMText(t,this._tileInfo)}return this._cimTemplateCache.set(s,i),i}_createPrimitiveMeshTemplates(t,s,i){switch(s.type){case"esriSMS":return ci(t,this._createSMS(s));case"esriPMS":return ci(t,this._createPMS(s));case"esriSFS":return ci(t,this._createSFS(s,i));case"line-marker":return ci(t,this._createLMS(s));case"esriPFS":return ci(t,this._createPFS(s,i));case"esriSLS":return ci(t,this._createSLS(s,!1));case"esriTS":return ci(t,this._createTS(s));default:return ri.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),t}}_createMeshTemplates(t,s,i){if(-1!==s.type.indexOf("3d"))return ri.error("3D symbols are not supported with MapView"),t;if("expanded-cim"===s.type){for(const i of s.layers)"function"==typeof i.materialHash?t.push(this._createDynamicCIM(i)):ci(t,this._createCIM(i));return t}if("composite-symbol"===s.type){for(const e of s.layers)this._createPrimitiveMeshTemplates(t,e,i);return t}return"cim"===s.type||"label"===s.type||"web-style"===s.type?t:this._createPrimitiveMeshTemplates(t,s,i)}}const fi=t=>{if(!t.layers)return!1;for(const s of t.layers)if("function"==typeof s.materialHash)return!0;return!1};class mi{constructor(t,s,i){this._loadPromise=T(),this._geometryType=t,this._idField=s,this._templateStore=i}update(t,s){b(t.mesh.labels)&&(this._labelTemplates=this._createLabelTemplates(t.mesh.labels,s)),this._schema=t}_createLabelTemplates(t,s){const i=new Map;if("simple"===t.type){for(const e of t.classes){const t=ns.fromLabelClass(e,s);i.set(e.index,t)}return i}for(const e in t.classes){const r=t.classes[e];for(const t of r){const e=ns.fromLabelClass(t,s);i.set(t.index,e)}}return i}get templates(){return this._templateStore}async analyze(t,s,i,e,r,n,h){if(L(h))return;let o;"dictionary"===i.type&&(o=await i.analyze(this._idField,t.copy(),s,r,n,h));let a=0;for(;t.next();){let s;if(s=o?o[a++]:b(e)&&M(t.getDisplayId())&&1!==t.readAttribute("cluster_count")?e.match(this._idField,t,this._geometryType,r,n):i.match(this._idField,t,this._geometryType,r,n),t.setGroupId(s),li(s)){const i=this._templateStore.getDynamicTemplateGroup(s);for(const s of i)s&&s.analyze&&s.analyze(this._templateStore,t,r,n)}}return await this._loadPromise,this._templateStore.finalize(h)}async analyzeGraphics(t,s,i,e,r,n){if(L(n))return;const h=t.getCursor();for(i&&await i.analyze(this._idField,h.copy(),s,e,r,n);h.next();){let t=h.getGroupId();if(null!=t&&-1!==t||(t=i.match(this._idField,h,h.geometryType,e,r),h.setGroupId(t)),li(t)){const s=this._templateStore.getDynamicTemplateGroup(t);for(const t of s)t&&t.analyze&&t.analyze(this._templateStore,h,e,r)}h.setGroupId(t)}return await this._loadPromise,this._templateStore.finalize(n)}writeGraphic(t,s,i){const e=s.getGroupId(),r=s.getDisplayId(),n=this._templateStore.getTemplateGroup(e);if(t.featureStart(s.insertAfter,0),null!=r){if(li(e))for(const t of n)t&&t.bindFeature(s,null,null);if(n){for(const e of n)e&&e.write(t,s,i);t.featureEnd()}}}writeCursor(t,s,i,e,r,n){const h=s.getGroupId(),o=s.getDisplayId(),a=this._templateStore.getTemplateGroup(h),c=this._schema.mesh.sortKey;let l=0;if(b(c)&&(l=null!=c.fieldIndex?s.getComputedNumericAtIndex(c.fieldIndex):s.readAttribute(null!=c.field?c.field:this._idField),l*="asc"===c.order?1:-1),t.featureStart(0,null==l||isNaN(l)?0:l),null!=o&&a){if(li(h))for(const t of a)t.bindFeature(s,i,e);for(const i of a)i.write(t,s,r);if(b(n)&&t.hasRecords){const i=n&&this._findLabelRef(a);this._writeLabels(t,s,n,i,r)}t.featureEnd()}}_findLabelRef(t){for(const s of t)if(s instanceof as)return s;return null}_writeLabels(t,s,i,e,r){for(const n of i)if(b(n)&&n){const{glyphs:i,rtl:h,index:o}=n,a=this._labelTemplates.get(o);a.setZoomLevel(r),a.bindReferenceTemplate(e),a.bindTextInfo(i,h),a.write(t,s,null)}}}const di=v.getLogger("esri/views/2d/engine/webgl/util/Matcher");async function pi(t,s,i,e){switch(t.type){case"simple":return Mi.fromBasicRenderer(t,s,i,e);case"map":return gi.fromUVRenderer(t,s,i,e);case"interval":return yi.fromCBRenderer(t,s,i,e);case"dictionary":return _i.fromDictionaryRenderer(t,s,i,e);case"subtype":return wi.fromSubtypes(t,s,i,e)}}class Mi{constructor(){this.type="feature",this._defaultResult=null}static async fromBasicRenderer(t,s,i,e){const r=new Mi;if(t.symbol){const n=await It(t.symbol,i,e),h=s.createTemplateGroup(n,null);r.setDefault(h)}return r}size(){return 1}getDefault(){return this._defaultResult}setDefault(t){this._defaultResult=t}match(t,s,i,e,r){return this.getDefault()}async analyze(t,s,i,e,r,n){return null}}class wi extends Mi{constructor(t,s){super(),this._subMatchers=t,this._subtypeField=s}static async fromSubtypes(t,s,i,e){const r=new Map,n=[];for(const h in t.renderers){const o=parseInt(h,10),a=pi(t.renderers[h],s,i,e).then((t=>r.set(o,t)));n.push(a)}return await Promise.all(n),new wi(r,t.subtypeField)}match(t,s,i,e,r){const n=s.readAttribute(this._subtypeField),h=this._subMatchers.get(n);return h?h.match(t,s,i,e,r):null}}class yi extends Mi{constructor(t,s,i,e){super(),this.type="interval",this._intervals=[],this._isMaxInclusive=s,this._fieldIndex=e,this._field=t,this._normalizationInfo=i}static async fromCBRenderer(t,s,i,e){const{isMaxInclusive:r,normalizationField:n,normalizationTotal:h,normalizationType:o}=t,a=new yi(t.field,r,{normalizationField:n,normalizationTotal:h,normalizationType:o},t.fieldIndex),c=await It(t.backgroundFillSymbol,i,e);await Promise.all(t.intervals.map((async t=>{const r=await It(t.symbol,i,e),n=await s.createTemplateGroup(r,c);a.add({min:t.min,max:t.max},n)})));const l=await It(t.defaultSymbol,i,e);if(l){const t=await s.createTemplateGroup(l,c);a.setDefault(t)}return a}add(t,s){this._intervals.push({interval:t,result:s}),this._intervals.sort(((t,s)=>t.interval.min-s.interval.min))}size(){return super.size()+this._intervals.length}match(t,s,i,e,r){if(null==this._fieldIndex&&!this._field)return this.getDefault();const n=null!=this._fieldIndex?s.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(s);if(!n&&(null==n||isNaN(n)))return this.getDefault();for(let t=0;t<this._intervals.length;t++){const{interval:s,result:i}=this._intervals[t],e=this._isMaxInclusive?n<=s.max:n<s.max;if(n>=s.min&&e)return i}return this.getDefault()}_needsNormalization(){const t=this._normalizationInfo;return t&&(t.normalizationField||t.normalizationTotal||t.normalizationType)}_getValueFromField(t){const s=t.readAttribute(this._field);if(!this._needsNormalization()||null==s)return s;const{normalizationField:i,normalizationTotal:e,normalizationType:r}=this._normalizationInfo,n=!!i&&t.readAttribute(i);if(r)switch(r){case"esriNormalizeByField":return n?s/n:void 0;case"esriNormalizeByLog":return Math.log(s)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return s/e*100;default:return void di.error(`Found unknown normalization type: ${r}`)}else di.error("Normalization is required, but no type was set!")}}class gi extends Mi{constructor(t,s,i){super(),this.type="map",this._nullResult=null,this._resultsMap=new Map,this._fieldsIndex=i,this._fields=t,this._seperator=s||""}static async fromUVRenderer(t,s,i,e){const r=t.fieldDelimiter,n=[t.field];t.field2&&n.push(t.field2),t.field3&&n.push(t.field3);const h=await It(t.backgroundFillSymbol,i,e),o=new gi(n,r,t.fieldIndex);await Promise.all(t.map.map((async t=>{const r=await It(t.symbol,i,e),n=await s.createTemplateGroup(r,h);"<Null>"===t.value?o.setNullResult(n):o.add(t.value,n)})));const a=await It(t.defaultSymbol,i,e);if(a){const t=await s.createTemplateGroup(a,h);o.setDefault(t)}return o}setNullResult(t){this._nullResult=t}add(t,s){this._resultsMap.set(t.toString(),s)}size(){return super.size()+this._resultsMap.size}match(t,s,i,e,r){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();const n=null!=this._fieldsIndex?s.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(s);if(null!==this._nullResult&&(null==n||""===n||"<Null>"===n))return this._nullResult;if(!n&&null==n)return this.getDefault();const h=n.toString();return this._resultsMap.has(h)?this._resultsMap.get(h):this.getDefault()}_getValueFromFields(t){const s=[];for(const i of this._fields){const e=t.readAttribute(i);s.push(null==e||""===e?"<Null>":e)}return s.join(this._seperator)}}let xi;async function bi(){return xi||(xi=import("./p-c5443b47.js").then((function(t){return t.j}))),xi}class _i extends Mi{constructor(t,s,i,e,r){super(),this.type="dictionary",this._groupIdCache=new Lt(100),this._renderer=t,this._fieldMap=t.fieldMap,this._symbolFields=t.getSymbolFields(),this._templates=s,this._info=i,this._scaleFn=e,this._schemaUtilsModule=r}static async fromDictionaryRenderer(t,s,i,e){const[{default:r},n]=await Promise.all([import("./p-5ce39624.js"),bi()]),h=r.fromJSON(t.renderer);await h.fetchResources({spatialReference:i.spatialReference,fields:i.fields});const o=await async function(t,s){const i=t||1;if("number"==typeof i)return()=>i;const e=await kt(i,s.spatialReference,s.fields);return(t,i,r)=>zt(e,t,{$view:r},s.geometryType,i)||1}(h.scaleExpression,i);return new _i(h,s,i,o,n)}async _analyzeFeature(t,s,i,e,r){const n=t.readLegacyFeature(),h=this._scaleFn(n,i,e),o=this._attributeHash(n)+"-"+h,a=this._groupIdCache.get(o);if(a)return a;const c={...e,spatialReference:this._info.spatialReference,abortOptions:r,fields:this._info.fields},l=await this._renderer.getSymbolAsync(n,c),u=this._schemaUtilsModule.createSymbolSchema(l,this._renderer),f=It(u,this._info,s,r).then((t=>{if("expanded-cim"!==t.type)return di.error(new y("mapview-bad-type",`Found unexpected type ${t.type} in dictionary response`)),null;t.hash+="-"+h;for(const s of t.layers)s.scaleFactor=h,s.templateHash+="-"+h,"text"===s.type&&"string"==typeof s.text&&s.text.indexOf("[")>-1&&(s.text=St(this._fieldMap,s.text,s.cim.textCase));return this._templates.createTemplateGroup(t,null)}));return this._groupIdCache.put(o,f,1),f}async analyze(t,s,i,e,r,n){const h=s.getCursor(),o=[];for(;h.next();)o.push(this._analyzeFeature(h,i,e,r,n));return Promise.all(o)}match(t,s,i,e,r){return null}_attributeHash(t){let s="";for(const i of this._symbolFields){const e=this._fieldMap[i];e&&(s+=t.attributes[e]+"-")}return s}}export{ui as E,Tt as a,Rt as b,Ct as e,mi as l,pi as o,ti as t}