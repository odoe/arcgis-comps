import{D as t,bv as n}from"./p-566b0715.js";import{_ as o,aC as e,r,cK as s,t as a,O as i}from"./p-9ae46e68.js";import{j as c}from"./p-39da60a5.js";import{a as p}from"./p-2794293b.js";import{a as u}from"./p-7571af29.js";import{m as l,c as f,y as m,f as j}from"./p-6fe3e430.js";import{T as b,i as d,c as w,x as g,u as x,L as h,O as $,E as v}from"./p-19c767c2.js";import{e as C,f as M,t as T,r as y,a as A,n as I}from"./p-76b2eeb3.js";import{a as S,r as k,o as q,b as D,t as E,c as K,j as L,f as N,e as O,k as R,i as z,d as B,g as F,m as G,n as P}from"./p-1184fb6f.js";import{b as Q}from"./p-4ece03e9.js";import"./p-fe01b82b.js";import"./p-84bf99cb.js";import"./p-01158f1c.js";import"./p-c3efb223.js";import"./p-b62a8a4f.js";import"./p-97ec6ae5.js";import"./p-e3f0e7de.js";import"./p-bae36c84.js";import"./p-138c2b2c.js";import"./p-98a14d68.js";import"./p-8e03c038.js";import"./p-32462343.js";import"./p-d925341f.js";import"./p-50875f24.js";import"./p-57ae469d.js";import"./p-c431b12a.js";import"./p-b1a3d539.js";import"./p-e49afbb8.js";async function U(t,n,o){const e=new P(function(t){return null!=t&&t.resolveFile?{busy:!1,request:async(n,o,e)=>{const s=t.resolveFile(n),a="image"===o?"image":"binary"===o?"array-buffer":"json";return(await i(s,{responseType:a,signal:r(e)?e.signal:null})).data}}:null}(o)),s=(await S(e,n,o,!0)).model,a=s.lods.shift(),c=new Map,p=new Map;s.textures.forEach(((t,n)=>c.set(n,J(t)))),s.materials.forEach(((t,n)=>p.set(n,W(t,c))));const u=H(a);for(const t of u.parts)X(u,t,p);const{position:l,normal:f,tangent:j,color:b,texCoord0:d}=u.vertexAttributes,w={position:l.typedBuffer,normal:r(f)?f.typedBuffer:null,tangent:r(j)?j.typedBuffer:null,uv:r(d)?d.typedBuffer:null,color:r(b)?b.typedBuffer:null},g=Q(w,t,o);return{transform:g.transform,components:u.components,spatialReference:t.spatialReference,vertexAttributes:new m({position:g.vertexAttributes.position,normal:g.vertexAttributes.normal,tangent:g.vertexAttributes.tangent,color:w.color,uv:w.uv})}}function V(t,n){if(a(t))return"-";const o=t.typedBuffer;return`${s(n,o.buffer,(()=>n.size))}/${o.byteOffset}/${o.byteLength}`}function _(t){return r(t)?t.toString():"-"}function H(t){let n=0;const o={color:!1,tangent:!1,normal:!1,texCoord0:!1},e=new Map,r=new Map,a=[];for(const i of t.parts){const{attributes:{position:t,normal:c,color:p,tangent:u,texCoord0:l}}=i,f=`\n      ${V(t,e)}/\n      ${V(c,e)}/\n      ${V(p,e)}/\n      ${V(u,e)}/\n      ${V(l,e)}/\n      ${_(i.transform)}\n    `;let m=!1;const j=s(r,f,(()=>(m=!0,{start:n,length:t.count})));m&&(n+=t.count),c&&(o.normal=!0),p&&(o.color=!0),u&&(o.tangent=!0),l&&(o.texCoord0=!0),a.push({gltf:i,writeVertices:m,region:j})}return{vertexAttributes:{position:k(b,n),normal:o.normal?k(d,n):null,tangent:o.tangent?k(w,n):null,color:o.color?k(g,n):null,texCoord0:o.texCoord0?k(x,n):null},parts:a,components:[]}}function J(t){return new l({data:t.data,wrap:tt(t.parameters.wrap)})}function W(r,s){const a=new t(function(t,n){return u(ot(t[0]),ot(t[1]),ot(t[2]),n)}(r.color,r.opacity)),i=r.emissiveFactor?new t(function(t){return n(ot(t[0]),ot(t[1]),ot(t[2]))}(r.emissiveFactor)):null;return new f({color:a,colorTexture:o(e(r.textureColor,(t=>s.get(t)))),normalTexture:o(e(r.textureNormal,(t=>s.get(t)))),emissiveColor:i,emissiveTexture:o(e(r.textureEmissive,(t=>s.get(t)))),occlusionTexture:o(e(r.textureOcclusion,(t=>s.get(t)))),alphaMode:Z(r.alphaMode),alphaCutoff:r.alphaCutoff,doubleSided:r.doubleSided,metallic:r.metallicFactor,roughness:r.roughnessFactor,metallicRoughnessTexture:o(e(r.textureMetallicRoughness,(t=>s.get(t))))})}function X(t,n,o){n.writeVertices&&Y(t,n);const e=n.gltf,r=function(t,n){switch(n){case 4:return F(t,G);case 5:return B(t);case 6:return z(t)}}(e.indices||e.attributes.position.count,e.primitiveType),s=n.region.start;if(s)for(let t=0;t<r.length;t++)r[t]+=s;t.components.push(new j({faces:r,material:o.get(e.material),trustSourceNormals:!0}))}function Y(t,n){const{position:o,normal:e,tangent:s,color:a,texCoord0:i}=t.vertexAttributes,u=n.region.start,{attributes:l,transform:f}=n.gltf,m=l.position.count;if(C(o.slice(u,m),l.position,f),r(l.normal)&&r(e)){const t=c(p(),f);M(e.slice(u,m),l.normal,t)}else r(e)&&T(e,0,0,1,{dstIndex:u,count:m});if(r(l.tangent)&&r(s)){const t=c(p(),f);D(s.slice(u,m),l.tangent,t)}else r(s)&&E(s,0,0,1,1,{dstIndex:u,count:m});if(r(l.texCoord0)&&r(i)?K(i.slice(u,m),l.texCoord0):r(i)&&L(i,0,0,{dstIndex:u,count:m}),r(l.color)&&r(a)){const t=l.color,n=a.slice(u,m);if(4===t.elementCount)t instanceof w?N(n,t,255):t instanceof g?O(n,t):t instanceof h&&R(n,t,8);else{E(n,255,255,255,255);const o=$.fromTypedArray(n.typedBuffer,n.typedBufferStride);t instanceof d?y(o,t,255):t instanceof $?A(o,t):t instanceof v&&I(o,t,8)}}else r(a)&&E(a.slice(u,m),255,255,255,255)}function Z(t){switch(t){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function tt(t){return{horizontal:nt(t.s),vertical:nt(t.t)}}function nt(t){switch(t){case 33071:return"clamp";case 33648:return"mirror";case 10497:return"repeat"}}function ot(t){return t**(1/q)*255}export{U as loadGLTFMesh}