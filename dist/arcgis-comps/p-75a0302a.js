import{k as e,a1 as n,bL as t}from"./p-566b0715.js";import{v as i,t as a,m as s,O as o,bc as r,r as l}from"./p-9ae46e68.js";import{s as c,n as u,e as p}from"./p-4003c7ae.js";import{e as f}from"./p-db87794e.js";import{O as d,T as m,L as g}from"./p-59312e26.js";import{u as y}from"./p-f8afda5b.js";import{d as w}from"./p-5a0fe1d0.js";import{i as h}from"./p-32462343.js";const b=i.getLogger("esri.layers.graphics.sources.ogcfeature"),j="http://www.opengis.net/def/crs/",I=`${j}OGC/1.3/CRS84`;async function F(e,n,t={},i=5){const{links:r}=e,l=M(r,"items","application/geo+json")||M(r,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(a(l))throw new s("ogc-feature-layer:missing-items-page","Missing items url");const{data:c}=await o(l.href,{signal:t.signal,query:{limit:i,...t.customParameters,token:t.apiKey},headers:{accept:"application/geo+json"}});await d(c);const u=m(c,{geometryType:n.geometryType}),p=n.fields||u.fields||[],f=null!=n.hasZ?n.hasZ:u.hasZ,g=u.geometryType,j=n.objectIdField||u.objectIdFieldName||"OBJECTID";let I=n.timeInfo;const F=p.find((e=>e.name===j));if(F)F.type="esriFieldTypeOID",F.editable=!1,F.nullable=!1;else{if(!u.objectIdFieldType)throw new s("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");p.unshift({name:j,alias:j,type:"esriFieldTypeOID",editable:!1,nullable:!1})}if(j!==u.objectIdFieldName){const e=p.find((e=>e.name===u.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}p===u.fields&&u.unknownFields.length>0&&b.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:u.unknownFields}});for(const e of p){if(null==e.name&&(e.name=e.alias),null==e.alias&&(e.alias=e.name),"esriFieldTypeOID"!==e.type&&"esriFieldTypeGlobalID"!==e.type&&(e.editable=null==e.editable||!!e.editable,e.nullable=null==e.nullable||!!e.nullable),!e.name)throw new s("ogc-feature-layer:invalid-field-name","field name is missing",{field:e});if(-1===h.jsonValues.indexOf(e.type))throw new s("ogc-feature-layer:invalid-field-type",`invalid type for field "${e.name}"`,{field:e})}if(I){const e=new w(p);if(I.startTimeField){const n=e.get(I.startTimeField);n?(I.startTimeField=n.name,n.type="esriFieldTypeDate"):I.startTimeField=null}if(I.endTimeField){const n=e.get(I.endTimeField);n?(I.endTimeField=n.name,n.type="esriFieldTypeDate"):I.endTimeField=null}if(I.trackIdField){const n=e.get(I.trackIdField);n?I.trackIdField=n.name:(I.trackIdField=null,b.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:I}}))}I.startTimeField||I.endTimeField||(b.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:I}}),I=null)}return{drawingInfo:g?y(g):null,geometryType:g,fields:p,hasZ:!!f,objectIdField:j,timeInfo:I}}async function k(e,n={}){const{links:t}=e,i=M(t,"data","application/json")||M(t,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(a(i))throw new s("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:r,customParameters:l,signal:c}=n,{data:u}=await o(i.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:r}});return u}async function v(e,n={}){const{links:t}=e,i=M(t,"conformance","application/json")||M(t,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(a(i))throw new s("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:r,customParameters:l,signal:c}=n,{data:u}=await o(i.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:r}});return u}async function T(e,n={}){const{apiKey:t,customParameters:i,signal:a}=n,{data:s}=await o(e,{signal:a,headers:{accept:"application/json"},query:{...i,token:t}});return s}async function x(e,n={}){const t="application/vnd.oai.openapi+json;version=3.0",i=M(e.links,"service-desc",t);if(a(i))return b.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:s,customParameters:r,signal:l}=n,{data:c}=await o(i.href,{signal:l,headers:{accept:t},query:{...r,token:s}});return c}function q(n){const t=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(n),i=null==t?void 0:t.groups;if(!i)return null;const{authority:a,code:s}=i;switch(a.toLowerCase()){case"ogc":switch(s.toLowerCase()){case"crs27":return e.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return e.WGS84.wkid;default:return null}case"esri":case"epsg":{const e=Number.parseInt(s,10);return Number.isNaN(e)?null:e}default:return null}}async function $(e,n,t){const i=await O(e,n,t);return c(i)}async function O(i,c,d){const{capabilities:{query:{maxRecordCount:m}},collection:y,layerDefinition:w,queryParameters:{apiKey:h,customParameters:b},spatialReference:j,supportedCrs:I}=i,{links:F}=y,k=M(F,"items","application/geo+json")||M(F,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(a(k))throw new s("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:v,num:T,start:x,timeExtent:q,where:$}=c;if(c.objectIds)throw new s("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const O=e.fromJSON(j),P=r(c.outSpatialReference,O),K=P.isWGS84?null:D(P,I),N=C(v,I),R=function(e){if(a(e))return null;const{start:n,end:t}=e;return`${l(n)?n.toISOString():".."}/${l(t)?t.toISOString():".."}`}(q),G=function(e){return a(e)||!e||"1=1"===e?null:e}($),Z=null!=T?T:null!=x&&void 0!==x?10:m,{data:A}=await o(k.href,{...d,query:{...b,...N,crs:K,datetime:R,query:G,limit:Z,startindex:x,token:h},headers:{accept:"application/geo+json"}});let E=!1;A.links&&(E=!!A.links.find((e=>"next"===e.rel))),!E&&Number.isInteger(A.numberMatched)&&Number.isInteger(A.numberReturned)&&(E=A.numberReturned<A.numberMatched);const{fields:S,globalIdField:B,hasM:J,hasZ:L,objectIdField:Q}=w,W=w.geometryType,z=g(A,{geometryType:W,hasZ:L,objectIdField:Q});if(!K&&P.isWebMercator)for(const t of z)if(l(t.geometry)){const i=u(t.geometry,W,L,!1);i.spatialReference=e.WGS84,t.geometry=p(n(i,P))}for(const e of z)e.objectId=e.attributes[Q];const H=K||!K&&P.isWebMercator?P.toJSON():t,U=new f;return U.exceededTransferLimit=E,U.features=z,U.fields=S,U.geometryType=W,U.globalIdFieldName=B,U.hasM=J,U.hasZ=L,U.objectIdFieldName=Q,U.spatialReference=H,U}function D(e,n){var t,i,a;const{isWebMercator:s,wkid:o}=e;if(!o)return null;const r=s?null!=(t=null!=(i=null!=(a=n[3857])?a:n[102100])?i:n[102113])?t:n[900913]:n[e.wkid];return r?`${j}${r}`:null}function P(e){if(a(e))return"";const{xmin:n,ymin:t,xmax:i,ymax:s}=e;return`${n},${t},${i},${s}`}function C(t,i){if(!function(e){return l(e)&&"extent"===e.type}(t))return null;const{spatialReference:a}=t;if(!a||a.isWGS84)return{bbox:P(t)};const s=D(a,i);return l(s)?{bbox:P(t),"bbox-crs":s}:a.isWebMercator?{bbox:P(n(t,e.WGS84))}:null}function M(e,n,t){return e.find((e=>e.rel===n&&e.type===t))||e.find((e=>e.rel===n&&!e.type))}export{I as F,F as I,$ as N,x as S,k as T,j,v as k,O as q,q as v,T as x}