import{r as t,c as e,g as i}from"./p-53bb6ab4.js";import{e as s,d as n,i as r,p as a,a1 as o,S as l,f as h,o as c,c as u,co as d,G as p,F as f,a as m,r as v,j as g,z as y,l as w,ay as b,ce as _,aP as k,X as x,aC as S,s as I,bo as E,P as M,A as F,af as C,al as O,T,E as j,ai as W,ap as V,ax as P,h as L,g as A,aw as U,cp as D,aW as N,aE as R,c6 as G,a9 as H,a8 as q,aN as $,bm as z,V as B,u as Z,a0 as K,$ as J,cq as Q,bv as X,cr as Y,k as tt,H as et,aO as it,y as st,M as nt}from"./p-e58503d5.js";import{a as rt,d as at}from"./p-7731c620.js";import{a as ot,l as lt,o as ht,h as ct}from"./p-765e6c28.js";import{h as ut}from"./p-e273719b.js";import{h as dt,f as pt,g as ft,t as mt,u as vt,A as gt,e as yt,j as wt,m as bt}from"./p-612a2c14.js";import{h as _t}from"./p-54330161.js";import{E as kt}from"./p-dae095dd.js";import{r as xt}from"./p-93765525.js";import{E as St}from"./p-22ccef7d.js";import{i as It}from"./p-a131049b.js";import{s as Et}from"./p-da9e7ba9.js";import{t as Mt}from"./p-2a99994a.js";import{l as Ft}from"./p-6f4b0bc8.js";import{r as Ct}from"./p-8747982c.js";import{h as Ot}from"./p-5f05b534.js";import{i as Tt,p as jt,m as Wt}from"./p-5d962998.js";import{e as Vt,c as Pt,i as Lt}from"./p-fb38a9d0.js";import{m as At}from"./p-889f7a78.js";import{s as Ut,a as Dt}from"./p-b6fa3228.js";import{m as Nt}from"./p-6b2eb7a7.js";import{l as Rt}from"./p-dfc6337f.js";import{getRotationAngle as Gt,getSize as Ht}from"./p-9f1c2d50.js";import{a as qt}from"./p-1f81b35d.js";import{t as $t}from"./p-f70b836b.js";import{e as zt}from"./p-ca657fcf.js";import{j as Bt,y as Zt,S as Kt,m as Jt}from"./p-8bc9b36a.js";import{D as Qt,c as Xt,p as Yt}from"./p-01e5a461.js";import{v as te,c as ee}from"./p-b79fcce3.js";import{r as ie}from"./p-a6c8fb32.js";import{y as se}from"./p-df35b79d.js";import{q as ne,o as re,j as ae,a as oe,s as le,p as he,m as ce,_ as ue,d as de}from"./p-e6fe5d89.js";import{n as pe}from"./p-d3105731.js";import{n as fe,t as me}from"./p-746a9d8f.js";import{m as ve,b as ge,l as ye,M as we,q as be,d as _e,j as ke,k as xe}from"./p-f16641e7.js";import{t as Se}from"./p-b8beb0d3.js";let Ie=class extends a{constructor(t){super(t),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1}};s([n({constructOnly:!0})],Ie.prototype,"layer",void 0),s([n()],Ie.prototype,"enabled",void 0),s([n()],Ie.prototype,"updating",void 0),s([n()],Ie.prototype,"availability",void 0),Ie=s([r("esri.views.interactive.snapping.SnappingLayerSource")],Ie);const Ee=Ie;let Me=class extends o{constructor(){super(...arguments),this.enabled=!0}};s([n({type:Boolean})],Me.prototype,"enabled",void 0),Me=s([r("esri.views.interactive.snapping.Settings.DefaultSnappingAlgorithm")],Me);let Fe=class extends o{constructor(t){super(t),this.lineSnapper=new Me,this.parallelLineSnapper=new Me,this.rightAngleSnapper=new Me,this.rightAngleTriangleSnapper=new Me,this.shortLineThreshold=15,this.distance=5,this.pointThreshold=1e-6,this.intersectionParallelLineThreshold=1e-6,this.parallelLineThreshold=1e-6,this.touchSensitivityMultiplier=1.5,this.pointOnLineThreshold=1e-6,this.orange=new ut([255,127,0]),this.lineHintWidthReference=3,this.lineHintWidthTarget=3,this.lineHintFadedExtensions=.3,this.parallelLineHintWidth=2,this.parallelLineHintLength=24,this.parallelLineHintOffset=1.5,this.rightAngleHintSize=24,this.rightAngleHintOutlineSize=1.5}};s([n({type:Me,constructOnly:!0,nonNullable:!0,json:{write:!0}})],Fe.prototype,"lineSnapper",void 0),s([n({type:Me,constructOnly:!0,nonNullable:!0,json:{write:!0}})],Fe.prototype,"parallelLineSnapper",void 0),s([n({type:Me,constructOnly:!0,nonNullable:!0,json:{write:!0}})],Fe.prototype,"rightAngleSnapper",void 0),s([n({type:Me,constructOnly:!0,nonNullable:!0,json:{write:!0}})],Fe.prototype,"rightAngleTriangleSnapper",void 0),s([n({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],Fe.prototype,"shortLineThreshold",void 0),s([n({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],Fe.prototype,"distance",void 0),s([n({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],Fe.prototype,"pointThreshold",void 0),s([n({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],Fe.prototype,"intersectionParallelLineThreshold",void 0),s([n({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],Fe.prototype,"parallelLineThreshold",void 0),s([n({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],Fe.prototype,"touchSensitivityMultiplier",void 0),s([n({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],Fe.prototype,"pointOnLineThreshold",void 0),s([n({type:ut,nonNullable:!0})],Fe.prototype,"orange",void 0),s([n({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],Fe.prototype,"lineHintWidthReference",void 0),s([n({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],Fe.prototype,"lineHintWidthTarget",void 0),s([n({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Fe.prototype,"lineHintFadedExtensions",void 0),s([n({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],Fe.prototype,"parallelLineHintWidth",void 0),s([n({type:Number,nonNullable:!0,range:{min:0,max:50},json:{write:!0}})],Fe.prototype,"parallelLineHintLength",void 0),s([n({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],Fe.prototype,"parallelLineHintOffset",void 0),s([n({type:Number,nonNullable:!0,range:{min:0,max:46},json:{write:!0}})],Fe.prototype,"rightAngleHintSize",void 0),s([n({type:Number,nonNullable:!0,range:{min:0,max:6},json:{write:!0}})],Fe.prototype,"rightAngleHintOutlineSize",void 0),Fe=s([r("esri.views.interactive.snapping.Settings.Defaults")],Fe);const Ce=new Fe;let Oe=class extends a{constructor(t){super(t),this.enabled=!1,this.enabledToggled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.featureSources=new l,this.distance=Ce.distance,this.touchSensitivityMultiplier=Ce.touchSensitivityMultiplier}get effectiveEnabled(){return this.enabledToggled?!this.enabled:this.enabled}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}};s([n()],Oe.prototype,"enabled",void 0),s([n()],Oe.prototype,"enabledToggled",void 0),s([n()],Oe.prototype,"selfEnabled",void 0),s([n()],Oe.prototype,"featureEnabled",void 0),s([n({type:l.ofType(Ee)})],Oe.prototype,"featureSources",void 0),s([n()],Oe.prototype,"distance",void 0),s([n()],Oe.prototype,"touchSensitivityMultiplier",void 0),s([n({readOnly:!0})],Oe.prototype,"effectiveEnabled",null),s([n({readOnly:!0})],Oe.prototype,"effectiveSelfEnabled",null),s([n({readOnly:!0})],Oe.prototype,"effectiveFeatureEnabled",null),Oe=s([r("esri.views.interactive.snapping.SnappingOptions")],Oe);const Te=Oe;let je=class extends o{constructor(t){super(t),this.digitSeparator=!1,this.dateFormat=null,this.places=null}};s([n()],je.prototype,"digitSeparator",void 0),s([n({json:{read:{source:"dateFormat",reader:xt}}})],je.prototype,"dateFormat",void 0),s([n()],je.prototype,"places",void 0),je=s([r("esri.widgets.FeatureForm.Format")],je);const We=je;let Ve=class extends a{constructor(t){super(t),this.description=null,this.domain=null,this.editable=!0,this.editorType=null,this.format=null,this.hint=null,this.includeTime=!0,this.label=null,this.maxLength=-1,this.minLength=-1,this.name=null,this.noValueOptionLabel=null,this.offValue=null,this.onValue=null,this.required=!1,this.requiredExpression=null,this.showNoValueOption=!1,this.visibilityExpression=null}};s([n()],Ve.prototype,"description",void 0),s([n()],Ve.prototype,"domain",void 0),s([n()],Ve.prototype,"editable",void 0),s([n()],Ve.prototype,"editorType",void 0),s([n({type:We})],Ve.prototype,"format",void 0),s([n()],Ve.prototype,"hint",void 0),s([n()],Ve.prototype,"includeTime",void 0),s([n()],Ve.prototype,"label",void 0),s([n()],Ve.prototype,"maxLength",void 0),s([n()],Ve.prototype,"minLength",void 0),s([n()],Ve.prototype,"name",void 0),s([n()],Ve.prototype,"noValueOptionLabel",void 0),s([n()],Ve.prototype,"offValue",void 0),s([n()],Ve.prototype,"onValue",void 0),s([n()],Ve.prototype,"required",void 0),s([n()],Ve.prototype,"requiredExpression",void 0),s([n()],Ve.prototype,"showNoValueOption",void 0),s([n()],Ve.prototype,"visibilityExpression",void 0),Ve=s([r("esri.widgets.FeatureForm.FieldConfig")],Ve);const Pe=Ve;let Le=class extends a{constructor(t){super(t),this.description=null,this.fieldConfig=null,this.label=null,this.state="expanded",this.visibilityExpression=null}castFieldConfig(t){return t?t.map((t=>t.declaredClass?t:new Pe(t))):null}};s([n()],Le.prototype,"description",void 0),s([n()],Le.prototype,"fieldConfig",void 0),s([h("fieldConfig")],Le.prototype,"castFieldConfig",null),s([n()],Le.prototype,"label",void 0),s([n()],Le.prototype,"state",void 0),s([n()],Le.prototype,"visibilityExpression",void 0),Le=s([r("esri.widgets.FeatureForm.FieldGroupConfig")],Le);const Ae=Le;let Ue=class extends(rt(a)){constructor(t){super(t),this.arcade=null,this.config=null,this.description=null,this.feature=null,this.label=null,this.state=null,this.visibilityExpression=null}get compiledFunc(){const{arcade:t}=this;return t&&t.arcadeUtils.createFunction(this.visibilityExpression)}get evaluatedVisibility(){const t=this.compiledFunc;if(!t)return;const{arcade:e}=this;return e.arcadeUtils.executeFunction(t,e.arcadeUtils.createExecContext(this.feature))}get inputFields(){return this._get("inputFields")}set inputFields(t){this.handles.removeAll(),t&&this.handles.add(t.map((t=>t.watch("visible",this._dirtyEvaluatedVisibility)))),this._set("inputFields",t)}get visible(){return!1!==this.evaluatedVisibility&&this.inputFields&&this.inputFields.some((t=>t.visible))}_dirtyEvaluatedVisibility(){this.visibilityExpression&&this.notifyChange("evaluatedVisibility")}};s([n()],Ue.prototype,"arcade",void 0),s([n()],Ue.prototype,"compiledFunc",null),s([n()],Ue.prototype,"config",void 0),s([n()],Ue.prototype,"evaluatedVisibility",null),s([c("config.description")],Ue.prototype,"description",void 0),s([n()],Ue.prototype,"feature",void 0),s([n()],Ue.prototype,"inputFields",null),s([c("config.label")],Ue.prototype,"label",void 0),s([c("config.state")],Ue.prototype,"state",void 0),s([c("config.visibilityExpression")],Ue.prototype,"visibilityExpression",void 0),s([n()],Ue.prototype,"visible",null),Ue=s([r("esri.widgets.FeatureForm.InputFieldGroup")],Ue);const De=Ue;function Ne(t,e,i,s=!0){return t.map((t=>{if("field"===t.type)return function(t,e,i){const{description:s,domain:n,editable:r,fieldName:a,hint:o,input:l,label:h,requiredExpression:c,visibilityExpression:u}=t,d=new Pe({description:s,domain:n,editable:r,hint:o,label:h,name:a,requiredExpression:e[c]||null,visibilityExpression:e[u]||null});if(l)if("barcode-scanner"===l.type||"text-area"===l.type||"text-box"===l.type)d.editorType=l.type,d.minLength=l.minLength,d.maxLength=l.maxLength;else if("combo-box"===l.type||"radio-buttons"===l.type)d.editorType=l.type,d.noValueOptionLabel=l.noValueOptionLabel,d.showNoValueOption=l.showNoValueOption;else if("switch"===l.type)d.editorType=l.type,d.offValue=l.offValue,d.onValue=l.onValue;else if("datetime-picker"===l.type){d.editorType=l.type,d.includeTime=l.includeTime;const{max:t,min:e}=l;if(t||e){const i="range"===(null==n?void 0:n.type)?Math.min(null==t?void 0:t.getTime(),n.maxValue):null==t?void 0:t.getTime(),s="range"===(null==n?void 0:n.type)?Math.max(null==e?void 0:e.getTime(),n.minValue):null==e?void 0:e.getTime();d.domain=new It({maxValue:i,minValue:s,name:"__internal-range-domain-based-on-datetime-picker-input__"})}}else i.push({type:"unsupported-input-type",details:l});return d}(t,e,i);if("group"===t.type){if(!s)return i.push({type:"nested-group",details:t}),null;const n=e[t.visibilityExpression]||null;return new Ae({description:t.description,state:t.initialState,fieldConfig:Ne(t.elements,e,i,!1),label:t.label,visibilityExpression:n})}return i.push({type:"unsupported-element-type",details:t}),null})).filter((t=>!!t))}function Re(t){return!!t.inputFields}function Ge(t){return!!t.fieldConfig}const He=new _t({attributes:{}}),qe="esri.widgets.FeatureForm.FeatureFormViewModel",$e=u.getLogger(qe);let ze=class extends(rt(v.EventedAccessor)){constructor(t){super(t),this._arcade=null,this._fieldPool=new d(St),this._fieldGroupPool=new d(De),this._featureClone=He.clone(),this._initialFeature=He.clone(),this._needsArcade=!1,this.messages=null,this.strict=!1}initialize(){const t=async()=>this.messages=await p("esri/widgets/FeatureForm/t9n/FeatureForm");t(),this.handles.add(f(t));const e=m(this,"fieldConfig",(async t=>{const i=[];t&&t.forEach((t=>{i.push(t.visibilityExpression),Ge(t)?t.fieldConfig.forEach((({requiredExpression:t,visibilityExpression:e})=>{i.push(t,e)})):i.push(t.requiredExpression)}));const s=i.filter((t=>!!t)),n=s.length>0;if(n){const t=await ot(),{arcadeUtils:i}=t;s.some((t=>i.hasGeometryOperations(t)))&&(await i.enableGeometryOperations(),e.remove()),this._arcade=t,this.notifyChange("inputFields")}this._needsArcade=n}));this.handles.add(e)}destroy(){this.fieldConfig=null,this.feature=null,this.layer=null,this._fieldPool.destroy(),this._fieldGroupPool.destroy()}get _allInputFields(){return this.inputFields.reduce(((t,e)=>Re(e)?[...t,...e.inputFields]:[...t,e]),[])}get _inputFieldCache(){const t=this._get("_inputFieldCache")||new Map;return t.forEach((t=>this._disposeInputOrGroup(t))),t.clear(),(this.get("layer.fields")||[]).forEach((e=>t.set(e,this._fieldPool.acquire()))),t}get _inputFieldGroupCache(){const t=this._get("_inputFieldGroupCache")||new Map;return t.forEach((t=>this._disposeInputOrGroup(t))),t.clear(),(this.fieldConfig||[]).filter(Ge).forEach((e=>t.set(e,this._fieldGroupPool.acquire()))),t}get description(){var t;return null==(t=this.formTemplate)?void 0:t.description}set description(t){void 0===t?this._clearOverride("description"):this._override("description",t)}get feature(){return this._get("feature")}set feature(t){this._featureClone=t?t.clone():He.clone(),this._initialFeature=this._featureClone.clone(),this._set("feature",t)}get fieldConfig(){const{formTemplate:t}=this;if(!t)return null;const{config:e,encounteredUnsupportedTypes:i}=function(t){var e;const i={},s=[];return null==(e=t.expressionInfos)||e.map((t=>i[t.name]=t.expression)),{config:Ne(t.elements,i,s),encounteredUnsupportedTypes:s}}(t);return i.length>0&&$e.warn("form-info::unsupported-type","encountered unsupported elements/types when parsing form info",i),e}set fieldConfig(t){t?this._override("fieldConfig",t):this._clearOverride("fieldConfig")}castFieldConfig(t){return t?t.map((t=>t instanceof Pe||t instanceof Ae?t:Ge(t)?new Ae(t):new Pe(t))):null}get formTemplate(){return this.layer&&"formTemplate"in this.layer?this.layer.formTemplate:null}set formTemplate(t){void 0===t?this._clearOverride("formTemplate"):this._override("formTemplate",t)}get inputFields(){const{_arcade:t,_inputFieldCache:e,_inputFieldGroupCache:i,_featureClone:s,messages:n,_needsArcade:r,layer:a,state:o}=this,l=s.clone();if("ready"!==o||r&&!t)return[];const h=this.get("layer.fields")||[],c=this.fieldConfig||[];let u;return u=0!==c.length?c.map((s=>{if(Ge(s)){const r=i.get(s),o=s.fieldConfig.map((i=>{const s=h.find((t=>t.name===i.name)),o=e.get(s);return o.set({arcade:t,field:s,config:i,feature:l,group:r,initialFeature:this._initialFeature,layer:a,messages:n,value:this.getValue(s.name)}),o})).filter((t=>t.visible));return r.set({arcade:t,config:s,feature:l,inputFields:o}),r}const r=h.find((t=>t.name===s.name)),o=e.get(r);return o.set({arcade:t,field:r,config:s,feature:l,group:null,initialFeature:this._initialFeature,layer:a,messages:n,value:this.getValue(r.name)}),o})):h.map((i=>{const s=e.get(i);return s.set({arcade:t,config:null,field:i,feature:l,group:null,initialFeature:this._initialFeature,layer:a,messages:n,value:this.getValue(i.name)}),s})),u.filter((t=>t.visible))}get layer(){var t;return null!=(t=this.feature)&&t.sourceLayer&&"applyEdits"in this.feature.sourceLayer?this.feature.sourceLayer:null}set layer(t){t?this._override("layer",t):this._clearOverride("layer")}get state(){return this.messages&&this.get("layer.loaded")?"ready":"disabled"}get title(){var t;return null==(t=this.formTemplate)?void 0:t.title}set title(t){void 0===t?this._clearOverride("title"):this._override("title",t)}get valid(){const t=this._allInputFields;return t.length>0&&t.every((({valid:t})=>t))}findField(t){return this._allInputFields.find((e=>e.name===t))}getValue(t){var e;const{_featureClone:i,layer:s}=this,n=!(null==s||!s.getField(t));return null!=(e=i.getAttribute(t))?e:n?null:void 0}setValue(t,e){const{_featureClone:i,strict:s}=this,n=this.findField(t);if(e=""===e?null:e,n&&i.getAttribute(t)!==e){if(n.value=e,this.get("layer.typeIdField")===n.name&&"types"in this.layer){const t=new Set;this.layer.types.forEach((e=>Object.keys(e.domains).forEach((e=>t.add(e))))),t.forEach((t=>{const e=this.findField(t);e&&e.notifyChange("domain")}))}s&&!n.valid||(i.setAttribute(t,e),this.notifyChange("inputFields"),this._emitChangeEvent(n))}}getValues(){return{...this._featureClone.attributes}}submit(){const t=this._allInputFields,e=t.filter((t=>t.valid)).map((({name:t})=>t)),i=t.filter((t=>!t.valid)).map((({name:t})=>t)),s=this.getValues();this.emit("submit",{valid:e,invalid:i,values:s})}_disposeInputOrGroup(t){Re(t)?this._disposeGroup(t):this._disposeInput(t)}_disposeGroup(t){t.inputFields.forEach((t=>this._disposeInput(t))),this._fieldGroupPool.release(t)}_disposeInput(t){this._fieldPool.release(t)}_emitChangeEvent({name:t,valid:e,value:i}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:t,value:i,valid:e})}};s([n({readOnly:!0})],ze.prototype,"_allInputFields",null),s([n({readOnly:!0})],ze.prototype,"_inputFieldCache",null),s([n({readOnly:!0})],ze.prototype,"_inputFieldGroupCache",null),s([n()],ze.prototype,"description",null),s([n()],ze.prototype,"feature",null),s([n()],ze.prototype,"fieldConfig",null),s([h("fieldConfig")],ze.prototype,"castFieldConfig",null),s([n({type:kt})],ze.prototype,"formTemplate",null),s([n({readOnly:!0,dependsOn:["messages","feature","fieldConfig","layer.fields","layer.loaded","state"]})],ze.prototype,"inputFields",null),s([n()],ze.prototype,"layer",null),s([n()],ze.prototype,"messages",void 0),s([n()],ze.prototype,"state",null),s([n()],ze.prototype,"strict",void 0),s([n()],ze.prototype,"title",null),s([n()],ze.prototype,"valid",null),s([n()],ze.prototype,"getValues",null),s([n()],ze.prototype,"submit",null),ze=s([r(qe)],ze);const Be=ze,Ze="esri-feature-form__description-text",Ke={datePattern:"D",timePattern:"tt"};function Je(t){return t&&t.inputFields}let Qe=class extends y{constructor(t,e){super(t,e),this._activeDateFieldEdit=null,this._activeInputName=null,this._fieldFocusNeeded=!1,this._fieldToInitialIncompatibleDomainValue=new Map,this._switchFieldsWithInitialIncompatibleValue=new Set,this._userUpdatedInputFieldNames=new Set,this.description=null,this.feature=null,this.fieldConfig=null,this.formTemplate=null,this.groupDisplay="all",this.headingLevel=2,this.label=void 0,this.layer=null,this.messages=null,this.strict=null,this.title=null,this.viewModel=new Be,this._handleRadioInputChange=t=>{this._commitInputValue(t.target)},this._handleInputInput=t=>{this._commitInputValue(t.target,!0)},this._handleFormKeyDown=this._handleFormKeyDown.bind(this),this._handleInputBlur=this._handleInputBlur.bind(this),this._handleInputFocus=this._handleInputFocus.bind(this),this._handleNumberInputMouseDown=this._handleNumberInputMouseDown.bind(this),this._handleInputKeyDown=this._handleInputKeyDown.bind(this),this._handleOptionChange=this._handleOptionChange.bind(this),this._handleGroupClick=this._handleGroupClick.bind(this),this._handleSubmit=this._handleSubmit.bind(this),this._afterInputCreateOrUpdate=this._afterInputCreateOrUpdate.bind(this)}initialize(){this.own(this.watch("feature",(()=>{const t=this._getFocusableInput("forward");this._activeInputName=t&&t.name,this._userUpdatedInputFieldNames.clear(),this._fieldToInitialIncompatibleDomainValue.clear(),this._switchFieldsWithInitialIncompatibleValue.clear(),this._fieldFocusNeeded=!0})),this.on("submit",(t=>{if(t.invalid.length>0){const[e]=t.invalid;t.invalid.forEach((t=>this._userUpdatedInputFieldNames.add(t))),this._activeInputName=e,this._fieldFocusNeeded=!0,this.scheduleRender()}})))}loadDependencies(){return import("./p-225bd576.js")}destroy(){this._userUpdatedInputFieldNames.clear(),this._userUpdatedInputFieldNames=null}getValues(){return null}submit(){return null}render(){const{state:t}=this.viewModel;return w("div",{class:this.classes("esri-feature-form","esri-widget","esri-widget--panel")},"ready"===t?this.renderForm():null)}renderForm(){const t=this.title?w(Et,{key:"title",level:this.headingLevel},this.title):null,e=this.description?w("p",{class:Ze,key:"description"},this.description):null,i=t||e?w("div",{class:"esri-feature-form__form-header"},t,e):null;return w("form",{class:"esri-feature-form__form",novalidate:!0,onsubmit:this._handleSubmit,onkeydown:this._handleFormKeyDown},i,this.renderFields())}renderFields(){const{viewModel:{inputFields:t}}=this;return t.map(((t,e)=>Je(t)?this.renderGroup(t,e):this.renderLabeledField(t)))}renderGroup(t,e){const{description:i,inputFields:s,label:n,state:r}=t,a=this.viewModel.findField(this._activeInputName),o=!(!a||a.group!==t),l=`${this.id}_group_${e}`,h=`${this.id}_group-label_${e}`,c=`${this.id}_group-description_${e}`,u=i?w("p",{class:this.classes("esri-feature-form__group-description",Ze),id:c},i):null,d="sequential"===this.groupDisplay,p=d?o:"expanded"===r,f=p?"esri-icon-up":"esri-icon-down";return w("fieldset",{"aria-expanded":p.toString(),"aria-labelledby":h,"aria-describedby":i?c:"",class:this.classes("esri-feature-form__group",d?"esri-feature-form__group--sequential":null,p?null:"esri-feature-form__group--collapsed",o?"esri-feature-form__group--active":null),"data-group":t,id:l,key:e,onclick:this._handleGroupClick},w("button",{role:d?"presentation":void 0,class:"esri-feature-form__group-header",type:"button",tabIndex:d?-1:0},w("div",{class:"esri-feature-form__group-title"},w(Et,{class:"esri-feature-form__group-label",id:h,level:this.headingLevel+(this.title?1:0)},n),u),d?null:w("span",{class:this.classes(f,"esri-feature-form__group-toggle-icon")})),s.map((t=>this.renderLabeledField(t))))}_getFocusableInput(t,e){const i=this.viewModel._allInputFields,s="forward"===t?i:i.slice().reverse();let n;if(e)if(Je(e))n=s.indexOf(e.inputFields[0]);else{let i;if(this._isFieldInClosedCollapsibleGroup(e)){const{inputFields:s}=e.group;i="forward"===t?s[s.length-1]:s[0]}else i=e;n=s.indexOf(i)+1}else n=0;for(let t=n;t<s.length;t++){const e=s[t];if(e.visible)return e}return null}renderLabeledField(t){const{label:e,layer:i,type:s}=t;return w("label",{key:`${i.id}-${t.name}`,class:"esri-feature-form__label"},[e,"unsupported"!==s?this.renderInputField(t):this.renderUnsupportedField(t),this.renderAuxiliaryText(t)])}renderInputField(t){const{viewModel:e}=this,{domain:i,editable:s,name:n,type:r}=t,a=e.getValue(n),o=!s,l=this.getCommonInputProps(t);if("coded-value"===(null==i?void 0:i.type)&&!o){if("switch"===t.editorType){if(!(this._switchFieldsWithInitialIncompatibleValue.has(n)||null==a||t.config.onValue!==a&&t.config.offValue!==a))return this.renderSwitchInputField(a,l);this._switchFieldsWithInitialIncompatibleValue.add(n)}return"radio-buttons"===t.editorType?this.renderRadioButtonsInputField(a,i.codedValues.map((({code:t,name:e})=>({value:t,name:e}))),l):this.renderSelectInputField(a,i.codedValues.map((({code:t,name:e})=>({value:t,name:e}))),l)}return"text"===r&&"text-area"===t.editorType||"rich-text"===t.editorType?w("textarea",{...l}):"datetime-picker"===t.editorType||"date"===r?this.renderDateInputField(a,l):w("input",{type:"text"===r?"text":"number",...l})}_parseDateTime(t,e,i){if(i){var s;let n=Ft.DateTime.fromJSDate(this._parseDate(t,i));const r=Ft.DateTime.fromMillis(null!=(s=e.value)?s:Date.now());return n=n.set("date"===i?{hour:r.hour,minute:r.minute,second:r.second}:{day:r.day,month:r.month,year:r.year}),n.isValid?n.toMillis():null}const n=Ft.DateTime.fromJSDate(this._parseDate(t));return n.isValid?n.toMillis():null}renderDateInputField(t,e){const{date:i,time:s}=this._formatDate(0),n=`${this.id}-${e.key}`,r=`${n}-date`,a=`${n}-time`,o=e["data-field"],{includeTime:l}=o,{_activeDateFieldEdit:h}=this;let{date:c,time:u}=this._formatDate(t);var d,p,f,m;return(null==h?void 0:h.fieldName)===o.name&&(c=null!=(d=null==(p=h.date.input)?void 0:p.value)?d:c,u=null!=(f=null==(m=h.time.input)?void 0:m.value)?f:u),w("div",{key:`${e.key}-date`,class:"esri-feature-form__date-input-container"},w("div",{class:this.classes("esri-feature-form__date-input-part",l?null:"esri-feature-form__date-input-part--lone")},w("input",{"aria-label":o.label,"aria-describedby":r,type:"text",...e,"data-date-part":"date",class:this.classes(e.class,"esri-feature-form__input--date"),value:c}),w("div",{class:"esri-feature-form__date-format-hint",id:r},i)),l?w("div",{class:"esri-feature-form__date-input-part",key:"time-input"},w("input",{"aria-describedby":a,"aria-label":o.label,type:"text",...e,"data-date-part":"time",class:this.classes(e.class,"esri-feature-form__input--time"),value:u}),w("div",{class:"esri-feature-form__date-format-hint",id:a},s)):null)}renderUnsupportedField(t){const e=this.getCommonInputProps(t);return w("input",{afterCreate:e.afterCreate,afterUpdate:e.afterUpdate,class:this.classes("esri-input","esri-feature-form__input","esri-feature-form__input--disabled"),"data-field":e["data-field"],onfocus:e.onfocus,readOnly:!0,tabIndex:e.tabIndex,type:"text",value:e.value})}renderSelectInputField(t,e,i){const s=e.map((t=>w("option",{value:`${t.value}`,key:t.name},t.name))),n=i["data-field"];if(this.registerIncompatibleValue(t,e,n,(t=>{s.unshift(w("option",{value:`${t}`,key:"incompatible-option",readOnly:!0},t))})),!n.required&&("combo-box"!==n.editorType||n.config.showNoValueOption)){var r;const t=(null==(r=n.config)?void 0:r.noValueOptionLabel)||this.messages.empty;s.unshift(w("option",{value:"",key:"empty-option"},t))}return w("select",{...i,class:this.classes(i.class,"esri-select"),onchange:this._handleOptionChange},s)}registerIncompatibleValue(t,e,i,s){const n=this._fieldToInitialIncompatibleDomainValue,r=n.has(i.name);(r||null!=t&&""!==t&&!e.find((e=>e.value===t))||r)&&(r||n.set(i.name,t),null==s||s(n.get(i.name)))}renderRadioButtonsInputField(t,e,i){const s=i["data-field"],n=e.map((e=>this.renderRadioButton({key:e.name,label:e.name,name:s.name,value:e.value,selected:e.value===t,props:i})));if(this.registerIncompatibleValue(t,e,s),!s.required&&(!s.config||s.config.showNoValueOption)){var r;const e="",a=(null==(r=s.config)?void 0:r.noValueOptionLabel)||this.messages.empty;n.unshift(this.renderRadioButton({key:"empty-option",label:a,name:s.name,value:e,selected:t===e||null===t,props:i}))}return w("div",{key:`${i.key}-radio`,class:"esri-feature-form__input--radio-group"},n)}renderSwitchInputField(t,e){const i=e["data-field"];return w("calcite-switch",{...e,class:"esri-feature-form__input--switch",switched:t===i.config.onValue,onCalciteSwitchChange:t=>{this._parseValue(t.currentTarget)}})}renderRadioButton({key:t,name:e,value:i,selected:s,label:n,props:r}){return w("label",{key:t,class:"esri-feature-form__input--radio-label"},w("input",{...r,class:"esri-feature-form__input--radio",name:e,type:"radio",value:i,checked:s,onchange:this._handleRadioInputChange}),n)}renderAuxiliaryText(t){return this._userUpdatedInputFieldNames.has(t.name)&&!t.valid?w("div",{key:"error-message"},w("span",{class:this.classes("esri-feature-form__input-icon--invalid","esri-icon-notice-triangle")}),w("div",{class:"esri-feature-form__field-error-message"},t.errorMessage)):t.description?w("div",{key:"description",class:Ze},t.description):void 0}getCommonInputProps(t){const{groupDisplay:e,viewModel:i}=this,{editable:s,group:n,hint:r,maxLength:a,minLength:o,name:l,required:h,type:c,valid:u}=t,d=i.getValue(l),p=this._userUpdatedInputFieldNames.has(l),f=!s,m="all"===e&&"collapsed"===(null==n?void 0:n.state);return{afterCreate:this._afterInputCreateOrUpdate,afterUpdate:this._afterInputCreateOrUpdate,"aria-invalid":u?"false":"true",class:this.classes("esri-input","esri-feature-form__input",f?"esri-feature-form__input--disabled":null,p&&!u?"esri-feature-form__input--invalid":null),key:l,minlength:o>-1?`${o}`:"",maxlength:a>-1?`${a}`:"",...this._getNumberFieldConstraints(t),readOnly:f,value:null==d?"":`${d}`,"data-field":t,onfocus:this._handleInputFocus,oninput:this._handleInputInput,onblur:this._handleInputBlur,onkeydown:this._handleInputKeyDown,onmousedown:"number"===c?this._handleNumberInputMouseDown:null,placeholder:"number"===c||"text"===c?r:"",required:h,tabIndex:m?-1:0}}_isFieldInClosedCollapsibleGroup(t){var e;return"all"===this.groupDisplay&&!Je(t)&&"collapsed"===(null==t||null==(e=t.group)?void 0:e.state)}_handleNumberInputMouseDown({target:t}){t.focus(),this.scheduleRender()}_getNumberFieldConstraints(t){const e=lt(t.domain)||ht(t.field);return e&&e.max!==Number.MAX_VALUE&&e.min!==Number.MIN_VALUE?e:{min:null,max:null}}_afterInputCreateOrUpdate(t){const e=t["data-field"],i=this.viewModel.findField(this._activeInputName),s=this._fieldToInitialIncompatibleDomainValue.get(e.name)===e.value;this._fieldFocusNeeded&&i===e&&("radio-buttons"!==e.editorType||s||t.checked)&&(this._fieldFocusNeeded=!1,t.focus())}_handleInputFocus(t){const e=t.target,i=e["data-field"];this._activeInputName=i.name,"date"===i.type&&this._syncDateFieldEdits(e)}_handleInputBlur(t){const e=t.target,i=e["data-field"];if("date"===i.type){const n=t.relatedTarget,r=n&&n["data-field"];if(r&&"date"===i.type&&"date"===r.type&&i.field===r.field){if(""!==e.value&&""===n.value){var s;const r=n.getAttribute("data-date-part");n.value=this._formatDate(null!=(s=i.value)?s:Date.now())[r],this._parseDate(e.value,e.getAttribute("data-date-part"))&&this._commitInputValue(t.target,!0,!1)}return}}this._commitInputValue(e),this.scheduleRender()}_commitInputValue(t,e=!1,i=!0){const s=t["data-field"];if(this._activeDateFieldEdit){const{date:l,time:h}=this._activeDateFieldEdit,c=this._parseDateTime(t.value,s,l.active?"date":"time"),u=null!==this.viewModel.getValue(s.name),d=l.input&&(h.input||!s.includeTime),p=null===c;if(e){if(p)return;(d||!i||u)&&this._updateDateFieldValue(s,c)}else{var n,r;if(""===(null==(n=l.input)?void 0:n.value)||""===(null==(r=h.input)?void 0:r.value))this._updateDateFieldValue(s,null);else if(d){var a,o;const t=`${l.input.value} ${null!=(a=null==(o=h.input)?void 0:o.value)?a:""}`,e=this._parseDateTime(t,s);null===e&&u||this._updateDateFieldValue(s,e)}this._activeDateFieldEdit=null}}else this._updateFieldValue(t)}_handleInputKeyDown(t){const{key:e,altKey:i,ctrlKey:s,metaKey:n}=t,r=t.target["data-field"];if("Enter"===e)this._isFieldInClosedCollapsibleGroup(r)&&(r.group.state="expanded");else{const{type:a}=r.field,o="single"===a||"double"===a,l=!i&&!s&&!n;if(("integer"===a||"small-integer"===a||o)&&l&&1===e.length){const i=Number(e),s=["-","+"],n=["e","."],r=o?[...s,...n]:s;isNaN(i)&&-1===r.indexOf(e)&&t.preventDefault()}}}_syncDateFieldEdits(t){var e,i;const s=t["data-field"];if("date"!==s.type)return;const n=t.getAttribute("data-date-part"),r="date"===n?{value:t.value,input:t,active:!0}:{...null==(e=this._activeDateFieldEdit)?void 0:e.date,active:!1},a="time"===n?{value:t.value,input:t,active:!0}:{...null==(i=this._activeDateFieldEdit)?void 0:i.time,active:!1};this._activeDateFieldEdit={fieldName:s.name,date:r,time:a}}_updateFieldValue(t){const e=t["data-field"];this.viewModel.setValue(e.name,this._parseValue(t)),this._userUpdatedInputFieldNames.add(e.name)}_updateDateFieldValue(t,e){this.viewModel.setValue(t.name,e),this._userUpdatedInputFieldNames.add(t.name)}_parseValue(t){const e=t["data-field"],i=t.value;if("switch"===e.editorType&&!(t instanceof HTMLSelectElement))return t.switched?e.config.onValue:e.config.offValue;if("radio-buttons"===e.editorType&&"radio"===t.type&&!t.checked)return e.value;const{type:s}=e;if("number"===s)return i?parseFloat(i):null;if("date"===s){if(!i)return null;const s=Number(i);if(!isNaN(s))return s;const n=t.getAttribute("data-date-part"),r=this._parseDate(i,n);if(!r)return null;let a=Ft.DateTime.fromJSDate(r);const o=e.domain,l=Ft.DateTime.now();let h=l;if(o&&"range"===o.type){const t=Ft.DateTime.fromMillis(o.maxValue);l<t&&(h=t)}const c=this.viewModel.getValue(e.name),u=null!=c?Ft.DateTime.fromMillis(c):h;return a=a.set("date"===n?{hour:u.hour,minute:u.minute,second:u.second}:{day:u.day,month:u.month,year:u.year}),a.toMillis()}return i}_handleOptionChange(t){this._commitInputValue(t.target),this.scheduleRender()}_handleGroupClick(t){var e;const i=t.currentTarget["data-group"],s="expanded"===i.state,n="sequential"===this.groupDisplay,r=".esri-feature-form__group-header";if(!s||t.target.closest(r)){if(this._activeInputName=null==(e=this._getFocusableInput("forward",i))?void 0:e.name,n){const e=t.target.closest(r);if(s&&!e)return;this.viewModel.inputFields.forEach((t=>{Je(t)&&t!==i&&(t.state="collapsed")}))}i.state=s?"collapsed":"expanded",this._fieldFocusNeeded=n,this.scheduleRender()}}_handleSubmit(t){t.preventDefault()}_handleFormKeyDown(t){"Enter"===t.key&&this.viewModel.submit()}_formatDate(t){if(null==t)return{date:"",time:""};const e=Ft.DateTime.fromMillis(t,{locale:b(),numberingSystem:"latn"});return{date:e.toLocaleString({year:"numeric",month:"2-digit",day:"2-digit"}),time:e.toFormat(Ke.timePattern)}}_parseDate(t,e){if(null==t||""===t)return null;const{timePattern:i,datePattern:s}=Ke,n=Ft.DateTime.fromFormat(t,e?"date"===e?s:i:`${s} ${i}`,{locale:b(),numberingSystem:"latn"});return n.isValid?n.toJSDate():null}};s([c("viewModel.description")],Qe.prototype,"description",void 0),s([c("viewModel.feature")],Qe.prototype,"feature",void 0),s([c("viewModel.fieldConfig")],Qe.prototype,"fieldConfig",void 0),s([c("viewModel.formTemplate")],Qe.prototype,"formTemplate",void 0),s([n()],Qe.prototype,"groupDisplay",void 0),s([n()],Qe.prototype,"headingLevel",void 0),s([n({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],Qe.prototype,"label",void 0),s([c("viewModel.layer")],Qe.prototype,"layer",void 0),s([n(),g("esri/widgets/FeatureForm/t9n/FeatureForm")],Qe.prototype,"messages",void 0),s([c("viewModel.strict")],Qe.prototype,"strict",void 0),s([c("viewModel.title")],Qe.prototype,"title",void 0),s([n(),Mt(["value-change","submit"])],Qe.prototype,"viewModel",void 0),s([c("viewModel.getValues")],Qe.prototype,"getValues",null),s([c("viewModel.submit")],Qe.prototype,"submit",null),Qe=s([r("esri.widgets.FeatureForm")],Qe);const Xe=Qe;var Ye;const ti=t=>`${t.label}-${t.layer.id}`;let ei=Ye=class extends(rt(a)){constructor(t){super(t),this._activeFetchInfo={id:null,request:null},this.description=null,this.label=null,this.layer=null,this.template=null,this.thumbnail=null}initialize(){this.handles.add(m(this,["layer.renderer","template"],(()=>{this._activeFetchInfo.id=null,this._activeFetchInfo.request=null,this._set("thumbnail",null)})))}clone(){const t=this.thumbnail?this.thumbnail.cloneNode(!0):null,e=new Ye({layer:this.layer,template:this.template});return e._set("thumbnail",t),e}async fetchThumbnail(){const{_activeFetchInfo:t}=this;return ti(this)===t.id||(t.id=ti(this),t.request=this._getPreviewSymbol().then((async e=>{var i;if(ti(this)!==t.id)return;const s={maxSize:36};"dictionary"===(null==(i=this.layer.renderer)?void 0:i.type)&&(s.fieldMap=this.layer.renderer.fieldMap,s.feature={attributes:this.template.prototype.attributes});const n=await dt(e,s);ti(this)===t.id&&this._set("thumbnail",n)}))),t.request}async _getPreviewSymbol(){const{layer:t,template:e,layer:{renderer:i}}=this;if(i){const t=new _t({attributes:e.prototype.attributes}),s=await i.getSymbolAsync(t);if(s)return s}return this._getFallbackSymbolFromGeometry(t)}_getFallbackSymbolFromGeometry(t){const{geometryType:e}=t;return"point"===e||"multipoint"===e?import("./p-8bc9b36a.js").then((function(t){return t.K})).then((t=>new t.default)):"polyline"===e?import("./p-8bc9b36a.js").then((function(t){return t.I})).then((t=>new t.default)):"polygon"===e||"mesh"===e||"multipatch"===e?import("./p-8bc9b36a.js").then((function(t){return t.J})).then((t=>new t.default)):void 0}};s([n({aliasOf:"template.description"})],ei.prototype,"description",void 0),s([n({aliasOf:"template.name"})],ei.prototype,"label",void 0),s([n()],ei.prototype,"layer",void 0),s([n()],ei.prototype,"template",void 0),s([n({readOnly:!0})],ei.prototype,"thumbnail",void 0),ei=Ye=s([r("esri.widgets.FeatureTemplates.TemplateItem")],ei);const ii=ei;let si=class extends(Ct(a)){constructor(t){super(t),this.items=null,this.label=null}};s([n()],si.prototype,"items",void 0),s([n()],si.prototype,"label",void 0),si=s([r("esri.widgets.FeatureTemplates.TemplateItemGroup")],si);const ni=si,ri=({layer:t})=>({key:t,label:t.title}),ai=({layer:t})=>t.geometryType;let oi=class extends(rt(v.EventedAccessor)){constructor(t){super(t),this._itemPool=new _(ii),this._groupPool=new _(ni),this.filterFunction=null,this.groupBy="layer",this.selectedItem=null}destroy(){this._templateToLayer.clear()}get _templateToLayer(){const t=new Map;for(const{layer:e,templates:i}of this._featureTemplateInfos)for(const s of i)t.set(s,e);return t}set layers(t){if(this.handles.remove("layers"),t){const e=()=>this.notifyChange("state");this.handles.add(t.map((t=>k(t,"loadStatus",e))),"layers")}this._set("layers",t)}get layers(){return this._get("layers")}get state(){const{layers:t}=this;return t&&0!==t.length?t.some((t=>"loading"===t.loadStatus||"not-loaded"===t.loadStatus))?"loading":"ready":"disabled"}get _featureTemplateInfos(){return this.layers?this.layers.filter((({capabilities:t,loaded:e})=>e&&t.operations.supportsEditing&&t.operations.supportsAdd)).map((t=>({layer:t,templates:this._getTemplatesForLayer(t)}))).filter((t=>null!=t&&t.templates.length>0)):[]}get numberOfFeatureTemplates(){return this._featureTemplateInfos.reduce(((t,e)=>t+e.templates.length),0)}get items(){const t=this._featureTemplateInfos;if(0===t.length)return this._releasePreviousItems(),[];const{groupBy:e}=this;if("none"===e){const e=t.map((({templates:t})=>t.filter((({name:t})=>!this.filterFunction||this.filterFunction({label:t}))))).map((t=>t.map((t=>this._createItem(t))))).reduce(((t,e)=>[...t,...e]),[]);return this._releasePreviousItems(),e}const i=t.reduce(((t,{layer:i,templates:s})=>(s.forEach((s=>{const n=("layer"===e?ri:"geometry"===e?ai:e)({template:s,layer:i});if(n){const e="string"==typeof n?n:n.key,i="string"==typeof n?n:n.label;t.has(e)||t.set(e,{label:i,templates:[]}),t.get(e).templates.push(s)}})),t)),new Map);if(0===i.size)return this._releasePreviousItems(),[];const s=[],{filterFunction:n}=this;return i.forEach((t=>{const{label:e,templates:i}=t;if(!n||this.filterFunction(t))s.push(this._createGroup(e,i.map((t=>this._createItem(t)))));else{const t=i.filter((({name:t})=>this.filterFunction({label:t}))).map((t=>this._createItem(t)));t.length>0&&s.push(this._createGroup(e,t))}})),this._releasePreviousItems(),s}refresh(){this.notifyChange("items")}select(t){const e=(null==t?void 0:t.clone())||null;this._set("selectedItem",e),this.emit("select",{item:e,template:(null==e?void 0:e.template)||null})}_getTemplatesForLayer(t){return[...t.templates||[],...(t.types||[]).map((t=>t.templates)).reduce(((t,e)=>[...t,...e]),[])]}_createItem(t){const e=this._itemPool.acquire();return e.set({template:t,layer:this._templateToLayer.get(t)}),e}_createGroup(t,e){const i=this._groupPool.acquire();return i.set("label",t),i.items=e,i}_releasePreviousItems(){this._destroyItems(this._get("items"))}_destroyItems(t){t&&t.forEach(t[0]instanceof ii?t=>this._destroyItem(t):t=>this._destroyGroup(t))}_destroyGroup(t){t.items.forEach((t=>this._destroyItem(t))),t.items.length=0,this._groupPool.release(t)}_destroyItem(t){t.layer=null,t.template=null,this._itemPool.release(t)}};s([n({readOnly:!0})],oi.prototype,"_templateToLayer",null),s([n()],oi.prototype,"filterFunction",void 0),s([n()],oi.prototype,"groupBy",void 0),s([n()],oi.prototype,"layers",null),s([n()],oi.prototype,"state",null),s([n({readOnly:!0})],oi.prototype,"_featureTemplateInfos",null),s([n({readOnly:!0})],oi.prototype,"numberOfFeatureTemplates",null),s([n({readOnly:!0})],oi.prototype,"items",null),s([n({readOnly:!0})],oi.prototype,"selectedItem",void 0),s([n()],oi.prototype,"select",null),oi=s([r("esri.widgets.FeatureTemplates.FeatureTemplatesViewModel")],oi);const li=oi;function hi(t){const{id:e,identify:i,filterEnabled:s=!0,headingLevel:n=4,items:r,selectedItem:a,messages:o,filterText:l="",onFilterChange:h,renderIcon:c,onItemMouseLeave:u,onItemMouseEnter:d,onItemSelect:p}=t;return w("div",{class:x("esri-item-list","esri-widget"),key:e},s?function(t){const e=`${t.id}-placeholder`;return w("div",{class:"esri-item-list__filter-container",key:"filter"},w("input",{"aria-labelledby":e,class:x("esri-input","esri-item-list__filter-input"),oninput:e=>{t.onFilterChange&&t.onFilterChange(e.currentTarget.value)},value:t.filterText,type:"search"}),t.filterText?null:w("div",{class:"esri-item-list__filter-placeholder",id:e,key:"placeholder"},w("span",{class:"esri-icon-search","aria-hidden":"true"}),w("div",{class:"esri-item-list__filter-placeholder-text"},t.messages.filterPlaceholder)))}({filterText:l,messages:o,onFilterChange:h,id:e}):null,function(t){const{headingLevel:e,identify:i,items:s,renderIcon:n,filterText:r,onItemMouseLeave:a,onItemMouseEnter:o,onItemSelect:l,selectedItem:h}=t;return 0===s.length?w("div",{class:"esri-item-list__no-matches-message",key:"no-matches"},t.messages.noMatches):function(t){return!!t.items}(s[0])?w("div",{class:"esri-item-list__scroller",key:"item-container"},s.map((t=>function(t){const{group:e,headingLevel:i,identify:s,onItemMouseLeave:n,onItemMouseEnter:r,onItemSelect:a,filterText:o,renderIcon:l,selectedItem:h}=t,c=`${s&&s(e)||e.id}-heading`;return w("section",{"aria-labelledby":c,class:"esri-item-list__group",key:e.label},w(Et,{id:c,class:"esri-item-list__group-header",level:i},ui({text:e.label,match:o})),w("ul",{class:"esri-item-list__list"},e.items.map((t=>ci({item:t,identify:s,grouped:!0,onItemMouseLeave:n,onItemMouseEnter:r,onItemSelect:a,renderIcon:l,filterText:o,selectedItem:h})))))}({filterText:r,group:t,headingLevel:e,identify:i,onItemMouseLeave:a,onItemMouseEnter:o,onItemSelect:l,renderIcon:n,selectedItem:h})))):w("ul",{class:x("esri-item-list__list","esri-item-list__scroller"),key:"item-container"},s.map((t=>ci({item:t,identify:i,grouped:!0,onItemMouseLeave:a,onItemMouseEnter:o,onItemSelect:l,renderIcon:n,filterText:r,selectedItem:h}))))}({identify:i,items:r,selectedItem:a,messages:o,filterText:l,headingLevel:n,renderIcon:c,onItemMouseLeave:u,onItemMouseEnter:d,onItemSelect:p}))}function ci(t){const{identify:e,item:i,selectedItem:s,grouped:n,filterText:r,onItemSelect:a,onItemMouseEnter:o,onItemMouseLeave:l,renderIcon:h}=t,c=`${(null==e?void 0:e(i))||i.id}__${i.label}`,u=s?`${(null==e?void 0:e(s))||s.id}__${s.label}`:"";return w("li",{"aria-level":n?"2":"",class:x("esri-item-list__list-item",c===u&&"esri-item-list__list-item--selected"),"data-item":i,key:c,onclick:t=>{a&&a(t.currentTarget["data-item"])},onmouseenter:t=>{o&&o(t.currentTarget["data-item"])},onkeydown:t=>{S(t.key)&&a&&a(t.currentTarget["data-item"])},onmouseleave:t=>{l&&l(t.currentTarget["data-item"])},tabIndex:0},w("div",{class:"esri-item-list__list-item-container"},h&&h({item:i}),ui({text:i.label,match:r})))}function ui(t){const{match:e,text:i}=t;let s=null;if(e){const t=i.toLowerCase(),n=e.toLowerCase(),r=t.indexOf(n);if(-1===r)s=i;else{const t=i.substring(0,r),n=i.substr(r,e.length),a=i.substring(r+e.length);s=w("span",null,t,w("strong",null,n),a)}}else s=i;return w("span",{class:"esri-item-list__list-item-label"},s)}function di(t){const{label:e}=t;return function(t){return"items"in t}(t)?e:`${e}â€“${t.layer.id}`}const pi={filter:!0};let fi=class extends(rt(y)){constructor(t,e){super(t,e),this._iconIntersectionObserver=new IntersectionObserver(((t,e)=>{t.forEach((async t=>{if(t.isIntersecting){const i=t.target;if(!i["data-has-icon"]){const t=i["data-item"];i["data-has-icon"]=!0,e.unobserve(i),await t.fetchThumbnail(),i["data-item"]===t&&t.thumbnail?i.appendChild(t.thumbnail):(i["data-has-icon"]=!1,e.observe(i))}}}))})),this.filterFunction=null,this.filterText="",this.groupBy=null,this.headingLevel=4,this.label=void 0,this.layers=null,this.messages=null,this.selectedItem=null,this.viewModel=new li,this.visibleElements={...pi},this.renderItemIcon=this.renderItemIcon.bind(this),this._afterItemCreateOrUpdate=this._afterItemCreateOrUpdate.bind(this),this._afterItemRemoved=this._afterItemRemoved.bind(this)}initialize(){const t=({label:t})=>!this.filterText||t.toLowerCase().indexOf(this.filterText.toLowerCase())>-1;this.own(m(this,"viewModel",((e,i)=>{e&&!e.filterFunction&&(this.filterFunction=t),i&&i!==e&&i.filterFunction===t&&(i.filterFunction=null)})))}destroy(){this._iconIntersectionObserver&&(this._iconIntersectionObserver.disconnect(),this._iconIntersectionObserver=null)}castVisibleElements(t){return{...pi,...t}}select(t){return null}render(){const{filterText:t,headingLevel:e,messages:i,viewModel:{items:s,selectedItem:n,state:r}}=this,a=this.visibleElements.filter;return w("div",{class:this.classes("esri-feature-templates","esri-widget"),"aria-label":i.widgetLabel},"loading"===r?this.renderLoader():"ready"===r?w(hi,{id:this.id,identify:di,filterText:t,items:s,headingLevel:e,messages:{filterPlaceholder:i.filterPlaceholder,noItems:i.noItems,noMatches:i.noMatches},filterEnabled:a,onItemSelect:t=>{this.viewModel.select(t)},onFilterChange:t=>{this.filterText=t,this.viewModel.refresh()},renderIcon:this.renderItemIcon,selectedItem:n}):null)}renderItemIcon({item:t}){return w("span",{key:"icon",class:"esri-feature-templates__list-item-icon",afterCreate:this._afterItemCreateOrUpdate,afterUpdate:this._afterItemCreateOrUpdate,afterRemoved:this._afterItemRemoved,"data-item":t,"data-has-icon":!1})}renderLoader(){return w("div",{class:"esri-feature-templates__loader",key:"loader"})}_afterItemCreateOrUpdate(t){this._iconIntersectionObserver.observe(t)}_afterItemRemoved(t){this._iconIntersectionObserver.unobserve(t)}};s([c("viewModel.filterFunction")],fi.prototype,"filterFunction",void 0),s([n()],fi.prototype,"filterText",void 0),s([c("viewModel.groupBy")],fi.prototype,"groupBy",void 0),s([n()],fi.prototype,"headingLevel",void 0),s([n({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],fi.prototype,"label",void 0),s([c("viewModel.layers")],fi.prototype,"layers",void 0),s([n(),g("esri/widgets/FeatureTemplates/t9n/FeatureTemplates")],fi.prototype,"messages",void 0),s([c("viewModel.selectedItem")],fi.prototype,"selectedItem",void 0),s([n(),Mt("select")],fi.prototype,"viewModel",void 0),s([n()],fi.prototype,"visibleElements",void 0),s([h("visibleElements")],fi.prototype,"castVisibleElements",null),s([c("viewModel.select")],fi.prototype,"select",null),fi=s([r("esri.widgets.FeatureTemplates")],fi);const mi=fi;let vi=class extends a{constructor(t){super(t),this.creationInfo=null,this.viewModel=null}};s([n()],vi.prototype,"creationInfo",void 0),s([n()],vi.prototype,"viewModel",void 0),vi=s([r("esri.widgets.Editor.BatchCreateWorkflowData")],vi);let gi=class extends(rt(v.EventedAccessor)){constructor(t){super(t),this._indexHistory=[],this._lastStepIndex=-1,this._stepIndex=-1,this._handleKeys={afterCommit:"after-commit",beforeCommit:"before-commit"},this.data=void 0,this.started=!1,this.steps=[],this.type=null}get hasNextStep(){const{steps:t}=this;return!!(t&&this._stepIndex<t.filter((t=>!t.parent)).length-1)}get hasPreviousStep(){return this._stepIndex>0}get stepId(){const{steps:t}=this,e=t&&t[this._stepIndex];return e&&e.id}async cancel(t={force:!0}){return!1!==t.force?this._cancel():new Promise(((t,e)=>{this.emit("cancel-request",{controller:{allow:()=>{this._cancel().then(t)},deny:()=>e(new I("workflow:cancel-denied","Request to cancel workflow was denied."))}})}))}async commit(){this.handles.remove(this._handleKeys.beforeCommit),await this.onCommit(this.data),this.handles.remove(this._handleKeys.afterCommit),this.emit("commit"),this.started&&await this.reset()}async go(t){const{steps:e}=this,i=e.findIndex((e=>e.id===t));this._indexHistory.push(this._stepIndex),await this._go(i)}async next(){this._indexHistory.push(this._stepIndex),await this._go(this._stepIndex+1)}async previous(t={cancelCurrentStep:!1}){await this._go(this._indexHistory.pop(),t.cancelCurrentStep)}async reset(){await this._cancel(!1),await this.start()}async start(){this._set("started",!0);const t=-1===this._stepIndex?0:this._stepIndex;await this._go(t)}async _cancel(t=!0){this.started&&(this._set("started",!1),await this.steps[this._stepIndex].tearDown({cancelled:!0}),this.data&&this.data.viewModel.sketchViewModel.layer.removeAll()),this.handles.remove([this._handleKeys.afterCommit,this._handleKeys.beforeCommit]),this._resetIndexing(t),t&&this.emit("cancel")}async _go(t=-1,e=!1){if(!(t<=-1||t>=this.steps.length)){if(!this.started)return this._stepIndex=t,void this._notifyStepProps();this._lastStepIndex>-1&&await this.steps[this._lastStepIndex].tearDown({cancelled:e}),await this.steps[t].setUp(),this._lastStepIndex=t,this._stepIndex=t,this._notifyStepProps()}}_resetIndexing(t=!0){this._stepIndex=-1,this._lastStepIndex=-1,this._indexHistory.length=0,t&&this._notifyStepProps()}_notifyStepProps(){this.notifyChange("stepId"),this.notifyChange("hasPreviousStep"),this.notifyChange("hasNextStep")}};s([n()],gi.prototype,"data",void 0),s([n()],gi.prototype,"hasNextStep",null),s([n()],gi.prototype,"hasPreviousStep",null),s([n()],gi.prototype,"onCommit",void 0),s([n()],gi.prototype,"started",void 0),s([n({readOnly:!0})],gi.prototype,"stepId",null),s([n()],gi.prototype,"steps",void 0),s([n({readOnly:!0})],gi.prototype,"type",void 0),s([n()],gi.prototype,"commit",null),gi=s([r("esri.widgets.Editor.Workflow")],gi);const yi=gi;let wi=class extends v.EventedAccessor{constructor(t){super(t),this.tracking=!1,this.displaying=!1,this.isDraped=!1}};function bi(t){const e=t.sourceLayer;if("feature"!==e.type||!function(t){switch(t.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":return!0;default:return!1}}(e.renderer))return{rotation:null,size:null};let i=null,s=null;const n=e.renderer.getVisualVariablesForType("rotation").filter((e=>(!e.axis||"heading"===e.axis)&&e.field&&!e.valueExpression&&F(Gt(e,t))));1===n.length&&(i=function(t,e){const i="heading"===(t.axis||"heading")&&"arithmetic"===t.rotationType?-1:1,s=t.field,n=e.fields&&e.fields.filter((t=>t.name===s)),r=n&&1===n.length?n[0].type:"double",a={initial:0,current:0};return{field:s,getDefault:()=>Promise.resolve(0),getValue:t=>(a.current=a.initial-i*t,_i((a.current+360)%360,r)),initValue:t=>{a.initial=null!=t?t:a.current,a.current=0},isUpdatingInteractively:!1}}(n[0],e));const r=e.renderer.getVisualVariablesForType("size").filter((e=>e.field&&!e.useSymbolValue&&!e.valueExpression&&"real-world-size"===Rt(e)&&F(Ht(e,t))));return 1===r.length&&(s=function(t,e){const i=t.field,s=t.axis,n=e.fields&&e.fields.filter((t=>t.name===i)),r=n&&1===n.length?n[0].type:"double",a={updating:!1,initial:0,current:0},o=Nt[t.valueUnit];let l;return l="area"===t.valueRepresentation?t=>(t*o/2)**2*Math.PI:"radius"===t.valueRepresentation||"distance"===t.valueRepresentation?t=>t*o/2:t=>t*o,{field:i,getDefault:async(t,e)=>_i(l(await async function(t,e,i){if(C(e))return 0;const{symbol:s}=qt(e);if(C(s)||"web-style"===s.type||"cim"===s.type)return 0;const n=s.symbolLayers.getItemAt(0);if(!n)return 0;switch(n.type){case"icon":{const{computeIconLayerResourceSize:t}=await import("./p-9d7c7db3.js");return n.size||Math.min(Fi.icon,(await t(n,Fi.icon))[0])||Fi.icon}case"text":return n.size||Fi.text;case"line":return n.size||Fi.line;case"object":{const{computeObjectLayerResourceSize:e}=await import("./p-9d7c7db3.js");return function(t,e){switch(e){case"width":return t[0];case"depth":return t[1];case"height":return t[2];default:return t[2]||t[1]||t[0]}}(await e(n,t.scale/Fi.viewScaleSizeFactor),i)}case"path":return(null!=n.width?n.width:n.height)||t.scale/Fi.viewScaleSizeFactor;case"extrude":return n.size||t.scale/Fi.viewScaleSizeFactor;default:return 0}}(e,t,s)),r),getValue:(t,e)=>(a.initial||(a.initial=e.pixelSizeAt(e.center)),a.current=a.initial*t,_i(a.current,r)),initValue:t=>{a.initial=null!=t?t:a.current,a.current=0},isUpdatingInteractively:!1}}(r[0],e)),{rotation:i,size:s}}function _i(t,e){switch(e){case"small-integer":case"integer":case"long":return Math.round(t);case"double":case"single":return t;default:return 0}}async function ki(t){const e=await pt(t,{useSourceLayer:!0,ignoreGraphicSymbol:!0}),i=At(t.symbol,e);F(i)&&(t.symbol=e)}async function xi(t,e){const i=e.layer,s={...e.template.prototype.attributes};await async function(t,e,i){var s;if("3d"!==t.view.type)return;const n=new _t({sourceLayer:e,attributes:i}),{rotation:r,size:a}=bi(n);let o=await pt(n,{useSourceLayer:!0}),l=!1;for(const e of[a,r])C(e)||null==i[e.field]&&(i[e.field]=await e.getDefault(o,t.view),l=!0);switch(l&&(o=await pt(n,{useSourceLayer:!0})),null==(s=o)?void 0:s.type){case"simple-fill":case"polygon-3d":t.polygonSymbol=o;break;case"simple-line":case"line-3d":t.polylineSymbol=o;break;case"simple-marker":case"point-3d":t.pointSymbol=o}}(t,i,s);const n={graphicProperties:{attributes:s,sourceLayer:i},hasZ:i.capabilities.data.supportsZ};return t.layer.elevationInfo=i.elevationInfo,t.create(function(t){if("mesh"===t||"multipatch"===t)throw new Error("Mesh and Multipatch not supported");return t}(i.geometryType),n)}function Si(t,e){return t&&t.find((t=>t.layer===e))}async function Ii(t,e,i,s){switch(e.type){case"3d":return async function(t,e,i,s){if(0===t.length)return[];const{updatable:n,graphicsByLayer:r}=await i.async((async()=>{const{results:n}=await O($t(e,i),s),r=new Map;n.forEach((({graphic:t})=>(({layer:t})=>{const e=r.get(t);if(!e){const e=new Array;return r.set(t,e),e}return e})(t).push(t)));const a=t.filter((({supports:t,layer:e})=>t.indexOf("update")>-1&&r.has(e)));return 0!==a.length&&i.stopPropagation(),{updatable:a,graphicsByLayer:r}}));return O(T(n.map((async({layer:t})=>{const{objectIdField:e,displayField:i}=t,n=[e];t.fieldsIndex.has(i)&&n.push(i);const a=r.get(t);if(a.some((t=>n.some((e=>!(e in t.attributes)))))){const e=t.createQuery();return e.outFields=n,e.returnGeometry=!1,e.objectIds=a.map((t=>t.getObjectId())),t.queryFeatures(e,{signal:s}).then((({features:t})=>t))}return a}))),s)}(t,e,i,s);case"2d":return async function(t,e,i,s){if(0===t.length)return[];const n=await i.async((async()=>{const{results:n}=await O(e.hitTest(i),s);if(0===n.length)return[];const r=new Set;n.forEach((({graphic:t})=>r.add(t.layer)));const a=t.items.filter((({layer:t,supports:e})=>e.indexOf("update")>-1&&r.has(t)));return a.length>0&&i.stopPropagation(),a}));return O(T(n.map((({layer:t})=>{const{objectIdField:n,displayField:r}=t,a=[n];t.fieldsIndex.has(r)&&a.push(r);const o=t.createQuery();o.outFields=a,o.returnGeometry=!1;const l="renderer"in t?Ut({renderer:t.renderer,event:i}):0;return o.geometry=Dt(i.mapPoint,l,e),o.outSpatialReference=e.spatialReference,t.queryFeatures(o,{signal:s}).then((({features:t})=>t))}))),s)}(t,e,i,s)}}async function Ei(t,e,i,s){let n=!1;const{rotation:r,size:a}=s;[r,a].forEach((async i=>{if(C(i))return;const s=e.attributes[i.field];if(F(s))i.initValue(s);else{const s=await i.getDefault(e.symbol,t.view);i.initValue(s),e.setAttribute(i.field,s),n=!0}})),n&&"3d"===t.view.type&&await ki(e);const o={multipleSelectionEnabled:!1};return"point"===i.geometryType&&(o.enableRotation=F(r),o.enableScaling=F(a)),t.layer.elevationInfo=i.elevationInfo,t.update(e,o)}async function Mi(t,e,i,s){var n;if(!F(e.geometry)||"point"!==(null==(n=e.geometry)?void 0:n.type))return;const r=s.rotation,a=function(t){return!t||"rotate-start"!==t.type&&"rotate"!==t.type&&"rotate-stop"!==t.type?null:t}(i.toolEventInfo);if(F(r)&&F(a))if("rotate-stop"===a.type)r.isUpdatingInteractively=!1,r.initValue();else{r.isUpdatingInteractively=!0;const{field:i,getValue:s}=r;e.attributes[i]=s(a.angle,t)}const o=s.size,l=function(t){return!t||"scale-start"!==t.type&&"scale"!==t.type&&"scale-stop"!==t.type?null:t}(i.toolEventInfo);if(F(o)&&F(l))if("scale-stop"===l.type)o.isUpdatingInteractively=!1,o.initValue();else{o.isUpdatingInteractively=!0;const{field:i,getValue:s}=o;e.attributes[i]=s(l.xScale,t)}"3d"===t.type&&await ki(e)}s([n({constructOnly:!0})],wi.prototype,"graphic",void 0),s([n()],wi.prototype,"tracking",void 0),s([n()],wi.prototype,"displaying",void 0),s([n()],wi.prototype,"isDraped",void 0),wi=s([r("esri.views.3d.layers.graphics.GraphicState")],wi);const Fi={icon:Vt(24),text:Vt(12),line:Vt(1),viewScaleSizeFactor:100};function Ci(t,e,i){let s=!1;return t.filter((t=>!!s||(s=t===e,s))).map((t=>i[t]()))}function Oi(t,e){if(t.viewModel.refreshCreationTemplates(),"awaiting-feature-creation-info"===e[0].id){const i=function(t){if(1!==t.length)return null;const e=t[0];if("items"in e){const t=e;return 1===t.items.length?t.items[0]:null}return e}(t.viewModel.featureTemplatesViewModel.items);F(i)&&(t.creationInfo={layer:i.layer,template:i.template},e.shift())}return e}var Ti;let ji=Ti=class extends yi{constructor(t){super(t),this.type="batch-create",this.createFeatureState="create-new",this.featureFormHandle=null,this.visualVariableAttributes={rotation:null,size:null},this.highlightHandles=new Map,this.preventDefaultActionOnCancel=!1}get numPendingFeatures(){return this.data.viewModel.sketchViewModel.layer.graphics.length}get pendingFeatures(){return this.data.viewModel.sketchViewModel.layer.graphics}async updatePendingFeature(t){return this.preventDefaultActionOnCancel=!0,this.data.viewModel.sketchViewModel.cancel(),j(this.lastActiveGraphics,t),this.startUpdating(t)}static create(t,e,i,s){const n=new Ti({data:new vi({creationInfo:e,viewModel:t}),onCommit:async t=>{await s(t.creationInfo.layer,{addFeatures:t.viewModel.sketchViewModel.layer.graphics.toArray()})}});return n._set("steps",this._createWorkflowSteps(n,i)),n}highlight(t){const e=this.data.viewModel.view;"3d"===e.type&&this.highlightHandles.set(t,e.highlight(t))}removeHighlight(t){E(this.highlightHandles.get(t)),this.highlightHandles.delete(t)}async startCreating(){return this.createFeatureState="create-new",xi(this.data.viewModel.sketchViewModel,this.data.creationInfo)}async startUpdating(t){var e;const i=this.data.viewModel,s=i.sketchViewModel,n=this.data.creationInfo.layer;return i.featureFormViewModel.set({feature:t,fieldConfig:null==(e=Si(i.layerInfos,n))?void 0:e.fieldConfig}),E(this.featureFormHandle),this.featureFormHandle=i.featureFormViewModel.on("value-change",(async()=>{t.attributes=i.featureFormViewModel.getValues(),"3d"===s.view.type&&await ki(t)})),this.removeHighlight(t),this.createFeatureState="update-pending",this.visualVariableAttributes=bi(t),Ei(s,t,n,this.visualVariableAttributes)}static _createWorkflowSteps(t,e="awaiting-feature-creation-info"){const{data:i,handles:s}=t;let n=null,r=!0;const a=Ci(["awaiting-feature-creation-info","batch-creating-features"],e,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){i.creationInfo=null,s.add(i.viewModel.featureTemplatesViewModel.on("select",(({item:t})=>{i.creationInfo={layer:t.layer,template:t.template},i.viewModel.activeWorkflow.next()})),this.id)},async tearDown(){s.remove(this.id)}}),"batch-creating-features":()=>({id:"batch-creating-features",async setUp(){const e=i.viewModel.view,a=i.viewModel.sketchViewModel;r=a.updateOnGraphicClick,a.updateOnGraphicClick=!1,t.lastActiveGraphics=[],t.featureFormHandle=E(t.featureFormHandle),t.visualVariableAttributes={rotation:null,size:null};const o=a.on("create",(async e=>{if("cancel"===e.state){if(t.preventDefaultActionOnCancel)return void(t.preventDefaultActionOnCancel=!1);if(t.lastActiveGraphics.length<1)return t.startCreating();const e=t.lastActiveGraphics.pop();return t.startUpdating(e)}if("complete"===e.state)return t.startUpdating(e.graphic)})),l=a.on("update",(async s=>{const r=s.graphics[0];if("complete"===s.state)return r!==n&&(t.lastActiveGraphics.push(r),t.highlight(r)),n=null,s.aborted&&t.preventDefaultActionOnCancel?void(t.preventDefaultActionOnCancel=!1):t.startCreating();"start"===s.state&&t.removeHighlight(r),await Mi(e,r,s,t.visualVariableAttributes);const a=r.attributes;if(F(t.visualVariableAttributes.rotation)){const{field:e}=t.visualVariableAttributes.rotation;i.viewModel.featureFormViewModel.setValue(e,a[e])}if(F(t.visualVariableAttributes.size)){const{field:e}=t.visualVariableAttributes.size;i.viewModel.featureFormViewModel.setValue(e,a[e])}})),h=a.on("delete",(async e=>{const i=e.graphics[0];j(t.lastActiveGraphics,i),n=i}));let c=null;const u=Tt((()=>{var t;const e=a.snappingOptions.featureSources.find((t=>t.layer===i.creationInfo.layer));return{hasFeatureLayerSource:!!e,enabled:null!=(t=null==e?void 0:e.enabled)&&t}}),(({hasFeatureLayerSource:t,enabled:e})=>{const i=a.snappingOptions.featureSources;t?(C(c)&&(c=new Ee({layer:a.layer,enabled:e}),i.add(c)),c.enabled=e):(F(c)&&i.remove(c),c=W(c))}),jt),d=e.on("immediate-click",(async i=>{const s=await e.hitTest(i,{include:a.layer});if(s.results.length>0){const e=s.results[0].graphic;if("transform"===a.activeTool||"reshape"===a.activeTool){if(a.updateGraphics.getItemAt(0)===e)return;await t.updatePendingFeature(e)}}}));await t.startCreating(),s.add({remove:()=>{E(t.featureFormHandle),o.remove(),l.remove(),h.remove(),u.remove(),F(c)&&a.snappingOptions.featureSources.remove(c),c=W(c),a.cancel(),d.remove()}},this.id)},async tearDown(t){t.cancelled&&i.viewModel.sketchViewModel.layer.removeAll(),s.remove(this.id),i.viewModel.sketchViewModel.updateOnGraphicClick=r}})});return Oi(i,a)}};ji=Ti=s([r("esri.widgets.Editor.BatchCreateWorkflow")],ji);const Wi=ji;let Vi=class extends a{constructor(t){super(t),this.creationInfo=null,this.edits=null,this.viewModel=null}};s([n()],Vi.prototype,"creationInfo",void 0),s([n()],Vi.prototype,"edits",void 0),s([n()],Vi.prototype,"viewModel",void 0),Vi=s([r("esri.widgets.Editor.CreateWorkflowData")],Vi);const Pi=Vi;function Li(t){return C(t)?null:JSON.stringify(t)}let Ai=class extends(rt(a)){constructor(t){super(t),this._baselineAttributesJSON=null,this._baselineGeometryJSON=null,this.feature=null}get attributesModified(){const{_baselineAttributesJSON:t,feature:e}=this;return!(!e||t===Li(e.attributes))}get geometryModified(){const{_baselineGeometryJSON:t,feature:e}=this;return!(!e||t===Li(e.geometry))}get modified(){return this.attributesModified||this.geometryModified}trackChanges(){this.feature&&(this._baselineAttributesJSON=Li(this.feature.attributes),this._baselineGeometryJSON=Li(this.feature.geometry),this.notifyChange("attributesModified"),this.notifyChange("geometryModified"))}updateAttributes(t){this.feature.attributes=t,this.notifyChange("attributesModified")}updateGeometry(t){this.feature.geometry=t,this.notifyChange("geometryModified")}};var Ui;s([n()],Ai.prototype,"attributesModified",null),s([n()],Ai.prototype,"feature",void 0),s([n()],Ai.prototype,"geometryModified",null),s([n()],Ai.prototype,"modified",null),Ai=s([r("esri.widgets.Editor.Edits")],Ai);let Di=Ui=class extends yi{constructor(t){super(t),this.type="create"}static create(t,e,i){const s=new Ui({data:new Pi({edits:new Ai,viewModel:t}),onCommit:async t=>{await i(t.creationInfo.layer,{addFeatures:[t.edits.feature]})}});return s._set("steps",this._createWorkflowSteps(s,e)),s}static _createWorkflowSteps(t,e="awaiting-feature-creation-info"){const{data:i,handles:s}=t,n=Ci(["awaiting-feature-creation-info","awaiting-feature-to-create","editing-new-feature"],e,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){i.creationInfo=null,i.edits.feature=null,i.viewModel.featureTemplatesViewModel.select(null),s.add(i.viewModel.featureTemplatesViewModel.on("select",(({item:t})=>{i.creationInfo={layer:t.layer,template:t.template},i.viewModel.activeWorkflow.next()})),this.id)},async tearDown(){s.remove(this.id)}}),"awaiting-feature-to-create":()=>({id:"awaiting-feature-to-create",async setUp(){s.add(await async function(t,e){await xi(t,e);const s=t.on("create",(async s=>{if("cancel"===s.state)return xi(t,e);if("complete"===s.state){const t=s.graphic;t.sourceLayer||(t.sourceLayer=e.layer),t.attributes||(t.attributes={...e.template.prototype.attributes}),await ki(t),(t=>{i.edits.feature=t,i.viewModel.activeWorkflow.next()})(t)}}));return{remove:()=>{s.remove(),t.cancel()}}}(i.viewModel.sketchViewModel,i.creationInfo),this.id)},async tearDown(){s.remove(this.id)}}),"editing-new-feature":()=>({id:"editing-new-feature",async setUp(){var t;const e=i.edits.feature,n=e.sourceLayer,r=i.viewModel,a=r.sketchViewModel;r.featureFormViewModel.set({feature:e,fieldConfig:null==(t=Si(r.layerInfos,n))?void 0:t.fieldConfig}),a.allowDeleteKey=!1;const o=bi(e);await Ei(a,e,n,o);const l=a.on("update",(async t=>{const e=t.graphics[0];if("complete"===t.state)return Ei(a,e,n,o);await Mi(a.view,e,t,o);const i=e.attributes;if(F(o.rotation)){const{field:t}=o.rotation;r.featureFormViewModel.setValue(t,i[t])}if(F(o.size)){const{field:t}=o.size;r.featureFormViewModel.setValue(t,i[t])}}));s.add([i.viewModel.featureFormViewModel.on("value-change",(async()=>{i.edits.updateAttributes(i.viewModel.featureFormViewModel.getValues()),e.attributes=i.edits.feature.attributes,"3d"===a.view.type&&await ki(e)})),l],this.id)},async tearDown(t){t.cancelled&&i.viewModel.sketchViewModel.layer.removeAll(),s.remove(this.id)}})});return Oi(i,n)}};Di=Ui=s([r("esri.widgets.Editor.CreateWorkflow")],Di);const Ni=Di;let Ri=class extends a{constructor(t){super(t),this.candidates=null,this.editableItem=null,this.edits=null,this.viewModel=null}};s([n()],Ri.prototype,"candidates",void 0),s([n()],Ri.prototype,"editableItem",void 0),s([n()],Ri.prototype,"edits",void 0),s([n()],Ri.prototype,"viewModel",void 0),Ri=s([r("esri.widgets.Editor.UpdateWorkflowData")],Ri);const Gi=Ri;var Hi;const qi="candidate-highlight";let $i=Hi=class extends yi{constructor(t){super(t),this.type="update"}static create(t,e,i){const s=new Hi({data:new Gi({edits:new Ai,viewModel:t}),onCommit:async t=>{const e=t.edits.feature,s=e.sourceLayer,n=e.clone();if(!t.edits.attributesModified){const{objectIdField:t}=s;n.attributes={[t]:e.getAttribute(t)}}t.edits.geometryModified||(n.geometry=null),await i(s,{updateFeatures:[n]})}});return s._set("steps",this._createWorkflowSteps(s,e)),s}highlight(t){const{data:{viewModel:{view:e}}}=this,i=t&&e.allLayerViews.items.find((({layer:e})=>e===t.layer));zt(i)&&this.handles.add(i.highlight(t),qi)}unhighlight(){this.handles.remove(qi)}static _createWorkflowSteps(t,e="awaiting-feature-to-update"){const{data:i,handles:s}=t;return Ci(["awaiting-feature-to-update","awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"],e,{"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",async setUp(){const{spinnerViewModel:t,view:e}=i.viewModel;let n=null;s.add({remove(){n&&(n.abort(),n=null)}},this.id),i.edits.feature=null;const r=e.on("immediate-click",(s=>{t.location=s.mapPoint,t.visible=!0,n&&n.abort();const{editableItems:r}=i.viewModel;n=new AbortController,new Promise(((t,i)=>{V(n.signal,(()=>i(P()))),t(Ii(r,e,s,n.signal))})).then((t=>{L(n),i.candidates=t.reduce(((t,e)=>e.error?t:[...t,...e.value]),[]),i.viewModel.spinnerViewModel.visible=1===i.candidates.length,0!==i.candidates.length&&(1===i.candidates.length?(i.edits.feature=i.candidates[0],i.viewModel.activeWorkflow.go("editing-existing-feature").catch((()=>{})).then((()=>i.viewModel.spinnerViewModel.visible=!1))):i.viewModel.activeWorkflow.next())}))}));s.add(r,this.id)},async tearDown(){s.remove(this.id)}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",async setUp(){const{edits:e}=i;e.feature=null,s.add(A(e,"feature",(e=>{t.unhighlight(),t.highlight(e)})),this.id)},async tearDown(){t.unhighlight(),s.remove(this.id)}}),"editing-existing-feature":()=>({id:"editing-existing-feature",async setUp(){const e=i.edits.feature,n=i.viewModel;i.editableItem=n.editableItems.find((t=>t.layer===e.layer));const r=new AbortController;s.add({remove:()=>r.abort()},this.id);const a=n.view.whenLayerView(e.layer),o=async function(t,e,i){const s=t.layer,n=s.createQuery();return n.objectIds=[t.getAttribute(s.objectIdField)],n.outFields=["*"],n.outSpatialReference=e.spatialReference,n.returnM=s.capabilities.data.supportsM,n.returnZ=s.capabilities.data.supportsZ,(await s.queryFeatures(n,{signal:i})).features[0]}(e,n.view,r.signal),l=await a,h=await o;if(U(r))return;i.edits.updateGeometry(h.geometry),i.edits.updateAttributes(h.attributes),i.edits.trackChanges();const c=h.sourceLayer,u=Si(n.layerInfos,c),d=u&&u.fieldConfig;n.attachmentsViewModel.set({graphic:h,mode:"view"}),n.featureFormViewModel.set({feature:h,fieldConfig:d});const p="createInteractiveEditSession"in l?l.createInteractiveEditSession(e):null,f=[n.featureFormViewModel.on("value-change",(t=>{i.edits.updateAttributes(n.featureFormViewModel.getValues()),h.attributes=i.edits.feature.attributes,p&&p.setAttribute(t.fieldName,t.value)})),n.attachmentsViewModel.watch("mode",(t=>{"add"===t&&i.viewModel.activeWorkflow.go("adding-attachment"),"edit"===t&&i.viewModel.activeWorkflow.go("editing-attachment")}))];p&&(f.push(D((()=>p.rollback()))),s.add(D((()=>p.commit())),t._handleKeys.afterCommit));const{supportsGeometryUpdate:v}=c.capabilities.editing;if(v){n.sketchViewModel.allowDeleteKey=!1;const e=bi(h),{interactive:r,visual:a}=await async function(t,e,i,s,n){const r=t.clone();await ki(r),s.map.add(i.layer),i.layer.add(r);const a=t.sourceLayer,o=s.whenLayerView(a),l=()=>{const e=t.attributes[t.layer.objectIdField];return o.then((t=>t.setVisibility(e,!1)),(()=>{})),{remove(){o.then((t=>t.setVisibility(e,!0)),(()=>{}))}}};let h=null,c=null;if("3d"===s.type){const t=new wi({graphic:r});h=s.trackGraphicState(t),m(t,"displaying",(t=>{c=t?l():E(c)}))}else c=l();await Ei(i,r,a,e);let u=null;o.then((t=>u=t),(()=>{}));const d=e.size,p=e.rotation,f=t.watch("attributes",(async t=>{let e=!1;for(const i in t){const s=t[i];s!==r.attributes[i]&&(r.setAttribute(i,s),F(d)&&!d.isUpdatingInteractively&&d.field===i&&d.initValue(s),F(p)&&!p.isUpdatingInteractively&&p.field===i&&p.initValue(s),(C(u)||u.requiredFields.includes(i))&&(e=!0))}e&&"3d"===s.type&&await ki(r)})),v=i.on("update",(async t=>{const r=t.graphics[0];if("complete"===t.state)return Ei(i,r,a,e);await Mi(s,r,t,e),n(r.clone())})),g=i.on(["undo","redo"],(async t=>{n(t.graphics[0].clone())})),y=()=>{};return{interactive:{remove(){g.remove(),v.remove(),i.cancel(),f&&f.remove(),this.remove=y}},visual:{remove(){E(c),s.whenLayerView(a).then((t=>M(t,"updating"))).then((()=>{E(h),i.layer.remove(r),this.remove=y}))}}}}(h,e,n.sketchViewModel,n.view,(({geometry:t,attributes:s})=>{if(F(e.rotation)){const{field:t}=e.rotation;n.featureFormViewModel.setValue(t,s[t])}if(F(e.size)){const{field:t}=e.size;n.featureFormViewModel.setValue(t,s[t])}i.edits.updateAttributes(s),i.edits.updateGeometry(t)}));f.push(r,a),s.add(r,t._handleKeys.beforeCommit),s.add(a,t._handleKeys.afterCommit)}else t.highlight(h);s.add(f,this.id)},async tearDown(){t.unhighlight(),s.remove(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){}})})}};$i=Hi=s([r("esri.widgets.Editor.UpdateWorkflow")],$i);const zi=$i;function Bi(t){switch(t){case 0:break;case 1:return"not owned by a graphics layer";case 2:return"no geometry";case 3:return"the geometry type is not supported";case 4:return"the elevation mode is not supported";case 5:return"the symbol type is not supported"}return""}function Zi(t,e){return C(e)||!e.mode?t?"absolute-height":"on-the-ground":e.mode}function Ki(t,e){return Zi(!!F(t)&&t.hasZ,e)}function Ji(t){const e=Yi(t);return Ki(t.geometry,e)}function Qi(t){const e=Yi(t),i=Ki(t.geometry,e);return{mode:i,offset:F(e)&&"on-the-ground"!==i?N(e.offset,0)*ie(N(e.unit,"meters")):0}}function Xi(t){if("on-the-ground"===Ji(t))return!1;const e=Yi(t),i=F(e)&&e.featureExpressionInfo?e.featureExpressionInfo.expression:null;return!(!i||"0"===i)}function Yi(t){return t.layer&&"elevationInfo"in t.layer?t.layer.elevationInfo:null}function ts(t,e,i){if(C(i)||!i.mode)return;const s=t.hasZ?t.z:0,n=F(i.offset)?i.offset:0;switch(i.mode){case"absolute-height":return s-n;case"on-the-ground":return 0;case"relative-to-ground":return s-(N(e.elevationProvider.getElevation(t.x,t.y,t.z,t.spatialReference,"ground"),0)+n);case"relative-to-scene":return s-(N(e.elevationProvider.getElevation(t.x,t.y,t.z,t.spatialReference,"scene"),0)+n)}}function es(t,e,i,s=null){return ss(t,e.x,e.y,e.hasZ?e.z:0,e.spatialReference,i,s)}function is(t,e,i,s,n=null){return ss(t,e[0],e[1],e.length>2?e[2]:0,i,s,n)}function ss(t,e,i,s,n,r,a=null){if(C(r))return;const o=F(a)?a.mode:"absolute-height";return"on-the-ground"===o?0:function(t,e,i,s,n,r,a,o){const l=F(a)&&F(a.offset)?a.offset:0;switch(o){case"absolute-height":return t-l;case"relative-to-ground":return t-(N(r.elevationProvider.getElevation(e,i,s,n,"ground"),0)+l);case"relative-to-scene":return t-(N(r.elevationProvider.getElevation(e,i,s,n,"scene"),0)+l)}}(function(t,e,i,s,n,r){const a=F(r.offset)?r.offset:0;switch(r.mode){case"absolute-height":return i+a;case"on-the-ground":return N(n.elevationProvider.getElevation(t,e,0,s,"ground"),0);case"relative-to-ground":return i+N(n.elevationProvider.getElevation(t,e,i,s,"ground"),0)+a;case"relative-to-scene":return i+N(n.elevationProvider.getElevation(t,e,i,s,"scene"),0)+a}}(e,i,s,n,t,r),e,i,s,n,t,a,o)}function ns(t){var e;if("graphics"!==(null==(e=t.layer)?void 0:e.type))return 1;if(C(t.geometry))return 2;switch(t.geometry.type){case"polygon":case"point":case"polyline":case"mesh":break;default:return 3}return"on-the-ground"!==Ji(t)&&Xi(t)?4:0}var rs;let as=rs=class extends te{constructor(...t){super(...t),this.center=null,this.geodesic=!1,this.numberOfPoints=60,this.radius=1e3,this.radiusUnit="meters"}normalizeCtorArgs(t,e){let i;if(t&&t.center)i=t;else{if(t&&t.rings)return super.normalizeCtorArgs(t,e);i={center:t}}return{...super.normalizeCtorArgs(),...i,...e}}initialize(){const t=this.center,e=this.numberOfPoints;if(this.hasZ=t&&t.hasZ,0!==this.rings.length||!t)return;const i=Qt(this.radius,this.radiusUnit,"meters"),s=t.spatialReference;let n,r="geographic";if(s.isWebMercator?r="webMercator":(null!=G[s.wkid]||s.wkt&&0===s.wkt.indexOf("PROJCS"))&&(r="projected"),this.geodesic){let s;switch(r){case"webMercator":s=H(t);break;case"projected":console.error("Creating a geodesic circle requires the center to be specified in web mercator or geographic coordinate system");break;case"geographic":s=t}n=this._createGeodesicCircle(s,i,e),"webMercator"===r&&(n=q(n))}else{let s;"webMercator"===r||"projected"===r?s=i/this._convert2Meters(1,t.spatialReference):"geographic"===r&&(s=Xt(i,"meters",Yt(t.spatialReference).radius)),n=this._createPlanarCircle(t,s,e)}this.spatialReference=n.spatialReference,this.addRing(n.rings[0])}clone(){const{center:t,numberOfPoints:e,radius:i,radiusUnit:s,geodesic:n}=this;return new rs({center:t.clone(),numberOfPoints:e,radius:i,radiusUnit:s,geodesic:n})}_createGeodesicCircle(t,e,i){let s=0;const n=[];for(;s<360;){const r=[0,0];se(r,[t.x,t.y],s,e),this.hasZ&&r.push(t.z),n.push(r),s+=360/i}return n.push(n[0]),new te(n)}_createPlanarCircle(t,e,i){const s=[],n=2*Math.PI/i;for(let r=0;r<i;++r){const i=n*r,a=[t.x+Math.cos(-i)*e,t.y+Math.sin(-i)*e];this.hasZ&&a.push(t.z),s.push(a)}return s.push(s[0]),new te({spatialReference:t.spatialReference,rings:[s]})}_convert2Meters(t,e){let i;if(null!=G[e.wkid])i=G.values[G[e.wkid]];else{const t=e.wkt,s=t.lastIndexOf(",")+1,n=t.lastIndexOf("]]");i=parseFloat(t.substring(s,n))}return t*i}};s([n({type:R})],as.prototype,"center",void 0),s([n()],as.prototype,"geodesic",void 0),s([n()],as.prototype,"numberOfPoints",void 0),s([n()],as.prototype,"radius",void 0),s([n()],as.prototype,"radiusUnit",void 0),as=rs=s([r("esri.geometry.Circle")],as);const os=as;function ls(t){return cs(t).result}function hs(t){return cs(t).geometry}function cs(t){var e;return"graphics"!==(null==(e=t.layer)?void 0:e.type)?{result:1,geometry:null}:C(t.geometry)?{result:2,geometry:null}:"on-the-ground"!==Ji(t)&&Xi(t)?{result:4,geometry:null}:"point"!==t.geometry.type&&"polyline"!==t.geometry.type&&("polygon"!==t.geometry.type||t.geometry instanceof os)?{result:3,geometry:null}:{result:0,geometry:t.geometry}}function us(t,e,i){if(!e||!t||!t.map)return;const{map:s}=t,n=s.layers.find((t=>t===e));n||s.add(e,i),null!=i&&s.layers.reorder(n,i)}const ds={redo:"r",undo:"z",center:"Alt",constraint:"Shift",snappingToggle:"Control",cancel:"Escape",delete:["Backspace","Delete"],complete:"Enter",vertexAdd:"f",pan:" "};function ps(t,e){const i=t.x-e.x,s=t.y-e.y;return i*i+s*s}function fs(t,e){const i=t.length===e.length&&t[0]===e[0]&&t[1]===e[1];switch(t.length){case 2:return i;case 3:return i&&t[2]===e[2];case 4:return i&&t[3]===e[3]}return!1}function ms(t,e,i,s){return"2d"===s.type?s.toScreen(e.vectorToPoint(t,_s)):(vs(t,e,i,s,ws),s.state.camera.projectToScreen(ws,bs),Pt(bs[0],bs[1]))}function vs(t,e,i,s,n=pe()){const r=e.toXYZ(t);return r[2]=is(s,r,e.spatialReference,i)||0,s.renderCoordsHelper.toRenderCoords(r,e.spatialReference,n),n}function gs(t,e,i,s,n,r,a){const o=i.toXYZ(t),l=i.toXYZ(e),h=is(n,o,i.spatialReference,s),c=is(n,l,i.spatialReference,s),u=(null==h?c:null==c?h:Math.min(h,c))||0;o[2]=u,l[2]=u,n.renderCoordsHelper.toRenderCoords(o,i.spatialReference,r),n.renderCoordsHelper.toRenderCoords(l,i.spatialReference,a)}function ys(t,e){e.sort(((e,i)=>ne(e.targetPoint,t)-ne(i.targetPoint,t)))}const ws=pe(),bs=Lt(),_s=new R;class ks{constructor(t){this.coordinateHelper=t}}class xs extends ks{constructor(t,e){super(t),this.point=e}objectEqual(t){return t instanceof xs&&fs(this.point,t.point)}check(t){return ne(t,this.point)<Ce.pointThreshold}closestTo(){return this.coordinateHelper.clone(this.point)}intersect(t){const e=[];return t instanceof Ss?e.push(...ye({start:t.start,end:t.end,type:t instanceof Es?1:0},this.point)):t instanceof Fs&&e.push(...xe(t.center,t.radius,this.point)),e.map((e=>new Ms(this.coordinateHelper,e,this,t)))}}class Ss extends ks{constructor(t,e,i){super(t),this.start=e,this.end=i}objectEqual(t){return t instanceof Ss&&fs(this.start,t.start)&&fs(this.end,t.end)}intersect(t){const e=[];return t instanceof xs?e.push(...ye({start:this.start,end:this.end,type:this instanceof Es?1:0},t.point)):t instanceof Ss?e.push(...we({start:this.start,end:this.end,type:this instanceof Es?1:0},{start:t.start,end:t.end,type:t instanceof Es?1:0})):t instanceof Fs&&e.push(...be({start:this.start,end:this.end,type:this instanceof Es?1:0},t.center,t.radius)),e.map((e=>new Ms(this.coordinateHelper,e,this,t)))}}class Is extends Ss{constructor(t,e,i){super(t,e,i),this.dir=fe(),this.p=fe()}objectEqual(t){return t instanceof Is&&super.objectEqual(t)}check(t){return re(this.dir,this.end,this.start),re(this.p,t,this.start),ae(this.dir,this.p)>=0&&ve(t,this.start,this.end)<Ce.pointOnLineThreshold}closestTo(t){const e=this.coordinateHelper.clone(t);return ge(e,t,this.start,this.end),e}}class Es extends Ss{constructor(t,e,i){super(t,e,i)}objectEqual(t){return t instanceof Es&&super.objectEqual(t)}check(t){return ve(t,this.start,this.end)<Ce.pointOnLineThreshold}closestTo(t){const e=this.coordinateHelper.clone(t);return _e(e,t,this.start,this.end),e}}class Ms extends ks{constructor(t,e,i,s){super(t),this.intersection=e,this.first=i,this.second=s}objectEqual(t){return t instanceof Ms&&this.first.objectEqual(t.first)&&this.second.objectEqual(t.second)}check(){return!1}closestTo(t){const e=this.coordinateHelper.clone(t);return oe(e,this.intersection),e}intersect(){return[]}}class Fs extends ks{constructor(t,e,i){super(t),this.center=e,this.radius=i}objectEqual(t){return t instanceof Fs&&this.center[0]===t.center[0]&&this.center[1]===t.center[1]&&this.radius===t.radius}check(){return!1}closestTo(t){const e=this.coordinateHelper.clone(t);return ke(e,t,this.center,this.radius),e}intersect(t){const e=[];return t instanceof Ss?e.push(...be({start:t.start,end:t.end,type:t instanceof Es?1:0},this.center,this.radius)):t instanceof xs&&e.push(...xe(this.center,this.radius,t.point)),e.map((e=>new Ms(this.coordinateHelper,e,this,t)))}}class Cs{constructor(t,e,i){this.coordinateHelper=t,this.targetPoint=e,this.constraint=i}}class Os extends Cs{constructor({coordinateHelper:t,targetPoint:e,objectId:i,constraint:s}){super(t,e,s),this.objectId=i}}class Ts{}u.getLogger("esri.views.interactive.snapping.hints.LineSnappingHint");class js extends Ts{constructor(t,e,i,s=!0,n=!0){super(),this.type=t,this.lineStart=e,this.lineEnd=i,this.fadeLeft=s,this.fadeRight=n}equals(t){return t instanceof js&&this.type===t.type&&fs(this.lineStart,t.lineStart)&&fs(this.lineEnd,t.lineEnd)&&this.fadeLeft===t.fadeLeft&&this.fadeRight===t.fadeRight}}class Ws extends Os{constructor(t){super({...t,constraint:new Es(t.coordinateHelper,t.edgeStart,t.edgeEnd)})}get hints(){return[new js(1,this.constraint.start,this.constraint.end)]}}u.getLogger("esri.views.interactive.snapping.hints.RightAngleSnappingHint");class Vs extends Ts{constructor(t,e,i){super(),this.previousVertex=t,this.centerVertex=e,this.nextVertex=i}equals(t){return t instanceof Vs&&fs(this.previousVertex,t.previousVertex)&&fs(this.centerVertex,t.centerVertex)&&fs(this.nextVertex,t.nextVertex)}}class Ps extends Cs{constructor({coordinateHelper:t,targetPoint:e,constraint:i,previousVertex:s,otherVertex:n,otherVertexType:r,objectId:a}){super(t,e,i),this.previousVertex=s,this.otherVertex=n,this.otherVertexType=r,this.objectId=a}get hints(){const t=this.previousVertex,e=1===this.otherVertexType?this.otherVertex:this.targetPoint,i=1===this.otherVertexType?this.targetPoint:this.otherVertex;return[new js(0,e,i),new js(1,t,e),new Vs(this.previousVertex,e,i)]}}let Ls=class extends at{constructor(t){super(t),this.sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null}}}get updating(){return $(this.snappingSources,(({snappingSource:t})=>t.updating))||this.updatingHandles.updating}get snappingSources(){var t;const e=this._get("snappingSources")||new Map,i=new Map;if(null!=(t=this.options)&&t.featureSources)for(const t of this.options.featureSources.items){const s=t.layer.uid,n=e.get(s);if(n){e.delete(s),i.set(s,n);continue}if(!t.layer.loaded){this.updatingHandles.addPromise(t.layer.load());continue}const r=this.createSourceInfo(t);F(r)&&i.set(s,r)}for(const[,t]of e)t.destroy();return i}initialize(){this.updatingHandles.add(this,"snappingSources",(()=>{this.notifyChange("updating")}),1),F(this.view)&&this.handles.add([this.view.on("layerview-create",(t=>this.updateLayerView(t.layer,t.layerView))),this.view.on("layerview-destroy",(t=>this.updateLayerView(t.layer,null)))])}updateLayerView(t,e){for(const[,i]of this.snappingSources)i.snappingSource.layerSource.layer===t&&(i.layerView=e)}destroy(){this._set("options",null);for(const[,t]of this.snappingSources)t.destroy()}async fetchCandidates(t,e,i){if(!this.options.effectiveFeatureEnabled)return[];const s=[],n=this.computeScreeenSizeDistanceParameters(t,e),r={distance:n,point:t,coordinateHelper:e.coordinateHelper,types:this.types,filter:null};for(const[,{snappingSource:t,layerView:n}]of this.snappingSources)!t.layerSource.enabled||F(n)&&n.suspended||s.push(t.fetchCandidates(r,i).then((i=>i.filter((i=>!this.candidateIsExcluded(t,i,e.excludeFeature))))));const a=(await z(s)).flat();return this.addRightAngleCandidates(a,t,n,e),L(i),ys(t,a),a}addRightAngleCandidates(t,e,i,s){var n,r,a,o,l,h,c,u;const d=F(s.vertexHandle)?null==(n=s.vertexHandle.rightEdge)||null==(r=n.rightVertex)?void 0:r.pos:F(s.editGeometryOperations)&&"polygon"===s.editGeometryOperations.data.type?null==(a=B(null==(o=s.editGeometryOperations.data.components[0])?void 0:o.getFirstVertex()))?void 0:a.pos:null,p=F(s.vertexHandle)?null==(l=s.vertexHandle.leftEdge)||null==(h=l.leftVertex)?void 0:h.pos:F(s.editGeometryOperations)?null==(c=B(null==(u=s.editGeometryOperations.data.components[0])?void 0:u.getLastVertex()))?void 0:c.pos:null,f=t.length;for(let n=0;n<f;n++)this.addRightAngleCandidate(t[n],p,e,i,s,t),this.addRightAngleCandidate(t[n],d,e,i,s,t)}addRightAngleCandidate(t,e,i,s,n,r){if(C(e)||!(t instanceof Ws))return;const a=t.constraint.closestTo(e),o=(a[0]-i[0])/s.x,l=(a[1]-i[1])/s.y;if(o*o+l*l<=1){const i=n.coordinateHelper;r.push(new Ps({coordinateHelper:i,targetPoint:a,otherVertex:e,otherVertexType:0,previousVertex:t.constraint.start,constraint:new Is(i,e,a),objectId:t.objectId}))}}computeScreeenSizeDistanceParameters(t,e){const i=this.options.distance*("touch"===e.pointer?this.options.touchSensitivityMultiplier:1);return C(this.view)?{x:i,y:i}:"2d"===this.view.type?{x:i*this.view.resolution,y:i*this.view.resolution}:this.computeScreeenSizeDistanceParameters3D(t,i,this.view,e)}computeScreeenSizeDistanceParameters3D(t,e,i,s){const{coordinateHelper:n,elevationInfo:r}=s,a=i.state.camera.computeScreenPixelSizeAt(vs(t,n,r,i,Us))*i.renderCoordsHelper.unitInMeters/i.mapCoordsHelper.unitInMeters,o=e*a;return{x:o/this.computeScreenMagnitudeOfMapOffset(t,a,0,i,s),y:o/this.computeScreenMagnitudeOfMapOffset(t,0,a,i,s)}}computeScreenMagnitudeOfMapOffset(t,e,i,s,{coordinateHelper:n,elevationInfo:r}){const a=n.clone(t);a[0]+=e,a[1]+=i;const o=ms(t,n,r,s),l=ms(a,n,r,s),h=l.x-o.x,c=l.y-o.y;return Math.sqrt(h*h+c*c)}get types(){return 3}candidateIsExcluded(t,e,i){if(C(i))return!1;const s=this.getCandidateObjectId(e);if(C(s))return!1;const n=t.layerSource.layer;return"graphics"===n.type?i.uid===s:i.sourceLayer===n&&!(!i.attributes||!("objectIdField"in n))&&i.attributes[n.objectIdField]===s}getCandidateObjectId(t){return t instanceof Os?t.objectId:null}createSourceInfo(t){const e=this.createFeatureSnappingSourceType(t);if(C(e))return null;if("loading"in e)return this.updatingHandles.addPromise(e.loading.then((()=>{this.destroyed||this.notifyChange("snappingSources")}))),null;const i=F(this.view)?this.view.allLayerViews.find((e=>e.layer===t.layer)):null;return new As(e.source,i)}createFeatureSnappingSourceType(t){switch(t.layer.type){case"feature":case"geojson":case"csv":case"subtype-group":case"wfs":return this.createFeatureSnappingSourceFeatureLayer(t);case"graphics":return this.createFeatureSnappingSourceGraphicsLayer(t)}return null}createFeatureSnappingSourceFeatureLayer(t){switch(t.layer.source.type){case"feature-layer":{const e=this.getSourceModule("featureService");return F(e.module)?{source:new e.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:t})}:{loading:e.loader}}case"memory":case"csv":case"geojson":case"wfs":{if("mesh"===t.layer.geometryType)return null;const e=this.getSourceModule("featureCollection");return F(e.module)?{source:new e.module.FeatureCollectionSnappingSource({layerSource:t})}:{loading:e.loader}}}return null}createFeatureSnappingSourceGraphicsLayer(t){const e=this.getSourceModule("graphics");return F(e.module)?{source:new e.module.GraphicsSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:t})}:{loading:e.loader}}getSourceModule(t){const e=this.sourceModules[t];if(C(e.loader)){const i=this.loadSourceModule(t).then((t=>{e.module=t}));return e.loader=i,{module:e.module,loader:i}}return{module:e.module,loader:e.loader}}loadSourceModule(t){switch(t){case"featureService":return this.updatingHandles.addPromise(import("./p-fac4fa17.js"));case"featureCollection":return this.updatingHandles.addPromise(import("./p-a265507b.js"));case"graphics":return this.updatingHandles.addPromise(import("./p-e34fbd8d.js"))}return null}};s([n({constructOnly:!0})],Ls.prototype,"spatialReference",void 0),s([n({constructOnly:!0})],Ls.prototype,"view",void 0),s([n()],Ls.prototype,"options",void 0),s([n({readOnly:!0})],Ls.prototype,"updating",null),s([n({readOnly:!0})],Ls.prototype,"snappingSources",null),Ls=s([r("esri.views.interactive.snapping.FeatureSnappingEngine")],Ls);class As{constructor(t,e){this.snappingSource=t,this.layerView=e,this.handles=new Z;const i=this.snappingSource.layerSource.layer;"refresh"in i&&this.handles.add(i.on("refresh",(()=>t.refresh()))),this.handles.add([m(t,"updating",(e=>t.layerSource.updating=e),!0),m(t,"availability",(e=>t.layerSource.availability=e),!0)])}destroy(){this.snappingSource.destroy(),this.handles.destroy()}}const Us=pe();class Ds{constructor(t,e){this.view=t,this.options=e,this.squaredShortLineThreshold=Ce.shortLineThreshold*Ce.shortLineThreshold}snap(t,e){return F(e.vertexHandle)?"vertex"!==e.vertexHandle.type?[]:this.snapExistingVertex(t,e):this.snapNewVertex(t,e)}edgeExceedsShortLineThreshold(t,e){return this.exceedsShortLineThreshold(t.leftVertex.pos,t.rightVertex.pos,e)}exceedsShortLineThreshold(t,e,{elevationInfo:i,editGeometryOperations:s}){const n=s.data.coordinateHelper;return 0===this.squaredShortLineThreshold||ps(ms(e,n,i,this.view),ms(t,n,i,this.view))>this.squaredShortLineThreshold}squaredProximityTreshold(t){return"touch"===t?this.squaredTouchProximityThreshold:this.squaredMouseProximityTreshold}get squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get squaredTouchProximityThreshold(){const{distance:t,touchSensitivityMultiplier:e}=this.options,i=t*e;return i*i}}class Ns extends Cs{constructor({coordinateHelper:t,lineStart:e,lineEnd:i,targetPoint:s}){super(t,s,new Es(t,e,i)),this.referenceLineHint=new js(2,e,i)}get hints(){return[this.referenceLineHint,new js(0,this.lineEndClosestToTarget(),this.targetPoint)]}lineEndClosestToTarget(){const t=this.constraint.start,e=this.constraint.end;return Math.sign(ae(re(Gs,e,t),re(Rs,this.targetPoint,t)))>0?e:t}}const Rs=fe(),Gs=fe();class Hs extends Ds{snapNewVertex(t,e){const i=e.editGeometryOperations.data.components[0],s=i.edges.length,n=[];if(s<1)return n;const r=ms(t,e.coordinateHelper,e.elevationInfo,this.view),a=i.edges[s-1];let o=a;do{this.edgeExceedsShortLineThreshold(o,e)&&this._processCandidateProposal(o.leftVertex.pos,o.rightVertex.pos,t,r,e,n),o=o.leftVertex.leftEdge}while(o&&o!==a);return n}snapExistingVertex(t,e){const i=[],s=B(e.vertexHandle),n=s.component;if(n.edges.length<2)return i;const r=ms(t,e.coordinateHelper,e.elevationInfo,this.view),a=s.leftEdge,o=s.rightEdge;a&&o&&this.edgeExceedsShortLineThreshold(a,e)&&this.edgeExceedsShortLineThreshold(o,e)&&this._processCandidateProposal(a.leftVertex.pos,o.rightVertex.pos,t,r,e,i);const l=n.edges[0];let h=l;do{h!==s.leftEdge&&h!==s.rightEdge&&this.edgeExceedsShortLineThreshold(h,e)&&this._processCandidateProposal(h.leftVertex.pos,h.rightVertex.pos,t,r,e,i),h=h.rightVertex.rightEdge}while(h&&h!==l);return i}_processCandidateProposal(t,e,i,s,n,r){const a=_e(fe(),i,t,e),o=n.coordinateHelper,l=o.fromXYZ(a,o.getZ(i,0));ps(s,ms(l,o,n.elevationInfo,this.view))<this.squaredProximityTreshold(n.pointer)&&r.push(new Ns({coordinateHelper:n.coordinateHelper,lineStart:t,lineEnd:e,targetPoint:l}))}}u.getLogger("esri.views.interactive.snapping.hints.ParallelSnappingHint");class qs extends Ts{constructor(t,e){super(),this.lineStart=t,this.lineEnd=e}equals(t){return t instanceof qs&&fs(this.lineStart,t.lineStart)&&fs(this.lineEnd,t.lineEnd)}}class $s extends Cs{constructor({coordinateHelper:t,referenceLine:e,lineStart:i,targetPoint:s}){const n=t.clone(i);re(n,le(n,n,e.rightVertex.pos),e.leftVertex.pos),super(t,s,new Es(t,i,n)),this._referenceLines=[{edge:e,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new js(0,this.constraint.start,this.targetPoint),new qs(this.constraint.start,this.targetPoint),...this._referenceLines.map((t=>new js(1,t.edge.leftVertex.pos,t.edge.rightVertex.pos,t.fadeLeft,t.fadeRight)))]}addReferenceLine(t){const e={edge:t,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach((i=>{t.rightVertex.rightEdge===i.edge&&(i.fadeLeft=!1,e.fadeRight=!1),t.leftVertex.leftEdge===i.edge&&(i.fadeRight=!1,e.fadeLeft=!1)})),this._referenceLines.push(e)}}class zs extends Ds{constructor(){super(...arguments),this._tmpProjection=fe()}snapNewVertex(t,e){const i=e.editGeometryOperations.data.components[0],s=i.edges.length,n=i.vertices.length,r=[];if(s<2)return r;const a=ms(t,e.coordinateHelper,e.elevationInfo,this.view),o=i.vertices[n-1],l=i.vertices[0],h=i.edges[s-1];let c=h;do{this.edgeExceedsShortLineThreshold(c,e)&&(this._checkEdgeForParalleLines(c,o.pos,t,a,e,r),this._checkEdgeForParalleLines(c,l.pos,t,a,e,r)),c=c.leftVertex.leftEdge}while(c&&c!==h);return r}snapExistingVertex(t,e){const i=[],s=B(e.vertexHandle),n=s.component;if(n.edges.length<3)return i;const r=ms(t,e.coordinateHelper,e.elevationInfo,this.view),a=s.leftEdge,o=s.rightEdge,l=n.vertices[0],h=n.vertices[n.vertices.length-1],c=n.edges[0];let u=c;do{u!==a&&u!==o&&this.edgeExceedsShortLineThreshold(u,e)&&(a&&this._checkEdgeForParalleLines(u,a.leftVertex.pos,t,r,e,i),o&&this._checkEdgeForParalleLines(u,o.rightVertex.pos,t,r,e,i),s===l?this._checkEdgeForParalleLines(u,h.pos,t,r,e,i):s===h&&this._checkEdgeForParalleLines(u,l.pos,t,r,e,i)),u=u.rightVertex.rightEdge}while(u&&u!==c);return i}_checkEdgeForParalleLines(t,e,i,s,n,r){const a=t.leftVertex.pos,o=t.rightVertex.pos;if(_e(this._tmpProjection,e,a,o),ne(this._tmpProjection,e)<Ce.parallelLineThreshold)return;_e(this._tmpProjection,i,a,o,e);const l=n.coordinateHelper,h=l.fromXYZ(this._tmpProjection,l.getZ(i,0));if(ps(s,ms(h,l,n.elevationInfo,this.view))<this.squaredProximityTreshold(n.pointer)){if(this.parallelToPreviousCandidate(t,r))return;r.push(new $s({coordinateHelper:l,referenceLine:t,lineStart:e,targetPoint:h}))}}parallelToPreviousCandidate(t,e){const i=t.leftVertex.pos,s=t.rightVertex.pos;for(const n of e)if(_e(this._tmpProjection,s,n.constraint.start,n.constraint.end,i),ne(this._tmpProjection,s)<Ce.parallelLineThreshold)return n.addReferenceLine(t),!0;return!1}}class Bs extends Ds{constructor(){super(...arguments),this._tmp=fe()}snapNewVertex(t,e){const i=e.editGeometryOperations.data.components[0],s=i.vertices.length,n=[];if(s<2)return n;const r=ms(t,e.coordinateHelper,e.elevationInfo,this.view),a=i.vertices[s-1];this._checkForSnappingCandidate(n,a.leftEdge,a.pos,t,a.leftEdge.leftVertex.pos,a.pos,e,t,r);const o=i.vertices[0];return this._checkForSnappingCandidate(n,o.rightEdge,o.pos,t,o.rightEdge.rightVertex.pos,o.pos,e,t,r),n}snapExistingVertex(t,e){const i=[],s=B(e.vertexHandle),n=s.component,r=n.vertices.length;if(r<3)return i;const a=ms(t,e.coordinateHelper,e.elevationInfo,this.view),o=s.leftEdge,l=s.rightEdge,h=n.vertices[0],c=n.vertices[r-1];if(!o)return this._checkForSnappingCandidate(i,h.rightEdge.rightVertex.rightEdge,h.rightEdge.rightVertex.pos,t,h.rightEdge.rightVertex.rightEdge.rightVertex.pos,h.rightEdge.rightVertex.pos,e,t,a),i;if(!l)return this._checkForSnappingCandidate(i,c.leftEdge.leftVertex.leftEdge,c.leftEdge.leftVertex.pos,t,c.leftEdge.leftVertex.leftEdge.leftVertex.pos,c.leftEdge.leftVertex.pos,e,t,a),i;if(o&&o.leftVertex.leftEdge){const s=o.leftVertex.leftEdge;this._checkForSnappingCandidate(i,s,o.leftVertex.pos,t,s.leftVertex.pos,o.leftVertex.pos,e,t,a)}if(l&&l.rightVertex.rightEdge){const s=l.rightVertex.rightEdge;this._checkForSnappingCandidate(i,s,l.rightVertex.pos,t,s.rightVertex.pos,l.rightVertex.pos,e,t,a)}return i}_checkForSnappingCandidate(t,e,i,s,n,r,a,o,l){if(!this.edgeExceedsShortLineThreshold(e,a))return;re(this._tmp,e.rightVertex.pos,e.leftVertex.pos);const h=me(this._tmp[1],-this._tmp[0]),c=ae(h,re(this._tmp,s,i))/he(h),u=a.coordinateHelper,d=u.fromXYZ(ce(fe(),r,h,c),u.getZ(o,0));ps(l,ms(d,u,a.elevationInfo,this.view))<this.squaredProximityTreshold(a.pointer)&&t.push(new Ps({coordinateHelper:u,targetPoint:d,constraint:new Is(u,r,ce(u.createVector(),r,h,Math.sign(c))),previousVertex:n,otherVertex:r,otherVertexType:1}))}}class Zs extends Cs{constructor({coordinateHelper:t,targetPoint:e,point1:i,point2:s}){super(t,e,new Fs(t,ue(Ks,i,s,.5),.5*de(i,s))),this.p1=i,this.p2=s}get hints(){return[new js(1,this.targetPoint,this.p1),new js(1,this.targetPoint,this.p2),new Vs(this.p1,this.targetPoint,this.p2)]}}const Ks=fe();class Js extends Ds{snapNewVertex(t,e){const i=e.editGeometryOperations.data.components[0],s=[],n=i.vertices.length;return"polygon"!==e.editGeometryOperations.data.type||n<2||this._processCandidateProposal(i.vertices[0].pos,i.vertices[n-1].pos,t,e,s),s}snapExistingVertex(t,e){const i=[],s=B(e.vertexHandle),n=s.component;return n.edges.length<2?i:"polyline"!==e.editGeometryOperations.data.type||0!==s.index&&s.index!==n.vertices.length-1?(this._processCandidateProposal(s.leftEdge.leftVertex.pos,s.rightEdge.rightVertex.pos,t,e,i),i):i}_processCandidateProposal(t,e,i,s,n){if(!this.exceedsShortLineThreshold(t,e,s))return;const r=ue(fe(),t,e,.5),a=.5*de(t,e),o=ke(fe(),i,r,a),l=s.coordinateHelper,h=l.fromXYZ(o,l.getZ(i,0));ps(ms(i,l,s.elevationInfo,this.view),ms(h,l,s.elevationInfo,this.view))<this.squaredProximityTreshold(s.pointer)&&n.push(new Zs({coordinateHelper:l,targetPoint:h,point1:t,point2:e}))}}let Qs=class extends a{constructor(t){super(t),this.updating=!1,this._snappers=new l}initialize(){this._snappers.push(new zs(this.view,this.options),new Hs(this.view,this.options),new Bs(this.view,this.options),new Js(this.view,this.options))}set options(t){this._set("options",t);for(const e of this._snappers)e.options=t}async fetchCandidates(t,e){if(!this.options.effectiveSelfEnabled)return[];const i=[];for(const s of this._snappers.items)i.push(...s.snap(t,e));return ys(t,i),i}};s([n({readOnly:!0})],Qs.prototype,"updating",void 0),s([n({constructOnly:!0})],Qs.prototype,"view",void 0),s([n()],Qs.prototype,"options",null),Qs=s([r("esri.views.interactive.snapping.SelfSnappingEngine")],Qs);class Xs extends Ts{constructor(t){super(),this.intersectionPoint=t}equals(t){return t instanceof Xs&&fs(this.intersectionPoint,t.intersectionPoint)}}class Ys extends Cs{constructor(t,e,i,s){super(t,e,new Ms(t,e,i.constraint,s.constraint)),this.first=i,this.second=s}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new Xs(this.targetPoint)]}}let tn=class extends(v.EventedMixin(at)){constructor(t){super(t),this.options=new Te,this.engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}initialize(){this.handles.add([Tt((()=>{const{effectiveFeatureEnabled:t,effectiveSelfEnabled:e,touchSensitivityMultiplier:i,distance:s}=this.options;return{effectiveFeatureEnabled:t,effectiveSelfEnabled:e,touchSensitivityMultiplier:i,distance:s}}),(()=>{this.doneSnapping(),this.emit("changed")}),Wt),Tt((()=>this.options),(t=>{for(const e of this.engines)e.options=t}),Wt),Tt((()=>this.view.ready),(t=>this.onViewReady(t)),jt)])}destroy(){this.destroyEngines()}get updating(){return this.engines.some((t=>t.updating))}onViewReady(t){var e,i;this.destroyEngines(),t&&(this.engines=[new Qs({view:this.view,options:this.options}),new Ls({view:this.view,spatialReference:null!=(e=null==(i=this.view)?void 0:i.spatialReference)?e:K.WGS84,options:this.options})])}destroyEngines(){for(const t of this.engines)t.destroy();this.engines.length=0}get squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get squaredTouchProximityThreshold(){const{distance:t,touchSensitivityMultiplier:e}=this.options,i=t*e;return i*i}async snap(t,e,i){const s=e.coordinateHelper.pointToVector(t),n=await this.fetchCandidates(s,e,i);return{get valid(){return!U(i)},apply:()=>{const{snappedPoint:t,hints:i}=this.processCandidates(s,n,e);return this.removeVisualization(),F(e.visualizer)&&this.handles.add(e.visualizer.draw(i,{coordinateHelper:e.coordinateHelper,elevationInfo:e.elevationInfo,view:this.view}),en),t}}}update(t,e){this.removeVisualization();let i=t;const s=[];if(F(this._currentMainCandidate)){const n=e.coordinateHelper,r=n.pointToVector(t),a=this._currentMainCandidate.constraint.closestTo(r);if(ps(ms(r,n,e.elevationInfo,this.view),ms(a,n,e.elevationInfo,this.view))<this.squaredPointProximityThreshold(e.pointer)){i=n.vectorToDehydratedPoint(a),this._currentMainCandidate.targetPoint=a,s.push(...this._currentMainCandidate.hints);for(const t of this._currentOtherActiveCandidates)t.targetPoint=a,s.push(...t.hints)}else this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}return F(e.visualizer)&&this.handles.add(e.visualizer.draw(s,{coordinateHelper:e.coordinateHelper,elevationInfo:e.elevationInfo,view:this.view}),en),i}doneSnapping(){this.removeVisualization(),this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}removeVisualization(){this.handles.remove(en)}async fetchCandidates(t,e,i){return(await Promise.all(this.engines.map((s=>s.fetchCandidates(t,e,i))))).flat()}processCandidates(t,e,i){if(e.length<1)return this.doneSnapping(),{snappedPoint:i.coordinateHelper.vectorToDehydratedPoint(t),hints:[]};ys(t,e);const s=this._currentMainCandidate;if(F(s)){const n=this.findOldConstraintInNewCandidates(s,e);if(n>=0){if(!(e[n]instanceof Ys))return this.intersectWithOtherCandidates(n,e,t,i);if(ne(t,s.targetPoint)<this.squaredPointProximityThreshold(i.pointer))return this.updateSnappingCandidate(s,e,i)}}return this.intersectWithOtherCandidates(0,e,t,i)}findOldConstraintInNewCandidates(t,e){return t instanceof Ys?this.findOldCandidateIndex(e,t.first)>=0&&this.findOldCandidateIndex(e,t.second)>=0?0:-1:this.findOldCandidateIndex(e,t)}intersectWithOtherCandidates(t,e,i,s){const n=e[t],r=[],a=s.coordinateHelper;for(let o=0;o<e.length;++o){if(o===t)continue;const l=e[o];for(const t of n.constraint.intersect(l.constraint)){const e=a.fromXYZ(t.intersection,n.targetPoint[2]);r.push([new Ys(a,e,n,l),ps(ms(i,s.coordinateHelper,s.elevationInfo,this.view),ms(e,s.coordinateHelper,s.elevationInfo,this.view))])}}return r.length>0&&(r.sort(((t,e)=>t[1]-e[1])),r[0][1]<this.squaredPointProximityThreshold(s.pointer))?this.updateSnappingCandidate(r[0][0],e,s):this.updateSnappingCandidate(n,e,s)}updateSnappingCandidate(t,e,i){this.doneSnapping(),this._currentMainCandidate=t;const s=this._currentMainCandidate.targetPoint,n=[];n.push(...t.hints);for(const i of e){if(t instanceof Ys){if(i.constraint.objectEqual(t.first.constraint)||i.constraint.objectEqual(t.second.constraint))continue}else if(i.constraint.objectEqual(t.constraint))continue;i.constraint.check(s)&&(i.targetPoint=s,this._currentOtherActiveCandidates.push(i),n.push(...i.hints))}return{snappedPoint:i.coordinateHelper.vectorToDehydratedPoint(s),hints:n}}squaredPointProximityThreshold(t){return"touch"===t?this.squaredTouchProximityThreshold:this.squaredMouseProximityTreshold}findOldCandidateIndex(t,e){let i=-1;for(let s=0;s<t.length;++s)if(e.constraint.objectEqual(t[s].constraint)){i=s;break}return i}get test(){return{visualizationsActive:this.handles.has(en),engines:this.engines}}};s([n({constructOnly:!0})],tn.prototype,"view",void 0),s([n()],tn.prototype,"options",void 0),s([n({readOnly:!0})],tn.prototype,"updating",null),s([n()],tn.prototype,"engines",void 0),s([n()],tn.prototype,"squaredMouseProximityTreshold",null),s([n()],tn.prototype,"squaredTouchProximityThreshold",null),tn=s([r("esri.views.interactive.snapping.SnappingManager")],tn);const en="visualization-handle";let sn=class extends v.EventedAccessor{constructor(t){super(t),this.cancelled=!1,this.history={undo:[],redo:[]},this.type=null}get tool(){if(!this.activeComponent)return null;switch(this.activeComponent.type){case"graphic-mover":case"move-3d":return"move";case"box":case"transform-3d":return"transform";case"reshape":case"reshape-3d":return"reshape";case"draw-2d":case"draw-3d":return this.activeComponent.geometryType}return null}addToHistory(t){this.history.redo=[],this.history.undo.push(t)}resetHistory(){this.history.redo=[],this.history.undo=[]}canUndo(){return this.history.undo.length>0}canRedo(){return this.history.redo.length>0}complete(){this.reset(),this.onEnd(),this.emit("complete")}cancel(){this.cancelled=!0,this.complete()}reset(){this.activeComponent.reset()}refreshComponent(){const t=this.activeComponent;t&&("box"!==t.type&&"reshape"!==t.type&&"graphic-mover"!==t.type||t.refresh())}set undo(t){this._set("undo",(()=>{this.canUndo()&&t()}))}set redo(t){this._set("redo",(()=>{this.canRedo()&&t()}))}};s([n()],sn.prototype,"activeComponent",void 0),s([n()],sn.prototype,"cancelled",void 0),s([n()],sn.prototype,"history",void 0),s([n()],sn.prototype,"tool",null),s([n()],sn.prototype,"type",void 0),s([n()],sn.prototype,"canUndo",null),s([n()],sn.prototype,"canRedo",null),s([n()],sn.prototype,"onEnd",void 0),s([n()],sn.prototype,"undo",null),s([n()],sn.prototype,"redo",null),s([n()],sn.prototype,"toggleTool",void 0),s([n()],sn.prototype,"addToSelection",void 0),s([n()],sn.prototype,"removeFromSelection",void 0),sn=s([r("esri.widgets.Sketch.support.OperationHandle")],sn);let nn=class extends sn{};s([n()],nn.prototype,"activeComponent",void 0),nn=s([r("esri.widgets.Sketch.support.CreateOperationHandle")],nn);let rn=class extends sn{constructor(t){super(t)}};s([n()],rn.prototype,"activeComponent",void 0),rn=s([r("esri.widgets.Sketch.support.UpdateOperationHandle")],rn);const an="esri.widgets.Sketch.SketchViewModel",on=u.getLogger(an),ln={defaultZ:0},hn={reshapeOptions:{edgeOperation:"split",shapeOperation:"move",vertexOperation:"move"},enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,enableZ:!0,tool:"transform"};let cn=class extends v.EventedAccessor{constructor(t){super(t),this._numUpdating=0,this._handles=new Z,this._internalGraphicsLayer=new Ot({listMode:"hide",internal:!0,title:"SVM Internal"}),this._operationHandle=null,this._viewHandles=new Z,this.activeFillSymbol=null,this.activeLineSymbol=null,this.activeVertexSymbol=null,this.allowDeleteKey=!0,this.layer=null,this.pointSymbol=new Zt({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this.polygonSymbol=new Kt({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),this.polylineSymbol=new Jt({color:[130,130,130,1],width:2}),this._snappingManager=null,this.updateGraphics=new l,this.updateOnGraphicClick=!0,this.updatePointSymbol=new Zt({size:10,color:[0,200,255,.5],outline:{color:"black",width:1}}),this.updatePolygonSymbol=new Kt({color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}}),this.updatePolylineSymbol=new Jt({color:[12,207,255],width:2}),this.vertexSymbol=new Zt({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this._moduleLoaderAbortController=null,this._viewReadyAbortController=null,this._originalAutoOpenEnabled=null,this.defaultCreateOptions=ln,this.defaultUpdateOptions=hn,this.snappingOptions=new Te}initialize(){this._handles.add([A(this,"layer",(()=>{this.cancel(),this._internalGraphicsLayer.elevationInfo=F(this.layer)?this.layer.elevationInfo:null})),J(this,"view.map.layers","change",(t=>{t.removed.includes(this.layer)&&this.cancel()})),J(this,"layer.graphics","change",(t=>{if(F(this._operationHandle))for(const e of t.removed)this.updateGraphics.includes(e)&&(this.updateGraphics.length>1?this._operationHandle.removeFromSelection(e):this._operationHandle.cancel())})),m(this,"layer.elevationInfo",(()=>{this.cancel(),this._internalGraphicsLayer.elevationInfo=F(this.layer)?this.layer.elevationInfo:null}),!0),m(this,"view",(t=>{W(this._snappingManager),t&&(this._snappingManager=new tn({view:t,options:this.snappingOptions}),"2d"===t.type?import("./p-8adc0cba.js"):"3d"===t.type&&(import("./p-9b923138.js").then((function(t){return t.e})),import("./p-9d6eeb1d.js")))}),!0)])}destroy(){this.cancel(),this._handles=W(this._handles),this._viewHandles=W(this._viewHandles),this._removeDefaultLayer(),this._snappingManager=W(this._snappingManager),this._set("view",null),this.emit("destroy")}get _defaultUpdateTool(){return"3d"===this.view.type?"move":"transform"}get updating(){return this._numUpdating>0}get activeTool(){return this._operationHandle&&this._operationHandle.tool?this._operationHandle.tool:null}get activeComponent(){return this._operationHandle?this._operationHandle.activeComponent:null}get createGraphic(){return!F(this.activeComponent)||"draw-3d"!==this.activeComponent.type&&"draw-2d"!==this.activeComponent.type?this._get("createGraphic"):B(this.activeComponent.graphic)}set defaultCreateOptions(t){this._set("defaultCreateOptions",{...ln,...t})}set defaultUpdateOptions(t){this._set("defaultUpdateOptions",{...hn,...t,reshapeOptions:{...hn.reshapeOptions,...null==t?void 0:t.reshapeOptions}})}set snappingOptions(t){F(this._snappingManager)&&(this._snappingManager.options=t),this._set("snappingOptions",t)}get state(){var t;const e=!(null==(t=this.view)||!t.ready||!this.layer);return e&&this._operationHandle?"active":e?"ready":"disabled"}get view(){return this._get("view")}set view(t){const e=this._get("view");if(e){const{container:t,map:i}=e;t&&(e.cursor=null),i&&i.remove(this._internalGraphicsLayer),this._viewHandles.removeAll(),this.cancel()}const i="view-ready";this._handles.remove(i),t&&this._handles.add(k(t,"ready",(e=>{this._viewHandles.removeAll(),e&&this._viewHandles.add(this._generateViewHandles(t))}),!0),i),this._set("view",t)}cancel(){this._moduleLoaderAbortController=Q(this._moduleLoaderAbortController),this._viewReadyAbortController=Q(this._viewReadyAbortController),this._operationHandle&&this._operationHandle.cancel()}complete(){this._operationHandle&&this._operationHandle.complete()}delete(){const{state:t,updateGraphics:e}=this;if("active"===t&&e.length){const{activeTool:t,layer:i}=this,s=e.toArray();i.removeMany(s),this.cancel(),this._emitDeleteEvent({graphics:s,tool:t})}}async create(t,e){if(await this._waitViewReady(),"disabled"===this.state)throw this.layer||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),this.view||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),P();if(this.cancel(),F(this.view.activeTool)&&(this.view.activeTool=null),!t)return void this._logError("sketch:missing-parameter","Missing parameter 'tool'.");us(this.view,this._internalGraphicsLayer);const i=await this._setupCreateOperation(t,e);C(i)||this.destroyed?this.view.map.remove(this._internalGraphicsLayer):(i.on("complete",(()=>{if(i===this._operationHandle){const e=this.createGraphic,s=this._operationHandle.cancelled;this._operationHandle.destroy(),this._operationHandle=null,this._set("createGraphic",null),this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),i.cancelled||null==e||this.layer.add(e),this.emit("create",{graphic:e,state:s?"cancel":"complete",tool:t,toolEventInfo:null,type:"create"})}})),this._operationHandle=i,this.view.ready&&ft(this.view)&&this.view.focus())}async update(t,e){await this._waitViewReady();const{layer:i,view:s,state:n}=this;if("disabled"===n)throw s||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),i||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),P();this.cancel(),F(this.view.activeTool)&&(this.view.activeTool=null);const r=Array.isArray(t)?t:[t];if(null==t||!r||!r.length)return void this._logError("sketch:missing-parameter","Missing parameter 'graphics'.");if(r.some((t=>t.layer!==i?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):C(t.geometry)?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0):"2d"===s.type&&!s.spatialReference.equals(t.geometry.spatialReference)&&(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with a spatial reference different from the supplied MapView."),!0))))return;const a=await this._setupUpdateOperation(r,e);this.destroyed||C(a)||vn(a)||(us(this.view,this._internalGraphicsLayer),this._setUpdateOperationHandle(a,e),this.emit("update",{graphics:r,state:"start",aborted:!1,tool:a.tool,toolEventInfo:null,type:"update"}))}undo(){this.canUndo()&&this._operationHandle.undo()}redo(){this.canRedo()&&this._operationHandle.redo()}canUndo(){return!(!this._operationHandle||!this._operationHandle.canUndo())}canRedo(){return!(!this._operationHandle||!this._operationHandle.canRedo())}toggleUpdateTool(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()}async _getFirstHit(t){const e=[];switch(this.view.type){case"2d":{const n=await this.view.hitTest(t);if(n.results.length>0){const t=n.results[0];if(t.graphic){var i,s;const n=t.graphic;"vector-tile"!==(null==(i=n.layer)?void 0:i.type)&&"imagery"!==(null==(s=n.layer)?void 0:s.type)&&e.push(t)}}}break;case"3d":{const i=[this.view.map.ground];this.view.map.allLayers.forEach((t=>{"integrated-mesh"===t.type&&i.push(t)}));const s=await this.view.hitTest(t,{exclude:i});if(s.results.length>0){const t=s.results[0];(!s.ground.mapPoint||this.view.map.ground.opacity<1||s.ground.distance-t.distance>-Math.min(3*s.ground.distance,"global"===this.view.viewingMode?Yt(this.view.renderCoordsHelper.spatialReference).radius/this.view.renderCoordsHelper.unitInMeters:Number.POSITIVE_INFINITY))&&e.push(t)}}}return{screenPoint:t,results:e}}_generateViewHandles(t){return[t.on("immediate-click",(async e=>{if("disabled"===this.state||"active"===this.state&&"create"===this._operationHandle.type||!this.updateOnGraphicClick)return;this._beginAsyncOperation();const i=(await e.async((()=>this._getFirstHit(mt(e))))).results;let s=null;if(i.length){for(const n of i)if(n.graphic){const i=n.graphic;if(this.updateGraphics.includes(i)||i.layer===this.layer){e.stopPropagation(),s=i;break}"2d"!==t.type||this._isComponentGraphic(i)||"active"!==this.state||this.cancel()}}else"active"===this.state&&this.cancel();F(s)&&!this.updateGraphics.includes(s)&&await this.update([s],{...this.defaultUpdateOptions,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions}}),this._endAsyncOperation()}),vt.WIDGET)]}async _setupCreateOperation(t,e){const i={hasZ:"3d"===this.view.type,...this.defaultCreateOptions,...e},s=await this._setupDrawGraphicTool(t,this.view,i);return C(s)?null:(this.view.tools.add(s),this.view.activeTool=s,this._setupCreateOperationHandle(s))}async _setupDrawGraphicTool(t,e,i){if("multipoint"===t&&"3d"===e.type)return this._logError("sketch:create","Multipoint geometries are not supported in SceneView"),null;const s="rectangle"!==t,n="rectangle"!==t;this.snappingOptions.enabledToggled=!1;const r={view:e,mode:"rectangle"===t||"circle"===t?"hybrid":"click",...i,snapToScene:!1,geometryType:t,graphicSymbol:this._getGraphicSymbolFromTool(t),snappingManager:this._snappingManager,forceUniformSize:n,centered:s};return"2d"===this.view.type?this._makeDrawGraphicTool2D(r):this._makeDrawGraphicTool3D(r)}async _makeDrawGraphicTool2D(t){const e=await this._requireModule(import("./p-8adc0cba.js"));return vn(e)||this.destroyed?null:new e.module.DrawGraphicTool2D({...t,activeVertexSymbol:this.activeVertexSymbol,regularVerticesSymbol:this.vertexSymbol,activeLineSymbol:this.activeLineSymbol,activeFillSymbol:un(t.geometryType)?this.activeFillSymbol:null})}async _makeDrawGraphicTool3D(t){const e=await this._requireModule(import("./p-9b923138.js").then((function(t){return t.e})));return vn(e)||this.destroyed?null:new e.module.DrawGraphicTool3D({...t,elevationInfo:this.layer.elevationInfo,snapToScene:!F(this.layer.elevationInfo)||"absolute-height"===this.layer.elevationInfo.mode})}_setupCreateOperationHandle(t){let e=null;const i=t.forceUniformSize,s=t.centered,n=[this.view.on("key-down",(e=>{if(e.key===ds.pan)e.stopPropagation(),e.repeat||(t.enabled=!1);else if(e.key===ds.complete)e.stopPropagation(),t.completeCreateOperation();else if(e.key!==ds.vertexAdd||e.repeat)e.key===ds.undo?(e.stopPropagation(),r.undo()):e.key===ds.redo?(e.stopPropagation(),r.redo()):e.key!==ds.snappingToggle||"rectangle"===t.geometryType||"circle"===t.geometryType||e.repeat?e.key!==ds.constraint||"rectangle"!==t.geometryType&&"circle"!==t.geometryType||e.repeat?e.key===ds.center&&(e.repeat||(t.centered=!s,e.stopPropagation())):(t.forceUniformSize=!i,e.stopPropagation()):(this.snappingOptions.enabledToggled=!0,e.stopPropagation());else{const i=t.drawOperation.geometryType;"polyline"!==i&&"polygon"!==i&&"multipoint"!==i||(e.stopPropagation(),t.drawOperation.commitStagedVertex())}}),vt.WIDGET),this.view.on("key-up",(e=>{e.key===ds.pan?t.enabled=!0:e.key===ds.snappingToggle&&"rectangle"!==t.geometryType&&"circle"!==t.geometryType?(this.snappingOptions.enabledToggled=!1,e.stopPropagation()):e.key!==ds.constraint||"rectangle"!==t.geometryType&&"circle"!==t.geometryType?e.key===ds.center&&(t.centered=s,e.stopPropagation()):(t.forceUniformSize=i,e.stopPropagation())}),vt.WIDGET),t.on("vertex-add",(i=>{switch(e=C(e)?"start":"active",i.operation){case"apply":this.emit("create",{graphic:B(t.graphic),state:e,tool:this.activeTool,toolEventInfo:i,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[B(t.graphic)],tool:t.geometryType});break;case"redo":this._emitRedoEvent({graphics:[B(t.graphic)],tool:t.geometryType})}})),t.on("cursor-update",(e=>{t.drawOperation.numCommittedVertices>0&&this.emit("create",{graphic:B(t.graphic),state:"active",tool:this.activeTool,toolEventInfo:{coordinates:e.vertices[0].coordinates,type:"cursor-update"},type:"create"})})),t.on("vertex-remove",(e=>{switch(e.operation){case"apply":this.emit("create",{graphic:B(t.graphic),state:"active",tool:this.activeTool,toolEventInfo:e,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[B(t.graphic)],tool:t.geometryType});break;case"redo":this._emitRedoEvent({graphics:[B(t.graphic)],tool:t.geometryType})}})),t.on("complete",(t=>{this._set("createGraphic",B(t.graphic)),e="complete",t.aborted?r&&r.cancel():r&&r.complete()})),Tt((()=>this._getGraphicSymbolFromTool(t.geometryType)),(e=>{t.graphicSymbol=e}))],r=new sn({activeComponent:t,tool:t.geometryType,type:"update",onEnd:()=>{var e;n.forEach((t=>t.remove())),n.length=0,null==(e=this.view.tools)||e.remove(t),t.destroy()},undo:()=>{t.canUndo&&t.undo()},redo:()=>{t.canRedo&&t.redo()},canUndo:()=>t.canUndo,canRedo:()=>t.canRedo});return r}_getGraphicSymbolFromTool(t){switch(t){case"point":case"multipoint":return this.pointSymbol;case"polyline":return this.polylineSymbol;case"circle":case"rectangle":case"polygon":return this.polygonSymbol;default:return null}}async _setupUpdateOperation(t,e){const{layer:i,view:s}=this,n={tool:this._defaultUpdateTool,...this.defaultUpdateOptions,...e,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions,...null==e?void 0:e.reshapeOptions}};let r=n.tool;for(const e of t)i.remove(e),i.add(e);if("3d"===s.type){if(0===t.length)return null;switch(r){case"move":return this._setupMove3DOperation(t,n,s,r);case"reshape":{if(t.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const e=ls(t[0]);return 0===e?this._setupReshape3DOperation(t[0],n,s):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${Bi(e)}).`),null)}case"transform":return this._setupGraphicTransform3DOperation(t,n,s)}}switch(r){case"move":return this._setupMoveOperation(t,n,s);case"reshape":{if(t.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const e=ls(t[0]);return 0===e?this._setupTransformOrReshapeOperation(t,r,n,s):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${Bi(e)}).`),null)}case"transform":if(1===t.length){const e=X(t[0].geometry,"type");"point"!==e&&"multipoint"!==e||(r="reshape")}return this._setupTransformOrReshapeOperation(t,r,n,s)}}async _setupMove3DOperation(t,e,i,s,n=!1){for(const e of t){const t=ns(e);if(0!==t)return this._logError("sketch:move",`Move operation not supported for provided graphic(s) (${Bi(t)}).`),null}const r=await this._requireModule(import("./p-9b923138.js").then((function(t){return t.e})));if(vn(r))return r;const a=new r.module.GraphicMoveTool({view:i,enableZ:e.enableZ,snappingManager:this._snappingManager});this.view.tools.add(a),a.graphics.addMany(t),n||this.updateGraphics.addMany(t);const o=[],l=new rn({activeComponent:a,tool:s,type:"update",onEnd:()=>{var t;o.forEach((t=>t.remove())),o.length=0,null==(t=this.view.tools)||t.remove(a),a.destroyed||a.destroy()},undo:()=>{dn(l,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:s})},redo:()=>{pn(l,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:s})},addToSelection:t=>{this.updateGraphics.push(t),a.graphics.push(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[t],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:t=>{const e=this.updateGraphics.indexOf(t);l.history.undo.forEach((t=>t.updates.splice(e,1))),l.history.redo.forEach((t=>t.updates.splice(e,1))),this.updateGraphics.remove(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[t],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?a.graphics.remove(t):l.complete()},toggleTool:async()=>{if(1!==this.updateGraphics.length||!1===e.toggleToolOnClick)return;if("transform"!==s)return;const t=this.updateGraphics.getItemAt(0);if(0!==ls(t))return;const n=await this._setupReshape3DOperation(t,e,i,!0);vn(n)||(l.onEnd(),l.destroy(),this._setUpdateOperationHandle(n,e))}});return o.push(...this._getHandlesForComponent(l,e),this.view.on("immediate-click",(t=>this._getCommonUpdateOperationClickHandlers(l,t,e)),vt.WIDGET),i.on("key-down",(t=>{this._getCommonUpdateOperationKeyDownHandlers(l,t),t.key===ds.snappingToggle&&(this.snappingOptions.enabledToggled=!0,t.stopPropagation())}),vt.WIDGET),i.on("key-up",(t=>{t.key===ds.snappingToggle&&(this.snappingOptions.enabledToggled=!1,t.stopPropagation())}),vt.WIDGET)),l}_setupGraphicTransform3DOperation(t,e,i,s=!1){if(1===t.length&&0===function(t){var e;if("graphics"!==(null==(e=t.layer)?void 0:e.type))return 1;if(C(t.geometry))return 2;switch(t.geometry.type){case"point":break;case"polygon":case"polyline":case"multipoint":case"extent":case"mesh":return 0;default:return 3}const i=F(t.symbol)&&"point-3d"===t.symbol.type&&t.symbol.symbolLayers;return i&&i.length>0&&i.some((t=>"object"===t.type))?"on-the-ground"!==Ji(t)&&Xi(t)?4:0:5}(t[0])){const n=t[0],r=n.geometry;if(F(r)&&("point"===r.type||"mesh"===r.type))return this._setupPointTransform3DOperation(n,e,i);if(F(r)&&("polygon"===r.type||"polyline"===r.type))return this._setupPolyTransform3DOperation(n,e,i,s)}return this._setupMove3DOperation(t,e,i,"transform",s)}async _setupPointTransform3DOperation(t,e,i){const s="transform",{enableRotation:n,enableScaling:r,enableZ:a}=e,o=await this._requireModule(import("./p-9b923138.js").then((function(t){return t.e})));if(vn(o))return o;const l=new o.module.GraphicTransformTool({graphic:t,view:i,enableRotation:n,enableScaling:r,enableZ:a,snappingManager:this._snappingManager});this.view.tools.add(l),this.updateGraphics.add(t);const h=[],c=new rn({activeComponent:l,tool:s,type:"update",onEnd:()=>{var t;h.forEach((t=>t.remove())),h.length=0,null==(t=this.view.tools)||t.remove(l),l.destroyed||l.destroy()},undo:()=>{dn(c,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:s})},redo:()=>{pn(c,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:s})},addToSelection:async t=>{this.updateGraphics.add(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[t],removed:[],type:"selection-change"},type:"update"});const s=await this._setupMove3DOperation(this.updateGraphics.toArray(),e,i,"transform",!0);vn(s)||(c.onEnd(),c.destroy(),this._setUpdateOperationHandle(s,e))},removeFromSelection:t=>{this.updateGraphics.remove(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[t],type:"selection-change"},type:"update"}),c.complete()},toggleTool:()=>{}});return h.push(...this._getHandlesForComponent(c,e),this.view.on("immediate-click",(t=>this._getCommonUpdateOperationClickHandlers(c,t,e)),vt.WIDGET),i.on("key-down",(t=>{this._getCommonUpdateOperationKeyDownHandlers(c,t),t.key===ds.snappingToggle&&(this.snappingOptions.enabledToggled=!0,t.stopPropagation())}),vt.WIDGET),i.on("key-up",(t=>{t.key===ds.snappingToggle&&(this.snappingOptions.enabledToggled=!1,t.stopPropagation())}),vt.WIDGET)),c}async _setupPolyTransform3DOperation(t,e,i,s=!1){const n="transform",{enableRotation:r,enableScaling:a,enableZ:o,preserveAspectRatio:l}=e,h=await this._requireModule(import("./p-9b923138.js").then((function(t){return t.e})));if(vn(h))return h;const c=new h.module.ExtentTransformTool({graphic:t,view:i,enableRotation:r,enableScaling:a,enableZ:o,preserveAspectRatio:l});this.view.tools.add(c),s||this.updateGraphics.add(t);const u=[],d=new rn({activeComponent:c,tool:n,type:"update",onEnd:()=>{var t;u.forEach((t=>t.remove())),u.length=0,null==(t=this.view.tools)||t.remove(c),c.destroyed||c.destroy()},canUndo:()=>c.canUndo,undo:()=>{c.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:n})},canRedo:()=>c.canRedo,redo:()=>{c.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:n})},addToSelection:async t=>{this.updateGraphics.add(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[t],removed:[],type:"selection-change"},type:"update"});const s=await this._setupMove3DOperation(this.updateGraphics.toArray(),e,i,"transform",!0);vn(s)||(d.onEnd(),d.destroy(),this._setUpdateOperationHandle(s,e))},removeFromSelection:t=>{this.updateGraphics.remove(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[t],type:"selection-change"},type:"update"}),d.complete()},toggleTool:async()=>{if(1!==this.updateGraphics.length||!1===e.toggleToolOnClick)return;const t=this.updateGraphics.getItemAt(0);if(0!==ls(t))return;const s=await this._setupReshape3DOperation(t,e,i,!0);vn(s)||(d.onEnd(),d.destroy(),this._setUpdateOperationHandle(s,e))}});return u.push(...this._getHandlesForComponent(d,e),this.view.on("immediate-click",(t=>this._getCommonUpdateOperationClickHandlers(d,t,e)),vt.WIDGET),this.view.on("key-down",(t=>this._getCommonUpdateOperationKeyDownHandlers(d,t)),vt.WIDGET),this.view.on("key-down",(t=>{t.key!==ds.constraint||t.repeat||(c.preserveAspectRatio=!c.preserveAspectRatio,t.stopPropagation())}),vt.WIDGET),this.view.on("key-up",(t=>{t.key===ds.constraint&&(c.preserveAspectRatio=!c.preserveAspectRatio,t.stopPropagation())}),vt.WIDGET)),d}async _setupMoveOperation(t,e,i){const s="move";this.updateGraphics.addMany(t);const n=await this._getGraphicMover(t,e,i);if(vn(n))return n;const r=new rn({activeComponent:n,tool:s,type:"update",onEnd:()=>{var t;this._displayDefaultCursor(),l.forEach((t=>t.remove())),o.forEach((t=>t.remove())),l=[],o=[],n.destroy(),null==(t=this._internalGraphicsLayer)||t.removeMany([...this.updateGraphics.toArray()])},undo:()=>{const t=this.updateGraphics.toArray();dn(r,t),r.refreshComponent(),this._emitUndoEvent({graphics:t,tool:s})},redo:()=>{const t=this.updateGraphics.toArray();pn(r,t),r.refreshComponent(),this._emitRedoEvent({graphics:t,tool:s})},addToSelection:t=>{this.updateGraphics.push(t),n.graphics=this.updateGraphics.toArray(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[t],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:t=>{const e=this.updateGraphics.indexOf(t);r.history.undo.forEach((t=>t.updates.splice(e,1))),r.history.redo.forEach((t=>t.updates.splice(e,1))),this.updateGraphics.remove(t);const i=this.updateGraphics.toArray();this.emit("update",{graphics:i,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[t],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?n.graphics=i:r.complete()}});let a=!1,o=[i.on("immediate-click",(t=>this._getCommonUpdateOperationClickHandlers(r,t,e)),vt.WIDGET),i.on("key-down",(t=>{this._getCommonUpdateOperationKeyDownHandlers(r,t),t.key!==ds.constraint||t.repeat||(a=!0,n.enableMoveAllGraphics=!n.enableMoveAllGraphics)}),vt.WIDGET),i.on("key-up",(t=>{t.key===ds.constraint&&a&&(a=!1,n.enableMoveAllGraphics=!n.enableMoveAllGraphics)}),vt.WIDGET)],l=this._getHandlesForComponent(r,e);return r}async _setupReshape3DOperation(t,e,i,s=!1){const n="reshape",r=await this._requireModule(import("./p-9b923138.js").then((function(t){return t.e})));if(vn(r))return r;this.snappingOptions.enabledToggled=!1;const a=new r.module.GraphicReshapeTool({view:i,graphic:t,enableZVertex:e.enableZ&&"move"===e.reshapeOptions.vertexOperation,enableZShape:e.enableZ&&"move"===e.reshapeOptions.shapeOperation,enableMoveGraphic:"move"===e.reshapeOptions.shapeOperation||"move-xy"===e.reshapeOptions.shapeOperation,enableMidpoints:"split"===e.reshapeOptions.edgeOperation,enableEdgeOffset:"offset"===e.reshapeOptions.edgeOperation,snappingManager:this._snappingManager});i.tools.add(a),s||this.updateGraphics.add(t);const o=[],l=new rn({activeComponent:a,tool:n,type:"update",onEnd:()=>{var t;o.forEach((t=>t.remove())),o.length=0,null==(t=this.view.tools)||t.remove(a),a.destroyed||a.destroy()},canUndo:()=>a.canUndo,undo:()=>{a.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:n})},canRedo:()=>a.canRedo,redo:()=>{a.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:n})},addToSelection:async t=>{this.updateGraphics.add(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[t],removed:[],type:"selection-change"},type:"update"});const s=await this._setupMove3DOperation(this.updateGraphics.toArray(),e,i,"transform",!0);vn(s)||(l.onEnd(),l.destroy(),this._setUpdateOperationHandle(s,e))},removeFromSelection:t=>{this.updateGraphics.remove(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[t],type:"selection-change"},type:"update"}),l.complete()},toggleTool:async()=>{if(!1===e.toggleToolOnClick)return;const t=await this._setupGraphicTransform3DOperation(this.updateGraphics.toArray(),e,i,!0);vn(t)||(l.onEnd(),l.destroy(),this._setUpdateOperationHandle(t,e))}});return o.push(...this._getHandlesForComponent(l,e),i.on("immediate-click",(t=>this._getCommonUpdateOperationClickHandlers(l,t,e)),vt.WIDGET),i.on("key-down",(t=>{this._getCommonUpdateOperationKeyDownHandlers(l,t),t.key===ds.snappingToggle&&(this.snappingOptions.enabledToggled=!0,t.stopPropagation())}),vt.WIDGET),i.on("key-up",(t=>{t.key===ds.snappingToggle&&(this.snappingOptions.enabledToggled=!1,t.stopPropagation())}),vt.WIDGET)),l}async _setupTransformOrReshapeOperation(t,e,i,s){const{multipleSelectionEnabled:n}=i;this.updateGraphics.addMany(t);const r="transform"===e?await this._getBox(t,i,s):await this._getReshape(t,i,s);if(vn(r))return r;const a=new rn({activeComponent:r,type:"update",onEnd:()=>{l.forEach((t=>t.remove())),o.forEach((t=>t.remove())),l=[],o=[],a.activeComponent&&!a.activeComponent.destroyed&&a.activeComponent.destroy(),this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray())},undo:()=>{dn(a,this.updateGraphics.toArray()),a.refreshComponent(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:a.tool})},redo:()=>{pn(a,this.updateGraphics.toArray()),a.refreshComponent(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:a.tool})},addToSelection:async t=>{let e=a.activeComponent;if("reshape"===e.type){const e=[...this.updateGraphics,t];this.updateGraphics.removeAll();const n=await this._setupMoveOperation(e,i,s);if(vn(n))return;a.onEnd(),a.destroy(),this._setUpdateOperationHandle(n,i)}else this.updateGraphics.add(t),e=e,e.graphics=this.updateGraphics.toArray(),e.refresh(),a.resetHistory();this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[t],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:async t=>{const e=this.updateGraphics.indexOf(t);a.history.undo.forEach((t=>t.updates.splice(e,1))),a.history.redo.forEach((t=>t.updates.splice(e,1))),this.updateGraphics.remove(t);const i=this.updateGraphics.toArray();if(0===i.length)a.complete();else{const t=i[0].geometry;1!==i.length||!F(t)||"point"!==t.type&&"multipoint"!==t.type?a.activeComponent.graphics=i:a.toggleTool()}this.emit("update",{graphics:i,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[t],type:"selection-change"},type:"update"})},toggleTool:async()=>{if(this.updateGraphics.length>1)return;const t=this.updateGraphics.getItemAt(0),e=t.geometry;if(F(e)&&("reshape"===a.tool&&("point"===e.type||"multipoint"===e.type)||"transform"===a.tool&&"extent"===e.type))return;let n=null;"transform"===a.tool?n=await this._getReshape([t],i,s):"reshape"===a.tool&&(n=await this._getBox([t],i,s)),vn(n)||(a.activeComponent.destroy(),a.activeComponent=n,a.activeComponent&&(l.forEach((t=>t.remove())),l=this._getHandlesForComponent(a,i)))}});let o=[s.on("immediate-click",(async t=>{var e;const i=await t.async((()=>this._getFirstHit(mt(t))));null!=(e=i.results)&&e.length?i.results.some((e=>{if(e.graphic){var i;const s=e.graphic;if(null!=(i=t.native)&&i.shiftKey&&n)return t.stopPropagation(),a.addToSelection(s),!0;if(s.layer===this.layer)return a.complete(),!0}return!1})):a.complete()}),vt.WIDGET),s.on("key-down",(t=>{if(this._getCommonUpdateOperationKeyDownHandlers(a,t),t.key!==ds.snappingToggle||t.repeat||(this.snappingOptions.enabledToggled=!0,t.stopPropagation()),t.key===ds.constraint&&!t.repeat&&a){const t=a.activeComponent;t&&"box"===t.type&&(t.preserveAspectRatio=!t.preserveAspectRatio)}}),vt.WIDGET),s.on("key-up",(t=>{var e;if(t.key===ds.snappingToggle&&"reshape"===(null==a||null==(e=a.activeComponent)?void 0:e.type)&&(this.snappingOptions.enabledToggled=!1,t.stopPropagation()),t.key===ds.constraint&&a){const t=a.activeComponent;t&&"box"===t.type&&(t.preserveAspectRatio=!t.preserveAspectRatio)}}),vt.WIDGET)],l=this._getHandlesForComponent(a,i);return a}async _getGraphicMover(t,e,i){const{enableMoveAllGraphics:s}=e,n=await this._requireModule(import("./p-a76c7be2.js"));return vn(n)?n:new n.module.default({enableMoveAllGraphics:s,graphics:t,view:i,callbacks:{onGraphicMoveStart:({dx:t,dy:e,graphic:i})=>{this._displayGrabbingCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t,dy:e,mover:i,type:"move-start"},type:"update"})},onGraphicMove:({dx:t,dy:e,graphic:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t,dy:e,mover:i,type:"move"},type:"update"}),onGraphicMoveStop:({dx:t,dy:e,graphic:i})=>{this._displayPointerCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t,dy:e,mover:i,type:"move-stop"},type:"update"})},onGraphicPointerOver:()=>this._displayPointerCursor(),onGraphicPointerOut:()=>this._displayDefaultCursor()}})}async _getBox(t,e,i){const{enableRotation:s,enableScaling:n,preserveAspectRatio:r}=e,a=await this._requireModule(import("./p-03794939.js"));return vn(a)?a:new a.module.default({graphics:t,enableRotation:s,enableScaling:n,preserveAspectRatio:r,layer:this._internalGraphicsLayer,view:i,callbacks:{onMoveStart:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onMove:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onMoveStop:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onScaleStart:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onScale:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onScaleStop:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onRotateStart:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onRotate:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onRotateStop:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"})}})}async _getReshape(t,e,i){var s,n;const r="split"===(null==(s=e.reshapeOptions)?void 0:s.edgeOperation),a="move"===(null==(n=e.reshapeOptions)?void 0:n.shapeOperation),o=await this._requireModule(import("./p-b30b07eb.js"));return vn(o)?o:new o.module.default({enableMidpoints:r,enableMovement:a,graphic:t[0],layer:this._internalGraphicsLayer,snappingManager:this._snappingManager,view:i,callbacks:{onReshapeStart:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onReshape:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onReshapeStop:({mover:t,type:e})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t,type:e},type:"update"}),onMoveStart:({dx:t,dy:e,mover:i,type:s})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t,dy:e,mover:i,type:s},type:"update"}),onMove:({dx:t,dy:e,mover:i,type:s})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t,dy:e,mover:i,type:s},type:"update"}),onMoveStop:({dx:t,dy:e,mover:i,type:s})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t,dy:e,mover:i,type:s},type:"update"}),onVertexAdd:({added:t,type:e,vertices:i})=>{const s=t.map((t=>ee(t.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:s,vertices:i,type:e},type:"update"})},onVertexRemove:({removed:t,type:e,vertices:i})=>{const s=t.map((t=>ee(t.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{removed:s,vertices:i,type:e},type:"update"})}}})}_getHandlesForComponent(t,e){const i=t.activeComponent;switch(i.type){case"graphic-mover":return[i.on("graphic-click",(({graphic:e,viewEvent:i})=>{var s;null!=(s=i.native)&&s.shiftKey&&(i.stopPropagation(),t.removeFromSelection(e))})),i.on("graphic-move-start",(e=>t.addToHistory(mn(e.allGraphics))))];case"box":return[i.on("graphic-click",(i=>this._onTransformOrReshape2DGraphicClick(t,e,i))),i.on("move-start",(e=>t.addToHistory(mn(e.graphics)))),i.on("rotate-start",(e=>t.addToHistory(mn(e.graphics)))),i.on("scale-start",(e=>t.addToHistory(mn(e.graphics))))];case"reshape":return[i.on("graphic-click",(i=>this._onTransformOrReshape2DGraphicClick(t,e,i))),i.on("move-start",(e=>t.addToHistory(mn([e.mover])))),i.on("reshape-start",(e=>t.addToHistory(mn([e.graphic])))),i.on("vertex-add",(e=>t.addToHistory(mn([e.oldGraphic])))),i.on("vertex-remove",(e=>t.addToHistory(mn([e.oldGraphic]))))];case"move-3d":return[i.on("graphic-move-start",(e=>{t.addToHistory(mn(e.allGraphics)),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move-start"},type:"update"})})),i.on("graphic-move",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t.dx,dy:t.dy,mover:t.allGraphics.length>0?t.allGraphics[0]:null,type:"move"},type:"update"})})),i.on("graphic-move-stop",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:t.allGraphics.length>0?t.allGraphics[0]:null,type:"move-stop"},type:"update"})})),i.on("immediate-click",(i=>{i.shiftKey?this._toggleSelection([i.graphic],t,e):t.toggleTool()}))];case"transform-3d":return[i.on("record-undo",(({record:e})=>{t.addToHistory({updates:[e]})})),i.on("graphic-translate-start",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,dx:t.dxScreen,dy:t.dyScreen,type:"move-start"},type:"update"})})),i.on("graphic-translate-stop",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,dx:t.dxScreen,dy:t.dyScreen,type:"move-stop"},type:"update"})})),i.on("graphic-rotate-start",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,angle:t.angle,type:"rotate-start"},type:"update"})})),i.on("graphic-rotate-stop",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,angle:t.angle,type:"rotate-stop"},type:"update"})})),i.on("graphic-scale-start",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,xScale:t.xScale,yScale:t.yScale,type:"scale-start"},type:"update"})})),i.on("graphic-scale-stop",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,xScale:t.xScale,yScale:t.yScale,type:"scale-stop"},type:"update"})})),i.on("graphic-translate",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,dx:t.dxScreen,dy:t.dyScreen,type:"move"},type:"update"})})),i.on("graphic-rotate",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,angle:t.angle,type:"rotate"},type:"update"})})),i.on("graphic-scale",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,xScale:t.xScale,yScale:t.yScale,type:"scale"},type:"update"})})),i.on("immediate-click",(i=>{i.shiftKey?this._toggleSelection([i.graphic],t,e):t.toggleTool()}))];case"reshape-3d":return[i.on("reshape",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:t,type:"update"})})),i.on("move",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:t,type:"update"})})),i.on("vertex-add",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:t,type:"update"})})),i.on("vertex-remove",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:t,type:"update"})})),i.on("immediate-click",(i=>{i.shiftKey?this._toggleSelection([i.graphic],t,e):t.toggleTool()}))];default:return}}_onTransformOrReshape2DGraphicClick(t,e,i){var s;const{graphic:n,viewEvent:r}=i;return null!=(s=r.native)&&s.shiftKey&&n.layer===this.layer?(r.stopPropagation(),t.removeFromSelection(n)):e.toggleToolOnClick?(r.stopPropagation(),t.toggleTool()):void 0}_setUpdateOperationHandle(t,e){this._operationHandle=t;const i=this.view.map;this._disablePopup(e),t.on("complete",(()=>{if(t===this._operationHandle){const s=this.updateGraphics.toArray(),n=this._operationHandle.tool;this._operationHandle.destroy(),this._operationHandle=null,this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray()),this.updateGraphics.removeAll(),i&&i.remove(this._internalGraphicsLayer),this._restorePopup(e),this.emit("update",{graphics:s,state:"complete",aborted:t.cancelled,tool:n,toolEventInfo:null,type:"update"})}}))}async _getCommonUpdateOperationClickHandlers(t,e,i){const s=mt(e),n=(await e.async((()=>this._getFirstHit(s)))).results;n.length&&(e.native.shiftKey&&this._toggleSelection(n.map((t=>t.graphic)),t,i)||n.some((t=>t.graphic&&this.updateGraphics.includes(t.graphic))))?e.stopPropagation():t.complete()}_toggleSelection(t,e,i){const s=!!i.multipleSelectionEnabled;return t.some((t=>!(null==t||!s||t.layer!==this.layer||(this.updateGraphics.includes(t)?e.removeFromSelection(t):e.addToSelection(t),0))))}_getCommonUpdateOperationKeyDownHandlers(t,e){if(!t)return;const i=e.key;i===ds.undo&&t.canUndo()?(e.stopPropagation(),t.undo()):i===ds.redo&&t.canRedo()?(e.stopPropagation(),t.redo()):i===ds.cancel?(e.stopPropagation(),t.cancel()):this.allowDeleteKey&&ds.delete.includes(i)&&this._onDeleteKey(e)}_onDeleteKey(t){if(!this._operationHandle||"update"!==this._operationHandle.type)return;const e=this.activeComponent,i=this.updateGraphics.toArray();C(e)||"reshape-3d"===e.type||("reshape"!==e.type||1===i.length&&"point"===X(i[0].geometry,"type"))&&(t.stopPropagation(),this.delete())}_removeDefaultLayer(){this._internalGraphicsLayer&&(this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),this._internalGraphicsLayer=W(this._internalGraphicsLayer))}_isComponentGraphic(t){const{activeComponent:e}=this;return!(!t||C(e))&&(!(!t.attributes||!t.attributes.esriSketchTool)||("box"===e.type||"reshape"===e.type)&&e.isUIGraphic(t))}_displayPointerCursor(){this.view&&this.view.container&&"pointer"!==this.view.cursor&&(this.view.cursor="pointer")}_displayGrabbingCursor(){this.view&&this.view.container&&"grabbing"!==this.view.cursor&&(this.view.cursor="grabbing")}_displayDefaultCursor(){this.view&&this.view.container&&null!==this.view.cursor&&(this.view.cursor=null)}_logError(t,e,i){on.error(new I(t,e,i))}async _requireModule(t){const e=new AbortController;this._moduleLoaderAbortController=e;const i=await t;return this._moduleLoaderAbortController!==e||e.signal.aborted?{requireError:"aborted"}:{module:i}}_emitUndoEvent(t){this.emit("undo",{...t,type:"undo"})}_emitRedoEvent(t){this.emit("redo",{...t,type:"redo"})}_emitDeleteEvent(t){this.emit("delete",{...t,type:"delete"})}test(){return{operationHandle:this._operationHandle,defaultUpdateOptions:hn}}wait(){return Y(this,"updating")}_beginAsyncOperation(){this._numUpdating+=1,this.notifyChange("updating")}_endAsyncOperation(){this._numUpdating-=1,this.notifyChange("updating")}_disablePopupEnabled(t){var e;return"3d"!==(null==(e=this.view)?void 0:e.type)||this.updateOnGraphicClick||F(t)&&t.toggleToolOnClick}_disablePopup(t){if(!this._disablePopupEnabled(t))return;const e=this.view.popup;e&&C(this._originalAutoOpenEnabled)&&(this._originalAutoOpenEnabled=e.autoOpenEnabled,e.autoOpenEnabled=!1)}_restorePopup(t){if(!this._disablePopupEnabled(t))return;const e=this.view.popup;e&&F(this._originalAutoOpenEnabled)&&(e.autoOpenEnabled=this._originalAutoOpenEnabled,this._originalAutoOpenEnabled=null)}async _waitViewReady(){this.view&&(Q(this._viewReadyAbortController),this._viewReadyAbortController=new AbortController,await O(tt(this.view,"ready"),this._viewReadyAbortController.signal))}};function un(t){return"polygon"===t||"rectangle"===t||"circle"===t}function dn(t,e){fn("undo",t.history.undo,t.history.redo,e)}function pn(t,e){fn("redo",t.history.redo,t.history.undo,e)}function fn(t,e,i,s){const n=e.pop().updates,r=[];s.forEach(((e,i)=>{const s=n[i];null!=s&&("geometry"in s&&F(s.geometry)&&(r.push({geometry:e.geometry}),e.geometry=s.geometry),"symbol"in s&&F(s.symbol)&&(r.push({symbol:e.symbol}),e.symbol=s.symbol),"undo"in s&&(r.push(s),s[t](e)))})),i.push({updates:r})}function mn(t){return{updates:t.map((t=>({geometry:t.geometry})))}}function vn(t){return"requireError"in t&&"aborted"===t.requireError}s([n()],cn.prototype,"updating",null),s([n()],cn.prototype,"_operationHandle",void 0),s([n({readOnly:!0})],cn.prototype,"activeTool",null),s([n()],cn.prototype,"activeFillSymbol",void 0),s([n()],cn.prototype,"activeLineSymbol",void 0),s([n()],cn.prototype,"activeVertexSymbol",void 0),s([n()],cn.prototype,"allowDeleteKey",void 0),s([n({readOnly:!0})],cn.prototype,"createGraphic",null),s([n()],cn.prototype,"defaultCreateOptions",null),s([n()],cn.prototype,"defaultUpdateOptions",null),s([n()],cn.prototype,"layer",void 0),s([n({types:Bt})],cn.prototype,"pointSymbol",void 0),s([n({types:Bt})],cn.prototype,"polygonSymbol",void 0),s([n({types:Bt})],cn.prototype,"polylineSymbol",void 0),s([n({type:Te,nonNullable:!0})],cn.prototype,"snappingOptions",null),s([n()],cn.prototype,"_snappingManager",void 0),s([n({readOnly:!0})],cn.prototype,"state",null),s([n({readOnly:!0})],cn.prototype,"updateGraphics",void 0),s([n()],cn.prototype,"updateOnGraphicClick",void 0),s([n({types:Bt})],cn.prototype,"updatePointSymbol",void 0),s([n({types:Bt})],cn.prototype,"updatePolygonSymbol",void 0),s([n({types:Bt})],cn.prototype,"updatePolylineSymbol",void 0),s([n({types:Bt})],cn.prototype,"vertexSymbol",void 0),s([n({value:null})],cn.prototype,"view",null),s([n()],cn.prototype,"cancel",null),s([n()],cn.prototype,"complete",null),s([n()],cn.prototype,"delete",null),s([n()],cn.prototype,"create",null),s([n()],cn.prototype,"update",null),s([n()],cn.prototype,"undo",null),s([n()],cn.prototype,"redo",null),s([n()],cn.prototype,"canUndo",null),s([n()],cn.prototype,"canRedo",null),s([n()],cn.prototype,"toggleUpdateTool",null),cn=s([r(an)],cn);const gn=cn,yn="esri.widgets.Editor.EditorViewModel",wn=u.getLogger(yn),bn=["create","update"];function _n(t,e,i){wn.error(new I(t,e,i))}let kn=class extends(rt(v.EventedAccessor)){constructor(t){super(t),this._sketchGraphicsLayer=new Ot({listMode:"hide",internal:!0}),this.activeWorkflow=null,this.activityQueue=[],this.failures=[],this.attachmentsViewModel=new gt({abilities:{editing:!0}}),this.featureFormViewModel=new Be,this.featureTemplatesViewModel=new li,this.layerInfos=null,this.sketchViewModel=new gn({layer:this._sketchGraphicsLayer}),this.snappingOptions=new Te,this.spinnerViewModel=new yt}initialize(){this.handles.add([J(this,"activeWorkflow","cancel",(()=>this.emit("workflow-cancel"))),J(this,"activeWorkflow","commit",(()=>this.emit("workflow-commit"))),m(this,"view.map",(t=>{t&&t.add(this._sketchGraphicsLayer)})),A(this,"editableItems",(()=>{const{activeWorkflow:t}=this;if(this.refreshCreationTemplates(),!t)return;const{stepId:e}=t;"create"!==t.type?"update"===t.type&&("awaiting-feature-to-update"===e&&!this.canUpdate||"awaiting-update-feature-candidate"===e&&!t.data.candidates.some((t=>{const e=this.editableItems.find((e=>e.layer===t.layer));return e&&e.supports.indexOf("update")>-1})))&&this._cancelWorkflow():"awaiting-feature-creation-info"!==e||this.canCreate||this._cancelWorkflow()}))])}destroy(){this._cancelWorkflow().then((()=>{var t;null!=(t=this.view)&&t.map&&this.view.map.remove(this._sketchGraphicsLayer),this.view=null}))}get allowedWorkflows(){return this._get("allowedWorkflows")}set allowedWorkflows(t){t&&0!==t.length||(t=[...bn]),this._set("allowedWorkflows",t)}get canCreate(){return this.editableItems.some((t=>t.supports.includes("create")))}get canUpdate(){return this.editableItems.some((t=>t.supports.includes("update")))}get editableItems(){var t,e,i;const s=null==(t=this.view)?void 0:t.allLayerViews;if(!s)return new l;const n=new Set(null==(e=this.view)||null==(i=e.map)?void 0:i.editableLayers);return s.filter((t=>n.has(t.layer))).map((t=>{const{layer:e,suspended:i}=t,{data:s,operations:n}=e.capabilities,r=function(t,e){return t&&t.find((t=>t.layer===e))}(this.layerInfos,e),a="supportsAttachment"in s&&s.supportsAttachment&&(!r||!1!==r.allowAttachments);if(i)return{hasAttachments:a,layer:e,supports:[]};const o=[];return n.supportsAdd&&this.allowedWorkflows.includes("create")&&(!r||!1!==r.enabled&&!1!==r.addEnabled)&&o.push("create"),n.supportsUpdate&&this.allowedWorkflows.includes("update")&&(!r||!1!==r.enabled&&!1!==r.updateEnabled)&&o.push("update"),!1!==(r&&r.deleteEnabled)&&n.supportsDelete&&o.push("delete"),{hasAttachments:a,layer:e,supports:o}})).reverse()}get state(){if(!this.get("view.ready")||0===this.editableItems.length)return"disabled";const t=this.attachmentsViewModel.mode;if("add"===t)return"adding-attachment";if("edit"===t)return"editing-attachment";const{activeWorkflow:e}=this;return e?e.stepId:"ready"}get syncing(){return this.activityQueue.length>0}set view(t){this.sketchViewModel.view=t,this.spinnerViewModel.view=t,this._set("view",t)}async startCreateWorkflowAtFeatureTypeSelection(){if(!this.canCreate)return void _n("editing:unsupported-workflow","Create workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createCreateWorkflow();await t.start(),this._set("activeWorkflow",t)}async startCreateWorkflowAtFeatureCreation(t){if(!this.canCreate)return void _n("editing:unsupported-workflow","Create workflow is unsupported or disabled.");await this._cancelWorkflow();const e=this._createCreateWorkflow("awaiting-feature-to-create");e.data.creationInfo=t,await e.start(),this._set("activeWorkflow",e)}async startBatchCreateWorkflow(t,e="awaiting-feature-creation-info"){if(!this.canCreate)throw new I("editing:unsupported-workflow","Batch create workflow is unsupported or disabled.");await this._cancelWorkflow();const i=this._createBatchCreateWorkflow(t,e);await i.start(),this._set("activeWorkflow",i)}async startCreateWorkflowAtFeatureEdit(t){if(!this.canCreate)return void _n("editing:unsupported-workflow","Create workflow is unsupported or disabled.");await this._cancelWorkflow();const e=this._createCreateWorkflow("editing-new-feature");e.data.edits.feature=t,await e.start(),this._set("activeWorkflow",e)}async startUpdateWorkflowAtFeatureSelection(){if(!this.canUpdate)return void _n("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createUpdateWorkflow();await t.start(),this._set("activeWorkflow",t)}async startUpdateWorkflowAtMultipleFeatureSelection(t){if(!this.canUpdate)return void _n("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const e=this._createUpdateWorkflow("awaiting-update-feature-candidate");e.data.candidates=t,await e.start(),this._set("activeWorkflow",e)}async startUpdateWorkflowAtFeatureEdit(t){if(!this.canUpdate)return void _n("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const e=this._createUpdateWorkflow("editing-existing-feature");e.data.edits.feature=t,await e.start(),this._set("activeWorkflow",e)}async deleteFeatureFromWorkflow(){const{activeWorkflow:t}=this;t&&"update"===t.type?(await this._delete(t.data.edits.feature),await t.reset()):_n("editing:unsupported-workflow","Deleting requires an active update workflow.")}async cancelWorkflow(t){return this._cancelWorkflow({warn:!0,...t})}refreshCreationTemplates(){const t=[];for(const{layer:e,supports:i}of this.editableItems)"templates"in e&&i.includes("create")&&t.push(e);this.featureTemplatesViewModel.layers=t}async _cancelWorkflow(t){const e=this.activeWorkflow;if(e)return t&&!1===t.force?(await e.cancel(t),void this._set("activeWorkflow",null)):(this.emit("workflow-cancel"),this._set("activeWorkflow",null),void await e.cancel(t));t&&t.warn&&_n("editing:no-active-workflow","There is no active workflow to cancel.")}_createBatchCreateWorkflow(t,e){return Wi.create(this,t,e,((t,e)=>this._applyEdits(t,e)))}_createCreateWorkflow(t){return Ni.create(this,t,((t,e)=>this._applyEdits(t,e)))}_createUpdateWorkflow(t){return zi.create(this,t,((t,e)=>this._applyEdits(t,e)))}async _delete(t){const e=t.sourceLayer;"applyEdits"in e&&await this._applyEdits(e,{deleteFeatures:[t]})}async _applyEdits(t,e){await this._queueOperation((async()=>{const i=await this.view.whenLayerView(t),s=await t.applyEdits(e);return await M(i,"updating"),s}))}_queueOperation(t){this.activityQueue.push(t),this.notifyChange("syncing");const e=(t,e)=>{const i=e.indexOf(t);i>-1&&e.splice(i,1)};return t().then((({addFeatureResults:t,deleteFeatureResults:e,updateFeatureResults:i})=>{const s=t.find((t=>!!t.error))||i.find((t=>!!t.error))||e.find((t=>!!t.error));if(s)throw s.error})).catch((i=>{_n("editing:operation-error","An error occurred.",{error:i});const s={error:i,retry:()=>(e(s,this.failures),this._queueOperation(t)),cancel:()=>{e(s,this.failures)}};this._set("failures",[...this.failures,s])})).then((()=>{e(t,this.activityQueue),this.notifyChange("syncing")}))}};s([n({readOnly:!0})],kn.prototype,"activeWorkflow",void 0),s([n({readOnly:!0})],kn.prototype,"activityQueue",void 0),s([n({value:[...bn]})],kn.prototype,"allowedWorkflows",null),s([n({readOnly:!0})],kn.prototype,"canCreate",null),s([n({readOnly:!0})],kn.prototype,"canUpdate",null),s([n({readOnly:!0})],kn.prototype,"editableItems",null),s([n({readOnly:!0})],kn.prototype,"failures",void 0),s([n()],kn.prototype,"attachmentsViewModel",void 0),s([n()],kn.prototype,"featureFormViewModel",void 0),s([n()],kn.prototype,"featureTemplatesViewModel",void 0),s([n()],kn.prototype,"layerInfos",void 0),s([n()],kn.prototype,"sketchViewModel",void 0),s([c("sketchViewModel.snappingOptions")],kn.prototype,"snappingOptions",void 0),s([n()],kn.prototype,"spinnerViewModel",void 0),s([n()],kn.prototype,"state",null),s([n({readOnly:!0})],kn.prototype,"syncing",null),s([n()],kn.prototype,"view",null),kn=s([r(yn)],kn);const xn=kn,Sn="esri-editor esri-widget esri-widget--panel",In="esri-editor__scroller",En="esri-editor__content",Mn="esri-editor__temp-wrapper";function Fn(t){t.focus()}let Cn=class extends(rt(y)){constructor(t,e){super(t,e),this._candidateCommitted=!1,this._featureForm=new Xe,this._attachments=new wt({visibleElements:{addSubmitButton:!1,cancelAddButton:!1,cancelUpdateButton:!1,deleteButton:!1,errorMessage:!1,progressBar:!1,updateButton:!1}}),this._featureTemplates=new mi,this._filterText="",this._prompt=null,this._spinner=new bt,this.activeWorkflow=null,this.allowedWorkflows=null,this.headingLevel=4,this.iconClass="esri-icon-edit",this.label=void 0,this.layerInfos=null,this.messages=null,this.messagesCommon=null,this.messagesTemplates=null,this.snappingOptions=new Te,this.supportingWidgetDefaults=null,this.view=null,this.viewModel=new xn,this._handleHeaderClickOrKeyDown=t=>{t.currentTarget["data-prevent-back"]||this._handleBack.call(this,t)},this._setCandidateFeature=(t,e=!1)=>{if(this._candidateCommitted)return;const i=this._assertActiveUpdateWorkflow();i.data.edits.feature=t,e&&(i.next(),this._candidateCommitted=!0)},this._handleSave=this._handleSave.bind(this),this._handleBack=this._handleBack.bind(this),this._handleDone=this._handleDone.bind(this),this._handleDelete=this._handleDelete.bind(this),this._handleAdd=this._handleAdd.bind(this),this._handleEdit=this._handleEdit.bind(this),this._handleAttachmentAdd=this._handleAttachmentAdd.bind(this),this._handleAttachmentUpdate=this._handleAttachmentUpdate.bind(this),this._handleAttachmentDelete=this._handleAttachmentDelete.bind(this)}initialize(){this.own([m(this,"headingLevel",(t=>{this._featureForm.headingLevel=t+1,this._featureTemplates.headingLevel=t+1})),m(this,"viewModel",(t=>{this._featureForm.viewModel=t?t.featureFormViewModel:null,this._attachments.viewModel=t?t.attachmentsViewModel:null,this._featureTemplates.viewModel=t?t.featureTemplatesViewModel:null,this._spinner.viewModel=t?t.spinnerViewModel:null})),m(this,"view",((t,e)=>{const i=`editor-${this.id}-spinner`;e&&e.ui.remove(this._spinner,i),t&&t.ui.add(this._spinner,{key:i,position:"manual"})})),J(this,"viewModel.sketchViewModel","create",(()=>{this.scheduleRender()})),J(this,"viewModel.activeWorkflow","cancel-request",(({controller:t})=>{const{messages:e,messagesCommon:i}=this;this._prompt={title:e.cancelRequestTitle,message:e.cancelRequestWarningMessage,options:[{label:i.form.no,type:"neutral",action:()=>(t.deny(),this._prompt=null)},{label:i.form.yes,type:"negative",action:()=>{t.allow(),this._prompt=null}}]},this.scheduleRender()})),m(this,"supportingWidgetDefaults",(t=>{t&&(this._featureForm.set(t.featureForm),this._attachments.set(t.attachments),this._featureTemplates.set(t.featureTemplates),this.viewModel.sketchViewModel.set(t.sketch))})),A(this,"_attachments.error",(t=>{if(!t)return;const{messages:e,messagesCommon:i}=this;this._prompt={title:e.errorWarningTitle,message:t.message,options:[{label:i.form.ok,type:"neutral",action:()=>{this._prompt=null}}]}})),A(this,"viewModel.failures",(t=>{if(!t)return;const{messages:e}=this,[{error:i,retry:s,cancel:n}]=t;this._prompt={title:e.errorWarningTitle,message:et(e.errorWarningMessageTemplate,{errorMessage:i.message}),options:[{label:e.retry,type:"positive",action:()=>{s(),this._prompt=null}},{label:e.ignore,type:"neutral",action:()=>(n(),this._prompt=null)}]}})),A(this,"viewModel.state",(t=>{"awaiting-update-feature-candidate"===t&&(this._candidateCommitted=!1)})),A(this,["_attachments.selectedFile","_attachments.submitting"],(()=>this.scheduleRender())),it(this,"viewModel.activeWorkflow",(()=>this._featureTemplates.filterText=""))])}destroy(){this._attachments.destroy(),this._featureForm.destroy(),this._featureTemplates.destroy()}startCreateWorkflowAtFeatureTypeSelection(){return this.viewModel.startCreateWorkflowAtFeatureTypeSelection()}startCreateWorkflowAtFeatureCreation(t){return this.viewModel.startCreateWorkflowAtFeatureCreation(t)}startCreateWorkflowAtFeatureEdit(t){return this.viewModel.startCreateWorkflowAtFeatureEdit(t)}startUpdateWorkflowAtFeatureSelection(){return this.viewModel.startUpdateWorkflowAtFeatureSelection()}startUpdateWorkflowAtMultipleFeatureSelection(t){return this.viewModel.startUpdateWorkflowAtMultipleFeatureSelection(t)}startUpdateWorkflowAtFeatureEdit(t){return this.viewModel.startUpdateWorkflowAtFeatureEdit(t)}deleteFeatureFromWorkflow(){return this.viewModel.deleteFeatureFromWorkflow()}cancelWorkflow(t){return this.viewModel.cancelWorkflow(t)}render(){const{_attachments:t,viewModel:e}=this;if(!e)return w("div",{class:Sn});const{state:i}=e,s=this._prompt?w("div",{class:"esri-editor__overlay",key:"overlay"},this.renderPrompt({message:this._prompt.message,title:this._prompt.title,options:this._prompt.options})):null;return w("div",{class:Sn},e.syncing||t.submitting?this.renderProgressBar():null,"disabled"===i?null:"ready"===i?this.renderLanding():"awaiting-feature-creation-info"===i?this.renderTemplates():"editing-new-feature"===i||"editing-existing-feature"===i?this.renderAttributeEditing():"awaiting-feature-to-update"===i?this.renderFeatureUpdating():"awaiting-update-feature-candidate"===i?this.renderFeatureList():"awaiting-feature-to-create"===i?this.renderFeatureCreation():"adding-attachment"===i?this.renderAttachmentAdding():"editing-attachment"===i?this.renderAttachmentEditing():null,s)}renderTemplates(){return w("div",{class:Mn,key:"wrapper"},this.renderHeader(this.messages.selectTemplate,!0),w("div",{key:"content",class:En},this._featureTemplates.render()))}renderAttributeEditing(){const{viewModel:t}=this,e=t.featureFormViewModel,i=this._assertActiveCreateOrUpdateWorklow(),s=i.data.edits.feature,n="update"===i.type&&!i.data.edits.modified||t.syncing||e.inputFields.length>0&&!e.valid,{messages:r,messagesCommon:a}=this,o="create"===i.type?a.add:a.update,l=[{label:o,type:"primary",disabled:n,clickHandler:this._handleSave}];let h=!1;"update"===i.type&&(i.data.editableItem.hasAttachments&&(h=!0),i.data.editableItem.supports.includes("delete")&&l.push({label:a.delete,type:"tertiary",clickHandler:this._handleDelete}));const c=this._getLabel(s);return w("div",{class:Mn,key:"wrapper"},this.renderHeader(c,!0),w("div",{key:"content",class:this.classes(En,In)},w("div",{class:"esri-editor__content-group"},e.inputFields.length>0?this._featureForm.render():this.renderMessage(et(r.clickToFinishTemplate,{button:o})),h?w("div",{key:"attachments"},w("div",null,r.attachments),this._attachments.render()):null)),this.renderControls(l))}renderAttachmentAdding(){const{_attachments:t,messages:e,messagesCommon:i}=this,s=[{label:t.submitting?i.cancel:i.add,disabled:t.submitting||!t.selectedFile,type:"primary",clickHandler:this._handleAttachmentAdd}];return w("div",{class:Mn,key:"wrapper"},this.renderHeader(e.addAttachment,!0,t.submitting),w("div",{key:"content",class:this.classes(En,In)},t.render()),this.renderControls(s))}renderAttachmentEditing(){const{_attachments:t,messages:e,messagesCommon:i}=this,s=[{label:i.update,disabled:t.submitting||!t.selectedFile,type:"primary",clickHandler:this._handleAttachmentUpdate},{label:i.delete,disabled:t.submitting,type:"tertiary",clickHandler:this._handleAttachmentDelete}];return w("div",{class:Mn,key:"wrapper"},this.renderHeader(e.editAttachment,!0,t.submitting),w("div",{key:"content",class:this.classes(En,In)},t.render()),this.renderControls(s))}renderFeatureUpdating(){const{messages:t}=this;return w("div",{class:Mn,key:"wrapper"},this.renderHeader(t.selectFeature,!0),w("div",{key:"content",class:this.classes(En,In)},this.renderMessage(t.selectFeatureToEdit)))}renderMessage(t){return w("div",{class:"esri-editor__message"},t)}renderFeatureCreation(){const{messages:t,viewModel:e}=this,i=e.sketchViewModel,s=this._assertActiveCreateWorkflow().data.creationInfo.layer,n=i.canUndo()&&i.createGraphic?i.createGraphic:null,r=this._getSketchingTip(s.geometryType,n);return w("div",{class:Mn,key:"wrapper"},this.renderHeader(t.placeFeature,!0),w("div",{key:"content",class:this.classes(En,In)},this.renderMessage(r)))}renderControls(t){return w("div",{class:"esri-editor__controls",key:"controls"},t.map((({disabled:t=!1,label:e,type:i,clickHandler:s},n)=>this.renderButton({label:e,class:this.classes("esri-editor__control-button","esri-button","secondary"===i?"esri-button--secondary":"tertiary"===i?"esri-button--tertiary":null,t?"esri-button--disabled":null),disabled:t,clickHandler:s,key:n}))))}renderPrompt({title:t,message:e,options:i=[]}){return w("div",{class:"esri-editor__warning-card",role:"alert"},w("div",{class:"esri-editor__warning-header"},w("span",{class:"esri-icon-notice-triangle","aria-hidden":"true"}),w(Et,{class:"esri-editor__warning-heading",level:this.headingLevel},t)),w("div",{class:"esri-editor__warning-message"},e),w("div",{class:"esri-editor__warning-divider"}),i.map((({label:t,action:e,type:i},s)=>{const n=0===s;return w("div",{afterCreate:n?Fn:null,class:this.classes("esri-editor__warning-option",n?"esri-editor__warning-option--primary":null,"positive"===i?"esri-editor__warning-option--positive":"negative"===i?"esri-editor__warning-option--negative":null),key:s,onclick:e,onkeydown:t=>{const i=nt(t);S(i)&&(t.preventDefault(),e.call(null))},tabIndex:0,role:"button"},t)})))}renderProgressBar(){return w("div",{class:this.classes("esri-editor__progress-bar"),key:"progress-bar"})}renderButton(t){return w("button",{class:t.class,disabled:t.disabled,key:t.key,onclick:t.clickHandler,type:"button"},t.label)}renderHeader(t,e=!1,i=!1){const{messagesCommon:s}=this;return w("header",{class:"esri-editor__header",key:"header"},e?w("div",{"aria-label":s.back,class:this.classes("esri-editor__back-button","esri-interactive",i?"esri-button--disabled":null),key:"back-button","data-prevent-back":i,onclick:this._handleHeaderClickOrKeyDown,onkeydown:this._handleHeaderClickOrKeyDown,role:"button",tabIndex:0,title:s.back},w("span",{"aria-hidden":"true",class:st(this.container)?"esri-icon-right":"esri-icon-left"})):null,w(Et,{class:"esri-editor__title",level:this.headingLevel},t))}renderLanding(){const{messages:t}=this,{allowedWorkflows:e,canCreate:i,canUpdate:s}=this.viewModel,n=st(this.container)?"esri-icon-left":"esri-icon-right";return w("div",{class:Mn,key:"wrapper"},this.renderHeader(t.widgetLabel),w("div",{key:"content",class:En,role:"group"},w("div",{class:"esri-editor__mode-selection",key:"mode-selection"},e.indexOf("update")>-1?w("div",{"aria-disabled":s?"false":"true",class:this.classes("esri-editor__feature-list-item",s?null:"esri-editor__feature-list-item--disabled"),key:"update",onclick:this._handleEdit,onkeydown:this._handleEdit,role:"button",tabIndex:s?0:-1},w("span",{class:"esri-editor__feature-list-name"},t.editFeature),w("span",{"aria-hidden":"true",class:this.classes("esri-editor__feature-list-icon",n)})):null,e.indexOf("create")>-1?w("div",{class:this.classes("esri-editor__feature-list-item",i?null:"esri-editor__feature-list-item--disabled"),key:"create",onclick:this._handleAdd,onkeydown:this._handleAdd,role:"button",tabIndex:i?0:-1},w("span",{class:"esri-editor__feature-list-name"},t.addFeature),w("span",{"aria-hidden":"true",class:this.classes("esri-editor__feature-list-icon",n)})):null)))}renderFeatureList(){const{messages:t,messagesTemplates:e,viewModel:{editableItems:i}}=this,s=this._assertActiveUpdateWorkflow().data.candidates,n=et(t.multipleFeaturesTemplate,{total:s.length}),r=new Map;s.map((t=>({label:this._getLabel(t),id:t.attributes[t.layer.objectIdField],data:t}))).filter((t=>{const{label:e,data:i}=t,s=this._filterText.toLowerCase(),{title:n}=i.layer;return this.viewModel.editableItems.find((t=>t.layer===i.layer)).supports.indexOf("update")>-1&&(!s||e.toLowerCase().indexOf(s)>-1||n.toLowerCase().indexOf(s)>-1)})).forEach((t=>{const e=t.data.layer;r.has(e)?r.get(e).items.push(t):r.set(e,{id:`${e.id}`,label:e.title,items:[t]})}));const a=i.filter((({layer:t})=>r.has(t))).map((({layer:t})=>r.get(t))).toArray();return w("div",{class:Mn,key:"wrapper"},this.renderHeader(n,!0),w("div",{key:"content",class:this.classes(En,In)},hi({id:this.id,filterText:this._filterText,items:a,messages:{filterPlaceholder:e.filterPlaceholder,noItems:e.noItems,noMatches:e.noMatches},onItemMouseEnter:({data:t})=>this._setCandidateFeature(t),onItemMouseLeave:()=>this._setCandidateFeature(null),onItemSelect:({data:t})=>this._setCandidateFeature(t,!0),onFilterChange:t=>this._filterText=t})))}_getSketchingTip(t,e){const{messages:i}=this;if("point"===t)return i.tips.clickToAddPoint;if("polygon"===t||"polyline"===t){if(!e)return i.tips.clickToStart;const s=e.geometry,n="polygon"===t?"rings":"paths",[r]=s[n];return"polygon"===t&&r<4?i.tips.clickToContinue:i.tips.clickToContinueThenDoubleClickToEnd}return i.tips.clickToAddFeature}_getLabel(t){const e=t.layer,{objectIdField:i}=e,{attributes:s}=t,n=ct(e);return n&&s[n]&&`${s[n]}`||et(this.messages.untitledFeatureTemplate,{id:s[i]})}_handleDelete(){const{messages:t,messagesCommon:e}=this;this._prompt={title:t.deleteWarningTitle,message:t.deleteWarningMessage,options:[{label:t.keepFeature,type:"neutral",action:()=>this._prompt=null},{label:e.delete,type:"positive",action:()=>{this.viewModel.deleteFeatureFromWorkflow(),this._prompt=null}}]}}_handleSave(){this.viewModel.activeWorkflow.commit()}_handleAttachmentAdd(){const{_attachments:t}=this,{activeWorkflow:e}=this.viewModel;t.addAttachment().then((()=>e.previous()))}_handleAttachmentUpdate(){const{_attachments:t}=this,{activeWorkflow:e}=this.viewModel;t.updateAttachment().then((()=>e.previous()))}_handleAttachmentDelete(){const{messages:t,messagesCommon:e}=this;this._prompt={title:t.deleteAttachmentWarningTitle,message:t.deleteAttachmentWarningMessage,options:[{label:t.keepAttachment,type:"neutral",action:()=>this._prompt=null},{label:e.delete,type:"positive",action:()=>{const{_attachments:t}=this,{activeWorkflow:e}=this.viewModel;t.deleteAttachment(t.viewModel.activeAttachmentInfo).then((()=>{e.previous(),this._prompt=null}))}}]}}_handleAdd(){this.viewModel.canCreate&&this.viewModel.startCreateWorkflowAtFeatureTypeSelection()}_handleEdit(){this.viewModel.canUpdate&&this.viewModel.startUpdateWorkflowAtFeatureSelection()}_handleDone(){this.viewModel.cancelWorkflow({force:!0})}_handleBack(){const{messages:t}=this,e=this._assertActiveCreateOrUpdateWorklow(),{stepId:i,data:s,type:n}=e,r=()=>{e.hasPreviousStep?e.previous({cancelCurrentStep:!0}):this.viewModel.cancelWorkflow({force:!0})};"editing-new-feature"===i||"editing-existing-feature"===i&&s.edits.modified?this._prompt={title:"create"===n?t.cancelAddTitle:t.cancelEditTitle,message:"create"===n?t.cancelAddWarningMessage:t.cancelEditWarningMessage,options:[{label:"create"===n?t.continueAdding:t.continueEditing,type:"neutral",action:()=>this._prompt=null},{label:"create"===n?t.discardFeature:t.discardEdits,type:"negative",action:()=>{r(),this._prompt=null}}]}:r()}_assertActiveCreateWorkflow(){if("create"===this.viewModel.activeWorkflow.type)return this.viewModel.activeWorkflow;throw Error("Expected activeWorkflow to be a CreateWorkflow")}_assertActiveUpdateWorkflow(){if("update"===this.viewModel.activeWorkflow.type)return this.viewModel.activeWorkflow;throw Error("Expected activeWorkflow to be an UpdateWorkflow")}_assertActiveCreateOrUpdateWorklow(){switch(this.viewModel.activeWorkflow.type){case"create":case"update":return this.viewModel.activeWorkflow}throw Error("Expected activeWorkflow to be either CreateWorkflow or UpdateWorkflow")}};s([n()],Cn.prototype,"_attachments",void 0),s([c("viewModel.activeWorkflow")],Cn.prototype,"activeWorkflow",void 0),s([c("viewModel.allowedWorkflows")],Cn.prototype,"allowedWorkflows",void 0),s([n()],Cn.prototype,"headingLevel",void 0),s([n()],Cn.prototype,"iconClass",void 0),s([n({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],Cn.prototype,"label",void 0),s([c("viewModel.layerInfos")],Cn.prototype,"layerInfos",void 0),s([n(),g("esri/widgets/Editor/t9n/Editor")],Cn.prototype,"messages",void 0),s([n(),g("esri/t9n/common")],Cn.prototype,"messagesCommon",void 0),s([n(),g("esri/widgets/FeatureTemplates/t9n/FeatureTemplates")],Cn.prototype,"messagesTemplates",void 0),s([c("viewModel.snappingOptions")],Cn.prototype,"snappingOptions",void 0),s([n()],Cn.prototype,"supportingWidgetDefaults",void 0),s([c("viewModel.view")],Cn.prototype,"view",void 0),s([n(),Mt(["workflow-cancel","workflow-commit"])],Cn.prototype,"viewModel",void 0),s([Se()],Cn.prototype,"_handleDelete",null),s([Se()],Cn.prototype,"_handleAttachmentAdd",null),s([Se()],Cn.prototype,"_handleAttachmentUpdate",null),s([Se()],Cn.prototype,"_handleAttachmentDelete",null),s([Se()],Cn.prototype,"_handleAdd",null),s([Se()],Cn.prototype,"_handleEdit",null),s([Se()],Cn.prototype,"_handleDone",null),s([Se()],Cn.prototype,"_handleBack",null),Cn=s([r("esri.widgets.Editor")],Cn);const On=Cn;let Tn=class{constructor(i){t(this,i),this.loaded=e(this,"loaded",7),this.position="bottom-left"}validateAllowedWorkflows(t){t&&this.widget&&(this.widget.allowedWorkflows=t.split(","))}validateView(t){t&&(this.widget.view=t,"arcgis-expand"!==this.el.parentElement.tagName.toLowerCase()&&this.widget.view.ui.add(this.widget,this.position))}componentWillLoad(){const t={container:this.el};this.allowedWorkflows&&(t.allowedWorkflows=this.allowedWorkflows.split(",")),this.view&&(t.view=this.view);const e=new On(t);this.widget=e,this.loaded.emit(!0)}get el(){return i(this)}static get watchers(){return{allowedWorkflows:["validateAllowedWorkflows"],view:["validateView"]}}};Tn.style="@import url('https://js.arcgis.com/next/esri/themes/light/main.css');";export{Tn as A,Vs as a,Ts as b,ts as c,fs as d,qs as e,es as f,vs as g,Ki as h,Xs as i,wi as j,Qi as k,gs as l,os as m,ls as n,hs as o,Ce as p,us as q,Zi as r,js as s,ns as t,Ji as u,ds as v,Os as w,xs as x,Ws as y,ys as z}