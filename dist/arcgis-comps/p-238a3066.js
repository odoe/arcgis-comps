import{gB as t,a7 as e,gC as s,s as i,eO as n,g as r,dF as h,cP as o,W as a,dI as c,bS as u,al as l,gD as d,gl as f,dD as p,gE as y,gF as g,N as w,aq as m,dd as v,dJ as b,aN as _,gG as M,gH as S,gh as x,gI as k,T as F,bW as I,bX as q,dr as A,aH as C,H as R,ca as T,ge as j,e as E,i as O,d as P,gy as U,R as N,ax as D,bp as G,er as L,ad as z,cM as B,gs as $,gJ as V,gK as Q,cR as X,bR as Y,dN as H,gL as W,dS as J,dm as Z,gM as K,cC as tt,gN as et,gO as st,dM as it,F as nt,gP as rt,ed as ht,gQ as ot}from"./p-7b6f6c18.js";import{V as at}from"./p-4f06073a.js";import{r as ct,o as ut,l as lt}from"./p-f06d001b.js";import{s as dt}from"./p-ec834938.js";import{q as ft}from"./p-98d0801b.js";import{d as pt,u as yt,P as gt}from"./p-94807627.js";import{A as wt}from"./p-3e28396b.js";import{s as mt}from"./p-c3db99c7.js";import{f as vt,g as bt}from"./p-51e4508b.js";import{o as _t}from"./p-47e1bd73.js";import"./p-227a5838.js";import"./p-8ec48dc4.js";import"./p-06d309e6.js";import"./p-06787bff.js";import"./p-2c47064f.js";import"./p-a4c129b5.js";import"./p-761b5073.js";import"./p-a666c421.js";import"./p-804725e3.js";import"./p-1dd7027e.js";import"./p-10e211d9.js";import"./p-b392deaf.js";import"./p-df9635e1.js";import"./p-f78de11d.js";import"./p-50ff864e.js";const Mt=268435455;class St{constructor(){this.fieldMap=new Map,this.fields=[],this.hasFeatures=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.vertexCount=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}hasField(t){return this.fieldMap.has(t)}isDateField(t){var e;return null==(e=this.fieldMap.get(t))?void 0:e.isDate}getFieldIndex(t){var e;return null==(e=this.fieldMap.get(t))?void 0:e.index}}function xt(t){const e=t.getLength(),i=t.pos()+e,n={name:"",isDate:!1};for(;t.pos()<i&&t.next();)switch(t.tag()){case 1:n.name=t.getString();break;case 2:"esriFieldTypeDate"===s(t.getEnum())&&(n.isDate=!0);break;default:t.skip()}return n}function kt(t){return t.toLowerCase().trim()}function Ft(s,i,n=!1){const r=s.pos(),h=new St;let o=0,a=0,c=null,u=null,l=null,d=!1;for(;s.next();)switch(s.tag()){case 1:c=s.getString();break;case 3:u=s.getString();break;case 12:l=s.processMessage(t);break;case 9:if(h.exceededTransferLimit=s.getBool(),h.exceededTransferLimit){h.offsets.geometry=n?new Float64Array(8e3):new Int32Array(8e3),h.centroid=n?new Float64Array(16e3):new Int32Array(16e3);for(let t=0;t<h.centroid.length;t++)h.centroid[t]=Mt}break;case 13:{const t=xt(s),e=t.name,i=kt(t.name),n={fieldName:e,index:o++,isDate:t.isDate};h.fields.push(n),h.fieldMap.set(t.name,n),h.fieldMap.set(i,n);break}case 15:{const t=s.getLength(),e=s.pos()+t;if(!h.exceededTransferLimit){const t=h.centroid;h.offsets.geometry.push(0),t.push(Mt),t.push(Mt)}!d&&h.exceededTransferLimit&&(d=!0,h.offsets.attributes=n?new Float64Array(8e3*o):new Uint32Array(8e3*o));let r=a*o;for(;s.pos()<e&&s.next();)switch(s.tag()){case 1:{d?h.offsets.attributes[r++]=s.pos():h.offsets.attributes.push(s.pos());const t=s.getLength();s.skipLen(t);break}case 2:if(i){const t=s.getLength(),e=s.pos()+t;for(;s.pos()<e&&s.next();)switch(s.tag()){case 3:{s.getUInt32();const t=s.getSInt64(),e=s.getSInt64();h.centroid[2*a]=t,h.centroid[2*a+1]=e;break}default:s.skip()}}else{h.offsets.geometry[a]=s.pos();const t=s.getLength();h.vertexCount+=t,s.skipLen(t)}break;case 4:{const t=s.getLength(),e=s.pos()+t;for(;s.pos()<e&&s.next();)switch(s.tag()){case 3:{s.getUInt32();const t=s.getSInt64(),e=s.getSInt64();h.centroid[2*a]=t,h.centroid[2*a+1]=e;break}default:s.skip()}break}default:s.skip()}a++,h.hasFeatures=!0;break}default:s.skip()}const f=c||u;if(!f)throw new e("FeatureSet has no objectId or globalId field name");return h.featureCount=a,h.fieldCount=o,h.objectIdFieldIndex=h.getFieldIndex(f),h.transform=l,h.displayIds=new Uint32Array(h.featureCount),h.groupIds=new Uint16Array(h.featureCount),s.move(r),h}const It=i.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF"),qt=268435455,At={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},large:{delta:new Int32Array(128e3),decoded:new Int32Array(128e3)}};function Ct(t){return t<=At.small.delta.length?At.small:(t<=At.large.delta.length||(At.large.delta=new Int32Array(Math.round(1.25*t)),At.large.decoded=new Int32Array(Math.round(1.25*t))),At.large)}function Rt(t){try{const e=2,s=new u(new Uint8Array(t),new DataView(t));for(;s.next();){if(s.tag()===e)return Tt(s.getMessage());s.skip()}}catch(t){const s=new e("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:t});It.error(s)}return null}function Tt(t){for(;t.next();){if(1===t.tag())return t.getMessage();t.skip()}return null}function jt(t,e,s,i,n,r){return.5*Math.abs(t*i+s*r+n*e-t*r-s*e-n*i)}function Et(t,e,s,i){return 0==t*i-s*e&&t*s+e*i>0}class Ot extends wt{constructor(t,e,s,i){super(t),this._hasNext=!1,this._isPoints=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},this._geometryType=i,this._reader=e,this._header=s,this._hasNext=s.hasFeatures,this._isPoints="esriGeometryPoint"===i}static fromBuffer(t,e,s=!1){const i=Rt(t),n=Ft(i,"esriGeometryPoint"===e,s),r=wt.createInstance();return new Ot(r,i,n,e)}get geometryType(){return this._geometryType}get size(){return this._header.featureCount}get hasZ(){return!1}get hasM(){return!1}get stride(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}getSize(){return this.size}getQuantizationTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(t){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=t}getAttributeHash(){let t="";return this._header.fields.forEach((({index:e})=>{t+=this._readAttributeAtIndex(e)+"."})),t}getObjectId(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(t){this._header.displayIds[this._featureIndex]=t}getGroupId(){return this._header.groupIds[this._featureIndex]}setGroupId(t){this._header.groupIds[this._featureIndex]=t}readLegacyFeature(){if(void 0===this._cache.legacyFeature){var t;const e=this.readCentroid(),s={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:null!=(t=e&&{x:e.coords[0],y:e.coords[1]})?t:null};return this._cache.legacyFeature=s,s}return this._cache.legacyFeature}readOptimizedFeature(){if(void 0===this._cache.optFeature){const t=new n(this.readGeometry(),this.readAttributes(),this.readCentroid());return t.objectId=this.getObjectId(),t.displayId=this.getDisplayId(),this._cache.optFeature=t,t}return this._cache.optFeature}getXHydrated(){const t=this._header.centroid[2*this._featureIndex],e=this.getQuantizationTransform();return r(e)?t:t*e.scale[0]+e.translate[0]}getYHydrated(){const t=this._header.centroid[2*this._featureIndex+1],e=this.getQuantizationTransform();return r(e)?t:e.translate[1]-t*e.scale[1]}getX(){return this._header.centroid[2*this._featureIndex]*this._sx+this._tx}getY(){return this._header.centroid[2*this._featureIndex+1]*this._sy+this._ty}readLegacyPointGeometry(){return{x:this.getX(),y:this.getY()}}readLegacyGeometry(t){const e=this.readGeometry(t);return h(e,this.geometryType,!1,!1)}readLegacyCentroid(){const t=this.readCentroid();if(!t)return null;const[e,s]=t.coords;return{x:e,y:s}}readGeometryArea(){return this._cache.area||this.readGeometry(!0),this._cache.area}readUnquantizedGeometry(t=!1){if(void 0===this._cache.unquantGeometry){const e=this.readGeometry(t);if(!e)return this._cache.unquantGeometry=null,null;const s=Ct(e.coords.length).decoded,i=e.clone(s),n=i.coords;let r=0;for(const t of i.lengths){for(let e=1;e<t;e++){const t=2*(r+e),s=2*(r+e-1);n[t]+=n[s],n[t+1]+=n[s+1]}r+=t}return this._cache.unquantGeometry=i,i}return this._cache.unquantGeometry}readHydratedGeometry(){if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===qt)return null;const t=this.getXHydrated(),e=this.getYHydrated();return new o([],[t,e])}const t=this.readGeometry();if(!t)return null;const e=t.clone(),s=this.getQuantizationTransform();return a(s)&&c(e,e,this.hasZ,this.hasM,s),e}readGeometry(t=!1){if(void 0===this._cache.geometry){let e=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===qt)return null;const t=this.getX(),s=this.getY();e=new o([],[t,s])}else{const s=this._header.offsets.geometry[this._featureIndex],i=this._reader;if(0===s)return null;i.move(s);try{e=t?this._parseGeometryForDisplay(i):this._parseGeometry(i)}catch(t){return console.error("Failed to parse geometry!",t),null}}return this._cache.geometry=e,e}return this._cache.geometry}readCentroid(){if(void 0===this._cache.centroid){let t=null;const e=this._header.centroid[2*this._featureIndex]+this._tx,s=this._header.centroid[2*this._featureIndex+1]+this._ty;return e===qt?(t=this._computeCentroid(),t&&(this._header.centroid[2*this._featureIndex]=t.coords[0]-this._tx,this._header.centroid[2*this._featureIndex+1]=t.coords[1]-this._ty)):t=new o([],[e,s]),this._cache.centroid=t,t}return this._cache.centroid}copy(){const t=this._reader.clone(),e=new Ot(this.instance,t,this._header,this.geometryType);return this.copyInto(e),e}next(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this.size&&!this._getExists(););return this._featureIndex<this.size}_readAttribute(t,e){const s=this._header.hasField(t)?t:function(t){return t.toLowerCase().trim()}(t),i=this._header.getFieldIndex(s);if(null==i)return;const n=this._readAttributeAtIndex(i);return e?null==n?n:this._header.isDateField(s)?new Date(n):n:n}_readAttributes(){const t={};return this._header.fields.forEach((({fieldName:e,index:s})=>{t[e]=this._readAttributeAtIndex(s)})),t}copyInto(t){super.copyInto(t),t._featureIndex=this._featureIndex,t._featureOffset=this._featureOffset,t._hasNext=this._hasNext}_readAttributeAtIndex(t){const e=this._reader;return e.move(this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+t]),function(t){const e=t.getLength(),s=t.pos()+e;for(;t.pos()<s&&t.next();)switch(t.tag()){case 1:return t.getString();case 2:return t.getFloat();case 3:return t.getDouble();case 4:return t.getSInt32();case 5:return t.getUInt32();case 6:return t.getInt64();case 7:return t.getUInt64();case 8:return t.getSInt64();case 9:return t.getBool();default:return t.skip(),null}return null}(e)}_parseGeometry(t){const e=t.getLength(),s=t.pos()+e,i=[],n=[];for(;t.pos()<s&&t.next();)switch(t.tag()){case 2:{const e=t.getUInt32(),s=t.pos()+e;for(;t.pos()<s;)n.push(t.getUInt32());break}case 3:{const e=t.getUInt32(),s=t.pos()+e;for(i.push(t.getSInt32()+this._tx),i.push(t.getSInt32()+this._ty),this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32();t.pos()<s;)i.push(t.getSInt32()),i.push(t.getSInt32()),this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32();break}default:t.skip()}return new o(n,i)}_parseGeometryForDisplay(t){const e=t.getLength(),s=t.pos()+e,i=[],n=[];let r=0,h=0,a=null,c=0;const u="esriGeometryPolygon"===this.geometryType;for(;t.pos()<s&&t.next();)switch(t.tag()){case 2:{const e=t.getUInt32(),s=t.pos()+e;for(;t.pos()<s;){const e=t.getUInt32();i.push(e),r+=e}a=Ct(2*r).delta;break}case 3:{t.getUInt32();const e=2+(this.hasZ?1:0)+(this.hasM?1:0);for(const s of i)if(h+e*s>a.length)for(let e=0;e<s;e++)t.getSInt32(),t.getSInt32(),this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32();else if(u){const e=this.getAreaSimplificationThreshold(s,this._header.vertexCount);let i=2,r=1;const o=!1;let u=t.getSInt32(),l=t.getSInt32();a[h++]=u,a[h++]=l,this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32();let d=t.getSInt32(),f=t.getSInt32();for(this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32();i<s;){let s=t.getSInt32(),n=t.getSInt32();this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32();const o=u+d,p=l+f;jt(u,l,o,p,o+s,p+n)>=e?(c+=-.5*(o-u)*(p+l),r>1&&Et(a[h-2],a[h-1],d,f)?(a[h-2]+=d,a[h-1]+=f):(a[h++]=d,a[h++]=f,r++),u=o,l=p):(s+=d,n+=f),d=s,f=n,i++}r<3||o?h-=2*r:(c+=-.5*(u+d-u)*(l+f+l),Et(a[h-2],a[h-1],d,f)?(a[h-2]+=d,a[h-1]+=f,n.push(r)):(a[h++]=d,a[h++]=f,n.push(++r)))}else{let e=0,i=t.getSInt32(),r=t.getSInt32();this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32(),a[h++]=i,a[h++]=r,e+=1;for(let n=1;n<s;n++){const s=t.getSInt32(),o=t.getSInt32(),u=i+s,l=r+o;c+=-.5*(u-i)*(l+r),this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32(),n>2&&Et(a[h-2],a[h-1],s,o)?(a[h-2]+=s,a[h-1]+=o):(a[h++]=s,a[h++]=o,e+=1),i=u,r=l}n.push(e)}break}default:t.skip()}if(this._cache.area=c,!n.length)return null;if(this._tx||this._ty){let t=0;for(const e of n)a[2*t]+=this._tx,a[2*t+1]+=this._ty,t+=e}return new o(n,a)}}class Pt{constructor(t){this.service=t}destroy(){}}class Ut extends Pt{constructor(t){super(t),this._portsOpen=async function(t){const e=new g;return await e.open(t,{}),e}(t.source).then((t=>this.client=t))}destroy(){this.client.close(),this.client=null}async executeQuery(t,e){await this._portsOpen;const s=await this.client.invoke("queryFeatures",t.toJSON(),e);return pt.fromFeatureSet(s,this.service.objectIdField)}}class Nt extends Pt{async executeQuery(t,e){const{data:s}=await d(this.service.source,t,e);return Ot.fromBuffer(s,this.service.geometryType,!t.quantizationParameters)}}class Dt extends Pt{async executeQuery(t,e){const{source:s,capabilities:i,spatialReference:n,objectIdField:r,geometryType:h}=this.service;if(a(t.quantizationParameters)&&!i.query.supportsQuantization){const i=t.clone(),h=dt(w(i.quantizationParameters));i.quantizationParameters=null;const{data:o}=await f(s,i,n,e),a=p(o,r);return y(h,a),pt.fromOptimizedFeatureSet(a)}const{data:o}=await f(s,t,this.service.spatialReference,e);return"esriGeometryPoint"===h&&(o.features=o.features.filter((t=>{if(a(t.geometry)){const e=t.geometry;return Number.isFinite(e.x)&&Number.isFinite(e.y)}return!0}))),pt.fromFeatureSet(o,this.service.objectIdField)}}class Gt extends Pt{async executeQuery(t,e){const{capabilities:s}=this.service;if(t.quantizationParameters&&!s.query.supportsQuantization){const s=t.clone(),i=dt(w(s.quantizationParameters));s.quantizationParameters=null;const n=await ft(this.service.source,t,e);return y(i,n),pt.fromOptimizedFeatureSet(n)}const i=await ft(this.service.source,t,e);return pt.fromOptimizedFeatureSet(i)}}class Lt{constructor(){this.source=!1,this.targets={feature:!1,aggregate:!1},this.storage={filters:!1,data:!1},this.mesh=!1,this.queryFilter=!1,this.why={mesh:[],source:[]}}static create(t){const e=new Lt;for(const s in t){const i=t[s];if("object"==typeof i)for(const t in i)e[s][t]=i[t];e[s]=i}return e}static empty(){return Lt.create({})}static all(){return Lt.create({source:!0,targets:{feature:!0,aggregate:!0},storage:{filters:!0,data:!0},mesh:!0})}unset(t){t.source&&(this.source=!1),t.targets.feature&&(this.targets.feature=!1),t.targets.aggregate&&(this.targets.aggregate=!1),t.storage.filters&&(this.storage.filters=!1),t.storage.data&&(this.storage.data=!1),t.mesh&&(this.mesh=!1),t.queryFilter&&(this.queryFilter=!1)}any(){return this.source||this.mesh||this.storage.filters||this.storage.data||this.targets.feature||this.targets.aggregate||this.queryFilter}describe(){let t=0,e="";if(this.mesh){t+=20,e+="-> (20) Mesh needs update\n";for(const t of this.why.mesh)e+=`    + ${t}\n`}if(this.source){t+=10,e+="-> (10) The source needs update\n";for(const t of this.why.source)e+=`    + ${t}\n`}this.targets.feature&&(t+=5,e+="-> (5) Feature target parameters changed\n"),this.storage.filters&&(t+=5,e+="-> (5) Feature filter parameters changed\n"),this.targets.aggregate&&(t+=4,e+="-> (4) Aggregate target parameters changed\n"),this.storage.data&&(t+=1,e+="-> (1) Texture storage parameters changed"),console.debug(`Applying ${t<5?"Fastest":t<10?"Fast":t<15?"Moderate":t<20?"Slow":"Very Slow"} update of cost ${t}/45 `),console.debug(e)}toJSON(){return{queryFilter:this.queryFilter,source:this.source,targets:this.targets,storage:this.storage,mesh:this.mesh}}}class zt{constructor(t){this.requests={done:new Array,stream:new mt(10)},this._edits=null,this._abortController=new AbortController,this._done=!1,this.didSend=!1,this.tile=t}get signal(){return this._abortController.signal}get options(){return{signal:this._abortController.signal}}get empty(){return!this.requests.done.length}get edits(){return this._edits}get done(){return this._done}end(){this._done=!0}clear(){this.requests.done=[]}applyUpdate(t){this.requests.done.forEach((e=>e.message.status.unset(t))),a(this._edits)&&this._edits.status.unset(t)}add(t){var e;t.message.status=null!=(e=t.message.status)?e:Lt.empty(),t.message.end&&this.requests.done.forEach((t=>{a(t.message)&&t.message.end&&(t.message.end=!1)})),this.requests.done.push(t)}edit(t,e){const s=t.getQuantizationTransform(),i=t.geometryType,n=Array.from(t.features()),h=[...e,...n.map((t=>t.objectId))];this.removeIds(h),this._invalidate(),r(this._edits)?this._edits={type:"append",addOrUpdate:pt.fromOptimizedFeatures(n,i,w(s)),id:this.tile.id,status:Lt.empty(),end:!0}:(this.requests.done.forEach((t=>t.message.end=!1)),w(this._edits.addOrUpdate).append(t.features()))}*readers(){for(const{message:t}of this.requests.done)a(t.addOrUpdate)&&(yield t.addOrUpdate);a(this._edits)&&a(this._edits.addOrUpdate)&&(yield this._edits.addOrUpdate)}_invalidate(){for(const t of this.requests.done)t.message.status=Lt.empty();a(this._edits)&&(this._edits.status=Lt.empty())}removeIds(t){this._invalidate();for(const{message:e}of this.requests.done){const s=e.addOrUpdate;a(s)&&(s.removeIds(t),s.isEmpty&&(e.addOrUpdate=null))}a(this._edits)&&a(this._edits.addOrUpdate)&&this._edits.addOrUpdate.removeIds(t),this.requests.done=this.requests.done.filter((t=>t.message.addOrUpdate||t.message.end))}abort(){this._abortController.abort()}}class Bt{constructor(t){this.events=new m,this._resolver=v(),this._didEdit=!1,this._subscriptions=new Map,this._outSR=t.outSR,this._serviceInfo=t.serviceInfo,this._onTileUpdateMessage=t.onMessage}destroy(){}async _onMessage(t){var e;const s=this._subscriptions.get(t.id);if(!s)return;const i={...t,remove:null!=(e=t.remove)?e:[],status:t.status};return this._onTileUpdateMessage(i,s.options)}update(t,e){var s;const i=e.fields.length;e.outFields=function(t,e){const s=new Set;return t&&t.forEach((t=>s.add(t))),e&&e.forEach((t=>s.add(t))),s.has("*")?["*"]:Array.from(s)}(null==(s=this._schema)?void 0:s.outFields,e.outFields),e.outFields=e.outFields.length>=.75*i?["*"]:e.outFields,e.outFields.sort();const n=b(this._schema,e);if(!n)return;l("esri-2d-update-debug")&&console.debug("Applying Update - Source:",n);const r="orderByFields"in this._serviceInfo&&this._serviceInfo.orderByFields?this._serviceInfo.orderByFields:this._serviceInfo.objectIdField+" ASC",h={returnCentroid:l("esri-2d-query-centroid-enabled")&&"esriGeometryPolygon"===this._serviceInfo.geometryType,returnGeometry:!0,timeReferenceUnknownClient:"stream"!==this._serviceInfo.type&&this._serviceInfo.timeReferenceUnknownClient,outFields:e.outFields,outSpatialReference:this._outSR,orderByFields:[r],where:e.definitionExpression||"1=1",gdbVersion:e.gdbVersion,historicMoment:e.historicMoment,timeExtent:_.fromJSON(e.timeExtent),customParameters:e.customParameters},o=this._schema&&M(n,"outFields");this._schema&&S(n,["timeExtent","definitionExpression","gdbVersion","historicMoment","customParameters"])&&(t.why.mesh.push("Layer filter and/or custom parameters changed"),t.why.source.push("Layer filter and/or custom parameters changed"),t.mesh=!0,t.source=!0,t.queryFilter=!0),o&&(t.why.source.push("Layer required fields changed"),t.source=!0),b(h,this._queryInfo)&&(this._queryInfo=h),this._schema=e,this._resolver.resolve()}whenInitialized(){return this._resolver.promise}async applyUpdate(t){if(t.queryFilter||t.source&&this._didEdit)return this.refresh(),void(this._didEdit=!1);this._subscriptions.forEach((e=>e.applyUpdate(t))),await this.resend()}refresh(){for(const t of this._tiles())this.unsubscribe(t),this.subscribe(t)}subscribe(t){const e=new zt(t);this._subscriptions.set(t.id,e)}unsubscribe(t){const e=this.get(t.id);a(e)&&e.abort(),this._subscriptions.delete(t.id)}createQuery(t={}){const e=this._queryInfo.historicMoment?new Date(this._queryInfo.historicMoment):null;return new x({...this._queryInfo,historicMoment:e,...t})}get(t){return this._subscriptions.has(t)?this._subscriptions.get(t):null}async queryLastEditDate(){throw new Error("Service does not support query type")}async query(t){throw new Error("Service does not support query")}*_tiles(){const t=Array.from(this._subscriptions.values());for(const e of t)yield e.tile}async edit(t,e){const s=Array.from(this._subscriptions.values()),i=s.map((({tile:t})=>t));for(const t of s)t.removeIds(e);if(t.length){const s=i.map((e=>{const s=this.createTileQuery(e);return s.objectIds=t,{tile:e,query:s}})).map((async({tile:t,query:e})=>({tile:t,result:await this.query(e),query:e}))),n=(await k(s)).map((async({tile:s,result:i})=>{if(!i.hasFeatures&&!e.length&&!t.length)return;const n=this._subscriptions.get(s.key.id);n&&n.edit(i,t)}));await F(n)}this._didEdit=!0}}const $t=i.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource");class Vt extends Bt{constructor(t){super(t),this.type="feature",this.mode="on-demand",this._adapter=function(t){const{capabilities:e}=t;return function(t){return t&&t.capabilities&&t.collection&&t.layerDefinition}(t.source)?new Gt(t):function(t){return Array.isArray(t.source)}(t)?new Ut(t):e.query.supportsFormatPBF&&l("featurelayer-pbf")?new Nt(t):new Dt(t)}(t.serviceInfo),this._queue=new I({concurrency:8,process:async t=>{if(q(t),a(t.tile)){const e=t.tile.key.id,{signal:s}=t,i=l("esri-tiles-debug")?{tile:e.replace(/\//g,"."),depth:t.depth}:void 0,n=await this._adapter.executeQuery(t.query,{signal:s,query:{...i,...this._schema.customParameters}});return n.level=t.tile.key.level,n}return this._adapter.executeQuery(t.query,{...t,query:this._schema.customParameters})}}),this._patchQueue=new I({concurrency:8,process:async t=>{if(q(t),a(t.tile)){const e=t.tile.key.id,{signal:s}=t,i=l("esri-tiles-debug")?{tile:e.replace(/\//g,"."),depth:t.depth}:void 0,n=await this._adapter.executeQuery(t.query,{signal:s,query:{...i,...this._schema.customParameters}});return n.level=t.tile.key.level,n}return this._adapter.executeQuery(t.query,{...t,query:this._schema.customParameters})}})}destroy(){super.destroy(),this._adapter.destroy(),this._queue.destroy(),this._patchQueue.destroy()}get updating(){return!!this._queue.length||Array.from(this._subscriptions.values()).some((t=>!t.done))}get maxRecordCountFactor(){const{query:t}=this._serviceInfo.capabilities;return t.supportsMaxRecordCountFactor?4:null}get maxPageSize(){var t;const{query:e}=this._serviceInfo.capabilities;return(null!=(t=e.maxRecordCount)?t:8e3)*A(this.maxRecordCountFactor,1)}get pageSize(){return Math.min(8e3,this.maxPageSize)}enableEvent(t,e){}subscribe(t){super.subscribe(t);const s=this._subscriptions.get(t.id);this._fetchDataTile(t).catch((s=>{C(s)||$t.error(new e("mapview-query-error","Encountered error when fetching tile",{tile:t,error:s}))})).then((()=>s.end()))}unsubscribe(t){super.unsubscribe(t)}readers(t){return this._subscriptions.get(t).readers()}async query(t){return this._adapter.executeQuery(t,{query:this._schema.customParameters})}async queryLastEditDate(){const t=this._serviceInfo.source,e={...t.query,f:"json"};return(await R(t.path,{query:e,responseType:"json"})).data.editingInfo.lastEditDate}createTileQuery(t,e={}){var s;const i=this.createQuery(e);return i.quantizationParameters=null!=(s=e.quantizationParameters)?s:t.getQuantizationParameters(),i.resultType="tile",i.geometry=t.extent,i.quantizationParameters&&"esriGeometryPolyline"===this._serviceInfo.geometryType&&(i.maxAllowableOffset=t.resolution),i}async _executePatchQuery(t,e,s,i){const n=e.clone();n.outFields=[this._serviceInfo.objectIdField,...s],n.returnCentroid=!1,n.returnGeometry=!1;const r=a(n.start)?n.start/8e3:0;return this._patchQueue.push({tile:t,query:n,signal:i.signal,depth:r})}async _resend(t,e){const{query:s,message:i}=t,n=a(s.outFields)?s.outFields:[],h=this._queryInfo.outFields,o=h.filter((t=>-1===n.indexOf(t)));if(r(i.addOrUpdate))this._onMessage({...i,type:"append"});else if(o.length)try{const t=this._subscriptions.get(i.id).tile,n=await this._executePatchQuery(t,s,o,e);q(e),s.outFields=h,i.addOrUpdate.joinAttributes(n),this._onMessage({...i,end:i.end,type:"append"})}catch(t){}else this._onMessage({...i,type:"append"})}async _resendSubscription(t){if(t.empty)return this._onMessage({id:t.tile.id,addOrUpdate:null,end:!1,type:"append"});const e=t.signal;for(const s of t.requests.done)await this._resend(s,{signal:e});return a(t.edits)?this._onMessage(t.edits):void 0}async resend(){const t=Array.from(this._subscriptions.values());await Promise.all(t.map((t=>this._resendSubscription(t))))}}const Qt=l("esri-mobile"),Xt={maxDrillLevel:Qt?1:4,maxRecordCountFactor:Qt?1:3};class Yt extends Vt{constructor(t){super(t)}async _fetchDataTile(t){const e=this._serviceInfo.capabilities.query.supportsMaxRecordCountFactor,s=this._subscriptions.get(t.key.id),i=s.signal,n=t.getQuantizationParameters();let r=0;const h=async(o,a)=>{const c=this._queryInfo,u=this.createTileQuery(o,{maxRecordCountFactor:e?Xt.maxRecordCountFactor:void 0,returnExceededLimitFeatures:!1,quantizationParameters:n});r++;try{const e=await this._queue.push({tile:t,query:u,signal:i,depth:a});if(r--,q(i),!e)return;if(c!==this._queryInfo)return void h(o,a);if(e.exceededTransferLimit&&a<Xt.maxDrillLevel){for(const t of o.createChildTiles())h(t,a+1);return}const n={id:t.id,addOrUpdate:e,end:0===r,type:"append"};s.add({query:u,message:n}),this._onMessage(n)}catch(e){C(e)||this._onMessage({id:t.id,addOrUpdate:null,end:!0,type:"append"})}};h(t,0)}}const Ht="__esri_timestamp__";class Wt{constructor(t,e,s,i,n=128){this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=s,this._purgeOptions=i,this.store=t,this.objectIdField=e,this.purgeInterval=n,this._useGeneratedIds="__esri_stream_id__"===this.objectIdField}add(t){if(this._useGeneratedIds){const e=this._nextId();t.attributes[this.objectIdField]=e,t.objectId=e}else t.objectId=t.attributes[this.objectIdField];if(this._addOrUpdated.set(t.objectId,t),this._maxAge=Math.max(this._maxAge,t.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return r(this._trackIdLessObservations)&&(this._trackIdLessObservations=new mt(1e5)),void this._trackIdLessObservations.enqueue(t.objectId);const e=t.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(e)){const t=a(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:1e3,s=T(t,0,1e3);this._trackIdToObservations.set(e,new mt(s))}const s=this._trackIdToObservations.get(e).enqueue(t.objectId);a(s)&&(this._addOrUpdated.has(s)?this._addOrUpdated.delete(s):this._removed.push(s))}checkForUpdates(){const t=this._getToAdd(),e=this._getToRemove(),s=performance.now();s-this._lastPurge>=this.purgeInterval&&(this._purge(s),this._lastPurge=s);const i=[];if(a(e))for(const t of e){const e=this.store.removeById(t);a(e)&&i.push(e)}if(a(t))for(const e of t)e.attributes[Ht]=s,this.store.add(e);(t||i)&&this.store.update(t,i)}_getToAdd(){if(!this._addOrUpdated.size)return null;const t=new Array(this._addOrUpdated.size);let e=0;return this._addOrUpdated.forEach((s=>t[e++]=s)),this._addOrUpdated.clear(),t}_getToRemove(){const t=this._removed;return this._removed.length?(this._removed=[],t):null}_nextId(){const t=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,t}_purge(t){const e=this._purgeOptions;a(e)&&(this._purgeSomeByDisplayCount(e),this._purgeByAge(e),this._purgeByAgeReceived(t,e),this._purgeTracks())}_purgeSomeByDisplayCount(t){if(!t.displayCount)return;let e=this.store.size;if(e>t.displayCount){if(this._timeInfo.trackIdField)for(const s of this._trackIdToObservations.values())if(e>t.displayCount&&s.size){const t=w(s.dequeue());this._removed.push(t),e--}if(a(this._trackIdLessObservations)){let s=e-t.displayCount;for(;s-- >0;){const t=this._trackIdLessObservations.dequeue();a(t)&&this._removed.push(t)}}}}_purgeByAge(t){var e;if(!t.age||null==(e=this._timeInfo)||!e.startTimeField)return;const s=this._maxAge-60*t.age*1e3;this.store.forEach((t=>{t.attributes[this._timeInfo.startTimeField]<s&&this._removed.push(t.objectId)}))}_purgeByAgeReceived(t,e){if(!e.ageReceived)return;const s=t-60*e.ageReceived*1e3;this.store.forEach((t=>{t.attributes[Ht]<s&&this._removed.push(t.objectId)}))}_purgeTracks(){this._trackIdToObservations.forEach(((t,e)=>{0===t.size&&this._trackIdToObservations.delete(e)}))}}let Jt=class extends(m.EventedMixin(j)){onFeature(t){this.emit("feature",t)}};Jt=E([O("esri.layers.graphics.sources.connections.StreamConnection")],Jt);const Zt=Jt,Kt=i.getLogger("esri.layers.graphics.sources.connections.WebSocketConnection");var te;!function(t){t[t.CONNECTING=0]="CONNECTING",t[t.OPEN=1]="OPEN",t[t.CLOSING=2]="CLOSING",t[t.CLOSED=3]="CLOSED"}(te||(te={}));let ee=class extends Zt{constructor(t){super(),this.errorString=null;const{geometryType:e,spatialReference:s,sourceSpatialReference:i}=t;this._config=t,this._featureZScaler=U(e,i,s),this._open()}async _open(){await this._tryCreateWebSocket(),this.destroyed||await this._handshake()}destroy(){a(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if(r(this._websocket))return"disconnected";switch(this._websocket.readyState){case te.CONNECTING:case te.OPEN:return"connected";case te.CLOSING:case te.CLOSED:return"disconnected"}}async _tryCreateWebSocket(t=this._config.source.path,s=1e3,i=0){try{if(this.destroyed)return;const e=N(t,this._config.customParameters);this._websocket=await this._createWebSocket(e),this.notifyChange("connectionStatus")}catch(n){const r=s/1e3;return this._config.maxReconnectionAttempts&&i>=this._config.maxReconnectionAttempts?(Kt.error(new e("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()):(Kt.error(new e("websocket-connection",`Failed to connect. Attempting to reconnect in ${r}s`,n)),await D(s),this._tryCreateWebSocket(t,Math.min(1.5*s,1e3*this._config.maxReconnectionInterval),i+1))}}_createWebSocket(t){return new Promise(((e,s)=>{const i=new WebSocket(t);i.onopen=()=>{if(i.onopen=null,this.destroyed)return i.onclose=null,void i.close();i.onclose=t=>this._onClose(t),i.onerror=t=>this._onError(t),i.onmessage=t=>this._onMessage(t),e(i)},i.onclose=t=>{i.onopen=i.onclose=null,s(t)}}))}async _handshake(t=1e4){const s=this._websocket;if(r(s))return;const i=v(),n=s.onmessage,{filter:h,outFields:o,spatialReference:a}=this._config;return i.timeout(t),s.onmessage=t=>{var r;let c=null;try{c=JSON.parse(t.data)}catch(t){}c&&"object"==typeof c||(Kt.error(new e("websocket-connection","Protocol violation. Handshake failed - malformed message",t.data)),i.reject(),this.destroy()),(null==(r=c.spatialReference)?void 0:r.wkid)!==(null==a?void 0:a.wkid)&&(Kt.error(new e("websocket-connection",`Protocol violation. Handshake failed - expected wkid of ${a.wkid}`,t.data)),i.reject(),this.destroy()),"json"!==c.format&&(Kt.error(new e("websocket-connection","Protocol violation. Handshake failed - format is not set",t.data)),i.reject(),this.destroy()),h&&c.filter!==h&&Kt.error(new e("websocket-connection","Tried to set filter, but server doesn't support it")),o&&c.outFields!==o&&Kt.error(new e("websocket-connection","Tried to set outFields, but server doesn't support it")),s.onmessage=n,i.resolve()},s.send(JSON.stringify({filter:h,outFields:o,format:"json",spatialReference:{wkid:a.wkid}})),i.promise}_onMessage(t){try{const s=JSON.parse(t.data);if("featureResult"!==s.type)throw new e("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",s);for(const t of s.features)a(this._featureZScaler)&&this._featureZScaler(t.geometry),this.onFeature(t)}catch(t){return Kt.error(new e("websocket-connection","Failed to parse message",t)),void this.destroy()}}_onError(t){const e="Encountered an error over WebSocket connection";this._set("errorString",e),Kt.error("websocket-connection",e)}_onClose(t){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==t.code&&Kt.error("websocket-connection",`WebSocket closed unexpectedly with error code ${t.code}`),this.destroyed||this._open()}};E([P()],ee.prototype,"connectionStatus",null),E([P()],ee.prototype,"errorString",void 0),ee=E([O("esri.layers.graphics.sources.connections.WebSocketConnection")],ee);const se=i.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),ie={maxQueryDepth:5,maxRecordCountFactor:3};let ne=class extends ee{constructor(t){super({...ie,...t})}async _open(){const t=await this._fetchServiceDefinition(this._config.source);t.timeInfo.trackIdField||se.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");const e=this._fetchWebSocketUrl(t.streamUrls,this._config.spatialReference);this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),await this._buddyServicesQuery,await this._tryCreateWebSocket(e);const{filter:s,outFields:i}=this._config;this.destroyed||this._setFilter(s,i)}_onMessage(t){let s;try{s=this._enrich(JSON.parse(t.data)),a(this._featureZScaler)&&this._featureZScaler(s.geometry)}catch(t){return void se.error(new e("geoevent-connection","Failed to parse message",t))}this.onFeature(s)}async _fetchServiceDefinition(t){const e={f:"json",...this._config.customParameters},s=R(t.path,{query:e,responseType:"json"}),i=(await s).data;return this._serviceDefinition=i,i}_fetchWebSocketUrl(t,e){const s=t[0],{urls:i,token:n}=s,r=this._inferWebSocketBaseUrl(i);return N(`${r}/subscribe`,{outSR:""+e.wkid,token:n})}_inferWebSocketBaseUrl(t){if(1===t.length)return t[0];for(const e of t)if(-1!==e.indexOf("wss"))return e;return se.error(new e("geoevent-connection","Unable to infer WebSocket url",t)),null}async _setFilter(t,s){const i=this._websocket;if(r(i)||r(t)&&r(s))return;const n=JSON.stringify({filter:this._serializeFilter(t,s)});let h=!1;const o=v();return i.onmessage=t=>{const s=JSON.parse(t.data);s.filter&&(s.error&&(se.error(new e("geoevent-connection","Failed to set service filter",s.error)),this._set("errorString",`Could not set service filter - ${s.error}`),o.reject(s.error)),i.onmessage=this._onMessage.bind(this),h=!0,o.resolve())},i.send(n),setTimeout((()=>{h||(this.destroyed||this._websocket!==i||se.error(new e("geoevent-connection","Server timed out when setting filter")),o.reject())}),1e4),o.promise}_serializeFilter(t,s){const i={};if(r(t)&&r(s))return i;if(a(t)&&t.geometry)try{const s=G(t.geometry);if("extent"!==s.type)throw new e(`Expected extent but found type ${s.type}`);i.geometry=JSON.stringify(s.shiftCentralMeridian())}catch(t){se.error(new e("geoevent-connection","Encountered an error when setting connection geometryDefinition",t))}return a(t)&&t.where&&"1 = 1"!==t.where&&(i.where=t.where),a(s)&&(i.outFields=s.join(",")),i}_enrich(t){if(!this._relatedFeatures)return t;const s=t.attributes[this._serviceDefinition.relatedFeatures.joinField];if(!this._relatedFeatures.has(s))return se.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",t),t;const{attributes:i,geometry:n}=this._relatedFeatures.get(s);for(const e in i)t.attributes[e]=i[e];return n&&(t.geometry=n),t.geometry||t.centroid||se.error(new e("geoevent-connection","Found malformed feature - no geometry found",t)),t}async _queryBuddyServices(){try{const{relatedFeatures:t,keepLatestArchive:e}=this._serviceDefinition,s=this._queryRelatedFeatures(t),i=this._queryArchive(e);await s;const n=await i;if(!n)return;for(const t of n.features)this.onFeature(this._enrich(t))}catch(t){se.error(new e("geoevent-connection","Encountered an error when querying buddy services",{error:t}))}}async _queryRelatedFeatures(t){if(!t)return;const e=await this._queryBuddy(t.featuresUrl);this._addRelatedFeatures(e)}async _queryArchive(t){if(t)return this._queryBuddy(t.featuresUrl)}async _queryBuddy(t){const e=new((await import("./p-7b6f6c18.js").then((function(t){return t.ki}))).default)({url:t}),{capabilities:s}=await e.load(),i=s.query.supportsMaxRecordCountFactor,n=s.query.supportsPagination,r=s.query.supportsCentroid,h=this._config.maxRecordCountFactor,o=e.capabilities.query.maxRecordCount,a=i?o*h:o,c=new x;if(c.outFields=A(this._config.outFields,["*"]),c.where=A(L(this._config.filter,"where"),"1=1"),c.returnGeometry=!0,c.returnExceededLimitFeatures=!0,c.outSpatialReference=z.fromJSON(this._config.spatialReference),r&&(c.returnCentroid=!0),i&&(c.maxRecordCountFactor=h),n)return c.num=a,e.destroy(),this._queryPages(t,c);const u=await f(t,c,this._config.sourceSpatialReference);return e.destroy(),u.data}async _queryPages(t,e,s=[],i=0){e.start=a(e.num)?i*e.num:null;const{data:n}=await f(t,e,this._config.sourceSpatialReference);return n.exceededTransferLimit&&i<this._config.maxQueryDepth?(n.features.forEach((t=>s.push(t))),this._queryPages(t,e,s,i+1)):(s.forEach((t=>n.features.push(t))),n)}_addRelatedFeatures(t){const e=new Map,s=t.features,i=this._serviceDefinition.relatedFeatures.joinField;for(const t of s)e.set(t.attributes[i],t);this._relatedFeatures=e}};ne=E([O("esri.layers.graphics.sources.connections.GeoEventConnection")],ne);const re=ne;function he(t,e){const s=t.weakClone();if(a(t.geometry)){const i=V(e,t.geometry.coords[0]),n=Q(e,t.geometry.coords[1]);s.geometry=new o([],[i,n])}return s}class oe{constructor(t,e){this.onUpdate=t,this._geometryType=e,this._objectIdToFeature=new Map}get _features(){const t=[];return this._objectIdToFeature.forEach((e=>t.push(e))),t}add(t){this._objectIdToFeature.set(t.objectId,t),this._index=null}get(t){return this._objectIdToFeature.has(t)?this._objectIdToFeature.get(t):null}forEach(t){this._objectIdToFeature.forEach(t)}search(t){return this._index||(this._index=function(t,e){const s=X(9,"esriGeometryPoint"===e?t=>a(t.geometry)?{minX:t.geometry.coords[0],minY:t.geometry.coords[1],maxX:t.geometry.coords[0],maxY:t.geometry.coords[1]}:{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}:t=>{let e=1/0,s=1/0,i=-1/0,n=-1/0;return a(t.geometry)&&t.geometry.forEachVertex(((t,r)=>{e=Math.min(e,t),s=Math.min(s,r),i=Math.max(i,t),n=Math.max(n,r)})),{minX:e,minY:s,maxX:i,maxY:n}});return s.load(t),s}(this._features,this._geometryType)),function(t,e){return t.search({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]})}(this._index,t)}removeById(t){const e=this._objectIdToFeature.get(t);return e?(this._objectIdToFeature.delete(t),this._index=null,e):null}update(t,e){this.onUpdate(t,e)}get size(){return this._objectIdToFeature.size}}class ae extends Bt{constructor(t){super(t),this.type="geoevent",this._dataReceiveEventEnabled=!1,this._level=0,this._updateInfo={websocket:0,client:0};const{outSR:e}=t,{geometryType:s,objectIdField:i,timeInfo:n,purgeOptions:r,source:h,spatialReference:a,serviceFilter:c,maxReconnectionAttempts:u,maxReconnectionInterval:l,updateInterval:d,enableDataReceived:f,customParameters:p}=t.serviceInfo,y=new oe(this._onUpdate.bind(this),s),g=new Wt(y,i,n,r),w=function(t,e,s,i,n,r,h,o){const a=0===t.path.indexOf("wss://")||0===t.path.indexOf("ws://"),c={source:t,sourceSpatialReference:e,spatialReference:s,geometryType:i,filter:n,maxReconnectionAttempts:r,maxReconnectionInterval:h,customParameters:o};return a?new ee(c):new re(c)}(h,a,e,s,c,u,l,p);this._store=y,this._manager=g,this._connection=w,this._quantize=function(t){return"esriGeometryPoint"===t?he:(e,s)=>{const i=e.weakClone(),n=new o,r=B(n,e.geometry,!1,!1,t,s,!1,!1);return i.geometry=r,i}}(s),this._dataReceiveEventEnabled=f,this._handles=[this._connection.on("feature",(t=>this._onFeature(t))),this._connection.watch("connectionStatus",(t=>this.events.emit("connectionStatus",t))),this._connection.watch("errorString",(t=>this.events.emit("errorString",t)))];let m=performance.now();this._updateIntervalId=setInterval((()=>{const e=performance.now(),s=e-m;if(s>2500){m=e;const t=Math.round(this._updateInfo.client/(s/1e3)),i=Math.round(this._updateInfo.websocket/(s/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.events.emit("updateRate",{client:t,websocket:i})}t.canAcceptRequest()&&this._manager.checkForUpdates()}),d)}destroy(){super.destroy(),clearInterval(this._updateIntervalId),this._handles.forEach((t=>t.remove())),this._connection.destroy()}_fetchDataTile(){}resume(){}enableEvent(t,e){"data-received"===t&&(this._dataReceiveEventEnabled=e)}get updating(){return!1}subscribe(t){super.subscribe(t);const e=this._subscriptions.get(t.id);this._level=t.level;const s=this._getTileFeatures(t);this._onMessage({type:"append",id:t.key.id,addOrUpdate:s,end:!0}),e.didSend=!0}unsubscribe(t){super.unsubscribe(t)}*readers(t){const e=this._subscriptions.get(t),{tile:s}=e;yield this._getTileFeatures(s);for(const t of e.requests.stream.entries)a(t)&&a(t.addOrUpdate)&&(yield t.addOrUpdate)}createTileQuery(t){throw new Error("Service does not support tile  queries")}async resend(){this._subscriptions.forEach((t=>{const{tile:e}=t,s={type:"append",id:e.id,addOrUpdate:this._getTileFeatures(e),end:!0};this._onMessage(s)}))}_getTileFeatures(t){const e=this._store.search(t).map((e=>this._quantize(e,t.transform)));return pt.fromOptimizedFeatures(e,this._serviceInfo.geometryType,t.transform)}_onFeature(t){this._updateInfo.websocket++;try{this._dataReceiveEventEnabled&&this.events.emit("feature",t);const e=$(t,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(e)}catch(t){}}_onUpdate(t,e){a(t)&&(this._updateInfo.client+=t.length),this._subscriptions.forEach(((t,e)=>{t.didSend&&t.tile.level===this._level&&this._onMessage({type:"append",id:e,addOrUpdate:null,clear:!0,end:!1})})),this._subscriptions.forEach(((t,e)=>{if(!t.didSend||t.tile.level!==this._level)return;const s={type:"append",id:e,addOrUpdate:this._getTileFeatures(t.tile),remove:[],end:!0,status:Lt.empty()};t.requests.stream.enqueue(s),this._onMessage(s)}))}}const ce=i.getLogger("esri.views.2d.layers.features.sources.FeatureSource");class ue extends Vt{constructor(t){super(t)}async _fetchDataTile(t){const s=this._subscriptions.get(t.key.id);let i=!1,n=0,r=0;const h=(e,n)=>{r--,q(s);const h=t.id,o=e.reader,a=e.query;if(!o.exceededTransferLimit){if(i=!0,0!==n&&!o.hasFeatures){const t={id:h,addOrUpdate:o,end:0===r,type:"append"};return s.add({message:t,query:a}),void this._onMessage(t)}const t={id:h,addOrUpdate:o,end:0===r,type:"append"};return s.add({message:t,query:a}),void this._onMessage(t)}const c={id:h,addOrUpdate:o,end:i&&0===r,type:"append"};s.add({message:c,query:a}),this._onMessage(c)};let o=0,a=0;for(;!i&&a++<20;){let a;for(let c=0;c<o+1;c++){const o=n++;r++,a=this._fetchDataTilePage(t,o,s).then((t=>t&&h(t,o))).catch((s=>{i=!0,C(s)||(ce.error(new e("mapview-query-error","Encountered error when fetching tile",{tile:t,error:s})),this._onMessage({id:t.id,addOrUpdate:null,end:i,type:"append"}))}))}await a,q(s),o=Math.min(o+2,6)}}async _fetchDataTilePage(t,e,s){const i=this._queryInfo,n={start:this.pageSize*e,num:this.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:t.getQuantizationParameters()};a(this.maxRecordCountFactor)&&(n.maxRecordCountFactor=this.maxRecordCountFactor);const r=this.createTileQuery(t,n);try{const n=s.signal,h=await this._queue.push({tile:t,query:r,signal:n,depth:e});return q(s),h?i!==this._queryInfo?this._fetchDataTilePage(t,e,s):{reader:h,query:r}:null}catch(t){return Y(t),null}}}const le=i.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource");function de(t,e,s){const i=t.getXHydrated(),n=t.getYHydrated(),r=e.getColumnForX(i),h=Math.floor(e.normalizeCol(r));return`${s}/${Math.floor(e.getRowForY(n))}/${h}`}function fe(t,e){if(r(t))return null;const s=e.transform,i=t.getQuantizationTransform();if(r(i)){const[e,i]=s.scale,[n,r]=s.translate;return t.transform(-n/e,r/i,1/e,1/-i)}const[n,h]=i.scale,[o,a]=i.translate,[c,u]=s.scale,[l,d]=s.translate;return t.transform((o-l)/c,(-a+d)/u,n/c,h/u)}class pe extends Vt{constructor(t){super(t),this.mode="snapshot",this._loading=!0,this._controller=new AbortController,this._downloadPromise=null,this._didSendEnd=!1,this._queries=new Array,this._invalidated=!1,this._hasAggregates=!1,this._random=new H(1e3),this._featureCount=t.featureCount,this._store=t.store,this._markedIdsBufId=this._store.storage.createBitset()}destroy(){super.destroy(),this._controller.abort()}get loading(){return this._loading}get _signal(){return this._controller.signal}update(t,e){super.update(t,e),this._hasAggregates=t.targets.aggregate}async resend(t=!1){if(await this._downloadPromise,this._invalidated||t)return this._invalidated=!1,this._subscriptions.forEach((t=>t.clear())),this._downloadPromise=this._download(this._featureCount),void await this._downloadPromise;const e=this._queries.map((({query:t,reader:e})=>this._sendPatchQuery(t,e)));await Promise.all(e),this._subscriptions.forEach((t=>{t.requests.done.forEach((t=>this._onMessage(t.message)))}))}async refresh(){await this.resend(!0)}async _sendPatchQuery(t,e){const s=a(t.outFields)?t.outFields:[],i=this._queryInfo.outFields,n=i.filter((t=>-1===s.indexOf(t)));if(!n.length)return;const r=t.clone(),h=this._signal;r.returnGeometry=!1,r.returnCentroid=!1,r.outFields=n,t.outFields=i;const o=await this._queue.push({query:r,depth:0,signal:h});q({signal:h}),e.joinAttributes(o)}async _fetchDataTile(t){this._downloadPromise||(this._downloadPromise=this._download(this._featureCount));const e=this._store.search(t),s=this._subscriptions.get(t.key.id),i=e.length-1;for(let n=0;n<i;n++){const i=fe(e[n],t),r={type:"append",id:t.id,addOrUpdate:i,end:!1,status:Lt.empty()};s.add({query:null,message:r}),this._hasAggregates||await D(1),this._onMessage(r)}const n=fe(i>=0?e[i]:null,t),r={type:"append",id:t.id,addOrUpdate:n,end:this._didSendEnd,status:Lt.empty()};s.add({query:null,message:r}),this._onMessage(r)}async _download(t){try{await this.whenInitialized();const e=this._store.storage.getBitset(this._markedIdsBufId),s=new Set;e.clear();const i=Math.ceil(t/this.pageSize),n=Array.from({length:i},((t,e)=>e)).sort((()=>this._random.getInt()-this._random.getInt())).map((t=>this._downloadPage(t,e,s)));await Promise.all(n),this._store.sweepFeatures(e,this._store.storage),this._store.sweepFeatureSets(s)}catch(t){le.error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",t)}this._sendEnd(),this._loading=!1}async _downloadPage(t,e,s){const i=this.pageSize,n={start:t*i,num:i,cacheHint:!0};a(this.maxRecordCountFactor)&&(n.maxRecordCountFactor=this.maxRecordCountFactor);const r=this.createQuery(n),h=this._signal,o=await this._queue.push({query:r,depth:t,signal:h});q({signal:h}),this._queries.push({query:r,reader:o}),this._store.insert(o),s.add(o.instance);const c=o.getCursor();for(;c.next();)e.set(c.getDisplayId());this._send(o)}_send(t){if(!this._subscriptions.size)return;let e=null;const s=new Map,i=new Set,n=new Map;this._subscriptions.forEach((t=>{var r;const h=t.tile;s.set(h.key.id,null),e=h.tileInfoView,i.add(h.level);const{row:o,col:a}=h.key,c=`${h.level}/${o}/${a}`,u=null!=(r=n.get(c))?r:[];u.push(t),n.set(c,u)}));for(const h of i){const i=e.getLODInfoAt(h),o=t.getCursor();for(;o.next();){const t=de(o,i,h),e=o.getIndex();if(n.has(t))for(const i of n.get(t)){const t=i.tile.id;let n=s.get(t);r(n)&&(n=[],s.set(t,n)),n.push(e)}}}s.forEach(((e,s)=>{if(a(e)){const i=this._subscriptions.get(s),n={type:"append",id:s,addOrUpdate:fe(ct.from(t,e),i.tile),end:!1,status:Lt.empty()};i.add({query:null,message:n}),this._onMessage(n)}}))}_sendEnd(){this._subscriptions.forEach((t=>{const e={type:"append",id:t.tile.id,addOrUpdate:null,end:!0,status:Lt.empty()};t.add({query:null,message:e}),this._onMessage(e)})),this._didSendEnd=!0}}function ye(t,e,s,i){i%2&&(i+=1);let n=0,r=0,h=-90,o=90,a=-180,c=180;for(let t=0;t<i/2;t++){for(let e=0;e<5;e++){const i=(a+c)/2,r=s>i?1:0;n|=r<<29-(e+5*t),a=(1-r)*a+r*i,c=(1-r)*i+r*c}for(let s=0;s<5;s++){const i=(h+o)/2,n=e>i?1:0;r|=n<<29-(s+5*t),h=(1-n)*h+n*i,o=(1-n)*i+n*o}}t.geohashX=n,t.geohashY=r}function ge(t,e,s,i,n){n%2&&(n+=1);let r=0,h=0,o=-90,a=90,c=-180,u=180;for(let t=0;t<n/2;t++){for(let e=0;e<5;e++){const s=(c+u)/2,n=i>s?1:0;r|=n<<29-(e+5*t),c=(1-n)*c+n*s,u=(1-n)*s+n*u}for(let e=0;e<5;e++){const i=(o+a)/2,n=s>i?1:0;h|=n<<29-(e+5*t),o=(1-n)*o+n*i,a=(1-n)*i+n*a}}t[2*e]=r,t[2*e+1]=h}class we{constructor(t=[],e=8096){this._nodes=0,this._root=new me(0,0,0),this._statisticFields=t,this._pool=e?new mt(8096):null}_acquire(t,e,s){this._nodes++;let i=null;return a(this._pool)&&(i=this._pool.dequeue()),a(i)?i.realloc(t,e,s):new me(t,e,s)}_release(t){this._nodes--,a(this._pool)&&this._pool.enqueue(t)}get count(){return this._root.count}get size(){return this._nodes}get poolSize(){return J(this._pool,0,(t=>t.size))}get depth(){let t=0;return this._forEachNode((e=>t=Math.max(t,e.depth))),t}dropLevels(t){this._forEachNode((e=>{if(e.depth>=t)for(let t=0;t<e.children.length;t++){const s=e.children[t];e.children[t]=null,s&&this._release(s)}}))}clear(){this.dropLevels(0)}insert(t,e,s=0){const i=pt.fromOptimizedFeatures([t],"esriGeometryPoint").getCursor();i.next();const n=i.readGeometry();if(!n)return;const[r,h]=n.coords;this.insertCursor(i,t.displayId,r,h,t.geohashX,t.geohashY,e,s)}insertCursor(t,e,s,i,n,r,h,o=0){let a=this._root,c=0,u=0,l=0;for(;null!==a;){if(a.depth>=o&&(a.count+=1,a.xTotal+=s,a.yTotal+=i,a.xGeohashTotal+=n,a.yGeohashTotal+=r,a.displayId=e,this._updateStatisticsCursor(t,a,1)),c>=h)return void a.add(e);const d=Math.ceil((c+1)/2),f=Math.floor((c+1)/2),p=1-c%2,y=30-(3*d+2*f),g=30-(2*d+3*f),w=(n&7*p+3*(1-p)<<y)>>y,m=(r&3*p+7*(1-p)<<g)>>g,v=w+m*(8*p+4*(1-p));u=u<<3*p+2*(1-p)|w,l=l<<2*p+3*(1-p)|m,null==a.children[v]&&(a.children[v]=this._acquire(u,l,c+1)),c+=1,a=a.children[v]}}remove(t,e){const s=pt.fromOptimizedFeatures([t],"esriGeometryPoint").getCursor();s.next();const i=s.readGeometry();if(!i)return;const[n,r]=i.coords;this.removeCursor(s,n,r,t.geohashX,t.geohashY,e)}removeCursor(t,e,s,i,n,r){let h=this._root,o=0;for(;null!==h;){if(h.count-=1,h.xTotal-=e,h.yTotal-=s,h.xGeohashTotal-=i,h.yGeohashTotal-=n,this._updateStatisticsCursor(t,h,-1),o>=r)return void h.remove(t.getDisplayId());const a=Math.ceil((o+1)/2),c=Math.floor((o+1)/2),u=1-o%2,l=30-(3*a+2*c),d=30-(2*a+3*c),f=((i&7*u+3*(1-u)<<l)>>l)+((n&3*u+7*(1-u)<<d)>>d)*(8*u+4*(1-u)),p=h.children[f];1===p.count&&(this._release(p),h.children[f]=null),o+=1,h=p}}find(t,e,s){return this._root.find(t,e,s,0,0,0)}findSingleOccupancyNode(t,e,s,i,n){let r=this._root;for(;null!==r;){const h=r.depth,o=r.xNode,a=r.yNode,c=1-h%2,u=r.xGeohashTotal/r.count,l=r.yGeohashTotal/r.count;if(1===r.count&&t<u&&u<=s&&e<l&&l<=i)return r;if(h>=n){r=r.next;continue}const d=Math.ceil((h+1)/2),f=Math.floor((h+1)/2),p=30-(3*d+2*f),y=30-(2*d+3*f),g=~((1<<p)-1),w=~((1<<y)-1),m=(e&w)>>y,v=(s&g)>>p,b=(i&w)>>y,_=o<<3*c+2*(1-c),M=a<<2*c+3*(1-c),S=_+8*c+4*(1-c),x=M+4*c+8*(1-c),k=Math.max(_,(t&g)>>p),F=Math.max(M,m),I=Math.min(S,v),q=Math.min(x,b);let A=null,C=null;for(let t=F;t<=q;t++)for(let e=k;e<=I;e++){const s=r.children[e-_+(t-M)*(8*c+4*(1-c))];s&&(A||(A=s,A.next=r.next),C&&(C.next=s),C=s,s.next=r.next)}r=A||r.next}return null}getRegionDisplayIds(t,e,s,i,n){let r=this._root;const h=[];for(;null!==r;){const o=r.depth,a=r.xNode,c=r.yNode;if(o>=n){const n=r.xGeohashTotal/r.count,o=r.yGeohashTotal/r.count;t<=n&&n<=s&&e<=o&&o<=i&&r.displayIds.forEach((t=>h.push(t))),r=r.next;continue}const u=Math.ceil((o+1)/2),l=Math.floor((o+1)/2),d=1-o%2,f=30-(3*u+2*l),p=30-(2*u+3*l),y=~((1<<f)-1),g=~((1<<p)-1),w=(e&g)>>p,m=(s&y)>>f,v=(i&g)>>p,b=a<<3*d+2*(1-d),_=c<<2*d+3*(1-d),M=b+8*d+4*(1-d),S=_+4*d+8*(1-d),x=Math.max(b,(t&y)>>f),k=Math.max(_,w),F=Math.min(M,m),I=Math.min(S,v);let q=null,A=null;for(let t=k;t<=I;t++)for(let e=x;e<=F;e++){const s=r.children[e-b+(t-_)*(8*d+4*(1-d))];s&&(q||(q=s,q.next=r.next),A&&(A.next=s),A=s,s.next=r.next)}r=q||r.next}return h}getRegionStatistics(t,e,s,i,n){let r=this._root,h=0,o=0,a=0;const c={};let u=0;for(;null!==r;){const l=r.depth,d=r.xNode,f=r.yNode;if(l>=n){const n=r.xGeohashTotal/r.count,l=r.yGeohashTotal/r.count;t<n&&n<=s&&e<l&&l<=i&&(h+=r.count,o+=r.xTotal,a+=r.yTotal,1===r.count&&(u=r.displayId),this._aggregateStatistics(c,r.statistics)),r=r.next;continue}const p=Math.ceil((l+1)/2),y=Math.floor((l+1)/2),g=1-l%2,w=30-(3*p+2*y),m=30-(2*p+3*y),v=~((1<<w)-1),b=~((1<<m)-1),_=(e&b)>>m,M=(s&v)>>w,S=(i&b)>>m,x=d<<3*g+2*(1-g),k=f<<2*g+3*(1-g),F=x+8*g+4*(1-g),I=k+4*g+8*(1-g),q=Math.max(x,(t&v)>>w),A=Math.max(k,_),C=Math.min(F,M),R=Math.min(I,S);let T=null,j=null;for(let n=A;n<=R;n++)for(let l=q;l<=C;l++){const d=r.children[l-x+(n-k)*(8*g+4*(1-g))];if(d){if(n!==A&&n!==R&&l!==q&&l!==C){const n=d.xGeohashTotal/d.count,r=d.yGeohashTotal/d.count;t<n&&n<=s&&e<r&&r<=i&&(h+=d.count,o+=d.xTotal,a+=d.yTotal,1===d.count&&(u=d.displayId),this._aggregateStatistics(c,d.statistics));continue}T||(T=d,T.next=r.next),j&&(j.next=d),j=d,d.next=r.next}}r=T||r.next}return{count:h,attributes:this._normalizeStatistics(c,h),xTotal:o,yTotal:a,referenceId:u}}_forEachNode(t){let e=this._root;for(;null!==e;){const s=this._linkChildren(e)||e.next;t(e),e=s}}_linkChildren(t){let e=null,s=null;for(let i=0;i<=t.children.length;i++){const n=t.children[i];n&&(e||(e=n,e.next=t.next),s&&(s.next=n),s=n,n.next=t.next)}return e}_updateStatisticsCursor(t,e,s){for(const i of this._statisticFields){const n=i.name,r=i.inField?t.readAttribute(i.inField):t.getComputedNumericAtIndex(i.inFieldIndex);switch(i.statisticType){case"norm":{e.statistics[n]||(e.statistics[n]={});const h=t.readAttribute(i.inNormalizationField),o=e.statistics[n].onStatisticField||0,a=e.statistics[n].onStatisticNormalizationField||0;null==r||isNaN(r)||null==h||0===h||isNaN(h)||(e.statistics[n].onStatisticField=o+s*r,e.statistics[n].onStatisticNormalizationField=a+s*h);break}case"sum":case"avg":{e.statistics[n]||(e.statistics[n]={value:0,nanCount:0});const t=e.statistics[n].value,i=e.statistics[n].nanCount;null==r||isNaN(r)?e.statistics[n].nanCount=i+s:e.statistics[n].value=t+s*r;break}case"avg_angle":{e.statistics[n]||(e.statistics[n]={x:0,y:0,nanCount:0});const t=e.statistics[n].x,i=e.statistics[n].y,h=e.statistics[n].nanCount,o=Math.PI/180;null==r||isNaN(r)?e.statistics[n].nanCount=h+s:(e.statistics[n].x=t+s*Math.cos(r*o),e.statistics[n].y=i+s*Math.sin(r*o));break}case"mode":e.statistics[n]||(e.statistics[n]={}),e.statistics[n][r]=(e.statistics[n][r]||0)+s}}}_aggregateStatistics(t,e){for(const s of this._statisticFields){const i=s.name;switch(s.statisticType){case"sum":case"avg":case"avg_angle":case"mode":case"norm":t[i]||(t[i]={});for(const s in e[i])t[i][s]=(t[i][s]||0)+e[i][s]}}}_normalizeStatistics(t,e){const s={};for(const i of this._statisticFields){const n=i.name;switch(i.statisticType){case"norm":{const i=t[n];if(e&&null==i.onStatisticNormalizationField)break;if(e&&i.onStatisticNormalizationField){s[n]=i.onStatisticField/i.onStatisticNormalizationField;break}s[n]=0;break}case"sum":{if(!e)break;const{value:i,nanCount:r}=t[n];if(!(e-r))break;s[n]=i;break}case"avg":{if(!e)break;const{value:i,nanCount:r}=t[n];if(!(e-r))break;s[n]=i/(e-r);break}case"avg_angle":{if(!e)break;const{x:i,y:r,nanCount:h}=t[n];if(!(e-h))break;const o=180/Math.PI,a=Math.atan2(r/(e-h),i/(e-h))*o;s[n]=a;break}case"mode":{const e=t[n];let i=0,r=null;for(const t in e){const s=e[t];s>i&&(i=s,r=t)}s[n]="null"===r?null:r;break}}}return s}}class me{constructor(t,e,s){this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.displayId=0,this.displayIds=new Set,this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this.children=new Array(32);for(let t=0;t<this.children.length;t++)this.children[t]=null;this.xNode=t,this.yNode=e,this.depth=s}realloc(t,e,s){for(let t=0;t<this.children.length;t++)this.children[t]=null;return this.xNode=t,this.yNode=e,this.depth=s,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this.displayIds.clear(),this}add(t){this.displayIds.add(t)}remove(t){this.displayIds.delete(t)}getLngLatBounds(){const t=this.depth,e=Math.ceil(t/2),s=Math.floor(t/2);return function(t,e){let s=-90,i=90,n=-180,r=180;for(let h=0;h<e;h++){const e=Math.ceil((h+1)/2),o=Math.floor((h+1)/2),a=1-h%2,c=30-(3*e+2*o),u=30-(2*e+3*o),l=2*a+3*(1-a),d=(7*a+3*(1-a)<<c&t.geohashX)>>c,f=(3*a+7*(1-a)<<u&t.geohashY)>>u;for(let t=3*a+2*(1-a)-1;t>=0;t--){const e=(n+r)/2,s=d&1<<t?1:0;n=(1-s)*n+s*e,r=(1-s)*e+s*r}for(let t=l-1;t>=0;t--){const e=(s+i)/2,n=f&1<<t?1:0;s=(1-n)*s+n*e,i=(1-n)*e+n*i}}return[n,s,r,i]}({geohashX:this.xNode<<30-(3*e+2*s),geohashY:this.yNode<<30-(2*e+3*s)},this.depth)}find(t,e,s,i,n,r){if(i>=s)return this;const h=1-i%2,o=3*h+2*(1-h),a=2*h+3*(1-h),c=30-n-o,u=30-r-a,l=this.children[((t&7*h+3*(1-h)<<c)>>c)+((e&3*h+7*(1-h)<<u)>>u)*(8*h+4*(1-h))];return null==l?null:l.find(t,e,s,i+1,n+o,r+a)}}class ve extends K{constructor(t,e,s,i,n){super(new o([],[e,s]),i,null,t),this.geohashBoundsInfo=n}get count(){return this.attributes.cluster_count}static create(t,e,s,i,n,r,h,o){const a=new ve(e,s,i,r,h);return a.displayId=t.createDisplayId(!0),a.referenceId=o,a.tileLevel=n,a}update(t,e,s,i,n,r){return this.geometry.coords[0]=t,this.geometry.coords[1]=e,this.tileLevel=s,this.attributes=i,this.geohashBoundsInfo=n,this.referenceId=null,this.referenceId=r,this}toJSON(){return{objectId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null,attributes:{...this.attributes,clusterId:this.objectId},geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}}}function be(t){return 57.29577951308232*t}class _e extends ut{constructor(t,e,s){super(t,s),this.events=new m,this._geohashLevel=0,this._tileLevel=0,this._aggregateValueRanges={},this._aggregateValueRangesChanged=!1,this._geohashBuf=[],this._clusters=new Map,this._tiles=new Map,this.geometryInfo=t.geometryInfo,this._spatialReference=e,this._projectionSupportCheck=vt(e,z.WGS84),this._bitsets.geohash=s.getBitset(s.createBitset()),this._bitsets.inserted=s.getBitset(s.createBitset())}async updateSchema(t,e){const s=this._schema;try{await super.updateSchema(t,e),await this._projectionSupportCheck}catch(t){}const i=b(s,e);e&&(!r(i)||t.source||t.storage.filters)?((M(i,"params.fields")||!this._tree||t.source)&&(this._tree=new we(this._statisticFields),this._rebuildTree(),l("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),l("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",i),t.targets[e.name]=!0,t.mesh=!1,this._aggregateValueRanges={}):s&&(t.mesh=!0)}clear(){this._rebuildTree()}sweepFeatures(t,e){this._bitsets.inserted.forEachSet((s=>{if(!t.has(s)){const t=e.lookupByDisplayIdUnsafe(s);this._remove(t)}}))}sweepClusters(t,e,s){this._clusters.forEach(((i,n)=>{i&&i.tileLevel!==s&&(t.releaseDisplayId(i.displayId),e.unsetAttributeData(i.displayId),this._clusters.delete(n))}))}onTileData(t,e,s,i,n=!0){if(!this._schema||r(e.addOrUpdate))return e;const h=this._getTransforms(t,this._spatialReference);{const t=e.addOrUpdate.getCursor();for(;t.next();)this._update(t,i)}if(e.status.mesh||!n)return e;const o=new Array;this._getClustersForTile(o,t,this._schema.params.clusterRadius,s,h),e.addOrUpdate=pt.fromOptimizedFeatures(o,"esriGeometryPoint"),e.addOrUpdate.attachStorage(s),e.end=!0;{const i=e.addOrUpdate.getCursor();for(;i.next();){const e=i.getDisplayId();this._bitsets.computed.unset(e),this.setComputedAttributes(s,i,e,t.scale)}}return this._aggregateValueRangesChanged&&e.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),e}onTileUpdate({added:t,removed:e}){if(t.length){const e=t[0].level;this._tileLevel=e,this._setGeohashLevel(e)}if(!this._schema)return;const s=this._schema.params.clusterRadius;e.forEach((t=>{this._tiles.delete(t.key.id),this._markTileClustersForDeletion(t,s)}))}getAggregate(t){let e=null;return this._clusters.forEach((s=>{s&&s.displayId===t&&(e=s.toJSON())})),e}getAggregates(){const t=[];return this._clusters.forEach((e=>{e&&e.tileLevel===this._tileLevel&&t.push(e.toJSON())})),t}getDisplayId(t){const e=this._clusters.get(t);return e?e.displayId:null}getFeatureDisplayIdsForAggregate(t){const e=this._clusters.get(t);if(!e)return[];const s=e.geohashBoundsInfo;return this._tree.getRegionDisplayIds(s.xLL,s.yLL,s.xTR,s.yTR,s.level)}getDisplayIdForReferenceId(t){let e;return this._clusters.forEach((s=>{s&&s.referenceId===t&&(e=s.displayId)})),e}getAggregateValueRanges(){return this._aggregateValueRanges}forEach(t){this._clusters.forEach(((e,s)=>{e&&t(e,s)}))}size(){let t=0;return this.forEach((()=>t++)),t}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(t){const e=t.getDisplayId(),s=t.getXHydrated(),i=t.getYHydrated(),n=this._geohashBuf[2*e],r=this._geohashBuf[2*e+1];this._bitsets.inserted.has(e)&&(this._bitsets.inserted.unset(e),this._tree.removeCursor(t,s,i,n,r,this._geohashLevel))}_update(t,e){const s=t.getDisplayId(),i=this._bitsets.inserted,n=e.isVisible(s);if(n===i.has(s))return;if(!n)return void this._remove(t);const r=t.getXHydrated(),h=t.getYHydrated();this._setGeohash(s,r,h)&&(this._tree.insertCursor(t,s,r,h,this._geohashBuf[2*s],this._geohashBuf[2*s+1],this._geohashLevel),i.set(s))}_setGeohash(t,e,s){if(this._bitsets.geohash.has(t))return!0;const i=this._geohashBuf;if(this._spatialReference.isWebMercator){const n=be(e/et.radius),r=n-360*Math.floor((n+180)/360);ge(i,t,be(Math.PI/2-2*Math.atan(Math.exp(-s/et.radius))),r,12)}else{const n=bt({x:e,y:s},this._spatialReference,z.WGS84);if(!n)return!1;ge(i,t,n.y,n.x,12)}return this._bitsets.geohash.set(t),!0}_getClustersForTile(t,e,s,i,h,o=!0){const c=this._schema.params.clusterPixelBuffer,u=2*s,l=this._getGeohashLevel(e.key.level),d=Math.ceil(2**e.key.level*_t/u),f=Math.ceil(c/u)+0,p=Math.ceil(_t/u),{row:y,col:g}=e.key,w=y*_t,m=Math.floor(g*_t/u)-f,v=Math.floor(w/u)-f,b=m+p+2*f,_=v+p+2*f,M=e.tileInfoView.getLODInfoAt(e.key.level);for(let s=m;s<=b;s++)for(let c=v;c<=_;c++){let u=s;M.wrap&&(u=s<0?s+d:s%d);const f=M.wrap&&s<0,p=M.wrap&&s%d!==s,y=this._lookupCluster(i,M,e.key.level,u,c,l);if(a(y)){const e=Z(h,(t=>f?t.left:p?t.right:t.tile));if(o&&r(e))continue;if(!y.count)continue;if(a(e)&&o){const s=y.geometry.clone();let i=y.attributes;s.coords[0]=V(e,s.coords[0]),s.coords[1]=Q(e,s.coords[1]),1===y.count&&a(y.referenceId)&&(i={...y.attributes,referenceId:y.referenceId});const r=new n(s,i);r.displayId=y.displayId,t.push(r)}}}}_getGeohashLevel(t){return Math.min(Math.ceil(t/2+2),12)}_setGeohashLevel(t){const e=this._getGeohashLevel(t),s=1*(Math.floor(e/1)+1)-1;if(this._geohashLevel!==s)return this._geohashLevel=s,this._rebuildTree(),void this._bitsets.geohash.clear()}_getTransforms(t,e){const s={originPosition:"upperLeft",scale:[t.resolution,t.resolution],translate:[t.bounds[0],t.bounds[3]]},i=tt(e);if(!i)return{tile:s,left:null,right:null};const[n,r]=i.valid;return{tile:s,left:{...s,translate:[r,t.bounds[3]]},right:{...s,translate:[n-r+t.bounds[0],t.bounds[3]]}}}_getClusterId(t,e,s){return(15&t)<<28|(16383&e)<<14|16383&s}_markForDeletion(t,e,s){const i=this._getClusterId(t,e,s);this._clusters.delete(i)}_getClusterBounds(t,e,s){const i=this._schema.params.clusterRadius,n=2*i;let r=s%2?e*n:e*n-i;const h=s*n;let o=r+n;const a=2**t.level*_t;t.wrap&&r<0&&(r=0),t.wrap&&o>a&&(o=a);const c=h/_t,u=o/_t,l=(h-n)/_t;return[t.getXForColumn(r/_t),t.getYForRow(c),t.getXForColumn(u),t.getYForRow(l)]}_lookupCluster(t,e,s,i,n,r){const h=this._getClusterId(s,i,n),o=this._clusters.get(h),[c,u,l,d]=this._getClusterBounds(e,i,n),f={x:c,y:u},p={x:l,y:d};let y=0,g=0,w=0,m=0;if(this._spatialReference.isWebMercator){{const t=be(f.x/et.radius);y=t-360*Math.floor((t+180)/360),g=be(Math.PI/2-2*Math.atan(Math.exp(-f.y/et.radius)))}{const t=be(p.x/et.radius);w=t-360*Math.floor((t+180)/360),m=be(Math.PI/2-2*Math.atan(Math.exp(-p.y/et.radius)))}}else{const t=bt(f,this._spatialReference,z.WGS84),e=bt(p,this._spatialReference,z.WGS84);if(!t||!e)return null;y=t.x,g=t.y,w=e.x,m=e.y}const v={geohashX:0,geohashY:0},b={geohashX:0,geohashY:0};ye(v,g,y,r),ye(b,m,w,r);const _=v.geohashX,M=v.geohashY,S=b.geohashX,x=b.geohashY,k={xLL:_,yLL:M,xTR:S,yTR:x,level:r},F=this._tree.getRegionStatistics(_,M,S,x,r),{count:I,xTotal:q,yTotal:A,referenceId:C}=F,R=I?q/I:0,T=I?A/I:0;if(0===I)return this._clusters.set(h,null),null;const j={cluster_count:I,...F.attributes},E=a(o)?o.update(R,T,s,j,k,C):ve.create(t,h,R,T,s,j,k,C);return 0===I&&(E.geometry.coords[0]=(c+l)/2,E.geometry.coords[1]=(u+d)/2),this._clusters.set(h,E),this._updateAggregateValueRangeForCluster(E,E.tileLevel),E}_updateAggregateValueRangeForCluster(t,e){const s=this._aggregateValueRanges[e]||{minValue:1/0,maxValue:0},i=s.minValue,n=s.maxValue;s.minValue=Math.min(i,t.count),s.maxValue=Math.max(n,t.count),this._aggregateValueRanges[e]=s,i===s.minValue&&n===s.maxValue||(this._aggregateValueRangesChanged=!0)}_markTileClustersForDeletion(t,e){const s=2*e,i=Math.ceil(_t/s),{row:n,col:r}=t.key,h=n*_t,o=Math.floor(r*_t/s),a=Math.floor(h/s);for(let e=o;e<o+i;e++)for(let s=a;s<a+i;s++)this._markForDeletion(t.key.level,e,s)}}function Me(t){if(!C(t)&&!function(t){return"worker:port-closed"===t.name}(t))throw t}function Se(t){return"feature"===t.type&&"snapshot"===t.mode}let xe=class extends j{constructor(){super(...arguments),this._storage=new yt,this._markedIdsBufId=this._storage.createBitset(),this._lastCleanup=performance.now(),this._cleanupNeeded=!1,this._invalidated=!1,this._tileToResolver=new Map,this._didEdit=!1,this.tileStore=null,this.config=null,this.processor=null,this.remoteClient=null,this.service=null}initialize(){this._initAttributeStore(),this._initStores(),this._initQueryEngine(),this._initSource(),this._updateQueue=new I({concurrency:"geoevent"===this._source.type?1:4,process:(t,e)=>this._onTileMessage(t,{signal:e})}),this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this)),this.watch("updating",(t=>!t&&this.onIdle()))]),this._checkUpdating=setInterval((()=>this.notifyChange("updating")),300)}async startup(){this._initAttributeStore(),this.tileStore.tiles.forEach((t=>this._source.subscribe(t)))}_initSource(){this._source=function(t,e,s,i,n,r){const h=function(t,e,s,i,n,r){switch(t.type){case"snapshot":return{type:"feature",origin:"snapshot",featureCount:A(t.featureCount,0),serviceInfo:t,onMessage:i,outSR:e,tileInfoView:s,canAcceptRequest:n,store:r};case"stream":return{type:"geoevent",serviceInfo:t,onMessage:i,outSR:e,canAcceptRequest:n};case"memory":case"on-demand":return{type:"feature",serviceInfo:t,onMessage:i,outSR:e,origin:function(t){return Array.isArray(t)?"local":"path"in t&&W(t.path)?"hosted":"unknown"}(t.source),tileInfoView:s,canAcceptRequest:n}}}(t,e,s,i,n,r);switch(h.type){case"feature":switch(h.origin){case"hosted":case"local":return new ue(h);case"snapshot":return new pe(h);case"unknown":return new Yt(h)}case"geoevent":return new ae(h)}}(this.service,this.spatialReference,this.tileStore.tileScheme,((t,e)=>(this._invalidated=!0,this._patchTile(t,e))),(()=>this._updateQueue.length<50),this.featureStore),this._proxyEvents()}_proxyEvents(){if("geoevent"===this._source.type){const t=this._source.events;this.handles.add([t.on("connectionStatus",(t=>this.remoteClient.invoke("setProperty",{propertyName:"connectionStatus",value:t}).catch(Me))),t.on("errorString",(t=>this.remoteClient.invoke("setProperty",{propertyName:"errorString",value:t}).catch(Me))),t.on("feature",(t=>this.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:t.attributes,centroid:t.centroid,geometry:t.geometry}}).catch(Me))),t.on("updateRate",(t=>this.remoteClient.invoke("emitEvent",{name:"update-rate",event:{...t}}).catch(Me)))])}}_initAttributeStore(){this.attributeStore?this.attributeStore.invalidateResources():this.attributeStore=new gt({type:"remote",initialize:(t,e)=>st(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",t,{signal:e}).catch(Me)),update:(t,e)=>st(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",t,{signal:e}).catch(Me)),render:t=>st(this.remoteClient.invoke("tileRenderer.featuresView.requestRender",void 0,{signal:t}).catch(Me))},this.config)}_initStores(){const t={geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields};this.featureStore=new lt(t,this._storage,"snapshot"===this.service.type?"snapshot":"on-demand"),this.aggregateStore=new _e(t,this.spatialReference,this._storage),this.handles.add(this.aggregateStore.events.on("valueRangesChanged",(t=>{this.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:t.valueRanges}}).catch(Me)})))}_initQueryEngine(){var t;const e=this;null==(t=this.queryEngine)||t.destroy(),this.queryEngine=new at({definitionExpression:this.config.definitionExpression,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,aggregateAdapter:{getFeatureObjectIds:t=>e.aggregateStore.getFeatureDisplayIdsForAggregate(t).map((t=>e.getObjectId(t)))},timeInfo:this.service.timeInfo})}destroy(){this._updateQueue.destroy(),this._source.destroy(),this.queryEngine.destroy(),this.attributeStore&&this.attributeStore.destroy(),clearInterval(this._checkUpdating)}get fieldsIndex(){return new it(this.service.fields)}get hasAggregates(){return!!this.config.schema.targets.aggregate}get spatialReference(){return this.tileStore.tileScheme.spatialReference}get updating(){return this.isUpdating()}isUpdating(){return this._source.updating||!!this._updateQueue.length}enableEvent(t){this._source.enableEvent(t.name,t.value)}pause(){this._updateQueue.pause(),this._updateQueue.clear()}async update(t,e){this._set("config",e),this._schema=e.schema,this._initQueryEngine(),await Promise.all([this._source.update(t,e.schema.source),this.featureStore.updateSchema(t,e.schema.targets.feature),this.attributeStore.update(t,e),this.attributeStore.updateFilters(t,this)]),await this.aggregateStore.updateSchema(t,e.schema.targets.aggregate),l("esri-2d-update-debug")&&t.describe()}async applyUpdate(t){t.mesh&&this.clearTiles(),this._updateQueue.resume(),await this._source.applyUpdate(t),this.notifyChange("updating"),await nt(this,"updating",!0),this.hasAggregates&&(await D(10),await nt(this,"updating",!0))}async onEdits({edits:t}){l("esri-2d-update-debug")&&console.debug("Applying Edit:",t),this._didEdit=!0;try{const e=t.removed.map((t=>t.objectId&&-1!==t.objectId?t.objectId:this._lookupObjectIdByGlobalId(t.globalId))),s=t.addOrModified.map((({objectId:t})=>t));this.featureStore.invalidate(),await this._source.edit(s,e),this.clearTiles(),this.notifyChange("updating"),this.aggregateStore.clear(),await this._source.resend(),await nt(this,"updating",!0)}catch(t){}}async refresh(){this.featureStore.invalidate(),this.clearTiles(),this._source.refresh(),this._cleanupNeeded=!0,this.notifyChange("updating"),await nt(this,"updating",!0)}clearTiles(){for(const t of this.tileStore.tiles)this.processor.onTileClear(t)}onTileUpdate(t){this.aggregateStore.onTileUpdate(t);for(const e of t.added)this._source.subscribe(e),this._level=e.level;for(const e of t.removed)this._source.unsubscribe(e),this._cleanupNeeded=!0,this._tileToResolver.has(e.id)&&(this._tileToResolver.get(e.id).resolve(),this._tileToResolver.delete(e.id));this.notifyChange("updating")}onIdle(){this._invalidated&&((this.hasAggregates||"heatmap"===this.processor.type)&&this._repushCurrentLevelTiles(),this._invalidated=!1),this._markAndSweep()}async querySummaryStatistics({query:t,params:e}){return this.queryEngine.executeQueryForSummaryStatistics(t,e)}async queryUniqueValues({query:t,params:e}){return this.queryEngine.executeQueryForUniqueValues(t,e)}async queryClassBreaks({query:t,params:e}){return this.queryEngine.executeQueryForClassBreaks(t,e)}queryExtent(t){return this.queryEngine.executeQueryForExtent(t)}queryFeatures(t){return this.queryEngine.executeQuery(t)}queryFeatureCount(t){return this.queryEngine.executeQueryForCount(t)}queryLatestObservations(t){return this.queryEngine.executeQueryForLatestObservations(t)}queryObjectIds(t){return this.queryEngine.executeQueryForIds(t)}async queryStatistics(){return this.featureStore.storeStatistics}getObjectId(t){return this.featureStore.lookupObjectId(t,this._storage)}getDisplayId(t){if(this._schema.targets.aggregate){const e=this.aggregateStore.getDisplayId(t);if(r(e)){const e=this.featureStore.lookupDisplayId(t);return this.aggregateStore.getDisplayIdForReferenceId(e)}return e}return this.featureStore.lookupDisplayId(t)}getFeature(t){const e=this.featureStore.lookupFeatureByDisplayId(t,this._storage);if(r(e))return null;const s=e.readHydratedGeometry(),i=h(s,e.geometryType,e.hasZ,e.hasM);return{attributes:e.readAttributes(),geometry:i}}getAggregate(t){return this.aggregateStore.getAggregate(t)}getAggregates(){return this.aggregateStore.getAggregates()}async setHighlight(t){const e=t.map((t=>this.getDisplayId(t)));return this.attributeStore.setHighlight(t,e)}_lookupObjectIdByGlobalId(t){const e=this.service.globalIdField;if(r(e))throw new Error("Expected globalIdField to be defined");let s=null;if(this.featureStore.forEach((i=>{t===i.readAttribute(e)&&(s=i.getObjectId())})),r(s))throw new Error(`Expected to find a feature with globalId ${t}`);return s}_repushCurrentLevelTiles(){const t=this.tileStore.tiles.filter((t=>t.level===this._level));for(const e of t)this._patchTile({type:"append",id:e.key.id,addOrUpdate:pt.fromOptimizedFeatures([],this.service.geometryType),remove:[],end:!0,status:Lt.empty()})}_maybeForceCleanup(){performance.now()-this._lastCleanup>5e3&&this._markAndSweep()}_patchTile(t,e){const s=this._updateQueue.push(t,e).then((()=>{this.notifyChange("updating")})).catch((()=>{this.notifyChange("updating")}));return this.notifyChange("updating"),s}async _onTileMessage(t,e){q(e);const s=this.tileStore.get(t.id);if(!s)return;if(t.clear)return this.processor.onTileClear(s);const i=t.status;this._cleanupNeeded=!0;const n=[];for(const e of t.remove){const t=this.featureStore.lookupDisplayId(e);t&&n.push(t)}t.remove=n;try{if(r(t.addOrUpdate))return void this.processor.onTileMessage(s,{...t,addOrUpdate:null},this.hasAggregates,e).catch(Y);if(t.addOrUpdate.setArcadeSpatialReference(this.spatialReference),this.featureStore.hasInstance(t.addOrUpdate.instance)&&i.targets.feature||(i.targets.feature=!0,this.featureStore.onTileData(s,t)),i.storage.data&&i.storage.filters||(i.storage.data=!0,i.storage.filters=!0,this.attributeStore.onTileData(s,t),"geoevent"===this._source.type||this._didEdit?(await this.attributeStore.sendUpdates(),q(e)):this.attributeStore.sendUpdates()),this.hasAggregates&&!i.targets.aggregate){i.targets.aggregate=!0;const e=Se(this._source)&&this._source.loading,n=!Se(this._source)||e||t.end;if(this.aggregateStore.onTileData(s,t,this._storage,this.attributeStore,n),!n)return;i.mesh||(this.attributeStore.onTileData(s,t),await this.attributeStore.sendUpdates(),this.processor.onTileClear(s))}i.mesh||(i.mesh=!0,await this.processor.onTileMessage(s,t,this.hasAggregates,e),q(e)),this._maybeForceCleanup()}catch(t){Y(t)}}_mark(t,e,s){const i=(4294901760&this._storage.getInstanceId(t))>>>16;t&&(e.add(i),s.set(t))}_markAndSweep(){if(this._lastCleanup=performance.now(),"feature"===this._source.type&&"snapshot"===this._source.mode||"geoevent"!==this._source.type&&!this._cleanupNeeded)return;this._cleanupNeeded=!1;const t=this._storage.getBitset(this._markedIdsBufId),e=new Set;t.clear();for(const s of this.tileStore.tiles)for(const i of this._source.readers(s.id)){const s=i.getCursor();for(;s.next();){let i=s.getDisplayId();if(!i){const t=s.getObjectId();i=this.featureStore.lookupDisplayId(t)}this._mark(i,e,t)}}"symbol"===this.processor.type&&this.processor.forEachBufferId((s=>{this._mark(s,e,t)})),this._updateQueue.forEach((s=>{for(const i of s.remove){const s=this.featureStore.lookupDisplayId(i);this._mark(s,e,t)}})),this.config.schema.targets.aggregate&&(this.aggregateStore.sweepFeatures(t,this.featureStore),this.aggregateStore.sweepClusters(this._storage,this.attributeStore,this._level)),this.featureStore.sweepFeatures(t,this._storage,this.attributeStore),this.featureStore.sweepFeatureSets(e)}};E([P({constructOnly:!0})],xe.prototype,"tileStore",void 0),E([P()],xe.prototype,"config",void 0),E([P({readOnly:!0})],xe.prototype,"fieldsIndex",null),E([P()],xe.prototype,"processor",void 0),E([P({constructOnly:!0})],xe.prototype,"remoteClient",void 0),E([P({constructOnly:!0})],xe.prototype,"service",void 0),E([P()],xe.prototype,"spatialReference",null),E([P()],xe.prototype,"updating",null),xe=E([O("esri.views.2d.layers.features.controllers.FeatureController2D")],xe);const ke=xe,Fe=new Set;function Ie(){return Fe}let qe=class extends j{constructor(){super(...arguments),this.controller=null,this.processor=null,this.remoteClient=null,this.tileStore=null,this.service=null,this.viewState=null}initialize(){this.handles.add(this.watch("updating",(t=>{this.remoteClient.invoke("setUpdating",t).catch((()=>{}))})))}destroy(){var t,e,s;null==(t=this.controller)||t.destroy(),null==(e=this.processor)||e.destroy(),null==(s=this.tileStore)||s.destroy(),this.controller=this.processor=this.tileStore=this.remoteClient=null}get updating(){return!this.controller||this.controller.updating}async startup({service:t,config:e,tileInfo:s,tiles:i}){if(this.service=t,!this.tileStore){const t=new rt(ht.fromJSON(s));this.tileStore=new ot(t)}this.tileStore.clear(),await this._createProcessorAndController(e),await this.update({config:e},!0),this.tileStore.updateTiles(i)}async updateTiles(t){this.tileStore.updateTiles(t)}async update({config:t},e=!1){const s=Lt.empty();return e||this.controller.pause(),await Promise.all([this.processor.update(s,t),this.controller.update(s,t)]),s.toJSON()}async applyUpdate(t){return this.controller.applyUpdate(Lt.create(t))}async _createProcessorAndController(t){await Promise.all([this._handleControllerConfig(t),this._handleProcessorConfig(t)]),this.controller.processor=this.processor}async _handleControllerConfig(t){const e=await this._createController(this.service,t);return await e.startup(),e}async _handleProcessorConfig(t){return this._createProcessor(this.service,t)}async _createController(t,e){this.controller&&this.controller.destroy();const{tileStore:s,remoteClient:i}=this,n=new ke({service:t,config:e,tileStore:s,remoteClient:i});return this.controller=n,n}async _createProcessor(t,e){const s=e.schema.processors[0].type,i=(await function(t){return"heatmap"===t?import("./p-4bb084f5.js"):import("./p-bbf7f63d.js")}(s)).default,{remoteClient:n,tileStore:r}=this,h=new i({service:t,config:e,tileStore:r,remoteClient:n});return this.processor&&this.processor.destroy(),this.processor=h,h}};E([P()],qe.prototype,"controller",void 0),E([P()],qe.prototype,"processor",void 0),E([P()],qe.prototype,"updating",null),E([P()],qe.prototype,"viewState",void 0),qe=E([O("esri.views.2d.layers.features.Pipeline")],qe);const Ae=qe;export default Ae;export{Ie as getInstances}