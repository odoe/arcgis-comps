import{n as t,i as s,o as i}from"./p-d6725707.js";import{s as e,i as r}from"./p-39da60a5.js";import{n as h}from"./p-7a648ea5.js";import{D as n}from"./p-d925341f.js";import{n as o}from"./p-56ed1c7a.js";import{o as a,Z as u,K as l,A as c,B as d,C as f,D as p,r as m}from"./p-47e1bd73.js";import{r as g,o as w}from"./p-dd4e6b8b.js";import{r as y,t as v,v as x,c1 as b,bF as F,a7 as A,_ as T,m as M,c0 as j,c2 as D,bG as I,bc as k}from"./p-9ae46e68.js";import{e as C}from"./p-1f10277d.js";import{l as V}from"./p-81abd5fc.js";import{o as z}from"./p-7c7c5507.js";import{Q as U,J as S,$ as _,N as R}from"./p-16def889.js";import{n as K,l as E}from"./p-0509f8e7.js";import{bi as O,a7 as B,D as q}from"./p-566b0715.js";import{m as P}from"./p-c5b7f7c3.js";import{o as L}from"./p-f614dce4.js";class $ extends g{constructor(t,s,i){super(t,s,i,a,a)}destroy(){super.destroy(),this._transforms&&$.TransformCache.release(this.key.hash)}setTransform(h,a){if(h.version===this.transforms.version)return;this.transforms.version=h.version;const u=a/(h.resolution*h.pixelRatio),l=this.transforms.tileMat3,[c,d]=h.toScreenNoRotation([0,0],[this.x,this.y]);e(l,this.width/this.rangeX*u,0,0,0,this.height/this.rangeY*u,0,c,d,1),r(this.transforms.dvs,h.displayViewMat3,l);const f=this.transforms.labelMat2d,p=h.getScreenTransform(f,a),m=o();n(m,[this.x,this.y],p),t(f),s(f,f,m),i(f,h.viewMat2d,f)}_createTransforms(){return $.TransformCache.acquire(this.key.hash)}}$.TransformCache=new class{acquire(t){return{refCount:1,version:-1,labelMat2d:h(),tileMat3:h(),dvs:h()}}release(t){}};const Z=2147483647;class G{constructor(t){this._head=t,this._cursor=t}static from(t,s=0,i=t.byteLength/H.BYTES_PER_RECORD-s){const e=new H(new Int32Array(t,s*H.BYTES_PER_RECORD,i*H.ELEMENTS_PER_RECORD));return new G(e)}size(){let t=this._cursor,s=0;for(;t;)s+=t.size(),t=t._link;return s}get id(){return this._cursor.id}set id(t){this._cursor.id=t}get materialKey(){return this._cursor.materialKey}set materialKey(t){this._cursor.materialKey=t}get insertAfter(){return this._cursor.insertAfter}get indexFrom(){return this._cursor.indexFrom}set indexFrom(t){this._cursor.indexFrom=t}get indexCount(){return this._cursor.indexCount}set indexCount(t){this._cursor.indexCount=t}get vertexFrom(){return this._cursor.vertexFrom}set vertexFrom(t){this._cursor.vertexFrom=t}get vertexCount(){return this._cursor.vertexCount}set vertexCount(t){this._cursor.vertexCount=t}get sortKey(){return this._cursor.sortKey}set sortKey(t){this._cursor.sortKey=t}get index(){return this._cursor._indexStart+this._cursor._index}seekIndex(t){let s=t;for(this._cursor=this._head;this._cursor;){const t=this._cursor.size();if(s<t)return this._cursor._index=s,!0;s-=t,this._cursor=this._cursor._link}return!1}forEach(t){const s=this.getCursor();for(;s.next();)t(s)}link(t){if(!this._head)return void(this._head=t._head);let s=this._head;for(;s._link;)s=s._link;s._link=t._head,s._link._indexStart=s._indexStart+s.size()}getCursor(){return this.copy()}lookup(t){for(this._cursor=this._head;this._cursor&&!this._cursor.lookup(t);){if(!this._cursor._link)return!1;this._cursor=this._cursor._link}return!!this._cursor}copy(){var t;const s=new G(null==(t=this._head)?void 0:t.copy());if(!s._head)return s;let i=s._head,e=s._head._link;for(;e;)i._link=e.copy(),i=e,e=i._link;return s}next(){return!!this._cursor&&(!!this._cursor.next()||!!this._cursor._link&&(this._cursor=this._cursor._link,this.next()))}peekId(){var t;return null!=(t=this._cursor.peekId())?t:this._cursor._link.peekId()}delete(t){let s=this._head,i=null;for(;s;){if(s.delete(t))return s.isEmpty()&&(y(i)&&(i._link=s._link),s===this._head&&(this._head=s._link),s===this._cursor&&(this._cursor=s._link)),!0;i=s,s=s._link}return!1}}G.ELEMENTS_PER_RECORD=u,G.BYTES_PER_RECORD=G.ELEMENTS_PER_RECORD*Int32Array.BYTES_PER_ELEMENT;class H{constructor(t){this._link=null,this._index=-1,this._indexStart=0,this._deletedCount=0,this._offsets={instance:null},this._packedRecords=t}static from(t,s=0,i=t.byteLength/this.BYTES_PER_RECORD-s){return new H(new Int32Array(t,s*this.BYTES_PER_RECORD,i*this.ELEMENTS_PER_RECORD))}delete(t){const s=this._index,i=this.lookup(t);if(i)for(this.id=Z,++this._deletedCount;this.next()&&this.id===t;)this.id=Z,++this._deletedCount;return this._index=s,i}isEmpty(){return this._deletedCount===this.size()}link(t){this._link?this._link.link(t):this._link=t}lookup(t){if(v(this._offsets.instance)){this._offsets.instance=new Map;const t=this.copy();t._index=-1;let s=0;for(;t.next();)t.id!==s&&(this._offsets.instance.set(t.id,t._index),s=t.id)}if(!this._offsets.instance.has(t))return!1;const s=this._index;return this._index=this._offsets.instance.get(t),this.id!==Z||(this._index=s,!1)}get id(){return this._packedRecords[this._index*H.ELEMENTS_PER_RECORD]}set id(t){this._packedRecords[this._index*H.ELEMENTS_PER_RECORD]=t}get materialKey(){return this._packedRecords[this._index*H.ELEMENTS_PER_RECORD+1]}set materialKey(t){this._packedRecords[this._index*H.ELEMENTS_PER_RECORD+1]=t}get insertAfter(){return this._packedRecords[this._index*H.ELEMENTS_PER_RECORD+2]}get indexFrom(){return this._packedRecords[this._index*H.ELEMENTS_PER_RECORD+3]}set indexFrom(t){this._packedRecords[this._index*H.ELEMENTS_PER_RECORD+3]=t}get indexCount(){return this._packedRecords[this._index*H.ELEMENTS_PER_RECORD+4]}set indexCount(t){this._packedRecords[this._index*H.ELEMENTS_PER_RECORD+4]=t}get vertexFrom(){return this._packedRecords[this._index*H.ELEMENTS_PER_RECORD+5]}set vertexFrom(t){this._packedRecords[this._index*H.ELEMENTS_PER_RECORD+5]=t}get vertexCount(){return this._packedRecords[this._index*H.ELEMENTS_PER_RECORD+6]}set vertexCount(t){this._packedRecords[this._index*H.ELEMENTS_PER_RECORD+6]=t}get sortKey(){return this._packedRecordsF32||(this._packedRecordsF32=new Float32Array(this._packedRecords.buffer)),this._packedRecordsF32[this._index*H.ELEMENTS_PER_RECORD+7]}set sortKey(t){this._packedRecordsF32||(this._packedRecordsF32=new Float32Array(this._packedRecords.buffer)),this._packedRecordsF32[this._index*H.ELEMENTS_PER_RECORD+7]=t}get index(){return this._index}size(){return this._packedRecords.length/H.ELEMENTS_PER_RECORD}next(){for(;++this._index<this.size()&&this.id===Z;);return this._index<this.size()}peekId(){const t=(this._index+1)*H.ELEMENTS_PER_RECORD;return t>=this._packedRecords.length?0:this._packedRecords[t]}getCursor(){return this.copy()}copy(){const t=new H(this._packedRecords);return t._indexStart=this._indexStart,t._link=this._link,t._index=this._index,t._offsets=this._offsets,t._deletedCount=this._deletedCount,t}}H.ELEMENTS_PER_RECORD=u,H.BYTES_PER_RECORD=H.ELEMENTS_PER_RECORD*Int32Array.BYTES_PER_ELEMENT;const J=x.getLogger("esri.views.2d.engine.webgl.AttributeStoreView"),N=K(E,J),Q=t=>2147483647&t;class W{constructor(t,s,i){this._texture=null,this._lastTexture=null,this._fbos={},this.texelSize=4;const{buffer:e,pixelType:r,textureOnly:h}=t,n=U(r);this.shared=i,this.pixelType=r,this.size=s,this.textureOnly=h,h||(this.data=new n(T(e))),this._resetRange()}destroy(){F(this._texture,(t=>t.dispose()));for(const t in this._fbos)F(this._fbos[t],(s=>{"0"===t&&s.detachColorTexture(),s.dispose()})),this._fbos[t]=null;this._texture=null}get _textureDesc(){return{target:3553,wrapMode:33071,pixelFormat:6408,dataType:this.pixelType,samplingMode:9728,width:this.size,height:this.size}}setData(t,s,i){const e=Q(t),r=T(this.data),h=e*this.texelSize+s;!r||h>=r.length||(r[h]=i,this.dirtyStart=Math.min(this.dirtyStart,e),this.dirtyEnd=Math.max(this.dirtyEnd,e))}getData(t,s){if(v(this.data))return null;const i=Q(t)*this.texelSize+s;return!this.data||i>=this.data.length?null:this.data[i]}getTexture(t){return k(this._texture,(()=>this._initTexture(t)))}getFBO(t,s=0){if(v(this._fbos[s])){const i={colorTarget:0,depthStencilTarget:0},e=0===s?this.getTexture(t):this._textureDesc;this._fbos[s]=new V(t,i,e)}return this._fbos[s]}get locked(){return!(5121!==this.pixelType||!this.shared||this.textureOnly||!A("esri-atomics")||!this.data)&&1===Atomics.load(this.data,0)}get hasDirty(){return this.dirtyEnd>=this.dirtyStart}updateTexture(t,s){if(!this.locked){try{const s=this.dirtyStart,i=this.dirtyEnd;if(!this.hasDirty)return;this._resetRange();const e=T(this.data).buffer,r=this.getTexture(t),h=4,n=(s-s%this.size)/this.size,o=n,a=(i-i%this.size)/this.size,u=n*this.size*h,l=(this.size+a*this.size)*h-u,c=U(this.pixelType),d=new c(e,u*c.BYTES_PER_ELEMENT,l),f=this.size,p=a-o+1;if(p>this.size)return void J.error(new M("mapview-webgl","Out-of-bounds index when updating AttributeData"));r.updateData(0,0,o,f,p,d)}catch(t){}s()}}update(t){const{data:s,start:i,end:e}=t;if(y(s)){const e=this.data,r=i*this.texelSize;for(let i=0;i<s.length;i++)t.layout&1<<i%this.texelSize&&(e[r+i]=s[i])}this.dirtyStart=Math.min(this.dirtyStart,i),this.dirtyEnd=Math.max(this.dirtyEnd,e)}resize(t,s){const i=this.size;if(this.size=s,this.textureOnly)return void(i!==this.size&&(this._lastTexture=this._texture,this._texture=null));const e=U(this.pixelType);this.destroy(),this.data=new e(T(t.buffer))}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}_initTexture(t){const s=new z(t,this._textureDesc,k(this.data,void 0));if(y(this._lastTexture)&&this._fbos[0]){const i=this._lastTexture.descriptor.width,e=this._lastTexture.descriptor.height,r=this._lastTexture.descriptor.dataType,h=this._lastTexture.descriptor.pixelFormat,n=this.getFBO(t),o=S(r),a=new(U(r))(new ArrayBuffer(i*e*o*this.texelSize)),u=t.getBoundFramebufferObject(),{x:l,y:c,width:d,height:f}=t.getViewport();t.bindFramebuffer(n),n.readPixels(0,0,i,e,h,r,a),s.updateData(0,0,0,2*i,e/2,a),t.setViewport(l,c,d,f),t.bindFramebuffer(u)}return this.destroy(),this._texture=s,this._texture}}class X{constructor(t){this._onUpdate=t,this._initialized=!1,this._forceNextUpload=!1,this._locked=!1}initialize(t){const{blocks:s,shared:i,size:e}=t;if(this.shared=i,this.size=e,N("Initializing AttributeStoreView",t),v(this._data))this._data=b(s,(t=>new W(t,e,i)));else for(let t=0;t<this._data.length;t++){const r=this._data[t],h=s[t];y(h)&&(v(r)?this._data[t]=new W(h,e,i):r.resize(h,e))}this._initialized=!0}destroy(){F(this._data,(t=>b(t,(t=>t.destroy())))),F(this._defaultTexture,(t=>t.dispose()))}isUpdating(){if(v(this._data))return!0;const t=y(this._pendingAttributeUpdate),s=t;return A("esri-2d-log-updating")&&console.log(`Updating AttributeStoreView ${s}\n  -> hasPendingUpdate ${t}`),s}getBlock(t){return v(this._data)?null:this._data[t]}setLabelMinZoom(t,s){this.setData(t,0,1,s)}getLabelMinZoom(t){return this.getData(t,0,1,255)}getFilterFlags(t){return this.getData(t,0,0,0)}getVVSize(t){return this.getData(t,l,0,0)}getData(t,s,i,e){if(!this._data)return 0;const r=T(this._data)[s];if(v(r))return 0;const h=r.getData(t,i);return y(h)?h:e}setData(t,s,i,e){const r=T(this._data)[s];T(r).setData(t,i,e)}lockTextureUpload(){this._locked=!0}unlockTextureUpload(){this._locked=!1}forceTextureUpload(){this._forceNextUpload=!0}async requestUpdate(t){if(this._pendingAttributeUpdate)return void J.error(new M("mapview-webgl","Tried to update attribute data with a pending update"));const s=j();return N("AttributeStoreView Update Requested",t),this._pendingAttributeUpdate={data:t,resolver:s},s.promise}update(){if(this._initialized&&y(this._pendingAttributeUpdate)){const{data:t,resolver:s}=this._pendingAttributeUpdate,i=T(this._data);for(let s=0;s<t.blocks.length;s++){const e=t.blocks[s];F(i[s],(t=>F(e,(i=>{N(`Updating block ${s}`,i),t.update(i)}))))}this._pendingAttributeUpdate=null,s(),this._onUpdate()}}bindTextures(t,s=!0){this.update();const i=this._getDefaultTexture(t);if(!this._initialized)return t.bindTexture(i,c),void(s&&(t.bindTexture(i,d),t.bindTexture(i,f),t.bindTexture(i,p)));const e=T(this._data);this._locked&&!this._forceNextUpload||(D(e,(s=>s.updateTexture(t,(()=>this._onUpdate())))),this._forceNextUpload=!1),t.bindTexture(I(e[0],i,(s=>s.getTexture(t))),c),s&&(t.bindTexture(I(e[1],i,(s=>s.getTexture(t))),d),t.bindTexture(I(e[2],i,(s=>s.getTexture(t))),f),t.bindTexture(I(e[3],i,(s=>s.getTexture(t))),p))}_getDefaultTexture(t){return v(this._defaultTexture)&&(this._defaultTexture=new z(t,{wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array(4))),this._defaultTexture}}function Y(t,s){const i=s.length;if(t<s[0].value||1===i)return s[0].size;for(let e=1;e<i;e++)if(t<s[e].value)return s[e-1].size+(t-s[e-1].value)/(s[e].value-s[e-1].value)*(s[e].size-s[e-1].size);return s[i-1].size}function tt(t,s,i=0){if(v(s))return t[i+0]=0,t[i+1]=0,t[i+2]=0,void(t[i+3]=0);const{r:e,g:r,b:h,a:n}=s;t[i+0]=e*n/255,t[i+1]=r*n/255,t[i+2]=h*n/255,t[i+3]=n}class st{constructor(){this.symbolLevels=[],this.vvColorValues=new Float32Array(8),this.vvColors=new Float32Array(32),this.vvOpacityValues=new Float32Array(8),this.vvOpacities=new Float32Array(8),this.vvSizeMinMaxValue=new Float32Array(4),this.ddColors=new Float32Array(32),this.ddBackgroundColor=new Float32Array(4),this.ddActiveDots=new Float32Array(8),this._vvMaterialParameters={vvSizeEnabled:!1,vvColorEnabled:!1,vvRotationEnabled:!1,vvRotationType:"geographic",vvOpacityEnabled:!1}}getSizeVVFieldStops(t){const s=this._vvSizeFieldStops;switch(s.type){case"static":return s;case"level-dependent":return k(s.levels[t],(()=>{let i=1/0,e=0;for(const r in s.levels){const s=parseFloat(r),h=Math.abs(t-s);h<i&&(i=h,e=s)}if(i===1/0)return{sizes:new Float32Array([0,0,0,0,0,0]),values:new Float32Array([0,0,0,0,0,0])};const r=2**((t-e)/2),h=T(s.levels[e]),n=new Float32Array(h.values);return n[2]*=r,n[3]*=r,{sizes:T(h.sizes),values:n}}))}}get vvMaterialParameters(){return this._vvMaterialParameters}update(t){y(this._vvInfo)&&this._updateVisualVariables(this._vvInfo.vvRanges,t)}setInfo(t,s,i){this._updateEffects(i),this._vvInfo=s,"dot-density"===t.type&&this._updateDotDensityInfo(t)}getVariation(){return{ddDotBlending:this.ddDotBlending,outsideLabelsVisible:this.outsideLabelsVisible,oesTextureFloat:L().supportsTextureFloat}}getVariationHash(){return(this.ddDotBlending?1:0)|(this.outsideLabelsVisible?1:0)<<1}_updateEffects(t){this.outsideLabelsVisible=!!y(t)&&t.excludedLabelsVisible}_updateVisualVariables(t,s){const i=this._vvMaterialParameters;if(i.vvOpacityEnabled=!1,i.vvSizeEnabled=!1,i.vvColorEnabled=!1,i.vvRotationEnabled=!1,!t)return;const e=t.size;if(e){if(i.vvSizeEnabled=!0,e.minMaxValue){const t=e.minMaxValue;let i,r;if(_(t.minSize)&&_(t.maxSize))if(R(t.minSize)&&R(t.maxSize))i=O(t.minSize),r=O(t.maxSize);else{const e=s.scale;i=O(Y(e,t.minSize.stops)),r=O(Y(e,t.maxSize.stops))}this.vvSizeMinMaxValue.set([t.minDataValue,t.maxDataValue,i,r])}if(e.scaleStops&&(this.vvSizeScaleStopsValue=O(Y(s.scale,e.scaleStops.stops))),e.unitValue){const t=B(s.spatialReference)/P[e.unitValue.unit];this.vvSizeUnitValueToPixelsRatio=t/s.resolution}e.fieldStops&&(this._vvSizeFieldStops=e.fieldStops)}const r=t.color;r&&(i.vvColorEnabled=!0,this.vvColorValues.set(r.values),this.vvColors.set(r.colors));const h=t.opacity;h&&(i.vvOpacityEnabled=!0,this.vvOpacityValues.set(h.values),this.vvOpacities.set(h.opacities));const n=t.rotation;n&&(i.vvRotationEnabled=!0,i.vvRotationType=n.type)}_updateDotDensityInfo(t){const s=t.attributes;this.ddDotValue=t.dotValue,this.ddDotScale=t.referenceScale,this.ddDotSize=t.dotSize,this.ddDotBlending=t.dotBlendingEnabled,this.ddSeed=t.seed;for(let t=0;t<m;t++){const i=t>=s.length?new q([0,0,0,0]):s[t].color;tt(this.ddColors,i,4*t)}for(let s=0;s<8;s++)this.ddActiveDots[s]=s<t.attributes.length?1:0;tt(this.ddBackgroundColor,t.backgroundColor)}}class it extends w{constructor(t){super(t),this._rendererInfo=new st,this._materialItemsRequestQueue=new C,this.attributeView=new X((()=>this.onAttributeStoreUpdate()))}destroy(){this.removeAllChildren(),this.children.forEach((t=>t.destroy())),this.attributeView.destroy(),this._materialItemsRequestQueue.clear()}setRendererInfo(t,s,i){this._rendererInfo.setInfo(t,s,i),this.requestRender()}async getMaterialItems(t,s){if(!t||0===t.length)return null;const i=j();return this._materialItemsRequestQueue.push({items:t,abortOptions:s,resolver:i}),this.requestRender(),i.promise}doRender(t){if(t.context.capabilities.enable("textureFloat"),t.context.capabilities.enable("vao"),this._materialItemsRequestQueue.length>0){let s=this._materialItemsRequestQueue.pop();for(;s;)this._processMaterialItemRequest(t,s),s=this._materialItemsRequestQueue.pop()}super.doRender(t)}renderChildren(t){for(const s of this.children)s.commit(t);this._rendererInfo.update(t.state),super.renderChildren(t)}createRenderParams(t){const s=super.createRenderParams(t);return s.rendererInfo=this._rendererInfo,s.attributeView=this.attributeView,s}onAttributeStoreUpdate(){}_processMaterialItemRequest(t,{items:s,abortOptions:i,resolver:e}){const{painter:r,pixelRatio:h}=t,n=s.map((t=>r.textureManager.rasterizeItem(t.symbol,h,t.glyphIds,i)));Promise.all(n).then((t=>{if(!this.stage)return void e.reject();const i=t.map(((t,i)=>({id:s[i].id,mosaicItem:t})));e.resolve(i)}),e.reject)}}export{$ as f,G as i,it as o}