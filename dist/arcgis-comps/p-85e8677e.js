import{K as t,A as e,af as n,s as r,T as o,Q as s,a7 as a,dI as i,dJ as c,dK as f,a0 as l,cI as u,cj as h}from"./p-e58503d5.js";import{p}from"./p-b9aa4901.js";import{e as d}from"./p-8f986f60.js";import{h as m}from"./p-ccdb8e80.js";import{e as w}from"./p-2c84c65f.js";import{F as y,v as M,w as b}from"./p-a3955219.js";import{n as v}from"./p-f6a340f9.js";import{o as j,r as T,J as x,P as g,d as k,u as F,I as A}from"./p-2f398ed1.js";import{n as K}from"./p-d3105731.js";import{n as W}from"./p-4d38e149.js";import{v as I,F as q,t as z,x as P,b as $}from"./p-c93d2280.js";import{p as C,d as E}from"./p-01e5a461.js";import{u as B,B as J,f as Q,k as R}from"./p-ea916a39.js";import{b as S}from"./p-5e833dfc.js";import{C as V}from"./p-c45aa9e8.js";import{m as Z,l as D,q as G}from"./p-cbbdb7db.js";import{E as H,H as L,V as N}from"./p-7de54cd0.js";function O(t,e,n,r){const o=U(t,e,n),s=w();return I(n,o,s,r),s}function U(t,e,n){const r=K(),o=2**(4*Math.ceil(Math.log(t[3])*Math.LOG2E/4)+1);if(n.isGeographic){const e=o/C(n).radius*180/Math.PI,s=Math.round(t[1]/e),a=Math.max(-90,Math.min(90,s*e)),i=e/Math.cos((Math.abs(a)-e/2)/180*Math.PI),c=Math.round(t[0]/i)*i;r[0]=c,r[1]=a}else{const e=Math.round(t[0]/o),n=Math.round(t[1]/o);r[0]=e*o,r[1]=n*o}const s=Math.round((t[2]+e)/o);return r[2]=s*o,r}function X(t){return t&&parseInt(t.substring(t.lastIndexOf("/")+1,t.length),10)}function Y(e){if(t("disable-feature:i3s-draco")||!e)return!1;for(const t of e)for(const e of t.geometryBuffers){var n;if("draco"===(null==(n=e.compressedAttributes)?void 0:n.encoding))return!0}return!1}function _(t,e,n,r,o,s){o.traverse(n,(n=>{let o=n.mbs;e!==r&&(o=ot,q(n.mbs,r,o,e));const a=st(t,o);return 0!==a&&(s(n,a),!0)}))}function tt(t,e,n){let r=0,o=0;for(let s=0;s<e.length&&r<t.length;s++)t[r]===e[s]&&(n(s)&&(t[o]=t[r],o++),r++);t.length=o}function et(t,e,n){let r=0,o=0;for(;r<n.length;)u(t,n[r])>=0===e&&(n[o]=n[r],o++),r++;n.length=o}const nt=B();function rt(t,e){if(0===e.rotationScale[1]&&0===e.rotationScale[2]&&0===e.rotationScale[3]&&0===e.rotationScale[5]&&0===e.rotationScale[6]&&0===e.rotationScale[7])return nt[0]=(t[0]-e.position[0])/e.rotationScale[0],nt[1]=(t[1]-e.position[1])/e.rotationScale[4],nt[2]=(t[2]-e.position[0])/e.rotationScale[0],nt[3]=(t[3]-e.position[1])/e.rotationScale[4],nt}const ot=W();function st(t,e){const n=e[0],r=e[1],o=e[3],s=t[0]-n,a=n-t[2],i=t[1]-r,c=r-t[3],f=Math.max(s,a,0),l=Math.max(i,c,0),u=f*f+l*l;return u>o*o?0:u>0?1:-Math.max(s,a,i,c)>o?3:2}function at(t,e,n){const r=[],o=n&&n.missingFields,s=n&&n.originalFields;for(const n of t){const t=n.toLowerCase();let a=!1;for(const o of e)if(t===o.name.toLowerCase()){r.push(o.name),a=!0,s&&s.push(n);break}!a&&o&&o.push(n)}return r}async function it(t,i,c,f,l){if(0===i.length)return[];const u=t.attributeStorageInfo;if(e(t.associatedLayer))try{return await async function(t,e,n,r){e.sort(((t,e)=>t.attributes[n]-e.attributes[n]));const o=e.map((t=>t.attributes[n])),s=[],a=at(r,t.fields,{originalFields:s}),i=await ct(t,o,a);for(let t=0;t<e.length;t++){const n=e[t],r=i[t],o={};if(n.attributes)for(const t in n.attributes)o[t]=n.attributes[t];for(let t=0;t<s.length;t++)o[s[t]]=r[a[t]];n.attributes=o}return e}(t.associatedLayer,i,c,f)}catch(e){if(t.associatedLayer.loaded)throw e}if(u){const e=function(t,e,n){const r=new Map,o=[],s=n();for(const n of t){const t=n.attributes[e];for(let e=0;e<s.length;e++){const a=s[e],i=a.featureIds.indexOf(t);if(i>=0){let t=r.get(a.node);t||(t={node:a.node,indices:[],graphics:[]},o.push(t),r.set(a.node,t)),t.indices.push(i),t.graphics.push(n);for(let t=e;t>0;t--)s[t]=s[t-1];s[0]=a;break}}}return o}(i,c,l);if(n(e))throw new r("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");const h=t.parsedUrl.path,p=await Promise.all(e.map((t=>function(t,e,n,r,a){const i=[];for(const r of e)r&&-1!==a.indexOf(r.name)&&i.push({url:`${t}/nodes/${n.resources.attributes}/attributes/${r.key}/0`,storageInfo:r});return o(i.map((t=>s(t.url,{responseType:"array-buffer"}).then((e=>V(t.storageInfo,e.data)))))).then((t=>{const e=[];for(const n of r){const r={};for(let e=0;e<t.length;e++)null!=t[e].value&&(r[i[e].storageInfo.name]=ft(t[e].value,n));e.push(r)}return e}))}(h,u,t.node,t.indices,f).then((e=>{for(let n=0;n<t.graphics.length;n++){const r=t.graphics[n],o=e[n];if(r.attributes)for(const t in r.attributes)t in o||(o[t]=r.attributes[t]);r.attributes=o}return t.graphics})))));return a(p)}throw new r("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function ct(t,e,n){const o=t.capabilities.query.maxRecordCount;if(null!=o&&e.length>o){const r=i(e,o);return Promise.all(r.map((e=>ct(t,e,n)))).then(a)}const s=new S({objectIds:e,outFields:n,orderByFields:[t.objectIdField]});return t.queryFeatures(s).then((t=>{if(t&&t.features&&t.features.length===e.length)return t.features.map((t=>t.attributes));throw new r("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")}))}function ft(t,e){if(!t)return null;const n=t[e];return c(t)?-32768===n?null:n:f(t)?-2147483648===n?null:n:n!=n?null:n}function lt(t){const e=t.store.indexCRS||t.store.geographicCRS,n=void 0===e?t.store.indexWKT:void 0;if(n){if(!t.spatialReference)throw new r("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indeWKT in the scene layer store but no layer spatial reference",{});if(n!==t.spatialReference.wkt)throw new r("layerview:store-spatial-reference-wkt-index-incompatible","The indeWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const o=e?new l(X(e)):t.spatialReference;return o.equals(t.spatialReference)?t.spatialReference:o}function ut(t){const e=t.store.vertexCRS||t.store.projectedCRS,n=void 0===e?t.store.vertexWKT:void 0;if(n){if(!t.spatialReference)throw new r("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(n!==t.spatialReference.wkt)throw new r("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const o=e?new l(X(e)):t.spatialReference;return o.equals(t.spatialReference)?t.spatialReference:o}function ht(t,e){return n(e)?"@null":e===E(e)?"@ECEF":t.equals(e)?"":null!=e.wkid?"@"+e.wkid:null}function pt(t,e,n){if(!z(t,e))throw new r("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===n&&!function(t,e){return t.equals(e)||t.isWGS84&&e.isWebMercator||t.isWebMercator&&e.isWGS84}(t,e))throw new r("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{})}function dt(t,e,n){const r=lt(t),o=ut(t);pt(r,e,n),pt(o,e,n)}function mt(t){if(null==t.store||null==t.store.defaultGeometrySchema||!function(t){return!(null!=t.geometryType&&"triangles"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null==t.vertexAttributes||null==t.vertexAttributes.position)}(t.store.defaultGeometrySchema))throw new r("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:t.parsedUrl.path})}function wt(t,e){dt(t,e.spatialReference,e.viewingMode)}function yt(t){if(null==t.store||null==t.store.defaultGeometrySchema||!function(t){return!(null==t.geometryType||"points"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null!=t.encoding&&""!==t.encoding&&"lepcc-xyz"!==t.encoding||null==t.vertexAttributes||null==t.vertexAttributes.position)}(t.store.defaultGeometrySchema))throw new r("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function Mt(t,e){pt(t.spatialReference,e.spatialReference,e.viewingMode)}function bt(t){return"mesh-3d"===t.type}function vt(t){if(null==t||!function(t){return"simple"===t.type||"class-breaks"===t.type||"unique-value"===t.type}(t))return!0;if(("unique-value"===t.type||"class-breaks"===t.type)&&null==t.defaultSymbol)return!0;const e=t.getSymbols();if(0===e.length)return!0;for(const t of e){if(!bt(t)||0===t.symbolLayers.length)return!0;for(const e of t.symbolLayers.items)if("fill"!==e.type||n(e.material)||n(e.material.color)||"replace"!==e.material.colorMixMode)return!0}return!1}const jt=Z({color:[0,0,0,0],opacity:0});class Tt{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function xt(t){const n=new Tt;let r=!1,o=!1;for(const s of t.symbolLayers.items)if("fill"===s.type&&s.enabled){const t=s.material,a=s.edges;if(e(t)&&!r){const o=t.color,a=G(t.colorMixMode);n.material=e(o)?{color:[o.r/255,o.g/255,o.b/255],alpha:o.a,colorMixMode:a}:{color:[1,1,1],alpha:1,colorMixMode:1},n.castShadows=s.castShadows,r=!0}e(a)&&!o&&(n.edgeMaterial=D(a,{}),o=!0)}return n.material||(n.material={color:[1,1,1],alpha:1,colorMixMode:1}),n}function gt(t,e){return(0|t)+(0|e)|0}function kt(t,e,n,r,o=0){r===E(r)?e.isGeographic?function(t,e,n,r){const o=C(n),s=1+Math.max(0,r)/(o.radius+t.center[2]);j(e.center,t.center[0],t.center[1],t.center[2]+r),P(e.center,n,0,e.center,E(n),0,1),y(e.quaternion,t.quaternion),b($t,t.quaternion),j(Qt,0,0,1),g(Qt,Qt,$t),j(Qt,t.halfSize[0]*Math.abs(Qt[0]),t.halfSize[1]*Math.abs(Qt[1]),t.halfSize[2]*Math.abs(Qt[2])),k(Qt,Qt,o.inverseFlattening),F(e.halfSize,t.halfSize,Qt),k(e.halfSize,e.halfSize,s)}(t,n,e,o):function(t,e,n,r){N(t,Ct),j(e.center,t.center[0],t.center[1],t.center[2]+r),I(n,e.center,Pt,E(n)),j(e.center,Pt[12],Pt[13],Pt[14]);const o=2*Math.sqrt(1+Pt[0]+Pt[5]+Pt[10]);$t[0]=(Pt[6]-Pt[9])/o,$t[1]=(Pt[8]-Pt[2])/o,$t[2]=(Pt[1]-Pt[4])/o,$t[3]=.25*o,M(e.quaternion,$t,t.quaternion),b($t,e.quaternion);let s=0,a=0,i=0;for(const t of Ct)t[2]+=r,P(t,n,0,t,E(n),0,1),x(Qt,t,e.center),g(Qt,Qt,$t),s=Math.max(s,Math.abs(Qt[0])),a=Math.max(a,Math.abs(Qt[1])),i=Math.max(i,Math.abs(Qt[2]));j(e.halfSize,s,a,i)}(t,n,e,o):e.isWGS84&&(r.isWebMercator||h(r))?function(t,e,n,r,o){T(Wt,e.center),Wt[2]+=o;const s=E(n);P(Wt,t,0,Wt,s,0,1),qt(s,e,Wt,n,r)}(e,t,r,n,o):e.isWebMercator&&h(r)?function(t,e,n,r,o){T(Wt,e.center),Wt[2]+=o,qt(t,e,Wt,n,r)}(e,t,r,n,o):t===n?(n.center[2]+=o,P(n.center,e,0,n.center,r,0,1)):(j(n.center,t.center[0],t.center[1],t.center[2]+o),P(n.center,e,0,n.center,r,0,1),y(n.quaternion,t.quaternion),T(n.halfSize,t.halfSize))}const Ft=new Float64Array(24),At={data:Ft,size:3},Kt=K(),Wt=K(),It=d();function qt(t,e,n,r,o){const s=p(It,e.quaternion);for(let t=0;t<8;++t){for(let n=0;n<3;++n)Kt[n]=e.halfSize[n]*(0!=(t&1<<n)?-1:1);for(let e=0;e<3;++e){let r=n[e];for(let t=0;t<3;++t)r+=Kt[t]*s[3*t+e];Ft[3*t+e]=r}}P(Ft,t,0,Ft,r,0,8),L(At,o)}function zt(t,r,o,s,a,i){if(!i||0===i.length||n(r))return null;const c=O(t.mbs,a,o,r);let f;m(St,c);const l=()=>{if(!f)if(f=Ct,J(Bt),e(t.serviceObb)){kt(t.serviceObb,o,Jt,r,a),N(Jt,f);for(const t of f)A(t,t,St),Q(Bt,t)}else{const e=t.mbs,n=e[3];$(e,o,Qt,r),A(Qt,Qt,St),Qt[2]+=a;for(let t=0;t<8;++t){const e=f[t];T(e,[Qt[0]+(1&t?n:-n),Qt[1]+(2&t?n:-n),Qt[2]+(4&t?n:-n)]),Q(Bt,e)}}};let u=1/0,h=-1/0;if(i.forEach((t=>(t=>{if("replace"!==t.type)return;const e=t.geometry;if(!e.hasZ)return;J(Et);const n=e.spatialReference||s,o=e.rings.reduce(((t,e)=>e.reduce(((t,e)=>($(e,n,Qt,r),A(Qt,Qt,St),Q(Et,Qt),Math.min(Qt[2],t))),t)),1/0);l(),R(Bt,Et)&&(u=Math.min(u,o),h=Math.max(h,o))})(t))),u===1/0)return null;const p=(t,e,n)=>{A(Qt,n,c),t[e+0]=Qt[0],t[e+1]=Qt[1],t[e+2]=Qt[2],e+=24,n[2]=u,A(Qt,n,c),t[e+0]=Qt[0],t[e+1]=Qt[1],t[e+2]=Qt[2],e+=24,n[2]=h,A(Qt,n,c),t[e+0]=Qt[0],t[e+1]=Qt[1],t[e+2]=Qt[2]};for(let t=0;t<8;++t)p(Rt.data,3*t,f[t]);return L(Rt)}const Pt=w(),$t=v(),Ct=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],Et=B(),Bt=B(),Jt=H(),Qt=[0,0,0],Rt={data:new Array(72),size:3},St=w();export{xt as A,kt as C,gt as I,mt as M,Mt as R,dt as S,vt as W,Y as X,_ as Y,zt as Z,tt as _,O as a,ht as b,ft as c,lt as d,et as e,pt as g,U as h,it as i,st as n,yt as q,rt as r,at as s,wt as x,ut as y,jt as z}