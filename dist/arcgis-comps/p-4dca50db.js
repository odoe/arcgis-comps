import{A as t,J as s,K as e,Q as h,ap as n,ax as o,s as a,b as c,aw as l,c as u,h as d,ad as p,af as f,d8 as m,r as w,aI as g,B as b,a as y,p as v,e as j,d as _,i as M,aE as x,u as T,cu as S,ct as P,cD as A}from"./p-e58503d5.js";import{s as k,n as F,r as z}from"./p-d3105731.js";import{n as R,i as U,c as C}from"./p-1e473dab.js";import{e as $}from"./p-d57f9971.js";import{C as B,F as E,H as I,S as D,$ as O,M as L,I as G,K as N}from"./p-6484267b.js";import{r as V,D as q,s as H,a as W}from"./p-e6fe5d89.js";import{n as Z}from"./p-746a9d8f.js";import{n as J,s as K}from"./p-1a7268a2.js";import{f as Q,h as Y,l as X,e as tt}from"./p-19bc1e3d.js";import{o as st}from"./p-0bb84768.js";import{t as it,n as et}from"./p-ad14ca1b.js";import{t as ht}from"./p-db4d63dc.js";import{n as rt}from"./p-56ca6f1f.js";import{e as nt,d as ot,o as at,h as ct,b as lt,s as ut,c as dt}from"./p-1f1360f9.js";import{I as pt,c as ft,O as mt,d as wt,u as gt,n as bt,i as yt,f as vt,a as jt,s as _t,l as Mt,o as xt,m as Tt,E as St}from"./p-e3500fdc.js";import{s as Pt,r as At,G as kt}from"./p-1676d4c7.js";import{c as Ft}from"./p-677fe242.js";import{t as zt}from"./p-6683efcf.js";import{u as Rt,c as Ut,i as Ct}from"./p-fb38a9d0.js";import{n as $t}from"./p-56ed1c7a.js";import{m as Bt}from"./p-6cd1d477.js";import{Y as Et,y as It,u as Dt,J as Ot,A as Lt,B as Gt,F as Nt,E as Vt,T as qt,P as Ht,Q as Wt}from"./p-47e1bd73.js";import{t as Zt}from"./p-2d0c34e5.js";import{a as Jt}from"./p-9d34911e.js";import{o as Kt}from"./p-025c0c8e.js";import{P as Qt}from"./p-a617738c.js";import{e as Yt}from"./p-c232e25f.js";import{a as Xt}from"./p-75cd09f2.js";import{s as ts}from"./p-7ec84656.js";import{e as ss}from"./p-8e6f6b13.js";import{d as is,a as es,f as hs}from"./p-de5b11d6.js";import{a as rs}from"./p-7731c620.js";import{k as ns,u as os}from"./p-612a2c14.js";import{e as as,d as cs}from"./p-2f398ed1.js";import{t as ls}from"./p-c0f84cd3.js";import{m as us}from"./p-6b2eb7a7.js";export{r as GraphicsView2D}from"./p-f7106e47.js";export{i as GraphicContainer}from"./p-b8b8ba99.js";import{u as ds}from"./p-eee9ef50.js";import"./p-b79fcce3.js";import{a as ps}from"./p-1c2ff3a7.js";import"./p-53bb6ab4.js";import"./p-400ca3dc.js";import"./p-efbca0ca.js";import"./p-9b7a2176.js";import"./p-e654504b.js";import"./p-0eb619a6.js";import"./p-4d17d2cd.js";import"./p-e273719b.js";import"./p-74de0937.js";import"./p-b5b00e38.js";import"./p-a9a30646.js";import"./p-765e6c28.js";import"./p-e94b450b.js";import"./p-1189fa83.js";import"./p-37058f88.js";import"./p-3e39c093.js";import"./p-8747982c.js";import"./p-7a5bfd29.js";import"./p-7d081d01.js";import"./p-54330161.js";import"./p-93765525.js";import"./p-8bc9b36a.js";import"./p-7a658388.js";import"./p-f94762ac.js";import"./p-ea916a39.js";import"./p-8a919d07.js";import"./p-c048b814.js";import"./p-afac6fb2.js";import"./p-01e5a461.js";import"./p-ca295674.js";import"./p-5d962998.js";import"./p-41f2b2dd.js";import"./p-76f37e40.js";import"./p-da33e926.js";import"./p-d1d9dbe4.js";import"./p-b9aa4901.js";import"./p-b8beb0d3.js";import"./p-b312c1fd.js";import"./p-b392deaf.js";import"./p-9790d1b4.js";import"./p-0bb41218.js";import"./p-a24f7752.js";import"./p-ccdb8e80.js";import"./p-bdf9e611.js";import"./p-5763113b.js";import"./p-09dd2137.js";import"./p-4414d64f.js";import"./p-b9c93bb2.js";import"./p-f971b161.js";import"./p-6fe4db61.js";import"./p-dc15ecc1.js";import"./p-9e860e7b.js";import"./p-0923eebd.js";import"./p-4019eec3.js";import"./p-6448f4dc.js";import"./p-77b9a0fc.js";import"./p-cd36fe2a.js";import"./p-5032dfbd.js";import"./p-182bb5be.js";import"./p-db87794e.js";import"./p-889f7a78.js";import"./p-612de336.js";import"./p-9b76ac50.js";import"./p-3a6cfd25.js";import"./p-237460e0.js";import"./p-5e833dfc.js";import"./p-a131049b.js";import"./p-a2324023.js";import"./p-f94ceb31.js";import"./p-2e8ad983.js";import"./p-97ec6ae5.js";import"./p-8acbca5b.js";import"./p-b05e75b2.js";import"./p-81b9df84.js";import"./p-e9bae5e9.js";import"./p-b0565d49.js";import"./p-f3659a34.js";import"./p-285c6a34.js";import"./p-480e5606.js";import"./p-db63fa0e.js";import"./p-9658240e.js";import"./p-c93d2280.js";import"./p-fea9512d.js";import"./p-d443df87.js";import"./p-7ca40eac.js";import"./p-9087b4d3.js";import"./p-c1cd5521.js";import"./p-ca4492df.js";import"./p-2db4840f.js";import"./p-bba8b671.js";import"./p-dc852195.js";import"./p-ff2962f5.js";import"./p-da9e7ba9.js";import"./p-a8f0aa27.js";import"./p-4a96de15.js";import"./p-a87cccba.js";import"./p-dae095dd.js";import"./p-0e784e4d.js";import"./p-dbdf15fc.js";import"./p-e0d9ff4c.js";import"./p-08e5f531.js";import"./p-dfc6337f.js";import"./p-9f1c2d50.js";import"./p-1f81b35d.js";import"./p-5ce39624.js";import"./p-51a17e75.js";import"./p-d208934e.js";import"./p-22c9f19c.js";import"./p-c096b5df.js";import"./p-4a6dc5e4.js";import"./p-6a92ecb9.js";import"./p-1ab449fc.js";import"./p-a6c8fb32.js";import"./p-0edb3309.js";import"./p-e8160b60.js";import"./p-e3270d48.js";import"./p-e44bd0a6.js";import"./p-fe68aab5.js";import"./p-c6970847.js";import"./p-de86b3c9.js";import"./p-37d3434c.js";import"./p-120b7410.js";import"./p-b1eff69d.js";import"./p-91fe06d4.js";import"./p-ab0e9273.js";import"./p-15a9486c.js";import"./p-2ae44317.js";import"./p-9f58a277.js";import"./p-ca657fcf.js";import"./p-2a99994a.js";import"./p-8925cd73.js";import"./p-eec31d91.js";import"./p-e49308c6.js";import"./p-50ff864e.js";import"./p-db566ae7.js";import"./p-1ccb0bf6.js";import"./p-a2b6db85.js";import"./p-2e5dd2d0.js";import"./p-c5443b47.js";import"./p-e991a11e.js";import"./p-7a68337e.js";import"./p-c2152437.js";import"./p-6ded4c02.js";const fs={shaders:{vertexShader:Pt("bitBlit/bitBlit.vert"),fragmentShader:Pt("bitBlit/bitBlit.frag")},attributes:new Map([["a_pos",0],["a_tex",1]])};class ms{constructor(){this._initialized=!1}dispose(){this._program&&(this._program.dispose(),this._program=null),this._vertexArrayObject&&(this._vertexArrayObject.dispose(),this._vertexArrayObject=null)}render(t,s,i,e){t&&(this._initialized||this._initialize(t),t.setBlendFunctionSeparate(1,771,1,771),t.bindVAO(this._vertexArrayObject),t.useProgram(this._program),s.setSamplingMode(i),t.bindTexture(s,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",e),t.drawArrays(5,0,4),t.bindTexture(null,0),t.bindVAO())}_initialize(t){if(this._initialized)return!0;const s=fs.attributes,i=it(t,fs);if(!i)return!1;const e=new Int8Array(16);e[0]=-1,e[1]=-1,e[2]=0,e[3]=0,e[4]=1,e[5]=-1,e[6]=1,e[7]=0,e[8]=-1,e[9]=1,e[10]=0,e[11]=1,e[12]=1,e[13]=1,e[14]=1,e[15]=1;const h=new Q(t,s,{geometry:[{name:"a_pos",count:2,type:5120,offset:0,stride:4,normalized:!1,divisor:0},{name:"a_tex",count:2,type:5120,offset:2,stride:4,normalized:!1,divisor:0}]},{geometry:Y.createVertex(t,35044,e)});return this._program=i,this._vertexArrayObject=h,this._initialized=!0,!0}}const ws=t=>{let s="";s+=t[0].toUpperCase();for(let i=1;i<t.length;i++){const e=t[i];e===e.toUpperCase()?(s+="_",s+=e):s+=e.toUpperCase()}return s},gs=t=>{const s={};for(const i in t)s[ws(i)]=t[i];return et(s)},bs=(t,s,i)=>{const e=t+t.substring(t.lastIndexOf("/")),h=s+s.substring(s.lastIndexOf("/"));return{attributes:i,shaders:t=>({vertexShader:gs(t)+Pt(`${e}.vert`),fragmentShader:gs(t)+Pt(`${h}.frag`)})}},ys=t=>t===pt.HITTEST||t===pt.LABEL_ALPHA;class vs{constructor(t){this._programByKey=new Map,this._programCache=new zt(t)}dispose(){this._programCache&&this._programCache.dispose()}getProgram(t,s,i=[],e=[]){const h=s.vsPath+"."+s.fsPath+JSON.stringify(i)+e.join(".");if(this._programByKey.has(h))return this._programByKey.get(h);const r=e.reduce(((s,i)=>({...s,[i]:t.context.driverTest[i]})),{}),n={...i.map((t=>"string"==typeof t?{name:t,value:!0}:t)).reduce(((t,s)=>({...t,[s.name]:s.value})),{}),...r},{vsPath:o,fsPath:a,attributes:c}=s,l=this._programCache.getProgram(bs(o,a,c),n);if(!l)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(h,l),l}getMaterialProgram(s,i,e,h,r,n=["ignoresSamplerPrecision"]){const o=(({rendererInfo:s,drawPhase:i},e,h,r)=>`${e.getVariationHash()}-${r.join(".")}-${(t=>(ys(t)?1:0)|(t===pt.HIGHLIGHT?2:0))(i)}-${s.getVariationHash()}-${t(h)&&h.join(".")}`)(s,i,r,n);if(this._programByKey.has(o))return this._programByKey.get(o);const a=((s,i,e,h)=>{const r=h.reduce(((t,i)=>({...t,[i]:s.context.driverTest[i]})),{}),n={...i.getVariation(),...s.rendererInfo.getVariation(),highlight:s.drawPhase===pt.HIGHLIGHT,id:ys(s.drawPhase),...r};if(t(e))for(const t of e)n[t]=!0;return n})(s,i,r,n),c=this._programCache.getProgram(bs(e,e,h),a);if(!c)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(o,c),c}}class js{constructor(t,s){this._width=0,this._height=0,this._free=[],this._width=t,this._height=s,this._free.push(new Zt(0,0,t,s))}get width(){return this._width}get height(){return this._height}allocate(t,s){if(t>this._width||s>this._height)return new Zt;let i=null,e=-1;for(let h=0;h<this._free.length;++h){const r=this._free[h];t<=r.width&&s<=r.height&&(null===i||r.y<=i.y&&r.x<=i.x)&&(i=r,e=h)}return null===i?new Zt:(this._free.splice(e,1),i.width<i.height?(i.width>t&&this._free.push(new Zt(i.x+t,i.y,i.width-t,s)),i.height>s&&this._free.push(new Zt(i.x,i.y+s,i.width,i.height-s))):(i.width>t&&this._free.push(new Zt(i.x+t,i.y,i.width-t,i.height)),i.height>s&&this._free.push(new Zt(i.x,i.y+s,t,i.height-s))),new Zt(i.x,i.y,t,s))}release(t){for(let s=0;s<this._free.length;++s){const i=this._free[s];if(i.y===t.y&&i.height===t.height&&i.x+i.width===t.x)i.width+=t.width;else if(i.x===t.x&&i.width===t.width&&i.y+i.height===t.y)i.height+=t.height;else if(t.y===i.y&&t.height===i.height&&t.x+t.width===i.x)i.x=t.x,i.width+=t.width;else{if(t.x!==i.x||t.width!==i.width||t.y+t.height!==i.y)continue;i.y=t.y,i.height+=t.height}this._free.splice(s,1),this.release(t)}this._free.push(t)}}const _s=t=>Math.floor(t/256);class Ms{constructor(t,s,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=s,this._glyphSource=i,this._binPack=new js(t-4,s-4),this._glyphData.push(new Uint8Array(t*s)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph()}dispose(){this._binPack=null;for(const t of this._textures)t&&t.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyph(){const t=[117,149,181,207,207,181,149,117],s=[];for(let i=0;i<t.length;i++){const e=t[i];for(let t=0;t<11;t++)s.push(e)}const i={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(s)};this._recordGlyph(i)}async getGlyphItems(t,s,i){const e=this._getGlyphCache(t);return await this._fetchRanges(t,s,i),s.map((s=>this._getMosaicItem(e,t,s)))}bind(t,s,i,e){const h=this._getTexture(t,i);h.setSamplingMode(s),this._dirties[i]&&(h.setData(this._glyphData[i]),this._dirties[i]=!1),t.bindTexture(h,e)}_getGlyphCache(t){return this._glyphCache[t]||(this._glyphCache[t]={}),this._glyphCache[t]}_getTexture(t,s){return this._textures[s]||(this._textures[s]=new st(t,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height))),this._textures[s]}_invalidate(){this._dirties[this._currentPage]=!0}async _fetchRanges(t,s,i){const e=function(t){const s=new Set;for(const i of t)s.add(_s(i));return s}(s),h=[];e.forEach((s=>{h.push(this._fetchRange(t,s,i))})),await Promise.all(h)}async _fetchRange(t,i,e){return i>256?null:function(t,i,e){return t.has(i)||t.set(i,e().then((()=>{t.delete(i)})).catch((e=>{t.delete(i),s(e)}))),t.get(i)}(this._rangePromises,t+i,(()=>this._glyphSource.getRange(t,i,e)))}_getMosaicItem(t,s,i){if(!t[i]){const e=this._glyphSource.getGlyph(s,i);if(!e||!e.metrics)return(t=>({rect:new Zt(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:t,sdf:!0}))(i);const h=this._recordGlyph(e);t[i]={rect:h,page:this._currentPage,metrics:e.metrics,code:i,sdf:!0},this._invalidate()}return t[i]}_recordGlyph(t){const s=t.metrics;let i;if(0===s.width)i=new Zt(0,0,0,0);else{const h=3,r=s.width+2*h,n=s.height+2*h;i=this._binPack.allocate(r,n),i.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph(),this._binPack=new js(this.width-4,this.height-4),i=this._binPack.allocate(r,n));const o=this._glyphData[this._currentPage],a=t.bitmap;let c,l;if(a)for(let t=0;t<n;t++){c=r*t,l=this.width*(i.y+t)+i.x;for(let t=0;t<r;t++)o[l+t]=a[c+t]}e("esri-glyph-debug")&&this._showDebugPage(o)}return i}_showDebugPage(t){const s=document.createElement("canvas"),i=s.getContext("2d"),e=new ImageData(this.width,this.height),h=e.data;s.width=this.width,s.height=this.height,s.style.border="1px solid black";for(let s=0;s<t.length;++s)h[4*s+0]=t[s],h[4*s+1]=0,h[4*s+2]=0,h[4*s+3]=255;i.putImageData(e,0,0),document.body.appendChild(s)}}class xs{constructor(t){for(this._metrics=[],this._bitmaps=[];t.next();)switch(t.tag()){case 1:{const s=t.getMessage();for(;s.next();)switch(s.tag()){case 3:{const t=s.getMessage();let i,e,h,r,n,o,a;for(;t.next();)switch(t.tag()){case 1:i=t.getUInt32();break;case 2:e=t.getBytes();break;case 3:h=t.getUInt32();break;case 4:r=t.getUInt32();break;case 5:n=t.getSInt32();break;case 6:o=t.getSInt32();break;case 7:a=t.getUInt32();break;default:t.skip()}t.release(),i&&(this._metrics[i]={width:h,height:r,left:n,top:o,advance:a},this._bitmaps[i]=e);break}default:s.skip()}s.release();break}default:t.skip()}}getMetrics(t){return this._metrics[t]}getBitmap(t){return this._bitmaps[t]}}class Ts{constructor(){this._ranges=[]}getRange(t){return this._ranges[t]}addRange(t,s){this._ranges[t]=s}}class Ss{constructor(t){this._glyphInfo={},this._baseURL=t}getRange(t,s,i){const e=this._getFontStack(t);if(e.getRange(s))return Promise.resolve();const r=256*s,n=r+255,o=this._baseURL.replace("{fontstack}",t).replace("{range}",r+"-"+n);return h(o,{responseType:"array-buffer",...i}).then((t=>{e.addRange(s,new xs(new Jt(new Uint8Array(t.data),new DataView(t.data))))}))}getGlyph(t,s){const i=this._getFontStack(t);if(!i)return;const e=Math.floor(s/256);if(e>256)return;const h=i.getRange(e);return h?{metrics:h.getMetrics(s),bitmap:h.getBitmap(s)}:void 0}_getFontStack(t){let s=this._glyphInfo[t];return s||(s=this._glyphInfo[t]=new Ts),s}}const Ps=1e20;class As{constructor(t){this.size=t;const s=document.createElement("canvas");s.width=s.height=t,this._context=s.getContext("2d"),this._gridOuter=new Float64Array(t*t),this._gridInner=new Float64Array(t*t),this._f=new Float64Array(t),this._d=new Float64Array(t),this._z=new Float64Array(t+1),this._v=new Int16Array(t)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(t,s,i=31){this._initSVG();const e=this.createSVGString(t);return new Promise(((t,h)=>{const r=new Image;r.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(e),r.onload=()=>{r.onload=null,this._context.clearRect(0,0,this.size,this.size),this._context.drawImage(r,0,0,this.size,this.size);const s=this._context.getImageData(0,0,this.size,this.size),e=new Uint8Array(this.size*this.size*4);for(let t=0;t<this.size*this.size;t++){const i=s.data[4*t+3]/255;this._gridOuter[t]=1===i?0:0===i?Ps:Math.max(0,.5-i)**2,this._gridInner[t]=1===i?Ps:0===i?0:Math.max(0,i-.5)**2}this._edt(this._gridOuter,this.size,this.size),this._edt(this._gridInner,this.size,this.size);for(let t=0;t<this.size*this.size;t++)Kt(.5-(this._gridOuter[t]-this._gridInner[t])/(2*i),e,4*t);t(e)};const a=s&&s.signal;a&&n(a,(()=>h(o())))}))}_initSVG(){if(!this._svg){const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("style","position: absolute;"),t.setAttribute("width","0"),t.setAttribute("height","0"),t.setAttribute("aria-hidden","true"),t.setAttribute("role","presentation"),document.body.appendChild(t),this._svg=t}}createSVGString(t){this._initSVG();const s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttribute("d",t),this._svg.appendChild(s);const i=s.getBBox(),e=i.width/i.height,h=this.size/2;let r,n,o,a;e>1?(n=r=h/i.width,o=this.size/4,a=h-h*(1/e)/2):(r=n=h/i.height,o=h-h*e/2,a=this.size/4),s.setAttribute("style",`transform: matrix(${r}, 0, 0, ${n}, ${-i.x*r+o}, ${-i.y*n+a})`);const c=`<svg style="fill:red;" height="${this.size}" width="${this.size}" xmlns="http://www.w3.org/2000/svg">${this._svg.innerHTML}</svg>`;return this._svg.removeChild(s),c}_edt(t,s,i){const e=this._f,h=this._d,r=this._v,n=this._z;for(let o=0;o<s;o++){for(let h=0;h<i;h++)e[h]=t[h*s+o];this._edt1d(e,h,r,n,i);for(let e=0;e<i;e++)t[e*s+o]=h[e]}for(let o=0;o<i;o++){for(let i=0;i<s;i++)e[i]=t[o*s+i];this._edt1d(e,h,r,n,s);for(let i=0;i<s;i++)t[o*s+i]=Math.sqrt(h[i])}}_edt1d(t,s,i,e,h){i[0]=0,e[0]=-Ps,e[1]=+Ps;for(let s=1,r=0;s<h;s++){let h=(t[s]+s*s-(t[i[r]]+i[r]*i[r]))/(2*s-2*i[r]);for(;h<=e[r];)r--,h=(t[s]+s*s-(t[i[r]]+i[r]*i[r]))/(2*s-2*i[r]);r++,i[r]=s,e[r]=h,e[r+1]=+Ps}for(let r=0,n=0;r<h;r++){for(;e[n+1]<r;)n++;s[r]=(r-i[n])*(r-i[n])+t[i[n]]}}}function ks(t){return t&&"static"===t.type}class Fs{constructor(t,s,i,e=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(s<=0||i<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=s,this._pageHeight=i,this._requestRender=t,e>0&&(this._maxItemSize=e),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new js(this._pageWidth,this._pageHeight);const h=Math.floor(this._pageWidth),r=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(h*r)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[0]}getHeight(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[1]}getPageTexture(t){return t<this._mosaicPages.length?this._mosaicPages[t].texture:null}has(t){return this._mosaicRects.has(t)}get itemCount(){return this._mosaicRects.size}getSpriteItem(t){return this._mosaicRects.get(t)}addSpriteItem(t,s,i,e,h,r){if(this._mosaicRects.has(t))return this._mosaicRects.get(t);let n,o,a;if(ks(i)?[n,o,a]=this._allocateImage(s[0],s[1]):(n=new Zt(0,0,s[0],s[1]),o=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:i,size:s,dirty:!0,texture:void 0})),n.width<=0||n.height<=0)return null;const c={rect:n,width:s[0],height:s[1],sdf:h,simplePattern:r,pixelRatio:1,page:o};return this._mosaicRects.set(t,c),ks(i)&&this._copy({rect:n,spriteSize:s,spriteData:i.data,page:o,pageSize:a,repeat:e,sdf:h}),c}hasItemsToProcess(){return 0!==this._spriteCopyQueue.length}processNextItem(){const t=this._spriteCopyQueue.pop();t&&this._copy(t)}getSpriteItems(t){const s={};for(const i of t)s[i]=this.getSpriteItem(i);return s}getMosaicItemPosition(t){const s=this.getSpriteItem(t),i=s&&s.rect;if(!i)return null;i.width=s.width,i.height=s.height;const e=this._mosaicPages[s.page];return{size:[s.width,s.height],tl:[(i.x+Et)/e[0],(i.y+Et)/e[1]],br:[(i.x+Et+s.width)/e[0],(i.y+Et+s.height)/e[1]],page:s.page}}bind(s,i,e=0,h=0){const r=this._mosaicPages[e],n=r.mosaicsData;let o=r.texture;if(o||(o=function(t,s,i){return ks(s)?new st(t,{pixelFormat:6408,dataType:5121,width:i[0],height:i[1]},new Uint8Array(s.data.buffer)):new st(t,{pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:i[0],height:i[1]},null)}(s,n,r.size),r.texture=o),o.setSamplingMode(i),ks(n))s.bindTexture(o,h),r.dirty&&(o.setData(new Uint8Array(n.data.buffer)),o.generateMipmap());else{const i=n.data,e=i.bindFrame(s,o,h);t(this._requestRender)&&e&&i.frameCount>0&&this._requestRender.requestRender(),i.bindFrame(s,o,h)}r.dirty=!1}static _copyBits(t,s,i,e,h,r,n,o,a,c,l){let u=e*s+i,d=o*r+n;if(l){d-=r;for(let n=-1;n<=c;n++,u=((n+c)%c+e)*s+i,d+=r)for(let s=-1;s<=a;s++)h[d+s]=t[u+(s+a)%a]}else for(let i=0;i<c;i++){for(let s=0;s<a;s++)h[d+s]=t[u+s];u+=s,d+=r}}_copy(t){if(t.page>=this._mosaicPages.length)return;const s=this._mosaicPages[t.page],i=s.mosaicsData;if(!ks(s.mosaicsData))throw new a("mapview-invalid-resource","unsuitable data type!");const e=t.spriteData,h=i.data;h&&e||console.error("Source or target images are uninitialized!"),Fs._copyBits(e,t.spriteSize[0],0,0,h,t.pageSize[0],t.rect.x+Et,t.rect.y+Et,t.spriteSize[0],t.spriteSize[1],t.repeat),s.dirty=!0}_allocateImage(t,s){t+=2*Et,s+=2*Et;const i=Math.max(t,s);if(this._maxItemSize&&this._maxItemSize<i){const i=2**Math.ceil(Qt(t)),e=2**Math.ceil(Qt(s)),h=new Zt(0,0,t,s);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(i*e)},size:[i,e],dirty:!0,texture:void 0}),[h,this._mosaicPages.length-1,[i,e]]}const e=this._binPack.allocate(t,s);if(e.width<=0){const i=this._mosaicPages[this._currentPage];return!i.dirty&&ks(i.mosaicsData)&&(i.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new js(this._pageWidth,this._pageHeight),this._allocateImage(t,s)}return[e,this._currentPage,[this._pageWidth,this._pageHeight]]}dispose(){this._binPack=null;for(const t of this._mosaicPages){const s=t.texture;s&&s.dispose();const i=t.mosaicsData;ks(i)||i.data.pause()}this._mosaicPages=null,this._mosaicRects.clear()}}const zs=new Uint32Array(256);for(let t=0;t<256;t++){let s=t;for(let t=0;t<8;t++)s=0!=(1&s)?3988292384^s>>>1:s>>>1;zs[t]=s}const Rs=new a("Not a PNG"),Us=new a("Not an animated PNG"),Cs=new Uint8Array([137,80,78,71,13,10,26,10]);function $s(t){const s=t.constructor===Uint8Array?t:new Uint8Array(t);return!Cs.some(((t,i)=>t!==s[i]))}class Bs{constructor(){this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[],this.paused=!1,this.playing=!1,this.playSpeed=1,this.currentFrameNumber=0,this._lastUsedFrame=-1}static async create(t,s){const i=new Bs;try{await i._load(t,s)}catch(t){if(!c(t))return new a("invalid-resource",`Could not load PNG: ${t.message}`)}return i}play(){this.playing||(this.paused=!1,this.playing=!0,this._play())}pause(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)}togglePlay(){this.paused||!this.playing?this.play():this.pause()}bindFrame(t,s,i){t.bindTexture(s,i);const e=this.frameChanged();if(!e)return!1;const h=this.currentFrame,r=h.frameData,n=s.descriptor;return(h.left||h.top||h.width!==n.width||h.height!==n.height)&&s.setData(null),s.updateData(0,h.left,h.top,h.width,h.height,r),this.updateUsedFrame(),e}frameChanged(){return this._lastUsedFrame!==this.currentFrameNumber}updateUsedFrame(){this._lastUsedFrame=this.currentFrameNumber}async _load(t,s){try{const s=function(t,s){const i=new Uint8Array(s);if(Cs.some(((t,s)=>t!==i[s])))return Rs;let e=!1;if(Is(i,(t=>!(e="acTL"===t))),!e)return Us;const h=[],r=[];let n=null,o=null,a=0;if(Is(i,((s,i,e,c)=>{const l=new DataView(i.buffer);switch(s){case"IHDR":n=i.subarray(e+8,e+8+c),t.width=l.getUint32(e+8),t.height=l.getUint32(e+12);break;case"acTL":t.numPlays=l.getUint32(e+8+4);break;case"fcTL":{o&&(t.frames.push(o),a++),o=new Es,o.width=l.getUint32(e+8+4),o.height=l.getUint32(e+8+8),o.left=l.getUint32(e+8+12),o.top=l.getUint32(e+8+16);const s=l.getUint16(e+8+20);let i=l.getUint16(e+8+22);0===i&&(i=100),o.delay=1e3*s/i,o.delay<=10&&(o.delay=100),t.playTime+=o.delay,o.disposeOp=l.getUint8(e+8+24),o.blendOp=l.getUint8(e+8+25),o.dataParts=[],0===a&&2===o.disposeOp&&(o.disposeOp=1);break}case"fdAT":o&&o.dataParts.push(i.subarray(e+8+4,e+8+c));break;case"IDAT":o&&o.dataParts.push(i.subarray(e+8,e+8+c));break;case"IEND":r.push(Os(i,e,12+c));break;default:h.push(Os(i,e,12+c))}})),0===t.frames.length)return Us;t.frameCount=t.frames.length;const c=new Blob(h),l=new Blob(r);return t.frames.forEach((t=>{let s=[];s.push(Cs),n.set(Gs(t.width),0),n.set(Gs(t.height),4),s.push(Ls("IHDR",n)),s.push(c),t.dataParts.forEach((t=>s.push(Ls("IDAT",t)))),s.push(l),t.data=new Blob(s,{type:"image/png"}),delete t.dataParts,s=null})),t}(this,t);if(s!==this)return s;this._resizeCanvas=document.createElement("canvas"),this._resizeCanvas.width=this.width,this._resizeCanvas.height=this.height,await Promise.all(this.frames.map((t=>t.createImage(this._resizeCanvas))))}catch(t){if(!c(t))return new a("invalid-resource","Could not parse PNG")}this.play()}_play(){let t,s;if(0===this.playSpeed)return void this.pause();this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),s=this.currentFrameNumber,s-=1,s<0&&(s=this.frames.length-1),t=1*-this.frames[s].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,t=1*this.frames[this.currentFrameNumber].delay/this.playSpeed);const i=this.frames[this.currentFrameNumber];this.currentFrame={frameData:i.imageData,top:i.top,left:i.left,width:i.width,height:i.height},this.timerID=window.setTimeout((()=>this._play()),t)}}class Es{constructor(){this.left=0,this.top=0,this.width=0,this.height=0,this.delay=0,this.disposeOp=0,this.blendOp=0,this.data=null,this.imageData=null}async createImage(t){if(null===this.imageData)return new Promise(((s,i)=>{const e=URL.createObjectURL(this.data),h=document.createElement("img");h.onload=()=>{URL.revokeObjectURL(e),this.imageData=function(t,s){s.width=t.width,s.height=t.height;const i=s.getContext("2d");i.drawImage(t,0,0,t.width,t.height);const e=i.getImageData(0,0,t.width,t.height),h=new Uint8Array(e.data);let r;for(let t=0;t<h.length;t+=4)r=h[t+3]/255,h[t]=h[t]*r,h[t+1]=h[t+1]*r,h[t+2]=h[t+2]*r;return new ImageData(new Uint8ClampedArray(h.buffer),t.width,t.height)}(h,t),s()},h.onerror=()=>{URL.revokeObjectURL(e),this.imageData=null,i(new Error("Image creation error"))},h.src=e}))}}function Is(t,s){const i=new DataView(t.buffer);let e,h,r,n=8;do{h=i.getUint32(n),e=Ds(t,n+4,4),r=s(e,t,n,h),n+=12+h}while(!1!==r&&"IEND"!==e&&n<t.length)}function Ds(t,s,i){const e=Array.prototype.slice.call(t.subarray(s,s+i));return String.fromCharCode.apply(String,e)}function Os(t,s,i){const e=new Uint8Array(i);return e.set(t.subarray(s,s+i)),e}function Ls(t,s){const i=t.length+s.length,e=new Uint8Array(i+8),h=new DataView(e.buffer);h.setUint32(0,s.length),e.set(function(t){const s=new Uint8Array(t.length);for(let i=0;i<t.length;i++)s[i]=t.charCodeAt(i);return s}(t),4),e.set(s,8);const r=function(t,s=0,i=t.length-s){let e=-1;for(let h=s,r=s+i;h<r;h++)e=e>>>8^zs[255&(e^t[h])];return-1^e}(e,4,i);return h.setUint32(i+4,r),e}function Gs(t){return new Uint8Array([t>>>24&255,t>>>16&255,t>>>8&255,255&t])}function Ns(t){if(!t||0===t.byteLength)return!1;const s=t.constructor===Uint8Array?t:new Uint8Array(t);return 71===s[0]&&73===s[1]&&70===s[2]&&56===s[3]}class Vs{constructor(){this.paused=!1,this.playing=!1,this.waitTillDone=!0,this.loading=!1,this.firstFrameOnly=!1,this.frames=[],this.comment="",this.length=0,this.currentFrameNumber=0,this.frameCount=0,this.playSpeed=1,this.lastFrame=null,this.playOnLoad=!0,this.complete=!1,this.interlaceOffsets=[0,4,2,1],this.interlaceSteps=[8,8,4,2],this._lastUsedFrame=-1}static async create(t,s){const i=new Vs;try{await i._load(t,s)}catch(t){if(!c(t))return new a("invalid-resource",`Could not load PNG: ${t.message}`)}return i}play(){this.playing||(this.paused=!1,this.playing=!0,this._play())}pause(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)}togglePlay(){this.paused||!this.playing?this.play():this.pause()}bindFrame(t,s,i){t.bindTexture(s,i);const e=this.frameChanged();if(e){const t=this.currentFrame;s.updateData(0,0,0,t.width,t.height,t.frameData),this.updateUsedFrame()}return e}seekFrame(t){clearTimeout(this.timerID),this.currentFrameNumber=t%this.frames.length,this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)}seek(t){clearTimeout(this.timerID),t<0&&(t=0),t*=1e3,t%=this.length;let s=0;for(;t>this.frames[s].time+this.frames[s].delay&&s<this.frames.length;)s+=1;this.currentFrameNumber=s,this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)}frameChanged(){return this._lastUsedFrame!==this.currentFrameNumber}updateUsedFrame(){this._lastUsedFrame=this.currentFrameNumber}async _load(t,s){try{this.loading=!0,await this._parse(t,s),this.loading=!1,this.play()}catch(t){if(!c(t))return new a("invalid-resource","Could not parse gif!")}}_parse(t,s){const i=new qs(t);i.pos+=6,this.width=i.data[i.pos++]+(i.data[i.pos++]<<8),this.height=i.data[i.pos++]+(i.data[i.pos++]<<8);const e=i.data[i.pos++];return this.globalColourCount=1<<1+(7&e),i.pos++,i.pos++,128&e&&(this.globalColourTable=this._parseColourTable(this.globalColourCount,i)),new Promise(((t,e)=>{setTimeout((()=>this._parseBlock(i,t,e,s)),0)}))}async _parseBlock(t,s,i,e){if(e&&e.signal&&l(e.signal))return void i(o());const h=t.data[t.pos++];if(44===h){if(this._parseImg(t),this.firstFrameOnly)return this._finishedLoading(),void s()}else{if(59===h)return this._finishedLoading(),void s();this._parseExt(t)}"function"==typeof this.onprogress&&this.onprogress({bytesRead:t.pos,totalBytes:t.data.length,frame:this.frames.length}),setTimeout((()=>this._parseBlock(t,s,i,e)),0)}_parseColourTable(t,s){const i=[];for(let e=0;e<t;e++)i.push([s.data[s.pos++],s.data[s.pos++],s.data[s.pos++]]);return i}_parseImg(t){const s={};this.frames.push(s),s.disposalMethod=this.disposalMethod,s.time=this.length,s.delay=10*this.delayTime,this.length+=s.delay,s.transparencyIndex=this.transparencyGiven?this.transparencyIndex:void 0,s.leftPos=t.data[t.pos++]+(t.data[t.pos++]<<8),s.topPos=t.data[t.pos++]+(t.data[t.pos++]<<8),s.width=t.data[t.pos++]+(t.data[t.pos++]<<8),s.height=t.data[t.pos++]+(t.data[t.pos++]<<8);const i=t.data[t.pos++];s.localColourTableFlag=!!(128&i),s.localColourTableFlag&&(s.localColourTable=this._parseColourTable(1<<1+(7&i),t)),this.pixelBufSize!==s.width*s.height&&(this.pixelBuf=new Uint8Array(s.width*s.height),this.pixelBufSize=s.width*s.height),this._lzwDecode(t.data[t.pos++],t.readSubBlocksB()),64&i?(s.interlaced=!0,(t=>{const s=this.pixelBufSize/t;this.interlacedBufSize!==this.pixelBufSize&&(this.deinterlaceBuf=new Uint8Array(this.pixelBufSize),this.interlacedBufSize=this.pixelBufSize);let i=0;for(let e=0;e<4;e++)for(let h=this.interlaceOffsets[e];h<s;h+=this.interlaceSteps[e])this.deinterlaceBuf.set(this.pixelBuf.subarray(i,i+t),h*t),i+=t})(s.width)):s.interlaced=!1,this._processFrame(s)}_lzwDecode(t,s){let i,e,h,r,n,o,a,c,l;h=e=0;let u=[];const d=1<<t,p=d+1;for(r=t+1,l=!1;!l;){for(o=n,n=0,i=0;i<r;i++)s[h>>3]&1<<(7&h)&&(n|=1<<i),h++;if(n===d){for(u=[],r=t+1,i=0;i<d;i++)u[i]=[i];u[d]=[],u[p]=null}else{if(n===p)return void(l=!0);for(n>=u.length?u.push(u[o].concat(u[o][0])):o!==d&&u.push(u[o].concat(u[n][0])),a=u[n],c=a.length,i=0;i<c;i++)this.pixelBuf[e++]=a[i];u.length===1<<r&&r<12&&r++}}}_processFrame(t){t.image=document.createElement("canvas"),t.image.width=this.width,t.image.height=this.height,t.ctx=t.image.getContext("2d");const s=t.localColourTableFlag?t.localColourTable:this.globalColourTable;null===this.lastFrame&&(this.lastFrame=t);const i=2===this.lastFrame.disposalMethod||3===this.lastFrame.disposalMethod;i||t.ctx.drawImage(this.lastFrame.image,0,0,this.width,this.height);const e=t.ctx.getImageData(t.leftPos,t.topPos,t.width,t.height),h=t.transparencyIndex,r=e.data,n=t.interlaced?this.deinterlaceBuf:this.pixelBuf,o=n.length;let a,c,l=0;for(let t=0;t<o;t++)a=n[t],c=s[a],h!==a?(r[l++]=c[0],r[l++]=c[1],r[l++]=c[2],r[l++]=255):i?(r[l+3]=0,l+=4):l+=4;t.ctx.putImageData(e,t.leftPos,t.topPos),this.lastFrame=t}_parseExt(t){const s=t.data[t.pos++];249===s?this._parseGCExt(t):254===s?this.comment+=t.readSubBlocks():255===s?this._parseAppExt(t):(1===s&&(t.pos+=13),t.readSubBlocks())}_parseAppExt(t){t.pos+=1,"NETSCAPE"===t.getString(8)?t.pos+=8:(t.pos+=3,t.readSubBlocks())}_parseGCExt(t){t.pos++;const s=t.data[t.pos++];this.disposalMethod=(28&s)>>2,this.transparencyGiven=!!(1&s),this.delayTime=t.data[t.pos++]+(t.data[t.pos++]<<8),this.transparencyIndex=t.data[t.pos++],t.pos++}_finishedLoading(){this.loading=!1,this.frameCount=this.frames.length,this.lastFrame=null,this.complete=!0,this.disposalMethod=void 0,this.transparencyGiven=void 0,this.delayTime=void 0,this.transparencyIndex=void 0,this.waitTillDone=void 0,this.pixelBuf=void 0,this.deinterlaceBuf=void 0,this.pixelBufSize=void 0,this.deinterlaceBuf=void 0,this.currentFrameNumber=0,this.frames.length>0&&this._setCurrentFrame(0),this.playOnLoad&&this.play()}_play(){let t,s;0!==this.playSpeed?(this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),s=this.currentFrameNumber,s-=1,s<0&&(s=this.frames.length-1),t=1*-this.frames[s].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,t=1*this.frames[this.currentFrameNumber].delay/this.playSpeed),this._setCurrentFrame(this.currentFrameNumber),this.timerID=window.setTimeout((()=>this._play()),t)):this.pause()}_setCurrentFrame(t){this.currentFrame={frameData:this.frames[t].image,top:0,left:0,width:this.width,height:this.height}}}class qs{constructor(t){this.pos=0,this.data=new Uint8ClampedArray(t),this.len=this.data.length}getString(t){let s="";for(;t--;)s+=String.fromCharCode(this.data[this.pos++]);return s}readSubBlocks(){let t,s,i="";do{for(s=t=this.data[this.pos++];s--;)i+=String.fromCharCode(this.data[this.pos++])}while(0!==t&&this.pos<this.len);return i}readSubBlocksB(){let t,s;const i=[];do{for(s=t=this.data[this.pos++];s--;)i.push(this.data[this.pos++])}while(0!==t&&this.pos<this.len);return i}}const Hs=$t(),Ws="arial-unicode-ms-regular",Zs=u.getLogger("esri.views.2d.engine.webgl.TextureManager");function Js(t,s){const i=Math.round(Rt(s)*window.devicePixelRatio);return Math.min(t,i*(i>=128?2:4))}const Ks=(t,s,i)=>Zs.error(new a(t,s,i));class Qs{constructor(t,s,i){this.mosaicType=t,this.page=s,this.sdf=i}static fromMosaic(t,s){return new Qs(t,s.page,s.sdf)}}class Ys{constructor(t,s){this.resourceManager=s,this._invalidFontsMap=new Map,this._sdfConverter=new As(126),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new Xt({concurrency:10,process:async(t,s)=>{d(s);try{return await h(t,{responseType:"image",signal:s})}catch(s){if(!c(s))throw new a("mapview-invalid-resource",`Could not fetch requested resource at ${t}`,s);throw s}}}),this._spriteMosaic=new Fs(t,2048,2048,500),this._glyphSource=new Ss(`${p.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new Ms(1024,1024,this._glyphSource),this._rasterizer=new Bt(s)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}async rasterizeItem(t,s,i,e){if(f(t))return Ks("mapview-null-resource","Unable to rasterize null resource"),null;switch(t.type){case"text":case"esriTS":{const s=await this._rasterizeText(t,i,e);return s.forEach((t=>this._setTextureBinding(mt.GLYPH,t))),{glyphMosaicItems:s}}default:{if(ft(t))return Ks("mapview-invalid-type",`MapView does not support symbol type: ${t.type}`,t),null;const i=await this._rasterizeSpriteSymbol(t,s,e);return Yt(i)&&i&&this._setTextureBinding(mt.SPRITE,i),{spriteMosaicItem:i}}}}bindTextures(t,s,i,e=!1){if(0===i.textureBinding)return;const h=this._bindingInfos[i.textureBinding-1],r=h.page,n=e?9987:9729;switch(h.mosaicType){case mt.SPRITE:{const i=this.sprites.getWidth(r),e=this.sprites.getHeight(r),h=V(Hs,i,e);return this._spriteMosaic.bind(t,n,r,Dt),s.setUniform1i("u_texture",Dt),void s.setUniform2fv("u_mosaicSize",h)}case mt.GLYPH:{const i=V(Hs,this.glyphs.width,this.glyphs.height);return this._glyphMosaic.bind(t,n,r,It),s.setUniform1i("u_texture",It),void s.setUniform2fv("u_mosaicSize",i)}default:Zs.error("mapview-texture-manager",`Cannot handle unknown type ${h.mosaicType}`)}}_hashMosaic(t,s){return 1|t<<1|(s.sdf?1:0)<<2|s.page<<3}_setTextureBinding(t,s){const i=this._hashMosaic(t,s);if(!this._hashToBindingIndex.has(i)){const e=Qs.fromMosaic(t,s);this._hashToBindingIndex.set(i,this._bindingInfos.length+1),this._bindingInfos.push(e)}s.textureBinding=this._hashToBindingIndex.get(i)}async _rasterizeText(t,s,i){let e,h;if("cim"in t)e=t.fontName,h=t.text;else{const s=t;e=function(t){const s=function(t){if(!t.weight)return"";switch(t.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}(t)+function(t){if(!t.style)return"";switch(t.style.toLowerCase()){case"italic":case"oblic":return"-italic"}return""}(t);return function(t){const s=t.toLowerCase().split(" ").join("-");switch(s){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return s}}(t.family)+(s.length>0?s:"-regular")}(s.font),h=s.text}const r=this._invalidFontsMap.has(e),n=s||wt(J(h)[0]);try{return await this._glyphMosaic.getGlyphItems(r?Ws:e,n,i)}catch(t){return Ks("mapview-invalid-resource",`Couldn't find font ${e}. Falling back to Arial Unicode MS Regular`),this._invalidFontsMap.set(e,!0),this._glyphMosaic.getGlyphItems(Ws,n,i)}}async _rasterizeSpriteSymbol(t,s,i){if(gt(t))return null;const e=function(t){switch(t.type){case"esriSMS":return`${t.style}.${t.path}`;case"esriSLS":return`${t.style}.${t.cap}`;case"esriSFS":return`${t.style}`;case"esriPFS":case"esriPMS":return t.imageData?`${t.imageData}${t.width}${t.height}`:`${t.url}${t.width}${t.height}`;default:return"mosaicHash"in t?t.mosaicHash:JSON.stringify(t)}}(t);if(this._spriteMosaic.has(e))return this._spriteMosaic.getSpriteItem(e);if(bt(t)||yt(t))return this._handleAsyncResource(e,t,i);const h=this._rasterizer.rasterizeJSONResource(t,1);if(h){const{size:s,image:i,sdf:r,simplePattern:n}=h;return this._addItemToMosaic(e,s,{type:"static",data:i},vt(t),r,n)}return new a("TextureManager","unrecognized or null rasterized image")}async _handleAsyncResource(t,s,i){if(this._ongoingRasterizations.has(t))return this._ongoingRasterizations.get(t);let e;e=bt(s)?this._handleSVG(s,t,i):this._handleImage(s,t,i),this._ongoingRasterizations.set(t,e);try{await e,this._ongoingRasterizations.delete(t)}catch{this._ongoingRasterizations.delete(t)}return e}async _handleSVG(t,s,i){const e=await this._sdfConverter.draw(t.path,i);return this._addItemToMosaic(s,[126,126],{type:"static",data:new Uint32Array(e.buffer)},!1,!0,!0)}async _handleGIFOrPNG(t,s,i){const e=await async function(t,s){const i=xt(t);let e;const r=";base64,";if(i.includes(r)){const t=i.indexOf(r)+r.length,s=i.substring(t),h=atob(s),n=new Uint8Array(h.length);for(let t=0;t<h.length;t++)n[t]=h.charCodeAt(t);e=n.buffer}else try{const{data:t}=await h(i,{responseType:"array-buffer",...s});e=t}catch(t){if(!c(t))return new a("mapview-invalid-resource",`Could not fetch requested resource at ${i}`)}return e}(t,i);if(Yt(e)){const h=Ns(e),r=$s(e);if(!h&&!r)return new a("mapview-invalid-resource","Image data is neither GIF nor PNG!");let n;try{h&&function(t){if(!t||0===t.byteLength)return!1;const s=new Uint8Array(t);if(!Ns(s))return!1;let i=0;for(let t=0,e=s.length-9;t<e&&(0!==s[t]||33!==s[t+1]||249!==s[t+2]||4!==s[t+3]||0!==s[t+8]||44!==s[t+9]&&33!==s[t+9]||(i++,!(i>1)));++t);return i>1}(e)?n=await Vs.create(e,i):r&&function(t){const s=new Uint8Array(t);if(!$s(s))return!1;let i=!1;return Is(s,(t=>!(i="acTL"===t))),i}(e)&&(n=await Bs.create(e,i))}catch(t){if(!c(t))return new a("mapview-invalid-resource","Could not fetch requested resource!")}if(n&&Yt(n))return this._addItemToMosaic(s,[n.width,n.height],{type:"animated",data:n},vt(t),!1,!1);const o=new Blob([e],{type:h?"image/gif":"image/png"}),l=await this._imageFromBlob(o);if(l&&l instanceof HTMLImageElement){let i=l.width,e=l.height;"esriPMS"===t.type&&(i=Math.round(Js(l.width,Tt(t))),e=Math.round(l.height*(i/l.width)));const h="cim"in t?t.cim.colorSubstitutions:void 0,{size:r,sdf:n,image:o}=this._rasterizer.rasterizeImageResource(i,e,l,h);return this._addItemToMosaic(s,r,{type:"static",data:o},vt(t),n,!1)}}return new a("mapview-invalid-resource","Could not handle resource!")}async _handleImage(s,i,e){if(jt(s)||_t(s))return this._handleGIFOrPNG(s,i,e);const h=xt(s);try{let r;const n=this.resourceManager.getResource(h);if(t(n))r=n;else{const{data:t}=await this._imageRequestQueue.push(h,{...e});r=t}if(Mt(h)){const t="height"in s?s.height:s.cim.size;r.width=Rt("width"in s?s.width:s.cim.size),r.height=Rt(t)}let o=r.width,a=r.height;"esriPMS"===s.type&&(o=Math.round(Js(r.width,Tt(s))),a=Math.round(r.height*(o/r.width)));const c="cim"in s?s.cim.colorSubstitutions:void 0,{size:l,sdf:u,image:d}=this._rasterizer.rasterizeImageResource(o,a,r,c);return this._addItemToMosaic(i,l,{type:"static",data:d},vt(s),u,!1)}catch(t){if(!c(t))return new a("mapview-invalid-resource",`Could not fetch requested resource at ${h}. ${t.message}`)}}async _imageFromBlob(t){const s=window.URL.createObjectURL(t);try{const{data:t}=await this._imageRequestQueue.push(s);return window.URL.revokeObjectURL(s),t}catch(t){if(window.URL.revokeObjectURL(s),!c(t))return new a("mapview-invalid-resource",`Could not fetch requested resource at ${s}`);throw t}}_addItemToMosaic(t,s,i,e,h,r){return this._spriteMosaic.addSpriteItem(t,s,i,e,h,r)}}class Xs{constructor(){this.name=this.constructor.name}}class ti extends Xs{constructor(){super(...arguments),this.defines=[],this._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:new Map([["a_position",0]])}}dispose(){this._quad&&this._quad.dispose()}bind(){}unbind(){}draw(t,s){if(!s.size)return;const{context:i,renderingOptions:e}=t;this._quad||(this._quad=new At(i,[0,0,1,0,0,1,1,1]));const h=i.getBoundFramebufferObject(),{x:r,y:n,width:o,height:a}=i.getViewport();s.bindTextures(i);const c=s.getBlock(Ot);if(f(c))return;const l=c.getFBO(i),u=c.getFBO(i,1);i.setViewport(0,0,s.size,s.size),this._computeDelta(t,u,e.labelsAnimationTime),this._updateAnimationState(t,u,l),i.bindFramebuffer(h),i.setViewport(r,n,o,a)}_computeDelta(t,s,i){const{context:e,painter:h,displayLevel:r}=t,n=h.materialManager.getProgram(t,this._desc,["delta"]);e.bindFramebuffer(s),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),e.useProgram(n),n.setUniform1i("u_maskTexture",Lt),n.setUniform1i("u_sourceTexture",Gt),n.setUniform1f("u_timeDelta",t.deltaTime),n.setUniform1f("u_animationTime",i),n.setUniform1f("u_zoomLevel",Math.round(10*r)),this._quad.draw()}_updateAnimationState(t,s,i){const{context:e,painter:h}=t,r=h.materialManager.getProgram(t,this._desc,["update"]);e.bindTexture(s.colorTexture,1),e.useProgram(r),r.setUniform1i("u_sourceTexture",1),e.bindFramebuffer(i),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._quad.draw()}}const si=t=>`#define ${(t=>t.replace("-","_").toUpperCase())(t)}\n`,ii={attributes:new Map([["a_pos",0],["a_tex",1]]),shaders:t=>({vertexShader:si(t)+Pt("blend/blend.vert"),fragmentShader:si(t)+Pt("blend/blend.frag")})},ei=u.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");class hi{constructor(){this._size=[0,0]}dispose(t){this._backBufferTexture&&(this._backBufferTexture.dispose(),this._backBufferTexture=null),this._programCache&&(this._programCache.dispose(),this._programCache=null),this._quad&&(this._quad.dispose(),this._quad=null)}draw(t,s,i,e,h){const{context:r,drawPhase:n}=t;if(this._setupShader(r),e&&"normal"!==e&&n!==pt.LABEL)return void this._drawBlended(t,s,i,e,h);const o=this._programCache.getProgram(ii,"normal");if(!o)return void ei.error(new a("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));r.useProgram(o),s.setSamplingMode(i),r.bindTexture(s,0),o.setUniform1i("u_layerTexture",0),o.setUniform1f("u_opacity",h),r.setBlendingEnabled(!0),r.setBlendFunction(1,771);const c=this._quad;c.draw(),c.unbind()}_drawBlended(s,i,e,h,r){const{context:n,state:o,pixelRatio:c,inFadeTransition:l}=s,{size:u}=o,d=n.getBoundFramebufferObject();let p,f;if(t(d)){const t=d.descriptor;p=t.width,f=t.height}else p=Math.round(c*u[0]),f=Math.round(c*u[1]);this._createOrResizeTexture(s,p,f);const m=this._backBufferTexture;d.copyToTexture(0,0,p,f,0,0,m),n.setStencilTestEnabled(!1),n.setStencilWriteMask(0),n.setBlendingEnabled(!0),n.setDepthTestEnabled(!1),n.setDepthWriteEnabled(!1);const w=this._programCache.getProgram(ii,h);if(!w)return void ei.error(new a("mapview-BlendEffect",`Error creating shader program for blend mode ${h}`));n.useProgram(w),m.setSamplingMode(e),n.bindTexture(m,0),w.setUniform1i("u_backbufferTexture",0),i.setSamplingMode(e),n.bindTexture(i,1),w.setUniform1i("u_layerTexture",1),w.setUniform1f("u_opacity",r),w.setUniform1f("u_inFadeOpacity",l?1:0),n.setBlendFunction(1,0);const g=this._quad;g.draw(),g.unbind(),n.setBlendFunction(1,771)}_setupShader(t){this._programCache||(this._programCache=new zt(t),this._quad||(this._quad=new At(t,[-1,-1,1,-1,-1,1,1,1])))}_createOrResizeTexture(t,s,i){const{context:e}=t;null!==this._backBufferTexture&&s===this._size[0]&&i===this._size[1]||(this._backBufferTexture?this._backBufferTexture.resize(s,i):this._backBufferTexture=new st(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:s,height:i}),this._size[0]=s,this._size[1]=i)}}class ri extends Xs{constructor(t){super(),this.name=this.constructor.name,this.defines=[t]}dispose(){}bind({context:t,painter:s}){this._prev=t.getBoundFramebufferObject();const{width:i,height:e}=t.getViewport(),h=s.getFbos(i,e).effect0;t.bindFramebuffer(h),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}unbind(){}draw(t,s){const{context:i,painter:e,state:h,deltaTime:r}=t,n=e.getPostProcessingEffects(s.effects),o=i.getBoundFramebufferObject();n.length&&s.transitionStep(r,h.scale);for(const{postProcessingEffect:s,effect:i}of n)s.draw(t,o,i);i.bindFramebuffer(this._prev),i.setStencilTestEnabled(!1),e.blitTexture(i,o.colorTexture,9728),i.setStencilTestEnabled(!0)}}const ni=[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],oi=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],ai=u.getLogger("esri.views.2d.engine.webgl.painter.highlight.HighlightGradient"),ci=[0,0,0,0];class li{constructor(){this._convertedHighlightOptions={fillColor:[.2*.75,.6*.75,.675,.75],outlineColor:[.2*.9,.54,.81,.9],outlinePosition:0,outlineWidth:.7,innerHaloWidth:.7,outerHaloWidth:.7},this.shadeTexChanged=!0,this.texelData=new Uint8Array(1024),this.minMaxDistance=[0,0]}setHighlightOptions(t){const s=this._convertedHighlightOptions;!function(t,s){s.fillColor[0]=t.color.r/255,s.fillColor[1]=t.color.g/255,s.fillColor[2]=t.color.b/255,s.fillColor[3]=t.color.a,t.haloColor?(s.outlineColor[0]=t.haloColor.r/255,s.outlineColor[1]=t.haloColor.g/255,s.outlineColor[2]=t.haloColor.b/255,s.outlineColor[3]=t.haloColor.a):(s.outlineColor[0]=s.fillColor[0],s.outlineColor[1]=s.fillColor[1],s.outlineColor[2]=s.fillColor[2],s.outlineColor[3]=s.fillColor[3]),s.fillColor[3]*=t.fillOpacity,s.outlineColor[3]*=t.haloOpacity,s.fillColor[0]*=s.fillColor[3],s.fillColor[1]*=s.fillColor[3],s.fillColor[2]*=s.fillColor[3],s.outlineColor[0]*=s.outlineColor[3],s.outlineColor[1]*=s.outlineColor[3],s.outlineColor[2]*=s.outlineColor[3],s.outlineWidth=.7,s.outerHaloWidth=.7,s.innerHaloWidth=.7,s.outlinePosition=0}(t,s);const i=s.outlinePosition-s.outlineWidth/2-s.outerHaloWidth,e=s.outlinePosition-s.outlineWidth/2,h=s.outlinePosition+s.outlineWidth/2,r=s.outlinePosition+s.outlineWidth/2+s.innerHaloWidth,n=1*Math.sqrt(Math.PI/2),o=Math.abs(i)>n?Math.round(10*(Math.abs(i)-n))/10:0,a=Math.abs(r)>n?Math.round(10*(Math.abs(r)-n))/10:0;let c;o&&!a?ai.error("The outer rim of the highlight is "+o+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards positive values (inwards)."):!o&&a?ai.error("The inner rim of the highlight is "+a+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards negative values (outwards)."):o&&a&&ai.error("The highlight is "+Math.max(o,a)+"px away from the edge of the feature; consider reducing some width values.");const l=[void 0,void 0,void 0,void 0];function u(t,s,i){l[0]=(1-i)*t[0]+i*s[0],l[1]=(1-i)*t[1]+i*s[1],l[2]=(1-i)*t[2]+i*s[2],l[3]=(1-i)*t[3]+i*s[3]}const{texelData:d}=this;for(let t=0;t<256;++t)c=i+t/255*(r-i),c<i?(l[4*t+0]=0,l[4*t+1]=0,l[4*t+2]=0,l[4*t+3]=0):c<e?u(ci,s.outlineColor,(c-i)/(e-i)):c<h?[l[0],l[1],l[2],l[3]]=s.outlineColor:c<r?u(s.outlineColor,s.fillColor,(c-h)/(r-h)):[l[4*t+0],l[4*t+1],l[4*t+2],l[4*t+3]]=s.fillColor,d[4*t+0]=255*l[0],d[4*t+1]=255*l[1],d[4*t+2]=255*l[2],d[4*t+3]=255*l[3];this.minMaxDistance[0]=i,this.minMaxDistance[1]=r,this.shadeTexChanged=!0}applyHighlightOptions(t,s){this.shadeTex||(this.shadeTex=new st(t,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,width:256,height:1,samplingMode:9729})),this.shadeTexChanged&&(this.shadeTex.updateData(0,0,0,256,1,this.texelData),this.shadeTexChanged=!1),t.bindTexture(this.shadeTex,Nt),s.setUniform2fv("u_minMaxDistance",this.minMaxDistance)}destroy(){this.shadeTex&&(this.shadeTex.dispose(),this.shadeTex=null)}}const ui={shaders:{vertexShader:Pt("highlight/textured.vert"),fragmentShader:Pt("highlight/highlight.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},di={shaders:{vertexShader:Pt("highlight/textured.vert"),fragmentShader:Pt("highlight/blur.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])};class pi{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}preBlur(t,s){t.bindTexture(s,Vt),t.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",ni),t.bindVAO(this._resources.quadVAO),t.drawArrays(5,0,4),t.bindVAO()}finalBlur(t,s){t.bindTexture(s,Vt),t.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",oi),t.bindVAO(this._resources.quadVAO),t.drawArrays(5,0,4),t.bindVAO()}renderHighlight(t,s,i){t.bindTexture(s,Vt),t.useProgram(this._resources.highlightProgram),i.applyHighlightOptions(t,this._resources.highlightProgram),t.bindVAO(this._resources.quadVAO),t.setBlendingEnabled(!0),t.setBlendFunction(1,771),t.drawArrays(5,0,4),t.bindVAO()}_initialize(t,s,i){this._width=s,this._height=i;const e=Y.createVertex(t,35044,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),h=new Q(t,new Map([["a_position",0],["a_texcoord",1]]),{geometry:[{name:"a_position",count:2,type:5120,offset:0,stride:4,normalized:!1},{name:"a_texcoord",count:2,type:5121,offset:2,stride:4,normalized:!1}]},{geometry:e}),r=it(t,ui),n=it(t,di);r.setUniform1i("u_texture",Vt),r.setUniform1i("u_shade",Nt),r.setUniform1f("u_sigma",1),n.setUniform1i("u_texture",Vt),n.setUniform1f("u_sigma",1),this._resources={quadGeometry:e,quadVAO:h,highlightProgram:r,blurProgram:n}}setup(t,s,i){this._resources?(this._width=s,this._height=i):this._initialize(t,s,i)}}function fi(t,s,i){const e=new st(t,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,width:s,height:i,samplingMode:9729});return[e,new X(t,{colorTarget:0,depthStencilTarget:2},e)]}class mi{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.sharedBlur1Tex.dispose(),this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Tex.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=null)}_initialize(t,s,i){this._width=s,this._height=i;const[e,h]=fi(t,s,i),[r,n]=fi(t,s,i);this._resources={sharedBlur1Tex:e,sharedBlur1Fbo:h,sharedBlur2Tex:r,sharedBlur2Fbo:n}}setup(t,s,i){!this._resources||this._width===s&&this._height===i||this.dispose(),this._resources||this._initialize(t,s,i)}get sharedBlur1Tex(){return this._resources.sharedBlur1Tex}get sharedBlur1Fbo(){return this._resources.sharedBlur1Fbo}get sharedBlur2Tex(){return this._resources.sharedBlur2Tex}get sharedBlur2Fbo(){return this._resources.sharedBlur2Fbo}}class wi extends Xs{constructor(){super(...arguments),this.defines=["highlight"],this._hlRenderer=new pi,this._hlGradient=new li,this._width=void 0,this._height=void 0,this._hlSurfaces=new mi,this._adjustedWidth=void 0,this._adjustedHeight=void 0,this._blitRenderer=new ms}dispose(){this._hlSurfaces&&this._hlSurfaces.dispose(),this._hlRenderer&&this._hlRenderer.dispose(),this._hlGradient&&this._hlGradient.destroy(),this._boundFBO=null}bind(t){const{context:s,painter:i}=t,{width:e,height:h}=s.getViewport(),r=i.getFbos(e,h).effect0;this.setup(t,e,h),s.bindFramebuffer(r),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.clear(s.gl.COLOR_BUFFER_BIT)}unbind(){}setup({context:t},s,i){this._width=s,this._height=i;const e=s%4,h=i%4;i+=h<2?-h:4-h,this._adjustedWidth=s+=e<2?-e:4-e,this._adjustedHeight=i,this._boundFBO=t.getBoundFramebufferObject();const r=Math.round(1*s),n=Math.round(1*i);this._hlRenderer.setup(t,r,n),this._hlSurfaces.setup(t,r,n)}draw({context:t}){const s=t.getBoundFramebufferObject();t.setViewport(0,0,1*this._adjustedWidth,1*this._adjustedHeight),t.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),t.setStencilTestEnabled(!1),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(t,s.colorTexture,9728,1),t.setStencilTestEnabled(!1),t.setBlendingEnabled(!1),t.setColorMask(!1,!1,!1,!0),t.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(t,this._hlSurfaces.sharedBlur1Tex),t.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(t,this._hlSurfaces.sharedBlur2Tex),t.bindFramebuffer(this._boundFBO),t.setBlendingEnabled(!0),t.setColorMask(!0,!0,!0,!0),t.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(t,this._hlSurfaces.sharedBlur1Tex,this._hlGradient),this._boundFBO=null}setHighlightOptions(t){this._hlGradient.setHighlightOptions(t)}}class gi extends Xs{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["id"],this._lastSize=0}dispose(){t(this._fbo)&&this._fbo.dispose()}bind({context:t,painter:s}){const{width:i,height:e}=t.getViewport();this._boundFBO=t.getBoundFramebufferObject();const h=s.getFbos(i,e).effect0;t.bindFramebuffer(h),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}unbind({context:t}){t.bindFramebuffer(this._boundFBO),this._boundFBO=null}draw({context:t,state:s,pixelRatio:i},e,h=qt){const r=t.getBoundFramebufferObject(),n=s.size[1]*i,o=Math.round(h*i),a=o/2,c=o/2;this._ensureBuffer(o),e.forEach(((t,s)=>{const h=new Map,l=Math.floor(s[0]*i-o/2),u=Math.floor(n-s[1]*i-o/2);r.readPixels(l,u,o,o,6408,5121,this._buf);for(let t=0;t<this._buf32.length;t++){const s=this._buf32[t];if(4294967295!==s&&0!==s){const i=t%o,e=o-Math.floor(t/o),r=(a-i)*(a-i)+(c-e)*(c-e),n=h.has(s)?h.get(s):4294967295;h.set(s,Math.min(r,n))}}const d=Array.from(h).sort(((t,s)=>t[1]-s[1])).map((t=>t[0]));t.resolve(d),e.delete(s)}))}_ensureBuffer(t){this._lastSize!==t&&(this._lastSize=t,this._buf=new Uint8Array(4*t*t),this._buf32=new Uint32Array(this._buf.buffer))}}function bi(t){switch(t){case"bloom":case"blur":case"opacity":case"drop-shadow":return t;default:return"colorize"}}const yi={colorize:async()=>new((await import("./p-398aae0b.js")).Colorize),blur:async()=>new((await import("./p-cef85562.js")).Blur),bloom:async()=>new((await import("./p-a38d75b7.js")).Bloom),opacity:async()=>new((await import("./p-6f6ab665.js")).Opacity),"drop-shadow":async()=>new((await import("./p-0c235c8b.js")).DropShadow)};class vi{constructor(t){this._requestRender=t,this._effectMap=new Map,this._effectPromiseMap=new Map}dispose(){this._requestRender&&(this._requestRender=null),this._effectMap.forEach((t=>t.dispose())),this._effectMap.clear(),this._effectPromiseMap.clear()}getPostProcessingEffects(t){if(!t||0===t.length)return[];const s=[];for(const i of t){const t=bi(i.type),e=this._effectMap.get(t);e?s.push({postProcessingEffect:e,effect:i}):this._enablePostProcessingEffect(t)}return s}async _enablePostProcessingEffect(t){const s=await this._loadPostProcessingEffect(t);this._requestRender&&(this._effectMap.set(t,s),this._requestRender.requestRender())}async _loadPostProcessingEffect(t){return this._effectPromiseMap.has(t)||this._effectPromiseMap.set(t,yi[t]()),this._effectPromiseMap.get(t)}}class ji{constructor(t,s){var i;this.brushes=t,this.name=s.name,this.drawPhase=s.drawPhase||pt.MAP,this._targetFn=s.target,this.effects=s.effects||[],this.enableDefaultDraw=null!=(i=s.enableDefaultDraw)?i:()=>!0}render(t){const{context:s,profiler:i}=t,e=this._targetFn(),h=this.drawPhase&t.drawPhase;if(i.recordPassStart(this.name),h){this.enableDefaultDraw()&&this._doRender(t,e),i.recordPassEnd();for(const h of this.effects){if(!h.enable())continue;const r=h.apply;i.recordPassStart(this.name+"."+r.name),i.recordBrushStart(r.name);const n=h.args&&h.args(),{x:o,y:a,width:c,height:l}=s.getViewport(),u=s.getBoundFramebufferObject();r.bind(t,n),this._doRender(t,e,r.defines),r.draw(t,n),r.unbind(t,n),s.bindFramebuffer(u),s.setViewport(o,a,c,l),i.recordBrushEnd(),i.recordPassEnd()}}}_doRender(t,s,i){if(!f(s))if(m(s)){for(const e of s)if(e.visible)for(const s of this.brushes)t.profiler.recordBrushStart(s.name),s.prepareState(t,e,i),s.draw(t,e,i),t.profiler.recordBrushEnd()}else for(const e of this.brushes)t.profiler.recordBrushStart(e.name),e.prepareState(t,s,i),e.draw(t,s,i),t.profiler.recordBrushEnd()}}const _i={[St.FILL]:kt.fill,[St.LINE]:kt.line,[St.MARKER]:kt.marker,[St.TEXT]:kt.text};class Mi{constructor(t,s,i){this.context=t,this._blitRenderer=new ms,this._brushCache=new Map,this._vtlMaterialManager=new Ft,this._blendEffect=new hi,this.effects={highlight:new wi,hittest:new gi,integrate:new ti,insideEffect:new ri("inside"),outsideEffect:new ri("outside")},this.materialManager=new vs(t),this.textureManager=new Ys(s,i),this._effectsManager=new vi(s)}get vectorTilesMaterialManager(){return this._vtlMaterialManager}getRenderTarget(){return this._renderTarget}setRenderTarget(t){this._renderTarget=t}getFbos(t,s){if(t!==this._lastWidth||s!==this._lastHeight){if(this._lastWidth=t,this._lastHeight=s,this._fbos){for(const i in this._fbos)this._fbos[i].resize(t,s);return this._fbos}const i={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:t,height:s},e={colorTarget:0,depthStencilTarget:3},h=new tt(this.context,{width:t,height:s,internalFormat:34041});this._stencilBuf=h,this._fbos={output:new X(this.context,e,i,h),blend:new X(this.context,e,i,h),effect0:new X(this.context,e,i,h)}}return this._fbos}getSharedStencilBuffer(){return this._stencilBuf}beforeRenderLayers(s,i=null){const{width:e,height:h}=s.getViewport();this._prevFBO=s.getBoundFramebufferObject();const r=this.getFbos(e,h);if(s.bindFramebuffer(r.output),s.setColorMask(!0,!0,!0,!0),s.setDepthWriteEnabled(!0),t(i)){const{r:t,g:e,b:h,a:r}=i.color;s.setClearColor(r*t/255,r*e/255,r*h/255,r)}else s.setClearColor(0,0,0,0);s.setClearDepth(1),s.clear(s.gl.COLOR_BUFFER_BIT|s.gl.DEPTH_BUFFER_BIT),s.setDepthWriteEnabled(!1)}beforeRenderLayer(t,s,i){const{context:e,blendMode:h,effects:r,requireFBO:n}=t;if(n||xi(h,r,i))e.bindFramebuffer(this._fbos.blend),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.setDepthWriteEnabled(!0),e.setClearDepth(1),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.setDepthWriteEnabled(!1);else{const t=this._getOutputFBO();e.bindFramebuffer(t)}e.setDepthWriteEnabled(!1),e.setDepthTestEnabled(!1),e.setStencilTestEnabled(!0),e.setClearStencil(s),e.setStencilWriteMask(255),e.clear(e.gl.STENCIL_BUFFER_BIT)}compositeLayer(s,i){const{context:e,blendMode:h,effects:r,requireFBO:n}=s;if(n||xi(h,r,i)){t(r)&&r.length>0&&s.drawPhase===pt.MAP&&this._applyEffects(s,r);const n=this._getOutputFBO();e.bindFramebuffer(n),e.setStencilTestEnabled(!1),e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(1,771,1,771),e.setColorMask(!0,!0,!0,!0);const o=t(h)?h:"normal";this._blendEffect.draw(s,this._fbos.blend.colorTexture,9728,o,i)}}renderLayers(t){if(t.bindFramebuffer(this._prevFBO),!this._fbos)return;const s=this._getOutputFBO();t.setStencilTestEnabled(!1),t.setStencilWriteMask(0),this.blitTexture(t,s.colorTexture,9728)}dispose(){if(this.materialManager.dispose(),this.textureManager.dispose(),this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null),this._brushCache&&(this._brushCache.forEach((t=>t.dispose())),this._brushCache.clear(),this._brushCache=null),this._fbos)for(const t in this._fbos)this._fbos[t]&&this._fbos[t].dispose();if(this.effects)for(const t in this.effects)this.effects[t]&&this.effects[t].dispose();this._vtlMaterialManager&&(this._vtlMaterialManager.dispose(),this._vtlMaterialManager=null),this._prevFBO=null}getGeometryBrush(t){const s=_i[t];let i=this._brushCache.get(s);return void 0===i&&(i=new s,this._brushCache.set(s,i)),this._brushCache.get(s)}renderObject(t,s,i,e){const h=kt[i];if(!h)return null;let r=this._brushCache.get(h);void 0===r&&(r=new h,this._brushCache.set(h,r)),r.prepareState(t,s,e),r.draw(t,s,e)}renderObjects(t,s,i,e){const h=kt[i];if(!h)return null;let r=this._brushCache.get(h);void 0===r&&(r=new h,this._brushCache.set(h,r)),r.drawMany(t,s,e)}registerRenderPass(t){const s=t.brushes.map((t=>(this._brushCache.has(t)||this._brushCache.set(t,new t),this._brushCache.get(t))));return new ji(s,t)}setHighlightOptions(t){this.effects.highlight.setHighlightOptions(t)}blitTexture(t,s,i,e=1){t.setBlendingEnabled(!0),t.setBlendFunctionSeparate(1,771,1,771),t.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(t,s,i,e)}getPostProcessingEffects(t){return this._effectsManager.getPostProcessingEffects(t)}_getOutputFBO(){return null!=this._renderTarget?this._renderTarget:this._fbos.output}_applyEffects(t,s){const{context:i}=t,e=this._effectsManager.getPostProcessingEffects(s);for(const{postProcessingEffect:s,effect:h}of e)i.bindFramebuffer(this._fbos.blend),s.draw(t,this._fbos.blend,h)}}function xi(s,i,e){return 1!==e||t(s)&&"normal"!==s||t(i)&&i.length>0}const Ti=e("esri-2d-profiler");class Si{constructor(t,s){if(this._events=new w,this._entries=new Map,this._timings=new ts(10),!Ti)return;this._ext=nt(t.gl,{}),this._debugOutput=s;const i=t.gl;if(this.enableCommandLogging)for(const t in i)if("function"==typeof i[t]){const s=i[t],e=-1!==t.indexOf("draw");i[t]=(...h)=>(this._events.emit("command",{container:this._currentContainer,pass:this._currentPass,brush:this._currentBrush,method:t,args:h,isDrawCommand:e}),this._currentSummary&&(this._currentSummary.commands++,e&&this._currentSummary.drawCommands++),s.apply(i,h))}}get enableCommandLogging(){return!("object"==typeof Ti&&Ti.disableCommands)}recordContainerStart(t){Ti&&(this._currentContainer=t)}recordContainerEnd(){Ti&&(this._currentContainer=null)}recordPassStart(t){Ti&&(this._currentPass=t,this._initSummary())}recordPassEnd(){Ti&&(this._currentPass=null,this._emitSummary())}recordBrushStart(t){Ti&&(this._currentBrush=t)}recordBrushEnd(){Ti&&(this._currentBrush=null)}recordStart(s){if(Ti&&t(this._ext)){if(this._entries.has(s)){const i=this._entries.get(s),e=this._ext.resultAvailable(i.query),h=this._ext.disjoint();if(e&&!h){const e=this._ext.getResult(i.query)/1e6;let h=0;if(t(this._timings.enqueue(e))){const t=this._timings.entries,s=t.length;let i=0;for(const s of t)i+=s;h=i/s}const r=e.toFixed(2),n=h?h.toFixed(2):"--";this.enableCommandLogging?(console.groupCollapsed(`Frame report for ${s}, ${r} ms (${n} last 10 avg)\n${i.commandsLen} Commands (${i.drawCommands} draw)`),console.log("RenderPass breakdown: "),console.table(i.summaries),console.log("Commands: ",i.commands),console.groupEnd()):console.log(`Frame report for ${s}, ${r} ms (${n} last 10 avg)`),this._debugOutput.innerHTML=`${r} (${n})`}for(const t of i.handles)t.remove();this._entries.delete(s)}const i={name:s,query:this._ext.createQuery(),commands:[],commandsLen:0,drawCommands:0,summaries:[],handles:[]};this.enableCommandLogging&&(i.handles.push(this._events.on("command",(t=>{i.commandsLen++,i.commands.push(t),t.isDrawCommand&&i.drawCommands++}))),i.handles.push(this._events.on("summary",(t=>{i.summaries.push(t)})))),this._ext.beginTimeElapsed(i.query),this._entries.set(s,i)}}recordEnd(s){Ti&&t(this._ext)&&this._entries.has(s)&&this._ext.endTimeElapsed()}_initSummary(){this.enableCommandLogging&&(this._currentSummary={container:this._currentContainer,pass:this._currentPass,drawCommands:0,commands:0})}_emitSummary(){this.enableCommandLogging&&this._events.emit("summary",this._currentSummary)}}const Pi={shaders:{vertexShader:Pt("stencil/stencil.vert"),fragmentShader:Pt("stencil/stencil.frag")},attributes:new Map([["a_pos",0]])};class Ai extends rt{constructor(s,i){super(),this._trash=new Set,this._clipData=new Float32Array(8),this._upperLeft=Z(),this._upperRight=Z(),this._lowerLeft=Z(),this._lowerRight=Z(),this._mat2=$(),this._clipRendererInitialized=!1,this._renderRemainingTime=0,this._lastFrameRenderTime=0,this.renderRequested=!1,this.stage=this,this._stationary=!0;const{canvas:h=document.createElement("canvas"),alpha:r=!0,stencil:n=!0,contextOptions:o={}}=i;this._canvas=h;const c=ht(h,1,{alpha:r,antialias:!1,depth:!0,stencil:n});this.context=new ot(t(c)?c:null,o),this.resourceManager=new K,this.painter=new Mi(this.context,this,this.resourceManager),e("esri-2d-profiler")&&(this._debugOutput=document.createElement("div"),this._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),s.appendChild(this._debugOutput)),this._renderParameters={drawPhase:0,state:at(this.state),pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:this.context,painter:this.painter,timeline:i.timeline||new ss,renderingOptions:i.renderingOptions,requireFBO:!1,profiler:new Si(this.context,this._debugOutput),dataUploadCounter:0},this._taskHandle=g({render:t=>this.renderFrame(t)}),this._taskHandle.pause(),this._lostWebGLContextHandle=b(h,"webglcontextlost",(()=>{this.emit("webgl-error",{error:new a("webgl-context-lost")})})),h.setAttribute("style","width: 100%; height:100%; display:block;"),s.appendChild(h)}destroy(){this.removeAllChildren(),this._emptyTrash(),this._taskHandle.remove(),this._taskHandle=null,this._boundFBO=null,this._clipFBO&&(this._clipFBO.dispose(),this._clipFBO=null),this._clipVAO&&(this._clipVAO.dispose(),this._clipVAO=null,this._clipVBO=null),this._clipStencilProgram&&(this._clipStencilProgram.dispose(),this._clipStencilProgram=null),this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput),this.highlightOptions=null,this.resourceManager.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}get background(){return this._background}set background(t){this._background=t,this.requestRender()}get highlightOptions(){return this._highlightOptions}set highlightOptions(t){this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null),this._highlightOptions=t,this._highlightOptions&&(this._highlightOptionsHandle=y(this._highlightOptions,"version",(()=>{this.painter.setHighlightOptions(t),this.requestRender()})))}get renderingOptions(){return this._renderingOptions}set renderingOptions(t){this._renderingOptions=t,this.requestRender()}get state(){return this._state}set state(t){this._state=t,this.requestRender()}get stationary(){return this._stationary}set stationary(t){this._stationary!==t&&(this._stationary=t,this.requestRender())}trashDisplayObject(t){this._trash.add(t),this.requestRender()}untrashDisplayObject(t){return this._trash.delete(t)}requestRender(){this._renderRemainingTime=2e3,this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())}renderFrame(t){this._renderRemainingTime-=this._lastFrameRenderTime?t.time-this._lastFrameRenderTime:0,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=t.time,this.renderRequested=!1,this._renderParameters.state=at(this._state),this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=t.time,this._renderParameters.deltaTime=t.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")}_createTransforms(){return{dvs:B()}}renderChildren(t){for(const s of this.children)s.beforeRender(t);this._renderChildren(this.children,t);for(const s of this.children)s.afterRender(t)}_renderChildren(t,s){const i=this.context;s.profiler.recordStart("drawLayers"),s.dataUploadCounter=0,this._beforeRenderChildren(s),s.drawPhase=pt.MAP,this.painter.beforeRenderLayers(i,this.background);for(const i of t)i.processRender(s);this.painter.renderLayers(i),s.drawPhase=pt.HIGHLIGHT,this.painter.beforeRenderLayers(i);for(const i of t)i.processRender(s);if(this.painter.renderLayers(i),this._isLabelDrawPhaseRequired(t)){s.drawPhase=pt.LABEL,this.painter.beforeRenderLayers(i);for(const i of t)i.processRender(s);this.painter.renderLayers(i)}if(e("esri-tiles-debug")){s.drawPhase=pt.DEBUG,this.painter.beforeRenderLayers(i);for(const i of t)i.processRender(s);this.painter.renderLayers(i)}s.profiler.recordEnd("drawLayers"),this._afterRenderChildren()}_beforeRenderChildren(t){const{context:s}=this,{state:i,pixelRatio:e}=t;s.enforceState(),s.setClearDepth(1),s.setClearColor(0,0,0,0),s.clear(s.gl.COLOR_BUFFER_BIT|s.gl.DEPTH_BUFFER_BIT);const{size:h,rotation:r}=i,n=Math.round(h[0]*e),o=Math.round(h[1]*e);if(this._boundFBO=s.getBoundFramebufferObject(),!i.spatialReference||!(i.spatialReference._isWrappable?i.spatialReference._isWrappable():i.spatialReference.isWrappable))return void(this._clipFrame=!1);const a=k(r),c=Math.abs(Math.cos(a)),l=Math.abs(Math.sin(a)),u=Math.round(n*c+o*l),d=Math.round(i.worldScreenWidth);if(u<=d)return void(this._clipFrame=!1);this._clipFBO&&this._clipFBO.width===n&&this._clipFBO.height===o||(this._clipFBO=new X(s,{colorTarget:0,depthStencilTarget:3,width:n,height:o}));const p=(this.state.padding.left-this.state.padding.right)/2,f=(this.state.padding.bottom-this.state.padding.top)/2,m=.5*n,w=.5*o,g=1/n,b=1/o,y=d*e*.5,v=.5*(n*l+o*c),j=this._upperLeft,_=this._upperRight,M=this._lowerLeft,x=this._lowerRight;V(j,-y,-v),V(_,y,-v),V(M,-y,v),V(x,y,v),R(this._mat2),U(this._mat2,this._mat2,[m+p,w+f]),0!==r&&C(this._mat2,this._mat2,a),q(j,j,this._mat2),q(_,_,this._mat2),q(M,M,this._mat2),q(x,x,this._mat2);const T=this._clipData;T.set([2*M[0]*g-1,2*(o-M[1])*b-1,2*x[0]*g-1,2*(o-x[1])*b-1,2*j[0]*g-1,2*(o-j[1])*b-1,2*_[0]*g-1,2*(o-_[1])*b-1]),this._clipRendererInitialized||this._initializeClipRenderer(s),this._clipVBO.setData(T),this._boundFBO=s.getBoundFramebufferObject(),s.bindFramebuffer(this._clipFBO),s.setDepthWriteEnabled(!0),s.setStencilWriteMask(255),s.setClearColor(0,0,0,0),s.setClearDepth(1),s.setClearStencil(0),s.clear(s.gl.COLOR_BUFFER_BIT|s.gl.DEPTH_BUFFER_BIT|s.gl.STENCIL_BUFFER_BIT),s.setDepthWriteEnabled(!1),this._clipFrame=!0}_afterRenderChildren(){const t=this.context;if(t.logIno(),this._clipFrame&&this._clipRendererInitialized){if(t.bindFramebuffer(this._boundFBO),this._boundFBO=null,t.bindVAO(this._clipVAO),t.useProgram(this._clipStencilProgram),t.setDepthWriteEnabled(!1),t.setDepthTestEnabled(!1),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!1),t.setColorMask(!1,!1,!1,!1),t.setStencilOp(7680,7680,7681),t.setStencilWriteMask(255),t.setStencilFunction(519,1,255),t.drawElements(4,6,5123,0),t.bindVAO(),t.setColorMask(!0,!0,!0,!0),null!=this.background){const{r:s,g:i,b:e,a:h}=this.background.color;t.setClearColor(h*s/255,h*i/255,h*e/255,h)}else t.setClearColor(0,0,0,0);t.clear(t.gl.COLOR_BUFFER_BIT),t.setBlendingEnabled(!0),t.setStencilFunction(514,1,255),this.painter.blitTexture(t,this._clipFBO.colorTexture,9728,1),t.setStencilTestEnabled(!1)}}doRender(t){const s=this.context,{state:i,pixelRatio:e}=t;this._resizeCanvas(t),this.context.enforceState(),s.setViewport(0,0,e*i.size[0],e*i.size[1]),s.setDepthWriteEnabled(!0),s.setStencilWriteMask(255),super.doRender(t)}async takeScreenshot(t){const{framebufferWidth:s,framebufferHeight:i}={framebufferWidth:Math.round(this._renderParameters.state.size[0]*t.resolutionScale),framebufferHeight:Math.round(this._renderParameters.state.size[1]*t.resolutionScale)},e=this.context,h=this._state.clone();if(null!=t.rotation){const s=h.viewpoint;h.viewpoint.rotation=t.rotation,h.viewpoint=s}const r={...this._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:at(h),pixelRatio:1,time:Date.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1},n=new X(e,{colorTarget:0,depthStencilTarget:3,width:s,height:i}),o=e.getBoundFramebufferObject(),a=e.getViewport();e.bindFramebuffer(n),e.setViewport(0,0,s,i),this._renderChildren(t.children,r);const c=this._readbackScreenshot({...t.cropArea,y:i-(t.cropArea.y+t.cropArea.height)});let l;return e.bindFramebuffer(o),e.setViewport(a.x,a.y,a.width,a.height),this.requestRender(),1===t.outputScale?l=c:(l=new ImageData(Math.round(c.width*t.outputScale),Math.round(c.height*t.outputScale)),is(c,l,!0)),es(l,{format:t.format,quality:t.quality,rotation:0,disableDecorations:!1},document.createElement("canvas"),{flipY:!0,premultipliedAlpha:!0})}_readbackScreenshot(t){const s=this.context.gl,i=hs(t.width,t.height,document.createElement("canvas"));return s.readPixels(t.x,t.y,t.width,t.height,6408,5121,new Uint8Array(i.data.buffer)),i}_resizeCanvas(t){const s=this._canvas,i=s.style,{state:{size:e},pixelRatio:h}=t,r=e[0],n=e[1],o=Math.round(r*h),a=Math.round(n*h);s.width===o&&s.height===a||(s.width=o,s.height=a),i.width=r+"px",i.height=n+"px"}_initializeClipRenderer(t){if(this._clipRendererInitialized)return!0;const s=Pi.attributes,i=it(t,Pi);if(!i)return!1;const e=Y.createVertex(t,35040,32),h=new Uint16Array([0,1,2,2,1,3]),r=Y.createIndex(t,35044,h),n=new Q(t,s,{geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},{geometry:e},r);return this._clipStencilProgram=i,this._clipVBO=e,this._clipVAO=n,this._clipRendererInitialized=!0,!0}_emptyTrash(){for(;this._trash.size>0;){const t=Array.from(this._trash);this._trash.clear();for(const s of t)s.processDetach()}}_isLabelDrawPhaseRequired(t){let s=!1;for(const i of t){if(!(i instanceof rt)){s=s||!1;break}if(i.hasLabels)return!0;s=s||this._isLabelDrawPhaseRequired(i.children)}return s}}class ki{constructor(t,s){this.width=t,this.height=s;const i=Math.ceil(t/1),e=Math.ceil(s/1);this._cols=i,this._rows=e,this._cells=ls.create(i*e)}insertMetrics(t){const s=this._hasCollision(t);return 0===s&&this._markMetrics(t),s}getCellId(t,s){return t+s*this._cols}has(t){return this._cells.has(t)}hasRange(t,s){return this._cells.hasRange(t,s)}set(t){this._cells.set(t)}setRange(t,s){this._cells.setRange(t,s)}_hasCollision(t){const s=t.id;let i=0,e=0;t.save();do{const s=t.boundsCount;i+=s;for(let i=0;i<s;i++){const s=t.boundsComputedAnchorX(i),h=t.boundsComputedAnchorY(i),r=t.boundsWidth(i)+2,n=t.boundsHeight(i)+2;switch(this._collide(s,h,r,n)){case 2:return 2;case 1:e++}}}while(t.peekId()===s&&t.next());return t.restore(),i===e?1:0}_collide(t,s,i,e){const h=t-i/2,r=s-e/2,n=h+i,o=r+e;if(n<0||o<0||h>this.width||r>this.height)return 1;const a=as(Math.floor(h/1),0,this._cols),c=as(Math.floor(r/1),0,this._rows),l=as(Math.ceil(n/1),0,this._cols),u=as(Math.ceil(o/1),0,this._rows);for(let t=c;t<=u;t++)for(let s=a;s<=l;s++){const i=this.getCellId(s,t);if(this.has(i))return 2}return 0}_mark(t,s,i,e){const h=t-i/2,r=s-e/2,n=h+i,o=r+e,a=as(Math.floor(h/1),0,this._cols),c=as(Math.floor(r/1),0,this._rows),l=as(Math.ceil(n/1),0,this._cols),u=as(Math.ceil(o/1),0,this._rows);for(let t=c;t<=u;t++)for(let s=a;s<=l;s++){const i=this.getCellId(s,t);this.set(i)}return!1}_markMetrics(t){const s=t.id;do{const s=t.boundsCount;for(let i=0;i<s;i++){const s=t.boundsComputedAnchorX(i),e=t.boundsComputedAnchorY(i),h=t.boundsWidth(i)+2,r=t.boundsHeight(i)+2;this._mark(s,e,h,r)}}while(t.peekId()===s&&t.next())}}const Fi=Math.PI;function zi(t,s){switch(s.transformationType){case"additive":return function(t,s){return t+(Ri(s.minSize,t)||s.minDataValue)}(t,s);case"constant":return function(t,s){const i=t.stops;let e=i&&i.length&&i[0].size;return null==e&&(e=t.minSize),Ri(e,s)}(s,t);case"clamped-linear":return function(t,s){const i=(t-s.minDataValue)/(s.maxDataValue-s.minDataValue),e=Ri(s.minSize,t),h=Ri(s.maxSize,t);return t<=s.minDataValue?e:t>=s.maxDataValue?h:e+i*(h-e)}(t,s);case"proportional":return function(t,s){const i=t/s.minDataValue,e=Ri(s.minSize,t),h=Ri(s.maxSize,t);let r=null;return r=i*e,as(r,e,h)}(t,s);case"stops":return function(t,s){const[i,e,h]=function(t,s){if(!s)return;let i=0,e=s.length-1;return s.some(((s,h)=>t<s?(e=h,!0):(i=h,!1))),[i,e,(t-s[i])/(s[e]-s[i])]}(t,s.cache.ipData);if(i===e)return Ri(s.stops[i].size,t);{const r=Ri(s.stops[i].size,t);return r+(Ri(s.stops[e].size,t)-r)*h}}(t,s);case"real-world-size":return function(t,s){const i=us[s.valueUnit],e=Ri(s.minSize,t),h=Ri(s.maxSize,t),{valueRepresentation:r}=s;let n=null;return n="area"===r?2*Math.sqrt(t/Fi)/i:"radius"===r||"distance"===r?2*t/i:t/i,as(n,e,h)}(t,s);case"identity":return t;case"unknown":return null}}function Ri(t,s){return"number"==typeof t?t:zi(s,t)}function Ui(s,i){const e=[];s.forEachTile((t=>e.push(t))),e.sort(((t,s)=>t.instanceId-s.instanceId)),e.forEach((s=>{t(s.labelMetrics)&&s.isReady&&i(s,s.labelMetrics.getCursor())}))}function Ci(t){return s=>Rt(zi(s,t))}function $i(t,s){if(!function(t){return"feature"===t.layer.type||"csv"===t.layer.type||"geojson"===t.layer.type||"ogc-feature"===t.layer.type||"stream"===t.layer.type||"subtype-group"===t.layer.type||"wfs"===t.layer.type}(s))return;const i=s.layer.geometryType,e=!function(t){for(const i of t){var s;const t="featureReduction"in i&&"cluster"===(null==(s=i.featureReduction)?void 0:s.type)&&i.featureReduction,e=[...i.labelingInfo||[],...t.labelingInfo||[]];if(i.labelsVisible&&e.length&&e.some((t=>"none"===t.deconflictionStrategy)))return!0}return!1}("subtype-group"===s.layer.type?s.layer.sublayers.items:[s.layer]),h={};if("subtype-group"!==s.layer.type){if("heatmap"===s.layer.renderer.type)return;const t=function(t){const s="visualVariables"in t&&t.visualVariables;if(!s)return null;for(const t of s)if("size"===t.type)return Ci(t);return null}(s.layer.renderer);h[0]=t}const r=s.tileRenderer;f(r)||t.push({tileRenderer:r,vvEvaluators:h,deconflictionEnabled:e,geometryType:i,visible:s.layer.visible})}class Bi{run(t,s,i){const e=[];for(let s=t.length-1;s>=0;s--)$i(e,t[s]);this._transformMetrics(e,s),this._runCollision(e,s,i)}_runCollision(t,s,i){const[e,h]=s.state.size,r=new ki(e*s.pixelRatio,h*s.pixelRatio);for(const{tileRenderer:s,deconflictionEnabled:e,visible:h}of t){const t=s.featuresView.attributeView;e?h?(this._prepare(s),this._collideVisible(r,s,i),this._collideInvisible(r,s)):Ui(s,((s,i)=>{for(;i.nextId();)t.setLabelMinZoom(i.id,255)})):Ui(s,((s,i)=>{for(;i.nextId();)t.setLabelMinZoom(i.id,0)}))}}_isFiltered(s,i,e){const h=i.getFilterFlags(s),r=!e.hasFilter||!!(h&Ht),n=!t(e.featureEffect)||e.featureEffect.excludedLabelsVisible||!!(h&Wt);return!(r&&n)}_prepare(t){const s=t.featuresView.attributeView,i=new Set;Ui(t,((e,h)=>{for(;h.nextId();)i.has(h.id)||(i.add(h.id),this._isFiltered(h.id,s,t.layerView)?s.setLabelMinZoom(h.id,254):0!==s.getLabelMinZoom(h.id)?s.setLabelMinZoom(h.id,255):s.setLabelMinZoom(h.id,0))}))}_collideVisible(t,s,i){const e=s.featuresView.attributeView,h=new Set;Ui(s,((s,r)=>{for(;r.nextId();)if(!h.has(r.id))if(s.key.level===i){if(0===e.getLabelMinZoom(r.id))switch(t.insertMetrics(r)){case 1:break;case 2:e.setLabelMinZoom(r.id,254),h.add(r.id);break;case 0:e.setLabelMinZoom(r.id,0),h.add(r.id)}}else e.setLabelMinZoom(r.id,254)}))}_collideInvisible(t,s){const i=s.featuresView.attributeView,e=new Set;Ui(s,((s,h)=>{for(;h.nextId();)if(!e.has(h.id)&&255===i.getLabelMinZoom(h.id))switch(t.insertMetrics(h)){case 1:break;case 2:i.setLabelMinZoom(h.id,255),e.add(h.id);break;case 0:i.setLabelMinZoom(h.id,0),e.add(h.id)}}))}_transformMetrics(s,i){for(const{tileRenderer:e,geometryType:h,vvEvaluators:r}of s)Ui(e,((s,n)=>{const o=e.featuresView.attributeView,a=s.transforms.labelMat2d;a[4]=Math.round(a[4]),a[5]=Math.round(a[5]);const c=a[4],l=a[5],u="polyline"===h;for(;n.next();){const s=n.boundsCount,e=n.anchorX,h=n.anchorY;let d=n.size;const p=r[0];if(t(p)){const t=p(o.getVVSize(n.id));d=isNaN(t)||null==t||t===1/0?d:t}const f=n.directionX*(d/2),m=n.directionY*(d/2);for(let t=0;t<s;t++){let s=e,r=n.anchorY;if(u){let e=s+n.boundsX(t)+f,h=r+n.boundsY(t)+m;i.state.rotation?(e=a[0]*e+a[2]*h+a[4],h=a[1]*e+a[3]*h+a[5]):(e+=c,h+=l),n.setBoundsComputedAnchorX(t,Math.floor(e)),n.setBoundsComputedAnchorY(t,Math.floor(h))}else{i.state.rotation?(s=a[0]*e+a[2]*h+a[4],r=a[1]*e+a[3]*h+a[5]):(s+=c,r+=l);const o=s+n.boundsX(t)+f,u=r+n.boundsY(t)+m;n.setBoundsComputedAnchorX(t,o),n.setBoundsComputedAnchorY(t,u)}}}}))}}const Ei=u.getLogger("esri.views.2d.layers.labels.LabelManager");let Ii=class extends(rs(v)){constructor(t){super(t),this._applyVisibilityPassThrottled=ns(this._applyVisibilityPass,32,this),this.lastUpdateId=-1,this.updateRequested=!1,this.view=null}initialize(){this.collisionEngine=new Bi}destroy(){this.collisionEngine=null,this._applyVisibilityPassThrottled.remove(),this._applyVisibilityPassThrottled=null}get updating(){return this.updateRequested}update(t){this._applyVisibilityPassThrottled(t)}viewChange(){this.requestUpdate()}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}processUpdate(t){this._set("updateParameters",t),this.updateRequested&&(this.updateRequested=!1,this.update(t))}_applyVisibilityPass(t){try{const s=this.view.featuresTilingScheme.getClosestInfoForScale(t.state.scale).level;this.collisionEngine.run(this.view.allLayerViews.items,t,s)}catch(t){Ei.error(new a("mapview-labeling","Encountered an error during label decluttering",t))}}};j([_()],Ii.prototype,"updateRequested",void 0),j([_({readOnly:!0})],Ii.prototype,"updateParameters",void 0),j([_()],Ii.prototype,"updating",null),j([_()],Ii.prototype,"view",void 0),Ii=j([M("esri.views.2d.layers.labels.LabelManager")],Ii);const Di=Ii;let Oi=class extends v{constructor(t){super(t),this._container=null,this._overlay=null,this._backgroundShape=null,this._boxShape=null,this._box={x:0,y:0,width:0,height:0},this._redraw=this._redraw.bind(this)}destroy(){this.view=null}set view(t){this._handles&&this._handles.forEach((t=>{t.remove()})),this._handles=null,this._destroyOverlay(),this._set("view",t),t&&(t.on("drag",["Shift"],(t=>this._handleDrag(t,1)),os.INTERNAL),t.on("drag",["Shift","Ctrl"],(t=>this._handleDrag(t,-1)),os.INTERNAL))}_start(){this._createContainer(),this._createOverlay(),this.navigation.begin()}_update(t,s,i,e){this._box.x=t,this._box.y=s,this._box.width=i,this._box.height=e,this._rafId||(this._rafId=requestAnimationFrame(this._redraw))}_end(t,s,i,e,h){const r=this.view,n=r.toMap(Ut(t+.5*i,s+.5*e));let o=Math.max(i/r.width,e/r.height);-1===h&&(o=1/o),this._destroyOverlay(),this.navigation.end(),r.goTo({center:n,scale:r.scale*o})}_updateBox(t,s,i,e){const h=this._boxShape;h.setAttributeNS(null,"x",""+t),h.setAttributeNS(null,"y",""+s),h.setAttributeNS(null,"width",""+i),h.setAttributeNS(null,"height",""+e),h.setAttributeNS(null,"class","esri-zoom-box__outline")}_updateBackground(t,s,i,e){this._backgroundShape.setAttributeNS(null,"d",this._toSVGPath(t,s,i,e,this.view.width,this.view.height))}_createContainer(){const t=document.createElement("div");t.className="esri-zoom-box__container",this.view.root.appendChild(t),this._container=t}_createOverlay(){const t=this.view.width,s=this.view.height,i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttributeNS(null,"d","M 0 0 L "+t+" 0 L "+t+" "+s+" L 0 "+s+" Z"),i.setAttributeNS(null,"class","esri-zoom-box__overlay-background");const e=document.createElementNS("http://www.w3.org/2000/svg","rect"),h=document.createElementNS("http://www.w3.org/2000/svg","svg");h.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),h.setAttributeNS(null,"class","esri-zoom-box__overlay"),h.appendChild(i),h.appendChild(e),this._container.appendChild(h),this._backgroundShape=i,this._boxShape=e,this._overlay=h}_destroyOverlay(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=this._backgroundShape=this._boxShape=this._overlay=null}_toSVGPath(t,s,i,e,h,r){const n=t+i,o=s+e;return"M 0 0 L "+h+" 0 L "+h+" "+r+" L 0 "+r+" ZM "+t+" "+s+" L "+t+" "+o+" L "+n+" "+o+" L "+n+" "+s+" Z"}_handleDrag(t,s){const i=t.x,e=t.y,h=t.origin.x,r=t.origin.y;let n,o,a,c;switch(i>h?(n=h,a=i-h):(n=i,a=h-i),e>r?(o=r,c=e-r):(o=e,c=r-e),t.action){case"start":this._start();break;case"update":this._update(n,o,a,c);break;case"end":this._end(n,o,a,c,s)}t.stopPropagation()}_redraw(){if(!this._rafId)return;if(this._rafId=null,!this._overlay)return;const{x:t,y:s,width:i,height:e}=this._box;this._updateBox(t,s,i,e),this._updateBackground(t,s,i,e),this._rafId=requestAnimationFrame(this._redraw)}};j([_()],Oi.prototype,"navigation",void 0),j([_()],Oi.prototype,"view",null),Oi=j([M("esri.views.2d.navigation.ZoomBox")],Oi);const Li=Oi;let Gi=class extends v{constructor(t){super(t),this.animationTime=0,this.momentumEstimator=new ct(500,6,.92),this.momentum=null,this.tmpMomentum=F(),this.momentumFinished=!1,this.viewpoint=new ds({targetGeometry:new x,scale:0,rotation:0}),this.watch("momentumFinished",(t=>{t&&this.navigation.stop()}))}begin(t,s){this.navigation.begin(),this.momentumEstimator.reset(),this.addToEstimator(s),this.previousDrag=s}update(t,s){this.addToEstimator(s);let i=s.center.x,e=s.center.y;const h=this.previousDrag;i=h?h.center.x-i:-i,e=h?e-h.center.y:e,t.viewpoint=E(this.viewpoint,t.viewpoint,[i||0,e||0]),this.previousDrag=s}end(t,s){this.addToEstimator(s),this.momentum=t.navigation.momentumEnabled?this.momentumEstimator.evaluateMomentum():null,this.animationTime=0,this.momentum&&this.onAnimationUpdate(t),this.previousDrag=null,this.navigation.end()}addToEstimator(t){const s=t.center.x,i=t.center.y,e=Ct(-s,i),h=z(-s,i,0);this.momentumEstimator.add(e,h,.001*t.timestamp)}onAnimationUpdate(t){this.navigation.animationManager.animateContinous(t.viewpoint,((s,i)=>{this.momentumFinished=!this.momentum||this.momentum.isFinished(this.animationTime);const e=.001*i;if(!this.momentumFinished){const i=this.momentum.valueDelta(this.animationTime,e);cs(this.tmpMomentum,this.momentum.direction,i),E(s,s,this.tmpMomentum),t.constraints.constrainByGeometry(s)}this.animationTime+=e}))}stopMomentumNavigation(){this.momentum&&(this.momentumEstimator.reset(),this.momentum=null,this.navigation.stop())}};j([_()],Gi.prototype,"momentumFinished",void 0),j([_()],Gi.prototype,"viewpoint",void 0),j([_()],Gi.prototype,"navigation",void 0),Gi=j([M("esri.views.2d.navigation.actions.Pan")],Gi);const Ni=Gi;let Vi=class extends v{constructor(t){super(t),this._animationTime=0,this._momentumFinished=!1,this._rotationMomentumEstimator=new lt(.6,.15,.95),this._rotationDirection=1,this._zoomDirection=1,this._zoomMomentumEstimator=new ut,this._zoomOnly=null,this.zoomMomentum=null,this.rotateMomentum=null,this.viewpoint=new ds({targetGeometry:new x,scale:0,rotation:0}),this.watch("_momentumFinished",(t=>{t&&this.navigation.stop()}))}begin(t,s){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=s.angle,this._previousRadius=this._startRadius=s.radius,this._previousCenter=s.center,this._updateTimestamp=null,t.constraints.rotationEnabled&&this.addToRotateEstimator(0,s.timestamp),this.addToZoomEstimator(s,1)}update(t,s){null===this._updateTimestamp&&(this._updateTimestamp=s.timestamp);const i=s.angle,e=s.radius,h=s.center,r=Math.abs(180*(i-this._startAngle)/Math.PI),n=Math.abs(e-this._startRadius),o=this._startRadius/e;if(this._previousRadius){const a=e/this._previousRadius;let c=180*(i-this._previousAngle)/Math.PI;this._rotationDirection=c>=0?1:-1,this._zoomDirection=a>=1?1:-1,t.constraints.rotationEnabled?(null===this._zoomOnly&&s.timestamp-this._updateTimestamp>200&&(this._zoomOnly=n-r>0),null===this._zoomOnly||this._zoomOnly?c=0:this.addToRotateEstimator(i-this._startAngle,s.timestamp)):c=0,this.addToZoomEstimator(s,o),this.navigation.setViewpoint([h.x,h.y],1/a,c,[this._previousCenter.x-h.x,h.y-this._previousCenter.y])}this._previousAngle=i,this._previousRadius=e,this._previousCenter=h}end(t){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=0,(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(t),this.navigation.end()}addToRotateEstimator(t,s){this._rotationMomentumEstimator.add(t,.001*s)}addToZoomEstimator(t,s){this._zoomMomentumEstimator.add(s,.001*t.timestamp)}canZoomIn(t){const s=t.constraints.effectiveMaxScale;return 0===s||t.scale>s}canZoomOut(t){const s=t.constraints.effectiveMinScale;return 0===s||t.scale<s}onAnimationUpdate(t){this.navigation.animationManager.animateContinous(t.viewpoint,((s,i)=>{const e=!this.canZoomIn(t)&&this._zoomDirection>1||!this.canZoomOut(t)&&this._zoomDirection<1,h=!this.rotateMomentum||this.rotateMomentum.isFinished(this._animationTime),r=e||!this.zoomMomentum||this.zoomMomentum.isFinished(this._animationTime),n=.001*i;if(this._momentumFinished=h&&r,!this._momentumFinished){const i=this.rotateMomentum?Math.abs(this.rotateMomentum.valueDelta(this._animationTime,n))*this._rotationDirection*180/Math.PI:0;let e=this.zoomMomentum?Math.abs(this.zoomMomentum.valueDelta(this._animationTime,n)):1;const h=Z(),r=Z();if(this._previousCenter){V(h,this._previousCenter.x,this._previousCenter.y),I(r,t.size,t.padding),H(h,h,r);const{constraints:n,scale:o}=t,a=o*e;e<1&&!n.canZoomInTo(a)?(e=o/n.effectiveMaxScale,this.zoomMomentum=null,this.rotateMomentum=null):e>1&&!n.canZoomOutTo(a)&&(e=o/n.effectiveMinScale,this.zoomMomentum=null,this.rotateMomentum=null),D(s,t.viewpoint,e,i,h,t.size),t.constraints.constrainByGeometry(s)}}this._animationTime+=n}))}stopMomentumNavigation(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())}};j([_()],Vi.prototype,"_momentumFinished",void 0),j([_()],Vi.prototype,"viewpoint",void 0),j([_()],Vi.prototype,"navigation",void 0),Vi=j([M("esri.views.2d.navigation.actions.Pinch")],Vi);const qi=Vi,Hi=Z(),Wi=Z();let Zi=class extends v{constructor(t){super(t),this._previousCenter=Z(),this.viewpoint=new ds({targetGeometry:new x,scale:0,rotation:0})}begin(t,s){this.navigation.begin(),V(this._previousCenter,s.center.x,s.center.y)}update(t,s){const{state:{size:i,padding:e}}=t;V(Hi,s.center.x,s.center.y),O(Wi,i,e),t.viewpoint=L(this.viewpoint,t.state.paddedViewState.viewpoint,G(Wi,this._previousCenter,Hi)),W(this._previousCenter,Hi)}end(){this.navigation.end()}};j([_()],Zi.prototype,"viewpoint",void 0),j([_()],Zi.prototype,"navigation",void 0),Zi=j([M("esri.views.2d.actions.Rotate")],Zi);const Ji=Zi,Ki=new ds({targetGeometry:new x}),Qi=[0,0];let Yi=class extends v{constructor(t){super(t),this._endTimer=null,this.animationManager=null}initialize(){this.pan=new Ni({navigation:this}),this.rotate=new Ji({navigation:this}),this.pinch=new qi({navigation:this}),this.zoomBox=new Li({view:this.view,navigation:this})}destroy(){this.zoomBox.destroy(),this.zoomBox=null,this.animationManager=null}begin(){this._set("interacting",!0)}end(){this._lastEventTimestamp=performance.now(),this._startTimer(250)}async zoom(t,s=this._getDefaultAnchor()){if(this.stop(),this.begin(),this.view.constraints.snapToZoom&&this.view.constraints.effectiveLODs)return t<1?this.zoomIn(s):this.zoomOut(s);this.setViewpoint(s,t,0,[0,0])}async zoomIn(t){const s=this.view,i=s.constraints.snapToNextScale(s.scale);return this._zoomToScale(i,t)}async zoomOut(t){const s=this.view,i=s.constraints.snapToPreviousScale(s.scale);return this._zoomToScale(i,t)}setViewpoint(t,s,i,e){this.begin(),this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,t,s,i,e),this.end()}setViewpointImmediate(t,s=0,i=[0,0],e=this._getDefaultAnchor()){this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,e,t,s,i)}continousRotateClockwise(){const t=this.get("view.viewpoint");this.animationManager.animateContinous(t,(t=>{L(t,t,-1)}))}continousRotateCounterclockwise(){const t=this.get("view.viewpoint");this.animationManager.animateContinous(t,(t=>{L(t,t,1)}))}resetRotation(){this.view.rotation=0}continousPanLeft(){this._continuousPan([-10,0])}continousPanRight(){this._continuousPan([10,0])}continousPanUp(){this._continuousPan([0,10])}continousPanDown(){this._continuousPan([0,-10])}stop(){this.pan.stopMomentumNavigation(),this.animationManager.stop(),this.end(),null!==this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null,this._set("interacting",!1))}_continuousPan(t){const s=this.get("view.viewpoint");this.animationManager.animateContinous(s,(s=>{E(s,s,t),this.view.constraints.constrainByGeometry(s)}))}_startTimer(t){return null!==this._endTimer||(this._endTimer=setTimeout((()=>{this._endTimer=null;const t=performance.now()-this._lastEventTimestamp;t<250?this._endTimer=this._startTimer(t):this._set("interacting",!1)}),t)),this._endTimer}_getDefaultAnchor(){const{size:t,padding:{left:s,right:i,top:e,bottom:h}}=this.view;return Qi[0]=.5*(t[0]-i+s),Qi[1]=.5*(t[1]-h+e),Qi}async _zoomToScale(t,s=this._getDefaultAnchor()){const{view:i}=this,{constraints:e,scale:h,viewpoint:r,size:n,padding:o}=i,a=e.canZoomInTo(t),c=e.canZoomOutTo(t);if(!(t<h&&!a||t>h&&!c))return N(Ki,r,t/h,0,s,n,o),e.constrainByGeometry(Ki),i.goTo(Ki,{animate:!0})}_scaleRotateTranslateViewpoint(t,s,i,e,h){const{view:r}=this,{size:n,padding:o,constraints:a,scale:c,viewpoint:l}=r,u=c*i,d=a.canZoomInTo(u),p=a.canZoomOutTo(u);return(i<1&&!d||i>1&&!p)&&(i=1),E(l,l,h),N(t,l,i,e,s,n,o),a.constrainByGeometry(t)}};j([_()],Yi.prototype,"animationManager",void 0),j([_({type:Boolean,readOnly:!0})],Yi.prototype,"interacting",void 0),j([_()],Yi.prototype,"pan",void 0),j([_()],Yi.prototype,"pinch",void 0),j([_()],Yi.prototype,"rotate",void 0),j([_()],Yi.prototype,"view",void 0),j([_()],Yi.prototype,"zoomBox",void 0),Yi=j([M("esri.views.2d.navigation.MapViewNavigation")],Yi);const Xi=Yi,te={shaders:{vertexShader:Pt("magnifier/magnifier.vert"),fragmentShader:Pt("magnifier/magnifier.frag")},attributes:new Map([["a_pos",0]])};class se extends ps{constructor(){super(),this._handles=new T,this._resourcePixelRatio=1,this.visible=!1}destroy(){this._handles.destroy(),this._handles=null,this._disposeRenderResources(),this._resourcesTask&&(this._resourcesTask.abort(),this._resourcesTask=null)}get background(){return this._background}set background(t){this._background=t,this.requestRender()}get magnifier(){return this._magnifier}set magnifier(s){this._magnifier=s,this._handles.removeAll(),this._handles.add([y(s,"version",(()=>{this.visible=s.visible&&t(s.position)&&s.size>0,this.requestRender()})),s.watch(["mask","overlay"],(()=>this._reloadResources())),s.watch("size",(()=>{this._disposeRenderResources(),this.requestRender()}))])}_createTransforms(){return{dvs:B()}}doRender(t){var s;const i=t.context;if(!this._resourcesTask)return void this._reloadResources();if(t.drawPhase!==pt.MAP||!this._canRender())return;this._updateResources(t);const e=this._magnifier;if(f(e.position))return;const h=t.pixelRatio,r=e.size*h,n=Math.ceil(1/e.factor*r);this._readbackTexture.resize(n,n);const{size:o}=t.state,a=h*o[0],c=h*o[1],l=.5*n,u=.5*n,d=as(h*e.position.x,l,a-l-1),p=as(c-h*e.position.y,u,c-u-1);i.setBlendingEnabled(!0);const m=d-l,w=p-u,g=this._readbackTexture;i.bindTexture(g,0),i.gl.copyTexImage2D(g.descriptor.target,0,g.descriptor.pixelFormat,m,w,n,n,0);const b=null==(s=this.background)?void 0:s.color,y=b?[b.a*b.r/255,b.a*b.g/255,b.a*b.b/255,b.a]:[1,1,1,1],v=(d+e.offset.x*h)/a*2-1,j=(p-e.offset.y*h)/c*2-1,_=r/a*2,M=r/c*2,x=this._program;i.bindVAO(this._vertexArrayObject),i.bindTexture(this._overlayTexture,6),i.bindTexture(this._maskTexture,7),i.useProgram(x),x.setUniform4fv("u_background",y),x.setUniform1i("u_readbackTexture",0),x.setUniform1i("u_overlayTexture",6),x.setUniform1i("u_maskTexture",7),x.setUniform4f("u_drawPos",v,j,_,M),x.setUniform1i("u_maskEnabled",e.maskEnabled?1:0),x.setUniform1i("u_overlayEnabled",e.overlayEnabled?1:0),i.setStencilTestEnabled(!1),i.setColorMask(!0,!0,!0,!0),i.drawArrays(5,0,4),i.bindVAO()}_canRender(){return this.mask&&this.overlay&&null!=this._magnifier}_reloadResources(){this._resourcesTask&&this._resourcesTask.abort();const s=t(this._magnifier)?this._magnifier.maskUrl:null,i=t(this._magnifier)?this._magnifier.overlayUrl:null;this._resourcesTask=S((async e=>{const r=f(s)||f(i)?dt(e):null,n=t(s)?h(s,{responseType:"image",signal:e}).then((t=>t.data)):r.then((t=>t.mask)),o=t(i)?h(i,{responseType:"image",signal:e}).then((t=>t.data)):r.then((t=>t.overlay)),[a,c]=await Promise.all([n,o]);this.mask=a,this.overlay=c,this._disposeRenderResources(),this.requestRender()}))}_disposeRenderResources(){this._readbackTexture=P(this._readbackTexture),this._overlayTexture=P(this._overlayTexture),this._maskTexture=P(this._maskTexture),this._vertexArrayObject=P(this._vertexArrayObject),this._program=P(this._program)}_updateResources(t){if(t.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),this._readbackTexture)return;const s=t.context;this._resourcePixelRatio=t.pixelRatio;const i=Math.ceil(this._magnifier.size*t.pixelRatio);this._program=function(t){return it(t,te)}(s);const e=new Uint16Array([0,1,0,0,1,1,1,0]);this._vertexArrayObject=new Q(s,te.attributes,{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1,divisor:0}]},{geometry:Y.createVertex(s,35044,e)}),this.overlay.width=i,this.overlay.height=i,this._overlayTexture=new st(s,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,preMultiplyAlpha:!A(this.overlay.src)||!t.context.driverTest.svgAlwaysPremultipliesAlpha},this.overlay),this.mask.width=i,this.mask.height=i,this._maskTexture=new st(s,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0},this.mask);const h=1/this._magnifier.factor;this._readbackTexture=new st(s,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:Math.ceil(h*i),height:Math.ceil(h*i)})}}export{Di as LabelManager,se as MagnifierView2D,Xi as MapViewNavigation,Ai as Stage}