import{s as t,e as i,d as s,aR as e,i as r,p as h,hq as a,E as o,a8 as n,W as p,aH as l,ce as d,aj as m,H as u,bn as c,a7 as y,gh as w,ac as f,U as g,G as j}from"./p-7b6f6c18.js";import{l as v,u as x}from"./p-0b691897.js";import{j as b}from"./p-a549f546.js";import{m as R}from"./p-631b6cb2.js";import{n as D}from"./p-a4a5967b.js";import{i as E}from"./p-5448dec1.js";import{r as I}from"./p-2d5d1985.js";import{d as P}from"./p-167d094f.js";import{t as V}from"./p-9afeab98.js";import{i as q}from"./p-cde787e2.js";import{S}from"./p-ce308849.js";import{d as T}from"./p-6bccadb6.js";import{i as U}from"./p-de5d9151.js";import"./p-227a5838.js";import"./p-033339b0.js";import"./p-804725e3.js";import"./p-1dd7027e.js";import"./p-cede17c2.js";import"./p-ea65d9c9.js";import"./p-47e1bd73.js";import"./p-b392deaf.js";import"./p-9790d1b4.js";import"./p-51e4508b.js";import"./p-50ff864e.js";import"./p-54e8960f.js";import"./p-fb136006.js";import"./p-1088d11f.js";import"./p-e53f77c2.js";import"./p-5bfd1d7e.js";import"./p-4414d64f.js";import"./p-a617738c.js";import"./p-a16c2b1d.js";import"./p-97ec6ae5.js";import"./p-10e211d9.js";import"./p-df9635e1.js";import"./p-7d065686.js";import"./p-94807627.js";import"./p-3e28396b.js";import"./p-f78de11d.js";import"./p-269bd937.js";import"./p-dfd2d479.js";import"./p-9f705d18.js";import"./p-ec834938.js";import"./p-55e3d31e.js";import"./p-dede18bd.js";import"./p-5c077b4e.js";import"./p-e991a11e.js";import"./p-b1c9647c.js";const N=t.getLogger("esri.views.2d.layers.imagery.ImageryGraphicsView2D");let k=class extends h{constructor(){super(...arguments),this.attached=!1,this.container=new D,this.updateRequested=!1,this._graphicsView=null,this._projectFullExtentPromise=null,this._dataParameters={exportParametersVersion:0,extents:[],tileResolution:0,time:""},this.type="Graphics",this._graphics=new a,this._updateGraphics=o((async(t,i)=>{if(!t.stationary)return;const s=t.state,e=new n({xmin:s.extent.xmin,ymin:s.extent.ymin,xmax:s.extent.xmax,ymax:s.extent.ymax,spatialReference:s.spatialReference}),[r,h]=t.state.size,a={};a.timeExtent=this.timeExtent,a.requestAsImageElement=!1,a.signal=i,null==this._projectFullExtentPromise&&(this._projectFullExtentPromise=this._getProjectedFullExtent(e.spatialReference));const o="vector-field"===this.layer.renderer.type?this.layer.renderer.symbolTileSize:50,l=await this._projectFullExtentPromise,{extent:d,resolution:m,width:u,height:c}=R(e,r,h,o,l),y=await this.layer.fetchImage(d,u,c,a),w=this.layer.renderer;if("vector-field"===w.type){const i=y.pixelData.pixelBlock,s=w.sizeVariables[0];!p(i)||s.minDataValue&&s.maxDataValue||(s.minDataValue=i.statistics[0].minValue,s.maxDataValue=i.statistics[0].maxValue),this._pixelData={extent:d,pixelBlock:i};const e=d.clone().normalize(),r={exportParametersVersion:this.layer.exportImageServiceParameters.version,extents:e,tileResolution:m,time:JSON.stringify(this.timeExtent||"")},h=this._canReuseVectorFieldData(r)?this._dataParameters.extents:[],a=await w.getGraphicsFromPixelData(y.pixelData,"vector-uv"===this.layer.rasterInfo.dataType,h);if(h.length){const t=this._graphics.items.filter((t=>p(t.geometry)&&h.some((i=>i.intersects(t.geometry)))&&!e.some((i=>i.intersects(t.geometry)))));this._graphics.removeMany(t),this._graphics.addMany(a)}else this._graphics.set("items",a);this._graphicsView.update(t),this._dataParameters=r}}))}destroy(){this.attached&&(this.detach(),this.attached=!1),this.updateRequested=!1}get updating(){return!this.attached||this.isUpdating()}update(t){this._updateGraphics(t).catch((t=>{l(t)||N.error(t)}))}hitTest(t,i){const s=this.view.toMap(d(t,i));return Promise.resolve(new m({attributes:{},geometry:s,layer:this.layer}))}attach(){this._graphicsView=new I({view:this.view,graphics:this._graphics,requestUpdateCallback:()=>this.requestUpdate(),container:new E(this.view.featuresTilingScheme)}),this.attached=!0}detach(){this._graphics.destroy(),this._graphicsView.destroy(),this.container.removeChild(this._graphicsView.container),this._graphicsView=null}install(t){this.container.addChild(this._graphicsView.container),t.addChild(this.container)}uninstall(t){this.container.removeChild(this._graphicsView.container),t.removeChild(this.container)}isUpdating(){return this._graphicsView.updating||this.updateRequested}getPixelData(){return this.updating?null:this._pixelData}redraw(){}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}async _getProjectedFullExtent(t){try{return await b(this.layer.fullExtent,t)}catch(i){try{const i=(await u(this.layer.url,{query:{option:"footprints",outSR:t.wkid||JSON.stringify(t.toJSON()),f:"json"}})).data.featureCollection.layers[0].layerDefinition.extent;return i?n.fromJSON(i):null}catch{return null}}}_canReuseVectorFieldData(t){const i=this._dataParameters.exportParametersVersion===t.exportParametersVersion,s=this._dataParameters.time===t.time,e=Math.abs(this._dataParameters.tileResolution-t.tileResolution)/t.tileResolution<.01,r=this._dataParameters.extents.some((i=>t.extents.some((t=>i.intersects(t)))));return i&&s&&e&&r}};i([s()],k.prototype,"attached",void 0),i([s()],k.prototype,"container",void 0),i([s()],k.prototype,"layer",void 0),i([s()],k.prototype,"timeExtent",void 0),i([s()],k.prototype,"view",void 0),i([s()],k.prototype,"updateRequested",void 0),i([s()],k.prototype,"updating",null),i([e({graphics:"Graphics"})],k.prototype,"type",void 0),k=i([r("esri.views.2d.layers.imagery.ImageryGraphicsView2D")],k);const G=k,M=t.getLogger("esri.views.2d.layers.imagery.ImageryView2D");let B=class extends h{constructor(){super(...arguments),this.attached=!1,this.container=new D,this.updateRequested=!1,this.type="Imagery",this._bitmapView=null}destroy(){this.attached&&(this.detach(),this.attached=!1),this.updateRequested=!1}get updating(){return!this.attached||this.isUpdating()}update(t){this.strategy.update(t).catch((t=>{l(t)||M.error(t)}))}detach(){this.strategy.destroy(),this._bitmapView.removeAllChildren(),this.container.removeAllChildren()}hitTest(t,i){const s=this.view.toMap(d(t,i));return Promise.resolve(new m({attributes:{},geometry:s,layer:this.layer}))}attach(){const t=this.layer.version>=10,i=this.layer.version>=10.1?this.layer.imageMaxHeight:2048,s=this.layer.version>=10.1?this.layer.imageMaxWidth:2048;this._bitmapView=new V,this.strategy=new S({container:this._bitmapView,imageNormalizationSupported:t,imageMaxHeight:i,imageMaxWidth:s,fetchSource:this._fetchImage.bind(this),requestUpdate:()=>this.requestUpdate()}),this.attached=!0}install(t){this.container.addChild(this._bitmapView),t.addChild(this.container)}uninstall(t){this.container.removeChild(this._bitmapView),t.removeChild(this.container)}redraw(){this.strategy.updateExports((t=>{t.source instanceof HTMLImageElement?t.requestRender():this.layer.applyRenderer({pixelBlock:t.source.pixelBlock}).then((i=>{const s=t.source;s.pixelBlock=i.pixelBlock,s.filter=t=>this.layer.applyFilter(t),this.container.requestRender()}))}))}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}isUpdating(){return this.strategy.updating||this.updateRequested}getPixelData(){if(this.updating)return null;const t=this.strategy.bitmaps;if(1===t.length&&t[0].source)return{extent:t[0].source.extent,pixelBlock:t[0].source.originalPixelBlock};if(t.length>1){const i=this.view.extent,s=t.map((t=>t.source)).filter((t=>t.extent&&t.extent.intersects(i))).map((t=>({extent:t.extent,pixelBlock:t.originalPixelBlock}))),e=P(s,i);return p(e)?{extent:e.extent,pixelBlock:e.pixelBlock}:null}return null}_fetchImage(t,i,s,e){return(e=e||{}).timeExtent=this.timeExtent,e.requestAsImageElement=!0,this.layer.fetchImage(t,i,s,e).then((t=>t.imageElement?t.imageElement:this.layer.applyRenderer(t.pixelData,{signal:e.signal}).then((i=>{const s=new q(i.pixelBlock,i.extent.clone(),t.pixelData.pixelBlock);return s.filter=t=>this.layer.applyFilter(t),s}))))}};i([s()],B.prototype,"attached",void 0),i([s()],B.prototype,"container",void 0),i([s()],B.prototype,"layer",void 0),i([s()],B.prototype,"strategy",void 0),i([s()],B.prototype,"timeExtent",void 0),i([s()],B.prototype,"view",void 0),i([s()],B.prototype,"updateRequested",void 0),i([s()],B.prototype,"updating",null),i([e({imagery:"Imagery"})],B.prototype,"type",void 0),B=i([r("esri.views.2d.layers.imagery.ImageryView2D")],B);const F=B,H=t=>{let e=class extends t{constructor(){super(...arguments),this.view=null}async fetchPopupFeatures(t,i){const{layer:s}=this;if(!t)throw new y("imagerylayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:s});const{popupEnabled:e}=s,r=T(s,i);if(!e||!p(r))throw new y("imagerylayerview:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:e,popupTemplate:r});const h=await r.getRequiredFields(),a=new w;a.timeExtent=this.timeExtent,a.geometry=t,a.outFields=h,a.outSpatialReference=t.spatialReference;const o=this.view.resolution,n="2d"===this.view.type?new f(o,o,this.view.spatialReference):new f(.5*o,.5*o,this.view.spatialReference),{returnTopmostRaster:l,showNoDataRecords:d}=r.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},m={returnDomainValues:!0,returnTopmostRaster:l,pixelSize:n,showNoDataRecords:d,signal:p(i)?i.signal:null};return s.queryVisibleRasters(a,m).then((t=>t))}canResume(){var t;return!(!super.canResume()||null!=(t=this.timeExtent)&&t.isEmpty)}};return i([s()],e.prototype,"layer",void 0),i([s()],e.prototype,"suspended",void 0),i([s(c)],e.prototype,"timeExtent",void 0),i([s()],e.prototype,"view",void 0),e=i([r("esri.views.layers.ImageryLayerView")],e),e};let _=class extends(H(U(v(x)))){constructor(){super(...arguments),this._exportImageVersion=-1}initialize(){this.handles.add([g(this,["layer.blendMode","layer.effects"],(t=>{this.subview&&(this.subview.container.blendMode=t)}),!0),g(this,"layer.effect",(t=>{this.subview&&(this.subview.container.effect=t)}),!0)])}get pixelData(){return this.updating?null:this.subview.getPixelData()}get updating(){return!(this.subview&&!this.subview.updating)}hitTest(t,i){return this.suspended||!this.subview?Promise.resolve(null):this.subview.hitTest(t,i)}update(t){var i;null==(i=this.subview)||i.update(t)}attach(){this.layer.increaseRasterJobHandlerUsage(),this._setSubView(),this.handles.add([g(this,"layer.exportImageServiceParameters.version",(t=>{this._exportImageVersion!==t&&(this._exportImageVersion=t,this.requestUpdate())})),this.watch("timeExtent",(()=>{this.subview.timeExtent=this.timeExtent,this.requestUpdate()})),this.layer.on("redraw",(()=>this.subview.redraw())),j(this.layer,"renderer",(()=>this._setSubView()))],"imagerylayerview-update")}detach(){this.layer.decreaseRasterJobHandlerUsage(),this.subview.destroy(),this.handles.remove("imagerylayerview-update"),this._exportImageVersion=-1}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}async doRefresh(){this.requestUpdate()}isUpdating(){return!this.subview||!this.suspended&&this.subview.isUpdating()}_setSubView(){var t;let i="Imagery";var s,e;"vector-field"===(null==(t=this.layer.renderer)?void 0:t.type)&&"lerc"===this.layer.format&&(i="Graphics"),this.subview&&this.subview.type===i||(null==(s=this.subview)||s.uninstall(this.container),null==(e=this.subview)||e.destroy(),this.subview="Imagery"===i?new F({layer:this.layer,view:this.view,timeExtent:this.timeExtent}):new G({layer:this.layer,view:this.view,timeExtent:this.timeExtent}),this.subview.attach(),this.subview.install(this.container),this.subview.container.blendMode=this.layer.blendMode,this.subview.container.effect=this.layer.effect),this.requestUpdate()}};i([s()],_.prototype,"pixelData",null),i([s({readOnly:!0})],_.prototype,"updating",null),i([s()],_.prototype,"subview",void 0),_=i([r("esri.views.2d.layers.ImageryLayerView2D")],_);const z=_;export default z;