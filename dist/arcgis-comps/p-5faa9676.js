import{e,d as t,i as n,p as r,a0 as i,_ as a,ah as s,a1 as o,N as l,Q as u,ap as c,ax as p,A as f,a$ as d,ab as y,ad as m,av as b,az as h,s as g}from"./p-e58503d5.js";import{e as v,c as P,u as w}from"./p-fb38a9d0.js";import{v as G}from"./p-b79fcce3.js";import{getSize as S,getColor as M,getOpacity as j,getRotationAngle as L,getSizeRangeAtScale as x}from"./p-9f1c2d50.js";import{v as D}from"./p-c1cd5521.js";import{y as F}from"./p-a131049b.js";import{n as V,e as T}from"./p-7ca40eac.js";import R from"./p-dc852195.js";import{a as I}from"./p-e258f3af.js";import{o as A}from"./p-03d6250d.js";let k=class extends r{constructor(e){super(e),this.attributionVisible=!0,this.exportOptions={width:800,height:1100,dpi:96},this.forceFeatureAttributes=!1,this.format="png32",this.label=null,this.layout="map-only",this.layoutOptions=null,this.outScale=0,this.scalePreserved=!0,this.showLabels=!0}};e([t()],k.prototype,"attributionVisible",void 0),e([t()],k.prototype,"exportOptions",void 0),e([t()],k.prototype,"forceFeatureAttributes",void 0),e([t()],k.prototype,"format",void 0),e([t()],k.prototype,"label",void 0),e([t()],k.prototype,"layout",void 0),e([t()],k.prototype,"layoutOptions",void 0),e([t()],k.prototype,"outScale",void 0),e([t()],k.prototype,"scalePreserved",void 0),e([t()],k.prototype,"showLabels",void 0),k=e([n("esri.rest.support.PrintTemplate")],k);const $=k;let J=class extends r{constructor(){super(...arguments),this.outSpatialReference=null,this.processExtent=null,this.processSpatialReference=null,this.returnFeatureCollection=!1,this.returnM=!1,this.returnZ=!1}};e([t({type:i})],J.prototype,"outSpatialReference",void 0),e([t({type:a})],J.prototype,"processExtent",void 0),e([t({type:i})],J.prototype,"processSpatialReference",void 0),e([t({nonNullable:!0})],J.prototype,"returnFeatureCollection",void 0),e([t({nonNullable:!0})],J.prototype,"returnM",void 0),e([t({nonNullable:!0})],J.prototype,"returnZ",void 0),J=e([n("esri/rest/geoprocessor/GPOptions")],J),J.from=s(J);const N=J;let O=class extends o{constructor(){super(...arguments),this.extent=null,this.height=null,this.href=null,this.opacity=1,this.rotation=0,this.scale=null,this.visible=!0,this.width=null}};e([t({type:a})],O.prototype,"extent",void 0),e([t()],O.prototype,"height",void 0),e([t()],O.prototype,"href",void 0),e([t()],O.prototype,"opacity",void 0),e([t()],O.prototype,"rotation",void 0),e([t()],O.prototype,"scale",void 0),e([t()],O.prototype,"visible",void 0),e([t()],O.prototype,"width",void 0),O=e([n("esri.layer.support.MapImage")],O);const C=O;let E=class extends o{constructor(e){super(e),this.itemId=null,this.url=null}};e([t({type:String,json:{read:{source:"itemID"},write:{target:"itemID"}}})],E.prototype,"itemId",void 0),e([t({type:String,json:{write:!0}})],E.prototype,"url",void 0),E=e([n("esri.rest.support.DataFile")],E);const U=E,B=new l({esriMeters:"meters",esriFeet:"feet",esriKilometers:"kilometers",esriMiles:"miles",esriNauticalMiles:"nautical-miles",esriYards:"yards"},{ignoreUnknown:!1});let _=class extends o{constructor(e){super(e),this.distance=0,this.units=null}};e([t({json:{write:!0}})],_.prototype,"distance",void 0),e([t({json:{read:B.read,write:B.write}})],_.prototype,"units",void 0),_=e([n("esri/rest/support/LinearUnit")],_);const q=_,K=new l({GPBoolean:"boolean",GPDataFile:"data-file",GPDate:"date",GPDouble:"double",GPFeatureRecordSetLayer:"feature-record-set-layer",GPField:"field",GPLinearUnit:"linear-unit",GPLong:"long",GPRasterData:"raster-data",GPRasterDataLayer:"raster-data-layer",GPRecordSet:"record-set",GPString:"string","GPMultiValue:GPBoolean":"multi-value","GPMultiValue:GPDataFile":"multi-value","GPMultiValue:GPDate":"multi-value","GPMultiValue:GPDouble":"multi-value","GPMultiValue:GPFeatureRecordSetLayer":"multi-value","GPMultiValue:GPField":"multi-value","GPMultiValue:GPLinearUnit":"multi-value","GPMultiValue:GPLong":"multi-value","GPMultiValue:GPRasterData":"multi-value","GPMultiValue:GPRasterDataLayer":"multi-value","GPMultiValue:GPRecordSet":"multi-value","GPMultiValue:GPString":"multi-value"});let z=class extends o{constructor(e){super(e),this.dataType=null,this.value=null}};e([t({json:{read:K.read,write:K.write}})],z.prototype,"dataType",void 0),e([t()],z.prototype,"value",void 0),z=e([n("esri.rest.support.ParameterValue")],z);const Z=z;let W=class extends o{constructor(e){super(e),this.format=null,this.itemId=null,this.url=null}};e([t()],W.prototype,"format",void 0),e([t({json:{read:{source:"itemID"},write:{target:"itemID"}}})],W.prototype,"itemId",void 0),e([t()],W.prototype,"url",void 0),W=e([n("esri/rest/support/RasterData")],W);const Y=W;async function H(e,t,n,r,i){const a={},s={},o=[];return function(e,t,n){for(const r in e){const i=e[r];if(i&&"object"==typeof i&&i instanceof R){const{features:e}=i;n[r]=[t.length,t.length+e.length],e.forEach((e=>{t.push(e.geometry)}))}}}(r,o,a),D(o).then((o=>{const{outSpatialReference:l,processExtent:c,processSpatialReference:p,returnFeatureCollection:f,returnM:d,returnZ:y}=n,{path:m}=T(e);for(const e in a){const t=a[e];s[e]=o.slice(t[0],t[1])}const b=l?l.wkid||l:null,h=p?p.wkid||p:null,g="execute"===t?{returnFeatureCollection:f||void 0,returnM:d||void 0,returnZ:y||void 0}:null,v=X({...c?{context:{extent:c,outSR:b,processSR:h}}:{"env:outSR":b,"env:processSR":h},...r,...g,f:"json"},null,s),P={...i,query:v};return u(`${m}/${t}`,P)}))}function Q(e){const t=e.dataType,n=Z.fromJSON(e);switch(t){case"GPBoolean":case"GPDouble":case"GPLong":case"GPString":case"GPMultiValue:GPBoolean":case"GPMultiValue:GPDouble":case"GPMultiValue:GPLong":case"GPMultiValue:GPString":return n;case"GPDate":n.value=new Date(n.value);break;case"GPDataFile":n.value=U.fromJSON(n.value);break;case"GPLinearUnit":n.value=q.fromJSON(n.value);break;case"GPFeatureRecordSetLayer":case"GPRecordSet":n.value=e.value.url?U.fromJSON(n.value):R.fromJSON(n.value);break;case"GPRasterData":case"GPRasterDataLayer":{const t=e.value.mapImage;n.value=t?C.fromJSON(t):Y.fromJSON(n.value);break}case"GPField":n.value=F.fromJSON(n.value);break;case"GPMultiValue:GPDate":n.value=n.value.map((e=>new Date(e)));break;case"GPMultiValue:GPDataFile":n.value=n.value.map((e=>U.fromJSON(e)));break;case"GPMultiValue:GPLinearUnit":n.value=n.value.map((e=>q.fromJSON(e)));break;case"GPMultiValue:GPFeatureRecordSetLayer":case"GPMultiValue:GPRecordSet":n.value=n.value.map((e=>R.fromJSON(e)));break;case"GPMultiValue:GPRasterData":case"GPMultiValue:GPRasterDataLayer":n.value=n.value.map((e=>e?C.fromJSON(e):Y.fromJSON(n.value)));break;case"GPMultiValue:GPField":n.value=n.value.map((e=>F.fromJSON(e)))}return n}function X(e,t,n){for(const t in e){const n=e[t];Array.isArray(n)?e[t]=JSON.stringify(n.map((e=>X({item:e},!0).item))):n instanceof Date&&(e[t]=n.getTime())}return V(e,t,n)}var ee;const te=new l({esriJobCancelled:"job-cancelled",esriJobCancelling:"job-cancelling",esriJobDeleted:"job-deleted",esriJobDeleting:"job-deleting",esriJobTimedOut:"job-timed-out",esriJobExecuting:"job-executing",esriJobFailed:"job-failed",esriJobNew:"job-new",esriJobSubmitted:"job-submitted",esriJobSucceeded:"job-succeeded",esriJobWaiting:"job-waiting"});let ne=ee=class extends o{constructor(e){super(e),this.jobId=null,this.jobStatus=null,this.messages=null,this.requestOptions=null,this.sourceUrl=null,this._timer=null}cancelJob(e){const{jobId:t,sourceUrl:n}=this,{path:r}=T(n),i={...this.requestOptions,...e,query:{f:"json"}};return this._clearTimer(),u(`${r}/jobs/${t}/cancel`,i).then((e=>{const t=ee.fromJSON(e.data);return this.messages=t.messages,this.jobStatus=t.jobStatus,this}))}destroy(){clearInterval(this._timer)}checkJobStatus(e){const{path:t}=T(this.sourceUrl),n={...this.requestOptions,...e,query:{f:"json"}};return u(`${t}/jobs/${this.jobId}`,n).then((({data:e})=>{const t=ee.fromJSON(e);return this.messages=t.messages,this.jobStatus=t.jobStatus,this}))}fetchResultData(e,t,n){t=N.from(t||{});const{returnFeatureCollection:r,returnM:i,returnZ:a,outSpatialReference:s}=t,{path:o}=T(this.sourceUrl),l=X({returnFeatureCollection:r,returnM:i,returnZ:a,outSR:s,returnType:"data",f:"json"},null),c={...this.requestOptions,...n,query:l};return u(`${o}/jobs/${this.jobId}/results/${e}`,c).then((e=>Q(e.data)))}fetchResultImage(e,t,n){const{path:r}=T(this.sourceUrl),i=X({...t.toJSON(),f:"json"}),a={...this.requestOptions,...n,query:i};return u(`${r}/jobs/${this.jobId}/results/${e}`,a).then((e=>Q(e.data)))}async fetchResultMapImageLayer(){const{path:e}=T(this.sourceUrl),t=e.indexOf("/GPServer/"),n=`${e.substring(0,t)}/MapServer/jobs/${this.jobId}`;return new((await import("./p-e7edfe56.js")).default)({url:n})}async waitForJobCompletion(e={}){const{interval:t=1e3,signal:n,statusCallback:r}=e;return new Promise(((e,i)=>{c(n,(()=>{this._clearTimer(),i(p())})),this._clearTimer();const a=setInterval((()=>{this._timer||i(p()),this.checkJobStatus(this.requestOptions).then((t=>{const{jobStatus:n}=t;switch(this.jobStatus=n,n){case"job-succeeded":this._clearTimer(),e(this);break;case"job-submitted":case"job-executing":case"job-waiting":case"job-new":r&&r(this);break;case"job-cancelled":case"job-cancelling":case"job-deleted":case"job-deleting":case"job-timed-out":case"job-failed":this._clearTimer(),i(this)}}))}),t);this._timer=a}))}_clearTimer(){this._timer&&(clearInterval(this._timer),this._timer=null)}};e([t()],ne.prototype,"jobId",void 0),e([t({json:{read:te.read}})],ne.prototype,"jobStatus",void 0),e([t({type:[I]})],ne.prototype,"messages",void 0),e([t()],ne.prototype,"requestOptions",void 0),e([t({json:{write:!0}})],ne.prototype,"sourceUrl",void 0),ne=ee=e([n("esri.rest.support.JobInfo")],ne);const re=ne,ie=new l({PDF:"pdf",PNG32:"png32",PNG8:"png8",JPG:"jpg",GIF:"gif",EPS:"eps",SVG:"svg",SVGZ:"svgz"}),ae=ie.fromJSON.bind(ie),se=ie.toJSON.bind(ie),oe=new l({MAP_ONLY:"map-only","A3 Landscape":"a3-landscape","A3 Portrait":"a3-portrait","A4 Landscape":"a4-landscape","A4 Portrait":"a4-portrait","Letter ANSI A Landscape":"letter-ansi-a-landscape","Letter ANSI A Portrait":"letter-ansi-a-portrait","Tabloid ANSI B Landscape":"tabloid-ansi-b-landscape","Tabloid ANSI B Portrait":"tabloid-ansi-b-portrait"}),le=oe.fromJSON.bind(oe),ue=oe.toJSON.bind(oe),ce="simple-marker",pe="simple-line";function fe(e,t){const{graphic:n,renderer:r,symbol:i}=t,a=i.type;if("text"===a||"shield-label-symbol"===a||!("visualVariables"in r)||!r.visualVariables)return;const s=r.getVisualVariablesForType("size"),o=r.getVisualVariablesForType("color"),l=r.getVisualVariablesForType("opacity"),u=r.getVisualVariablesForType("rotation"),c=s[0],p=o[0],f=l[0],d=u[0];if(c){const t=S(c,n,{shape:a===ce?i.style:null});null!=t&&(a===ce?e.size=v(t):"picture-marker"===a?(e.width=v(t),e.height=v(t)):a===pe?e.width=v(t):e.outline&&(e.outline.width=v(t)))}if(p){const t=M(p,n);(t&&a===ce||a===pe||"simple-fill"===a)&&(e.color=t?t.toJSON():void 0)}if(f){const t=j(f,n);null!=t&&e.color&&(e.color[3]=Math.round(255*t))}d&&(e.angle=-L(r,n))}function de(e){return e&&"bing-maps"===e.type}function ye(e){return e&&"csv"===e.type}function me(e){return e&&"feature"===e.type}function be(e){return e&&"geojson"===e.type}function he(e){return e&&"graphics"===e.type}function ge(e){return e&&"group"===e.type}function ve(e){return e&&"esri.views.2d.layers.GroupLayerView2D"===e.declaredClass}function Pe(e){return e&&"imagery"===e.type}function we(e){return e&&"imagery-tile"===e.type}function Ge(e){return e&&"kml"===e.type}function Se(e){return e&&"map-image"===e.type}function Me(e){return e&&"map-notes"===e.type}function je(e){return e&&"open-street-map"===e.type}function Le(e){return e&&"stream"===e.type}function xe(e){return e&&"tile"===e.type}function De(e){return e&&"vector-tile"===e.type}function Fe(e){return e&&"web-tile"===e.type}function Ve(e){return e&&"wms"===e.type}function Te(e){return e&&"wmts"===e.type}const Re={Feet:"ft",Kilometers:"km",Meters:"m",Miles:"mi"},Ie=new l({esriFeet:"Feet",esriKilometers:"Kilometers",esriMeters:"Meters",esriMiles:"Miles"}),Ae=new l({esriExecutionTypeSynchronous:"sync",esriExecutionTypeAsynchronous:"async"}),ke=new Map;async function $e(e,t,n){const r=Ne(e);let i=ke.get(r);return Promise.resolve().then((()=>i?{data:i.gpMetadata}:(i={gpServerUrl:r,is11xService:!1,legendLayerNameMap:{},legendLayers:[]},u(r,{query:{f:"json"}})))).then((e=>(i.gpMetadata=e.data,i.cimVersion=i.gpMetadata.cimVersion,i.is11xService=!!i.cimVersion,ke.set(r,i),Je(t,i)))).then((r=>{const a=function(e){return e.gpMetadata&&e.gpMetadata.executionType?Ae.fromJSON(e.gpMetadata.executionType):"sync"}(i);let s;const o=e=>"sync"===a?e.results&&e.results[0]&&e.results[0].value:s.fetchResultData("Output_File",null,n).then((e=>e.value));return"async"===a?async function(e,t,n,r){return n=N.from(n||{}),H(e,"submitJob",n,t,r).then((t=>{const n=re.fromJSON(t.data);return n.sourceUrl=e,n}))}(e,r,null,n).then((e=>(s=e,e.waitForJobCompletion({interval:t.updateDelay}).then(o)))):async function(e,t,n,r){return H(e,"execute",n=N.from(n||{}),t,r).then((e=>{const t=e.data.messages||[];return{results:(e.data.results||[]).map(Q),messages:t.map((e=>I.fromJSON(e)))}}))}(e,r,null,n).then(o)}))}async function Je(e,t){t=t||{is11xService:!1,legendLayerNameMap:{},legendLayers:[]};const n=e.template||new $;null==n.showLabels&&(n.showLabels=!0);const r=n.exportOptions;let i;const a=ue(n.layout);r&&(i={dpi:r.dpi},"map_only"===a.toLowerCase()||""===a)&&(i.outputSize=[r.width,r.height]);const s=n.layoutOptions;let o;if(s){let e,t;"Miles"===s.scalebarUnit||"Kilometers"===s.scalebarUnit?(e="Kilometers",t="Miles"):"Meters"!==s.scalebarUnit&&"Feet"!==s.scalebarUnit||(e="Meters",t="Feet"),o={titleText:s.titleText,authorText:s.authorText,copyrightText:s.copyrightText,customTextElements:s.customTextElements,scaleBarOptions:{metricUnit:Ie.toJSON(e),metricLabel:Re[e],nonMetricUnit:Ie.toJSON(t),nonMetricLabel:Re[t]}}}let l=null;null!=s&&s.legendLayers&&(l=s.legendLayers.map((e=>{t.legendLayerNameMap[e.layerId]=e.title;const n={id:e.layerId};return e.subLayerIds&&(n.subLayerIds=e.subLayerIds),n})));const u=await async function(e,t,n){const r=e.view;let i=r.spatialReference;const a={operationalLayers:await Oe(r,t,n)};let s=n.ssExtent||e.extent||r.extent;if(i&&i.isWrappable&&(s=s.clone()._normalize(!0),i=s.spatialReference),a.mapOptions={extent:s&&s.toJSON(),spatialReference:i&&i.toJSON(),showAttribution:t.attributionVisible},n.ssExtent=null,r.background&&(a.background=r.background.toJSON()),r.rotation&&(a.mapOptions.rotation=-r.rotation),t.scalePreserved&&(a.mapOptions.scale=t.outScale||r.scale),r.timeExtent){const e=f(r.timeExtent.start)?r.timeExtent.start.getTime():null,t=f(r.timeExtent.end)?r.timeExtent.end.getTime():null;a.mapOptions.time=[e,t]}return a}(e,n,t);if(u.operationalLayers){const e=new RegExp("[\\u4E00-\\u9FFF\\u0E00-\\u0E7F\\u0900-\\u097F\\u3040-\\u309F\\u30A0-\\u30FF\\u31F0-\\u31FF]"),n=/[\u0600-\u06FF]/,r=t=>{const r=t.text,i=t.font,a=i&&i.family&&i.family.toLowerCase();r&&i&&("arial"===a||"arial unicode ms"===a)&&(i.family=e.test(r)?"Arial Unicode MS":"Arial","normal"!==i.style&&n.test(r)&&(i.family="Arial Unicode MS"))},i=()=>{throw new g("print-task:cim-symbol-unsupported","CIMSymbol is not supported by a print service published from ArcMap")};u.operationalLayers.forEach((e=>{var n,a,s;null!=(n=e.featureCollection)&&n.layers?e.featureCollection.layers.forEach((e=>{var n,a,s,o;if(null!=(n=e.layerDefinition)&&null!=(a=n.drawingInfo)&&null!=(s=a.renderer)&&s.symbol){const n=e.layerDefinition.drawingInfo.renderer;"esriTS"===n.symbol.type?r(n.symbol):"CIMSymbolReference"!==n.symbol.type||t.is11xService||i()}null!=(o=e.featureSet)&&o.features&&e.featureSet.features.forEach((e=>{e.symbol&&("esriTS"===e.symbol.type?r(e.symbol):"CIMSymbolReference"!==e.symbol.type||t.is11xService||i())}))})):!t.is11xService&&null!=(a=e.layerDefinition)&&null!=(s=a.drawingInfo)&&s.renderer&&JSON.stringify(e.layerDefinition.drawingInfo.renderer).includes('"type":"CIMSymbolReference"')&&i()}))}e.outSpatialReference&&(u.mapOptions.spatialReference=e.outSpatialReference.toJSON()),Object.assign(u,{exportOptions:i,layoutOptions:o||{}}),Object.assign(u.layoutOptions,{legendOptions:{operationalLayers:null!=l?l:t.legendLayers.slice()}}),t.legendLayers.length=0,ke.set(t.gpServerUrl,t);const c={Web_Map_as_JSON:JSON.stringify(u),Format:se(n.format),Layout_Template:a};return e.extraParameters&&Object.assign(c,e.extraParameters),c}function Ne(e){let t=e;const n=t.lastIndexOf("/GPServer/");return n>0&&(t=t.slice(0,n+9)),t}async function Oe(e,t,n){const r=[],i={layerView:null,printTemplate:t,view:e};let a=0;t.scalePreserved&&(a=t.outScale||e.scale);const s=function(e,t){const n=e.allLayerViews.items;if(t===e.scale)return n.filter((e=>!e.suspended));const r=new Array;for(const e of n)ve(e.parent)&&!r.includes(e.parent)||!e.visible||t&&"isVisibleAtScale"in e&&!e.isVisibleAtScale(t)||r.push(e);return r}(e,a);for(const e of s){const t=e.layer;if(!t.loaded||ge(t))continue;let a;i.layerView=e,a=de(t)?Ce(t):ye(t)?await Ee(t,i,n):me(t)?await Be(t,i,n):be(t)?await _e(t,i,n):he(t)?await qe(t,i,n):Pe(t)?Ke(t,n):we(t)?ze(t,n):Ge(t)?await Ze(t,i,n):Se(t)?We(t,i,n):Me(t)?await Ye(i,n):je(t)?{type:"OpenStreetMap"}:Le(t)?await Qe(t,i,n):xe(t)?Xe(t):De(t)?await et(t,i,n):Fe(t)?tt(t):Ve(t)?nt(t):Te(t)?rt(t):await He(t,i,n),a&&(Array.isArray(a)?r.push(...a):(a.id=t.id,a.title=n.legendLayerNameMap[t.id]||t.title,a.opacity=t.opacity,a.minScale=t.minScale||0,a.maxScale=t.maxScale||0,r.push(a)))}if(a&&r.forEach((e=>{e.minScale=0,e.maxScale=0})),e.graphics&&e.graphics.length){const i=await Ue(null,e.graphics,t,n);i&&r.push(i)}return r}function Ce(e){return{culture:e.culture,key:e.key,type:"BingMaps"+("aerial"===e.style?"Aerial":"hybrid"===e.style?"Hybrid":"Road")}}async function Ee(e,t,n){e.legendEnabled&&n.legendLayers.push({id:e.id});const r=t.layerView,i=t.printTemplate;let a;return!n.is11xService||r.filter?Ue(e,await ot(r),i,n):(a={type:"CSV"},e.write(a,{origin:"web-map"}),delete a.popupInfo,delete a.layerType,a.showLabels=i.showLabels&&e.labelsVisible,a)}async function Ue(e,t,n,r){let i;const a={layerDefinition:{name:"polygonLayer",geometryType:"esriGeometryPolygon",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryPolygon",features:[]}},s={layerDefinition:{name:"polylineLayer",geometryType:"esriGeometryPolyline",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryPolyline",features:[]}},o={layerDefinition:{name:"pointLayer",geometryType:"esriGeometryPoint",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryPoint",features:[]}},l={layerDefinition:{name:"multipointLayer",geometryType:"esriGeometryMultipoint",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryMultipoint",features:[]}},u={layerDefinition:{name:"pointLayer",geometryType:"esriGeometryPoint",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryPoint",features:[]}};if(u.layerDefinition.name="textLayer",delete u.layerDefinition.drawingInfo,e){if("esri.layers.FeatureLayer"===e.declaredClass||"esri.layers.StreamLayer"===e.declaredClass?a.layerDefinition.name=s.layerDefinition.name=o.layerDefinition.name=l.layerDefinition.name=r.legendLayerNameMap[e.id]||e.get("arcgisProps.title")||e.title:"esri.layers.GraphicsLayer"===e.declaredClass&&(t=e.graphics.items),e.renderer){const t=e.renderer.toJSON();a.layerDefinition.drawingInfo.renderer=t,s.layerDefinition.drawingInfo.renderer=t,o.layerDefinition.drawingInfo.renderer=t,l.layerDefinition.drawingInfo.renderer=t}if(n.showLabels&&e.labelsVisible&&"function"==typeof e.write){var c,p;const t=null==(c=e.write({},{origin:"web-map"}).layerDefinition)||null==(p=c.drawingInfo)?void 0:p.labelingInfo;t&&(i=!0,a.layerDefinition.drawingInfo.labelingInfo=t,s.layerDefinition.drawingInfo.labelingInfo=t,o.layerDefinition.drawingInfo.labelingInfo=t,l.layerDefinition.drawingInfo.labelingInfo=t)}}let f;null!=e&&e.renderer||i||(delete a.layerDefinition.drawingInfo,delete s.layerDefinition.drawingInfo,delete o.layerDefinition.drawingInfo,delete l.layerDefinition.drawingInfo);const d=null==e?void 0:e.fieldsIndex,y=null==e?void 0:e.renderer;if(d){if(y&&"function"==typeof y.collectRequiredFields){const e=new Set;await y.collectRequiredFields(e,d),f=Array.from(e)}const e=d.fields.map((e=>e.toJSON()));a.layerDefinition.fields=e,s.layerDefinition.fields=e,o.layerDefinition.fields=e,l.layerDefinition.fields=e}const m=t&&t.length;let b;for(let i=0;i<m;i++){const c=t[i]||t.getItemAt(i);if(!1===c.visible||!c.geometry)continue;if(b=c.toJSON(),b.hasOwnProperty("popupTemplate")&&delete b.popupTemplate,b.geometry&&b.geometry.z&&delete b.geometry.z,b.symbol&&b.symbol.outline&&"esriCLS"===b.symbol.outline.type&&!r.is11xService)continue;!r.is11xService&&b.symbol&&b.symbol.outline&&b.symbol.outline.color&&b.symbol.outline.color[3]&&(b.symbol.outline.color[3]=255);const p=e&&e.renderer&&("valueExpression"in e.renderer&&e.renderer.valueExpression||"hasVisualVariables"in e.renderer&&e.renderer.hasVisualVariables());if(!b.symbol&&e&&e.renderer&&p&&!r.is11xService){const t=e.renderer,n=await t.getSymbolAsync(c);if(!n)continue;b.symbol=n.toJSON(),"hasVisualVariables"in t&&t.hasVisualVariables()&&fe(b.symbol,{renderer:t,graphic:c,symbol:n})}if(b.symbol&&(b.symbol.angle||delete b.symbol.angle,lt(b.symbol)?b.symbol=await at(b.symbol,r):b.symbol.text&&delete b.attributes),(!n||!n.forceFeatureAttributes)&&f&&f.length){const e={};f.forEach((t=>{b.attributes&&b.attributes.hasOwnProperty(t)&&(e[t]=b.attributes[t])})),b.attributes=e}"polygon"===c.geometry.type?a.featureSet.features.push(b):"polyline"===c.geometry.type?s.featureSet.features.push(b):"point"===c.geometry.type?b.symbol&&b.symbol.text?u.featureSet.features.push(b):o.featureSet.features.push(b):"multipoint"===c.geometry.type?l.featureSet.features.push(b):"extent"===c.geometry.type&&(b.geometry=G.fromExtent(c.geometry).toJSON(),a.featureSet.features.push(b))}const h=[a,s,l,o,u].filter((e=>e.featureSet.features.length>0));for(const e of h){const t=e.featureSet.features.every((e=>e.symbol));!t||n&&n.forceFeatureAttributes||e.featureSet.features.forEach((e=>{delete e.attributes})),t&&delete e.layerDefinition.drawingInfo,e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer&&await st(e.layerDefinition.drawingInfo.renderer,r)}return h.length?{featureCollection:{layers:h},showLabels:i}:null}async function Be(e,t,n){var r,i;let a;e.legendEnabled&&n.legendLayers.push({id:e.id});const s=e.renderer,o=parseFloat(n.cimVersion);if(e.featureReduction&&(!n.is11xService||o<2.9)||"dot-density"===(null==s?void 0:s.type)&&(!n.is11xService||o<2.6))return He(e,t,n);const l=t.layerView,{printTemplate:u,view:c}=t,p=s&&("valueExpression"in s&&s.valueExpression||"hasVisualVariables"in s&&s.hasVisualVariables()),f="feature-layer"!==(null==(r=e.source)?void 0:r.type)&&"ogc-feature"!==(null==(i=e.source)?void 0:i.type);if(!n.is11xService&&p||l.filter||f||!s||"field"in s&&null!=s.field&&("string"!=typeof s.field||!e.getField(s.field))){const t=await ot(l);a=await Ue(e,t,u,n)}else{var d,y;if(a={id:(m=e.write()).id,title:m.title,opacity:m.opacity,minScale:m.minScale,maxScale:m.maxScale,url:m.url,layerType:m.layerType,customParameters:m.customParameters,layerDefinition:m.layerDefinition},a.showLabels=u.showLabels&&e.labelsVisible,it(a,e),null!=(d=a.layerDefinition)&&null!=(y=d.drawingInfo)&&y.renderer&&(delete a.layerDefinition.minScale,delete a.layerDefinition.maxScale,await st(a.layerDefinition.drawingInfo.renderer,n),"visualVariables"in s&&s.visualVariables&&s.visualVariables[0])){const e=s.visualVariables[0];if("size"===e.type&&e.maxSize&&"number"!=typeof e.maxSize&&e.minSize&&"number"!=typeof e.minSize){const t=x(e,c.scale);a.layerDefinition.drawingInfo.renderer.visualVariables[0].minSize=t.minSize,a.layerDefinition.drawingInfo.renderer.visualVariables[0].maxSize=t.maxSize}}const t=A(l);t&&(a.layerDefinition||(a.layerDefinition={}),a.layerDefinition.definitionExpression=a.layerDefinition.definitionExpression?`(${a.layerDefinition.definitionExpression}) AND (${t})`:t)}var m;return a}async function _e(e,{layerView:t,printTemplate:n},r){return e.legendEnabled&&r.legendLayers.push({id:e.id}),Ue(e,await ot(t),n,r)}async function qe(e,{printTemplate:t},n){return Ue(e,null,t,n)}function Ke(e,t){e.legendEnabled&&t.legendLayers.push({id:e.id});const n={layerType:(r=e.write()).layerType,customParameters:r.customParameters};var r;if(n.bandIds=e.bandIds,n.compressionQuality=e.compressionQuality,n.format=e.format,n.interpolation=e.interpolation,(e.mosaicRule||e.definitionExpression)&&(n.mosaicRule=e.exportImageServiceParameters.mosaicRule.toJSON()),e.renderingRule||e.renderer)if(t.is11xService)e.renderingRule&&(n.renderingRule=e.renderingRule.toJSON()),e.renderer&&(n.layerDefinition=n.layerDefinition||{},n.layerDefinition.drawingInfo=n.layerDefinition.drawingInfo||{},n.layerDefinition.drawingInfo.renderer=e.renderer.toJSON());else{const t=e.exportImageServiceParameters.combineRendererWithRenderingRule();t&&(n.renderingRule=t.toJSON())}return it(n,e),n}function ze(e,t){e.legendEnabled&&t.legendLayers.push({id:e.id});const n={bandIds:(r=e.write()||{}).bandIds,customParameters:r.customParameters,interpolation:r.interpolation,layerDefinition:r.layerDefinition};var r;return n.layerType="ArcGISImageServiceLayer",it(n,e),n}async function Ze(e,t,n){const r=t.printTemplate;if(n.is11xService){const t={type:"kml"};return e.write(t,{origin:"web-map"}),delete t.layerType,t.url=d(e.url),t}{const i=[],a=t.layerView;a.allVisibleMapImages.forEach(((t,n)=>{const r={id:`${e.id}_image${n}`,type:"image",title:e.id,minScale:e.minScale||0,maxScale:e.maxScale||0,opacity:e.opacity,extent:t.extent};"data:image/png;base64,"===t.href.substr(0,22)?r.imageData=t.href.substr(22):r.url=t.href,i.push(r)}));const s=[...a.allVisiblePoints.items,...a.allVisiblePolylines.items,...a.allVisiblePolygons.items],o={id:e.id,...await Ue(null,s,r,n)};return i.push(o),i}}function We(e,{view:t},n){let r;const i={id:e.id,subLayerIds:[]};let a=[];const s=t.scale,o=e=>{if(e.visible&&(0===s||(0===e.minScale||s<=e.minScale)&&(0===e.maxScale||s>=e.maxScale)))if(e.sublayers)e.sublayers.forEach(o);else{const t=e.toExportImageJSON();a.unshift({id:e.id,name:e.title,layerDefinition:{drawingInfo:t.drawingInfo,definitionExpression:t.definitionExpression,source:t.source}}),i.subLayerIds.push(e.id)}};var l;return e.sublayers&&e.sublayers.forEach(o),a.length&&(a=a.map((({id:e,name:t,layerDefinition:n})=>({id:e,name:t,layerDefinition:n}))),r={layerType:(l=e.write()).layerType,customParameters:l.customParameters},r.layers=a,r.visibleLayers=e.capabilities.exportMap.supportsDynamicLayers?void 0:i.subLayerIds,it(r,e),e.legendEnabled&&n.legendLayers.push(i)),r}async function Ye({layerView:e,printTemplate:t},n){const r=[],i=e.layer;if(f(i.featureCollections))for(const e of i.featureCollections){const i=await Ue(e,e.source,t,n);i&&r.push(...i.featureCollection.layers)}else if(f(i.sublayers))for(const e of i.sublayers){const i=await Ue(null,e.graphics,t,n);i&&r.push(...i.featureCollection.layers)}return{featureCollection:{layers:r}}}async function He(e,{printTemplate:t,view:n},r){const i={type:"image"},a={format:"png",ignoreBackground:!0,layers:[e],rotation:0},s=r.ssExtent||n.extent.clone();let o=96,l=!0,u=!0;if(t.exportOptions){const e=t.exportOptions;e.dpi>0&&(o=e.dpi),e.width>0&&(l=e.width%2==n.width%2),e.height>0&&(u=e.height%2==n.height%2)}if("map-only"===t.layout&&t.scalePreserved&&(!t.outScale||t.outScale===n.scale)&&96===o&&(!l||!u)&&(a.area={x:0,y:0,width:n.width,height:n.height},l||(a.area.width-=1),u||(a.area.height-=1),!r.ssExtent)){const e=n.toMap(P(a.area.width,a.area.height));s.ymin=e.y,s.xmax=e.x,r.ssExtent=s}i.extent=s.clone()._normalize(!0).toJSON();const c=await n.takeScreenshot(a),{data:p}=y(c.dataUrl);return i.imageData=p,i}async function Qe(e,{layerView:t,printTemplate:n},r){return e.legendEnabled&&r.legendLayers.push({id:e.id}),Ue(e,await ot(t),n,r)}function Xe(e){const t={layerType:(n=e.write()).layerType,customParameters:n.customParameters};var n;return it(t,e),t}async function et(e,t,n){if(n.is11xService&&e.serviceUrl&&e.styleUrl){const t=h&&h.findCredential(e.styleUrl),r=h&&h.findCredential(e.serviceUrl);if(!t&&!r||"2.1.0"!==n.cimVersion){const n={type:"VectorTileLayer"};return n.styleUrl=d(e.styleUrl),t&&(n.token=t.token),r&&r.token!==n.token&&(n.additionalTokens=[{url:e.serviceUrl,token:r.token}]),n}}return He(e,t,n)}function tt(e){const t={type:"WebTiledLayer",urlTemplate:e.urlTemplate.replace(/\${/g,"{"),credits:e.copyright};return e.subDomains&&e.subDomains.length>0&&(t.subDomains=e.subDomains),t}function nt(e){let t;const n=[],r=e=>{e.visible&&(e.sublayers?e.sublayers.forEach(r):e.name&&n.unshift(e.name))};return e.sublayers&&e.sublayers.forEach(r),n.length&&(t={type:"wms",customLayerParameters:e.customLayerParameters,customParameters:e.customParameters,transparentBackground:e.imageTransparency,visibleLayers:n,url:d(e.url),version:e.version}),t}function rt(e){const t=e.activeLayer;return{type:"wmts",customLayerParameters:e.customLayerParameters,customParameters:e.customParameters,format:t.imageFormat,layer:t.id,style:t.styleId,tileMatrixSet:t.tileMatrixSetId,url:d(e.url)}}function it(e,t){if(t.url)if(e.url=d(e.url||t.url),"apiKey"in t&&t.apiKey)e.token=t.apiKey;else if(m.apiKey&&b(t.url))e.token=m.apiKey;else{var n,r;e.token=null==(n=h)||null==(r=n.findCredential(t.url))?void 0:r.token}}async function at(e,t){t.canvas||(t.canvas=document.createElement("canvas"));const n=1024;t.canvas.width=n,t.canvas.height=n;const r=t.canvas.getContext("2d");let i,a;if(e.path){var s;const t=new Path2D(e.path);t.closePath(),r.fillStyle=Array.isArray(e.color)?`rgba(${e.color[0]},${e.color[1]},${e.color[2]},${e.color[3]/255})`:"rgb(0,0,0)",r.fill(t);const o=function(e,t=15){const n=e.canvas.width,r=e.canvas.height,i=e.getImageData(0,0,n,r).data;let a,s,o,l,u,c;e:for(s=r;s--;)for(a=n;a--;)if(i[4*(n*s+a)+3]>t){c=s;break e}if(!c)return null;e:for(a=n;a--;)for(s=c+1;s--;)if(i[4*(n*s+a)+3]>t){u=a;break e}e:for(a=0;a<=u;++a)for(s=c+1;s--;)if(i[4*(n*s+a)+3]>t){o=a;break e}e:for(s=0;s<=c;++s)for(a=o;a<=u;++a)if(i[4*(n*s+a)+3]>t){l=s;break e}return{x:o,y:l,width:u-o,height:c-l}}(r);if(!o)return null;r.clearRect(0,0,n,n);const l=w(e.size)/Math.max(o.width,o.height);r.scale(l,l);const u=n/l;if(r.translate(u/2-o.width/2-o.x,u/2-o.height/2-o.y),Array.isArray(e.color)&&r.fill(t),null!=(s=e.outline)&&s.width&&Array.isArray(e.outline.color)){const n=e.outline;r.lineWidth=w(n.width)/l,r.lineJoin="round",r.strokeStyle=`rgba(${n.color[0]},${n.color[1]},${n.color[2]},${n.color[3]/255})`,r.stroke(t),o.width+=r.lineWidth,o.height+=r.lineWidth}o.width*=l,o.height*=l;const c=r.getImageData(512-o.width/2,512-o.height/2,Math.ceil(o.width),Math.ceil(o.height));i=c.width,a=c.height,r.canvas.width=i,r.canvas.height=a,r.putImageData(c,0,0)}else{const t="image/svg+xml"===e.contentType?"data:image/svg+xml;base64,"+e.imageData:e.url,n=(await u(t,{responseType:"image"})).data;i=w(e.width),a=w(e.height),r.canvas.width=i,r.canvas.height=a,r.drawImage(n,0,0,r.canvas.width,r.canvas.height)}return{type:"esriPMS",imageData:r.canvas.toDataURL("image/png").substr(22),angle:e.angle,contentType:"image/png",height:v(a),width:v(i),xoffset:e.xoffset,yoffset:e.yoffset}}async function st(e,t){const n=e.type;if("simple"===n&&lt(e.symbol))e.symbol=await at(e.symbol,t);else if("uniqueValue"===n||"classBreaks"===n){lt(e.defaultSymbol)&&(e.defaultSymbol=await at(e.defaultSymbol,t));const r=e["uniqueValue"===n?"uniqueValueInfos":"classBreakInfos"];if(r)for(const e of r)lt(e.symbol)&&(e.symbol=await at(e.symbol,t))}}async function ot(e){return e.queryFeatures(e.createQuery()).then((e=>e.features))}function lt(e){return e&&(e.path||"image/svg+xml"===e.contentType||e.url&&e.url.endsWith(".svg"))}export{ke as G,$e as Q,Je as X,Ne as Z,ae as n,$ as p,le as r}