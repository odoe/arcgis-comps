import{z as e,$ as n,s as t,c as r,U as o,V as i,a,d as l,Z as s,A as f,e as u,J as c,aj as p,ak as m,a4 as d,al as E}from"./p-4ddfade5.js";import{D as j,q as b,r as w,P as y,G as N,y as I,_ as $,e as g,a as D,b as A,g as h,w as x,T as L,j as O,c as S,C as T,v as F,E as P,d as M}from"./p-6c62fcb2.js";import{c as v,E as G}from"./p-e3799f3b.js";import{ao as B,bE as C}from"./p-9ae46e68.js";import{WhereClause as H}from"./p-b74f39e0.js";import R from"./p-7e9d2371.js";import{y as V}from"./p-8e03c038.js";import"./p-566b0715.js";import"./p-fe01b82b.js";import"./p-a184d75f.js";import"./p-023ccb69.js";import"./p-4003c7ae.js";import"./p-b2d0e2de.js";import"./p-db87794e.js";import"./p-9dcf03f7.js";import"./p-2a252a78.js";import"./p-dfc6337f.js";import"./p-e991a11e.js";import"./p-5a0fe1d0.js";import"./p-3048cc18.js";import"./p-c7a0a732.js";import"./p-98a14d68.js";import"./p-84bf99cb.js";import"./p-32462343.js";import"./p-f42060e0.js";import"./p-79553c8d.js";import"./p-98ce0cca.js";import"./p-41655335.js";import"./p-a0e42f29.js";import"./p-3ffd0931.js";import"./p-8031c809.js";import"./p-22c8d854.js";import"./p-3d1b25b6.js";import"./p-32824614.js";import"./p-a7080451.js";import"./p-2f7c985e.js";import"./p-725fd184.js";import"./p-0cc8e004.js";import"./p-4681e856.js";import"./p-94f8dc11.js";import"./p-bb07d873.js";import"./p-8ac97b63.js";import"./p-a0a931f0.js";import"./p-77e6a663.js";import"./p-c5b7f7c3.js";import"./p-30ddb3a0.js";import"./p-74fc1b7f.js";import"./p-b3024dec.js";import"./p-4fcbc3c5.js";import"./p-4b3ae2cf.js";import"./p-3a2e88bf.js";import"./p-6443bfb4.js";import"./p-8e6daf54.js";import"./p-c0757461.js";import"./p-6ebb24ba.js";import"./p-4fd6e394.js";import"./p-93d9099f.js";import"./p-d3898fd7.js";import"./p-844dad6c.js";import"./p-c59d0a4d.js";import"./p-3a5fe179.js";import"./p-138c2b2c.js";import"./p-ae0b06e3.js";import"./p-a293872e.js";import"./p-f271906a.js";import"./p-cf2267f9.js";import"./p-d2e19070.js";import"./p-e5429b9e.js";import"./p-cf8dc9be.js";import"./p-f17028ec.js";import"./p-5c89c68e.js";import"./p-57ae469d.js";import"./p-0c91ebaf.js";import"./p-72355290.js";import"./p-d68829c1.js";import"./p-81102839.js";import"./p-00b9ea57.js";import"./p-7818def0.js";import"./p-da143060.js";import"./p-15bb2887.js";function k(e,n,t){const r=e.getVariables();if(r.length>0){const o=[];for(let e=0;e<r.length;e++)o.push(n.evaluateIdentifier(t,{name:r[e]}));return B(o).then((n=>{const t={};for(let e=0;e<r.length;e++)t[r[e]]=n[e];return e.parameters=t,e}))}return C(e)}function z(e,n,t=null){for(const t in e)if(t.toLowerCase()===n.toLowerCase())return e[t];return t}function W(e){if(null===e)return null;const n={type:z(e,"type",""),name:z(e,"name","")};if("range"===n.type)n.range=z(e,"range",[]);else{n.codedValues=[];for(const t of z(e,"codedValues",[]))n.codedValues.push({name:z(t,"name",""),code:z(t,"code",null)})}return n}function J(e){if(null===e)return null;const n={},t=z(e,"wkt",null);null!==t&&(n.wkt=t);const r=z(e,"wkid",null);return null!==r&&(n.wkid=r),n}function _(e){if(null===e)return null;const n={hasZ:z(e,"hasz",!1),hasM:z(e,"hasm",!1)},t=z(e,"spatialreference",null);t&&(n.spatialReference=J(t));const r=z(e,"x",null);if(null!==r)return n.x=r,n.y=z(e,"y",null),n;const o=z(e,"rings",null);if(null!==o)return n.rings=o,n;const i=z(e,"paths",null);if(null!==i)return n.paths=i,n;const a=z(e,"points",null);if(null!==a)return n.points=a,n;for(const t of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const r=z(e,t,null);null!==r&&(n[t]=r)}return n}function q(q){"async"===q.mode&&(q.functions.getuser=function(o,a){return q.standardFunctionAsync(o,a,((a,l,s)=>{e(s,1,2);let u=i(s[1],""),c=!0===u;if(u=!0===u||!1===u?"":n(u),s[0]instanceof t){let e=null;return o.services&&o.services.portal&&(e=o.services.portal),e=j(s[0],e),b(e,u,c).then((e=>{if(e){const n=JSON.parse(JSON.stringify(e));for(const e of["lastLogin","created","modified"])null!=n[e]&&(n[e]=new Date(n[e]));return r.convertObjectToArcadeDictionary(n)}return null}))}let p=null;if(f(s[0])&&(p=s[0]),p)return c=!1,u?null:p.load().then((()=>p.getOwningSystemUrl())).then((e=>{if(!e)return u?null:p.getIdentityUser().then((e=>e?r.convertObjectToArcadeDictionary({username:e}):null));let n=null;return o.services&&o.services.portal&&(n=o.services.portal),n=j(new t(e),n),b(n,u,c).then((e=>{if(e){const n=JSON.parse(JSON.stringify(e));for(const e of["lastLogin","created","modified"])null!=n[e]&&(n[e]=new Date(n[e]));return r.convertObjectToArcadeDictionary(n)}return null}))}));throw new Error("Invalid Parameter")}))},q.signatures.push({name:"getuser",min:"1",max:"2"}),q.functions.featuresetbyid=function(t,r){return q.standardFunctionAsync(t,r,((t,r,l)=>{if(e(l,2,4),l[0]instanceof w){const e=n(l[1]);let t=i(l[2],null);const r=o(i(l[3],!0));if(null===t&&(t=["*"]),!1===a(t))throw new Error("Invalid Parameter");return l[0].featureSetById(e,r,t)}throw new Error("Invalid Parameter")}))},q.signatures.push({name:"featuresetbyid",min:"2",max:"4"}),q.functions.getfeatureset=function(t,r){return q.standardFunctionAsync(t,r,((r,o,a)=>{if(e(a,1,2),a[0]instanceof l){let e=i(a[1],"datasource");return null===e&&(e="datasource"),e=n(e).toLowerCase(),y(a[0]._layer,e,t.lrucache,t.interceptor,t.spatialReference)}throw new Error("Invalid Parameter")}))},q.signatures.push({name:"getfeatureset",min:"1",max:"2"}),q.functions.featuresetbyportalitem=function(r,l){return q.standardFunctionAsync(r,l,((l,f,u)=>{if(e(u,2,5),null===u[0])throw new Error("Portal is required");if(u[0]instanceof t){const e=n(u[1]),t=n(u[2]);let l=i(u[3],null);const s=o(i(u[4],!0));if(null===l&&(l=["*"]),!1===a(l))throw new Error("Invalid Parameter");let f=null;return r.services&&r.services.portal&&(f=r.services.portal),f=j(u[0],f),N(e,t,r.spatialReference,l,s,f,r.lrucache,r.interceptor)}if(!1===s(u[0]))throw new Error("Portal is required");const c=n(u[0]),p=n(u[1]);let m=i(u[2],null);const d=o(i(u[3],!0));if(null===m&&(m=["*"]),!1===a(m))throw new Error("Invalid Parameter");if(r.services&&r.services.portal)return N(c,p,r.spatialReference,m,d,r.services.portal,r.lrucache,r.interceptor);throw new Error("Portal is required")}))},q.signatures.push({name:"featuresetbyportalitem",min:"2",max:"5"}),q.functions.featuresetbyname=function(t,r){return q.standardFunctionAsync(t,r,((t,r,l)=>{if(e(l,2,4),l[0]instanceof w){const e=n(l[1]);let t=i(l[2],null);const r=o(i(l[3],!0));if(null===t&&(t=["*"]),!1===a(t))throw new Error("Invalid Parameter");return l[0].featureSetByName(e,r,t)}throw new Error("Invalid Parameter")}))},q.signatures.push({name:"featuresetbyname",min:"2",max:"4"}),q.functions.featureset=function(n,t){return q.standardFunction(n,t,((t,o,i)=>{e(i,1,1);let l=i[0];const f={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(s(l))l=JSON.parse(l),void 0!==l.layerDefinition?(f.layerDefinition=l.layerDefinition,f.featureSet=l.featureSet,l.layerDefinition.spatialReference&&(f.layerDefinition.spatialReference=l.layerDefinition.spatialReference)):(f.featureSet.features=l.features,f.featureSet.geometryType=l.geometryType,f.layerDefinition.geometryType=f.featureSet.geometryType,f.layerDefinition.objectIdField=l.objectIdFieldName,f.layerDefinition.typeIdField=l.typeIdFieldName,f.layerDefinition.globalIdField=l.globalIdFieldName,f.layerDefinition.fields=l.fields,l.spatialReference&&(f.layerDefinition.spatialReference=l.spatialReference));else{if(!(i[0]instanceof r))throw new Error("Invalid Parameter");{l=JSON.parse(i[0].castToText());const e=z(l,"layerdefinition");if(null!==e){f.layerDefinition.geometryType=z(e,"geometrytype",""),f.featureSet.geometryType=f.layerDefinition.geometryType,f.layerDefinition.globalIdField=z(e,"globalidfield",""),f.layerDefinition.objectIdField=z(e,"objectidfield",""),f.layerDefinition.typeIdField=z(e,"typeidfield","");const n=z(e,"spatialreference",null);n&&(f.layerDefinition.spatialReference=J(n));for(const n of z(e,"fields",[])){const e={name:z(n,"name",""),alias:z(n,"alias",""),type:z(n,"type",""),nullable:z(n,"nullable",!0),editable:z(n,"editable",!0),length:z(n,"length",null),domain:W(z(n,"domain"))};f.layerDefinition.fields.push(e)}const t=z(l,"featureset",null);if(t){const e={};for(const n of f.layerDefinition.fields)e[n.name.toLowerCase()]=n.name;for(const n of z(t,"features",[])){const t={},r=z(n,"attributes",{});for(const n in r)t[e[n.toLowerCase()]]=r[n];f.featureSet.features.push({attributes:t,geometry:_(z(n,"geometry",null))})}}}else{f.layerDefinition.geometryType=z(l,"geometrytype",""),f.featureSet.geometryType=f.layerDefinition.geometryType,f.layerDefinition.objectIdField=z(l,"objectidfieldname",""),f.layerDefinition.typeIdField=z(l,"typeidfieldname","");const e=z(l,"spatialreference",null);e&&(f.layerDefinition.spatialReference=J(e));for(const e of z(l,"fields",[])){const n={name:z(e,"name",""),alias:z(e,"alias",""),type:z(e,"type",""),nullable:z(e,"nullable",!0),editable:z(e,"editable",!0),length:z(e,"length",null),domain:W(z(e,"domain"))};f.layerDefinition.fields.push(n)}const n={};for(const e of f.layerDefinition.fields)n[e.name.toLowerCase()]=e.name;for(const e of z(l,"features",[])){const t={},r=z(e,"attributes",{});for(const e in r)t[n[e.toLowerCase()]]=r[e];f.featureSet.features.push({attributes:t,geometry:_(z(e,"geometry",null))})}}}}if(!1===function(e){return!!e.layerDefinition&&!!e.featureSet&&!1!==function(e){for(const n of["","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])if(n===e)return!0;return!1}(e.layerDefinition.geometryType)&&null!==e.layerDefinition.objectIdField&&""!==e.layerDefinition.objectIdField&&!1!==a(e.layerDefinition.fields)&&!1!==a(e.featureSet.features)}(f))throw new Error("Invalid Parameter");return I.create(f,n.spatialReference)}))},q.signatures.push({name:"featureset",min:"1",max:"1"}),q.functions.filter=function(n,t){return q.standardFunctionAsync(n,t,((t,r,o)=>(e(o,2,2),f(o[0])?o[0].load().then((e=>{const t=H.create(o[1],e.getFieldsIndex()),r=t.getVariables();if(r.length>0){const e=[];for(let t=0;t<r.length;t++)e.push(q.evaluateIdentifier(n,{name:r[t]}));return B(e).then((e=>{const n={};for(let t=0;t<r.length;t++)n[r[t]]=e[t];return t.parameters=n,new $({parentfeatureset:o[0],whereclause:t})}))}return C(new $({parentfeatureset:o[0],whereclause:t}))})):q.failDefferred("Filter cannot accept this parameter type"))))},q.signatures.push({name:"filter",min:"2",max:"2"}),q.functions.orderby=function(n,t){return q.standardFunctionAsync(n,t,((n,t,r)=>{if(e(r,2,2),f(r[0])){const e=new g(r[1]);return C(new D({parentfeatureset:r[0],orderbyclause:e}))}return q.failDefferred("Order cannot accept this parameter type")}))},q.signatures.push({name:"orderby",min:"2",max:"2"}),q.functions.top=function(n,t){return q.standardFunctionAsync(n,t,((n,t,r)=>(e(r,2,2),f(r[0])?C(new A({parentfeatureset:r[0],topnum:r[1]})):a(r[0])?u(r[1])>=r[0].length?r[0].slice(0):r[0].slice(0,u(r[1])):c(r[0])?u(r[1])>=r[0].length()?r[0].slice(0):r[0].slice(0,u(r[1])):q.failDefferred("Top cannot accept this parameter type"))))},q.signatures.push({name:"top",min:"2",max:"2"}),q.functions.first=function(n,t){return q.standardFunctionAsync(n,t,((n,t,r)=>(e(r,1,1),f(r[0])?r[0].first(n.abortSignal).then((e=>{if(null!==e){const n=l.createFromGraphicLikeObject(e.geometry,e.attributes,r[0]);n._underlyingGraphic=e,e=n}return e})):a(r[0])?C(0===r[0].length?null:r[0][0]):c(r[0])?0===r[0].length()?C(null):C(r[0].get(0)):null)))},q.signatures.push({name:"first",min:"1",max:"1"}),q.functions.attachments=function(n,t){return q.standardFunctionAsync(n,t,((t,i,a)=>{e(a,1,2);const s={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(a.length>1)if(a[1]instanceof r){if(a[1].hasField("minsize")&&(s.minsize=u(a[1].field("minsize"))),a[1].hasField("metadata")&&(s.returnMetadata=o(a[1].field("metadata"))),a[1].hasField("maxsize")&&(s.maxsize=u(a[1].field("maxsize"))),a[1].hasField("types")){const e=p(a[1].field("types"),!1);e.length>0&&(s.types=e)}}else if(null!==a[1])throw new Error("Invalid Parameter");if(a[0]instanceof l){let e=a[0]._layer;return e instanceof R&&(e=h(e,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),null===e||!1===f(e)?[]:e.load().then((()=>e.queryAttachments(a[0].field(e.objectIdField),s.minsize,s.maxsize,s.types,s.returnMetadata)))}if(null===a[0])return[];throw new Error("Invalid Parameter")}))},q.signatures.push({name:"attachments",min:"1",max:"2"}),q.functions.featuresetbyrelationshipname=function(t,r){return q.standardFunctionAsync(t,r,((r,s,u)=>{e(u,2,4);const c=u[0],p=n(u[1]);let m=i(u[2],null);const d=o(i(u[3],!0));if(null===m&&(m=["*"]),!1===a(m))throw new Error("Invalid Parameter");if(null===u[0])return null;if(!(u[0]instanceof l))throw new Error("Invalid Parameter");let E=c._layer;return E instanceof R&&(E=h(E,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),null===E||!1===f(E)?null:E.load().then((e=>{const n=e.relationshipMetaData().filter((e=>e.name===p));if(0===n.length)return null;if(null!=n[0].relationshipTableId&&n[0].relationshipTableId>-1)return x(e,n[0],c.field(e.objectIdField),e.spatialReference,m,d,t.lrucache,t.interceptor);let r=e.serviceUrl();return r?(r="/"===r.charAt(r.length-1)?r+n[0].relatedTableId.toString():r+"/"+n[0].relatedTableId.toString(),L(r,e.spatialReference,m,d,t.lrucache,t.interceptor).then((t=>t.load().then((()=>t.relationshipMetaData())).then((r=>{if(r=r.filter((e=>e.id===n[0].id)),!1===c.hasField(n[0].keyField)||null===c.field(n[0].keyField))return e.getFeatureByObjectId(c.field(e.objectIdField),[n[0].keyField]).then((e=>{if(e){const o=H.create(r[0].keyField+"= @id",t.getFieldsIndex());return o.parameters={id:e.attributes[n[0].keyField]},t.filter(o)}return new v({parentfeatureset:t})}));const o=H.create(r[0].keyField+"= @id",t.getFieldsIndex());return o.parameters={id:c.field(n[0].keyField)},t.filter(o)}))))):null}))}))},q.signatures.push({name:"featuresetbyrelationshipname",min:"2",max:"4"}),q.functions.featuresetbyassociation=function(t,r){return q.standardFunctionAsync(t,r,((r,o,a)=>{e(a,2,3);const u=a[0],c=n(i(a[1],"")).toLowerCase(),p=s(a[2])?n(a[2]):null;if(null===a[0])return null;if(!(a[0]instanceof l))throw new Error("Invalid Parameter");let E=u._layer;return E instanceof R&&(E=h(E,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),null===E||!1===f(E)?null:E.load().then((()=>{const e=E.serviceUrl();return O(e,t.spatialReference)})).then((e=>{let n=null,t=null,r=!1;if(null!==p&&""!==p&&void 0!==p){for(const n of e.terminals)n.terminalName===p&&(t=n.terminalId);null===t&&(r=!0)}const o=e.associations.getFieldsIndex(),i=o.get("TOGLOBALID").name,a=o.get("FROMGLOBALID").name,l=o.get("TOTERMINALID").name,s=o.get("FROMTERMINALID").name,f=o.get("FROMNETWORKSOURCEID").name,j=o.get("TONETWORKSOURCEID").name,b=o.get("ASSOCIATIONTYPE").name,w=o.get("ISCONTENTVISIBLE").name,y=o.get("OBJECTID").name;for(const e of E.fields)if("global-id"===e.type){n=u.field(e.name);break}let N=null,I=new S(new V({name:"percentalong",alias:"percentalong",type:"double"}),H.create("0",e.associations.getFieldsIndex())),$=new S(new V({name:"side",alias:"side",type:"string"}),H.create("''",e.associations.getFieldsIndex()));const g="globalid",D="globalId",A={};for(const n in e.lkp)A[n]=e.lkp[n].sourceId;const h=new T(new V({name:"classname",alias:"classname",type:"string"}),null,A);let x="";switch(c){case"midspan":{x=`((${i}='${n}') OR ( ${a}='${n}')) AND (${b} IN (5))`,h.codefield=H.create(`CASE WHEN (${i}='${n}') THEN ${f} ELSE ${j} END`,e.associations.getFieldsIndex());const t=d(P.findField(e.associations.fields,a));t.name=g,t.alias=g,N=new S(t,H.create(`CASE WHEN (${a}='${n}') THEN ${i} ELSE ${a} END`,e.associations.getFieldsIndex())),I=e.unVersion>=4?new M(P.findField(e.associations.fields,o.get("PERCENTALONG").name)):new S(new V({name:"percentalong",alias:"percentalong",type:"double"}),H.create("0",e.associations.getFieldsIndex()));break}case"junctionedge":{x=`((${i}='${n}') OR ( ${a}='${n}')) AND (${b} IN (4,6))`,h.codefield=H.create(`CASE WHEN (${i}='${n}') THEN ${f} ELSE ${j} END`,e.associations.getFieldsIndex());const t=d(P.findField(e.associations.fields,a));t.name=g,t.alias=g,N=new S(t,H.create(`CASE WHEN (${a}='${n}') THEN ${i} ELSE ${a} END`,e.associations.getFieldsIndex())),$=new S(new V({name:"side",alias:"side",type:"string"}),H.create(`CASE WHEN (${b}=4) THEN 'from' ELSE 'to' END`,e.associations.getFieldsIndex()));break}case"connected":{let r=`${i}='@T'`,o=`${a}='@T'`;null!==t&&(r+=` AND ${l}=@A`,o+=` AND ${s}=@A`),x="(("+r+") OR ("+o+"))",x=m(x,"@T",n),r=m(r,"@T",n),null!==t&&(r=m(r,"@A",t.toString()),x=m(x,"@A",t.toString())),h.codefield=H.create("CASE WHEN "+r+` THEN ${f} ELSE ${j} END`,e.associations.getFieldsIndex());const u=d(P.findField(e.associations.fields,a));u.name=g,u.alias=g,N=new S(u,H.create("CASE WHEN "+r+` THEN ${a} ELSE ${i} END`,e.associations.getFieldsIndex()));break}case"container":x=`${i}='${n}' AND ${b} = 2`,null!==t&&(x+=` AND ${l} = `+t.toString()),h.codefield=f,x="( "+x+" )",N=new F(P.findField(e.associations.fields,a),g,g);case"content":x=`(${a}='${n}' AND ${b} = 2)`,null!==t&&(x+=` AND ${s} = `+t.toString()),h.codefield=j,x="( "+x+" )",N=new F(P.findField(e.associations.fields,i),g,g);break;case"structure":x=`(${i}='${n}' AND ${b} = 3)`,null!==t&&(x+=` AND ${l} = `+t.toString()),h.codefield=f,x="( "+x+" )",N=new F(P.findField(e.associations.fields,a),g,D);break;case"attached":x=`(${a}='${n}' AND ${b} = 3)`,null!==t&&(x+=` AND ${s} = `+t.toString()),h.codefield=j,x="( "+x+" )",N=new F(P.findField(e.associations.fields,i),g,D);break;default:throw new Error("Invalid Parameter")}return r&&(x="1 <> 1"),new P({parentfeatureset:e.associations,adaptedFields:[new M(P.findField(e.associations.fields,y)),new M(P.findField(e.associations.fields,w)),N,$,h,I],extraFilter:x?H.create(x,e.associations.getFieldsIndex()):null})}))}))},q.signatures.push({name:"featuresetbyassociation",min:"2",max:"6"}),q.functions.groupby=function(t,o){return q.standardFunctionAsync(t,o,((o,i,l)=>(e(l,3,3),f(l[0])?l[0].load().then((e=>{const o=[],i=[];let f=!1,u=[];if(s(l[1]))u.push(l[1]);else if(l[1]instanceof r)u.push(l[1]);else if(a(l[1]))u=l[1];else{if(!c(l[1]))return q.failDefferred("Illegal Value: GroupBy");u=l[1].toArray()}for(const t of u)if(s(t)){const r=H.create(n(t),e.getFieldsIndex()),i=!0===G(r)?n(t):"%%%%FIELDNAME";o.push({name:i,expression:r}),"%%%%FIELDNAME"===i&&(f=!0)}else{if(!(t instanceof r))return q.failDefferred("Illegal Value: GroupBy");{const n=t.hasField("name")?t.field("name"):"%%%%FIELDNAME",r=t.hasField("expression")?t.field("expression"):"";if("%%%%FIELDNAME"===n&&(f=!0),!n)return q.failDefferred("Illegal Value: GroupBy");o.push({name:n,expression:H.create(r||n,e.getFieldsIndex())})}}if(u=[],s(l[2]))u.push(l[2]);else if(a(l[2]))u=l[2];else if(c(l[2]))u=l[2].toArray();else{if(!(l[2]instanceof r))return q.failDefferred("Illegal Value: GroupBy");u.push(l[2])}for(const n of u){if(!(n instanceof r))return q.failDefferred("Illegal Value: GroupBy");{const t=n.hasField("name")?n.field("name"):"",r=n.hasField("statistic")?n.field("statistic"):"",o=n.hasField("expression")?n.field("expression"):"";if(!t||!r||!o)return q.failDefferred("Illegal Value: GroupBy");i.push({name:t,statistic:r.toLowerCase(),expression:H.create(o,e.getFieldsIndex())})}}if(f){const n={};for(const t of e.fields)n[t.name.toLowerCase()]=1;for(const e of o)"%%%%FIELDNAME"!==e.name&&(n[e.name.toLowerCase()]=1);for(const e of i)"%%%%FIELDNAME"!==e.name&&(n[e.name.toLowerCase()]=1);let t=0;for(const e of o)if("%%%%FIELDNAME"===e.name){for(;1===n["field_"+t.toString()];)t++;n["field_"+t.toString()]=1,e.name="FIELD_"+t.toString()}}const p=[];for(const e of o)p.push(k(e.expression,q,t));for(const e of i)p.push(k(e.expression,q,t));return p.length>0?B(p).then((()=>C(l[0].groupby(o,i)))):C(l[0].groupby(o,i))})):q.failDefferred("Illegal Value: GroupBy"))))},q.signatures.push({name:"groupby",min:"3",max:"3"}),q.functions.distinct=function(t,o){return q.standardFunctionAsync(t,o,((o,i,l)=>f(l[0])?(e(l,2,2),l[0].load().then((e=>{const o=[];let i=[];if(s(l[1]))i.push(l[1]);else if(l[1]instanceof r)i.push(l[1]);else if(a(l[1]))i=l[1];else{if(!c(l[1]))return q.failDefferred("Illegal Value: GroupBy");i=l[1].toArray()}let f=!1;for(const t of i)if(s(t)){const r=H.create(n(t),e.getFieldsIndex()),i=!0===G(r)?n(t):"%%%%FIELDNAME";o.push({name:i,expression:r}),"%%%%FIELDNAME"===i&&(f=!0)}else{if(!(t instanceof r))return q.failDefferred("Illegal Value: GroupBy");{const n=t.hasField("name")?t.field("name"):"%%%%FIELDNAME",r=t.hasField("expression")?t.field("expression"):"";if("%%%%FIELDNAME"===n&&(f=!0),!n)return q.failDefferred("Illegal Value: GroupBy");o.push({name:n,expression:H.create(r||n,e.getFieldsIndex())})}}if(f){const n={};for(const t of e.fields)n[t.name.toLowerCase()]=1;for(const e of o)"%%%%FIELDNAME"!==e.name&&(n[e.name.toLowerCase()]=1);let t=0;for(const e of o)if("%%%%FIELDNAME"===e.name){for(;1===n["field_"+t.toString()];)t++;n["field_"+t.toString()]=1,e.name="FIELD_"+t.toString()}}const u=[];for(const e of o)u.push(k(e.expression,q,t));return u.length>0?B(u).then((()=>C(l[0].groupby(o,[])))):C(l[0].groupby(o,[]))}))):function(e,n,t,r){if(1===r.length){if(a(r[0]))return E(e,r[0],-1);if(c(r[0]))return E(e,r[0].toArray(),-1)}return E(e,r,-1)}("distinct",0,0,l)))})}export{q as registerFunctions}