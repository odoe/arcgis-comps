import"./p-b79fcce3.js";import{c as e,af as n,s as t,Q as i,a0 as a,aW as s,A as o,ar as r,dl as l}from"./p-e58503d5.js";import{s as c,n as u,e as p}from"./p-5032dfbd.js";import{e as f}from"./p-db87794e.js";import{O as d,T as m,L as g}from"./p-48c5edb1.js";import{u as y}from"./p-ed18725d.js";import{d as w}from"./p-612de336.js";import{i as h}from"./p-a2324023.js";const b=e.getLogger("esri.layers.graphics.sources.ogcfeature"),j="http://www.opengis.net/def/crs/",I=`${j}OGC/1.3/CRS84`;async function F(e,a,s={},o=5){const{links:r}=e,l=M(r,"items","application/geo+json")||M(r,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(n(l))throw new t("ogc-feature-layer:missing-items-page","Missing items url");const{data:c}=await i(l.href,{signal:s.signal,query:{limit:o,...s.customParameters,token:s.apiKey},headers:{accept:"application/geo+json"}});await d(c);const u=m(c,{geometryType:a.geometryType}),p=a.fields||u.fields||[],f=null!=a.hasZ?a.hasZ:u.hasZ,g=u.geometryType,j=a.objectIdField||u.objectIdFieldName||"OBJECTID";let I=a.timeInfo;const F=p.find((e=>e.name===j));if(F)F.type="esriFieldTypeOID",F.editable=!1,F.nullable=!1;else{if(!u.objectIdFieldType)throw new t("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");p.unshift({name:j,alias:j,type:"esriFieldTypeOID",editable:!1,nullable:!1})}if(j!==u.objectIdFieldName){const e=p.find((e=>e.name===u.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}p===u.fields&&u.unknownFields.length>0&&b.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:u.unknownFields}});for(const e of p){if(null==e.name&&(e.name=e.alias),null==e.alias&&(e.alias=e.name),"esriFieldTypeOID"!==e.type&&"esriFieldTypeGlobalID"!==e.type&&(e.editable=null==e.editable||!!e.editable,e.nullable=null==e.nullable||!!e.nullable),!e.name)throw new t("ogc-feature-layer:invalid-field-name","field name is missing",{field:e});if(-1===h.jsonValues.indexOf(e.type))throw new t("ogc-feature-layer:invalid-field-type",`invalid type for field "${e.name}"`,{field:e})}if(I){const e=new w(p);if(I.startTimeField){const n=e.get(I.startTimeField);n?(I.startTimeField=n.name,n.type="esriFieldTypeDate"):I.startTimeField=null}if(I.endTimeField){const n=e.get(I.endTimeField);n?(I.endTimeField=n.name,n.type="esriFieldTypeDate"):I.endTimeField=null}if(I.trackIdField){const n=e.get(I.trackIdField);n?I.trackIdField=n.name:(I.trackIdField=null,b.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:I}}))}I.startTimeField||I.endTimeField||(b.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:I}}),I=null)}return{drawingInfo:g?y(g):null,geometryType:g,fields:p,hasZ:!!f,objectIdField:j,timeInfo:I}}async function k(e,a={}){const{links:s}=e,o=M(s,"data","application/json")||M(s,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(n(o))throw new t("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:r,customParameters:l,signal:c}=a,{data:u}=await i(o.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:r}});return u}async function T(e,a={}){const{links:s}=e,o=M(s,"conformance","application/json")||M(s,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(n(o))throw new t("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:r,customParameters:l,signal:c}=a,{data:u}=await i(o.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:r}});return u}async function v(e,n={}){const{apiKey:t,customParameters:a,signal:s}=n,{data:o}=await i(e,{signal:s,headers:{accept:"application/json"},query:{...a,token:t}});return o}async function x(e,t={}){const a="application/vnd.oai.openapi+json;version=3.0",s=M(e.links,"service-desc",a);if(n(s))return b.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:o,customParameters:r,signal:l}=t,{data:c}=await i(s.href,{signal:l,headers:{accept:a},query:{...r,token:o}});return c}function q(e){const n=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),t=null==n?void 0:n.groups;if(!t)return null;const{authority:i,code:s}=t;switch(i.toLowerCase()){case"ogc":switch(s.toLowerCase()){case"crs27":return a.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return a.WGS84.wkid;default:return null}case"esri":case"epsg":{const e=Number.parseInt(s,10);return Number.isNaN(e)?null:e}default:return null}}async function $(e,n,t){const i=await D(e,n,t);return c(i)}async function D(e,c,d){const{capabilities:{query:{maxRecordCount:m}},collection:y,layerDefinition:w,queryParameters:{apiKey:h,customParameters:b},spatialReference:j,supportedCrs:I}=e,{links:F}=y,k=M(F,"items","application/geo+json")||M(F,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(n(k))throw new t("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:T,num:v,start:x,timeExtent:q,where:$}=c;if(c.objectIds)throw new t("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const D=a.fromJSON(j),P=s(c.outSpatialReference,D),K=P.isWGS84?null:O(P,I),N=C(T,I),R=function(e){if(n(e))return null;const{start:t,end:i}=e;return`${o(t)?t.toISOString():".."}/${o(i)?i.toISOString():".."}`}(q),A=function(e){return n(e)||!e||"1=1"===e?null:e}($),G=null!=v?v:null!=x&&void 0!==x?10:m,{data:Z}=await i(k.href,{...d,query:{...b,...N,crs:K,datetime:R,query:A,limit:G,startindex:x,token:h},headers:{accept:"application/geo+json"}});let E=!1;Z.links&&(E=!!Z.links.find((e=>"next"===e.rel))),!E&&Number.isInteger(Z.numberMatched)&&Number.isInteger(Z.numberReturned)&&(E=Z.numberReturned<Z.numberMatched);const{fields:Q,globalIdField:S,hasM:W,hasZ:B,objectIdField:J}=w,z=w.geometryType,H=g(Z,{geometryType:z,hasZ:B,objectIdField:J});if(!K&&P.isWebMercator)for(const e of H)if(o(e.geometry)){const n=u(e.geometry,z,B,!1);n.spatialReference=a.WGS84,e.geometry=p(r(n,P))}for(const e of H)e.objectId=e.attributes[J];const L=K||!K&&P.isWebMercator?P.toJSON():l,U=new f;return U.exceededTransferLimit=E,U.features=H,U.fields=Q,U.geometryType=z,U.globalIdFieldName=S,U.hasM=W,U.hasZ=B,U.objectIdFieldName=J,U.spatialReference=L,U}function O(e,n){var t,i,a;const{isWebMercator:s,wkid:o}=e;if(!o)return null;const r=s?null!=(t=null!=(i=null!=(a=n[3857])?a:n[102100])?i:n[102113])?t:n[900913]:n[e.wkid];return r?`${j}${r}`:null}function P(e){if(n(e))return"";const{xmin:t,ymin:i,xmax:a,ymax:s}=e;return`${t},${i},${a},${s}`}function C(e,n){if(!function(e){return o(e)&&"extent"===e.type}(e))return null;const{spatialReference:t}=e;if(!t||t.isWGS84)return{bbox:P(e)};const i=O(t,n);return o(i)?{bbox:P(e),"bbox-crs":i}:t.isWebMercator?{bbox:P(r(e,a.WGS84))}:null}function M(e,n,t){return e.find((e=>e.rel===n&&e.type===t))||e.find((e=>e.rel===n&&!e.type))}export{I as F,F as I,$ as N,x as S,k as T,j,T as k,D as q,q as v,v as x}