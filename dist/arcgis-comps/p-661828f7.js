import{N as n,kc as t,W as o,k7 as e,j as r,b$ as s,fX as a,g as c,H as i}from"./p-c8bc3433.js";import{a as u}from"./p-2794293b.js";import{a as l}from"./p-353228be.js";import{m as f,c as p,y as m,f as b}from"./p-5db50865.js";import{T as d,i as j,c as w,x as g,u as x,L as h,O as $,E as v}from"./p-595bf8a5.js";import{e as C,f as M,t as T,r as y,a as k,n as A}from"./p-fa930cf8.js";import{a as I,r as N,o as S,b as q,t as E,c as L,j as R,f as z,e as B,k as D,i as F,d as G,g as H,m as K,n as O}from"./p-a1bcdc3a.js";import{b as P}from"./p-43c6911a.js";import"./p-84bf99cb.js";import"./p-01158f1c.js";import"./p-97ec6ae5.js";import"./p-3f1bfef4.js";import"./p-e0fec76c.js";import"./p-6227298a.js";import"./p-b13a6689.js";async function Q(n,t,e){const r=new O(function(n){return null!=n&&n.resolveFile?{busy:!1,request:async(t,e,r)=>{const s=n.resolveFile(t),a="image"===e?"image":"binary"===e?"array-buffer":"json";return(await i(s,{responseType:a,signal:o(r)?r.signal:null})).data}}:null}(e)),s=(await I(r,t,e,!0)).model,a=s.lods.shift(),c=new Map,u=new Map;s.textures.forEach(((n,t)=>c.set(t,X(n)))),s.materials.forEach(((n,t)=>u.set(t,J(n,c))));const l=W(a);for(const n of l.parts)Y(l,n,u);const{position:f,normal:p,tangent:b,color:d,texCoord0:j}=l.vertexAttributes,w={position:f.typedBuffer,normal:o(p)?p.typedBuffer:null,tangent:o(b)?b.typedBuffer:null,uv:o(j)?j.typedBuffer:null,color:o(d)?d.typedBuffer:null},g=P(w,n,e);return{transform:g.transform,components:l.components,spatialReference:n.spatialReference,vertexAttributes:new m({position:g.vertexAttributes.position,normal:g.vertexAttributes.normal,tangent:g.vertexAttributes.tangent,color:w.color,uv:w.uv})}}function U(n,t){if(c(n))return"-";const o=n.typedBuffer;return`${e(t,o.buffer,(()=>t.size))}/${o.byteOffset}/${o.byteLength}`}function V(n){return o(n)?n.toString():"-"}function W(n){let t=0;const o={color:!1,tangent:!1,normal:!1,texCoord0:!1},r=new Map,s=new Map,a=[];for(const c of n.parts){const{attributes:{position:n,normal:i,color:u,tangent:l,texCoord0:f}}=c,p=`\n      ${U(n,r)}/\n      ${U(i,r)}/\n      ${U(u,r)}/\n      ${U(l,r)}/\n      ${U(f,r)}/\n      ${V(c.transform)}\n    `;let m=!1;const b=e(s,p,(()=>(m=!0,{start:t,length:n.count})));m&&(t+=n.count),i&&(o.normal=!0),u&&(o.color=!0),l&&(o.tangent=!0),f&&(o.texCoord0=!0),a.push({gltf:c,writeVertices:m,region:b})}return{vertexAttributes:{position:N(d,t),normal:o.normal?N(j,t):null,tangent:o.tangent?N(w,t):null,color:o.color?N(g,t):null,texCoord0:o.texCoord0?N(x,t):null},parts:a,components:[]}}function X(n){return new f({data:n.data,wrap:nn(n.parameters.wrap)})}function J(o,e){const a=new r(function(n,t){return l(on(n[0]),on(n[1]),on(n[2]),t)}(o.color,o.opacity)),c=o.emissiveFactor?new r(function(n){return s(on(n[0]),on(n[1]),on(n[2]))}(o.emissiveFactor)):null;return new p({color:a,colorTexture:n(t(o.textureColor,(n=>e.get(n)))),normalTexture:n(t(o.textureNormal,(n=>e.get(n)))),emissiveColor:c,emissiveTexture:n(t(o.textureEmissive,(n=>e.get(n)))),occlusionTexture:n(t(o.textureOcclusion,(n=>e.get(n)))),alphaMode:_(o.alphaMode),alphaCutoff:o.alphaCutoff,doubleSided:o.doubleSided,metallic:o.metallicFactor,roughness:o.roughnessFactor,metallicRoughnessTexture:n(t(o.textureMetallicRoughness,(n=>e.get(n))))})}function Y(n,t,o){t.writeVertices&&Z(n,t);const e=t.gltf,r=function(n,t){switch(t){case 4:return H(n,K);case 5:return G(n);case 6:return F(n)}}(e.indices||e.attributes.position.count,e.primitiveType),s=t.region.start;if(s)for(let n=0;n<r.length;n++)r[n]+=s;n.components.push(new b({faces:r,material:o.get(e.material),trustSourceNormals:!0}))}function Z(n,t){const{position:e,normal:r,tangent:s,color:c,texCoord0:i}=n.vertexAttributes,l=t.region.start,{attributes:f,transform:p}=t.gltf,m=f.position.count;if(C(e.slice(l,m),f.position,p),o(f.normal)&&o(r)){const n=a(u(),p);M(r.slice(l,m),f.normal,n)}else o(r)&&T(r,0,0,1,{dstIndex:l,count:m});if(o(f.tangent)&&o(s)){const n=a(u(),p);q(s.slice(l,m),f.tangent,n)}else o(s)&&E(s,0,0,1,1,{dstIndex:l,count:m});if(o(f.texCoord0)&&o(i)?L(i.slice(l,m),f.texCoord0):o(i)&&R(i,0,0,{dstIndex:l,count:m}),o(f.color)&&o(c)){const n=f.color,t=c.slice(l,m);if(4===n.elementCount)n instanceof w?z(t,n,255):n instanceof g?B(t,n):n instanceof h&&D(t,n,8);else{E(t,255,255,255,255);const o=$.fromTypedArray(t.typedBuffer,t.typedBufferStride);n instanceof j?y(o,n,255):n instanceof $?k(o,n):n instanceof v&&A(o,n,8)}}else o(c)&&E(c.slice(l,m),255,255,255,255)}function _(n){switch(n){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function nn(n){return{horizontal:tn(n.s),vertical:tn(n.t)}}function tn(n){switch(n){case 33071:return"clamp";case 33648:return"mirror";case 10497:return"repeat"}}function on(n){return n**(1/S)*255}export{Q as loadGLTFMesh}