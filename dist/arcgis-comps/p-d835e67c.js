import{dw as t,u as s,i4 as i,e,d as r,i as h,p as n,r as l,f7 as a,en as o,ch as u,b as c,aL as d,t as p,T as m,b5 as f,hO as y,d8 as b,o as g,ef as v,hu as w,hN as T,Y as P,a as _,Q as x,b4 as S,bl as j,c as F,w as I}from"./p-5420851c.js";import{g as z,u as V,s as D,i as R}from"./p-a62db1cb.js";import{u as L,l as E}from"./p-8d730a3d.js";import{w as G,j as k,F as U}from"./p-163c7216.js";import{l as A,u as C}from"./p-e4db8bd2.js";import{x as M,G as O,c as W}from"./p-81f41410.js";import{r as B,o as N}from"./p-27418da2.js";import{I as q,t as J}from"./p-54db165f.js";import{U as Q,_ as Y,S as H}from"./p-e9fbf3df.js";import{h as K,f as X}from"./p-def8d692.js";import"./p-4d140ee3.js";import{a as Z}from"./p-e2fe661c.js";import{d as $}from"./p-cc74fdc8.js";import{i as tt}from"./p-8dd46af5.js";import{a as st}from"./p-4dafedac.js";import"./p-53bb6ab4.js";import"./p-47e1bd73.js";import"./p-4b2b4a33.js";import"./p-b392deaf.js";import"./p-4414d64f.js";import"./p-a617738c.js";import"./p-13d3a443.js";import"./p-97ec6ae5.js";import"./p-4c6040da.js";class it extends B{constructor(t,s,i,e,r,h=null){super(t,s,i,e,r),this.bitmap=new M(h,null,null),this.bitmap.coordScale=[e,r],this.bitmap.once("isReady",(()=>this.ready()))}destroy(){super.destroy(),this.bitmap.destroy(),this.bitmap=null,this.stage=null}set stencilRef(t){this.bitmap.stencilRef=t}get stencilRef(){return this.bitmap.stencilRef}setTransform(t,s){super.setTransform(t,s),this.bitmap.transforms.dvs=this.transforms.dvs}_createTransforms(){return{dvs:t(),tileMat3:t()}}onAttach(){this.bitmap.stage=this.stage}onDetach(){this.bitmap.stage=null}}class et extends N{constructor(){super(...arguments),this.isCustomTilingScheme=!1}createTile(t){const s=this._getTileBounds(t),[i,e]=this._tileInfoView.tileInfo.size;return new it(t,s[0],s[3],i,e)}destroyTile(){}prepareRenderPasses(t){const s=t.registerRenderPass({name:"imagery (tile)",brushes:[O.raster],target:()=>this.children.map((t=>t.bitmap)),drawPhase:q.MAP});return[...super.prepareRenderPasses(t),s]}doRender(t){this.visible&&t.drawPhase===q.MAP&&super.doRender(t)}_getTileBounds(t){const e=this._tileInfoView.getTileBounds(s(),t);if(this.isCustomTilingScheme&&t.world){const{tileInfo:s}=this._tileInfoView,r=i(s.spatialReference);if(r){const{resolution:i}=s.lodAt(t.level),h=r/i%s.size[0],n=h?(s.size[0]-h)*i:0;e[0]-=n*t.world,e[2]-=n*t.world}}return e}}let rt=class extends n{constructor(){super(...arguments),this._emptyTilePixelBlock=null,this.container=null,this.layer=null,this.tileSize=null,this.useWebGLForProcessing=!0}fetchTile(t,s){return this.layer.fetchTile(t.level,t.row,t.col,s)}createEmptyTilePixelBlock(t=null){const s=null==t||t.join(",")===this.tileSize.join(",");if(s&&l(this._emptyTilePixelBlock))return this._emptyTilePixelBlock;t=t||this.tileSize;const[i,e]=t,r=new L({width:i,height:e,pixels:[new Uint8Array(i*e)],mask:new Uint8Array(i*e),pixelType:"u8"});return s&&(this._emptyTilePixelBlock=r),r}};e([r()],rt.prototype,"container",void 0),e([r()],rt.prototype,"layer",void 0),e([r()],rt.prototype,"tileSize",void 0),e([r()],rt.prototype,"type",void 0),e([r()],rt.prototype,"useWebGLForProcessing",void 0),rt=e([h("esri.views.2d.layers.imagery.BaseImageryTileSubView2D")],rt);let ht=class extends rt{constructor(){super(...arguments),this.container=null,this.layer=null,this.tileSize=null,this.type="raster",this.useWebGLForProcessing=!0}canUseWebGLForProcessing(){return this.useWebGLForProcessing&&this.layer.symbolizer.canRenderInWebGL&&!("majority"===this.layer.interpolation&&this._canUseMajorityInterpolationOnDataSource())}fetchTile(t,s){return this.layer.fetchTile(t.level,t.row,t.col,s)}async updateTileSource(t,s){const{bandIds:i}=this.layer,e=this._getLayerInterpolation(),r=this.canUseWebGLForProcessing(),{source:h,symbolizerParams:n,globalSymbolizerParams:a,suspended:o,coords:u,resolution:c}=s,{bitmap:d}=t;if([d.x,d.y]=u,d.resolution=c,h&&l(h)&&l(h.pixelBlock)){const t={extent:h.extent,pixelBlock:h.pixelBlock};if(d.rawPixelData=t,r)d.source=h.pixelBlock,d.isRendereredSource=!1;else{const s=await this.layer.applyRenderer(t,"stretch"===(null==a?void 0:a.type)?a:null);d.source=s,d.isRendereredSource=!0}d.symbolizerParameters=r?n:null,r?d.transformGrid||(d.transformGrid=h.transformGrid):d.transformGrid=null}else{const t=this.createEmptyTilePixelBlock();d.source=t,d.symbolizerParameters=r?n:null,d.transformGrid=null}d.bandIds=r?i:null,d.width=this.tileSize[0],d.height=this.tileSize[1],d.interpolation=e,d.suspended=o,d.invalidateTexture()}async updateTileSymbolizerParameters(t,s){const{local:i,global:e}=s,{bandIds:r}=this.layer,h=this._getLayerInterpolation(),n=this.canUseWebGLForProcessing(),{bitmap:a}=t,{rawPixelData:o}=a;!n&&l(o)?(a.source=await this.layer.applyRenderer(o,"stretch"===(null==e?void 0:e.type)?e:null),a.isRendereredSource=!0):(a.isRendereredSource&&l(o)&&(a.source=o.pixelBlock),a.isRendereredSource=!1),a.symbolizerParameters=n?e||i:null,a.bandIds=n?r:null,a.interpolation=h,a.suspended=!1}install(t,s){this.container=new et(s.tileInfoView),this.container.isCustomTilingScheme=s.isCustomTilingScheme,t.addChild(this.container)}uninstall(){this.container.removeAllChildren(),this.container.remove()}_canUseMajorityInterpolationOnDataSource(){const{bandCount:t,attributeTable:s,colormap:i,pixelType:e}=this.layer.rasterInfo;return 1===t&&(null!=s||null!=i||"u8"===e||"s8"===e)}_getLayerInterpolation(){const t=this.layer.renderer.type;if("raster-colormap"===t||"unique-value"===t||"class-breaks"===t)return"nearest";const{interpolation:s}=this.layer,{renderer:i}=this.layer;return"raster-stretch"===i.type&&null!=i.colorRamp?"bilinear"===s||"cubic"===s?"bilinear":"nearest":s}};e([r()],ht.prototype,"container",void 0),e([r()],ht.prototype,"layer",void 0),e([r()],ht.prototype,"tileSize",void 0),e([r()],ht.prototype,"type",void 0),e([r()],ht.prototype,"useWebGLForProcessing",void 0),ht=e([h("esri.views.2d.layers.imagery.ImageryTileView2D")],ht);const nt=ht;class lt extends Z{constructor(t=null){super(),this._source=null,this._symbolizerParameters=null,this._vaoInvalidated=!0,this.coordScale=[1,1],this.height=null,this.stencilRef=0,this.rawPixelData=null,this.width=null,this.source=t}destroy(){var t,s;l(this.vaoData)&&(null==(t=this.vaoData.magdir)||t.vao.dispose(),null==(s=this.vaoData.scalar)||s.vao.dispose(),this.vaoData=null)}get symbolizerParameters(){return this._symbolizerParameters}set symbolizerParameters(t){JSON.stringify(this._symbolizerParameters)!==JSON.stringify(t)&&(this._symbolizerParameters=t,this.invalidateVAO())}get source(){return this._source}set source(t){this._source=t,this.invalidateVAO()}invalidateVAO(){var t,s;!this._vaoInvalidated&&l(this.vaoData)&&(null==(t=this.vaoData.magdir)||t.vao.dispose(),null==(s=this.vaoData.scalar)||s.vao.dispose(),this.vaoData=null,this._vaoInvalidated=!0,this.requestRender())}updateVectorFieldVAO(t){if(this._vaoInvalidated){if(this._vaoInvalidated=!1,l(this.source)&&!l(this.vaoData)){const{style:s}=this.symbolizerParameters;switch(s){case"beaufort_ft":case"beaufort_km":case"beaufort_kn":case"beaufort_m":case"beaufort_mi":case"classified_arrow":case"ocean_current_kn":case"ocean_current_m":case"single_arrow":{const s=Q(this.source,this.symbolizerParameters),i=this._createVectorFieldVAO(t.context,s);this.vaoData={magdir:i}}break;case"simple_scalar":{const s=Y(this.source,this.symbolizerParameters),i=this._createVectorFieldVAO(t.context,s);this.vaoData={scalar:i}}break;case"wind_speed":{const s=Q(this.source,this.symbolizerParameters),i=this._createVectorFieldVAO(t.context,s),e=Y(this.source,this.symbolizerParameters),r=this._createVectorFieldVAO(t.context,e);this.vaoData={magdir:i,scalar:r}}}}this.ready(),this.requestRender()}}_createTransforms(){return{dvs:t()}}onAttach(){this.invalidateVAO()}onDetach(){this.invalidateVAO()}_createVectorFieldVAO(t,s){const{vertexData:i,indexData:e}=s,r=K.createVertex(t,35044,new Float32Array(i)),h=K.createIndex(t,35044,new Uint32Array(e)),n=J("vector-field",{geometry:[{location:0,name:"a_pos",count:2,type:5126,normalized:!1},{location:1,name:"a_offset",count:2,type:5126,normalized:!1},{location:2,name:"a_vv",count:2,type:5126,normalized:!1}]});return{vao:new X(t,n.attributes,n.bufferLayouts,{geometry:r},h),elementCount:e.length}}}class at extends B{constructor(t,s,i,e,r,h=null){super(t,s,i,e,r),this.tileData=new lt(h),this.tileData.coordScale=[e,r],this.tileData.once("isReady",(()=>this.ready()))}destroy(){super.destroy(),this.tileData.destroy(),this.tileData=null,this.stage=null}set stencilRef(t){this.tileData.stencilRef=t}get stencilRef(){return this.tileData.stencilRef}_createTransforms(){return{dvs:t(),tileMat3:t()}}setTransform(t,s){super.setTransform(t,s);const i=s/(t.resolution*t.pixelRatio),e=this.transforms.tileMat3,[r,h]=this.tileData.offset,n=[this.x+r*s,this.y-h*s],[l,u]=t.toScreenNoRotation([0,0],n),{symbolTileSize:c}=this.tileData.symbolizerParameters,d=Math.round((this.width-this.tileData.offset[0])/c)*c,p=Math.round((this.height-this.tileData.offset[1])/c)*c;a(e,d/this.rangeX*i,0,0,0,p/this.rangeY*i,0,l,u,1),o(this.transforms.dvs,t.displayViewMat3,e),this.tileData.transforms.dvs=this.transforms.dvs}onAttach(){this.tileData.stage=this.stage}onDetach(){this.tileData.stage=null}}class ot extends N{constructor(){super(...arguments),this.isCustomTilingScheme=!1,this.symbolTypes=["triangle"]}createTile(t){const i=this._tileInfoView.getTileBounds(s(),t),[e,r]=this._tileInfoView.tileInfo.size;return new at(t,i[0],i[3],e,r)}destroyTile(){}prepareRenderPasses(t){const s=t.registerRenderPass({name:"imagery (vf tile)",brushes:[W],target:()=>this.children.map((t=>t.tileData)),drawPhase:q.MAP});return[...super.prepareRenderPasses(t),s]}doRender(t){this.visible&&t.drawPhase===q.MAP&&this.symbolTypes.forEach((s=>{t.renderPass=s,super.doRender(t)}))}}let ut=class extends rt{constructor(){super(...arguments),this._handle=null,this.container=null,this.layer=null,this.tileSize=null,this.type="rasterVF",this.useWebGLForProcessing=!0}canUseWebGLForProcessing(){return!1}async fetchTile(t,s){const i=await this.layer.fetchTile(t.level,t.row,t.col,s);return"vector-magdir"===this.layer.rasterInfo.dataType&&null!=i&&i.pixelBlock&&(i.pixelBlock=await this.layer.convertVectorFieldData(i.pixelBlock,s)),i}updateTileSource(t,s){const i=s.symbolizerParams,{tileData:e}=t;e.key=t.key,e.width=this.tileSize[0],e.height=this.tileSize[1];const{symbolTileSize:r}=i,{source:h}=s;if(e.offset=this._getTileSymbolOffset(e.key,r),l(h)&&l(h.pixelBlock))e.rawPixelData={extent:h.extent,pixelBlock:h.pixelBlock},e.source=this._sampleVectorFieldData(h.pixelBlock,i,e.offset),e.symbolizerParameters=i;else{const t=[Math.round((this.tileSize[0]-e.offset[0])/r),Math.round((this.tileSize[1]-e.offset[1])/r)],s=this.createEmptyTilePixelBlock(t);e.source=s,e.symbolizerParameters=i}return e.invalidateVAO(),Promise.resolve(null)}updateTileSymbolizerParameters(t,s){var i;const e=s.local,{symbolTileSize:r}=e,{tileData:h}=t;h.offset=this._getTileSymbolOffset(h.key,r);const n=h.symbolizerParameters.symbolTileSize;return h.symbolizerParameters=e,l(null==(i=h.rawPixelData)?void 0:i.pixelBlock)&&n!==r&&(h.source=this._sampleVectorFieldData(h.rawPixelData.pixelBlock,h.symbolizerParameters,h.offset)),Promise.resolve(null)}install(t,s){this.container=new ot(s.tileInfoView),this.container.isCustomTilingScheme=s.isCustomTilingScheme,this._updateSymbolType(this.layer.renderer),this._handle=this.layer.watch("renderer",(t=>this._updateSymbolType(t))),t.addChild(this.container)}uninstall(){this.container.removeAllChildren(),this._handle.remove(),this._handle=null,this.container.remove()}_getTileSymbolOffset(t,s){const i=t.col*this.tileSize[0]%s,e=t.row*this.tileSize[1]%s;return[i>s/2?s-i:-i,e>s/2?s-e:-e]}_sampleVectorFieldData(t,s,i){const{symbolTileSize:e}=s;return H(t,"vector-uv",e,i)}_updateSymbolType(t){"vector-field"===t.type&&(this.container.symbolTypes="wind-barb"===t.style?["scalar","triangle"]:"simple-scalar"===t.style?["scalar"]:["triangle"])}};e([r()],ut.prototype,"container",void 0),e([r()],ut.prototype,"layer",void 0),e([r()],ut.prototype,"tileSize",void 0),e([r()],ut.prototype,"type",void 0),e([r()],ut.prototype,"useWebGLForProcessing",void 0),ut=e([h("esri.views.2d.layers.imagery.VectorFieldTileView2D")],ut);const ct=ut,dt=t=>{let s=class extends t{constructor(){super(...arguments),this._rasterFieldPrefix="Raster.",this.layer=null,this.view=null,this.fullExtent=null,this.tileInfo=null,this.datumTransformation=null}get hasTilingEffects(){return this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment}async fetchPopupFeatures(t,s){const{layer:i}=this;if(!t)return Promise.reject(new c("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:i}));const{popupEnabled:e}=i,r=$(i,s);if(!e||!l(r))throw new c("imageryTileLayerView:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:e,popupTemplate:r});const h=[],{value:n,magdirValue:a}=await i.identify(t,{timeExtent:this.timeExtent});let o="";if(n&&n.length){var u,p;o="imagery-tile"===i.type&&i.hasStandardTime()&&null!=n[0]?n.map((t=>i.getStandardTimeValue(t))).join(", "):n.join(", ");const t={ObjectId:0},s="Raster.ServicePixelValue";t[s]=this._formatAttributeValue(o,s);const e=null==(u=i.rasterInfo)||null==(p=u.attributeTable)?void 0:p.features;if(e&&e.length>0){const s=e.filter((t=>String(t.attributes.value||t.attributes.Value||t.attributes.VALUE)===o));if(s.length>0){const i=s[0];if(i)for(const s in i.attributes)if(i.attributes.hasOwnProperty(s)){const e=this._rasterFieldPrefix+s;t[e]=this._formatAttributeValue(i.attributes[s],e)}}}const r=i.rasterInfo.dataType;"vector-magdir"!==r&&"vector-uv"!==r||(t["Raster.Magnitude"]=null==a?void 0:a[0],t["Raster.Direction"]=null==a?void 0:a[1]);const l=new d(this.fullExtent.clone(),null,t);l.layer=i,l.sourceLayer=l.layer,h.push(l)}return h}updateFullExtent(){const t=this.layer.tileInfo;if(!t||!t.spatialReference)return Promise.reject(new c("layerview:tiling-information-missing","The layer doesn't provide tiling information",{layer:this.layer}));if(p(this.layer.fullExtent))return Promise.reject(new c("layerview:extent-missing","The layer doesn't provide a full extent.",{layer:this.layer}));const s=G(this.layer.fullExtent,this.view.spatialReference,!1),i=k(this.layer.fullExtent,this.view.spatialReference,s);return null==i?Promise.reject(new c("layerview:projection-not-supported","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})):(this._set("fullExtent",i),this.datumTransformation||(this.datumTransformation=G(this.layer.fullExtent,this.view.spatialReference,!0)),Promise.resolve())}_formatAttributeValue(t,s){if("string"==typeof t){const i=this._getFieldInfo(this.layer.popupTemplate&&this.layer.popupTemplate.fieldInfos,s),e=i&&i.format;if(e){let s,i;return t.trim().indexOf(",")>-1?(s=",",i=s+" ",this._formatDelimitedString(t,s,i,e)):t.trim().indexOf(" ")>-1?(s=i=" ",this._formatDelimitedString(t,s,i,e)):this._formatNumberFromString(t,e)}}return t}_getFieldInfo(t,s){if(!t||!t.length||!s)return;const i=s.toLowerCase();let e;return t.some((t=>!(!t.fieldName||t.fieldName.toLowerCase()!==i&&t.fieldName.toLowerCase()!==i.replace(/ /g,"_")||(e=t,0)))),e}_formatDelimitedString(t,s,i,e){return t&&s&&i&&e?t.trim().split(s).map((t=>this._formatNumberFromString(t,e))).join(i):t}_formatNumberFromString(t,s){if(!t||!s)return t;const i=Number(t);return isNaN(i)?t:s.format(i)}};return e([r()],s.prototype,"layer",void 0),e([r(u)],s.prototype,"timeExtent",void 0),e([r()],s.prototype,"view",void 0),e([r()],s.prototype,"fullExtent",void 0),e([r()],s.prototype,"tileInfo",void 0),e([r({readOnly:!0})],s.prototype,"hasTilingEffects",null),s=e([h("esri.views.layers.ImageryTileLayerView")],s),s},pt=m.getLogger("esri.views.2d.layers.ImageryTileLayerView2D"),mt=[0,0];let ft=class extends(dt(tt(A(C)))){constructor(){super(...arguments),this._tileStrategy=null,this._tileInfoView=null,this._fetchQueue=null,this._blockCacheRegistryUrl=null,this._blockCacheRegistryId=null,this._srcResolutions=null,this._previousLOD=null,this._needBlockCacheUpdate=!1,this._globalSymbolizerParams=null,this._symbolizerParams=null,this._abortController=null,this._globalUpdateRequested=!1,this._isCustomTilingScheme=!1,this.subview=null,this._redrawOrRefetch=f(((t,s)=>this._previousLOD?t?this.doRefresh():this._redrawImage(s):Promise.resolve()))}initialize(){const t=this.updateFullExtent();this.addResolvingPromise(t)}get useWebGLForProcessing(){var t;return null==(t=this._get("useWebGLForProcessing"))||t}set useWebGLForProcessing(t){this.subview&&(this.subview.useWebGLForProcessing=t),this._set("useWebGLForProcessing",t)}get useProgressiveUpdate(){return null==this._get("useProgressiveUpdate")||this._get("useProgressiveUpdate")}set useProgressiveUpdate(t){if(this._tileStrategy&&this.useProgressiveUpdate!==t){var s;this._tileStrategy.destroy(),null==(s=this.subview)||s.container.removeAllChildren();const i=this._getCacheSize(t);this._tileStrategy=new y({cachePolicy:"purge",acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),cacheSize:i,tileInfoView:this._tileInfoView}),this._set("useProgressiveUpdate",t),this.requestUpdate()}}hitTest(t,s){if(this.suspended)return Promise.resolve(null);const i=this.view.toMap(b(t,s));return Promise.resolve(new d({attributes:{},geometry:i}))}update(t){this._fetchQueue.pause(),this._fetchQueue.state=t.state,this._tileStrategy.update(t),this._fetchQueue.resume();const{extent:s,resolution:i,scale:e}=t.state,r=this._tileInfoView.getClosestInfoForScale(e);if(this.layer.raster){var h;if(!this.useProgressiveUpdate||this._needBlockCacheUpdate){const t=this._srcResolutions[r.level],e=s.toJSON?s:g.fromJSON(s);z(this._blockCacheRegistryUrl,this._blockCacheRegistryId,e,i,t,this.layer.raster.ioConfig.sampling)}this._needBlockCacheUpdate=!1,(null==(h=this._previousLOD)?void 0:h.level)!==r.level&&(this._previousLOD=r,null==this._symbolizerParams||this.hasTilingEffects||this._updateSymbolizerParams(),this._tileStrategy.updateCacheSize(0))}this.notifyChange("updating")}attach(){this.layer.increaseRasterJobHandlerUsage(),v().supportsTextureFloat||(this.useWebGLForProcessing=!1),this._initializeTileInfo(),this._tileInfoView=new w(this.tileInfo,this.fullExtent);const t=this._computeFetchConcurrency();this._fetchQueue=new T({tileInfoView:this._tileInfoView,concurrency:t,process:(t,s)=>this.fetchTile(t,s)});const s=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy=new y({cachePolicy:"purge",acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),cacheSize:s,tileInfoView:this._tileInfoView}),this._updatesubview(),this.handles.add([P(this.layer,["bandIds","renderer","interpolation","multidimensionalDefinition"],((t,s,i)=>{const e="multidimensionalDefinition"===i,r="interpolation"===i&&("majority"===t||"majority"===s)&&this._canUseMajorityInterpolationOnDataSource(),h="renderer"===i&&"vector-field"===s.type!=("vector-field"===t.type);h&&this._updatesubview(),this._redrawOrRefetch(e||r||h).catch((t=>{_(t)||pt.error(t)}))})),x(this,["layer.blendMode"],(t=>{this.subview&&(this.subview.container.blendMode=t)}),!0),x(this,["layer.effect"],(t=>{this.subview&&(this.subview.container.effect=t)}),!0),x(this,"timeExtent",(()=>{this._redrawOrRefetch(!0).catch((t=>{_(t)||pt.error(t)}))}))],"attach"),this._updateBlockCacheRegistry()}detach(){var t;this.handles.remove("attach"),this.layer.decreaseRasterJobHandlerUsage(),null==(t=this.subview)||t.uninstall(),this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null,V(this._blockCacheRegistryUrl,this._blockCacheRegistryId)}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){!this.hasTilingEffects&&this.useProgressiveUpdate||(this._abortController&&this._abortController.abort(),this._abortController=new AbortController,0===this._fetchQueue.length&&this._redrawImage(this._abortController.signal).then((()=>{this._globalUpdateRequested=!1,this.requestUpdate()})));const t=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy.updateCacheSize(t),this.requestUpdate()}createFetchPopupFeaturesQueryGeometry(t,s){return st(t,s,this.view)}async doRefresh(){if(this.suspended)return;await this.layer.updateRenderer(),this.hasTilingEffects||this._updateSymbolizerParams(),this._updateBlockCacheRegistry(!0),this._fetchQueue.reset();const t=[];this._tileStrategy.tiles.forEach((s=>t.push(this._enqueueTileFetch(s)))),await S(t),this.notifyChange("updating")}isUpdating(){return this._fetchQueue.length>0||this._globalUpdateRequested}acquireTile(t){const s=this.subview.container.createTile(t);return this._enqueueTileFetch(s),this.requestUpdate(),this._needBlockCacheUpdate=!0,this._globalUpdateRequested=this.hasTilingEffects||!this.useProgressiveUpdate,s}releaseTile(t){var s;this._fetchQueue.abort(t.key.id),null==(s=this.subview)||s.container.removeChild(t),t.once("detach",(()=>{t.destroy(),this.requestUpdate()})),this.requestUpdate()}fetchTile(t,s){const i=!p(s)&&s.signal,e=this.subview.canUseWebGLForProcessing(),r={allowPartialFill:!0,datumTransformation:this.datumTransformation,interpolation:e?"nearest":this.layer.interpolation,registryId:this._blockCacheRegistryId,requestRawData:e,signal:I(i),srcResolution:this._srcResolutions[t.level],timeExtent:this.timeExtent,tileInfo:this.tileInfo};return this.subview.fetchTile(t,r)}_updatesubview(){const t=this._isVectorField()?"rasterVF":"raster";if(this.subview){if(this.subview.type===t)return;this.subview.uninstall()}const{layer:s}=this;this._tileStrategy.clear();const i=new("rasterVF"===t?ct:nt)({layer:s,tileSize:this.tileInfo.size,useWebGLForProcessing:this.useWebGLForProcessing});i.install(this.container,{tileInfoView:this._tileInfoView,isCustomTilingScheme:this._isCustomTilingScheme}),i.container.blendMode=s.blendMode,i.container.effect=s.effect,this.subview=i}_isVectorField(){return"vector-field"===this.layer.renderer.type}_getCacheSize(t){return t?40:0}_initializeTileInfo(){const t=this.view.spatialReference,s=new j({x:this.fullExtent.xmin,y:this.fullExtent.ymax,spatialReference:t}),{scales:i,srcResolutions:e,isCustomTilingScheme:r}=U(this.layer.rasterInfo,t),h=F.create({spatialReference:t,size:512,scales:i});(0===h.origin.x||h.origin.x>s.x)&&(h.origin=s),this._isCustomTilingScheme=r,this._set("tileInfo",h),this._srcResolutions=null!=e?e:[]}_computeFetchConcurrency(){const{blockBoundary:t}=this.layer.rasterInfo.storageInfo,s=t[t.length-1];return(s.maxCol-s.minCol+1)*(s.maxRow-s.minRow+1)>64?2:10}async _enqueueTileFetch(t,s){if(!this._fetchQueue.has(t.key.id)){try{const s=await this._fetchQueue.push(t.key),{bandIds:i}=this.layer;let e=!this.useProgressiveUpdate||this.hasTilingEffects&&!this._globalSymbolizerParams;if(this._globalUpdateRequested&&!this.moving&&0===this._fetchQueue.length){e=!1;try{await this._redrawImage(this._abortController&&this._abortController.signal)}catch(t){_(t)&&pt.error(t)}this._globalUpdateRequested=!1}!this.subview.canUseWebGLForProcessing()&&!this._isVectorField()||this.hasTilingEffects||null!=this._symbolizerParams||this._updateSymbolizerParams();const r=this._tileInfoView.getTileCoords(mt,t.key),h=this._tileInfoView.getTileResolution(t.key);await this.subview.updateTileSource(t,{source:s,symbolizerParams:this._symbolizerParams,globalSymbolizerParams:this._globalSymbolizerParams,suspended:e,bandIds:i,coords:r,resolution:h}),t.once("attach",(()=>this.requestUpdate())),this.subview.container.addChild(t)}catch(t){_(t)||pt.error(t)}this.requestUpdate()}}async _redrawImage(t){if(0===this.subview.container.children.length)return;await this.layer.updateRenderer(),this.hasTilingEffects?await this._updateGlobalSymbolizerParams(t):(this._updateSymbolizerParams(),this._globalSymbolizerParams=null);const s=this.subview.container.children.map((async t=>this.subview.updateTileSymbolizerParameters(t,{local:this._symbolizerParams,global:this._globalSymbolizerParams})));await S(s),this.container.requestRender()}async _updateGlobalSymbolizerParams(t){const s={srcResolution:this._srcResolutions[this._previousLOD.level],registryId:this._blockCacheRegistryId,signal:t},i=await this.layer.fetchPixels(this.view.extent,this.view.width,this.view.height,s);if(!i||!i.pixelBlock)return;const e=this.layer.symbolizer.generateWebGLParameters({pixelBlock:E(i.pixelBlock,this.layer.bandIds),isGCS:this.view.spatialReference.isGeographic,resolution:{x:this._previousLOD.resolution,y:this._previousLOD.resolution},bandIds:this.layer.bandIds});!this.subview.canUseWebGLForProcessing()&&e&&"stretch"===e.type&&this.layer.renderer&&"raster-stretch"===this.layer.renderer.type&&(e.factor=e.factor.map((t=>255*t)),e.outMin=Math.round(255*e.outMin),e.outMax=Math.round(255*e.outMax)),this._globalSymbolizerParams=e}_updateSymbolizerParams(){this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null,isGCS:this.view.spatialReference.isGeographic,resolution:{x:this._previousLOD.resolution,y:this._previousLOD.resolution},bandIds:this.layer.bandIds})}_updateBlockCacheRegistry(t=!1){const{url:s,rasterInfo:i,raster:e}=this.layer,{multidimensionalDefinition:r}=this.layer.normalizeRasterFetchOptions({multidimensionalDefinition:this.layer.multidimensionalDefinition,timeExtent:this.timeExtent}),h=null!=i&&i.multidimensionalInfo?e.getSliceIndex(r):null,n=R(s,h);if(n!==this._blockCacheRegistryUrl){if(null!=this._blockCacheRegistryUrl&&V(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryId=D(n,this.layer.raster.rasterInfo),t){const t=this._tileInfoView.getClosestInfoForScale(this.view.scale);z(n,this._blockCacheRegistryId,this.view.extent,this.view.resolution,this._srcResolutions[t.level],this.layer.raster.ioConfig.sampling)}this._blockCacheRegistryUrl=n}}_canUseMajorityInterpolationOnDataSource(){const{bandCount:t,attributeTable:s,colormap:i,pixelType:e}=this.layer.rasterInfo;return 1===t&&(null!=s||null!=i||"u8"===e||"s8"===e)}};e([r()],ft.prototype,"subview",void 0),e([r()],ft.prototype,"useWebGLForProcessing",null),e([r()],ft.prototype,"useProgressiveUpdate",null),ft=e([h("esri.views.2d.layers.ImageryTileLayerView2D")],ft);const yt=ft;export default yt;