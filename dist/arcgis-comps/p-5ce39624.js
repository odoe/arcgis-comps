import{c as t,D as s,b as e,aZ as i,Q as r,s as o,A as n,e as a,d as l,a3 as p,i as c}from"./p-e58503d5.js";import{h as f}from"./p-e273719b.js";import{e as u}from"./p-e9bae5e9.js";import{b as h,a as m,n as d}from"./p-765e6c28.js";import{v as y,p as b}from"./p-dbdf15fc.js";import{d as j}from"./p-8bc9b36a.js";import"./p-53bb6ab4.js";import"./p-74de0937.js";import"./p-2f398ed1.js";import"./p-d3105731.js";import"./p-b0565d49.js";import"./p-b79fcce3.js";import"./p-e0d9ff4c.js";import"./p-a9a30646.js";import"./p-08e5f531.js";import"./p-fb38a9d0.js";import"./p-dfc6337f.js";import"./p-9f1c2d50.js";import"./p-54330161.js";import"./p-93765525.js";import"./p-8747982c.js";import"./p-c048b814.js";import"./p-6b2eb7a7.js";import"./p-01e5a461.js";import"./p-7a658388.js";import"./p-f94762ac.js";import"./p-ea916a39.js";import"./p-8a919d07.js";import"./p-efbca0ca.js";var w;const g=t.getLogger("esri.renderers.DictionaryRenderer"),S={type:"CIMSimpleLineCallout",lineSymbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",width:.5,color:[0,0,0,255]}]}};let v=w=class extends(y(b)){constructor(t){super(t),this._ongoingRequests=new Map,this._symbolCache=new u(100),this.config=null,this.fieldMap=null,this.scaleExpression=null,this.scaleExpressionTitle=null,this.url=null,this.type="dictionary"}writeData(t,s){t&&(s.scalingExpressionInfo={expression:t,returnType:"number"})}writeVisualVariables(t,s,e,i){null!=i&&i.origin||super.writeVisualVariables(t,s,e,i)}clone(){return new w({config:s(this.config),scaleExpression:this.scaleExpression,scaleExpressionTitle:this.scaleExpressionTitle,fieldMap:s(this.fieldMap),url:s(this.url),visualVariables:s(this.visualVariables)})}async getSymbolAsync(t,s){let r;this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(s));try{r=await this._dictionaryPromise}catch(t){if(e(t))return this._dictionaryPromise=null,null}const o={};if(this.fieldMap)for(const s of this._symbolFields){const e=this.fieldMap[s];o[s]=e&&null!=t.attributes[e]?""+t.attributes[e]:""}const a=r(o,s);if(!a||"string"!=typeof a)return null;const l=i(a).toString(),p=this._symbolCache.get(l);if(p)return p.catch((()=>{this._symbolCache.pop(l)})),p;const c=a.split(";"),u=[],h=[];for(const t of c)if(t&&0!==t.length)if(-1===t.indexOf("po:"))if(-1!==t.indexOf("|")){for(const s of t.split("|"))if(this._itemNames.has(s)){u.push(s);break}}else this._itemNames.has(t)&&u.push(t);else{const s=t.substr(3).split("|");if(3===s.length){const t=s[0],e=s[1];let i=s[2];if("DashTemplate"===e)i=i.split(" ").map((t=>Number(t)));else if("Color"===e){const t=new f(i).toRgba();i=[t[0],t[1],t[2],255*t[3]]}else i=Number(i);h.push({primitiveName:t,propertyName:e,value:i})}}const m=!n(t.geometry)||!t.geometry.hasZ&&"point"===t.geometry.type,d=this._cimPartsToCIMSymbol(u,h,m,s);return this._symbolCache.put(l,d,1),d}async collectRequiredFields(t,s){await this.collectVVRequiredFields(t,s),this.scaleExpression&&await h(t,s,this.scaleExpression);for(const e in this.fieldMap){const i=this.fieldMap[e];s.has(i)&&t.add(i)}}get arcadeRequired(){return!0}async fetchResources(t){if(this._dictionaryPromise)return this._dictionaryPromise;if(!this.url)return void g.error("no valid URL!");const s=n(t)?t.abortOptions:null,e=r(this.url+"/resources/styles/dictionary-info.json",{responseType:"json",query:{f:"json"},...s}),[{data:i}]=await Promise.all([e,m()]);if(!i)throw this._dictionaryPromise=null,new o("esri.renderers.DictionaryRenderer","Bad dictionary data!");const a=i.expression,l=i.authoringInfo;this._refSymbolUrlTemplate=this.url+"/"+i.cimRefTemplateUrl,this._itemNames=new Set(i.itemsNames),this._symbolFields=l.symbol;const p={};if(this.config){const t=this.config;for(const s in t)p[s]=t[s]}if(l.configuration)for(const t of l.configuration)p.hasOwnProperty(t.name)||(p[t.name]=t.value);const c=[];if(n(t)&&t.fields&&this.fieldMap)for(const s of this._symbolFields){const e=this.fieldMap[s],i=t.fields.filter((t=>t.name===e));i.length>0&&c.push({...i[0],name:s})}return this._dictionaryPromise=d(a,n(t)?t.spatialReference:null,c,p).then((t=>{const s={scale:0};return(e,i)=>{const r=t.repurposeFeature({geometry:null,attributes:e});return s.scale=n(i)?i.scale:void 0,t.evaluate({$feature:r,$view:s})}})).catch((t=>(g.error("Creating dictinoary expression failed:",t),null))),this._dictionaryPromise}getSymbol(){return null}getSymbols(){return[]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce(((t,s)=>t+s.getAttributeHash()),"")}getMeshHash(){return`${this.url}-${JSON.stringify(this.fieldMap)}`}getSymbolFields(){return this._symbolFields}async _getSymbolPart(t,s){if(this._ongoingRequests.has(t))return this._ongoingRequests.get(t).then((t=>t.data));const e=this._refSymbolUrlTemplate.replace(/\{itemName\}/gi,t),i=r(e,{responseType:"json",query:{f:"json"},...s});this._ongoingRequests.set(t,i);try{return(await i).data}catch(s){return this._ongoingRequests.delete(t),Promise.reject(s)}}_combineSymbolParts(t,s,e){if(!t||0===t.length)return null;const i={...t[0]};if(t.length>1){i.symbolLayers=[];for(const s of t)i.symbolLayers.unshift(...s.symbolLayers)}return e&&(i.callout=S),{type:"CIMSymbolReference",symbol:i,primitiveOverrides:s}}async _cimPartsToCIMSymbol(t,s,e,i){const r=new Array(t.length);for(let s=0;s<t.length;s++)r[s]=this._getSymbolPart(t[s],i);const o=await Promise.all(r);return new j({data:this._combineSymbolParts(o,s,e)})}};a([l({type:Object,json:{read:{source:"configuration"},write:{target:"configuration"}}})],v.prototype,"config",void 0),a([l({type:Object,json:{write:!0}})],v.prototype,"fieldMap",void 0),a([l({type:String,json:{read:{source:"scalingExpressionInfo.expression"},write:!0}})],v.prototype,"scaleExpression",void 0),a([p("scaleExpression")],v.prototype,"writeData",null),a([l({type:String,json:{read:{source:"scalingExpressionInfo.title"},write:{target:"scalingExpressionInfo.title",overridePolicy(t){return{enabled:!!t&&!!this.scaleExpression}}}}})],v.prototype,"scaleExpressionTitle",void 0),a([l({type:String,json:{write:!0}})],v.prototype,"url",void 0),a([p("visualVariables")],v.prototype,"writeVisualVariables",null),v=w=a([c("esri.renderers.DictionaryRenderer")],v);const x=v;export default x;