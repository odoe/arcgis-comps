import{a0 as e,A as t,e as s,d as r,i,p as u,af as n,h as a,ax as o,ai as h,a as l,bU as c,s as d}from"./p-e58503d5.js";import{aV as m}from"./p-340cd100.js";import{U as y,E as p,S as f,s as g}from"./p-d7e4c9b1.js";import{p as F}from"./p-cbbdb7db.js";import{z as v}from"./p-3bcc4805.js";import{g as b,y as w}from"./p-9087b4d3.js";import{h as x}from"./p-54330161.js";import{n as O}from"./p-e9596294.js";import{y as M}from"./p-a131049b.js";import{t as D}from"./p-7de54cd0.js";import{O as q}from"./p-0d085df1.js";import{u as j}from"./p-a63f7978.js";import{i as T}from"./p-07ab8db5.js";class C{constructor(e){this._schedule=e,this._handle=new P(e)}destroy(){this._handle.destroy()}invoke(s,r){return s.buffer&&0!==s.buffer.byteLength?(s.options.sourceSpatialReference&&s.options.sourceSpatialReference instanceof e&&(s.options={...s.options,sourceSpatialReference:s.options.sourceSpatialReference.toJSON()}),this._handle.invoke(s,r).then((s=>this._schedule((()=>{if(s.spatialReference=e.fromJSON(s.spatialReference),s.fields)for(let e=0;e<s.fields.length;e++)s.fields[e]=M.fromJSON(s.fields[e]);const r=s.spatialReference;for(const e of s.features)e.uid=x.generateUID(),t(e.geometry)&&(e.geometry.spatialReference=r);return s}))))):Promise.resolve(null)}}class P extends O{constructor(e){super("PBFDecoderWorker","_parseFeatureQuery",e)}getTransferList(e){return[e.buffer]}}let Q=class extends u{constructor(e){super(e)}get queryFeaturesDehydrated(){const e=this.layer.capabilities,s=e&&e.query;if(s&&s.supportsFormatPBF){var r,i;n(this._decoder)&&(this._decoder=new C(this.schedule));const e={sourceSpatialReference:null!=(r=null==(i=this.layer.spatialReference)?void 0:i.toJSON())?r:null,applyTransform:!0,maxStringAttributeLength:1024};return(s,r)=>b(this.layer.parsedUrl,s,"pbf",this._createRequestOptions(r)).then((s=>(a(r),t(this._decoder)?this._decoder.invoke({buffer:s.data,options:e},r.signal):Promise.reject(o()))))}return(e,t)=>w(this.layer.parsedUrl,e,this.layer.spatialReference,this._createRequestOptions(t)).then((e=>v(e.data)))}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}destroy(){this._decoder=h(this._decoder)}_createRequestOptions(e){return{...e,query:{...this.layer.customParameters,token:this.layer.apiKey,...null==e?void 0:e.query}}}};s([r({constructOnly:!0})],Q.prototype,"layer",void 0),s([r({constructOnly:!0})],Q.prototype,"schedule",void 0),s([r({readOnly:!0})],Q.prototype,"queryFeaturesDehydrated",null),Q=s([i("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],Q);let N=class extends u{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.layer.queryFeatures(e,t)}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}};s([r({constructOnly:!0})],N.prototype,"layer",void 0),s([r({readOnly:!0})],N.prototype,"queryFeaturesDehydrated",null),N=s([i("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceMeshQuery3D")],N);let R=class extends u{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.layer.queryFeatures(e,t)}};s([r({constructOnly:!0})],R.prototype,"layer",void 0),R=s([i("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],R);let S=class extends u{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.source.queryFeaturesJSON(e,t).then(v,(s=>{if(s&&"query-features-json:unsupported"===s.name)return this.layer.queryFeatures(e,t);throw s}))}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}};function V(e,s){return"feature"===e.type&&"feature-layer"===e.source.type?t(e.infoFor3D)?new N({layer:e}):new Q({layer:e,schedule:s}):"feature"===e.type&&"memory"===e.source.type||"csv"===e.type||"geojson"===e.type||"wfs"===e.type?new S({layer:e,source:e.source}):"ogc-feature"===e.type?new R({layer:e}):null}s([r({constructOnly:!0})],S.prototype,"layer",void 0),s([r({constructOnly:!0})],S.prototype,"source",void 0),S=s([i("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],S);class E{constructor(e){this._memoryCache=null,this._capabilities=null;const t=e.layerView.layer;this.layerView=e.layerView,this.objectIdField=t.objectIdField,this.globalIdField="globalIdField"in t?t.globalIdField:null,this.returnZ=e.returnZ,this.returnM=e.returnM;const s=this.layerView.view.resourceController;this.query=V(t,(e=>s.schedule(e))),s&&this.memoryCacheEnabled&&(this._memoryCache=s.memoryController.newCache(t.uid))}get memoryCacheEnabled(){switch(this.layerView.layer.source.type){case"feature-layer":case"ogc-feature":return!0;case"csv":case"geojson":case"memory":case"wfs":return!1}}destroy(){this._memoryCache=h(this._memoryCache),this.query.destroy()}createQuery(){const e=this.layerView.layer.createQuery();return e.outFields=this.layerView.availableFields,e.returnZ=this.returnZ,e.returnM=this.returnM,e.outSpatialReference=this.tilingScheme.spatialReference,e}get memoryCache(){return this._memoryCache}get viewingMode(){return this.layerView.view.state.viewingMode}get tilingScheme(){return this.layerView.view.featureTiles.tilingScheme}get scheduler(){const e=this.layerView.view.resourceController;return e?e.scheduler:null}get geometryType(){return this.layerView.layer.geometryType}get fullExtent(){return this.layerView.layer.fullExtent}get tileMaxRecordCount(){return this.layerView.layer.capabilities.query.tileMaxRecordCount}get maxRecordCount(){return this.layerView.layer.capabilities.query.maxRecordCount}get capabilities(){return t(this._capabilities)||(this._capabilities=y(this.layerView.layer)),this._capabilities}logFetchError(e,t){e.error("#fetchTile()",this.layerView.layer,t&&t.message?t.message:t)}}let L=class extends(T(p(q(F(j))))){constructor(e){super(e),this._controllerTotal=0,this._graphicsCoreTotal=0,this.suspendResumeExtentMode="data"}initialize(){this.updatingHandles.add(this,"view.floors",(()=>this.graphics3d.filterVisibility.filterChanged()))}destroy(){this.fetcherContext&&(this.fetcherContext.destroy(),this.fetcherContext=null)}get maximumNumberOfFeatures(){var e,t;return null!=(e=null==(t=this.controller)?void 0:t.maximumNumberOfFeatures)?e:this._get("maximumNumberOfFeatures")}set maximumNumberOfFeatures(e){this._set("maximumNumberOfFeatures",e),this.controller&&(this.controller.maximumNumberOfFeatures=e)}get maximumNumberOfFeaturesExceeded(){return!!this.controller&&!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded)}get updatingProgressValue(){var e,t,s;let r=0;if(null!=(e=this.controller)&&e.updating){const e=this.controller.updatingRemaining,t=Math.max(this.controller.updatingTotal,this._controllerTotal);t>0&&(r=(t-e)/t,this._controllerTotal=t)}let i=0;if(null!=(t=this.graphics3d)&&null!=(s=t.graphicsCore)&&s.updating){const e=this.graphics3d.graphicsCore.updatingRemaining,t=Math.max(e,this._graphicsCoreTotal);t>0&&(i=(t-e)/t,this._graphicsCoreTotal=t)}return.5*(r+i)}get updatePolicy(){if(!this.controller)return 0;switch(this.controller.mode){case"snapshot":{const e=Z[this.layer.geometryType];return null==e||this.controller.serviceDataCount>e?0:1}case"tiles":return 0}}get hasZ(){const e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsZ)&&("returnZ"in e&&null!=e.returnZ?e.returnZ:t.supportsZ)}get hasM(){const e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsM)&&"returnM"in e&&null!=e.returnM&&e.returnM}async fetchPopupFeatures(e,t){const s=this.validateFetchPopupFeatures(t);return s?Promise.reject(s):this.fetchClientPopupFeatures(t)}setVisibility(e,t){this.graphics3d&&this.graphics3d.graphicsCore.setObjectIdVisibility(e,t)}createQuery(){return super.createQuery()}queryFeatures(e,t){const s=()=>super.queryFeatures(e,t);return"mesh"===this.layer.geometryType?this._queryFeaturesMesh(this._ensureQuery(e),s):s()}beforeSetController(e){e.maximumNumberOfFeatures=this.maximumNumberOfFeatures}createController(){this.fetcherContext=new E({layerView:this,returnZ:this.hasZ,returnM:this.hasM});const e=new f({layerView:this,context:this.fetcherContext,graphics:new g,extent:this.clippingExtent});return this.updatingHandles.add(e,"serviceDataExtent",(e=>{this.graphics3d&&(this.graphics3d.dataExtent=e)}),2),this.handles.add(l(this,"suspended",(t=>{t?e.suspend():e.resume()}),!0)),this.updatingHandles.add(this.graphics3d.graphicsCore,"displayFeatureLimit",(()=>this.updateDisplayFeatureLimit(e)),2),this.handles.add([this.view.resourceController.memoryController.events.on("quality-changed",(()=>this.updateDisplayFeatureLimit())),c(this,"updating",(()=>{this._controllerTotal=0,this._graphicsCoreTotal=0,this.notifyChange("updatingProgressValue")}))]),e}async doRefresh(){!this.suspended&&this.controller&&this.controller.refetch()}getUsedMemory(){const e=this.graphics3d&&this.graphics3d.graphicsCore;return(e?e.usedMemory:0)+(this.controller?this.controller.memoryForUnusedFeatures:0)}getUnloadedMemory(){const e=this.graphics3d&&this.graphics3d.graphicsCore;return(e?e.unprocessedMemoryEstimate:0)+(this.controller?this.controller.expectedFeatureDiff*e.usedMemoryPerGraphic:0)}ignoresMemoryFactor(){return this.controller&&this.controller.hasMaximumNumberOfFeaturesOverride}updateDisplayFeatureLimit(e=this.controller){if(!e||!this.graphics3d||!this.graphics3d.graphicsCore)return;const t=this.graphics3d.graphicsCore.displayFeatureLimit,s=this.view.resourceController.memoryController.memoryFactor;if(1===s)e.displayFeatureLimit=t;else{const r=Math.ceil(t.maximumNumberOfFeatures*s),i=Math.ceil(t.maximumTotalNumberOfFeatures*s),u=Math.ceil(t.minimumTotalNumberOfFeatures*s);e.displayFeatureLimit={...t,maximumNumberOfFeatures:r,maximumTotalNumberOfFeatures:i,minimumTotalNumberOfFeatures:u}}}async _queryFeaturesMesh(e,t){await this._validateQueryFeaturesMesh(e);const s=await t();if(e&&e.outStatistics)return s;const r=this.layer.objectIdField,i=this.graphics3d.graphicsCore.graphics3DGraphicsByObjectID,u=[];for(const e of s.features)if(e.geometry){const t=i.get(e.attributes[r]);t&&(e.geometry=m(t.graphic.geometry),u.push(e))}else u.push(e);return s.features=u,s}async _validateQueryFeaturesMesh(e){if(!e)return;const s=e=>{throw new d("feature-layer-view:unsupported-query",`Queries on Mesh feature collection layers do not support '${e}'`)},r=["quantizationParameters","geometryPrecision","maxAllowableOffset"];for(const t of r)null!=e[t]&&s(t);"returnM"in e&&e.returnM&&s("returnM"),"returnCentroid"in e&&e.returnCentroid&&s("returnCentroid"),t(e.outSpatialReference)&&!e.outSpatialReference.equals(this.view.spatialReference)&&s("outSpatialReference")}get performanceInfo(){const e=this.controller&&this.controller.displayFeatureLimit,s=t(e)&&e.averageSymbolComplexity,r=t(s)?`f:${s.primitivesPerFeature},v:${s.primitivesPerCoordinate}`:"n/a",i={...this._getResourceInfo(),storedFeatures:0,totalVertices:0,partial:this.maximumNumberOfFeaturesExceeded,mode:this.controller?this.controller.mode:"n/a",symbolComplexity:r,nodes:this.controller?this.controller.tileDescriptors.length:0};if(this.controller&&i.displayedNumberOfFeatures){const e=this.controller.debug;i.storedFeatures=e.storedFeatures,i.totalVertices=e.totalVertices}return i}get test(){return{updatePolicy:this.updatePolicy,controller:this.controller}}};s([r()],L.prototype,"layer",void 0),s([r()],L.prototype,"controller",void 0),s([r()],L.prototype,"maximumNumberOfFeatures",null),s([r()],L.prototype,"maximumNumberOfFeaturesExceeded",null),s([r(D)],L.prototype,"updatingProgress",void 0),s([r({readOnly:!0,dependsOn:["controller.updatingRemaining","controller.updatingTotal","graphics3d.graphicsCore.updatingRemaining"]})],L.prototype,"updatingProgressValue",null),s([r({readOnly:!0})],L.prototype,"updatePolicy",null),s([r({readOnly:!0})],L.prototype,"hasZ",null),s([r({readOnly:!0})],L.prototype,"hasM",null),s([r()],L.prototype,"suspendResumeExtentMode",void 0),L=s([i("esri.views.3d.layers.FeatureLayerViewBase3D")],L);const Z={point:5e3,polygon:500,polyline:1e3},_=L;export{_ as x}