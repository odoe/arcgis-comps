import{m as t,c as s,Q as i,b as e,A as n,bo as r}from"./p-e58503d5.js";import{J as h,a as o,o as a,d as l,z as c,u,e as d,q as f}from"./p-2f398ed1.js";import{i as m}from"./p-5d962998.js";import{n as p}from"./p-d3105731.js";import{j as y}from"./p-728dcbb0.js";function v(s){return t(`esri/libs/vxl/${s}`)}const g=s.getLogger("esri.layers.VoxelWasmPerScene");class b{constructor(t){this._halfIntTexturesAvailable=!1,this._useDepthPass=!1,this._havePreparedWithAllLayers=!1,this._renderPluginContext=null,this._vxl=null,this._pluginIsActive=!1,this._moreToLoad=!1,this._viewportWidth=-1,this._viewportHeight=-1,this._newLayers=[],this._layers=new Map,this._renderPass=0,this._renderSlot=3,this._rctx=null,this._renderTargetToRestore=null,this._wasmMemBlockSizes=[512,1024,2048,4096,8192,16384,32768,65536],this._wasmMemBlocks=new Map,this._dbgFlags=new Set,this._dbgFlags.add(4),this._view=t,this.initialize()}get canRender(){return!!this._vxl&&"local"===this._view.viewingMode}dbg(t,s){this._dbgFlags.has(t)&&(4===t?g.error(s):g.warn(s))}removeRenderPlugin(){this._pluginIsActive&&this._view._stage&&(this.dbg(1,"--removeRenderPlugin--"),this._view._stage.removeRenderPlugin(this)),this._pluginIsActive=!1}initialize(){this.dbg(1,"--initialize--");for(const t of this._wasmMemBlockSizes)this._wasmMemBlocks.set(t,0);this._readyWatchHandle=m((()=>this._view.ready),(t=>{t&&"local"===this._view.viewingMode?(this.dbg(1,"view ready status changed to ready on a local view, calling addRenderPlugin"),this._view._stage.addRenderPlugin([this._renderSlot],this),this._pluginIsActive=!0):(this.dbg(1,"view ready status changed, not ready or not a local view!"),this.removeRenderPlugin())}),{initial:!0}),this._qualityWatchHandle=m((()=>{var t;return null==(t=this._view)?void 0:t.qualityProfile}),(t=>{this.dbg(3,"qualityProfile changed to "+t),this._vxl&&this._vxl.set_quality(this.toWasmQuality(t))}),{initial:!0}),this._timeExtentWatchHandle=m((()=>{var t;return null==(t=this._view)?void 0:t.timeExtent}),(()=>{if(this._vxl){var t;const s=this._getTimeArgs(null==(t=this._view)?void 0:t.timeExtent);this.dbg(3,"sceneView timeExtent changed to useTime="+s.useTime+" st="+s.startTime+" et="+s.endTime),this._vxl.set_scene_time_extent(s.startTime,s.endTime,s.useTime),this._renderPluginContext.requestRender()}}),{initial:!0})}initializeRenderContext(t){this.dbg(1,"--initializeRenderContext--");const s=t.renderContext.rctx;"webgl2"===s.webglVersion?(this._renderPluginContext=t,this._rctx=t.renderContext.rctx,this._halfIntTexturesAvailable=!!this._rctx.capabilities.textureNorm16,this.initializeWasm(s.gl)):this.dbg(4,"WebGL 1 context only!")}uninitializeRenderContext(){this._renderPluginContext=null,this._rctx=null,this.dbg(1,"--uninitializeRenderContext--")}restoreFramebuffer(){if(!this._renderTargetToRestore)return;const t=this._renderTargetToRestore.fbo;if(!this._rctx)return void this.dbg(4,"no context in restoreFramebuffer!");this._rctx.bindFramebuffer(t,!0);const s=this._renderTargetToRestore.viewport;this._rctx.setViewport(s.x,s.y,s.width,s.height)}bindPreviousDepthToSlot(t,s){if(!this._rctx||!this._renderTargetToRestore)return 0;const i=this._renderTargetToRestore.fbo.depthStencilTexture;return i?(this._rctx.bindTexture(0===s?null:i,t,!0),1):(this.dbg(4,"no depth/stencil texture exists!"),0)}setBlendState(t,s,i,e){this._rctx?(this._rctx.setBlendingEnabled(1===t),this._rctx.setBlendFunction(s,i),this._rctx.setBlendEquation(e)):this.dbg(4,"setBlendState callback has no rendering context!")}setFrontFace(t){this._rctx?this._rctx.setFrontFace(t):this.dbg(4,"setFrontFace callback has no rendering context!")}setDepthStencilStateFunction(t,s,i){this._rctx?(this._rctx.setDepthFunction(i),this._rctx.setDepthTestEnabled(1===t),this._rctx.setDepthWriteEnabled(1===s),this._rctx.setStencilTestEnabled(!1),this._rctx.setStencilFunction(519,0,255),this._rctx.setStencilOpSeparate(1028,7680,7682,7680),this._rctx.setStencilOpSeparate(1029,7680,7683,7680)):this.dbg(4,"setDepthStencilStateFunction callback has no rendering context!")}setRasterizerState(t){if(this._rctx)switch(t){case 1:this._rctx.setFaceCullingEnabled(!1);break;case 3:this._rctx.setCullFace(1029),this._rctx.setFaceCullingEnabled(!0);break;case 2:this._rctx.setCullFace(1028),this._rctx.setFaceCullingEnabled(!0)}else this.dbg(4,"setRasterizerState callback has no rendering context!")}setViewport(t,s,i,e){this._rctx?this._rctx.setViewport(t,s,i,e):this.dbg(4,"setViewport callback has no rendering context!")}_syncRequestsResponses(){this._layers.forEach(((t,s)=>{const n=[];t.responses.forEach(((t,i)=>{n.push(i),this.dbg(2,"responding for requestID:"+i+" size:"+t.size),this._vxl.respond(s,i,t)}));const r=t.responses;for(const t of n)r.delete(t);const h=this._vxl.get_new_requests(s),o=t.abortController.signal;for(const s in h){t.outstandingRequestCount+=1,1===t.outstandingRequestCount&&t.layerView.updatingFlagChanged();const n=h[s],a={responseType:"array-buffer",signal:o};this.dbg(2,"making requestID:"+s+" url:"+n.url),i(n.url,a).then((i=>{t.outstandingRequestCount-=1,0===t.outstandingRequestCount&&t.layerView.updatingFlagChanged(),this.dbg(2,"have response for requestID:"+s);let e=0;if(i.data.byteLength>0){e=this._vxl._malloc(i.data.byteLength);const t=new Uint8Array(this._vxl.HEAPU8.buffer,e,i.data.byteLength),s=new Uint8Array(i.data);for(let e=0;e<i.data.byteLength;++e)t[e]=s[e]}r.set(+s,{type:n.type,ptr:e,size:i.data.byteLength,success:!0})})).catch((i=>{t.outstandingRequestCount-=1,0===t.outstandingRequestCount&&t.layerView.updatingFlagChanged(),e(i)||(this.dbg(4,`requestID:${s} failed, error=${i.toString()}`),r.set(+s,{type:n.type,ptr:0,size:0,success:!1}))}))}}))}updateWasmCamera(t){this._vxl.set_projection_matrix.apply(this._vxl,t.projectionMatrix),this._vxl.set_view_matrix.apply(this._vxl,t.viewMatrix),this._vxl.set_near_far(t.near,t.far)}isUpdating(t){return!(this._vxl||!this._vxlPromise)||!!this._layers.has(t)&&this._layers.get(t).outstandingRequestCount>0}setEnabled(t,s){this._layers.forEach(((i,e)=>{i.layerView===t&&(this._vxl.set_enabled(e,s),this._renderPluginContext.requestRender())}))}setSlices(t,s){return this._doMaskedUIUpdate(t,{mask:2,slices:{planes:s,currentEditPlane:-1}},!0)}setDynamicSections(t,s){return this._doMaskedUIUpdate(t,{mask:4,dynamicSections:{planes:s,currentEditPlane:-1}},!0)}setStaticSections(t,s){return this._doMaskedUIUpdate(t,{mask:1,staticSections:s},!0)}setCurrentVariable(t,s){return this._doMaskedUIUpdate(t,{mask:1024,currentVariable:s},!0)}setRenderMode(t,s){return this._doMaskedUIUpdate(t,{mask:8192,renderMode:s},!0)}_doMaskedUIUpdate(t,s,i){if(!this._vxl)return!1;let e=!1;return this._layers.forEach(((i,n)=>{if(i.layerView===t){const t={str:JSON.stringify(s),byteCount:0,ptr:0,isReusable:!1};this._AllocateBlock(t)&&(e=1===this._vxl.handle_masked_ui_update(n,t.ptr,t.byteCount),t.isReusable||this._vxl._free(t.ptr))}})),e&&i&&this._renderPluginContext.requestRender(),e}addVoxelLayer(t){if(!this._vxl){const s={layerView:t,resolveCallback:null,rejectCallback:null},i=new Promise(((t,i)=>{s.resolveCallback=t,s.rejectCallback=i}));return this._newLayers.push(s),i}const s=this._addVoxelLayer(t);return s<0?Promise.reject(-1):Promise.resolve(s)}removeVoxelLayer(t){if(!this._vxl){const s=this._newLayers.findIndex((s=>t===s.layerView));s>=0&&(this._newLayers[s].resolveCallback(-1),this._newLayers.splice(s,1));const i=this._newLayers.length;return 0===i&&(this.dbg(1," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),i}let s=-1;this._layers.forEach(((i,e)=>{i.layerView===t&&(s=e,i.abortController.abort(),this._vxl.remove_layer(s))})),s>=0&&this._layers.delete(s);const i=this._layers.size;return 0===i&&(this.dbg(1," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy()),i}_getBlockSize(t){for(const s of this._wasmMemBlockSizes)if(t<s)return s;return-1}_AllocateBlock(t){t.byteCount=this._vxl.lengthBytesUTF8(t.str)+1;const s=this._getBlockSize(t.byteCount);return s<0?(t.isReusable=!1,t.ptr=this._vxl._malloc(t.byteCount)):(t.isReusable=!0,t.ptr=this._wasmMemBlocks.get(s),0===t.ptr&&(t.ptr=this._vxl._malloc(s),this._wasmMemBlocks.set(s,t.ptr))),0!==t.ptr&&(this._vxl.stringToUTF8(t.str,t.ptr,t.byteCount),!0)}_getTimeArgs(t){let s=-Number.MAX_VALUE,i=Number.MAX_VALUE,e=!1;return n(t)&&(t.isAllTime?e=!0:(n(t.start)&&(e=!0,s=t.start.getTime()/1e3),n(t.end)&&(e=!0,i=t.end.getTime()/1e3))),{startTime:s,endTime:i,useTime:e}}_addVoxelLayer(t){var s;const i=t.layer;let e=-1;const n=i.getConfiguration();if(n.length<1)return-1;const r={str:n,byteCount:0,ptr:0,isReusable:!1};if(!this._AllocateBlock(r))return-1;const h=this._getTimeArgs(null==(s=this._view)?void 0:s.timeExtent),o=this._view.spatialReference.isWGS84&&i.spatialReference.isWGS84?111319.49079327357:1;if(e=this._vxl.add_layer(i.serviceRoot,r.ptr,r.byteCount,o,o,h.startTime,h.endTime,h.useTime),r.isReusable||this._vxl._free(r.ptr),e>=0){const s=new AbortController;if(this._layers.set(e,{layerView:t,responses:new Map,outstandingRequestCount:0,abortController:s}),!this._halfIntTexturesAvailable){const s=[];let i="";for(const e of t.layer.variables)"Int16"!==e.renderingFormat.type&&"UInt16"!==e.renderingFormat.type||(s.push(e.name),e.id===t.layer.style.currentVariableId&&(i=e.name));""!==i&&g.error("#addVoxelLayer_error()",t.layer,`The voxel layer '${t.layer.title}' cannot render the current variable '${i}' in the this browser`),s.length>0&&g.warn("#addVoxelLayer_warning()",t.layer,`The voxel layer '${t.layer.title}' cannot render the variables '${s.toString()}' in the this browser`)}return e}return-1}prepareRender(t){if(!this._vxl)return;const s=t.viewForward,i=t.eye;this._vxl.update_camera_pos_and_direction(i[0],i[1],i[2],s[0],s[1],s[2]);const e=this._vxl.cull();this.dbg(2,"missingResourceCount="+e),this._moreToLoad=e>0,this._havePreparedWithAllLayers=0===this._newLayers.length}render(t){if(!this._vxl||t.pass!==this._renderPass||t.slot!==this._renderSlot)return!1;for(const t of this._newLayers){const s=this._addVoxelLayer(t.layerView);-1===s?t.rejectCallback(-1):t.resolveCallback(s)}if(this._newLayers=[],0===this._layers.size)return this.dbg(4,"No voxel layers but RenderPlugin instance is being asked to render!"),!1;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()},this._syncRequestsResponses(),this._vxl.begin_frame();const s=this._renderTargetToRestore.viewport;return s.width===this._viewportWidth&&s.height===this._viewportHeight||(this._viewportWidth=s.width,this._viewportHeight=s.height,this._vxl.set_viewport(s.width,s.height)),0===s.x&&0===s.y||this.dbg(4,"Unsupported viewport parameters detected!"),this.updateWasmCamera(t.camera),this._vxl.draw(),this._renderTargetToRestore.fbo=null,t.rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),t.rctx.externalVertexArrayObjectUpdate(),t.rctx.externalVertexBufferUpdate(),(this._moreToLoad||!this._havePreparedWithAllLayers&&this._layers.size>0)&&this._renderPluginContext.requestRender(),!0}queryDepthRange(t){this.dbg(1,"--queryDepthRange--");const s=t.viewForward,i=t.eye;this._vxl.update_camera_pos_and_direction(i[0],i[1],i[2],s[0],s[1],s[2]),this._vxl.cull();const e={near:5,far:1e4};return e.near=this._vxl.get_near(),e.far=this._vxl.get_far(),e}destroy(){this.dbg(1,"--destroy--"),this.removeRenderPlugin(),this._readyWatchHandle=r(this._readyWatchHandle),this._qualityWatchHandle=r(this._qualityWatchHandle),this._timeExtentWatchHandle=r(this._timeExtentWatchHandle),this._vxl&&(this._layers.forEach((t=>{t.abortController.abort()})),this._wasmMemBlocks.forEach((t=>{0!==t&&this._vxl._free(t)})),this._vxl.uninitialize_voxel_wasm(),this._vxl=null)}initializeWasm(t){return this._vxl?Promise.resolve():(this._vxlPromise||(this._vxlPromise=function(t){return new Promise((s=>import("./p-f9c7a059.js").then((t=>t.v)).then((({default:i})=>{const e=i({locateFile:v,preinitializedWebGLContext:t,onRuntimeInitialized:()=>s(e)})})))).catch((t=>Promise.reject(t)))}(t).then((t=>{var s;if(this._vxl=t,this._vxlPromise=null,this._newLayers.length<=0)return this.dbg(1," no voxel layers left after WASM downloaded, removing RenderPlugin and destroying"),void this.destroy();const i=this._getTimeArgs(null==(s=this._view)?void 0:s.timeExtent),e=this._vxl.addFunction(this.restoreFramebuffer.bind(this),"v"),n=this._vxl.addFunction(this.setBlendState.bind(this),"viiii"),r=this._vxl.addFunction(this.setFrontFace.bind(this),"vi"),h=this._vxl.addFunction(this.setRasterizerState.bind(this),"vi"),o=this._vxl.addFunction(this.setDepthStencilStateFunction.bind(this),"viii"),a=this._vxl.addFunction(this.setViewport.bind(this),"viiii"),l=this._vxl.addFunction(this.bindPreviousDepthToSlot.bind(this),"iii");this._vxl.initialize_voxel_wasm(e,n,r,h,o,a,l,i.startTime,i.endTime,i.useTime),this._vxl.set_quality(this.toWasmQuality(this._view.qualityProfile)),this._renderPluginContext&&this._renderPluginContext.requestRender()})).catch((()=>{for(const t of this._newLayers)t.rejectCallback(-2);this.dbg(4," WASM failed to download, removing RenderPlugin and destroying"),this.destroy()}))),this._vxlPromise)}get type(){return"external"}get isGround(){return!1}get slicePlane(){return!1}get intersectionHandlerId(){return"unj"}intersect(t,s,i,e,n){if(!this._vxl)return;if(!this._rctx)return;if(0===this._layers.size)return;if(n[0]<0||n[0]>t.camera.viewport[2]||n[1]<0||n[1]>t.camera.viewport[3])return;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()};const r=t.camera.viewForward,h=t.camera.eye;this._vxl.update_camera_pos_and_direction(h[0],h[1],h[2],r[0],r[1],r[2]),this.updateWasmCamera(t.camera),this._vxl.begin_frame(),this._useDepthPass?this.intersectDepth(t,s,i,e,n):this.intersectObject(t,s,i,e,n),this._renderTargetToRestore.fbo=null,this._rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit()),this._rctx.externalVertexArrayObjectUpdate(),this._rctx.externalVertexBufferUpdate()}intersectObject(t,s,i,e,n){const r=this._vxl.pick_object(n[0],n[1]);if(r.success){const n=p();h(n,e,i),o(n,n);const m=f(i,e),v=p();a(v,r.worldX,r.worldY,r.worldZ);const g=p();h(g,v,i);const b=p();l(b,n,c(g,n));const x=p();u(x,i,b);const w=f(i,x),R=d(w/m,0,1),S=t=>{t.intersector="Voxel",t.dist=R,t.target={type:"external",metadata:{layerUid:this.intersectionHandlerId}}},P=t.results.min;(null==P.dist||R<P.dist)&&(null==s||s(i,e,R))&&S(P);const k=t.results.max;if(0!==t.options.store&&(null==k.dist||R>k.dist)&&(null==s||s(i,e,R))&&S(k),2===t.options.store){const s=new y(t.ray);S(s),t.results.all.push(s)}}}intersectDepth(t,s,i,e,n){const r=this._vxl.pick_depth(n[0],n[1]);if(r.success){const n=p();h(n,e,i),o(n,n);const m=f(i,e),v=p();a(v,r.worldX,r.worldY,r.worldZ);const g=p();h(g,v,i);const b=p();l(b,n,c(g,n));const x=p();u(x,i,b);const w=f(i,x),R=d(w/m,0,1),S=t=>{t.intersector="Voxel",t.dist=R,t.target={type:"external",metadata:{layerUid:this.intersectionHandlerId}}},P=t.results.min;(null==P.dist||R<P.dist)&&(null==s||s(i,e,R))&&S(P);const k=t.results.max;if(0!==t.options.store&&(null==k.dist||R>k.dist)&&(null==s||s(i,e,R))&&S(k),2===t.options.store){const s=new y(t.ray);S(s),t.results.all.push(s)}}}toWasmQuality(t){switch(t){case"low":return 0;case"medium":return 1;case"high":return 2}}}class x{constructor(){this.view2WASM=new Map}static getInstance(){return x.instance||(x.instance=new x),x.instance}isUpdating(t,s){return!!this.view2WASM.has(t)&&this.view2WASM.get(t).isUpdating(s)}addLayer(t,s){return this.view2WASM.has(t)||this.view2WASM.set(t,new b(t)),this.view2WASM.get(t).addVoxelLayer(s)}removeLayer(t,s){this.view2WASM.has(t)&&this.view2WASM.get(t).removeVoxelLayer(s)<1&&this.view2WASM.delete(t)}setLayerEnabled(t,s,i){this.view2WASM.has(t)&&this.view2WASM.get(t).setEnabled(s,i)}setLayerSlices(t,s){let i=!1;return this.view2WASM.forEach(((e,n)=>{n.allLayerViews.filter((t=>"voxel-3d"===t.type)).forEach((n=>{n.layer===t&&(i=e.setSlices(n,s))}))})),i}setLayerDynamicSections(t,s){let i=!1;return this.view2WASM.forEach(((e,n)=>{n.allLayerViews.filter((t=>"voxel-3d"===t.type)).forEach((n=>{n.layer===t&&(i=e.setDynamicSections(n,s))}))})),i}setLayerCurrentVariable(t,s){let i=!1;return this.view2WASM.forEach(((e,n)=>{n.allLayerViews.filter((t=>"voxel-3d"===t.type)).forEach((n=>{n.layer===t&&(i=e.setCurrentVariable(n,s))}))})),i}setLayerRenderMode(t,s){let i=!1;return this.view2WASM.forEach(((e,n)=>{n.allLayerViews.filter((t=>"voxel-3d"===t.type)).forEach((n=>{n.layer===t&&(i=e.setRenderMode(n,s))}))})),i}setLayerStaticSections(t,s){let i=!1;return this.view2WASM.forEach(((e,n)=>{n.allLayerViews.filter((t=>"voxel-3d"===t.type)).forEach((n=>{n.layer===t&&(i=e.setStaticSections(n,s))}))})),i}}export{x as t}