import{v as t,e as i,d as s,i as e,p,bm as r,r as o,N as a,O as h,m,a as n,h as c}from"./p-9ae46e68.js";import{l as d,u as j}from"./p-ebe5e529.js";import{f as l,M as u,_ as f,h as b,E as y}from"./p-566b0715.js";import{j as w}from"./p-40c5644b.js";import{m as g}from"./p-cb5759ce.js";import{c as v}from"./p-8b767e6c.js";import{n as x}from"./p-6ab16fcc.js";import{i as R}from"./p-220bdae9.js";import{r as D}from"./p-798e3ebd.js";import{d as E}from"./p-9dbf3f05.js";import{t as I}from"./p-71e3657b.js";import{i as P}from"./p-fe4caffe.js";import{S as V}from"./p-3d177b3b.js";import{g as S}from"./p-f271906a.js";import{b as T}from"./p-f42060e0.js";import{d as q}from"./p-24ce6cb4.js";import{i as N}from"./p-9ca88c10.js";import"./p-84bf99cb.js";import"./p-fe01b82b.js";import"./p-6ebb24ba.js";import"./p-4fd6e394.js";import"./p-bae36c84.js";import"./p-138c2b2c.js";import"./p-7a648ea5.js";import"./p-b2a0fae5.js";import"./p-4681e856.js";import"./p-a0e42f29.js";import"./p-41655335.js";import"./p-3ffd0931.js";import"./p-8031c809.js";import"./p-3048cc18.js";import"./p-c7a0a732.js";import"./p-b2d0e2de.js";import"./p-db87794e.js";import"./p-22c8d854.js";import"./p-3d1b25b6.js";import"./p-98a14d68.js";import"./p-8e03c038.js";import"./p-32462343.js";import"./p-32824614.js";import"./p-79553c8d.js";import"./p-40d3b500.js";import"./p-c8f716a9.js";import"./p-57ae469d.js";import"./p-27ef204b.js";import"./p-3a2e88bf.js";import"./p-9e860e7b.js";import"./p-ada83011.js";import"./p-98ce0cca.js";import"./p-4003c7ae.js";import"./p-a7080451.js";import"./p-7e9d2371.js";import"./p-94f8dc11.js";import"./p-bb07d873.js";import"./p-8ac97b63.js";import"./p-a0a931f0.js";import"./p-dfc6337f.js";import"./p-77e6a663.js";import"./p-c5b7f7c3.js";import"./p-30ddb3a0.js";import"./p-74fc1b7f.js";import"./p-b3024dec.js";import"./p-4fcbc3c5.js";import"./p-4b3ae2cf.js";import"./p-6443bfb4.js";import"./p-8e6daf54.js";import"./p-c0757461.js";import"./p-93d9099f.js";import"./p-d3898fd7.js";import"./p-844dad6c.js";import"./p-c59d0a4d.js";import"./p-3a5fe179.js";import"./p-ae0b06e3.js";import"./p-a293872e.js";import"./p-cf2267f9.js";import"./p-d2e19070.js";import"./p-e5429b9e.js";import"./p-cf8dc9be.js";import"./p-f17028ec.js";import"./p-5c89c68e.js";import"./p-725fd184.js";import"./p-0c91ebaf.js";import"./p-72355290.js";import"./p-d68829c1.js";import"./p-81102839.js";import"./p-2f7c985e.js";import"./p-00b9ea57.js";import"./p-5a0fe1d0.js";import"./p-7818def0.js";import"./p-da143060.js";import"./p-15bb2887.js";import"./p-1f10277d.js";import"./p-2b250922.js";import"./p-285c6a34.js";import"./p-81e5b36e.js";import"./p-1d6f3ddb.js";import"./p-789e71c1.js";import"./p-523f37cd.js";import"./p-a198d6d0.js";import"./p-15515b8a.js";import"./p-264c75ac.js";import"./p-c431b12a.js";import"./p-b0f556d6.js";import"./p-8d03d70f.js";import"./p-9658240e.js";import"./p-d6725707.js";import"./p-d925341f.js";import"./p-c3efb223.js";import"./p-39da60a5.js";import"./p-56ed1c7a.js";import"./p-d18723b0.js";import"./p-b62a8a4f.js";import"./p-f614dce4.js";import"./p-0c60bcc4.js";import"./p-16def889.js";import"./p-7c7c5507.js";import"./p-128c292d.js";import"./p-2d0c34e5.js";import"./p-47e1bd73.js";import"./p-b392deaf.js";import"./p-9790d1b4.js";import"./p-47f143cb.js";import"./p-50ff864e.js";import"./p-81abd5fc.js";import"./p-da4ee59d.js";import"./p-dd4e6b8b.js";import"./p-d40c97c9.js";import"./p-eb19a862.js";import"./p-4414d64f.js";import"./p-a617738c.js";import"./p-ffe0d3ad.js";import"./p-97ec6ae5.js";import"./p-0509f8e7.js";import"./p-9739c166.js";import"./p-1fb61ab0.js";import"./p-d778cb09.js";import"./p-9dcf03f7.js";import"./p-2a252a78.js";import"./p-5fb38925.js";import"./p-e6a400a0.js";import"./p-6c45ae96.js";import"./p-685003b3.js";import"./p-6e4caa55.js";import"./p-d30fd87a.js";import"./p-58fed22f.js";import"./p-e991a11e.js";import"./p-b1c9647c.js";const U=t.getLogger("esri.views.2d.layers.imagery.ImageryGraphicsView2D");let k=class extends p{constructor(){super(...arguments),this.attached=!1,this.container=new x,this.updateRequested=!1,this._graphicsView=null,this._projectFullExtentPromise=null,this._dataParameters={exportParametersVersion:0,extents:[],tileResolution:0,time:""},this.type="Graphics",this._graphics=new v,this._updateGraphics=r((async(t,i)=>{if(!t.stationary)return;const s=t.state,e=new u({xmin:s.extent.xmin,ymin:s.extent.ymin,xmax:s.extent.xmax,ymax:s.extent.ymax,spatialReference:s.spatialReference}),[p,r]=t.state.size,a={};a.timeExtent=this.timeExtent,a.requestAsImageElement=!1,a.signal=i,null==this._projectFullExtentPromise&&(this._projectFullExtentPromise=this._getProjectedFullExtent(e.spatialReference));const h="vector-field"===this.layer.renderer.type?this.layer.renderer.symbolTileSize:50,m=await this._projectFullExtentPromise,{extent:n,resolution:c,width:d,height:j}=g(e,p,r,h,m),l=await this.layer.fetchImage(n,d,j,a),f=this.layer.renderer;if("vector-field"===f.type){const i=l.pixelData.pixelBlock,s=f.sizeVariables[0];!o(i)||s.minDataValue&&s.maxDataValue||(s.minDataValue=i.statistics[0].minValue,s.maxDataValue=i.statistics[0].maxValue),this._pixelData={extent:n,pixelBlock:i};const e=n.clone().normalize(),p={exportParametersVersion:this.layer.exportImageServiceParameters.version,extents:e,tileResolution:c,time:JSON.stringify(this.timeExtent||"")},r=this._canReuseVectorFieldData(p)?this._dataParameters.extents:[],a=await f.getGraphicsFromPixelData(l.pixelData,"vector-uv"===this.layer.rasterInfo.dataType,r);if(r.length){const t=this._graphics.items.filter((t=>o(t.geometry)&&r.some((i=>i.intersects(t.geometry)))&&!e.some((i=>i.intersects(t.geometry)))));this._graphics.removeMany(t),this._graphics.addMany(a)}else this._graphics.set("items",a);this._graphicsView.update(t),this._dataParameters=p}}))}destroy(){this.attached&&(this.detach(),this.attached=!1),this.updateRequested=!1}get updating(){return!this.attached||this.isUpdating()}update(t){this._updateGraphics(t).catch((t=>{a(t)||U.error(t)}))}hitTest(t,i){const s=this.view.toMap(f(t,i));return Promise.resolve(new b({attributes:{},geometry:s,layer:this.layer}))}attach(){this._graphicsView=new D({view:this.view,graphics:this._graphics,requestUpdateCallback:()=>this.requestUpdate(),container:new R(this.view.featuresTilingScheme)}),this.attached=!0}detach(){this._graphics.destroy(),this._graphicsView.destroy(),this.container.removeChild(this._graphicsView.container),this._graphicsView=null}install(t){this.container.addChild(this._graphicsView.container),t.addChild(this.container)}uninstall(t){this.container.removeChild(this._graphicsView.container),t.removeChild(this.container)}isUpdating(){return this._graphicsView.updating||this.updateRequested}getPixelData(){return this.updating?null:this._pixelData}redraw(){}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}async _getProjectedFullExtent(t){try{return await w(this.layer.fullExtent,t)}catch(i){try{const i=(await h(this.layer.url,{query:{option:"footprints",outSR:t.wkid||JSON.stringify(t.toJSON()),f:"json"}})).data.featureCollection.layers[0].layerDefinition.extent;return i?u.fromJSON(i):null}catch{return null}}}_canReuseVectorFieldData(t){const i=this._dataParameters.exportParametersVersion===t.exportParametersVersion,s=this._dataParameters.time===t.time,e=Math.abs(this._dataParameters.tileResolution-t.tileResolution)/t.tileResolution<.01,p=this._dataParameters.extents.some((i=>t.extents.some((t=>i.intersects(t)))));return i&&s&&e&&p}};i([s()],k.prototype,"attached",void 0),i([s()],k.prototype,"container",void 0),i([s()],k.prototype,"layer",void 0),i([s()],k.prototype,"timeExtent",void 0),i([s()],k.prototype,"view",void 0),i([s()],k.prototype,"updateRequested",void 0),i([s()],k.prototype,"updating",null),i([l({graphics:"Graphics"})],k.prototype,"type",void 0),k=i([e("esri.views.2d.layers.imagery.ImageryGraphicsView2D")],k);const M=k,B=t.getLogger("esri.views.2d.layers.imagery.ImageryView2D");let F=class extends p{constructor(){super(...arguments),this.attached=!1,this.container=new x,this.updateRequested=!1,this.type="Imagery",this._bitmapView=null}destroy(){this.attached&&(this.detach(),this.attached=!1),this.updateRequested=!1}get updating(){return!this.attached||this.isUpdating()}update(t){this.strategy.update(t).catch((t=>{a(t)||B.error(t)}))}detach(){this.strategy.destroy(),this._bitmapView.removeAllChildren(),this.container.removeAllChildren()}hitTest(t,i){const s=this.view.toMap(f(t,i));return Promise.resolve(new b({attributes:{},geometry:s,layer:this.layer}))}attach(){const t=this.layer.version>=10,i=this.layer.version>=10.1?this.layer.imageMaxHeight:2048,s=this.layer.version>=10.1?this.layer.imageMaxWidth:2048;this._bitmapView=new I,this.strategy=new V({container:this._bitmapView,imageNormalizationSupported:t,imageMaxHeight:i,imageMaxWidth:s,fetchSource:this._fetchImage.bind(this),requestUpdate:()=>this.requestUpdate()}),this.attached=!0}install(t){this.container.addChild(this._bitmapView),t.addChild(this.container)}uninstall(t){this.container.removeChild(this._bitmapView),t.removeChild(this.container)}redraw(){this.strategy.updateExports((t=>{t.source instanceof HTMLImageElement?t.requestRender():this.layer.applyRenderer({pixelBlock:t.source.pixelBlock}).then((i=>{const s=t.source;s.pixelBlock=i.pixelBlock,s.filter=t=>this.layer.applyFilter(t),this.container.requestRender()}))}))}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}isUpdating(){return this.strategy.updating||this.updateRequested}getPixelData(){if(this.updating)return null;const t=this.strategy.bitmaps;if(1===t.length&&t[0].source)return{extent:t[0].source.extent,pixelBlock:t[0].source.originalPixelBlock};if(t.length>1){const i=this.view.extent,s=t.map((t=>t.source)).filter((t=>t.extent&&t.extent.intersects(i))).map((t=>({extent:t.extent,pixelBlock:t.originalPixelBlock}))),e=E(s,i);return o(e)?{extent:e.extent,pixelBlock:e.pixelBlock}:null}return null}_fetchImage(t,i,s,e){return(e=e||{}).timeExtent=this.timeExtent,e.requestAsImageElement=!0,this.layer.fetchImage(t,i,s,e).then((t=>t.imageElement?t.imageElement:this.layer.applyRenderer(t.pixelData,{signal:e.signal}).then((i=>{const s=new P(i.pixelBlock,i.extent.clone(),t.pixelData.pixelBlock);return s.filter=t=>this.layer.applyFilter(t),s}))))}};i([s()],F.prototype,"attached",void 0),i([s()],F.prototype,"container",void 0),i([s()],F.prototype,"layer",void 0),i([s()],F.prototype,"strategy",void 0),i([s()],F.prototype,"timeExtent",void 0),i([s()],F.prototype,"view",void 0),i([s()],F.prototype,"updateRequested",void 0),i([s()],F.prototype,"updating",null),i([l({imagery:"Imagery"})],F.prototype,"type",void 0),F=i([e("esri.views.2d.layers.imagery.ImageryView2D")],F);const G=F,_=t=>{let p=class extends t{constructor(){super(...arguments),this.view=null}async fetchPopupFeatures(t,i){const{layer:s}=this;if(!t)throw new m("imagerylayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:s});const{popupEnabled:e}=s,p=q(s,i);if(!e||!o(p))throw new m("imagerylayerview:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:e,popupTemplate:p});const r=await p.getRequiredFields(),a=new T;a.timeExtent=this.timeExtent,a.geometry=t,a.outFields=r,a.outSpatialReference=t.spatialReference;const h=this.view.resolution,n="2d"===this.view.type?new y(h,h,this.view.spatialReference):new y(.5*h,.5*h,this.view.spatialReference),{returnTopmostRaster:c,showNoDataRecords:d}=p.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},j={returnDomainValues:!0,returnTopmostRaster:c,pixelSize:n,showNoDataRecords:d,signal:o(i)?i.signal:null};return s.queryVisibleRasters(a,j).then((t=>t))}canResume(){var t;return!(!super.canResume()||null!=(t=this.timeExtent)&&t.isEmpty)}};return i([s()],p.prototype,"layer",void 0),i([s()],p.prototype,"suspended",void 0),i([s(S)],p.prototype,"timeExtent",void 0),i([s()],p.prototype,"view",void 0),p=i([e("esri.views.layers.ImageryLayerView")],p),p};let O=class extends(_(N(d(j)))){constructor(){super(...arguments),this._exportImageVersion=-1}initialize(){this.handles.add([n(this,["layer.blendMode","layer.effects"],(t=>{this.subview&&(this.subview.container.blendMode=t)}),!0),n(this,"layer.effect",(t=>{this.subview&&(this.subview.container.effect=t)}),!0)])}get pixelData(){return this.updating?null:this.subview.getPixelData()}get updating(){return!(this.subview&&!this.subview.updating)}hitTest(t,i){return this.suspended||!this.subview?Promise.resolve(null):this.subview.hitTest(t,i)}update(t){var i;null==(i=this.subview)||i.update(t)}attach(){this.layer.increaseRasterJobHandlerUsage(),this._setSubView(),this.handles.add([n(this,"layer.exportImageServiceParameters.version",(t=>{this._exportImageVersion!==t&&(this._exportImageVersion=t,this.requestUpdate())})),this.watch("timeExtent",(()=>{this.subview.timeExtent=this.timeExtent,this.requestUpdate()})),this.layer.on("redraw",(()=>this.subview.redraw())),c(this.layer,"renderer",(()=>this._setSubView()))],"imagerylayerview-update")}detach(){this.layer.decreaseRasterJobHandlerUsage(),this.subview.destroy(),this.handles.remove("imagerylayerview-update"),this._exportImageVersion=-1}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}async doRefresh(){this.requestUpdate()}isUpdating(){return!this.subview||!this.suspended&&this.subview.isUpdating()}_setSubView(){var t;let i="Imagery";var s,e;"vector-field"===(null==(t=this.layer.renderer)?void 0:t.type)&&"lerc"===this.layer.format&&(i="Graphics"),this.subview&&this.subview.type===i||(null==(s=this.subview)||s.uninstall(this.container),null==(e=this.subview)||e.destroy(),this.subview="Imagery"===i?new G({layer:this.layer,view:this.view,timeExtent:this.timeExtent}):new M({layer:this.layer,view:this.view,timeExtent:this.timeExtent}),this.subview.attach(),this.subview.install(this.container),this.subview.container.blendMode=this.layer.blendMode,this.subview.container.effect=this.layer.effect),this.requestUpdate()}};i([s()],O.prototype,"pixelData",null),i([s({readOnly:!0})],O.prototype,"updating",null),i([s()],O.prototype,"subview",void 0),O=i([e("esri.views.2d.layers.ImageryLayerView2D")],O);const z=O;export default z;