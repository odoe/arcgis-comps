import{O as t,bQ as e,bR as s,t as n,r,ab as i,U as o,e as a,d as u,i as c,a7 as h,ac as l,m as f}from"./p-9ae46e68.js";import{b as d,K as y}from"./p-f42060e0.js";import{e as p}from"./p-41655335.js";import{l as m,a as b,n as j,s as w}from"./p-a0e42f29.js";import{t as x,S as F,c as O}from"./p-3ffd0931.js";import{u as g,l as G,S as P}from"./p-32824614.js";import{M as R,aH as S}from"./p-566b0715.js";import{m as q,n as C}from"./p-4003c7ae.js";import{t as I}from"./p-3d1b25b6.js";import v from"./p-98a14d68.js";import{v as k}from"./p-8031c809.js";import{r as N}from"./p-22c8d854.js";import{l as T}from"./p-a7080451.js";function D(t){const e=t.toJSON();return e.attachmentTypes&&(e.attachmentTypes=e.attachmentTypes.join(",")),e.keywords&&(e.keywords=e.keywords.join(",")),e.globalIds&&(e.globalIds=e.globalIds.join(",")),e.objectIds&&(e.objectIds=e.objectIds.join(",")),e.size&&(e.size=e.size.join(",")),e}function J(t,n){const r={};for(const i of t){const{parentObjectId:t,parentGlobalId:o,attachmentInfos:a}=i;for(const i of a){const{id:a}=i,u=e(s(`${n}/${t}/attachments/${a}`)),c=m.fromJSON(i);c.set({url:u,parentObjectId:t,parentGlobalId:o}),r[t]?r[t].push(c):r[t]=[c]}}return r}async function M(e,s,n){const r=p(e);return function(e,s,n){let r={query:x({...e.query,f:"json",...D(s)})};return n&&(r={...n,...r,query:{...n.query,...r.query}}),t(e.path+"/queryAttachments",r)}(r,g.from(s),{...n}).then((t=>J(t.data.attachmentGroups,r.path)))}async function Z(t,e,s){const n=p(t);return F(n,d.from(e),{...s}).then((t=>({count:t.data.count,extent:R.fromJSON(t.data.extent)})))}function Q(t,e){return e}function _(t,e,s,n){switch(s){case 0:return L(t,e+n,0);case 1:return"lowerLeft"===t.originPosition?L(t,e+n,1):function({translate:t,scale:e},s,n){return t[n]-s*e[n]}(t,e+n,1)}}function A(t,e,s,n){return 2===s?L(t,e,2):_(t,e,s,n)}function E(t,e,s,n){return 2===s?L(t,e,3):_(t,e,s,n)}function $(t,e,s,n){return 3===s?L(t,e,3):A(t,e,s,n)}function L({translate:t,scale:e},s,n){return t[n]+s*e[n]}class X{constructor(t){this.options=t,this.geometryTypes=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"],this.previousCoordinate=[0,0],this.transform=null,this.applyTransform=Q,this.lengths=[],this.currentLengthIndex=0,this.toAddInCurrentPath=0,this.vertexDimension=0,this.coordinateBuffer=null,this.coordinateBufferPtr=0,this.AttributesConstructor=function(){}}createFeatureResult(){return{fields:[],features:[]}}finishFeatureResult(t){if(this.options.applyTransform&&(t.transform=null),this.AttributesConstructor=function(){},this.coordinateBuffer=null,this.lengths.length=0,!t.hasZ)return;const e=I(t.geometryType,this.options.sourceSpatialReference,t.spatialReference);if(!n(e))for(const s of t.features)e(s.geometry)}createSpatialReference(){return{}}addField(t,e){t.fields.push(e);const s=t.fields.map((t=>t.name));this.AttributesConstructor=function(){for(const t of s)this[t]=null}}addFeature(t,e){t.features.push(e)}prepareFeatures(t){switch(this.transform=t.transform,this.options.applyTransform&&t.transform&&(this.applyTransform=this.deriveApplyTransform(t)),this.vertexDimension=2,t.hasZ&&this.vertexDimension++,t.hasM&&this.vertexDimension++,t.geometryType){case"esriGeometryPoint":this.addCoordinate=(t,e,s)=>this.addCoordinatePoint(t,e,s),this.createGeometry=t=>this.createPointGeometry(t);break;case"esriGeometryPolygon":this.addCoordinate=(t,e,s)=>this.addCoordinatePolygon(t,e,s),this.createGeometry=t=>this.createPolygonGeometry(t);break;case"esriGeometryPolyline":this.addCoordinate=(t,e,s)=>this.addCoordinatePolyline(t,e,s),this.createGeometry=t=>this.createPolylineGeometry(t);break;case"esriGeometryMultipoint":this.addCoordinate=(t,e,s)=>this.addCoordinateMultipoint(t,e,s),this.createGeometry=t=>this.createMultipointGeometry(t)}}createFeature(){return this.lengths.length=0,this.currentLengthIndex=0,this.previousCoordinate[0]=0,this.previousCoordinate[1]=0,this.coordinateBuffer=null,this.coordinateBufferPtr=0,{attributes:new this.AttributesConstructor}}allocateCoordinates(){}addLength(t,e,s){0===this.lengths.length&&(this.toAddInCurrentPath=e),this.lengths.push(e)}addQueryGeometry(t,e){const{queryGeometry:s,queryGeometryType:n}=e,r=q(s.clone(),s,!1,!1,this.transform),i=C(r,n,!1,!1);t.queryGeometryType=n,t.queryGeometry={...i}}createPointGeometry(t){const e={x:0,y:0,spatialReference:t.spatialReference};return t.hasZ&&(e.z=0),t.hasM&&(e.m=0),e}addCoordinatePoint(t,e,s){switch(e=this.applyTransform(this.transform,e,s,0),s){case 0:t.x=e;break;case 1:t.y=e;break;case 2:"z"in t?t.z=e:t.m=e;break;case 3:t.m=e}}transformPathLikeValue(t,e){let s=0;return e<=1&&(s=this.previousCoordinate[e],this.previousCoordinate[e]+=t),this.applyTransform(this.transform,t,e,s)}addCoordinatePolyline(t,e,s){this.dehydratedAddPointsCoordinate(t.paths,e,s)}addCoordinatePolygon(t,e,s){this.dehydratedAddPointsCoordinate(t.rings,e,s)}addCoordinateMultipoint(t,e,s){0===s&&t.points.push([]);const n=this.transformPathLikeValue(e,s);t.points[t.points.length-1].push(n)}createPolygonGeometry(t){return{rings:[[]],spatialReference:t.spatialReference,hasZ:!!t.hasZ,hasM:!!t.hasM}}createPolylineGeometry(t){return{paths:[[]],spatialReference:t.spatialReference,hasZ:!!t.hasZ,hasM:!!t.hasM}}createMultipointGeometry(t){return{points:[],spatialReference:t.spatialReference,hasZ:!!t.hasZ,hasM:!!t.hasM}}dehydratedAddPointsCoordinate(t,e,s){0===s&&0==this.toAddInCurrentPath--&&(t.push([]),this.toAddInCurrentPath=this.lengths[++this.currentLengthIndex]-1,this.previousCoordinate[0]=0,this.previousCoordinate[1]=0);const n=this.transformPathLikeValue(e,s),r=t[t.length-1];0===s&&(this.coordinateBufferPtr=0,this.coordinateBuffer=new Array(this.vertexDimension),r.push(this.coordinateBuffer)),this.coordinateBuffer[this.coordinateBufferPtr++]=n}deriveApplyTransform(t){const{hasZ:e,hasM:s}=t;return e&&s?$:e?A:s?E:_}}async function Y(t,e,s){const n=p(t),r={...s},i=d.from(e),o=!i.quantizationParameters,{data:a}=await O(n,i,new X({sourceSpatialReference:i.sourceSpatialReference,applyTransform:o}),r);return a}function z(t,e){const s=t.toJSON();return s.objectIds&&(s.objectIds=s.objectIds.join(",")),s.orderByFields&&(s.orderByFields=s.orderByFields.join(",")),!s.outFields||null!=e&&e.returnCountOnly?delete s.outFields:s.outFields=-1!==s.outFields.indexOf("*")?"*":s.outFields.join(","),s.outSpatialReference&&(s.outSR=s.outSR.wkid||JSON.stringify(s.outSR.toJSON()),delete s.outSpatialReference),s.dynamicDataSource&&(s.layer=JSON.stringify({source:s.dynamicDataSource}),delete s.dynamicDataSource),s}async function V(e,s,n={},r){const i=x({...e.query,f:"json",...r,...z(s,r)});return t(e.path+"/queryRelatedRecords",{...n,query:{...n.query,...i}})}async function H(t,e,s){return e=G.from(e),async function(t,e,s){const n=await V(t,e,s),r=n.data,i=r.geometryType,o=r.spatialReference,a={};for(const t of r.relatedRecordGroups){const e={fields:void 0,objectIdFieldName:void 0,geometryType:i,spatialReference:o,hasZ:!!r.hasZ,hasM:!!r.hasM,features:t.relatedRecords};if(null!=t.objectId)a[t.objectId]=e;else for(const s in t)t.hasOwnProperty(s)&&"relatedRecords"!==s&&(a[t[s]]=e)}return{...n,data:a}}(p(t),e,s).then((t=>{const e=t.data,s={};return Object.keys(e).forEach((t=>s[t]=v.fromJSON(e[t]))),s}))}async function B(t,e,s){return e=G.from(e),async function(t,e,s){const n=await V(t,e,s,{returnCountOnly:!0}),r=n.data,i={};for(const t of r.relatedRecordGroups)null!=t.objectId&&(i[t.objectId]=t.count);return{...n,data:i}}(p(t),e,{...s}).then((t=>t.data))}const K="Layer does not support extent calculation.";function U(t,e){var s,n;const i=t.geometry,o=t.toJSON(),a=o;if(r(i)&&(a.geometry=JSON.stringify(i),a.geometryType=S(i),a.inSR=i.spatialReference.wkid||JSON.stringify(i.spatialReference)),null!=(s=o.topFilter)&&s.groupByFields&&(a.topFilter.groupByFields=o.topFilter.groupByFields.join(",")),null!=(n=o.topFilter)&&n.orderByFields&&(a.topFilter.orderByFields=o.topFilter.orderByFields.join(",")),o.topFilter&&(a.topFilter=JSON.stringify(a.topFilter)),o.objectIds&&(a.objectIds=o.objectIds.join(",")),o.orderByFields&&(a.orderByFields=o.orderByFields.join(",")),o.outFields&&!(null!=e&&e.returnCountOnly||null!=e&&e.returnExtentOnly||null!=e&&e.returnIdsOnly)?a.outFields=-1!==o.outFields.indexOf("*")?"*":o.outFields.join(","):delete a.outFields,o.outSR?a.outSR=o.outSR.wkid||JSON.stringify(o.outSR):i&&o.returnGeometry&&(a.outSR=a.inSR),o.returnGeometry&&delete o.returnGeometry,o.timeExtent){const t=o.timeExtent,{start:e,end:s}=t;null==e&&null==s||(a.time=e===s?e:`${null==e?"null":e},${null==s?"null":s}`),delete o.timeExtent}return a}function W(e,s,n,a={},u={}){const c="string"==typeof e?o(e):e,h=s.geometry?[s.geometry]:[];return a.responseType="pbf"===n?"array-buffer":"json",k(h,null,a).then((e=>{const o=e&&e[0];r(o)&&((s=s.clone()).geometry=o);const h=x({...c.query,f:n,...u,...U(s,u)});return t(i(c.path,"queryTopFeatures"),{...a,query:{...h,...a.query}})}))}async function tt(t,e,s,n){const r=p(t),i={...n},{data:o}=await async function(t,e,s,n){const r=await W(t,e,"json",n);return N(e,s,r.data),r}(r,P.from(e),s,i);return v.fromJSON(o)}async function et(t,e,s){const n=p(t);return(await async function(t,e,s){return r(e.timeExtent)&&e.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):W(t,e,"json",s,{returnIdsOnly:!0})}(n,P.from(e),{...s})).data.objectIds}async function st(t,e,s){const n=p(t),i=await async function(t,e,s){return r(e.timeExtent)&&e.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):W(t,e,"json",s,{returnExtentOnly:!0,returnCountOnly:!0}).then((t=>{const e=t.data;if(e.hasOwnProperty("extent"))return t;if(e.features)throw new Error(K);if(e.hasOwnProperty("count"))throw new Error(K);return t}))}(n,P.from(e),{...s});return{count:i.data.count,extent:R.fromJSON(i.data.extent)}}async function nt(t,e,s){const n=p(t);return(await function(t,e,s){return r(e.timeExtent)&&e.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):W(t,e,"json",s,{returnIdsOnly:!0,returnCountOnly:!0})}(n,P.from(e),{...s})).data.count}let rt=class extends T{constructor(t){super(t),this.dynamicDataSource=null,this.fieldsIndex=null,this.format="json",this.gdbVersion=null,this.infoFor3D=null,this.sourceSpatialReference=null}execute(t,e){return this.executeJSON(t,e).then((s=>this.featureSetFromJSON(t,s,e)))}async executeJSON(t,e){var s;const n={...this.requestOptions,...e},r=this._normalizeQuery(t),i=null!=(null==(s=t.outStatistics)?void 0:s[0]),o=h("featurelayer-pbf-statistics"),a=!i||o;let u;if("pbf"===this.format&&a)try{u=await Y(this.url,r,n)}catch(t){if("query:parsing-pbf"!==t.name)throw t;this.format="json"}return"json"!==this.format&&a||(u=await b(this.url,r,n)),this._normalizeFields(u.fields),u}async featureSetFromJSON(t,e,s){if(!(this._queryIs3DObjectFormat(t)&&r(this.infoFor3D)&&e.features&&e.features.length))return v.fromJSON(e);const{meshFeatureSetFromJSON:n}=await l(import("./p-6fe3e430.js").then((function(t){return t.a})),s);return n(t,this.infoFor3D,e)}executeForCount(t,e){const s={...this.requestOptions,...e},n=this._normalizeQuery(t);return j(this.url,n,s)}executeForExtent(t,e){const s={...this.requestOptions,...e},n=this._normalizeQuery(t);return Z(this.url,n,s)}executeForIds(t,e){const s={...this.requestOptions,...e},n=this._normalizeQuery(t);return w(this.url,n,s)}executeRelationshipQuery(t,e){t=G.from(t);const s={...this.requestOptions,...e};return(this.gdbVersion||this.dynamicDataSource)&&((t=t.clone()).gdbVersion=t.gdbVersion||this.gdbVersion,t.dynamicDataSource=t.dynamicDataSource||this.dynamicDataSource),H(this.url,t,s)}executeRelationshipQueryForCount(t,e){t=G.from(t);const s={...this.requestOptions,...e};return(this.gdbVersion||this.dynamicDataSource)&&((t=t.clone()).gdbVersion=t.gdbVersion||this.gdbVersion,t.dynamicDataSource=t.dynamicDataSource||this.dynamicDataSource),B(this.url,t,s)}executeAttachmentQuery(t,e){const s={...this.requestOptions,...e};return M(this.url,t,s)}executeTopFeaturesQuery(t,e){const s={...this.requestOptions,...e};return tt(this.parsedUrl,t,this.sourceSpatialReference,s)}executeForTopIds(t,e){const s={...this.requestOptions,...e};return et(this.parsedUrl,t,s)}executeForTopExtents(t,e){const s={...this.requestOptions,...e};return st(this.parsedUrl,t,s)}executeForTopCount(t,e){const s={...this.requestOptions,...e};return nt(this.parsedUrl,t,s)}_normalizeQuery(t){let e=d.from(t);if(e.sourceSpatialReference=e.sourceSpatialReference||this.sourceSpatialReference,(this.gdbVersion||this.dynamicDataSource)&&(e=e===t?e.clone():e,e.gdbVersion=t.gdbVersion||this.gdbVersion,e.dynamicDataSource=t.dynamicDataSource?y.from(t.dynamicDataSource):this.dynamicDataSource),r(this.infoFor3D)&&this._queryIs3DObjectFormat(t)){e=e===t?e.clone():e,e.formatOf3DObjects=null;for(const t of this.infoFor3D.queryFormats){if("3D_glb"===t.id){e.formatOf3DObjects=t.id;break}"3D_gltf"!==t.id||e.formatOf3DObjects||(e.formatOf3DObjects=t.id)}if(!e.formatOf3DObjects)throw new f("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(n(e.outFields)||!e.outFields.includes("*")){e=e===t?e.clone():e,n(e.outFields)&&(e.outFields=[]);const{originX:s,originY:r,originZ:i,translationX:o,translationY:a,translationZ:u,scaleX:c,scaleY:h,scaleZ:l,rotationX:f,rotationY:d,rotationZ:y,rotationDeg:p}=this.infoFor3D.transformFieldRoles;e.outFields.push(s,r,i,o,a,u,c,h,l,f,d,y,p)}}return e}_normalizeFields(t){if(r(this.fieldsIndex)&&r(t))for(const e of t){const t=this.fieldsIndex.get(e.name);t&&Object.assign(e,t.toJSON())}}_queryIs3DObjectFormat(t){return r(this.infoFor3D)&&t.returnGeometry&&"xyFootprint"!==t.multipatchOption&&!t.outStatistics}};a([u({type:y})],rt.prototype,"dynamicDataSource",void 0),a([u()],rt.prototype,"fieldsIndex",void 0),a([u()],rt.prototype,"format",void 0),a([u()],rt.prototype,"gdbVersion",void 0),a([u()],rt.prototype,"infoFor3D",void 0),a([u()],rt.prototype,"sourceSpatialReference",void 0),rt=a([c("esri.tasks.QueryTask")],rt);const it=rt;export{it as Q,J as a}