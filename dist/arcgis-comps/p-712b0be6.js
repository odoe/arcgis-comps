import{af as t,r as s,aN as i,e,d as h,i as r,p as n,u as o,c as a,cg as l,A as c,b9 as u,bo as d,aI as f,s as m,ap as p,h as g,aW as y,a as b,ai as v,K as _,bp as w,cT as x,V as M,bE as S,S as O,aR as C}from"./p-e58503d5.js";import{h as F}from"./p-e273719b.js";import{h as N}from"./p-54330161.js";import{Y as E}from"./p-01e5a461.js";import{a as A}from"./p-b9aa4901.js";import{C as I}from"./p-6484267b.js";import{P as j,e as P,j as D}from"./p-ccdb8e80.js";import{e as T,n as R}from"./p-2c84c65f.js";import{L as G,u as U,I as V,r as B,h as L}from"./p-2f398ed1.js";import{n as z}from"./p-d3105731.js";import{x as k,t as $,b as H,l as q,k as W,F as K}from"./p-c93d2280.js";import{A as J,D as Z,M as Q,H as X,a as Y,B as tt,G as st}from"./p-f94762ac.js";import{B as it,h as et,k as ht,u as rt}from"./p-ea916a39.js";import{s as nt,T as ot,f as at,K as lt,C as ct,a as ut,F as dt}from"./p-b709baea.js";import{a as ft,y as mt}from"./p-765e6c28.js";import{c as pt}from"./p-d2d87566.js";import{f as gt}from"./p-b03021c3.js";import{getColor as yt,getOpacity as bt}from"./p-9f1c2d50.js";import{L as vt,A as _t}from"./p-8bc9b36a.js";import{r as wt}from"./p-a6c8fb32.js";import{m as xt}from"./p-889f7a78.js";import{v as Mt}from"./p-3bcc4805.js";import{I as St,y as Ot}from"./p-e31c89bd.js";import{n as Ct}from"./p-e9596294.js";import{initialize as Ft,setModificationsSync as Nt,filterObbsForModificationsSync as Et,interpretObbModificationResults as At}from"./p-92108618.js";import{y as It,I as jt,a$ as Pt}from"./p-340cd100.js";import{P as Dt,E as Tt,t as Rt,e as Gt,F as Ut}from"./p-7de54cd0.js";import{j as Vt}from"./p-728dcbb0.js";import{aG as Bt,aH as Lt}from"./p-eb48bb01.js";import{W as zt,M as kt,x as $t,b as Ht,i as qt,a as Wt,Z as Kt,h as Jt,_ as Zt,n as Qt,I as Xt,A as Yt,c as ts,z as ss,r as is}from"./p-85e8677e.js";import{n as es}from"./p-8fa44ebc.js";import{b as hs}from"./p-cbbdb7db.js";import{t as rs}from"./p-04a0cfca.js";function ns(t,s,i,e){const h=s.getComponentAabb(i,t,ls),r=s.getObjectTransform(i);for(let t=0;t<8;++t)cs[0]=1&t?h[0]:h[3],cs[1]=2&t?h[1]:h[4],cs[2]=4&t?h[2]:h[5],G(cs,cs,r.rotationScale),U(cs,cs,r.position),e[3*t]=cs[0],e[3*t+1]=cs[1],e[3*t+2]=cs[2];return e}function os(s,i,e){const h=new Float64Array(24);return r=>{let n=r.meta.featureExtents;if(t(n)){n=new Float64Array(6*r.meta.featureIds.length),r.meta.featureExtents=n;for(let t=0;t<n.length;t+=6)n[t]=Number.POSITIVE_INFINITY}const o=new Float64Array(n.buffer,6*r.index*Float64Array.BYTES_PER_ELEMENT,6);return o[0]===Number.POSITIVE_INFINITY&&(ns(r.index,e,r.meta.objectHandle,h),k(h,i,0,h,s,0,8)?(J(o,Z),Q(o,h,0,8)):J(o,X)),o}}function as(t,s,i,e){const h=s.getComponentAabb(i,t,ls),r=s.getObjectTransform(i);e[0]=0,e[1]=0,e[2]=0;for(let t=0;t<8;++t)cs[0]=1&t?h[0]:h[3],cs[1]=2&t?h[1]:h[4],cs[2]=h[5],G(cs,cs,r.rotationScale),U(cs,cs,r.position),e[0]+=cs[0],e[1]+=cs[1],e[2]+=cs[2];return e[0]/=8,e[1]/=8,e[2]/=8,e}const ls=Y(),cs=z();class us extends s{constructor(t){super(),this._limit=t,this._all=new nt,this._active=new fs(this),this._pending=new Map,this._handle=this._all.on("change",(t=>this._handleChanges(t)))}destroy(){this._handle.remove()}get length(){return this._active.length}toArray(){return this._active.toArray()}find(t){return this._active.find(t)}forEach(t){this._active.forEach(t)}addMany(t){this._all.addMany(t)}removeManyByObjectId(t){this._all.removeManyByObjectId(t)}_handleChanges(t){let s=t.removed;if(this._pending.size>0){s=new Array;for(const i of t.removed)this._pending.delete(i.objectId)||s.push(i)}let i=this._limit-this._active.length+s.length;i<t.added.length&&(this._active.removeMany(s),s=[],ds.reset(1-this._limit/(this._active.length+t.added.length)),this._active.forEach((t=>{ds.sample()&&(s.push(t),this._pending.set(t.objectId,t))})),i=this._limit-this._active.length+s.length);let e=t.added;if(i<t.added.length){e=new Array,ds.reset(i/t.added.length);for(const s of t.added)ds.sample()?e.push(s):this._pending.set(s.objectId,s)}const h=i-e.length;h>0&&this._pending.size>0&&(ds.reset(h/this._pending.size),this._pending.forEach((t=>{ds.sample()&&(e.push(t),this._pending.delete(t.objectId))}))),this._active.addAndRemove(e,s)}}const ds=new class{constructor(){this.percentage=1,this.last=-1,this.index=0}reset(t){this.percentage=t,this.last=-1}sample(){const t=Math.floor(this.index*this.percentage);return++this.index,t!==this.last&&(this.last=t,!0)}};class fs{constructor(t){this._parent=t,this._map=new Map}get length(){return this._map.size}forEach(t){this._map.forEach((s=>t(s)))}find(t){let s;return i(this._map,(i=>!!t(i)&&(s=i,!0))),s}toArray(){return[...this._map.values()]}addAndRemove(t,s){for(const s of t)this._map.set(s.objectId,s);for(const t of s)this._map.delete(t.objectId);(t.length>0||s.length>0)&&this._parent.emit("change",{added:t,removed:s})}removeMany(t){for(const s of t)this._map.delete(s.objectId);t.length>0&&this._parent.emit("change",{added:[],removed:t})}}let ms=class extends n{constructor(t){super(t),this.loadedGraphics=new us(5e4),this.slicePlaneEnabled=!1,this._renderingInfo={symbol:new vt},this._handles=new o,this._graphicsByNode=new Map,this._scaleVisibility=null}initialize(){this._graphicsCore=new St({owner:this,layer:this.layer,preferredUpdatePolicy:0,elevationFeatureExpressionEnabled:!1,graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1});const t=this.view.basemapTerrain;this._scaleVisibility=new Ot({layerScaleEnabled:!1}),this._scaleVisibility.setup(this,this.layer,((t,s,i)=>this._graphicsCore.spatialIndex.queryGraphicUIDsInExtent(t,s,i)),this._graphicsCore,t);const s=this.view.labeler.addGraphicsOwner(this._graphicsCore,this._scaleVisibility,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),i=this.view.deconflictor.addGraphicsOwner(this._graphicsCore);this._graphicsCore.setup({labeler:s,deconflictor:i,scaleVisibility:this._scaleVisibility}).then((()=>{this._graphicsCore.startCreateGraphics()})).catch((()=>{})),this._handles.add([this.layer.watch("labelingInfo",((t,s)=>{xt(t,s)&&this._graphicsCore.updateLabelingInfo()}))])}destroy(){this._handles&&(this._handles.destroy(),this._handles=null),null!=this._scaleVisibility&&(this._scaleVisibility.destroy(),this._scaleVisibility=null),null!=this._graphicsCore&&(this._graphicsCore.destroy(),this._graphicsCore=null),this.loadedGraphics.destroy(),this.view=null}addNodeMeta(s,i){let e=0;const h=s.filteredIds,r=s.featureIds.map(((r,n)=>{as(n,this.collection,s.objectHandle,gs);const o=Mt(0,0,0,this.view.spatialReference);this.view.renderCoordsHelper.fromRenderCoords(gs,o);const a=i(n,s);let l=!1;return t(h)?l=!0:e<h.length&&r===h[e]&&(l=!0,e++),{objectId:r,uid:N.generateUID(),attributes:a,visible:l,geometry:o}}));this.loadedGraphics.addMany(r),this._graphicsByNode.set(s.node.index,r)}setNodeMetaAttributes(t,s){const i=this._graphicsByNode.get(t.node.index),e=new Array(i.length);for(let h=0;h<i.length;h++){const r=i[h];r.attributes=s(h,t),e[h]=r.uid}this._graphicsCore.updateLabelingInfo(e)}applyFilterChange(s){const i=this._graphicsByNode.get(s.node.index);if(i)if(t(s.filteredIds))for(const t of i)t.visible||(t.visible=!0,ps.graphic=t,ps.property="visible",ps.oldValue=!1,ps.newValue=!0,this._graphicsCore.graphicUpdateHandler(ps));else{let t=0;for(const e of i){const i=e.visible;t<s.filteredIds.length&&e.objectId===s.filteredIds[t]?(e.visible=!0,t++):e.visible=!1,i!==e.visible&&(ps.graphic=e,ps.property="visible",ps.oldValue=i,ps.newValue=e.visible,this._graphicsCore.graphicUpdateHandler(ps))}}}removeNodeMeta(t){this.loadedGraphics.removeManyByObjectId(t.featureIds)}getRenderingInfo(){return this._renderingInfo}notifyGraphicGeometryChanged(){}notifyGraphicVisibilityChanged(){}get updatePolicy(){return this._graphicsCore.effectiveUpdatePolicy}get usedMemory(){return this._graphicsCore.usedMemory}get unloadedMemoryEstimate(){return this._graphicsCore.unprocessedMemoryEstimate}get test(){return{graphicsCore:this._graphicsCore}}};e([h()],ms.prototype,"view",void 0),e([h()],ms.prototype,"layer",void 0),e([h()],ms.prototype,"collection",void 0),e([h()],ms.prototype,"loadedGraphics",void 0),e([h({aliasOf:"_graphicsCore.updating"})],ms.prototype,"updating",void 0),e([h()],ms.prototype,"slicePlaneEnabled",void 0),e([h()],ms.prototype,"_graphicsCore",void 0),ms=e([r("esri.views.3d.layers.I3SMeshViewLabeler")],ms);const ps={graphic:null,property:null,oldValue:null,newValue:null},gs=z(),ys=ms,bs=a.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle");class vs extends Ct{constructor(t){super("SceneLayerWorker","process",t,{hasInitialize:!0})}getTransferList(t){return[t.geometryBuffer]}setModifications(t,s,i,e){const h={context:t,modifications:xs(s,i,e),isGeodetic:e.isGeographic};this.broadcast(h,"setModifications")}setLegacySchema(t,s){const i=JSON.stringify(s);this.broadcast({context:t,jsonSchema:i},"setLegacySchema")}destroyContext(t){return this.broadcast(t,"destroyContext")}}const _s=new l({deallocator:null}),ws=[0,0,0];function xs(t,s,i){_s.clear();let e=1/0,h=1/0,r=-1/0,n=-1/0,o=!1;for(const t of s){const s="clip"===t.type?2:"mask"===t.type?1:0,a=t.geometry;let l=t=>t;if(a.spatialReference){if(!$(a.spatialReference,i)){bs.warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}l=t=>(H(t,a.spatialReference,ws,i),ws)}else a.hasZ||(ws[2]=0,l=t=>(ws[0]=t[0],ws[1]=t[1],ws));o=o||1===s,_s.push(s),_s.push(a.rings.length);for(const t of a.rings){_s.push(t.length);for(const s of t){const t=l(s);_s.push(t[0]),_s.push(t[1]),_s.push(t[2]),e=Math.min(e,t[0]),h=Math.min(h,t[1]),r=Math.max(r,t[0]),n=Math.max(n,t[1])}}}if(c(t))if(o){const s=1e-4;_s.push(2),_s.push(2),_s.push(4),_s.push(e-s),_s.push(h-s),_s.push(0),_s.push(r+s),_s.push(h-s),_s.push(0),_s.push(r+s),_s.push(n+s),_s.push(0),_s.push(e-s),_s.push(n+s),_s.push(0),_s.push(4),_s.push(t[0]),_s.push(t[1]),_s.push(0),_s.push(t[2]),_s.push(t[1]),_s.push(0),_s.push(t[2]),_s.push(t[3]),_s.push(0),_s.push(t[0]),_s.push(t[3]),_s.push(0)}else _s.push(1),_s.push(1),_s.push(4),_s.push(t[0]),_s.push(t[1]),_s.push(0),_s.push(t[2]),_s.push(t[1]),_s.push(0),_s.push(t[2]),_s.push(t[3]),_s.push(0),_s.push(t[0]),_s.push(t[3]),_s.push(0);_s.push(3);const a=new Float64Array(_s.length);for(let t=0;t<_s.length;++t)a[t]=_s.getItemAt(t);return a}class Ms{constructor(){this.ids=new Set,this.paused=!1}}class Ss{constructor({collection:t,forAllFeatures:s,forAllFeaturesOfNode:i}){this.highlights=[],this.collection=t,this.forAllFeatures=s,this.forAllFeaturesOfNode=i}destroy(){this.highlights.forEach((t=>this.releaseSet(t))),this.highlights=null}acquireSet(){const t=new Ms;this.highlights.push(t);const s={remove:()=>{this.releaseSet(t),u(this.highlights,t)},pause:()=>{this.releaseSet(t),t.paused=!0},resume:()=>{t.paused=!1,this.initializeSet(t)}};return{set:t,handle:s}}setFeatureIds(t,s){s.forEach((s=>t.ids.add(s))),this.initializeSet(t)}initializeSet(t){this.forAllFeatures(((s,i,e)=>(t.ids.has(s)&&this.collection.addComponentHighlight(e.objectHandle,i),1)))}releaseSet(t){this.forAllFeatures(((s,i,e)=>(t.ids.has(s)&&this.collection.removeComponentHighlight(e.objectHandle,i),1)))}objectCreated(t){this.highlights.forEach((s=>{s.paused||this.forAllFeaturesOfNode(t,((i,e)=>(s.ids.has(i)&&this.collection.addComponentHighlight(t.objectHandle,e),1)))}))}objectDeleted(t){this.collection.clearHighlights(t.objectHandle)}}class Os{constructor(t){this.view=t,this._preRenderFrameTaskHandle=null,this._currentFrameStartTime=null,this._numFadingNodes=0}get updating(){return this._numFadingNodes>0}stopNodeFading(t){null!=t.lodCrossfadeProgress&&(this._numFadingNodes--,t.lodCrossfadeProgress=null,0===this._numFadingNodes&&(null!=this._preRenderFrameTaskHandle&&(this._preRenderFrameTaskHandle=d(this._preRenderFrameTaskHandle)),this.view.notifyLODUpdate(),this.view.notifyUpdate()))}_startNodeFading(t,s,i){0===this._numFadingNodes&&(this._preRenderFrameTaskHandle=f({preRender:t=>this._updateAllNodeFading(t)}),this.view.notifyLODUpdate()),null==t.lodCrossfadeProgress&&(this._numFadingNodes++,this.view.notifyUpdate()),t.lodCrossfadeSignedDuration=i,t.lodCrossfadeProgress=s}_updateAllNodeFading(t){const s=this.view.nodeCrossfadingEnabled;this.view.foreachCrossfadeNode(((i,e)=>{if(c(e)&&c(e.lodCrossfadeProgress)){const h=e.lodCrossfadeSignedDuration,r=h>0?this.view.fullOpacity:0,n=e.lodCrossfadeProgress+Math.abs(t.deltaTime/h),o=!s||n>=1||0===h,a=r-(o?0:h>0?1:-1)*(1-n);o?(this.stopNodeFading(e),h<0&&this.view.markNodeToRemove(i)):e.lodCrossfadeProgress=n,this.view.setNodeOpacityByIndex(i,a)}})),this.view.removeMarkedNodes()}stopAllNodeFading(){this.view.foreachCrossfadeNode(((t,s)=>{if(c(s)&&c(s.lodCrossfadeProgress)){this.stopNodeFading(s);const i=s.lodCrossfadeSignedDuration;i<0&&this.view.markNodeToRemove(t),this.view.setNodeOpacityByIndex(t,i>0?this.view.fullOpacity:0)}})),this.view.removeMarkedNodes()}fadeNode(t,s,i,e){null==this._currentFrameStartTime&&(this._currentFrameStartTime=Date.now());const h=this.view,r=h.nodeCrossfadingEnabled,n=0===i?h.fullOpacity:0,o=r?e?0===i?h.lodCrossfadeinDuration:h.lodCrossfadeoutDuration:h.lodCrossfadeUncoveredDuration:0,a=this.view.getNodeOpacityByIndex(t);if(r&&a!==n&&o>0){const t=1-Math.abs(n-a);this._startNodeFading(s,t,function(t){return 0===t?1:-1}(i)*o)}else this.stopNodeFading(s),this.view.setNodeOpacityByIndex(t,n),1===i&&this.view.removeNode(t)}isNodeFullyFadedIn(t){const s=this.view.getNodeCrossfadeMetaData(t);return c(s)&&null==s.lodCrossfadeProgress&&this.view.getNodeOpacityByIndex(t)===this.view.fullOpacity}}const Cs=it(),Fs=T(),Ns=z(),Es=z(),As=z(),Is=a.getLogger("esri.views.3d.layers.i3s.I3SElevationProvider");let js=class extends(s.EventedMixin(n)){constructor(t){super(t),this.tmpEvent={spatialReference:null,extent:Cs,context:"scene"}}initialize(){this.view=this.layerView.view,this.renderCoordsHelper=this.view.renderCoordsHelper,this.intersector=new It(this.view.state.viewingMode),this.intersector.options.store=0;const s=this.layerView.i3slayer.fullExtent;t(s)?Is.error("I3SElevationProvider expected fullExtent on I3SLayer."):(this.zmin=s.zmin,this.zmax=s.zmax),this.tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}getElevation(t,s,i,e){if(Ns[0]=t,Ns[1]=s,Ns[2]=i,!this.renderCoordsHelper.toRenderCoords(Ns,e,Ns))return Is.error("could not project point to compute elevation"),null;const h=this.layerView.elevationOffset,r=this.zmin+h;return this.renderCoordsHelper.setAltitude(Es,this.zmax+h,Ns),this.renderCoordsHelper.setAltitude(As,r,Ns),this.intersector.reset(Es,As),this.intersectionHandler.intersect(this.intersector,null,Es,As),this.intersector.results.min.getIntersectionPoint(Ns)?this.renderCoordsHelper.getAltitude(Ns):null}layerChanged(){this.spatialReference&&(this.tmpEvent.extent=this.computeLayerExtent(),this.tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this.tmpEvent))}objectChanged(t){this.spatialReference&&(this.tmpEvent.extent=this.computeObjectExtent(t),this.tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this.tmpEvent))}computeObjectExtent(t){return it(Cs),this._expandExtent(t,Cs),Cs}computeLayerExtent(){it(Cs);for(const t of this.layerView.getVisibleNodes())this._expandExtent(t,Cs);return Cs}_expandExtent(t,s){const i=t.visibilityObb||t.serviceObbInRenderSR;if(c(i)){j(Fs,i.quaternion),Fs[12]=i.center[0],Fs[13]=i.center[1],Fs[14]=i.center[2];for(let t=0;t<8;++t)Ns[0]=1&t?i.halfSize[0]:-i.halfSize[0],Ns[1]=2&t?i.halfSize[1]:-i.halfSize[1],Ns[2]=4&t?i.halfSize[2]:-i.halfSize[2],V(Ns,Ns,Fs),this.renderCoordsHelper.fromRenderCoords(Ns,Ns,this.spatialReference),et(s,Ns,s)}else{const i=t.renderMbs[3],e=B(Es,t.renderMbs);e[0]-=i,e[1]-=i,e[2]-=i;const h=B(As,t.renderMbs);h[0]+=i,h[1]+=i,h[2]+=i;for(let t=0;t<8;++t)Ns[0]=1&t?e[0]:h[0],Ns[1]=2&t?e[1]:h[1],Ns[2]=4&t?e[2]:h[2],this.renderCoordsHelper.fromRenderCoords(Ns,Ns,this.spatialReference),et(s,Ns,s)}}};e([h({constructOnly:!0})],js.prototype,"layerView",void 0),e([h({constructOnly:!0})],js.prototype,"intersectionHandler",void 0),e([h()],js.prototype,"view",void 0),e([h({readOnly:!0,aliasOf:"view.elevationProvider.spatialReference"})],js.prototype,"spatialReference",void 0),js=e([r("esri.views.3d.layers.i3s.I3SElevationProvider")],js);const Ps=js;class Ds{constructor(t){this.type="I3S",this.layerUid=t.layerUid,this.sublayerUid=t.sublayerUid,this.collection=t.collection,this.traverseNodeHierarchy=t.traverseNodeHierarchy,this.slicePlane=t.slicePlaneEnabled,this.isGround=t.isGround}intersect(t,s,i,e){const h=t.results,r=2===t.options.store,n=t.ray.direction,o=t.tolerance;let a=t=>t,l=t=>t;const u=Bt(t.verticalOffset);c(u)&&(a=t=>u.applyToMbs(t),l=t=>u.applyToObb(t)),this.traverseNodeHierarchy(((d,f)=>!(c(d.serviceObbInRenderSR)&&!Dt(l(d.serviceObbInRenderSR),i,n,o)||(!f||c(d.geometryObb)&&!Dt(l(d.geometryObb),i,n,o)||!c(d.serviceObbInRenderSR)&&!function(t,s,i,e=0){const h=t[3]+e,r=s[0]-t[0],n=s[1]-t[1],o=s[2]-t[2],a=i[0],l=i[1],c=i[2],u=a*r+l*n+c*o;return u*u-(a*a+l*l+c*c)*(r*r+n*n+o*o-h*h)>=0}(a(d.renderMbs),i,n,o)||this.collection.intersect(f,i,e,o,u,((n,o,a,l)=>{if(o>=0){if(null!=s&&!s(i,e,o))return;const c=t=>{t.intersector=this.type,t.target={type:"external",metadata:{layerUid:this.layerUid,sublayerUid:this.sublayerUid,nodeIndex:d.index,componentIndex:n}},t.dist=o,B(t.normal,a),t.triangleNr=l};if(this.isGround&&(null==h.ground.dist||o<h.ground.dist)&&c(h.ground),t.options.isFiltered)return;if((null==h.min.dist||o<h.min.dist)&&c(h.min),(null==h.max.dist||o>h.max.dist)&&c(h.max),r){const s=new Vt(t.ray);c(s),t.results.all.push(s)}}})),0))))}get intersectionHandlerId(){return this.layerUid}}class Ts{constructor(t,s,i=14){this._version=i,this._db=null,this._quotaReductionPromise=null,this._gcCounter=0,this._hit=0,this._miss=0,this._destroyed=!1,this.gcFrequency=50,this.maxByteSize=1073741824,this.quotaReductionFactor=.2,this._dbName=t,this._storeName=s}init(){return Promise.resolve().then((()=>{const t=indexedDB.open(this._dbName,this._version);return t.onupgradeneeded=s=>{const i=t.result,e=t.transaction,h=i.objectStoreNames.contains(this._storeName)?e.objectStore(this._storeName):i.createObjectStore(this._storeName),r=i.objectStoreNames.contains("last_access")?e.objectStore("last_access"):i.createObjectStore("last_access");r.indexNames.contains("date")||r.createIndex("date","date",{unique:!1}),r.indexNames.contains("byteSize")||r.createIndex("byteSize","byteSize",{unique:!1}),s.oldVersion<this._version&&(h.clear(),r.clear())},Gs(t)})).then((t=>{this._destroyed?t.close():this._db=t}))}destroy(){this._db&&(this._db.close(),this._db=null),this._destroyed=!0}get initialized(){return null!=this._db}getHitRate(){return this._hit/(this._hit+this._miss)}put(t,s){return null==this._db?Promise.reject(new m("indexedb:not-initialized","IndexedDB Cache is not initialized")):(null!=this._quotaReductionPromise?this._quotaReductionPromise:Promise.resolve()).then((()=>this._put(t,s))).catch((i=>{if(i&&"QuotaExceededError"===i.name)return null==this._quotaReductionPromise&&(this._quotaReductionPromise=this._getCacheSize().then((t=>this._removeLeastRecentlyAccessed(s.byteSize+Math.ceil(t*this.quotaReductionFactor)))),this._quotaReductionPromise.then((()=>this._quotaReductionPromise=null),(()=>this._quotaReductionPromise=null))),this._quotaReductionPromise.then((()=>this._put(t,s)));throw i})).then((()=>{this._gcCounter--,this._gcCounter<0&&null!=this._db&&(this._gcCounter=this.gcFrequency,this._getCacheSize().then((t=>this._removeLeastRecentlyAccessed(t-this.maxByteSize))))}))}get(t,s){if(null==this._db)return Promise.resolve(null);let i=null;return Promise.resolve().then((()=>{const e=this._db.transaction(this._storeName,"readonly");return i=p(s,(()=>{e.abort()})),Gs(e.objectStore(this._storeName).get(t))})).then((s=>(null==s?++this._miss:this._db&&(++this._hit,this._db.transaction("last_access","readwrite").objectStore("last_access").put({date:Date.now(),byteSize:s.byteSize},t)),c(i)&&i.remove(),s))).catch((()=>(++this._miss,g(s),c(i)&&i.remove(),null)))}remove(t){return null==this._db?Promise.resolve():Promise.resolve().then((async()=>{const s=this._db.transaction([this._storeName,"last_access"],"readwrite"),i=s.objectStore(this._storeName),e=s.objectStore("last_access"),h=i.delete(t),r=e.delete(t);await Promise.all([Gs(h),Gs(r),Rs(s)])}))}_put(t,s){const i=this._db.transaction([this._storeName,"last_access"],"readwrite"),e=i.objectStore(this._storeName),h=i.objectStore("last_access"),r=e.put(s,t),n=h.put({date:Date.now(),byteSize:s.byteSize},t);return Promise.all([Gs(r),Gs(n),Rs(i)])}_removeLeastRecentlyAccessed(t){if(t<=0)return;const s=this._db.transaction([this._storeName,"last_access"],"readwrite"),i=s.objectStore(this._storeName),e=s.objectStore("last_access");let h=0;const r=e.index("date").openCursor(null,"next");return r.onsuccess=()=>{const s=r.result;null!=s&&(null!=s.value.byteSize&&(h+=s.value.byteSize),i.delete(s.primaryKey),e.delete(s.primaryKey),h<t&&s.continue())},Rs(s)}_getCacheSize(){const t=this._db.transaction("last_access"),s=t.objectStore("last_access");let i=0;const e=s.index("byteSize").openKeyCursor();return e.onsuccess=()=>{const t=e.result;if(!t)return;const s=t.key;null!=s&&(i+=s),t.continue()},Rs(t).then((()=>i))}}function Rs(t){return new Promise(((s,i)=>{t.oncomplete=()=>s(),t.onerror=()=>i(t.error),t.onabort=()=>i(t.error)}))}function Gs(t){return new Promise(((s,i)=>{"done"===t.readyState?null!=t.error?i(t.error):s(t.result):(t.onsuccess=()=>s(t.result),t.onerror=()=>i(t.error))}))}const Us=a.getLogger("esri.views.3d.layers.SceneLayerView3D"),Vs=[1,1,1,1];class Bs extends class{constructor(){this.lodCrossfadeSignedDuration=0}}{constructor(t,s,i,e,h,r,n){super(),this.node=t,this.featureIds=s,this.objectHandle=i,this.cachedRendererVersion=e,this.attributeInfo=h,this.material=r,this.textures=n,this.cachedEdgeMaterials=new Array,this.cachedSymbology=null}}const Ls=s=>{let n=class extends s{constructor(...t){super(t),this._elevationProvider=null,this._intersectionHandler=null,this._nodeId2Meta=new Map,this._nodeId2MetaReloading=new Map,this._i3sWasmLoaded=!1,this._hasLoadedPBRTextures=!1,this._asyncModuleLoading=0,this._addTasks=new Map,this._rendererVersion=0,this._colorVariable=null,this._opacityVariable=null,this._rendererFields=null,this._symbologyFields=null,this._symbologyOverride=null,this._symbologyOverrideFields=null,this._symbolInfos=new Map,this._idbCache=new Ts("esri-scenelayer-cache","geometries"),this.holeFilling="auto",this._hasColors=!1,this._hasTextures=!1,this._hasData=!1,this.slicePlaneEnabled=!1,this._modifications=new Array,this._layerUrl="",this._cacheKeySuffix=null,this._arcade=null,this._tmpAttributeOnlyGraphic=new N(null,null,{}),this._crossfadeHelper=new Os(this)}get lodCrossfadeoutDuration(){return 0}get lodCrossfadeinDuration(){return 0}get lodCrossfadeUncoveredDuration(){return 0}get layerUid(){return this.i3slayer&&this.i3slayer.uid}get sublayerUid(){return null}get hasTexturesOrVertexColors(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"}get rendererTextureUsage(){return zt(this._currentRenderer)?this._usePBR()||this._hasLoadedPBRTextures?63:37:this._usePBR()||this._hasLoadedPBRTextures?44:36}get elevationOffset(){const t=null!=this.i3slayer?this.i3slayer.elevationInfo:null;if(null!=t&&"absolute-height"===t.mode){const s=E(this.i3slayer.spatialReference),i=wt(t.unit);return y(t.offset,0)*i/s}return 0}get supportedTextureEncodings(){return ot(this.view._stage.renderView.capabilities)}get uncompressedTextureDownsamplingEnabled(){var t;return(null==(t=this.view)?void 0:t.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled)&&0==(4&this.supportedTextureEncodings)}initialize(){this.preLoadBasis(),this.addResolvingPromise(this.i3slayer.indexInfo);const t=this.view.resourceController;if(this.attributeOverrides=new at(this.i3slayer,t.memoryController),this._worker=new vs((s=>t.schedule(s))),this.addResolvingPromise(this._worker.promise),this._worker.setLegacySchema(this.layerUid,this.i3slayer.store.defaultGeometrySchema),kt(this.i3slayer),$t(this.i3slayer,this.view),this._layerUrl=this.i3slayer.parsedUrl.path,this._controller=new lt({layerView:this}),this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._collection=this._stage.renderView.componentObjectCollection,this._highlights=new Ss({collection:this._collection,forAllFeatures:t=>this._forAllFeatures(t,null,1),forAllFeaturesOfNode:(t,s)=>this._forAllFeaturesOfNode(t,s)}),this._isIntegratedMesh||!this.i3slayer.store.defaultGeometrySchema)this._hasSymbolColors=!1;else{const t=this.i3slayer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(t&&t.faceRange&&t.id)}this._hasVertexColors=null!=this.i3slayer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.i3slayer.cachedDrawingInfo||!this.i3slayer.cachedDrawingInfo.color),this._isIntegratedMesh||(this._edgeView=this._stage.renderView.ensureEdgeView());const s=this.view.resourceController.memoryController.newCache(this.i3slayer.uid,(t=>this._deleteComponentObject(t)));this._memCache=s,this._intersectionHandler=new Ds({layerUid:this.layerUid,sublayerUid:this.sublayerUid,collection:this._collection,slicePlaneEnabled:this.slicePlaneEnabled,isGround:this._isIntegratedMesh,traverseNodeHierarchy:t=>c(this._controller.index)&&c(this._controller.index.rootNode)?this._controller.index.traverse(this._controller.index.rootNode,(s=>{const i=s.index,e=this._nodeId2Meta.get(i)||this._nodeId2MetaReloading.get(i);return t(s,c(e)?e.objectHandle:null)})):()=>{}}),this._elevationProvider=new Ps({layerView:this,intersectionHandler:this._intersectionHandler}),this._hasLoadedPBRTextures=this._usePBR(),this.updatingHandles.add(this,"view.clippingArea",(()=>this._clippingAreaChanged()),2),this.updatingHandles.add(this,"fullOpacity",(t=>this._opacityChange(t))),this.updatingHandles.add(this,"slicePlaneEnabled",(t=>this._slicePlaneEnabledChange(t))),this.updatingHandles.add(this,"elevationOffset",((t,s)=>{this._reloadAll(s),this._controller.invalidateVisibilityObbs()})),this.updatingHandles.add(this,"filter",(()=>this._filterChange()),2),this.updatingHandles.add(this,"view.qualitySettings.physicallyBasedRenderingEnabled",(()=>this._updatePBR()));const i=()=>{this._reloadAll(),this.clearMemCache()};this.updatingHandles.add(this,"rendererTextureUsage",i),this.updatingHandles.add(this,"uncompressedTextureDownsamplingEnabled",i),this.updatingHandles.add(this,"suspended",(t=>this._suspendedChange(t)),2),this.updatingHandles.add(this.i3slayer,"labelsVisible",(()=>this._labelingChanged()),2),this.updatingHandles.add(this.i3slayer,"labelingInfo",(()=>this._labelingChanged()),2),this.updatingHandles.add(this,"_modifications",(()=>this._modificationsChanged()),2),this.handles.add([b(jt,"I3S_TREE_SHOW_TILES",(t=>{if(t&&!this._treeDebugger){const t=this._controller.crsIndex;import("./p-261f8f20.js").then((({I3STreeDebugger:s})=>{!this._treeDebugger&&jt.I3S_TREE_SHOW_TILES&&(this._treeDebugger=new s({lv:this,view:this.view,nodeSR:t}))}))}else t||jt.I3S_TREE_SHOW_TILES||(this._treeDebugger=v(this._treeDebugger))})),b(jt,"I3S_SHOW_MODIFICATIONS",(()=>this._showModifications()))]),this._cacheKeySuffix=Ht(this.i3slayer.spatialReference,this.view.renderSpatialReference),this._idbCache.init().catch((t=>Us.warn(`Failed to initialize IndexedDB cache: ${t}`)))}destroy(){this._clearAddTasks(),this.attributeOverrides=v(this.attributeOverrides),this._elevationProvider&&(this._elevationProvider.layerChanged(),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this._intersectionHandler&&(this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);const t=this._worker;t&&(t.destroyContext(this.i3slayer.uid).then((()=>t.destroy())),this._worker=null),this._removeAllNodeDataFromStage(),this._memCache=v(this._memCache),this._collection=null,this._stage=null,this._edgeView=null,this._labeler=v(this._labeler),this._treeDebugger=v(this._treeDebugger),this._controller=v(this._controller),this._highlights.destroy(),this._nodeId2Meta.clear(),this._nodeId2MetaReloading.clear(),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}memEstimateTextureAdded(t){const s=t.estimatedTexMemRequired;return this.gpuMemoryEstimate+=s,this.texMemoryEstimate+=s,s}memEstimateTextureRemoved(t){if(c(t)){const s=t.estimatedTexMemRequired;this.gpuMemoryEstimate-=s,this.texMemoryEstimate-=s}}memEstimateGeometryAdded(t){const s=this._collection.getObjectGPUMemoryUsage(t);return this.gpuMemoryEstimate+=s,this.geoMemoryEstimate+=s,s}memEstimateGeometryRemoved(t){const s=this._collection.getObjectGPUMemoryUsage(t);this.gpuMemoryEstimate-=s,this.geoMemoryEstimate-=s}isNodeLoaded(t){return this._nodeId2Meta.has(t)}isNodeReloading(t){return this._nodeId2MetaReloading.has(t)}getUsedMemory(){let t=c(this._labeler)?this._labeler.usedMemory:0;return this._nodeId2Meta.forEach((s=>t+=c(s)?s.node.memory:0)),this._nodeId2MetaReloading.forEach((s=>t+=c(s)?s.node.memory:0)),t}getUnloadedMemory(){return(c(this._controller)?this._controller.unloadedMemoryEstimate:0)+(c(this._labeler)?this._labeler.unloadedMemoryEstimate:0)}ignoresMemoryFactor(){return!1}_labelingChanged(){if(!pt(this.i3slayer)||!this._supportsLabeling)return void(c(this._labeler)&&(this._labeler.destroy(),this._labeler=null));if(c(this._labeler))return;const t=new ys({view:this.view,layer:this.i3slayer,collection:this._collection});this._nodeId2Meta.forEach((s=>c(s)&&this._addMetaToLabeler(t,s))),this._labeler=t}_loadAsyncModule(t){return++this._asyncModuleLoading,t.then((t=>(--this._asyncModuleLoading,t)),(t=>{throw--this._asyncModuleLoading,t}))}_modificationsChanged(){if(!this._i3sWasmLoaded&&this.hasModifications)return this._i3sWasmLoaded=Ft().then((()=>{this._i3sWasmLoaded=!0,this._modificationsChanged(),this.notifyUpdate()})),void this.notifyUpdate();if(!0!==this._i3sWasmLoaded)return;const s=this.i3slayer.uid,i=this.i3slayer.spatialReference;this._worker.setModifications(s,this._layerClippingArea,this._modifications,i);const e=xs(this._layerClippingArea,this._modifications,i);Nt({context:s,modifications:e,isGeodetic:i.isGeographic}),this._controller.modificationsChanged();const h=this.hasModifications?new l:null;this._nodeId2Meta.forEach(((s,i)=>{t(s)?this._nodeId2Meta.delete(i):s.node.hasModifications?(this._nodeId2Meta.delete(i),this._nodeId2MetaReloading.set(i,s)):c(h)&&h.push(s.node)})),c(h)&&this._nodeId2MetaReloading.forEach((t=>h.push(t.node))),c(h)&&h.length>0&&(this.updateNodeModificationStatus(h),h.forAll((t=>{if(2!==t.imModificationImpact){const s=this._nodeId2Meta.get(t.index);this._controller.invalidateGeometryVisibility(t.index),this._nodeId2Meta.delete(t.index),c(s)&&this._nodeId2MetaReloading.set(t.index,s)}}))),this.clearMemCache(),this._controller.restartNodeLoading(),this._showModifications()}_showModifications(){if(c(this._modificationGraphics)&&(this.view.graphics.removeMany(this._modificationGraphics),this._modificationGraphics=null),!jt.I3S_SHOW_MODIFICATIONS||0===this._modifications.length)return;const t={clip:[227,227,79,.8],mask:[227,139,79,.8],replace:[139,227,79,.8]},s={type:"simple-fill",outline:{color:[255,255,255],width:1}};this._modificationGraphics=new Array;for(const i of this._modifications){i.geometry.spatialReference=this.i3slayer.spatialReference;const e={...s,color:t[i.type]};this._modificationGraphics.push(new N({geometry:i.geometry,symbol:e}))}this.view.graphics.addMany(this._modificationGraphics)}_addMetaToLabeler(t,s){t.addNodeMeta(s,((t,s)=>this._createAttributes(t,s)))}_suspendedChange(t){t?(this._removeAllNodeDataFromStage(),this.view.elevationProvider&&this.view.elevationProvider.unregister(this._elevationProvider),this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler)):(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler))}getLoadedAttributes(t){const s=this._nodeId2Meta.get(t);if(c(s)&&c(s.attributeInfo))return s.attributeInfo.loadedAttributes}getAttributeData(t){const s=this._nodeId2Meta.get(t);if(c(s)&&c(s.attributeInfo))return s.attributeInfo.attributeData}setAttributeData(t,s){const i=this._nodeId2Meta.get(t);c(i)&&c(i.attributeInfo)&&(i.attributeInfo.attributeData=s,this._attributeValuesChanged(i))}async updateAttributes(t,s,i){const e=this._nodeId2Meta.get(t);c(e)&&(await this.attributeOverrides.apply(e.featureIds,s,i),e.attributeInfo=s,this._attributeValuesChanged(e))}_attributeValuesChanged(t){t.cachedRendererVersion=this._getInvalidRendererVersion(),t.filteredIds=null,c(this._labeler)&&this._labeler.setNodeMetaAttributes(t,((t,s)=>this._createAttributes(t,s))),this._updateEngineObject(t)}clearMemCache(){c(this._memCache)&&this._memCache.clear()}getVisibleNodes(){const t=new Array;return this._nodeId2Meta.forEach((s=>c(s)&&t.push(s.node))),t}getLoadedNodeIndices(t){this._nodeId2Meta.forEach(((s,i)=>t.push(i))),this._nodeId2MetaReloading.forEach(((s,i)=>t.push(i)))}preLoadBasis(){!_("disable-feature:i3s-basis")&&0!=(2&this.supportedTextureEncodings)&&w(this.i3slayer.textureSetDefinitions,(t=>t.some((t=>t.formats.some((t=>"basis"===t.format||"ktx2"===t.format))))))&&Lt()}_getVertexBufferLayout(t,s){const i={hasTexture:Js(t.params.material),hasNormals:s.normal,hasRegions:s.uvRegion};return rs(Gt(this._getGeometryParameters(i)))}_getObjectIdField(){return this.i3slayer.objectIdField||"OBJECTID"}_findGraphicNodeAndIndex(s){const e=es(this.i3slayer.fieldsIndex,s.attributes,this._getObjectIdField());let h=null;return i(this._nodeId2Meta,(s=>{if(t(s))return!1;const i=s.featureIds.indexOf(e);return-1!==i&&(h={node:s.node,index:i},!0)})),h}_getGraphicIndices(s,i){const e=this._nodeId2Meta.get(s.index);if(t(e))return[];const h=[],r=this._getObjectIdField(),n=this.i3slayer.fieldsIndex;for(const t of i){const s=es(n,t.attributes,r),i=e.featureIds.indexOf(s);-1!==i&&h.push(i)}return h}whenGraphicBounds(s){const i=this._findGraphicNodeAndIndex(s);if(!i)return Promise.reject();const e=this._nodeId2Meta.get(i.node.index);if(t(e))return Promise.reject();const h=ns(i.index,this._collection,e.objectHandle,new Float64Array(24));if(k(h,this.view.renderSpatialReference,0,h,this.view.spatialReference,0,8)){const t=tt();return Q(t,h,0,8),Promise.resolve({boundingBox:t,screenSpaceObjects:[]})}}whenGraphicAttributes(t,s){return qt(this.i3slayer,t,this._getObjectIdField(),s,(()=>[...this._nodeId2Meta.values()].filter(c)))}getGraphicFromIntersectorMetadata(s){if(null==s.nodeIndex||null==s.componentIndex)return null;const i=this._nodeId2Meta.get(s.nodeIndex);return t(i)||null==i.featureIds||s.componentIndex>=i.featureIds.length?null:this._createGraphic(s.componentIndex,i)}_getCacheKey(t){return`${this._layerUrl}/v19/${t.id}${this._cacheKeySuffix}`}_getMemCacheKey(t,s=this.elevationOffset){return t+"#"+s}get _idbCacheEnabled(){return!this._controller.disableIDBCache&&!this.hasModifications&&0===this.elevationOffset&&null!=this._cacheKeySuffix}loadCachedGPUData(t){return c(this._memCache)?this._memCache.pop(this._getMemCacheKey(t.index)):null}deleteCachedGPUData(t){c(t)&&this._deleteComponentObject(t)}_cacheGPUData(s,i=this.elevationOffset){if(t(this._memCache))return void this._deleteComponentObject(s);const e=this._controller.indexDepth-s.node.level;this._memCache.put(this._getMemCacheKey(s.node.index,i),s,s.node.memory,e)}loadMissingTextures(s,i,e,h){const r=s.filter(((s,e)=>{if(0==(s.usage&this.rendererTextureUsage))return!1;if(t(i))return!0;const h=ct(s.encodings,this.supportedTextureEncodings),r=i[e];return!!(t(r)||null==r.data||h&&r.encoding!==h.encoding)}));return 0===r.length?Promise.resolve(!1):e(r,h).then((t=>{let e=0;for(let h=0;h<s.length;h++)e<t.length&&t[e].id===s[h].id&&(i[h]=t[e],e++);return!0}))}loadCachedNodeData(t,s,i){return this._idbCacheEnabled?this._idbCache.get(this._getCacheKey(t),s).then((e=>null==e?null:e.nodeVersion!==t.version?(this._idbCache.remove(this._getCacheKey(t)),null):(t.geometryObb=e.geometryObb,this.loadMissingTextures(e.requiredTextures,e.textureData,i,s).then((i=>(i&&this._idbCache.initialized&&c(e.textureData)&&(e.byteSize=Qs(e.transformedGeometry,e.textureData),e.textureData.every(Zs)&&Xs(t,e)&&this._idbCache.put(this._getCacheKey(t),e).catch((s=>Us.warn(`Failed to update node with textures in IndexedDB cache: ${t.id}: ${s}`)))),g(s),e)))))):Promise.resolve(null)}addNode(s,i,e){return function(t){return"geometryData"in t}(i)?this._addData(s,i.attributeDataInfo,(()=>this._transformNode(s,i,e).then((h=>this._safeReschedule((()=>{if(t(h))return s.hasModifications=!1,this._addCachedNodeData(s,null,e);s.hasModifications=h.transformedGeometry.hasModifications;const{obb:r,componentOffsets:n,featureIds:o,transformedGeometry:a}=h,l=Wt(s.mbs,this.elevationOffset,this._controller.crsIndex,this.view.renderSpatialReference);s.geometryObb=Tt([r.center.x,r.center.y,r.center.z],[r.extents.x,r.extents.y,r.extents.z],[r.orientation.x,r.orientation.y,r.orientation.z,r.orientation.w]),V(s.geometryObb.center,s.geometryObb.center,l),i.geometryData.componentOffsets=n,o&&(i.geometryData.featureIds=Array.prototype.slice.call(o));const u={nodeVersion:s.version,geometryData:i.geometryData,requiredTextures:i.requiredTextures,textureData:i.textureData,transformedGeometry:a,globalTrafo:l,geometryObb:s.geometryObb,byteSize:Qs(a,i.textureData)};if(this._idbCacheEnabled&&this._idbCache.initialized&&Xs(s,u)){const t=c(u.textureData)?u.textureData.map((t=>Zs(t)?t:null)):null;this._idbCache.put(this._getCacheKey(s),{...u,textureData:t}).catch((t=>Us.warn(`Failed to store node in IndexedDB cache: ${s.id}: ${t}`)))}return this._addCachedNodeData(s,u,e)}),e))))):Promise.reject()}computeVisibilityObb(t){return Kt(t,this.view.renderSpatialReference,this._controller.crsIndex,this.i3slayer.spatialReference,this.elevationOffset,this._modifications)}_transformNode(s,i,e){const h=i.geometryData.geometries,r=new Array(h.length);for(let t=0;t<h.length;++t)r[t]=this._getVertexBufferLayout(h[t],i.geometryDescriptor);const n=s.mbs,o=this.elevationOffset,a=this._controller.crsIndex,l=this._controller.crsVertex,c=this.view.renderSpatialReference,u=Jt(n,o,a),d=Wt(n,o,a,c),f=q(a,l),m=q(l,c);return t(f)||t(m)?Promise.resolve(null):this._worker.invoke({context:this.i3slayer.uid,geometryBuffer:i.geometryBuffer,geometryData:i.geometryData,geometryDescriptor:i.geometryDescriptor,layouts:r,localOrigin:u,globalTrafo:d,mbs:n,obb:s.serviceObb,elevationOffset:o,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.i3slayer.normalReferenceFrame||"none",indexToVertexProjector:f,vertexToRenderProjector:m},e)}get supportsNodeCrossFading(){var t,s;return!(null!=(t=this.view)&&null!=(s=t._stage)&&s.renderView.hasShadowsEnabled)}get nodeCrossfadingEnabled(){return this.supportsNodeCrossFading&&(this.lodCrossfadeinDuration>0||this.lodCrossfadeoutDuration>0||this.lodCrossfadeUncoveredDuration>0)}get nodeFadeoutEnabled(){return this.supportsNodeCrossFading&&this.lodCrossfadeoutDuration>0}_setNewNodeOpacity(t){this._setNodeOpacity(t,this.nodeCrossfadingEnabled?0:this.fullOpacity)}addCachedGPUData(t,s,i){if(t.geometryObb=Ut(this._collection.getComponentObb(s.objectHandle)),!this._controller.isGeometryVisible(t))return void this._cacheGPUData(s);c(this._labeler)&&this._addMetaToLabeler(this._labeler,s);const e=t.index;this._addNodeMeta(e,s),this.updateNodeState(e,i),this._collection.setObjectVisibility(s.objectHandle,1),this._updateMaterial(s),this._setNewNodeOpacity(s),this._updateEngineObject(s),this._highlights.objectCreated(s),c(this._treeDebugger)&&this._treeDebugger.update()}addCachedNodeData(t,s,i,e){return this._addData(t,i,(()=>this._addCachedNodeData(t,s,e)))}async _addCachedNodeData(s,i,e){if(this.suspended||!this._controller.isGeometryVisible(s))return void this._removeNodeStageData(s.index,this.elevationOffset,this._nodeId2MetaReloading);if(t(i))return void this._addNodeMeta(s.index,null);const h=this._addTasks.get(s.index),{geometryData:r,transformedGeometry:n,globalTrafo:o}=i;await this.attributeOverrides.apply(r.featureIds,h.attributeInfo,e);const a=c(i.textureData)?i.textureData.filter((t=>c(t)&&0!=(t.usage&this.rendererTextureUsage))):[];!_("disable-feature:i3s-basis")&&a.some((t=>c(t)&&(2===t.encoding||1===t.encoding)))&&await Lt(),s.memory=0;const{componentOffsets:l,geometries:u,featureIds:d}=r,f=this._collection,m=u[0],{layout:p,indices:g,interleavedVertexData:y,positionData:b,hasColors:v}=n,w=this._materialParameters(m,p),x=l||new Uint32Array([0,g?g.length:y.byteLength/p[0].stride]),S={vertices:{data:y,count:y.byteLength/p[0].stride,layoutParameters:w.geometryParams},positionData:{positions:b.data,indices:b.indices},indices:g,componentOffsets:x},O=m.transformation?R(m.transformation):T();P(O,o,O);const C=D(z(),O),F=A(I(),O),N=this.view.renderSpatialReference,E=this.view.basemapTerrain.spatialReference,j=z(),G=[1,1,1];W(C,N,G,E)||Us.errorOnce("Unsupported coordinate system for IM overlay"),H(C,N,j,E);const U=f.createObject({toMapSpace:[j[0],j[1],G[0],G[1]],geometry:S,obb:M(s.geometryObb),transform:{position:C,rotationScale:F}}),V=this._initMaterialAndTextures(U,w.material,a,2===w.geometryParams.textureCoordinates);s.memory+=this.memEstimateGeometryAdded(U),s.memory+=V.reduce(((t,s)=>t+(c(s)?this.memEstimateTextureAdded(s):0)),0);const B=!!w.material.hasParametersFromSource,L="blend"!==w.material.alphaMode&&w.material.metallicRoughness.baseColorFactor[3]>=1,k=new Bs(s,d,U,this._getInvalidRendererVersion(),h.attributeInfo,{hasParametersFromSource:B,isOpaque:L},V);h.meta=k,!this._hasTextures&&i.requiredTextures.some((({usage:t})=>0!=(19&t)))&&(this._hasTextures=!0),this._hasData=!0,this._hasColors=this._hasColors||v,this._hasTextures=this._hasTextures||!!s.resources.texture,this.notifyChange("hasTexturesOrVertexColors");const $=this.slicePlaneEnabled;return this._addOrUpdateEdgeRendering(k).then((t=>(c(t)&&t.updateObjectVisibility(k.objectHandle,!1),this._safeReschedule((()=>{const i=this._addTasks.get(s.index);if(!i)return;if(c(this._labeler)&&this._addMetaToLabeler(this._labeler,k),this._addNodeMeta(s.index,k),i.meta=null,this.suspended)return void this._removeNodeStageData(s.index,this.elevationOffset);f.setObjectVisibility(U,1),c(t)&&t.updateObjectVisibility(k.objectHandle,!0),k.attributeInfo=i.attributeInfo;const e=k.cachedRendererVersion!==this._rendererVersion,h=$!==this.slicePlaneEnabled;this._setObjectSymbolColors(k);const r=this._applyFiltersToNode(k);(e||c(t)&&(h||r))&&this._addOrUpdateEdgeRendering(k),this._visibleGeometryChanged(k),this._highlights.objectCreated(k),this._updateMaterial(k),this._setNewNodeOpacity(k),c(this._treeDebugger)&&this._treeDebugger.update()}),e)))).catch((t=>{throw c(h.meta)&&(this._cacheGPUData(h.meta),h.meta=null),t}))}_addNodeMeta(t,s){if(this._removeNodeStageData(t,this.elevationOffset,this._nodeId2MetaReloading),this._nodeId2Meta.has(t)){Us.error("Removing duplicated node");const s=this._nodeId2Meta.get(t);c(s)&&this._deleteComponentObject(s)}c(s)&&(s.lodCrossfadeProgress=null,this.nodeCrossfadingEnabled&&ti(s.cachedEdgeMaterials,0)),this._nodeId2Meta.set(t,s)}_safeReschedule(t,s){return g(s),this._controller.reschedule(t,s)}_materialParameters(t,s){const i=t.params.material,e=s.some((t=>"uvRegion"===t.name)),h=s.some((t=>"normalCompressed"===t.name)),r=Js(i);return{geometryParams:this._getGeometryParameters({hasTexture:r,hasNormals:h,hasRegions:e}),material:i}}_initMaterialAndTextures(t,s,i,e){const h=this._stage.renderView,r=i.map((t=>ut(t,s,e,h)));return this._stage.addMany(r),this._collection.updateMaterial(t,(t=>{dt(t,s,r,i,this.view._stage.renderView.textureRepository,{rendererTextureUsage:this.rendererTextureUsage,usePBR:this._usePBR(),isIntegratedMesh:this._isIntegratedMesh,slicePlaneEnabled:this.slicePlaneEnabled,viewSpatialReference:this.view.spatialReference}),this._updateMaterialOverlay(t)})),r}_getGeometryParameters(t){return{textureCoordinates:t.hasTexture?t.hasRegions?2:1:0,colors:this._hasVertexColors,normals:t.hasNormals&&!this._isIntegratedMesh}}_addData(t,s,i){let e=this._addTasks.get(t.index);return e?e.attributeInfo=s:(e={...S(),attributeInfo:s,meta:null},this._addTasks.set(t.index,e),i().then(e.resolve,e.reject).then((()=>this._addTasks.delete(t.index))).catch((s=>{throw this._addTasks.delete(t.index),s}))),e.promise}_clearAddTasks(){this._addTasks.forEach((t=>{c(t.meta)&&(this._cacheGPUData(t.meta),t.meta=null)})),this._addTasks.clear()}_clippingAreaChanged(){const t=this.view.renderSpatialReference,s=this.i3slayer.spatialReference,i=rt();this._renderClippingArea=hs(this.view.clippingArea,i,t)?i:null;const e=rt();this._layerClippingArea=hs(this.view.clippingArea,e,s)?e:null,this._filterChange(),this._controller&&this._controller.updateClippingArea(this.view.clippingArea),this._isIntegratedMesh&&this._modificationsChanged()}_geometryFilterChange(){this._controller.geometryFilterChanged(this.hasGeometryFilter)}get hasGeometryFilter(){return!1}_filterChange(){this._applyFilters(!1)}_applyFilters(t){this._filters=this.getFilters(),t?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach((t=>{c(t)&&this._applyFiltersToNode(t)&&(this._addOrUpdateEdgeRendering(t),this._visibleGeometryChanged(t))}))}getFilters(){const t=[],s=this._renderClippingArea;return c(s)&&t.push(((t,i)=>this._boundingRectFilter(t,i,s))),t}addSqlFilter(t,s,i){if(c(s)){const e=s.fieldNames;t.push(((t,h)=>this._sqlFilter(t,h,s,e,i)))}}_sqlFilter(t,s,i,e,h){const r={},n=this._createLayerGraphic(r),o=this.i3slayer.objectIdField,a=s.featureIds,l=c(s.attributeInfo)&&s.attributeInfo.attributeData;e.every((t=>null!=l[t]||t===o))&&Zt(t,a,(t=>{r[o]=a[t];for(const s of e)s!==o&&(r[s]=ts(l[s],t));try{return i.testFeature(n)}catch(t){return h(t),!1}}))}_boundingRectNodeTest(t,s){return K(t.node.mbs,this._controller.crsIndex,Ks,this.view.renderSpatialReference),Qt(s,Ks)}_boundingRectFeatureTest(t,s,i){return this._collection.getComponentAabb(t.objectHandle,s,zs),st(zs,ks),ht(i,ks)}_boundingRectFilter(t,s,i){const e=this._collection,h=this._boundingRectNodeTest(s,i);if(3===h)return;if(0===h)return void(t.length=0);const r=e.getComponentCount(s.objectHandle);if(r.invisible+r.visible!==s.featureIds.length)return;const n=this._transformClippingArea($s,i,s.objectHandle);Zt(t,s.featureIds,(t=>this._boundingRectFeatureTest(s,t,n)))}_transformClippingArea(t,s,i){const e=this._collection.getObjectTransform(i),h=e.position,r=e.rotationScale;return t[0]=(s[0]-h[0])/r[0],t[1]=(s[1]-h[1])/r[4],t[2]=(s[2]-h[0])/r[0],t[3]=(s[3]-h[1])/r[4],t}_addOrUpdateEdgeRendering(s,i=!0){if(t(this._edgeView))return Promise.resolve(null);const e=s.objectHandle,h=this._edgeView.hasObject(e),{hasEdges:r,perFeatureEdgeMaterials:n}=this._getFilteredEdgeMaterials(s),o={slicePlaneEnabled:this.slicePlaneEnabled};return r?h?(this.nodeCrossfadingEnabled&&ti(n,this.getNodeOpacity(s)),this._edgeView.updateAllComponentMaterials(e,n,o,i),this._edgeView.updateObjectVisibility(e,!0),Promise.resolve(this._edgeView)):this._collection.addEdges(e,this._edgeView,n,o).then((()=>this._edgeView)):(h&&this._edgeView.removeObject(e),Promise.resolve(null))}_removeEdgeRendering(t){c(this._edgeView)&&this._edgeView.hasObject(t.objectHandle)&&this._edgeView.removeObject(t.objectHandle)}_applyFiltersToNode(t){return!!this._applyFiltersToNodeComponents(t)&&(c(this._labeler)&&this._labeler.applyFilterChange(t),!0)}_applyFiltersToNodeComponents(t){const s=this._collection,i=0===s.getComponentCount(t.objectHandle).invisible;if(s.setAllComponentVisibilities(t.objectHandle,"all"),0===this._filters.length)return t.filteredIds=null,!i;if(this._updateCachedFilteredIds(t),t.filteredIds===t.featureIds)return!i;const e=this._computeFilteredComponentIndices(t);return s.setAllComponentVisibilities(t.objectHandle,e),!0}_updateCachedFilteredIds(t){null!=t.filteredIds&&t.appliedFilters===this._filters||(t.filteredIds=this._computeFilteredIds(t),t.appliedFilters=this._filters)}_computeFilteredIds(t){const s=t.featureIds.slice();for(const i of this._filters)if(i(s,t),0===s.length)break;return s.length===t.featureIds.length?t.featureIds:s}_computeFilteredComponentIndices(t){const s=new Array;return t.featureIds.forEach(((i,e)=>{t.filteredIds[s.length]===i&&s.push(e)})),s}_removeAllNodeDataFromStage(t=this.elevationOffset){this._nodeId2Meta.forEach(((s,i)=>this._removeNodeStageData(i,t))),this._nodeId2MetaReloading.forEach(((s,i)=>this._removeNodeStageData(i,t,this._nodeId2MetaReloading)))}removeNode(t){const s=this.elevationOffset;this._removeNodeStageData(t,s),this._removeNodeStageData(t,s,this._nodeId2MetaReloading)}_removeNodeStageData(s,i,e=this._nodeId2Meta){const h=e.get(s);t(h)?e.delete(s):(this._collection.setObjectVisibility(h.objectHandle,0),this._visibleGeometryChanged(h),this._removeEdgeRendering(h),c(this._labeler)&&this._labeler.removeNodeMeta(h),e.delete(s),this._highlights.objectDeleted(h),e===this._nodeId2Meta?(this._cacheGPUData(h,i),this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopNodeFading(h)):this._deleteComponentObject(h),c(this._treeDebugger)&&this._treeDebugger.update())}_deleteComponentObject(t){if(c(this._edgeView)&&this._edgeView.removeObject(t.objectHandle),this.memEstimateGeometryRemoved(t.objectHandle),this._collection.destroyObject(t.objectHandle),t.textures)for(const s of t.textures)this.memEstimateTextureRemoved(s),this._stage.remove(s)}updateNodeState(t,s){const i=this._nodeId2Meta.get(t);c(i)&&this._collection.updateMaterial(i.objectHandle,(t=>t.polygonOffsetEnabled=0===s))}_invalidateAllSymbols(){this._rendererVersion=Xt(this._rendererVersion,1),this._controller&&this._controller.requestUpdate()}_getInvalidRendererVersion(){return Xt(this._rendererVersion,-1)}async _rendererChange(t){if(this._currentRenderer=t,this.notifyChange("rendererTextureUsage"),this._rendererVersion=Xt(this._rendererVersion,1),this._rendererFields=null,this._colorVariable=null,this._opacityVariable=null,this._invalidateAllSymbols(),t&&(this._rendererFields=await t.getRequiredFields(this.i3slayer.fieldsIndex)),this._updateSymbologyFields(),!this._arcade&&t&&"arcadeRequired"in t&&t.arcadeRequired&&(this._arcade=await ft()),t&&"visualVariables"in t&&t.visualVariables)for(const s of t.visualVariables)"color"===s.type?this._colorVariable=s:"opacity"===s.type?this._opacityVariable=s:Us.warn(`Unsupported visual variable type for 3D Object Scene Services: ${s.type}`);if(t)for(const s of t.getSymbols())"mesh-3d"!==s.type&&Us.error(`Symbols of type '${s.type}' are not supported for 3D Object Scene Services.`);this._controller&&this._controller.requestUpdate()}_getCachedEdgeMaterials(t){return this._hasSymbolColors&&t.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(t),t.cachedEdgeMaterials}_getSymbolColors(t){this._hasSymbolColors&&t.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(t);const s=t.cachedSymbology;return(t,i)=>{const e=5*t;L(i.externalColor,s[e+0]/255,s[e+1]/255,s[e+2]/255,s[e+3]/255),i.externalColorMixMode=15&s[e+4],i.castShadows=0!=(16&s[e+4]),i.pickable=0!=(32&s[e+4])}}_getSymbolInfo(t,s){const i=t&&t.getSymbol(s,{arcade:this._arcade});if(!(i instanceof _t))return null;const e=i.id;if(this._symbolInfos.has(e))return this._symbolInfos.get(e);const h=Yt(i);return this._symbolInfos.set(e,h),h}_setSymbologyOverride(t,s){this._symbologyOverride!==t&&(this._symbologyOverride=t,this._symbologyOverrideFields=s,this._invalidateAllSymbols(),this._updateSymbologyFields())}_updateSymbologyFields(){this._symbologyFields=c(this._symbologyOverrideFields)&&this._symbologyOverrideFields.length>0?c(this._rendererFields)&&this._rendererFields.length>0?mt(this.i3slayer.fieldsIndex,[...this._rendererFields,...this._symbologyOverrideFields]):this._symbologyOverrideFields:this._rendererFields}_updateCachedRendererData(s){if(s.cachedRendererVersion=this._rendererVersion,!this._hasSymbolColors)return;const i=this._tmpAttributeOnlyGraphic,e={};i.attributes=e;const h=this._currentRenderer,r=c(s.attributeInfo)&&s.attributeInfo.attributeData,n=null!=s.featureIds?this.i3slayer.objectIdField:null,o=null!=r&&c(this._symbologyFields)&&this._symbologyFields.length>0,a=o?[]:null,l=o?[]:null;if(o&&c(this._symbologyFields))for(const t of this._symbologyFields){const s=r[t];s&&(a.push(t),l.push(s))}s.cachedSymbology||(s.cachedSymbology=new Uint8Array(5*s.featureIds.length));const u={color:qs,castShadows:!0,pickable:!0,colorMixMode:1,edgeMaterial:null},d=this.fullOpacity,f=this.nodeCrossfadingEnabled?this.getNodeOpacity(s):d;let m=null,p=2,g=ss,y=0;for(let r=0;r<s.featureIds.length;r++){if(null!=n&&(e[n]=s.featureIds[r]),o)for(let t=0;t<a.length;t++)e[a[t]]=ts(l[t],r);const d=this._getSymbolInfo(h,i);let b=null,v=null;if(h&&"visualVariables"in h){if(this._colorVariable){const t=yt(this._colorVariable,i,{color:Ws,arcade:this._arcade});t&&(b=qs,b[0]=t.r/255,b[1]=t.g/255,b[2]=t.b/255,this._opacityVariable||null===t.a||(v=t.a))}this._opacityVariable&&(v=bt(this._opacityVariable,i,{arcade:this._arcade}))}if(d&&d.material){const s=d.material;b=t(b)||t(v)?Pt(b,v,s.color,s.alpha,Vs,qs):Pt(b,v,null,null,Vs,qs)}if(t(b)&&(b=qs,b[0]=1,b[1]=1,b[2]=1,b[3]=1),u.pickable=!0,u.castShadows=!d||d.castShadows,u.colorMixMode=d&&d.material?d.material.colorMixMode:1,u.edgeMaterial=d?d.edgeMaterial:null,c(this._symbologyOverride)&&(u.color=b,this._symbologyOverride(i,u),b=u.color),c(u.edgeMaterial)){const t=b[3]<=0?0:b[3]>=1&&(s.material.isOpaque||3===u.colorMixMode)?2:1;u.edgeMaterial===m&&t===p||(g={...u.edgeMaterial,opacity:f,objectTransparency:t},m=u.edgeMaterial,p=t),s.cachedEdgeMaterials[r]=g}else s.cachedEdgeMaterials[r]=ss;s.cachedSymbology[y+0]=Math.round(255*b[0]),s.cachedSymbology[y+1]=Math.round(255*b[1]),s.cachedSymbology[y+2]=Math.round(255*b[2]),s.cachedSymbology[y+3]=Math.round(255*b[3]),s.cachedSymbology[y+4]=u.colorMixMode|+u.castShadows<<4|+u.pickable<<5,y+=5}}_getFilteredEdgeMaterials(s){const i=this._getCachedEdgeMaterials(s);if(this.nodeCrossfadingEnabled||ti(i,this.fullOpacity),t(s.filteredIds))return{hasEdges:i.some((t=>t!==ss)),perFeatureEdgeMaterials:i};let e=0,h=!1;const r=i.map(((t,i)=>s.featureIds[i]!==s.filteredIds[e]?ss:(h=h||t!==ss,e++,t)));return{hasEdges:h,perFeatureEdgeMaterials:r}}_setObjectSymbolColors(t){if(!this._hasSymbolColors)return;const s=t.objectHandle,i=this._getSymbolColors(t);this._collection.setComponentData(s,i),this._stage.renderView.requestRender()}_reloadAll(t=this.elevationOffset){this._removeAllNodeDataFromStage(t),null!=this._controller&&this._controller.restartNodeLoading()}_opacityChange(s){this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopAllNodeFading(),this._nodeId2Meta.forEach((i=>{t(i)||(this._collection.updateMaterial(i.objectHandle,(t=>t.objectOpacity=s)),ti(i.cachedEdgeMaterials,s),this._updateEdgeRendering(i))}))}_updateMaterial(t){this._collection.updateMaterial(t.objectHandle,(t=>{t.commonMaterialParameters.slicePlaneEnabled=this.slicePlaneEnabled,t.usePBR=this._usePBR(),this._updateMaterialOverlay(t)}))}_updateMaterialOverlay(t){}_updateEngineObject(t){this._setObjectSymbolColors(t),this._applyFiltersToNode(t),this._addOrUpdateEdgeRendering(t),this._visibleGeometryChanged(t)}_slicePlaneEnabledChange(s){this._intersectionHandler&&(this._intersectionHandler.slicePlane=s),c(this._labeler)&&(this._labeler.slicePlaneEnabled=s),this._nodeId2Meta.forEach((i=>{t(i)||(this._collection.updateMaterial(i.objectHandle,(t=>{t.commonMaterialParameters.slicePlaneEnabled=s})),this._updateEdgeRendering(i,!1))}))}_updatePBR(){this._nodeId2Meta.forEach((s=>{t(s)||this._collection.updateMaterial(s.objectHandle,(t=>{t.usePBR=this._usePBR()}))})),this._hasLoadedPBRTextures=!0}_usePBR(){return!this._isIntegratedMesh&&this.view.qualitySettings.physicallyBasedRenderingEnabled}_updateEdgeRendering(t,s=!0){c(this._edgeView)&&this._edgeView.hasObject(t.objectHandle)&&this._addOrUpdateEdgeRendering(t,s)}_forAllNodes(t){this._nodeId2Meta.forEach(t)}_forAllFeatures(s,e,h=0){i(this._nodeId2Meta,(i=>{if(t(i))return!1;if(c(e))switch(e(i)){case 0:return!0;case 2:return!1}let r=1;switch(h){case 1:r=this._forAllFeaturesOfNode(i,s);break;case 0:r=this._forVisibleFeaturesOfNode(i,s);break;case 2:r=this._forAllFeaturesOfNodeInClippingArea(i,s)}return 0===r}))}_forAllFeaturesOfNode(t,s){let i=1;const e=t.featureIds;for(let h=0;h<e.length;h++)if(i=s(e[h],h,t),0===i)return i;return i}_forVisibleFeaturesOfNode(t,s){let i=1;const e=t.featureIds;return this._collection.forEachVisibleComponent(t.objectHandle,(h=>(i=s(e[h],h,t),1===i))),i}_forAllFeaturesOfNodeInClippingArea(s,i){if(t(this._renderClippingArea))return this._forAllFeaturesOfNode(s,i);const e=this._boundingRectNodeTest(s,this._renderClippingArea);if(0===e)return 1;if(3===e)return this._forAllFeaturesOfNode(s,i);const h=s.featureIds,r=is(this._renderClippingArea,this._collection.getObjectTransform(s.objectHandle));for(let t=0;t<h.length;t++){if(!this._boundingRectFeatureTest(s,t,r))continue;const e=i(h[t],t,s);if(0===e)return e}return 1}_createAttributes(t,s){const i={};null!=s.featureIds&&(i[this._getObjectIdField()]=s.featureIds[t]);const e=c(s.attributeInfo)&&s.attributeInfo.attributeData;if(c(e))for(const s of Object.keys(e))i[s]=ts(e[s],t);return i}_createGraphic(t,s){return this._createLayerGraphic(this._createAttributes(t,s))}highlight(t){const s=this._highlights;if("number"==typeof t||t instanceof N?t=[t]:t instanceof O&&(t=t.toArray()),Array.isArray(t)&&t.length>0){if(t[0]instanceof N){const i=t,e=this.i3slayer.fieldsIndex,h=this._getObjectIdField(),r=i.map((t=>es(e,t.attributes,h))),{set:n,handle:o}=s.acquireSet();return s.setFeatureIds(n,r),o}if("number"==typeof t[0]){const i=t,{set:e,handle:h}=s.acquireSet();return s.setFeatureIds(e,i),h}}return Ys}_visibleGeometryChanged(t){this._elevationProvider&&(this._elevationProvider.objectChanged(t.node),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=C((()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null}))))}get performanceInfo(){const t={displayedNumberOfFeatures:0,maximumNumberOfFeatures:0,totalNumberOfFeatures:0,core:null,index:0,nodes:this._nodeId2Meta.size,"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB","Unloaded Memory Estimate":(this.getUnloadedMemory()/1048576).toFixed(1)+"MB"};return c(this._memCache)&&(t.MemCache=Math.round(100*this._memCache.hitRate)+"% hit"),this._controller&&(this._idbCacheEnabled&&(t.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(t)),t}get test(){const t=this;return{controller:this._controller,labeler:this._labeler,get visibleObjectIds(){const s=[];return t._forAllFeatures((t=>(s.push(t),1)),null,0),s.sort(((t,s)=>t-s)),s},get numNodes(){return t._nodeId2Meta.size}}}getNodeOpacityByIndex(t){const s=this._nodeId2Meta.get(t);return this.getNodeOpacity(s)}getNodeOpacity(t){return c(t)?this._collection.getMaterial(t.objectHandle).objectOpacity:0}isNodeFullyFadedIn(t){return this._crossfadeHelper.isNodeFullyFadedIn(t)}getNodeCrossfadeMetaData(t){return this._nodeId2Meta.get(t)}markNodeToRemove(t){this._controller&&this._controller.markNodeToRemove(t)}removeMarkedNodes(){this._controller&&this._controller.removeMarkedNodes()}foreachCrossfadeNode(t){this._nodeId2Meta.forEach(((s,i)=>t(i,s)))}fadeNode(t,s,i){if(!this.nodeCrossfadingEnabled)return;const e=this._nodeId2Meta.get(t);c(e)&&this._crossfadeHelper.fadeNode(t,e,s,i)}setNodeOpacityByIndex(t,s){const i=this._nodeId2Meta.get(t);c(i)&&this._setNodeOpacity(i,s)}_setNodeOpacity(t,s){this._collection.updateMaterial(t.objectHandle,(t=>t.objectOpacity=s)),this._setNodeEdgeOpacity(t,s)}_setNodeEdgeOpacity(t,s){if(!c(this._edgeView)||!t.cachedEdgeMaterials)return;ti(t.cachedEdgeMaterials,s);const i=t.objectHandle;this._edgeView.hasObject(i)&&this._edgeView.updateAllComponentOpacities(i,s)}get hasModifications(){return this._isIntegratedMesh&&c(this._layerClippingArea)||this._modifications&&this._modifications.length>0}updateNodeModificationStatus(s){if(!this.hasModifications||s.length<=0||!0!==this._i3sWasmLoaded)return;const i=this.i3slayer.uid,e=function(s){if(0===s.length)return null;const i=new Float64Array(10*s.length);return s.forAll(((s,e)=>{let h=s.serviceObb;t(h)&&(h=Hs,B(h.center,s.mbs),h.halfSize[0]=h.halfSize[1]=h.halfSize[2]=s.mbs[3]);const r=10*e;i[r+0]=h.center[0],i[r+1]=h.center[1],i[r+2]=h.center[2],i[r+3]=h.halfSize[0],i[r+4]=h.halfSize[1],i[r+5]=h.halfSize[2],i[r+6]=h.quaternion[0],i[r+7]=h.quaternion[1],i[r+8]=h.quaternion[2],i[r+9]=h.quaternion[3]})),i}(s);if(c(e)){Et({context:i,buffer:e.buffer});const t=new Float64Array(e.buffer);s.forAll(((s,i)=>{const e=At(t[i]);s.imModificationImpact=e,0!==e&&this._controller.invalidateGeometryVisibility(s.index)}))}}notifyUpdate(){this.notifyChange("updating")}notifyLODUpdate(){this._controller.notifyLODUpdate()}isUpdating(){return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle||c(this._labeler)&&this._labeler.updating||this._crossfadeHelper.updating||this._i3sWasmLoaded instanceof Promise||this._asyncModuleLoading>0}};return e([h()],n.prototype,"_hasLoadedPBRTextures",void 0),e([h()],n.prototype,"_asyncModuleLoading",void 0),e([h()],n.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),e([h()],n.prototype,"view",void 0),e([h()],n.prototype,"i3slayer",void 0),e([h()],n.prototype,"_controller",void 0),e([h()],n.prototype,"_labeler",void 0),e([h()],n.prototype,"updating",void 0),e([h()],n.prototype,"suspended",void 0),e([h()],n.prototype,"holeFilling",void 0),e([h(Rt)],n.prototype,"updatingProgress",void 0),e([h({readOnly:!0,aliasOf:"_controller.updatingProgress"})],n.prototype,"updatingProgressValue",void 0),e([h({readOnly:!0})],n.prototype,"hasTexturesOrVertexColors",null),e([h({readOnly:!0})],n.prototype,"rendererTextureUsage",null),e([h({readOnly:!0})],n.prototype,"elevationOffset",null),e([h({type:Boolean})],n.prototype,"slicePlaneEnabled",void 0),e([h()],n.prototype,"supportedTextureEncodings",null),e([h()],n.prototype,"uncompressedTextureDownsamplingEnabled",null),e([h({type:[gt]})],n.prototype,"_modifications",void 0),n=e([r("esri.views.3d.layers.I3SMeshView3D")],n),n},zs=Y(),ks=rt(),$s=rt(),Hs=Tt(),qs=[0,0,0,0],Ws=new F([0,0,0,0]),Ks=[0,0,0,0];function Js(t){const s=t.metallicRoughness;return s&&s.baseColorTextureId>=0||s&&s.metallicRoughnessTextureId>=0||t.normalTextureId>=0||t.emissiveTextureId>=0||t.occlusionTextureId>=0}function Zs(t){return c(t)&&x(t.data)}function Qs(t,s){let i=1024+t.interleavedVertexData.byteLength+(t.indices?t.indices.byteLength:0)+t.positionData.data.byteLength+t.positionData.indices.byteLength;if(c(s))for(const t of s)c(t)&&x(t.data)&&(i+=t.data.byteLength);return i}function Xs(t,s){return s.byteSize>104857600?(Us.warn(`Node is too big to store in IndexedDB cache: ${t.id} (${s.byteSize} bytes)`),!1):s.byteSize>0}const Ys={remove(){},pause(){},resume(){}};function ti(t,s){t.forEach((t=>t.opacity=s))}export{Ls as $,os as u}