import{w as n,kE as t,r as o,kB as e,aT as r,dr as s,gG as a,t as c,E as i}from"./p-5420851c.js";import{a as u}from"./p-2794293b.js";import{r as l}from"./p-078c732e.js";import{m as f,c as p,y as m,f as d}from"./p-33ff00d0.js";import{T as b,i as w,c as j,x as g,u as x,L as h,O as $,E as T}from"./p-d4dbfa93.js";import{e as v,f as C,t as M,r as y,a as k,n as A}from"./p-b0deb17a.js";import{a as E,r as I,o as S,b as q,t as B,c as G,j as L,f as N,e as R,k as z,i as D,d as F,g as K,m as O,n as P}from"./p-c374e32a.js";import{b as Q}from"./p-541d3fdc.js";import"./p-53bb6ab4.js";import"./p-97ec6ae5.js";import"./p-cb6da774.js";import"./p-01158f1c.js";import"./p-0bbc1744.js";import"./p-9d3cbf73.js";import"./p-aa3586ef.js";import"./p-74752c79.js";async function U(n,t,e){const r=new P(function(n){return null!=n&&n.resolveFile?{busy:!1,request:async(t,e,r)=>{const s=n.resolveFile(t),a="image"===e?"image":"binary"===e?"array-buffer":"json";return(await i(s,{responseType:a,signal:o(r)?r.signal:null})).data}}:null}(e)),s=(await E(r,t,e,!0)).model,a=s.lods.shift(),c=new Map,u=new Map;s.textures.forEach(((n,t)=>c.set(t,W(n)))),s.materials.forEach(((n,t)=>u.set(t,X(n,c))));const l=J(a);for(const n of l.parts)Y(l,n,u);const{position:f,normal:p,tangent:d,color:b,texCoord0:w}=l.vertexAttributes,j={position:f.typedBuffer,normal:o(p)?p.typedBuffer:null,tangent:o(d)?d.typedBuffer:null,uv:o(w)?w.typedBuffer:null,color:o(b)?b.typedBuffer:null},g=Q(j,n,e);return{transform:g.transform,components:l.components,spatialReference:n.spatialReference,vertexAttributes:new m({position:g.vertexAttributes.position,normal:g.vertexAttributes.normal,tangent:g.vertexAttributes.tangent,color:j.color,uv:j.uv})}}function V(n,t){if(c(n))return"-";const o=n.typedBuffer;return`${e(t,o.buffer,(()=>t.size))}/${o.byteOffset}/${o.byteLength}`}function H(n){return o(n)?n.toString():"-"}function J(n){let t=0;const o={color:!1,tangent:!1,normal:!1,texCoord0:!1},r=new Map,s=new Map,a=[];for(const c of n.parts){const{attributes:{position:n,normal:i,color:u,tangent:l,texCoord0:f}}=c,p=`\n      ${V(n,r)}/\n      ${V(i,r)}/\n      ${V(u,r)}/\n      ${V(l,r)}/\n      ${V(f,r)}/\n      ${H(c.transform)}\n    `;let m=!1;const d=e(s,p,(()=>(m=!0,{start:t,length:n.count})));m&&(t+=n.count),i&&(o.normal=!0),u&&(o.color=!0),l&&(o.tangent=!0),f&&(o.texCoord0=!0),a.push({gltf:c,writeVertices:m,region:d})}return{vertexAttributes:{position:I(b,t),normal:o.normal?I(w,t):null,tangent:o.tangent?I(j,t):null,color:o.color?I(g,t):null,texCoord0:o.texCoord0?I(x,t):null},parts:a,components:[]}}function W(n){return new f({data:n.data,wrap:nn(n.parameters.wrap)})}function X(o,e){const a=new r(function(n,t){return l(on(n[0]),on(n[1]),on(n[2]),t)}(o.color,o.opacity)),c=o.emissiveFactor?new r(function(n){return s(on(n[0]),on(n[1]),on(n[2]))}(o.emissiveFactor)):null;return new p({color:a,colorTexture:n(t(o.textureColor,(n=>e.get(n)))),normalTexture:n(t(o.textureNormal,(n=>e.get(n)))),emissiveColor:c,emissiveTexture:n(t(o.textureEmissive,(n=>e.get(n)))),occlusionTexture:n(t(o.textureOcclusion,(n=>e.get(n)))),alphaMode:_(o.alphaMode),alphaCutoff:o.alphaCutoff,doubleSided:o.doubleSided,metallic:o.metallicFactor,roughness:o.roughnessFactor,metallicRoughnessTexture:n(t(o.textureMetallicRoughness,(n=>e.get(n))))})}function Y(n,t,o){t.writeVertices&&Z(n,t);const e=t.gltf,r=function(n,t){switch(t){case 4:return K(n,O);case 5:return F(n);case 6:return D(n)}}(e.indices||e.attributes.position.count,e.primitiveType),s=t.region.start;if(s)for(let n=0;n<r.length;n++)r[n]+=s;n.components.push(new d({faces:r,material:o.get(e.material),trustSourceNormals:!0}))}function Z(n,t){const{position:e,normal:r,tangent:s,color:c,texCoord0:i}=n.vertexAttributes,l=t.region.start,{attributes:f,transform:p}=t.gltf,m=f.position.count;if(v(e.slice(l,m),f.position,p),o(f.normal)&&o(r)){const n=a(u(),p);C(r.slice(l,m),f.normal,n)}else o(r)&&M(r,0,0,1,{dstIndex:l,count:m});if(o(f.tangent)&&o(s)){const n=a(u(),p);q(s.slice(l,m),f.tangent,n)}else o(s)&&B(s,0,0,1,1,{dstIndex:l,count:m});if(o(f.texCoord0)&&o(i)?G(i.slice(l,m),f.texCoord0):o(i)&&L(i,0,0,{dstIndex:l,count:m}),o(f.color)&&o(c)){const n=f.color,t=c.slice(l,m);if(4===n.elementCount)n instanceof j?N(t,n,255):n instanceof g?R(t,n):n instanceof h&&z(t,n,8);else{B(t,255,255,255,255);const o=$.fromTypedArray(t.typedBuffer,t.typedBufferStride);n instanceof w?y(o,n,255):n instanceof $?k(o,n):n instanceof T&&A(o,n,8)}}else o(c)&&B(c.slice(l,m),255,255,255,255)}function _(n){switch(n){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function nn(n){return{horizontal:tn(n.s),vertical:tn(n.t)}}function tn(n){switch(n){case 33071:return"clamp";case 33648:return"mirror";case 10497:return"repeat"}}function on(n){return n**(1/S)*255}export{U as loadGLTFMesh}