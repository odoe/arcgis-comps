import{af as t,A as s,r as i,V as e,bE as r,c as h,s as o,a as p,b as a,D as n,e as c,d as l,i as d}from"./p-e58503d5.js";import{h as f}from"./p-54330161.js";import{m,a as u}from"./p-889f7a78.js";import{u as j}from"./p-ea916a39.js";import{r as b,i as y,a as w,h as v,o as g}from"./p-aa9bb1d7.js";import{e as T}from"./p-e9bae5e9.js";import{b as _,h as C}from"./p-75cd09f2.js";import{e as I}from"./p-77b9a0fc.js";import{s as x,h as M,d as S}from"./p-fbb06b4d.js";import{c as D,e as L}from"./p-4414d64f.js";import{I as U}from"./p-e3500fdc.js";import{C as k}from"./p-6484267b.js";import{r as P}from"./p-1ccb0bf6.js";import{o as R}from"./p-a2b6db85.js";import{a as V}from"./p-7356a318.js";import{l as O}from"./p-728f106f.js";import{g as $}from"./p-6d6923ed.js";import{t as z}from"./p-35dda696.js";import{j as q}from"./p-db63fa0e.js";import{p as F}from"./p-6448f4dc.js";import{u as A}from"./p-a63f7978.js";import"./p-53bb6ab4.js";import"./p-b79fcce3.js";import"./p-93765525.js";import"./p-765e6c28.js";import"./p-a9a30646.js";import"./p-8747982c.js";import"./p-8bc9b36a.js";import"./p-7a658388.js";import"./p-e273719b.js";import"./p-74de0937.js";import"./p-2f398ed1.js";import"./p-d3105731.js";import"./p-fb38a9d0.js";import"./p-f94762ac.js";import"./p-8a919d07.js";import"./p-efbca0ca.js";import"./p-c048b814.js";import"./p-480e5606.js";import"./p-19bc1e3d.js";import"./p-0bb84768.js";import"./p-2d0c34e5.js";import"./p-9d34911e.js";import"./p-1a7268a2.js";import"./p-025c0c8e.js";import"./p-47e1bd73.js";import"./p-1e473dab.js";import"./p-d1d9dbe4.js";import"./p-e6fe5d89.js";import"./p-56ed1c7a.js";import"./p-b392deaf.js";import"./p-9790d1b4.js";import"./p-b0565d49.js";import"./p-f3659a34.js";import"./p-285c6a34.js";import"./p-5e833dfc.js";import"./p-7a5bfd29.js";import"./p-a131049b.js";import"./p-a2324023.js";import"./p-b9aa4901.js";import"./p-400ca3dc.js";import"./p-9b7a2176.js";import"./p-e654504b.js";import"./p-0eb619a6.js";import"./p-4d17d2cd.js";import"./p-b5b00e38.js";import"./p-e94b450b.js";import"./p-7731c620.js";import"./p-5d962998.js";import"./p-1189fa83.js";import"./p-37058f88.js";import"./p-3e39c093.js";import"./p-7d081d01.js";import"./p-afac6fb2.js";import"./p-01e5a461.js";import"./p-ca295674.js";import"./p-41f2b2dd.js";import"./p-612a2c14.js";import"./p-d443df87.js";import"./p-7ca40eac.js";import"./p-9087b4d3.js";import"./p-c1cd5521.js";import"./p-ca4492df.js";import"./p-182bb5be.js";import"./p-db87794e.js";import"./p-2db4840f.js";import"./p-bba8b671.js";import"./p-dc852195.js";import"./p-ff2962f5.js";import"./p-da9e7ba9.js";import"./p-a8f0aa27.js";import"./p-4a96de15.js";import"./p-5032dfbd.js";import"./p-a87cccba.js";import"./p-dae095dd.js";import"./p-0e784e4d.js";import"./p-dbdf15fc.js";import"./p-e0d9ff4c.js";import"./p-08e5f531.js";import"./p-dfc6337f.js";import"./p-9f1c2d50.js";import"./p-6b2eb7a7.js";import"./p-1f81b35d.js";import"./p-81b9df84.js";import"./p-5ce39624.js";import"./p-51a17e75.js";import"./p-d208934e.js";import"./p-22c9f19c.js";import"./p-c096b5df.js";import"./p-da33e926.js";import"./p-a24f7752.js";import"./p-ccdb8e80.js";import"./p-4a6dc5e4.js";import"./p-6a92ecb9.js";import"./p-1ab449fc.js";import"./p-a6c8fb32.js";import"./p-0edb3309.js";import"./p-e8160b60.js";import"./p-2e8ad983.js";import"./p-e3270d48.js";import"./p-e44bd0a6.js";import"./p-fe68aab5.js";import"./p-c6970847.js";import"./p-de86b3c9.js";import"./p-37d3434c.js";import"./p-120b7410.js";import"./p-b1eff69d.js";import"./p-612de336.js";import"./p-91fe06d4.js";import"./p-ab0e9273.js";import"./p-15a9486c.js";import"./p-2ae44317.js";import"./p-9f58a277.js";import"./p-9e860e7b.js";import"./p-ca657fcf.js";import"./p-b312c1fd.js";import"./p-b8beb0d3.js";import"./p-2a99994a.js";import"./p-76f37e40.js";import"./p-eee9ef50.js";import"./p-6ded4c02.js";import"./p-d57f9971.js";import"./p-746a9d8f.js";import"./p-db4d63dc.js";import"./p-1c2ff3a7.js";import"./p-2e5dd2d0.js";import"./p-1676d4c7.js";import"./p-09dd2137.js";import"./p-ad14ca1b.js";import"./p-a617738c.js";import"./p-b9c93bb2.js";import"./p-f971b161.js";import"./p-6fe4db61.js";import"./p-56ca6f1f.js";import"./p-0bb41218.js";import"./p-97ec6ae5.js";import"./p-81049b2d.js";import"./p-9658240e.js";const B=(t,s)=>t+1/(1<<2*s);class E{constructor(t,s){this._tiles=new Map,this._tileCache=new T(40,(t=>t.dispose())),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,this._container=s}destroy(){for(const[t,s]of this._tiles)s.dispose();this._tiles=null,this._tileCache.clear(),this._tileCache=null}update(t){this._updateCacheSize(t);const s=this.tileInfoView,i=s.getTileCoverage(t.state,0,"smallest"),{spans:e,lodInfo:r}=i,{level:h}=r,o=this._tiles,p=new Set,a=new Set;for(const{row:t,colFrom:s,colTo:i}of e)for(let e=s;e<=i;e++){const s=I.getId(h,t,r.normalizeCol(e),r.getWorldForColumn(e)),i=this._getOrAcquireTile(s);p.add(s),i.processed()?this._addToContainer(i):a.add(new I(s))}for(const[t,s]of o)s.isCoverage=p.has(t);for(const t of a)this._findPlaceholdersForMissingTiles(t,p);let n=!1;for(const[t,e]of o)e.neededForCoverage=p.has(t),e.neededForCoverage||e.isHoldingForFade&&s.intersects(i,e.key)&&p.add(t),e.isFading&&(n=!0);for(const[t,s]of this._tiles)p.has(t)||this._releaseTile(t);return _.pool.release(i),!n}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}clearCache(){this._tileCache.clear()}_findPlaceholdersForMissingTiles(t,s){const i=[];for(const[e,r]of this._tiles)this._addPlaceholderChild(i,r,t,s);const e=i.reduce(B,0);Math.abs(1-e)<1e-6||this._addPlaceholderParent(t.id,s)}_addPlaceholderChild(t,s,i,e){s.key.level<=i.level||!s.hasData()||function(t,s){const i=s.level-t.level;return t.row===s.row>>i&&t.col===s.col>>i&&t.world===s.world}(i,s.key)&&(this._addToContainer(s),e.add(s.id),t.push(s.key.level-i.level))}_addPlaceholderParent(t,s){const i=this._tiles;let e=t;for(;;){if(e=N(e),!e||s.has(e))return;const t=i.get(e);if(t&&t.hasData())return this._addToContainer(t),void s.add(t.id)}}_getOrAcquireTile(t){let s=this._tiles.get(t);return s||(s=this._tileCache.pop(t),s||(s=this.acquireTile(new I(t))),this._tiles.set(t,s),s)}_releaseTile(t){const s=this._tiles.get(t);this.releaseTile(s),this._removeFromContainer(s),this._tiles.delete(t),s.hasData()?this._tileCache.put(t,s,1):s.dispose()}_addToContainer(i){let e;const r=[],h=this._container;if(h.contains(i))return;const o=this._visibleTiles;for(const[s,h]of o)this._canConnectDirectly(i,h)&&r.push(h),t(e)&&this._canConnectDirectly(h,i)&&(e=h);if(s(e)){for(const t of r)e.childrenTiles.delete(t),i.childrenTiles.add(t),t.parentTile=i;e.childrenTiles.add(i),i.parentTile=e}else for(const t of r)i.childrenTiles.add(t),t.parentTile=i;o.set(i.id,i),h.addChild(i)}_removeFromContainer(t){if(this._visibleTiles.delete(t.id),this._container.removeChild(t),s(t.parentTile)){t.parentTile.childrenTiles.delete(t);for(const i of t.childrenTiles)s(t.parentTile)&&t.parentTile.childrenTiles.add(i)}for(const s of t.childrenTiles)s.parentTile=t.parentTile;t.parentTile=null,t.childrenTiles.clear()}_canConnectDirectly(t,s){const i=t.key;let{level:e,row:r,col:h,world:o}=s.key;const p=this._visibleTiles;for(;e>0;){if(e--,r>>=1,h>>=1,i.level===e&&i.row===r&&i.col===h&&i.world===o)return!0;if(p.has(`${e}/${r}/${h}/${o}`))return!1}return!1}_updateCacheSize(t){const s=t.state.size;if(s[0]===this._viewSize[0]&&s[1]===this._viewSize[1])return;const i=Math.ceil(s[0]/512)+1,e=Math.ceil(s[1]/512)+1;this._viewSize[0]=s[0],this._viewSize[1]=s[1],this._tileCache.maxSize=5*i*e}}function N(t){const[s,i,e,r]=t.split("/"),h=parseInt(s,10);return 0===h?null:`${h-1}/${parseInt(i,10)>>1}/${parseInt(e,10)>>1}/${parseInt(r,10)}`}const Q=1e-6;class H extends i{constructor(t,s){super(),this.styleRepository=t,this._tileToHandle=new Map,this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._completed=!1,this._symbolRepository=new b(4096,s,(()=>new x)),this._symbolDeclutterer=new y(s,this._symbolRepository,((t,s,i)=>new w(t,s,i,this.styleRepository,this._zoom,this._viewState.rotation)),((t,s)=>{t.allSymbolsFadingOut=!0,t.lastOpacityUpdate=s,M(t,s,!0),t.decluttered=!0,t.requestRender()}),((t,s)=>this.styleRepository.getStyleLayerByUID(t.styleLayerUID).z-this.styleRepository.getStyleLayerByUID(s.styleLayerUID).z),(t=>{const s=this.styleRepository.getStyleLayerByUID(t);if(this._zoom+Q<s.minzoom||this._zoom-Q>=s.maxzoom)return!1;const i=s.getLayoutProperty("visibility");return!i||1!==i.getValue()}))}addTile(t){t.decluttered=!1,this._tileToHandle.set(t,t.on("symbols-changed",(()=>{this._symbolRepository.add(t),this.restartDeclutter()}))),this._symbolRepository.add(t),this.restartDeclutter()}removeTile(t){const s=this._tileToHandle.get(t);s&&(this._symbolRepository.removeTile(t),this.restartDeclutter(),s.remove(),this._tileToHandle.delete(t))}update(t,s){return this._zoom=t,this._viewState={scale:s.scale,rotation:s.rotation,center:[s.center[0],s.center[1]],size:[s.size[0],s.size[1]]},this._continueDeclutter(),this._completed}restartDeclutter(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}clear(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach((t=>t.remove())),this._tileToHandle.clear()}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(t){this._symbolRepository.deleteStyleLayers(t)}_continueDeclutter(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(D),this._completed&&this._scheduleNotifyStable())}_scheduleNotifyStable(){s(this._stableNotificationHandle)&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout((()=>{this._stableNotificationHandle=null,this.emit("fade-complete")}),1.5*L)}_notifyUnstable(){s(this._stableNotificationHandle)&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this.emit("fade-start")}}class G extends P{_createTransforms(){return{dvs:k(),tileMat3:k()}}}const J=1e-6;function K(t,s){if(t){const i=t.getLayoutProperty("visibility");if(!i||1!==i.getValue()&&(void 0===t.minzoom||t.minzoom<s+J)&&(void 0===t.maxzoom||t.maxzoom>=s-J))return!0}return!1}class W extends R{constructor(t){super(t),this._backgroundTiles=[],this._pointToCallbacks=new Map}destroy(){this.removeAllChildren(),this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null),s(this._symbolFader)&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[],this._pointToCallbacks.clear()}setStyleResources(s,i,r){if(this._spriteMosaic=s,this._glyphMosaic=i,this._styleRepository=r,t(this._symbolFader)){const t=new H(this._styleRepository,this.children);t.on("fade-start",(()=>{this.emit("fade-start"),this.requestRender()})),t.on("fade-complete",(()=>{this.emit("fade-complete"),this.requestRender()})),this._symbolFader=t}e(this._symbolFader).styleRepository=r}deleteStyleLayers(t){s(this._symbolFader)&&this._symbolFader.deleteStyleLayers(t)}async hitTest(t,s){const i=[t,s],e=r();return this._pointToCallbacks.set(i,e),this.requestRender(),e.promise}enterTileInvalidation(){for(const t of this.children)t.invalidating=!0}createRenderParams(t){return{...super.createRenderParams(t),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}}doRender(t){!this.visible||t.drawPhase!==U.MAP&&t.drawPhase!==U.DEBUG||void 0===this._spriteMosaic||super.doRender(t)}addChild(t){return super.addChild(t),s(this._symbolFader)?this._symbolFader.addTile(t):t.decluttered=!0,this.requestRender(),t}removeChild(t){return s(this._symbolFader)&&this._symbolFader.removeTile(t),this.requestRender(),super.removeChild(t)}renderChildren(t){const{drawPhase:s}=t;if(s!==U.DEBUG){if(this._doRender(t),this._pointToCallbacks.size>0){t.drawPhase=U.HITTEST;const i=t.painter.effects.hittest;i.bind(t),this._doRender(t),i.draw(t,this._pointToCallbacks),i.unbind(t),t.drawPhase=s}}else super.renderChildren(t)}removeAllChildren(){for(let t=0;t<this.children.length;t++){const i=this.children[t];s(this._symbolFader)&&this._symbolFader.removeTile(i),i.dispose()}super.removeAllChildren()}getStencilTarget(){return this.children.filter((t=>t.neededForCoverage&&t.hasData()))}restartDeclutter(){s(this._symbolFader)&&this._symbolFader.restartDeclutter()}_doRender(t){const{context:s}=t,i=this._styleRepository;if(!i)return;const e=i.layers;let r=!0;t.drawPhase===U.HITTEST&&(r=!1),i.backgroundBucketIds.length>0&&(t.renderPass="background",this._renderBackgroundLayers(t,i.backgroundBucketIds)),super.renderChildren(t),t.drawPhase===U.MAP&&this._fade(t.displayLevel,t.state);const h=this.children.filter((t=>t.visible&&t.hasData()));if(!h||0===h.length)return s.bindVAO(),s.setStencilTestEnabled(!0),void s.setBlendingEnabled(!0);for(const t of h)t.triangleCount=0;s.setStencilWriteMask(0),s.setColorMask(!0,!0,!0,!0),s.setStencilOp(7680,7680,7681),s.setStencilTestEnabled(!0),s.setBlendingEnabled(!1),s.setDepthTestEnabled(!0),s.setDepthWriteEnabled(!0),s.setDepthFunction(515),s.setClearDepth(1),s.clear(s.gl.DEPTH_BUFFER_BIT),t.renderPass="opaque";for(let s=e.length-1;s>=0;s--)this._renderStyleLayer(e[s],t,h);s.setDepthWriteEnabled(!1),s.setBlendingEnabled(r),s.setBlendFunctionSeparate(1,771,1,771),t.renderPass="translucent";for(let s=0;s<e.length;s++)this._renderStyleLayer(e[s],t,h);s.setDepthTestEnabled(!1),t.renderPass="symbol";for(let s=0;s<e.length;s++)this._renderStyleLayer(e[s],t,h);s.bindVAO(),s.setStencilTestEnabled(!0),s.setBlendingEnabled(!0)}_fade(t,i){s(this._symbolFader)&&(this._symbolFader.update(t,i)||this.requestRender())}_renderStyleLayer(t,s,i){const{painter:e,renderPass:r}=s;if(void 0===t)return;const h=t.getLayoutProperty("visibility");if(h&&1===h.getValue())return;let o;switch(t.type){case 0:return;case 1:if("opaque"!==r&&"translucent"!==s.renderPass)return;o="vtlFill";break;case 2:if("translucent"!==r)return;o="vtlLine";break;case 4:if("symbol"!==r)return;o="vtlCircle";break;case 3:if("symbol"!==r)return;o="vtlSymbol"}if(i=i.filter(3===t.type?t=>t.decluttered:t=>t.neededForCoverage),"vtlSymbol"!==o){const e=s.displayLevel;if(0===i.length||void 0!==t.minzoom&&t.minzoom>=e+J||void 0!==t.maxzoom&&t.maxzoom<e-J)return}const p=t.uid;s.styleLayerUID=p,s.styleLayer=t;for(const t of i)if(t.layerData.has(p)){e.renderObjects(s,i,o);break}}_renderBackgroundLayers(t,i){const{context:e,displayLevel:r,painter:h,state:o}=t,p=this._styleRepository;let a=!1;for(const t of i)if(0===p.getLayerById(t).type&&K(p.getLayerById(t),r)){a=!0;break}if(!a)return;const n=this._tileInfoView.getTileCoverage(t.state,0,"smallest"),{spans:c,lodInfo:l}=n,{level:d}=l,f=j(),m=[];if(this._renderPasses){const i=this._renderPasses[0];s(this._clippingInfos)&&(i.brushes[0].prepareState(t,this._clippingInfos[0]),i.brushes[0].drawMany(t,this._clippingInfos))}const u=this._backgroundTiles;let b,y=0;for(const{row:t,colFrom:s,colTo:i}of c)for(let e=s;e<=i;e++){if(y<u.length)b=u[y],b.key.set(d,t,l.normalizeCol(e),l.getWorldForColumn(e)),this._tileInfoView.getTileBounds(f,b.key,!1),b.x=f[0],b.y=f[3];else{const s=new I(d,t,l.normalizeCol(e),l.getWorldForColumn(e)),i=this._tileInfoView.getTileBounds(j(),s);b=new G(s,i[0],i[3],512,512,4096,4096),u.push(b)}b.setTransform(o,this._tileInfoView.getTileResolution(b.key)),m.push(b),y++}e.setStencilWriteMask(0),e.setColorMask(!0,!0,!0,!0),e.setStencilOp(7680,7680,7681),e.setStencilFunction(514,0,255);let w=!0;t.drawPhase===U.HITTEST&&(w=!1),e.setStencilTestEnabled(w);for(const s of i){const i=p.getLayerById(s);0===i.type&&K(i,r)&&(t.styleLayerUID=i.uid,t.styleLayer=i,h.renderObjects(t,m,"vtlBackground"))}_.pool.release(n)}}class X extends z{constructor(t){super(),this.requestRender=this.requestRender.bind(this),this._layerView=t,this._canvas=document.createElement("canvas"),this._context=this._canvas.getContext("2d"),this._bitmap=new $(null,"standard",!1),this.addChild(this._bitmap)}doRender(t){const s=t.state,i=this._createCustomRenderParams(t),e=i.pixelRatio,r=this._canvas,h=this._bitmap;r.width=s.size[0]*e,r.height=s.size[1]*e,h.resolution=s.resolution,h.pixelRatio=e,h.x=s.viewpoint.targetGeometry.x-Math.abs(s.extent.xmax-s.extent.xmin)/2,h.y=s.viewpoint.targetGeometry.y+Math.abs(s.extent.ymax-s.extent.ymin)/2,this._layerView.render(i),h.source=r,h.rotation=s.rotation,super.doRender(t)}_createCustomRenderParams(t){const s=window.devicePixelRatio,i={...t.state,pixelRatio:s};return{...t,pixelRatio:s,context:this._context,state:i}}}class Y extends C{constructor(){super(...arguments),this._fullCacheLodInfos=null,this._levelByScale={}}getTileParentId(t){const s=I.pool.acquire(t),i=0===s.level?null:I.getId(s.level-1,s.row>>1,s.col>>1,s.world);return I.pool.release(s),i}getTileCoverage(t,s,i){const e=super.getTileCoverage(t,s,i);if(!e)return e;const r=1<<e.lodInfo.level;return e.spans=e.spans.filter((t=>t.row>=0&&t.row<r)),e}scaleToLevel(t){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[t])return this._levelByScale[t];{const s=this._fullCacheLodInfos;if(t>s[0].scale)return s[0].level;let i,e;for(let r=0;r<s.length-1;r++)if(e=s[r+1],t>e.scale)return i=s[r],i.level+(i.scale-t)/(i.scale-e.scale);return s[s.length-1].level}}_initializeFullCacheLODs(t){let s;s=0===t[0].level?t.map((t=>({level:t.level,resolution:t.resolution,scale:t.scale}))):q.create({size:this.tileInfo.size[0],spatialReference:this.tileInfo.spatialReference}).lods.map((t=>({level:t.level,resolution:t.resolution,scale:t.scale})));for(let t=0;t<s.length;t++)this._levelByScale[s[t].scale]=s[t].level;this._fullCacheLodInfos=s}}const Z=h.getLogger("esri.views.2d.layers.VectorTileLayerView2D");let tt=class extends(O(A)){constructor(){super(...arguments),this._styleChanges=[],this._fetchQueue=null,this._parseQueue=null,this._isTileHandlerReady=!1,this.fading=!1}initialize(){const t=this.layer.tileInfo;if(!(t&&t.spatialReference).equals(this.view.spatialReference))return void this.addResolvingPromise(Promise.reject(new o("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer})));const{style:s,spriteUrl:i,glyphsUrl:e}=this.layer.currentStyleInfo;this._styleRepository=new V(s,{spriteUrl:i,glyphsUrl:e}),this._tileInfoView=new Y(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new W(this._tileInfoView),this._tileHandler=new v(this.layer,this._styleRepository,window.devicePixelRatio||1),this.container.addChild(this._vectorTileContainer),this.handles.add([this._vectorTileContainer.on("fade-start",(()=>{this.fading=!0,this.notifyChange("updating"),this.requestUpdate()})),this._vectorTileContainer.on("fade-complete",(()=>{this._collisionBoxesDisplay&&this._collisionBoxesDisplay.requestRender(),this.fading=!1,this.notifyChange("updating"),this.requestUpdate()})),p(this.layer,"symbolCollisionBoxesVisible",(t=>{t?(this._collisionBoxesDisplay=new X({render:t=>this._renderCollisionBoxes(t.context)}),this.container.addChild(this._collisionBoxesDisplay)):(this.container.removeChild(this._collisionBoxesDisplay),this._collisionBoxesDisplay=null)}))])}destroy(){var t;this._stop(),this.container.removeAllChildren(),this._vectorTileContainer&&(this._vectorTileContainer.destroy(),this._vectorTileContainer=null),null==(t=this._tileHandler)||t.destroy(),this._tileHandler=null}async hitTest(t,s){if(this.suspended||!this._tileHandlerPromise)return null;await this._tileHandlerPromise;const i=await this._vectorTileContainer.hitTest(t,s);if(!i||0===i.length)return null;const e=i[0]-1,r=this._styleRepository,h=r.getStyleLayerByUID(e);if(!h)return null;const o=r.getStyleLayerIndex(h.id),p=new f({attributes:{layerId:o,layerName:h.id,layerUID:e}});return p.layer=this.layer,p.sourceLayer=this.layer,p}update(t){if(this._tileHandlerPromise&&this._isTileHandlerReady)return t.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=t.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.state=t.state,this._parseQueue.state=t.state,this._tileManager.update(t)||this.requestUpdate(),this._parseQueue.resume(),this._fetchQueue.resume()))}attach(){this._start(),this.handles.add([this.layer.on("paint-change",(t=>{if(t.isDataDriven)this._styleChanges.push({type:0,data:t}),this.notifyChange("updating"),this.requestUpdate();else{const s=this._styleRepository,i=s.getLayerById(t.layer);if(!i)return;const e=3===i.type;s.setPaintProperties(t.layer,t.paint),e&&this._vectorTileContainer.restartDeclutter(),this._vectorTileContainer.requestRender()}})),this.layer.on("layout-change",(s=>{const i=this._styleRepository,e=i.getLayerById(s.layer);if(!e)return;const r=m(e.layout,s.layout);if(!t(r)){if(u(r,"visibility")&&1===function(s){if(t(s))return 0;switch(s.type){case"partial":return Object.keys(s.diff).length;case"complete":return Math.max(Object.keys(s.oldValue).length,Object.keys(s.newValue).length);case"collection":return Object.keys(s.added).length+Object.keys(s.changed).length+Object.keys(s.removed).length}}(r))return i.setLayoutProperties(s.layer,s.layout),3===e.type&&this._vectorTileContainer.restartDeclutter(),void this._vectorTileContainer.requestRender();this._styleChanges.push({type:1,data:s}),this.notifyChange("updating"),this.requestUpdate()}})),this.layer.on("style-layer-visibility-change",(t=>{const s=this._styleRepository,i=s.getLayerById(t.layer);i&&(s.setStyleLayerVisibility(t.layer,t.visibility),3===i.type&&this._vectorTileContainer.restartDeclutter(),this._vectorTileContainer.requestRender())})),this.layer.on("style-layer-change",(t=>{this._styleChanges.push({type:2,data:t}),this.notifyChange("updating"),this.requestUpdate()})),this.layer.on("delete-style-layer",(t=>{this._styleChanges.push({type:3,data:t}),this.notifyChange("updating"),this.requestUpdate()})),this.layer.on("load-style",(()=>this._loadStyle()))],this.declaredClass)}detach(){this._stop(),this.handles.remove(this.declaredClass)}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this._collisionBoxesDisplay&&this._vectorTileContainer.restartDeclutter(),this.requestUpdate()}canResume(){let t=super.canResume();const s=this.layer;if(t&&s.currentStyleInfo){const i=this.view.scale,e=s.currentStyleInfo;if(e&&e.layerDefinition){const s=e.layerDefinition;s.minScale&&s.minScale<i&&(t=!1),s.maxScale&&s.maxScale>i&&(t=!1)}}return t}isUpdating(){const t=this._vectorTileContainer.children;return!this._isTileHandlerReady||!this._fetchQueue||!this._parseQueue||this._fetchQueue.updating||this._parseQueue.updating||t.length>0&&t.filter((t=>t.invalidating)).length>0||this.fading}acquireTile(t){const s=this._createVectorTile(t);return this._tileHandlerPromise.then((()=>{this._fetchQueue.push(s.key).then((t=>this._parseQueue.push({key:s.key,data:t}))).then((t=>{s.once("attach",(()=>this.requestUpdate())),t&&(s.setData(t.tileData),this.requestUpdate(),this.notifyChange("updating"))})).catch((t=>{this.notifyChange("updating"),a(t)||Z.error(t)}))})),s}releaseTile(t){const s=t.key.id;this._fetchQueue.abort(s),this._parseQueue.abort(s),this.requestUpdate()}_start(){if(this._stop(),this._tileManager=new E({acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),tileInfoView:this._tileInfoView},this._vectorTileContainer),!this.layer.currentStyleInfo)return;const t=new AbortController,s=this._tileHandler.start({signal:t.signal}).then((()=>{this._fetchQueue=new F({tileInfoView:this._tileInfoView,process:(t,s)=>this._getTileData(t,s),concurrency:15}),this._parseQueue=new F({tileInfoView:this._tileInfoView,process:(t,s)=>this._parseTileData(t,s),concurrency:8}),this.requestUpdate(),this._isTileHandlerReady=!0}));this._tileHandler.spriteMosaic.then((t=>{this._vectorTileContainer.setStyleResources(t,this._tileHandler.glyphMosaic,this._styleRepository),this.requestUpdate()})),this._tileHandlerAbortController=t,this._tileHandlerPromise=s}_stop(){if(!this._tileHandlerAbortController||!this._vectorTileContainer)return;const t=this._tileHandlerAbortController;t&&t.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue&&(this._fetchQueue.destroy(),this._fetchQueue=null),this._parseQueue&&(this._parseQueue.destroy(),this._parseQueue=null),this._tileManager&&(this._tileManager.destroy(),this._tileManager=null),this._vectorTileContainer.removeAllChildren()}async _getTileData(t,s){const i=await this._tileHandler.fetchTileData(t,s);return this.notifyChange("updating"),i}async _parseTileData(t,s){return this._tileHandler.parseTileData(t,s)}async _applyStyleChanges(){this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this._tileManager.clearCache();const t=this._styleChanges;try{await this._tileHandler.updateStyle(t)}catch(t){Z.error("error applying vector-tiles style update",t.message),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0}const s=this._styleRepository,i=[];t.forEach((t=>{if(3!==t.type)return;const e=s.getLayerById(t.data.layer);e&&i.push(e.uid)}));const e=[];let r;t.forEach((t=>{const i=t.data;switch(t.type){case 0:s.setPaintProperties(i.layer,i.paint),r=i.layer;break;case 1:s.setLayoutProperties(i.layer,i.layout),r=i.layer;break;case 3:return void s.deleteStyleLayer(i.layer);case 2:s.setStyleLayer(i.layer,i.index),r=i.layer.id}const h=s.getLayerById(r);h&&e.push(h.uid)}));const h=this._vectorTileContainer.children;if(i.length>0){this._vectorTileContainer.deleteStyleLayers(i);for(const t of h)t.deleteLayerData(i)}if(this._fetchQueue.resume(),this._parseQueue.resume(),e.length>0){const t=[];for(const s of h){const i=this._fetchQueue.push(s.key).then((t=>this._parseQueue.push({key:s.key,data:t,styleLayerUIDs:e}))).then((t=>s.setData(t.tileData)));t.push(i)}await Promise.all(t)}this._styleChanges=[],this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate()}async _loadStyle(){const{style:t,spriteUrl:s,glyphsUrl:i}=this.layer.currentStyleInfo,e=n(t);this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this.notifyChange("updating"),this._styleRepository=new V(e,{spriteUrl:s,glyphsUrl:i}),this._vectorTileContainer.destroy(),this._tileManager.clear(),this._tileHandlerAbortController.abort(),this._tileHandlerAbortController=new AbortController;const{signal:r}=this._tileHandlerAbortController;try{this._tileHandlerPromise=this._tileHandler.setStyle(this._styleRepository,e),await this._tileHandlerPromise}catch(t){if(!a(t))throw t}if(r.aborted)return this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),void this.requestUpdate();const h=await this._tileHandler.spriteMosaic;this._vectorTileContainer.setStyleResources(h,this._tileHandler.glyphMosaic,this._styleRepository),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate()}_createVectorTile(t){const s=this._tileInfoView.getTileBounds(j(),t);return new S(t,s[0],s[3],512,512,this._styleRepository)}_renderCollisionBoxes(t){for(const s of this._vectorTileContainer.children)if(s.symbols){const i=[];for(const[t,e]of s.symbols)i.push(...e);g(t,i)}}};c([l()],tt.prototype,"_fetchQueue",void 0),c([l()],tt.prototype,"_parseQueue",void 0),c([l()],tt.prototype,"_isTileHandlerReady",void 0),c([l()],tt.prototype,"fading",void 0),tt=c([d("esri.views.2d.layers.VectorTileLayerView2D")],tt);const st=tt;export default st;