import{b9 as t,cg as s,b as i,A as e,af as h,V as r,cs as n,bF as o,bG as a,K as l,T as u,bh as c,D as d,ao as f,dH as m,c as g,n as p,p as b,u as v,a as y,e as w,d as x,i as M,r as I,aN as C,al as N,dI as D,v as S,Q as A,bv as _,E as O}from"./p-e58503d5.js";import{F,d as $}from"./p-c93d2280.js";import{g as j,u as T}from"./p-ea916a39.js";import{v as L}from"./p-3bcc4805.js";import{f as P,i as V,C as E}from"./p-ca295674.js";import{s as k,e as R,W as q,B as G,d as B,z as U,i as H,c as z,u as W,q as K,g as Q}from"./p-2f398ed1.js";import{e as J}from"./p-4d38e149.js";import{I as X,C as Y,n as Z,y as tt,d as st,Y as it}from"./p-85e8677e.js";import{F as et,E as ht,O as rt,n as nt}from"./p-7de54cd0.js";import{a as ot,i as at,p as lt}from"./p-e654504b.js";import{C as ut,g as ct}from"./p-c45aa9e8.js";import{q as dt}from"./p-d87e82bf.js";import{S as ft,m as mt}from"./p-eb48bb01.js";import{n as gt}from"./p-d3105731.js";import{d as pt}from"./p-01e5a461.js";import{f as bt,a1 as vt,b0 as yt,a_ as wt,w as xt,aF as Mt,O as It}from"./p-340cd100.js";import{w as Ct}from"./p-95909347.js";import{b as Nt}from"./p-cbbdb7db.js";import{c as Dt,o as St}from"./p-ca657fcf.js";import{n as At,t as _t}from"./p-3721667d.js";import{b as Ot}from"./p-5e833dfc.js";class Ft{constructor(t){this.referenceCount=0,this.callbacks=[],this.runIndex=0,this.handle=t.registerTask(P.I3S_CONTROLLER,this)}destroy(){this.handle&&(this.handle.remove(),this.handle=null)}get running(){for(const t of this.callbacks)if(t.needsUpdate())return!0;return!1}runTask(t){this.sort();const s=this.callbacks,i={numIndexLoading:0,numNodesLoading:0};for(let e=0;e<s.length&&!t.done;++e)s[e].priority=s[e].update(t,i),this.runIndex=e}sort(){const t=this.callbacks;let s=t.length;for(let i=this.runIndex;i>0;i--){const e=t[i-1];let h=i;for(;h<t.length&&e.priority<=t[h].priority&&(h!==s||e.priority<t[h].priority);)t[h-1]=t[h],h++;t[h-1]=e,s=h-1}this.runIndex=0}add(t){this.sort(),t.priority=1/0,this.callbacks.unshift(t)}remove(s){t(this.callbacks,s),this.runIndex=this.callbacks.length,this.sort()}}const $t=new Map;function jt(t,s){let i=$t.get(t);return null==i&&(i=new Ft(t),$t.set(t,i)),i.add(s),{remove:()=>{null!=i&&(i.remove(s),i.callbacks.length>0||($t.delete(t),i.destroy()),i=null)}}}class Tt{constructor(t,s){this.id=t,this.mbs=s,this.renderMbs=J([0,0,0,-1]),this.imModificationImpact=4}}class Lt extends Tt{constructor(t,s,i,e,h,r,n,o,a,l){super(t,i),this.index=s,this.childCount=e,this.level=h,this.resources=r,this.version=n,this.lodMetric=o,this.maxError=a,this.numFeatures=l,this.failed=!1,this.hasModifications=!1,this.cacheState=0,this.vertexCount=0,this.memory=0}}class Pt{constructor(t,s,i,e){this.nodeHasLOD=t,this.isChosen=s,this.lodLevel=i,this.version=e}}class Vt{constructor(t,s,i,e,h){this.childOffset=t,this.childCount=s,this.visibilityCache=i,this.ref=e,this.node=h,this.useAsHole=0,this.filterImpact=2}}class Et{constructor(t,i,e,h,r,n,o,a,l,u,c,d,f,m){this.streamDataController=e,this.viewportQueries=h,this.logger=r,this.holeFilling=n,this._isLoaded=o,this._isReloading=a,this._isSelected=l,this._enable=u,this._needsUpdate=c,this._canRequest=d,this._computeVisibilityObb=f,this._computeNodeFiltering=m,this._dirty=!0,this._nodePages=[],this.nodeCount=0,this.nodesPerPage=0,this.rootIndex=0,this.lodMetric=0,this.lodConversion=t=>t,this.urlPrefix="",this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState=new Map,this._version=Bt(0),this._visibilityCacheVersion=Bt(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missing=new s({deallocator:null}),this._prefetch=new s({deallocator:null}),this._updates=new Rt(this._missing),this._imModificationUncategorized=new s({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this.layerHasModifications=!1,this._layerHasFilter=!1,this.logLayer=t,t.serviceUpdateTimeStamp&&t.serviceUpdateTimeStamp.lastUpdate&&(this.lastUpdate=`${t.serviceUpdateTimeStamp.lastUpdate}`),this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,this.init(i)}init(t){if("page"===t.type){switch(this.urlPrefix=t.urlPrefix,this.nodesPerPage=t.pageSize,this.rootIndex=t.rootIndex,t.lodMetric){case"maxScreenThreshold":this.lodMetric=1;break;case"maxScreenThresholdSQ":this.lodMetric=1,this.lodConversion=Xt}this.addPage(Wt(this.rootIndex,this.nodesPerPage),t.rootPage)}else if("node"===t.type){this.urlPrefix=t.urlPrefix,this._nodePages.push({nodes:[],children:[],parents:[]}),this.makeRefNode(new Tt(t.rootNode.id,null),-1);const s=this._validateNode(t.rootNode.id,t.rootNode);s&&this.addNode(s,0)}}loadPage(t){this._loading.add(t),this.streamDataController.request(this.urlPrefix+t,"json").then((s=>{this._loading.delete(t),this.addPage(t,s)})).catch((s=>{this._loading.delete(t),i(s)||(this._failedPages.add(t),this.logger.error("#loadPage()",this.logLayer,`Error when loading page ${t}`,s))}))}addPage(t,s){for(let s=this._nodePages.length;s<t;s++)this._nodePages[s]=null;const i=[],e=[],h=s.nodes.map(((s,h)=>{const r=i.length,n=s.children?s.children.length:0;e.push(-1);for(let t=0;t<n;t++)i.push(s.children[t]);const o=`${s.index}`,a=et(s.obb),l=J([a.center[0],a.center[1],a.center[2],k(a.halfSize)]),u=s.mesh&&s.mesh.attribute,c=s.mesh&&s.mesh.geometry,d=s.mesh&&s.mesh.material,f=new Lt(o,t*this.nodesPerPage+h,l,n,0,{hasSharedResource:!1,hasFeatureData:!!c,attributes:u&&null!=u.resource?`${u.resource}`:null,geometry:c&&null!=c.resource?`${c.resource}`:null,texture:d&&null!=d.resource?`${d.resource}`:null,geometryDefinition:c?c.definition:-1,materialDefinition:d?d.definition:-1},this.lastUpdate,this.lodMetric,this.lodConversion(s.lodThreshold),c?c.featureCount:null);return f.serviceObb=a,f.visibilityObb=this._computeVisibilityObb(f),f.vertexCount=c?c.vertexCount:0,new Vt(r,n,Gt(this._visibilityCacheVersion),null,f)}));this._nodePages[t]={nodes:h,children:i,parents:e},this.nodeCount+=h.length,this.updateParentsAndLevel()}updateParentsAndLevel(){const t=new Array,s=(s,i,h)=>{const r=this.getPage(s);if(e(r)){const n=Kt(s,this.nodesPerPage);r.parents[n]=i;const o=r.nodes[n].node;e(o)&&(o.level=h,t.push(s))}};for(s(this.rootIndex,-1,0);t.length;){const i=t.pop(),h=this.getNode(i);if(e(h))for(let t=0;t<h.childCount;t++)s(this.getChildIndex(h,t),i,h.level+1),this._maxLevel=Math.max(this._maxLevel,h.level+1)}}getPage(t){return this._nodePages[Wt(t,this.nodesPerPage)]}getNodeInternal(t){const s=this.getPage(t);return h(s)?null:s.nodes[Kt(t,this.nodesPerPage)]}addNode(t,s){null!=t.children&&this.populateChildren(s,t.children);const i=this.getParent(s),h=e(i)?i.level+1:0;this._maxLevel=Math.max(this._maxLevel,t.children?h+1:h);const{lodMetric:n,maxError:o}=function(t){if(t)for(let s=0;s<t.length;s++)for(const i of Qt)if(i[0]===t[s].metricType)return{lodMetric:i[1],maxError:t[s].maxError};return{lodMetric:0,maxError:0}}(t.lodSelection),a=r(this.getNodeInternal(s));return a.node=new Lt(t.id,s,J(t.mbs),a.childCount,h,t.resources,t.version,n,o,t.numFeatures),t.obb&&(a.node.serviceObb=et(t.obb)),a.node.visibilityObb=this._computeVisibilityObb(a.node),e(a.ref)&&(null==a.ref.mbs&&(a.ref.mbs=t.mbs),a.node.renderMbs=a.ref.renderMbs,a.node.serviceObbInRenderSR=a.ref.serviceObbInRenderSR,a.ref.visibilityObb=a.node.visibilityObb),a.node}makeRefNode(t,s){const i=this._nodePages[0],h=i.nodes.length;return i.nodes.push(new Vt(0,0,Gt(this._visibilityCacheVersion),t,null)),this.nodeCount++,i.parents.push(s),t.renderMbs[3]=-1,e(t.serviceObbInRenderSR)&&(t.serviceObbInRenderSR.halfSize[0]=-1),h}populateChildren(t,s){const i=r(this.getNodeInternal(t)),e=r(this.getPage(t));i.childOffset=e.children.length,i.childCount=s.length;for(let i=0;i<s.length;i++){const h=this.makeRefNode(s[i],t);e.children.push(h)}}getNode(t){const s=this.getNodeInternal(t);return e(s)?s.node:null}getIndexById(t){let s;return this.forAllNodes(((i,h)=>{(e(i.node)&&i.node.id===t||e(i.ref)&&i.ref.id===t)&&(s=h)})),s}getNodeById(t){const s=this.getIndexById(t);return s>=0?this.getNode(s):null}getChildIndex(t,s){const i=this.getPage(t.index);if(h(i))return-1;const e=i.nodes[Kt(t.index,this.nodesPerPage)];return i.children[e.childOffset+s]}getParentIndex(t){const s=this.getPage(t);return e(s)?s.parents[Kt(t,this.nodesPerPage)]:-1}getParent(t){return(t=this.getParentIndex(t))>=0?this.getNode(t):null}isLeaf(t){const s=this.getNodeInternal(t);return e(s)&&0===s.childCount}get rootNode(){return this.getNode(this.rootIndex)}get size(){return this.nodeCount}invalidateVisibilityCache(){this._visibilityCacheVersion=Bt(this._visibilityCacheVersion)}invalidateNodeVisibilityCache(t){const s=this.getNodeInternal(t);e(s)&&this.invalidateNodeVisibilityCacheInternal(s)}invalidateNodeVisibilityCacheInternal(t){t.visibilityCache=Gt(this._visibilityCacheVersion)}invalidateBoundingVolumeCache(t){const s=this.getNodeInternal(t);e(s)&&(qt(s),this.invalidateNodeVisibilityCacheInternal(s))}invalidateGeometryVisibility(t){const s=this.getNodeInternal(t);e(s)&&e(s.node)&&(s.node.geometryObb=null,s.node.renderMbs[3]=-1,e(s.node.serviceObbInRenderSR)&&(s.node.serviceObbInRenderSR.halfSize[0]=-1))}invalidateVisibilityObbs(){h(this.rootNode)||this.traverse(this.rootNode,(t=>(t.visibilityObb=this._computeVisibilityObb(t),t.geometryObb=null,!0)))}isNodeVisible(t){const s=this.getNodeInternal(t);if(h(s)||e(s.ref)&&!s.ref.mbs)return!0;if(!Ht(s.visibilityCache,this._visibilityCacheVersion)){const t=s.node,i=e(t)&&(h(s.ref)||e(t.visibilityObb))?t:e(s.ref)?s.ref:null;if(this._layerHasFilter&&this._computeNodeFiltering&&(e(t)||e(s.ref))&&2===s.filterImpact){const i=e(t)?t.mbs:e(s.ref)?s.ref.mbs:null;s.filterImpact=null!=i?this._computeNodeFiltering(i):0}const r=e(t)&&1===s.filterImpact,n=!(e(t)&&2===t.imModificationImpact)&&(!i||this.viewportQueries.isNodeVisible(i))&&!r;return s.visibilityCache=Ut(n,this._visibilityCacheVersion),n}return zt(s.visibilityCache)}isGeometryVisible(t){if(!this.isNodeVisible(t))return!1;const s=this.getNodeInternal(t);return!(e(s)&&e(s.node)&&e(s.node.geometryObb)&&(!this.layerHasModifications||4!==s.node.imModificationImpact))||this.viewportQueries.isGeometryVisible(s.node)}_traverseCoverage(t,s,i,n,o){const a=this.getPage(t);if(h(a)||0===s.childCount)return;const l=s.childOffset+s.childCount,u=new Array;for(let t=s.childOffset;t<l;++t){const s=a.children[t],i=this.getNodeInternal(s);e(i)&&e(i.node)&&this.isGeometryVisible(s)&&u.push(i)}n/=u.length;for(const t of u){const s=r(t.node).index;this._isLoaded(s)||this._isReloading(s)?(o.delta=Math.max(o.delta,i),o.coverage+=n):this._traverseCoverage(s,t,i+1,n,o)}}useNodeAsHole(t){if("off"===this.holeFilling)return!1;const s=this.getNodeInternal(t);if(h(s))return!1;if("always"===this.holeFilling)return!0;if(Ht(s.useAsHole,this._version))return zt(s.useAsHole);const i={delta:0,coverage:0};this._traverseCoverage(t,s,0,1,i);const e=i.delta*i.coverage<=.5;return s.useAsHole=Ut(e,this._version),e}get maxLevel(){return this._maxLevel}get dirty(){return this._dirty}destroy(){this._updates.add.prune(),this._updates.update.prune()}requestUpdate(){this._dirty=!0,this._indexMissing=1,this._version=Bt(this._version)}imModificationsChanged(t){this.layerHasModifications=t,this.forAllNodes((({node:t})=>{e(t)&&(t.imModificationImpact=4,t.visibilityObb=this._computeVisibilityObb(t),t.hasModifications&&this.invalidateGeometryVisibility(t.index))})),this.invalidateVisibilityCache()}layerFilterChanged(t){this._layerHasFilter=t,this.forAllNodes((t=>{if(e(t)){t.filterImpact=2;const s=t.node;e(s)&&this.invalidateNodeVisibilityCache(s.index)}})),this.invalidateVisibilityCache()}update(t,s,i){if(!this._dirty)return;this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(t),kt.clear();let n=!0;const o=new Jt,a=new Jt,l=this._imModificationUncategorized;l.clear();const u=new Set;this.traverseVisible(((c,d,f)=>{if(h(d)){let t=this.entryPriority(c);t===1/0&&(t=this.entryPriority(f));const s=Wt(c,this.nodesPerPage);return kt.set(s,Math.max(t,kt.get(s)||0)),this._loading.has(s)||this._failedPages.has(s)||this._missing.push(s),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,t))}const m=d.node;if(this._updateNodeFeatureEstimate(m,a),h(m)){const t=this.entryPriority(c);return this._loading.has(c)||this._failedNodes.has(c)||(this._missing.push(c),kt.set(c,t)),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,t))}const g=r(this.getPage(c));if(0===this._missing.length&&0===this.nodesPerPage)for(let t=0;t<d.childCount;t++){const s=g.children[d.childOffset+t],i=this.getNodeInternal(s);!e(i)||i.node||this._loading.has(s)||this._failedNodes.has(s)||(kt.set(s,this.entryPriority(s)),this._prefetch.push(s))}if(m.failed||!m.resources.hasFeatureData)return;if(u.add(m.id),this._isLoaded(c)){if(o.known+=m.memory,++o.knownNodes,this._isSelected(m)?d.childCount>0&&(n=!1):(o.unremoved+=m.memory,n=!1),this._needsUpdate(m)){const t=this.entryPriority(c);kt.set(c,t),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,t),this._updates.update.push(c)}return}if(m.memory&&(o.known+=m.memory,++o.knownNodes),!this._isSelected(m))return void(this._isReloading(c)&&this._updates.remove.push(c));if(d.childCount>0&&(n=!1),m.memory?(o.missing+=m.memory,o.known+=m.memory,++o.knownNodes):++o.missingNodes,t.indexOf(m.index)>=0)return this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this.entryPriority(c)),void(this._updates.cancel=this._updates.cancel.filter((t=>t!==m.index)));if(!s.done&&this._enable(m))return void s.madeProgress();const p=this.entryPriority(c);kt.set(c,p),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,p),this._updates.add.push(c),this.layerHasModifications&&i&&e(m)&&4===m.imModificationImpact&&l.push(c)}));const c=this._updates.add;c.length>0&&this.layerHasModifications&&(l.length>0&&i(l),c.filterInPlace((t=>{const s=this.getNodeInternal(t),i=h(s)||h(s.node)||2!==s.node.imModificationImpact;return i||this.invalidateNodeVisibilityCache(t),i}))),this._unloadedMemoryEstimate=o.missing-o.unremoved,o.knownNodes>3&&o.missingNodes>0&&(this._unloadedMemoryEstimate+=o.known/o.knownNodes*o.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(a),this._featureEstimate.leavesReached=n,this._missing.sort(((t,s)=>t-s)),this._missing.filterInPlace(((t,s)=>s<1||this._missing.data[s-1]!==t)),this._missing.sort(((t,s)=>kt.get(t)-kt.get(s))),this._missing.length>0&&(this._maxUnloadedPrio=kt.get(this._missing.back()),this._prefetch.clear()),this._updates.add.filterInPlace((t=>kt.get(t)>=this._maxUnloadedPrio)).sort(((t,s)=>kt.get(t)-kt.get(s))),this._updates.update.sort(((t,s)=>kt.get(t)-kt.get(s))),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,kt.clear()}checkFeatureTarget(t,s){const i=this.viewportQueries.updateScreenSpaceErrorBias(s);let e=s,h=s,r=i,n=10;for(;n--;){const i=new Jt;if(this._updateFeatureEstimate(e,i),this._computeFeatureEstimate(i)<=t){if(e>=s||i.missingNodes>0||0===n)break;r=e,e=.5*(e+h)}else h=e,e=.5*(e+r)}return this._version=Bt(this._version),this.viewportQueries.updateScreenSpaceErrorBias(i),Math.min(s,e)}_updateFeatureEstimate(t,s){this._version=Bt(this._version),this.viewportQueries.updateScreenSpaceErrorBias(t),this.traverseVisible(((t,i)=>this._updateNodeFeatureEstimate(e(i)&&i.node,s)))}_updateNodeFeatureEstimate(t,s){if(!(h(t)||t.failed||h(t.numFeatures)))return this._isLoaded(t.index)?(s.known+=t.numFeatures,++s.knownNodes,void(this._isSelected(t)||(s.unremoved+=t.numFeatures))):void(this._isSelected(t)&&(e(t.numFeatures)?(s.missing+=t.numFeatures,s.known+=t.numFeatures,++s.knownNodes):++s.missingNodes))}_computeFeatureEstimate(t){let s=t.known-t.unremoved;return t.knownNodes>3&&t.missingNodes>0&&(s+=t.known/t.knownNodes*t.missingNodes),Math.max(0,s)}load(){return this._load(this._missing)}prefetch(){return this._prefetch.sort(((t,s)=>kt.get(t)-kt.get(s))),this._load(this._prefetch)}_load(t){if(0===t.length||!this._canRequest())return!1;for(;t.length>0&&this._canRequest();)0===this.nodesPerPage?this._loadNode(t.pop()):this.loadPage(t.pop());return!0}isLoading(){return this._indexMissing>0}getIndexLoading(){return this._loading.size}getIndexMissing(){return this._indexMissing}getUnloadedMemoryEstimate(){return this._unloadedMemoryEstimate}get updates(){return this._updates}get featureEstimate(){return this._featureEstimate}nodeTraversalState(t){if(h(t))return null;let s=this._nodeTraversalState.get(t.index);if(s&&Ht(s.version,this._version))return s;const i=this.viewportQueries.getLodLevel(t),e=this.viewportQueries.hasLOD(t);let r=!0;if(e){const s=this.getParentIndex(t.index);if(s>=0){const t=this._nodeTraversalState.get(s);r=t&&i>t.lodLevel}else r=i>0}else r=0===t.childCount;return s?(s.lodLevel=i,s.isChosen=r,s.version=Ut(!0,this._version),s):(s=new Pt(e,r,i,Ut(!0,this._version)),this._nodeTraversalState.set(t.index,s),s)}_loadNode(t){this._loading.add(t);const s=r(this.getNodeInternal(t)).ref;if(h(s))return void this._failedNodes.add(t);const e=s.id,n=this.urlPrefix+e,o=()=>{this._loading.delete(t),0===this._missing.length&&0===this._loading.size&&this.requestUpdate()};this.streamDataController.request(n,"json").then((s=>{o();const i=this._validateNode(e,s);if(null==i)return;i.obb&&this.invalidateNodeVisibilityCache(t);const h=this.addNode(i,t);this.nodeTraversalState(h)}),(s=>{o(),i(s)||(this.logger.error("#loadNode()",this.logLayer,"Error loading node: "+n),this._failedNodes.add(t))}))}_validateNode(t,s){if(null==s||"object"!=typeof s||s.id!==t)return this.logger.error("#validateNode()",this.logLayer,`Invalid node. Wrong type or wrong id "${t}"`),null;if(!Array.isArray(s.mbs))return this.logger.error("#validateNode()",this.logLayer,`Invalid bounding volume on node ${t}.`),null;s.sharedResource&&"./shared"!==s.sharedResource.href&&"./shared/"!==s.sharedResource.href&&this.logger.warn("#validateNode()",this.logLayer,`Invalid shared resource href on node "${t}"`),null==s.geometryData||Array.isArray(s.geometryData)&&1===s.geometryData.length&&"./geometries/0"===s.geometryData[0].href||this.logger.warn("#validateNode()",this.logLayer,`Invalid geometry data on node "${t}"`),null==s.attributeData||Array.isArray(s.attributeData)&&!s.attributeData.some(((t,s)=>t.href!==`./attributes/f_${s}/0`))||this.logger.warn("#validateNode()",this.logLayer,`Invalid attribute data on node "${t}"`),s.featureData&&s.featureData.length>1&&this.logger.warn("#validateNode()",this.logLayer,`Node ${t} has ${s.featureData.length} bundles. Only the first bundle will be loaded.`);const i=s.hasOwnProperty("obb")&&!this.ignoreServiceObb?s.obb:null,e=s.featureData&&1===s.featureData.length&&s.featureData[0].featureRange?s.featureData[0].featureRange[1]-s.featureData[0].featureRange[0]+1:null,h=Array.isArray(s.children)?s.children.map((s=>{if(null==s)return null;const i=s=>this.logger.error("#validateNode()",this.logLayer,`Invalid node reference on node ${t}: ${s}`);if("number"==typeof s.id)i(`id ${s.id} is a number instead of a string.`);else if("string"!=typeof s.id||!Array.isArray(s.mbs))return i("Missing or invalid id."),null;if(!Array.isArray(s.mbs))return i(`Invalid bounding volume on reference ${s.id}.`),null;s.href&&s.href!=="../"+s.id&&this.logger.error("#validateNode()",this.logLayer,`Invalid node href on node "${t}"`);const e=s.hasOwnProperty("obb")&&!this.ignoreServiceObb?s.obb:null,h=new Tt(`${s.id}`,s.mbs);return h.serviceObb=e,h.visibilityObb=this._computeVisibilityObb(h),h})).filter((t=>null!=t)):null;return{id:t,mbs:s.mbs,obb:i,children:h,resources:{hasFeatureData:s.featureData&&s.featureData.length>0,hasSharedResource:null!=s.sharedResource,attributes:s.attributeData?t:null,texture:s.textureData&&s.textureData.length>0?t:null,geometry:null!=s.geometryData?t:null},version:"string"==typeof s.version?s.version:null,lodSelection:Array.isArray(s.lodSelection)?s.lodSelection:null,numFeatures:e}}resetFailedNodes(){this._failedNodes.clear(),this._failedPages.clear(),this.forAllNodes((t=>{e(t.node)&&(t.node.failed=!1)}))}entryPriority(t){const s=this.getNodeInternal(t),i=this.getParentIndex(t);if(h(s)||i<0&&null==s.node)return i<0?1/0:this.entryPriority(i);let r=0;if(s.node&&i>=0){const t=this._nodeTraversalState.get(i);null!=t&&(r=t.lodLevel)}let n=this.progressiveLoadPenalty;for(let s=t;s>=0;s=this.getParentIndex(s))if(this._isLoaded(s)){n=0;break}const o=e(s.ref)?this.viewportQueries.distToPOI(s.ref):e(s.node)?this.viewportQueries.distToPOI(s.node):0;return-o-r*(o+this.progressiveLoadPenalty)+n}traverseVisible(t){const s=this.getNodeInternal(this.rootIndex);h(s)?t(this.rootIndex,null,null):this._traverseVisible(this.rootIndex,-1,s,t)}_traverseVisible(t,s,i,h){if(i.node&&0===i.childCount)return void(this.isGeometryVisible(t)&&h(t,i,s));if(!this.isNodeVisible(t))return;if(h(t,i,s),null==i.node)return;const n=this.nodeTraversalState(i.node);if(n.nodeHasLOD&&n.lodLevel===this._maxLodLevel)return;const o=r(this.getPage(t));for(let s=0;s<i.childCount;s++){const r=o.children[i.childOffset+s],n=this.getNodeInternal(r);e(n)?this._traverseVisible(r,t,n,h):h(r,null,t)}}traverse(t,s){s(t)&&this.traverseChildren(t,s)}traverseChildren(t,s){const i=t.index,h=this.getNodeInternal(i);e(h)&&this._traverseChildren(i,h,s)}_traverseChildren(t,s,i){const r=this.getPage(t);if(h(r))return;const n=s.childOffset+s.childCount;for(let t=s.childOffset;t<n;++t){const s=r.children[t],h=this.getNodeInternal(s);e(h)&&e(h.node)&&i(h.node)&&this._traverseChildren(s,h,i)}}updateStats(t){if(this._updates.add.length>0&&(t.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(t.index+=" + "+this._indexMissing||this._prefetch.length),t.prio=this._maxProcessingPrio,this._featureEstimate.estimate){const s=this._featureEstimate.estimate-t.features;s>0?t.features+=" + "+s:s<0&&(t.features+=" - "+-s)}}getPriority(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}updateElevationInfo(t){this.forAllNodes(qt),this.viewportQueries.updateElevationInfo(t)}forAllNodes(t){for(let s=0;s<this._nodePages.length;s++){const i=this._nodePages[s];if(i){const e=s*this.nodesPerPage;for(let s=0;s<i.nodes.length;s++)t(i.nodes[s],e+s)}}}get test(){return{addNode:(t,s)=>this.addNode(t,s)}}}const kt=new Map;class Rt{constructor(t){this.missing=t,this.update=new s({deallocator:null}),this.add=new s({deallocator:null}),this.remove=new s({deallocator:null}),this.cancel=[]}reset(t){this.add.clear(),this.update.clear(),this.cancel=t}}function qt(t){e(t.node)&&(t.node.renderMbs[3]=-1,e(t.node.serviceObbInRenderSR)&&(t.node.serviceObbInRenderSR.halfSize[0]=-1)),e(t.ref)&&(t.ref.renderMbs[3]=-1,e(t.ref.serviceObbInRenderSR)&&(t.ref.serviceObbInRenderSR.halfSize[0]=-1))}function Gt(t){return X(t,-2)}function Bt(t){return X(t,2)}function Ut(t,s){return s+(t?1:0)}function Ht(t,s){return(-2&t)===s}function zt(t){return 1==(1&t)}function Wt(t,s){return 0===s?0:t/s|0}function Kt(t,s){return 0===s?t:t%s}const Qt=[["maxScreenThreshold",1],["screenSpaceRelative",2],["removedFeatureDiameter",3],["distanceRangeFromDefaultCamera",4]];class Jt{constructor(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}}function Xt(t){return Math.sqrt(t*(4/Math.PI))}class Yt{constructor(t){this.layerView=t,this._lodGlobalDirty=!1}startNodeLoading(t,s,i,e){this._maxLodLevel=e.maxLodLevel,this._index=i,this._isNodeInScaleBounds=t,this._removeNodes=s}shouldLoadNode(t){if(h(t))return!1;const s=this._index.nodeTraversalState(t);return!!this.isChosenMaxLOD(s)||!!s.isChosen&&this._childrenRequireLoading(t)}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return null!=this._index&&!0===this._lodGlobalDirty}lodGlobalHandling(t){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const s=Math.max(0,Math.floor(10*(this.layerView.view.resourceController.memoryController.usedMemory-1)));Zt.clear(),this._lodGlobalHandling(this._index.rootNode,s,!1);const i=Zt.length;this._removeNodes(Zt,t);const e=Zt.length<i;return 0!==Zt.length&&(this._lodGlobalDirty=!0),Zt.clear(),e}_lodGlobalHandling(t,s,i){if(h(t))return!1;const r=t.index,n=this._index,o=this.layerView,a=n.nodeTraversalState(t),l=this.isChosenMaxLOD(a),u=o.isNodeLoaded(r),c=o.nodeCrossfadingEnabled;if(c&&u&&l){const s=!i&&this.hasNoVisibleChildren(t);o.fadeNode(r,0,!s)}const d=u&&(!o.isNodeFullyFadedIn||o.isNodeFullyFadedIn(r));if(u&&(o.updateNodeState(r,l?1:0),l))return d&&this._removeChildrenRecursive(t),d;const f=t.childCount>0;let m=f;if(f)for(let h=0;h<t.childCount;h++){const r=n.getChildIndex(t,h),o=n.getNode(r);e(o)?n.isGeometryVisible(r)&&!this._lodGlobalHandling(o,s,i||d)&&this._isNodeInScaleBounds(o)&&(m=!1):n.isNodeVisible(r)&&(m=!1)}const g=u&&!l&&(m||Zt.length<s);return g&&Zt.push(r),!c||g||!u||i||m||o.fadeNode(r,0,!1),m||d&&!g||!t.resources.hasFeatureData}_removeChildrenRecursive(t){this._index.traverseChildren(t,(t=>((this.layerView.isNodeLoaded(t.index)||this.layerView.isNodeReloading(t.index))&&Zt.push(t.index),!0)))}hasNoVisibleChildren(t){let s=!0;return this._index.traverseChildren(t,(t=>!(!s||!this._index.isNodeVisible(t.index)||this.layerView.isNodeLoaded(t.index)&&(s=!1,1)))),s}_childrenRequireLoading(t){let s=!1,i=!0;return this._index.traverseChildren(t,(t=>{if(!i||!this._index.isNodeVisible(t.index))return!1;const e=this._index.nodeTraversalState(t);return this.isChosenMaxLOD(e)&&this._index.isGeometryVisible(t.index)&&(s=!0),!this.layerView.isNodeLoaded(t.index)||(i=!1,!1)})),i&&s}isChosenMaxLOD(t){return t.isChosen&&(!t.nodeHasLOD||t.lodLevel===this._maxLodLevel)}}const Zt=new s({deallocator:null});class ts{constructor(t,s){this._textureRep=t,this._disposed=!1,this._textureRep.acquire(s).then((t=>{this._disposed?n(t):this._textureRef=t}))}dispose(){this._textureRef=n(this._textureRef),this._disposed=!0}bind(t,s,i){const h=e(this._textureRef)?this._textureRef.glTexture:null;e(h)&&(t.bindTexture(h,s),t.setUniform2f(i,h.descriptor.width,h.descriptor.height))}}function ss(t){return t.sort(((t,s)=>t.encoding-s.encoding))}const is={ktx2:1,basis:2,dds:4,png:8,jpg:16,"ktx-etc2":32},es={[mt.KTX2_ENCODING]:2,[mt.BASIS_ENCODING]:2,[mt.DDS_ENCODING]:4,"image/png":8,"image/jpg":16,"image/jpeg":16,"image/ktx":32};function hs(t){const s=t&&t.materialDefinitions?Object.keys(t.materialDefinitions)[0]:null,i=t&&t.textureDefinitions?Object.keys(t.textureDefinitions)[0]:null,e=s&&t.materialDefinitions[s],h=i&&t.textureDefinitions[i],r=rs();if(null!=e){const t=e.params;t.diffuse&&(r.metallicRoughness.baseColorFactor=[t.diffuse[0],t.diffuse[1],t.diffuse[2],1]),null!=t.doubleSided&&(r.doubleSided=t.doubleSided,r.cullFace=t.doubleSided?0:2),"none"!==t.cullFace&&"front"!==t.cullFace&&"back"!==t.cullFace||(r.cullFace="none"===t.cullFace?0:"back"===t.cullFace?2:1),t.transparency&&(r.metallicRoughness.baseColorFactor[3]=R(1-t.transparency,0,1)),(t.useVertexColorAlpha||r.metallicRoughness.baseColorFactor[3]<1)&&(r.alphaMode="blend")}const n=[];if(null!=h){const t=0;!h.wrap||"repeat"!==h.wrap[0]&&"repeat"!==h.wrap[1]||(r.wrapTextures=!0);let s=1;"rgba"===h.channels&&(r.alphaMode="blend",s|=32);const i=h.images[h.images.length-1],e=t=>t&&t.split("/").pop(),o=Array.isArray(h.encoding)?ss(h.encoding.map(((t,s)=>({name:e(i.href[s]),encoding:es[t]||0})))):[{name:e(i.href),encoding:es[h.encoding]||0}];n.push({id:t,usage:s,encodings:o}),r.metallicRoughness.baseColorTextureId=t}return{material:r,textures:n}}const rs=()=>({alphaMode:"opaque",alphaCutoff:ft,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0});function ns(t,s,i,e){if(h(t)||null==t.data)return null;const r=t.data,n=!(r instanceof HTMLImageElement)||q(r.width)&&q(r.height),o=i&&!e.capabilities.shaderTextureLOD?1:e.renderingContext.parameters.maxMaxAnisotropy,a=n&&!t.downsampled&&o>1,l=i||!s.wrapTextures?os:as,u=function(t){switch(t){case 1:return mt.KTX2_ENCODING;case 2:return mt.BASIS_ENCODING;case 4:return mt.DDS_ENCODING;case 8:return"image/png";case 16:return"image/jpeg";case 32:return"image/ktx";default:return""}}(t.encoding);return new mt(r,{mipmap:a,maxAnisotropy:o,encoding:u,wrap:l,components:1&t.usage?"opaque"===s.alphaMode?3:4:3,noUnpackFlip:!0})}const os={s:33071,t:33071},as={s:10497,t:10497};function ls(t,s,i,r,n,l){const u=l.rendererTextureUsage,c=t=>function(t,s,i){if(h(t)||0===i)return null;for(let h=0;h<t.length;h++){const r=t[h];if(e(r)&&0!=(r.usage&i)){const t=s[h];return e(t)?t.id:null}}return null}(r,i,t&u),d=s.metallicRoughness.baseColorFactor,f=R(s.metallicRoughness.baseColorFactor[3],0,1);t.baseColor=[d[0],d[1],d[2],f],t.hasParametersFromSource=!!s.hasParametersFromSource,t.usePBR=l.usePBR,t.mrrFactors=[s.metallicRoughness.metallicFactor,s.metallicRoughness.roughnessFactor,s.hasParametersFromSource?.2:.5],t.emissiveFactor=s.emissiveFactor,t.isIntegratedMesh=l.isIntegratedMesh,t.alphaCutoff="mask"===s.alphaMode?s.alphaCutoff:ft,t.alphaDiscardMode="opaque"===s.alphaMode?1:"mask"===s.alphaMode?2:3;const m=c(33);e(m)&&(t.baseColorTexture=new ts(n,m));const g=c(2);e(g)&&(t.metallicRoughnessTexture=new ts(n,g));const p=c(16);e(p)&&(t.emissionTexture=new ts(n,p));const b=c(8);e(b)&&(t.occlusionTexture=new ts(n,b));const v=c(4);e(v)&&(t.normalTexture=new ts(n,v)),t.commonMaterialParameters.slicePlaneEnabled=l.slicePlaneEnabled,t.commonMaterialParameters.doubleSided=s.doubleSided,t.commonMaterialParameters.cullFace=s.cullFace,t.ellipsoidMode=function(t){return t&&o(t)?2:t&&a(t)?3:1}(l.viewSpatialReference)}function us(t){const s=!!t.compressedTextureS3TC,i=!!t.compressedTextureETC,e=l("disable-feature:i3s-basis")?0:3;return 24|(s?4|e:0)|(i?e:0)}function cs(t,s){return t.find((t=>0!=(t.encoding&s)))}class ds{constructor(t,s,i,r,n,o){if(this.streamDataController=s,this.logger=i,this.defaultGeometrySchema=r,this.requiredAttributes=n,this.options=o,this.logLayer=t,this.layerUrl=t.parsedUrl.path,this.geometryDefinitions=t.geometryDefinitions,t.materialDefinitions){const s=t.textureSetDefinitions;this.materialAndTextures=t.materialDefinitions.map((t=>function(t,s){const i=new Map,r=(t,s)=>{if(h(t))return-1;if(i.has(t.id)){const e=i.get(t.id);return e.usage|=s,e.id}const e=i.size;return i.set(t.id,{id:e,usage:s}),e},n=s.pbrMetallicRoughness,o=n&&n.baseColorFactor,a=s.emissiveFactor,l=null==s.normalTexture&&null==s.emissiveTexture&&null==s.occlusionTexture&&(!n||null==n.metallicRoughnessTexture&&1===n.roughnessFactor&&(1===n.metallicFactor||0===n.metallicFactor)),u=l?dt[0]:n?n.metallicFactor:1,c=l?dt[1]:n?n.roughnessFactor:1,d={baseColorFactor:o?[o[0],o[1],o[2],o[3]]:[1,1,1,1],baseColorTextureId:r(n&&n.baseColorTexture,"mask"===s.alphaMode?33:1),metallicRoughnessTextureId:r(n&&n.metallicRoughnessTexture,2),metallicFactor:u,roughnessFactor:c},f={alphaMode:s.alphaMode,alphaCutoff:s.alphaCutoff,doubleSided:s.doubleSided,cullFace:"none"===s.cullFace?0:"back"===s.cullFace?2:"front"===s.cullFace?1:void 0,normalTextureId:r(s.normalTexture,4),emissiveTextureId:r(s.emissiveTexture,16),occlusionTextureId:r(s.occlusionTexture,8),emissiveFactor:a?[a[0],a[1],a[2]]:[0,0,0],metallicRoughness:d,wrapTextures:!1,hasParametersFromSource:l},m=[];return i.forEach((({usage:s},i)=>{const h=e(t)&&t[i]&&t[i].formats,r=h?ss(h.map((({name:t,format:s})=>({name:t,encoding:is[s]})))):[];m.push({id:i,usage:s,encodings:r})})),{material:f,textures:m}}(s,t)))}}load(t,s,i){return this.streamDataController.request(t,s,i)}loadAttribute(t,s,i){return this.load(`${this.layerUrl}/nodes/${t.resources.attributes}/attributes/${s.key}/0`,"binary",i).then((t=>ut(s,t)))}loadAttributes(t,s,e){return u(s.map((s=>this.loadAttribute(t,s.attributeStorageInfo,e)))).then((e=>{const h={};for(let r=0;r<s.length;++r)if(e[r].value)h[s[r].name]=e[r].value;else{if(i(e[r].error))throw e[r].error;this.logger.error("#loadAttributes",this.logLayer,`Failed to load attributeData for '${s[r].name}' on node '${t.id}'`,e[r].error)}return h}))}async loadNodeData(t,s){const i=null!=this.requiredAttributes&&t.resources.attributes?ot(this.loadAttributes(t,this.requiredAttributes,s)):null,{bufferDefinition:r,bufferIndex:n}=function(t,s){const i={bufferDefinition:null,bufferIndex:0};if(null==t||s.resources.geometryDefinition<0)return i;const e=s.resources.geometryDefinition>=0?t[s.resources.geometryDefinition].geometryBuffers:null;if(null==e)return i;for(let t=0;t<e.length;t++){const s=e[t];if(null==s.compressedAttributes)i.bufferIndex=t,i.bufferDefinition=e[t];else if("draco"===s.compressedAttributes.encoding&&!l("disable-feature:i3s-draco"))return i.bufferIndex=t,i.bufferDefinition=s,i}return i}(this.geometryDefinitions,t),o=!!t.resources.geometry,a=o?ot(this.loadGeometry(t.resources.geometry,n,s)):null,u=t.resources.hasSharedResource?await this.loadShared(t,s):null,c=this.materialAndTextures&&t.resources.materialDefinition>=0?this.materialAndTextures[t.resources.materialDefinition]:null!=u?hs(u):null,d=c&&c.material,f=c&&c.textures,m=`${t.id}`,g=!o&&this.options.loadFeatureData,p=g?await this.loadFeatureData(m,s):null,b=g?function(t){for(const s of t.featureData){const t=s.geometries;if(null!=t)for(const i of t)return{featureIds:[s.id],featureDataPosition:s.position,geometries:[i]}}return null}(p):function(t){return{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:t}}],featureDataPosition:[0,0,0]}}(d),v=h(b)&&function(t){const s=new Array;for(const i of t.featureData)null!=i.position&&s.push({featureIds:[i.id],featureDataPosition:i.position,geometries:null});return s}(p),y=null!=f&&f.length>0?ot(this.loadTextures(t,f,s)):null;let w=null,x=null;if(a){w=at(await a);const t=fs(this.defaultGeometrySchema,u);x=ct(r,t)}const M=y?at(await y):null,I=i?at(await i):{},C=I?{attributeData:I,loadedAttributes:this.requiredAttributes}:null;return e(b)?{geometryData:b,attributeDataInfo:C,geometryBuffer:w,geometryDescriptor:x,requiredTextures:f,textureData:M}:e(v)?{pointData:v,attributeDataInfo:C,geometryBuffer:w,geometryDescriptor:x,requiredTextures:f,textureData:M}:Promise.reject()}static addAbsoluteHrefTexture(t,s){const i=t.textureDefinitions;if(null!=i)for(const t of Object.keys(i))for(const e of i[t].images)e.hrefConcat=Array.isArray(e.href)?e.href.map((t=>c(t,s))):c(e.href,s)}static fixTextureEncodings(t){const s=t.textureDefinitions;if(null!=s)for(const t in s){const i=s[t];if(Array.isArray(i.encoding))for(let t=0;t<i.encoding.length;t++){const s=i.encoding[t];"data:"===s.substring(0,5)&&(i.encoding[t]=s.substring(5))}else{const t=i.encoding;"data:"===t.substring(0,5)&&(i.encoding=t.substring(5))}}}loadShared(t,s){const i=`${this.layerUrl}/nodes/${t.resources.geometry}/shared`;return this.load(i,"json",s).then((t=>(ds.fixTextureEncodings(t),ds.addAbsoluteHrefTexture(t,i),t)))}loadTexture(t,s,i,e,h,r){let n=!1;return 4===h||1===h||2===h?this.load(t,"binary",r).then((t=>({id:s,usage:i,data:t,encoding:h,downsampled:n}))):this.load(t,"image",r).then((t=>{let r=t;if(e&&t.width*t.height>=4096){const s=Math.ceil(t.width/2),i=Math.ceil(t.height/2),e=document.createElement("canvas");e.width=s,e.height=i,e.getContext("2d").drawImage(t,0,0,s,i),r=e,n=!0}return{id:s,usage:i,data:r,encoding:h,downsampled:n}}))}loadTextures(t,s,i){const e=this.options.uncompressedTextureDownsamplingEnabled,h=this.options.textureUsageMask;return Promise.all(s.map((s=>{if(0==(s.usage&h))return null;const r=cs(s.encodings,this.options.textureEncodings);return null==r?(this.logger.error("#loadTextures",this.logLayer,`No known encoding for texture found on node ${t.id}`),Promise.reject()):this.loadTexture(`${this.layerUrl}/nodes/${t.resources.texture||t.id}/textures/${r.name}`,s.id,s.usage,e,r.encoding,i)})))}loadFeatureData(t,s){return this.load(`${this.layerUrl}/nodes/${t}/features/0`,"json",s)}loadGeometry(t,s,i){return this.load(`${this.layerUrl}/nodes/${t}/geometries/${s}`,"binary",i)}}function fs(t,s){if(!t||!s||!s.materialDefinitions)return t;const i=Object.keys(s.materialDefinitions)[0];return!s.materialDefinitions[i].params.vertexRegions&&t.vertexAttributes.region&&delete(t=d(t)).vertexAttributes.region,t}class ms{constructor(t,s){this.requester=t,this.apiKey=s,this.activeRequests=new Set}get busy(){return this.requester.busy}request(t,s,i){const e=new AbortController,h=f(i,(()=>e.abort())),r=this.requester.request(t,s,{signal:e.signal,query:{token:this.apiKey}}),n={response:r,abortController:e,abortHandle:h};return this.activeRequests.add(n),m(r,(()=>{var t;n.abortController=null,null==(t=n.abortHandle)||t.remove(),n.abortHandle=null,this.activeRequests.delete(n)})),r}cancelAll(){this.activeRequests.forEach((t=>{var s,i;null==(s=t.abortController)||s.abort(),t.abortController=null,null==(i=t.abortHandle)||i.remove()})),this.activeRequests.clear()}}const gs=1e5;class ps{constructor(t,s,i,e,h,r,n,o={}){this._indexSR=t,this._renderCoordsHelper=s,this.clippingArea=h,this._elevationProvider=r,this._options=o,this._frustum=bt(),this._useFrustumCulling=!1,this._poi=gt(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmp1=gt(),this._tmp2=gt(),this._tmp3=gt(),this._tmp0=gt(),this._screenspaceErrorBias=o.screenspaceErrorBias||1,this._progressiveLoadFactor=o.progressiveLoadFactor||1,this.updateCamera(i,e),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(n),this._tmpPoint=L(0,0,0,t)}updateElevationInfo(t){null!=t?(this._elevationContext=vt.fromElevationInfo(t),this._elevationContext.updateFeatureExpressionInfoContext(yt(wt(t,!1)))):this._elevationContext=null}updateCamera(t,s){this._useFrustumCulling=s,s&&xt(t.viewMatrix,t.projectionMatrix,this._frustum),this._screenSizeFactor=1/(t.perScreenPixelRatio/2),this._camPos=t.eye,this.minDistance=1/0,this.maxDistance=0}setPointOfInterest(t){this._poi=t}updateScreenSpaceErrorBias(t){const s=this._screenspaceErrorBias;return this._screenspaceErrorBias=t,s}updateClippingArea(t){this.clippingArea=t}getRenderMbs(t){const s=t.renderMbs;return s[3]<0&&(G(s,t.mbs),this._elevationContext&&s[3]<gs&&(this._tmpPoint.x=s[0],this._tmpPoint.y=s[1],this._tmpPoint.z=s[2],s[2]=Mt(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper)),F(s,this._indexSR,s,this.engineSR)),s}getVisibilityObb(t){if(e(t.visibilityObb))return t.visibilityObb;const s=t.serviceObb;return h(s)||s.halfSize[0]<0?void 0:(t.serviceObbInRenderSR=this._computeRenderObb(s,t.serviceObbInRenderSR,t.mbs[3]),t.serviceObbInRenderSR)}_computeRenderObb(t,s,i){if(h(s)&&(s=ht()),s.halfSize[0]<0){let e=0;this._elevationContext&&i<gs&&(this._tmpPoint.x=t.center[0],this._tmpPoint.y=t.center[1],this._tmpPoint.z=t.center[2],e=Mt(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper)-t.center[2]),Y(t,this._indexSR,s,this.engineSR,e)}return s}isNodeVisible(t){const s=this.getRenderMbs(t);if(!this._isMBSinClippingArea(s))return!1;if(!this._useFrustumCulling)return!0;const i=this.getVisibilityObb(t);return e(i)?rt(i,this._frustum):It(this._frustum,Ct(s))}isGeometryVisible(t){if(!this._useFrustumCulling)return!0;const s=t.geometryObb;return e(s)?rt(s,this._frustum):this.isNodeVisible(t)}_isMBSinClippingArea(t){return!!h(this.clippingArea)||0!==Z(this.clippingArea,t)}screenSpaceDiameterMbs(t,s){const i=this.getRenderMbs(t),e=Math.sqrt(Q(i,this._camPos)),h=e-i[3];return this._updateMinMaxDistance(e),h<0?.5*Number.MAX_VALUE:s/h*this._screenSizeFactor}calcCameraDistance(t){return this.calcCameraDistanceToCenter(t)-this.getRenderMbs(t)[3]}calcCameraDistanceToCenter(t){const s=this.getRenderMbs(t),i=K(s,this._camPos);return this._updateMinMaxDistance(i),i}calcAngleDependentLoD(t){const s=this.getRenderMbs(t),i=s[3],e=(Math.abs(s[0]*(s[0]-this._camPos[0])+s[1]*(s[1]-this._camPos[1])+s[2]*(s[2]-this._camPos[2]))/k(s)+i)/K(s,this._camPos);return Math.min(1,e)}hasLOD(t){return 0!==t.lodMetric}getDistancePlanarMode(t,s){const i=t[0]-s[0],e=t[1]-s[1],h=t[2]-s[2],r=i*i+e*e,n=s[3];if(r<=n*n)return Math.abs(h);const o=Math.sqrt(r)-n;return Math.sqrt(h*h+o*o)}getDistanceGlobeMode(t,s){const i=k(s),e=k(t)-i;B(this._tmp0,t,U(t,s)/H(t));const h=Q(s,this._tmp0),r=s[3];if(h<=r*r)return Math.abs(e);{const h=B(this._tmp0,s,1/i),n=B(this._tmp1,h,i-r*r/2/i),o=t,a=z(this._tmp2,o,n),l=z(this._tmp2,a,B(this._tmp3,h,U(h,a))),u=W(this._tmp2,n,B(this._tmp2,l,r/k(l)));let c=K(o,u);if(e>=2e5){const t=z(this._tmp1,o,u);let s=U(t,h)/k(t);s<.08&&(s=1e-4),c/=s}return c}}getDistance(t,s){return this.engineSR===pt(this.engineSR)?this.getDistanceGlobeMode(t,s):this.getDistancePlanarMode(t,s)}_updateMinMaxDistance(t){t>0?(this.minDistance=Math.min(this.minDistance,t),this.maxDistance=Math.max(this.maxDistance,t)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-t))}getLodLevel(t){if(0===t.lodMetric||!t.resources.hasFeatureData)return 0;if(0===t.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this._progressiveLoadFactor<1){const s=this._screenspaceErrorBias;return this.evaluateLODmetric(t,this._progressiveLoadFactor*this._screenspaceErrorBias)?this.evaluateLODmetric(t,s)?2:1:0}return this.evaluateLODmetric(t,this._screenspaceErrorBias)?this.maxLodLevel:0}evaluateLODmetric(t,s){switch(t.lodMetric){case 2:{const i=this.getRenderMbs(t),e=this.getDistance(this._camPos,i),h=2*e/this._screenSizeFactor;return this._updateMinMaxDistance(e+i[3]),t.maxError*s<=h}case 1:{let i=this.screenSpaceDiameterMbs(t,t.mbs[3]*s);return this._options.angleDependentLoD&&(i*=this.calcAngleDependentLoD(t)),i<t.maxError}case 3:return this.screenSpaceDiameterMbs(t,t.maxError)*s<10;case 4:return this.calcCameraDistance(t)>t.maxError*s}return!1}distToPOI(t){const s=this.getRenderMbs(t);return K(s,this._poi)-s[3]}distCameraToPOI(){return K(this._camPos,this._poi)}}const bs=g.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),vs=1e-4;let ys=class extends(p(b)){constructor(t){super(t),this.screenSizeFactor=0,this.featureTarget=5e4,this.fixedFeatureTarget=!1,this.updating=!0,this.updatingProgress=1,this.leavesReached=!1,this.scaleVisibilityEnabled=!0,this._featureLOD=1,this._stableFeatureLOD=!1,this._isIdle=!1,this._cameraDirty=!0,this._invisibleDirty=!1,this._newLoadingNodes=new s({deallocator:null}),this._loadedNodeScales=new Map,this._modificationsNodeFilteringArray=new s,this._downloadingCount=0,this._loadingNodes=new Map,this._updatingNodes=new Map,this._progressMaxNumNodes=1,this._requiredAttributes=new Array,this._requiredAttributesDirty=!0,this._updatesDisabled=!1,this.disableIDBCache=!1,this._disableMemCache=!1,this._restartNodeLoading=!1,this._fields=null,this._attributeStorageInfo=null,this._handles=new v,this._idleQueue=new V,this._elevationUpdateNodes=new s({deallocator:null}),this._errorCount=0}get isMeshPyramid(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType}get isGraphics3D(){return"points"===this.layer.profile}get indexStreamController(){const t=this.layerView.view.resourceController.createStreamDataRequester(2);return new ms(t,this.layer.apiKey)}get dataStreamController(){const t=this.layerView.view.resourceController.createStreamDataRequester(3);return new ms(t,this.layer.apiKey)}get crsVertex(){return tt(this.layer)}get crsIndex(){return st(this.layer)}get rootNodeVisible(){if(e(this._index)){const t=this._index.rootNode;if(e(t))return this._updateViewData(),this._index.isNodeVisible(t.index)}return!0}get index(){return this._index}initialize(){this._disableMemCache=!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData,this._lodHandling=new Yt(this.layerView);const t=this.layerView.i3slayer;this.layer=t,this._defaultGeometrySchema=t.store.defaultGeometrySchema,this.disableIDBCache=l("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo),this.addResolvingPromise(Promise.all([this.layer.indexInfo,this.layer.when(),this.layerView.when()]).then((([s])=>{var i;if(this.destroyed||!this.layerView||this.layerView.destroyed)return;const h=this.layerView.view;this._setClippingArea(h.clippingArea);const r=this.layerView.view.resourceController;this._handles.add([y(h,"pointsOfInterest.focus.renderLocation",(t=>this._pointOfInterestChanged(t))),r.memoryController.events.on("quality-changed",(()=>this._setCameraDirty())),y(this.layerView,"suspended",(t=>{const s=t?()=>this._updateViewData():()=>this._updateIdleState(!0),i=t?()=>{}:()=>this._updateIdleState(!1);this._idleStateCallbacks?(t&&this.cancelNodeLoading(),this.restartNodeLoading(),this._idleStateCallbacks.idleBegin=s,this._idleStateCallbacks.idleEnd=i):this._idleStateCallbacks=r.scheduler.registerIdleStateCallbacks(s,i)})),jt(this.layerView.view.resourceController.scheduler,{update:(t,s)=>this._frame(t,s),needsUpdate:()=>this.updating}),this.watch("uncompressedTextureDownsamplingEnabled",(()=>this.restartNodeLoading())),this.watch(["featureTarget","fixedFeatureTarget"],(()=>{this._setCameraDirty(),this._stableFeatureLOD=!1})),h.state.watch("contentCamera",(()=>this._setCameraDirty())),this.layer.watch("elevationInfo",(()=>this._elevationInfoChanged())),this.layer.watch(["minScale","maxScale"],(()=>this._scaleBoundsChanged())),this.layerView.watch("lodFactor",(()=>this._setCameraDirty())),this.layerView.watch("availableFields?",(()=>this._requiredFieldsChange())),this.layerView.watch("holeFilling",(t=>e(this._index)&&(this._index.holeFilling=t)))]),this._updateScaleHandles(),this._viewportQueries=new ps(this.crsIndex,h.renderCoordsHelper,h.state.contentCamera,!h.state.fixedContentCamera||this.isGraphics3D,this._clippingArea,h.elevationProvider,this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(),screenspaceErrorBias:this.lod,angleDependentLoD:this.lod<.5}),this._index=new Et(t,s,this.indexStreamController,this._viewportQueries,bs,this.layerView.holeFilling,(t=>this.layerView.isNodeLoaded(t)),(t=>this.layerView.isNodeReloading(t)),(t=>this._shouldLoadNode(t)),(t=>this._enableFromGPUCache(t,1)),(t=>this._needsUpdate(t)),(()=>!this.indexStreamController.busy),(t=>this.layerView.computeVisibilityObb?this.layerView.computeVisibilityObb(t):null),null!=(i=this.layerView)&&i.computeNodeFiltering?t=>this.layerView.computeNodeFiltering(t):void 0),this._index.imModificationsChanged(!!this.layerView.hasModifications),this._startNodeLoading()}))),this._tmpPoint=L(0,0,0,this.crsIndex)}updateNodeModificationStatus(t){const s=this._index,i=this.layerView;e(s)&&i&&i.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),t.forAll((t=>{const i=s.getNode(t);e(i)&&this._modificationsNodeFilteringArray.push(i)})),i.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}destroy(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,ws.prune(),e(xs)&&(xs.hide(),xs=null)}_getRequiredAttributes(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];const t=this._attributeStorageInfo,s=this._fields,i=this.layer.objectIdField;return this.layerView.availableFields.map((i=>{const e=Is(t,i),h=Is(s,i);return e>=0&&h>=0?{index:e,name:s[h].name,field:s[h],attributeStorageInfo:t[e]}:null})).filter((t=>null!=t&&t.name!==i))}_requiredFieldsChange(){const t=this._getRequiredAttributes();Ms(this._requiredAttributes,t)||(this._requiredAttributes=t,this._requiredAttributesDirty=!1,this.restartNodeLoading())}requestUpdate(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}_setClippingArea(t){const s=T();this._clippingArea=Nt(t,s,this.layerView.view.renderSpatialReference)?s:null}_pointOfInterestChanged(t){e(this._viewportQueries)&&(this._viewportQueries.setPointOfInterest(t),e(this._index)&&(this._index.progressiveLoadPenalty=Cs.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}updateClippingArea(t){this._setClippingArea(t),e(this._viewportQueries)&&e(this._index)&&(this._viewportQueries.updateClippingArea(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}_setCameraDirty(){this._cameraDirty=!0,this.notifyChange("rootNodeVisible"),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}updateElevationChanged(t,s){const i=this._index;if(h(i))return;const e=i.rootNode;if(h(e))return;const r=this._elevationUpdateNodes;r.clear(),it(t,s,e,this.crsIndex,i,(t=>r.push(t.index))),r.forAll((t=>{i.invalidateBoundingVolumeCache(t),t===e.index&&this.notifyChange("rootNodeVisible")})),r.length&&this.restartNodeLoading()}getParentIndex(t){return e(this._index)&&this._index.getParentIndex(t)}_elevationInfoChanged(){e(this._index)&&this._index.updateElevationInfo(this.layer.elevationInfo),this._setCameraDirty()}_updateScaleHandles(){const t="scale-bounds";this._handles.remove(t),this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",(t=>this._scaleUpdateHandler(t))),t)}_scaleBoundsChanged(){this.areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()}_scaleUpdateHandler(t){this._updateScaleInBoundingRect(t.extent,t.spatialReference),this._setCameraDirty()}_updateScaleInBoundingRect(t,s){const i=this._index;h(i)||!h(i.rootNode)&&$(t,s,Ns,this.crsIndex)&&this._loadedNodeScales.forEach(((t,s)=>{const h=i.getNode(s);e(h)&&j(Ns,h.mbs)&&this._loadedNodeScales.set(s,this._computeScale(h))}))}restartNodeLoading(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}schedule(t,s){return this._idleQueue.push(t,s)}reschedule(t,s){return this._idleQueue.unshift(t,s)}get isIntegratedMesh(){return"integrated-mesh"===this.layer.type}get areScaleBoundsActive(){const{minScale:t,maxScale:s}=St(this.layer);return this.scaleVisibilityEnabled&&(t>0||s>0)}get unloadedMemoryEstimate(){return h(this._index)||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor}get indexDepth(){return e(this._index)?this._index.maxLevel:0}set disableMemCache(t){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0),this._disableMemCache=t}_frame(t,s){return this.layerView.suspended?(this._updateViewData(),this._evaluateUpdating(),-1/0):!this.layerView.visible||h(this._index)?-1/0:(this._processLogError(t,s),this._index.getPriority())}_processLogError(t,s){try{this._process(t,s)}catch(t){this._errorCount<50?bs.error("Error during processing: "+t):50===this._errorCount&&bs.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}_process(t,s){this._restartNodeLoading&&this._startNodeLoading(),null==this._nodeLoader||h(this._index)||(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(t)&&(this._invisibleDirty=!1),this.isIntegratedMesh&&(t.enabled=!1),t.run((()=>this._processIndex(t))),this._updateFeatureLOD(),t.run((()=>this._processCache(t))),this.isIntegratedMesh&&(t.enabled=!0),t.run((()=>this._processNodes(t,s))),this._idleQueue.runTask(t),t.run((()=>this._prefetchIndex())),s.numIndexLoading+=this._index.getIndexLoading(),s.numNodesLoading+=this._downloadingCount,t.run((()=>this._lodHandling.lodGlobalHandling(t))),this._evaluateUpdating())}_processIndex(t){if(h(this._index))return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update([...this._loadingNodes.keys()],t,(t=>this.updateNodeModificationStatus(t))),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));const s=this._index.featureEstimate.leavesReached;this._index.isLoading()||s===this._get("leavesReached")||this._set("leavesReached",s)}return this._index.load()}_prefetchIndex(){return!(h(this._index)||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}_updateFeatureLOD(){if(!this.isGraphics3D||h(this._index)||h(this._viewportQueries))return;const t=!this._index.isLoading(),s=this.featureTarget*this.baseLOD,i=this._index.featureEstimate;if(i.estimate=i.estimate||s/2,this._index.getIndexMissing()>500){if(this._featureLOD<=vs)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(t&&i.estimate<s){if(i.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;const t=Math.min(10,Math.max(s/i.estimate,1.001));this._featureLOD*=t;const e=this.lod,h=this._index.checkFeatureTarget(s,e);h!==e&&(this._featureLOD=h/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(i.estimate>1.2*s||t&&i.estimate>s))return;if(this._featureLOD<=vs)return;this._featureLOD/=1+.25*(i.estimate/s-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(vs,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate()}_processCache(t){const s=this._index;if(h(s))return!1;for(;this._newLoadingNodes.length>0&&!t.done;){const i=this._newLoadingNodes.pop();for(let h=s.getParent(i);e(h)&&!this.layerView.isNodeLoaded(h.index)&&this._isNodeInScaleBounds(h);h=s.getParent(h.index))if(this._enableFromGPUCache(h,0)){t.madeProgress();break}}return t.hasProgressed}_processNodes(t,s){if(h(this._index))return!1;let i=(this._isIdle?100:2)-this._loadingNodes.size;const r=this._index.updates;for(r.cancel.forEach(this._cancelNode,this),r.cancel=[];r.remove.length>0&&!t.done;)this.layerView.removeNode(r.remove.pop()),t.madeProgress();for(;r.update.length>0&&!t.done;){const s=this._index.getNode(r.update.pop());e(s)&&(this._updateLoadedNode(s),t.madeProgress())}for(;r.add.length>0&&!t.done&&i>0;){--i;const e=this._index.getNode(r.add.back());if(h(e)||2!==e.cacheState&&!this._hasNodeLoadToken(s))break;r.add.pop(),this._loadNode(e),t.madeProgress()}return t.hasProgressed}_cancelAllNodes(){this._loadingNodes.forEach((t=>t.abort())),this._loadingNodes.clear(),this._updatingNodes.forEach((t=>t.abort())),this._updatingNodes.clear()}_cancelNode(t){const s=this._loadingNodes.get(t);s&&(s.abort(),this._loadingNodes.delete(t))}_hasNodeLoadToken(t){return!(!this._isIdle&&t.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<nt&&!this.dataStreamController.busy}_evaluateUpdating(){let t=!1,s=0;if(this.layerView.suspended)t=this._cameraDirty,s=t?0:1;else{const i=(e(this._index)?this._index.getIndexMissing():0)+3*(e(this._index)?this._index.updates.add.length:0)+2*this._loadingNodes.size;t=!!(i>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.running||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling),0===i&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(i,this._progressMaxNumNodes),s=1-i/this._progressMaxNumNodes}this.updating=t,this.updatingProgress=s}_updateViewData(){if(!this._cameraDirty||h(this._index)||h(this._viewportQueries))return;const t=this.layerView.view,{contentCamera:s,fixedContentCamera:i}=t.state;this.screenSizeFactor=1/(s.perScreenPixelRatio/2),this._viewportQueries.updateCamera(s,!i||this.isGraphics3D),this._viewportQueries.setPointOfInterest(t.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=Cs.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}_getProgressiveLoadFactor(){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor}get lod(){return this._featureLOD*this.baseLOD}get baseLOD(){const t=this.layerView.lodFactor;return this.fixedFeatureTarget?1:(t>0?t:1)*this.layerView.view.resourceController.memoryController.memoryFactor}get lodDropFactor(){if(this.fixedFeatureTarget)return 1;const t=this.layerView.view.resourceController.memoryController;return(Math.min(t.memoryFactor,.5)-t.minQuality)/(.5-t.minQuality)}isGeometryVisible(t){return e(this._index)&&this._index.isGeometryVisible(t.index)}updateVisibility(t){e(this._index)&&this._index.invalidateNodeVisibilityCache(t)}updateBoundingVolume(t){e(this._index)&&this._index.invalidateBoundingVolumeCache(t)}invalidateGeometryVisibility(t){e(this._index)&&this._index.invalidateGeometryVisibility(t)}invalidateVisibilityObbs(){e(this._index)&&this._index.invalidateVisibilityObbs()}modificationsChanged(){e(this._index)&&this._index.imModificationsChanged(!!this.layerView.hasModifications),this._invisibleDirty=!0}_shouldLoadNode(t){return!(!this._lodHandling.shouldLoadNode(t)||this._shouldDropNode(t))&&!(!e(this._index)||!this._index.isGeometryVisible(t.index))&&this._isNodeInScaleBounds(t)}_shouldDropNode(t){if(h(this._viewportQueries))return!1;const s=this.lodDropFactor;return!(s>=1||!this._lodHandling.hasNoVisibleChildren(t))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(t))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*s}_startNodeLoading(){this._restartNodeLoading=!1;const t=this._index;this._updatesDisabled||h(t)||h(this._viewportQueries)||(this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1),this._nodeLoader=new ds(this.layer,this.dataStreamController,bs,this._defaultGeometrySchema,this._requiredAttributes,{textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:!this.isMeshPyramid}),t.requestUpdate(),this._lodHandling.startNodeLoading((t=>this._isNodeInScaleBounds(t)),((t,s)=>this._removeNodes(t,s,1)),t,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating())}isNodeLoading(){return null!=this._nodeLoader&&null!=this._index}cancelNodeLoading(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}_removeInvisibleNodes(t){const s=this._index;if(h(s)||h(this._viewportQueries))return!1;ws.clear(),this.layerView.getLoadedNodeIndices(ws);const i=0===this._viewportQueries.maxDistance,e=i?()=>!1:t=>this._shouldDropNode(t);return ws.filterInPlace((t=>{const i=s.getNode(t);return h(i)||!s.isGeometryVisible(t)||e(i)||!this._isNodeInScaleBounds(i)})),ws.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(ws,t,0),!(i&&this.lodDropFactor<1||0!==ws.length&&(ws.clear(),1))}markNodeToRemove(t){ws.push(t)}removeMarkedNodes(){this._removeNodes(ws,E,0)}_removeNodes(t,s,i){const h=t.length;if(0!==h&&!s.done){for(e(this._index)&&this._index.requestUpdate();t.length>0&&!s.done;){const h=t.pop(),r=this._index;1===i&&this.layerView.nodeFadeoutEnabled&&e(r)&&r.isGeometryVisible(h)?this.layerView.fadeNode(h,1,!0):this.layerView.removeNode(h),s.madeProgress()}if(this._loadedNodeScales.size>0)for(let s=t.length;s<h;s++)this._loadedNodeScales.delete(t.data[s])}}_needsUpdate(t){if(!t.resources.hasFeatureData||this._updatingNodes.has(t.index))return!1;const s=this.layerView.getLoadedAttributes(t.index);return null!=s&&s!==this._requiredAttributes}_updateLoadedNode(t){const s=new AbortController;this._updatingNodes.set(t.index,s),(Ms(this.layerView.getLoadedAttributes(t.index),this._requiredAttributes)?Promise.resolve(this.layerView.getAttributeData(t.index)):this._nodeLoader.loadAttributes(t,this._requiredAttributes,s.signal)).then((i=>this.schedule((()=>this.layerView.updateAttributes(t.index,{loadedAttributes:this._requiredAttributes,attributeData:i},s.signal)),s.signal))).catch((e=>{if(!i(e))return this.layerView.updateAttributes(t.index,{loadedAttributes:this._requiredAttributes,attributeData:{}},s.signal)})).catch((()=>{})).then((()=>{this._updatingNodes.delete(t.index),this._evaluateUpdating()})),this._evaluateUpdating()}_loadNode(t){if(this._loadingNodes.has(t.index))return void bs.error("already loading node "+t.index);const s=new AbortController;this._loadingNodes.set(t.index,s),this._evaluateUpdating(),this._loadAndAddNode(t,s.signal).then((t=>{t&&e(this._index)&&this._index.requestUpdate()})).catch((t=>{if(!i(t))throw t})).finally((()=>{this._loadingNodes.get(t.index)===s&&this._loadingNodes.delete(t.index),this._evaluateUpdating()}))}_loadAndAddNode(t,s){return 1===t.cacheState?this._loadUncached(t,s).then((()=>!1)):this._loadCached(t,s).then((s=>!s&&(t.cacheState=1,!0))).catch((s=>!i(s)&&(t.cacheState=1,!0)))}_enableFromGPUCache(t,s){if(this._disableMemCache||h(this._index))return!1;if(0===s&&!this._index.useNodeAsHole(t.index))return!0;const i=this._loadCachedGPUData(t);return!!i&&(this.layerView.addCachedGPUData(t,i,s),this._nodeAdded(),!0)}_loadCachedGPUData(t){const s=this.layerView.loadCachedGPUData(t);return e(s)&&e(s.attributeInfo)&&Ms(s.attributeInfo.loadedAttributes,this._requiredAttributes)?s:(this.layerView.deleteCachedGPUData(s),null)}_nodeAdded(){e(this._index)&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}_loadCached(t,s){if(this._enableFromGPUCache(t,1))return Promise.resolve(!0);const i=this.layerView;return!this.disableIDBCache&&i.loadCachedNodeData&&i.addCachedNodeData?this.schedule((()=>i.loadCachedNodeData(t,s,((s,i)=>this._nodeLoader.loadTextures(t,s,i)))),s).then((e=>{if(h(e))return!1;const r=this._requiredAttributes;return this.reschedule((()=>this._nodeLoader.loadAttributes(t,r,s)),s).then((h=>this.reschedule((()=>i.addCachedNodeData(t,e,{loadedAttributes:r,attributeData:h},s)),s))).then((()=>(this._nodeAdded(),!0)))})):Promise.resolve(!1)}_loadUncached(t,s){return this._downloadingCount++,this._nodeLoader.loadNodeData(t,s).catch((t=>{throw this._downloadingCount--,t})).then((i=>(this._downloadingCount--,this.schedule((()=>this.layerView.addNode(t,i,s)),s)))).then((()=>{this._nodeAdded(),t.cacheState=2})).catch((s=>{if(!i(s))throw bs.error("#loadNodeData()",this.layer,`Failed to load node '${t.id}'`,s),t.failed=!0,e(this._index)&&this._index.requestUpdate(),s}))}_updateIdleState(t){t!==this._isIdle&&(this._isIdle=t,this._evaluateUpdating(),t&&this._index&&e(this._index)&&this._index.resetFailedNodes())}_getScale(t){if(this._loadedNodeScales.has(t.index))return this._loadedNodeScales.get(t.index);const s=this._computeScale(t);return this.layerView.isNodeLoaded(t.index)&&this._loadedNodeScales.set(t.index,s),s}_computeScale(t){return this._tmpPoint.x=t.mbs[0],this._tmpPoint.y=t.mbs[1],this._tmpPoint.z=t.mbs[2],this.layerView.view.basemapTerrain.getSphereScale(this._tmpPoint,t.mbs[3])}_isNodeInScaleBounds(t){if(!this.areScaleBoundsActive)return!0;const s=this._getScale(t),{minScale:i,maxScale:e}=St(this.layer);return Dt(s,i,e)}updateStats(t){t.index=e(this._index)?this._index.size:0,this.isGraphics3D&&(t.detail=this._featureLOD,t.target=this.featureTarget*this.baseLOD),e(this._index)&&this._index.updateStats(t)}get test(){const t=this;return{index:this._index,set disableUpdates(s){t._updatesDisabled=s,s?t.cancelNodeLoading():t.requestUpdate()},set disableIDBCache(s){t.disableIDBCache=s},set ignoreServiceObb(s){e(t._index)&&(t._index.ignoreServiceObb=s)},shouldLoadNode:s=>t._shouldLoadNode(s)}}notifyLODUpdate(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),e(this._index)&&this._index.requestUpdate()}geometryFilterChanged(t){const s=this._index;e(s)&&s.layerFilterChanged(t),this.requestUpdate()}};w([x({readOnly:!0})],ys.prototype,"isMeshPyramid",null),w([x({readOnly:!0})],ys.prototype,"isGraphics3D",null),w([x({readOnly:!0})],ys.prototype,"indexStreamController",null),w([x({readOnly:!0})],ys.prototype,"dataStreamController",null),w([x({readOnly:!0})],ys.prototype,"crsVertex",null),w([x({readOnly:!0})],ys.prototype,"crsIndex",null),w([x()],ys.prototype,"screenSizeFactor",void 0),w([x()],ys.prototype,"featureTarget",void 0),w([x()],ys.prototype,"fixedFeatureTarget",void 0),w([x()],ys.prototype,"layerView",void 0),w([x()],ys.prototype,"layer",void 0),w([x({})],ys.prototype,"updating",void 0),w([x({})],ys.prototype,"updatingProgress",void 0),w([x({readOnly:!0})],ys.prototype,"leavesReached",void 0),w([x({constructOnly:!0})],ys.prototype,"scaleVisibilityEnabled",void 0),w([x({readOnly:!0,dependsOn:[]})],ys.prototype,"rootNodeVisible",null),ys=w([M("esri.layers.graphics.controllers.I3SOnDemandController")],ys);const ws=new s({deallocator:null});let xs;function Ms(t,s){return e(t)&&t.length===s.length&&t.every((t=>Is(s,t.name)>=0))}function Is(t,s){const i=s.toLowerCase();for(let s=0;s<t.length;s++)if(t[s].name.toLowerCase()===i)return s;return-1}const Cs={factorIM:.2,factor3dObject:.05,distancePenalty:10},Ns=T(),Ds=ys;class Ss extends I{constructor(){super(...arguments),this._map=new Map}clear(){if(this._map.size>0){const t=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:t})}}get length(){return this._map.size}get(t){return this._map.get(t)}addMany(t){if(0===t.length)return;const s=new Set;for(let i=0;i<t.length;i++){const e=t[i],h=e.objectId,r=this._map.get(h);r?(s.add(h),e!==r&&(t[i]=r),++r.refCount):(e.refCount=1,this._map.set(h,e))}const i=s.size>0?t.filter((t=>!s.has(t.objectId))):t;i.length>0&&this.emit("change",{added:i,removed:[]})}removeMany(t){const s=[];for(const i of t){const t=i.objectId,e=this._map.get(t);null!=e&&--e.refCount<=0&&(this._map.delete(t),s.push(i))}s.length>0&&this.emit("change",{added:[],removed:s})}removeManyByObjectId(t){const s=[];for(const i of t){const t=this._map.get(i);null!=t&&--t.refCount<=0&&(this._map.delete(i),s.push(t))}s.length>0&&this.emit("change",{added:[],removed:s})}toArray(){return[...this._map.values()]}find(t){let s;return C(this._map,(i=>!!t(i)&&(s=i,!0))),s}forEach(t){this._map.forEach((s=>t(s)))}}async function As(t,s,i){s=s.clone(),t.capabilities.query.supportsMaxRecordCountFactor&&(s.maxRecordCountFactor=Os(t));const e=_s(t),r=t.capabilities.query.supportsPagination;s.start=0,s.num=e;let n=null;for(;;){const o=await t.source.queryFeaturesJSON(s,i);if(h(n)?n=o:n.features=n.features.concat(o.features),n.exceededTransferLimit=o.exceededTransferLimit,!r||!o.exceededTransferLimit)break;s.start+=e}return n}function _s(t){return Os(t)*function(t){return t.capabilities.query.maxRecordCount||2e3}(t)}function Os(t){return t.capabilities.query.supportsMaxRecordCountFactor?Ot.MAX_MAX_RECORD_COUNT_FACTOR:1}const Fs=g.getLogger("esri.views.3d.layers.i3s.I3SAttributeOverrides");class $s{constructor(t,s){this.layer=t,this.warnMaximumChangedObjectsExceeded=!1,this.changedObjectIds=new Set,this.pendingFetchAbortController=new AbortController,this.interactiveEditingSessions=null,this._maximumNumberOfEditOVerrides=Ls,this.memCache=s.newCache(`${t.uid}-attribute-overrides`),this.pendingFetchChangedObjectIds=this.fetchChangedObjectIds(this.pendingFetchAbortController.signal),this.pendingFetchChangedObjectIds.then((()=>this.pendingFetchAbortController=null))}destroy(){this.layer=null,this.memCache.destroy(),this.memCache=null,this.pendingFetchAbortController&&(this.pendingFetchAbortController.abort(),this.pendingFetchAbortController=null),this.pendingFetchChangedObjectIds=null}createInteractiveEditSession(t){this.changedObjectIds.add(t),h(this.interactiveEditingSessions)&&(this.interactiveEditingSessions=[]);const s=this.interactiveEditingSessions,i=new js(t,{rollback:()=>{O(s,i),0===s.length&&(this.interactiveEditingSessions=null)},commit:s=>{for(const[i,e]of s)this.updateValue(t,i,e)}});return s.unshift(i),i}async apply(t,s,i){if(h(s))return;const{loadedAttributes:e,attributeData:r}=s;if(h(e)||0===e.length||h(r))return;if(await N(this.pendingFetchChangedObjectIds,i),0===this.changedObjectIds.size)return;const n={loadedAttributes:e,attributeData:r},o=this.getOverridesFromCache(t,n,this.changedObjectIds),{objectIds:a,fieldNames:l}=o,u=await this.queryOverridesFromAssociatedLayer(a,l,i);h(u)||this.processOverridesFromAssociatedLayer(t,u,l,n)}updateValue(t,s,i){this.changedObjectIds.add(t),this.cacheValue(t,s,i)}cacheValue(t,s,i){this.memCache.put(this.getCacheKey(t,s),i,this.memCacheValueSize(i))}getOverridesFromCache(t,{loadedAttributes:s,attributeData:i},e){const h=new Set,r=new Array;for(const t of s)r[t.index]=i[t.name];const n=new Set;for(let i=0;i<t.length;i++){const o=t[i];if(e.has(o))for(const t of s){const s=this.fromCache(o,t.index);void 0===s?(h.add(o),n.add(t.name)):r[t.index][i]=s}}return{objectIds:Array.from(h),fieldNames:Array.from(n)}}fromCache(t,s){const i=this.fromInteractiveEditingSession(t,s);if(void 0!==i)return i;const e=this.getCacheKey(t,s);return this.memCache.get(e)}fromInteractiveEditingSession(t,s){if(!h(this.interactiveEditingSessions))for(const i of this.interactiveEditingSessions){if(i.objectId!==t)continue;const e=i.get(s);if(void 0!==e)return e}}getCacheKey(t,s){return`${t}-${s}`}async queryOverridesFromAssociatedLayer(t,s,i){if(0===t.length||0===s.length)return null;t=t.sort(((t,s)=>t-s)),this.warnMaximumChangedObjectsExceeded&&(this.warnMaximumChangedObjectsExceeded=!1,this.logMaximumObjectsExceededWarning());const e=r(this.layer.associatedLayer),h=e.createQuery();h.where="1=1",h.returnGeometry=!1,h.outFields=[e.objectIdField,...s],h.cacheHint=!0,h.objectIds=t;const n=_s(e),o=t.length>n?D(t,n).map((t=>{const s=h.clone();return s.objectIds=t,lt(As(e,s,{signal:i}))})):[lt(As(e,h,{signal:i}))];return(await Promise.all(o)).reduce(((t,s)=>t.concat(s.ok?s.value.features:[])),[])}logMaximumObjectsExceededWarning(){let t=`The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ${S(this._maximumNumberOfEditOVerrides)} objects. Please consider re-caching the scene service`;const s=this.layer.portalItem;t+=s&&s.loaded?` (${s.portal.url}/home/item.html?id=${s.id}#settings)`:` (${this.layer.parsedUrl.path})`,Fs.warn("#queryOverrides()",this.layer.title,`${t}.`)}processOverridesFromAssociatedLayer(t,s,i,{loadedAttributes:e,attributeData:h}){const n=r(this.layer.associatedLayer).objectIdField,o=i.map((t=>h[t])),a=new Map(e.map((t=>[t.name,t.index]))),l=i.map((t=>a.get(t))),u=new Map(Array.from(t,((t,s)=>[t,s])));for(const t of s){const s=t.attributes[n];for(let e=0;e<i.length;e++){const h=l[e],r=u.get(s),n=t.attributes[i[e]];o[e][r]=n,this.cacheValue(s,h,n)}}}memCacheValueSize(t){return"string"==typeof t?At(t):_t()}async fetchChangedObjectIds(t){var s,i,r;const n=this.layer;if(await n.load({signal:t}),this.changedObjectIds.clear(),h(n.associatedLayer)||null==(s=n.associatedLayer.capabilities)||null==(i=s.operations)||!i.supportsChangeTracking)return;const o=this.getFetchChangedObjectIdsServerGen();if(h(o))return null;const a=n.associatedLayer.layerId,l=await ot(A(`${n.associatedLayer.url}/extractChanges`,{method:"post",query:{f:"json",returnIdsOnly:!0,layers:`${a}`,returnUpdates:!0,returnDeletes:!1,returnInserts:!1,layerServerGens:JSON.stringify([{id:a,serverGen:o}])},timeout:Ts,signal:t})),u=l.ok&&null!=(r=l.value.data)&&r.edits?_(l.value.data.edits[0],"objectIds","updates"):null;if(e(u)){const t=Math.min(this._maximumNumberOfEditOVerrides,u.length);t<u.length&&(this.warnMaximumChangedObjectsExceeded=!0);const s=u.sort(((t,s)=>t-s));for(let i=0;i<t;i++)this.changedObjectIds.add(s[i])}}getFetchChangedObjectIdsServerGen(){const t=this.layer;if(e(t.serviceUpdateTimeStamp)&&e(t.serviceUpdateTimeStamp.lastUpdate))return t.serviceUpdateTimeStamp.lastUpdate;const s=t.associatedLayer;return e(s)&&e(s.serverGens)&&e(s.serverGens.minServerGen)?s.serverGens.minServerGen:null}get test(){const t=Array.from(this.changedObjectIds),s=this;return{changedObjectIds:t,pendingFetchChangedObjectIds:this.pendingFetchChangedObjectIds,get maximumNumberOfEditOVerrides(){return s._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(t){s._maximumNumberOfEditOVerrides=t}}}}class js{constructor(t,s){this.objectId=t,this.options=s,this.updates=new Map,this.state=0}get(t){return this.updates.get(t)}set(t,s){this.isActive&&this.updates.set(t,s)}rollback(){this.isActive&&(this.state=2,this.options.rollback())}commit(){this.isActive&&(this.state=1,this.options.commit(this.updates),this.updates.clear())}get isActive(){return 0===this.state}}const Ts=1e4,Ls=5e4;export{cs as C,ls as F,Ds as K,us as T,ns as a,$s as f,Ss as s}