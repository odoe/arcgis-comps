import{e,d as t,i as r,s,T as a,A as i}from"./p-e58503d5.js";import{g as o}from"./p-1ab449fc.js";import{c as n}from"./p-c76c700c.js";import{s as p}from"./p-b6fa3228.js";import{a as l}from"./p-765e6c28.js";import{t as m,d as u}from"./p-e285e8f3.js";const c=c=>{let f=class extends c{initialize(){this.exportImageParameters=new n({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var e;return null==(e=this.exportImageParameters)||e.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(e,t){const{layer:r}=this;if(!e)return Promise.reject(new s("mapimagelayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:r}));const o=this.get("view.scale"),n=[],l=async e=>{if(e.visible&&(0===e.minScale||o<=e.minScale)&&(0===e.maxScale||o>=e.maxScale))if(e.sublayers)e.sublayers.forEach(l);else if(e.popupEnabled){const r=u(e,{...t,defaultPopupTemplateEnabled:!1});i(r)&&n.unshift({sublayer:e,popupTemplate:r})}},c=r.sublayers.toArray().reverse().map(l);await Promise.all(c);const f=n.map((async({sublayer:r,popupTemplate:s})=>{await r.load().catch((()=>{}));const a=r.createQuery(),o=i(t)?t.event:null,n=p({renderer:r.renderer,event:o}),l=this.createFetchPopupFeaturesQueryGeometry(e,n);a.geometry=l,a.outFields=await m(r,s);const u=await this._loadArcadeModules(s);return u&&u.arcadeUtils.hasGeometryOperations(s)||(a.maxAllowableOffset=l.width/n),(await r.queryFeatures(a)).features}));return(await a(f)).reduce(((e,t)=>t.value?[...e,...t.value]:e),[]).filter((e=>null!=e))}canResume(){var e;return!(!super.canResume()||null!=(e=this.timeExtent)&&e.isEmpty)}_loadArcadeModules(e){if(e.get("expressionInfos.length"))return l()}};return e([t()],f.prototype,"exportImageParameters",void 0),e([t({readOnly:!0})],f.prototype,"exportImageVersion",null),e([t()],f.prototype,"layer",void 0),e([t()],f.prototype,"suspended",void 0),e([t(o)],f.prototype,"timeExtent",void 0),f=e([r("esri.views.layers.MapImageLayerView")],f),f};export{c}