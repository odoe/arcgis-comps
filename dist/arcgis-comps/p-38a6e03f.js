import{dC as t,dD as s,dE as i,dF as e,g as r,dG as h,dH as n,W as o,dI as a,s as u,al as c,dJ as l,dd as d,aH as f,a7 as p,dK as g,dL as m,dM as y,dm as x,N as w,ca as b}from"./p-c8bc3433.js";import{A,t as I}from"./p-a805321e.js";import{N as M,O as C,K as S,c as T,J as F}from"./p-47e1bd73.js";import{Q as _}from"./p-a6945989.js";import{n as D,l as z,r as v}from"./p-f9493103.js";class G extends A{constructor(t,s,i){super(t),this._featureIndex=-1,this._dateFields=new Set,this._geometryType=i,this._features=s}static fromFeatures(s,i,e){const r=t([],s,i,!1,!1,e);for(let t=0;t<r.length;t++)r[t].displayId=s[t].displayId;return G.fromOptimizedFeatures(r,i)}static fromFeatureSet(t,i){const e=s(t,i);return G.fromOptimizedFeatureSet(e)}static fromOptimizedFeatureSet(t){const{features:s,geometryType:i}=t,e=G.fromOptimizedFeatures(s,i);e._exceededTransferLimit=t.exceededTransferLimit,e._transform=t.transform;for(const s of t.fields)"esriFieldTypeDate"===s.type&&e._dateFields.add(s.name);return e}static fromOptimizedFeatures(t,s,i){const e=A.createInstance(),r=new G(e,t,s);return r._transform=i,r}get _current(){return this._features[this._featureIndex]}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}removeIds(t){const s=new Set(t);this._features=this._features.filter((t=>!s.has(t.objectId)))}append(t){for(const s of t)this._features.push(s)}getSize(){return this._features.length}getCursor(){return this.copy()}getQuantizationTransform(){return this._transform}getAttributeHash(){let t="";for(const s in this._current.attributes)t+=this._current.attributes[s];return t}getIndex(){return this._featureIndex}setIndex(t){this._featureIndex=t}getObjectId(){return this._current.objectId}getDisplayId(){return this._current.displayId}setDisplayId(t){this._current.displayId=t}getGroupId(){return this._current.groupId}setGroupId(t){this._current.groupId=t}copy(){const t=new G(this.instance,this._features,this.geometryType);return this.copyInto(t),t}next(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}readLegacyFeature(){return i(this._current,this.geometryType,this.hasZ,this.hasM)}readOptimizedFeature(){return this._current}readLegacyPointGeometry(){return this.readGeometry()?{x:this.getX(),y:this.getY()}:null}readLegacyGeometry(){const t=this.readGeometry();return e(t,this.geometryType,this.hasZ,this.hasM)}readLegacyCentroid(){const t=this.readCentroid();return r(t)?null:{x:t.coords[0]*this._sx+this._tx,y:t.coords[1]*this._sy+this._ty}}readGeometryArea(){return h(this._current)?n(this._current.geometry,2):0}readUnquantizedGeometry(){const t=this.readGeometry();if("esriGeometryPoint"===this.geometryType||!t)return t;const s=t.clone();return function({coords:t,lengths:s}){let i=0;for(const e of s){for(let s=1;s<e;s++)t[2*(i+s)]+=t[2*(i+s)-2],t[2*(i+s)+1]+=t[2*(i+s)-1];i+=e}}(s),s}readHydratedGeometry(){const t=this._current.geometry;if(r(t))return null;const s=t.clone();return o(this._transform)&&a(s,s,this.hasZ,this.hasM,this._transform),s}getXHydrated(){if(!h(this._current))return 0;const t=this._current.geometry.coords[0],s=this.getQuantizationTransform();return r(s)?t:t*s.scale[0]+s.translate[0]}getYHydrated(){if(!h(this._current))return 0;const t=this._current.geometry.coords[1],s=this.getQuantizationTransform();return r(s)?t:s.translate[1]-t*s.scale[1]}getX(){return h(this._current)?this._current.geometry.coords[0]*this._sx+this._tx:0}getY(){return h(this._current)?this._current.geometry.coords[1]*this._sy+this._ty:0}readGeometry(){if(!h(this._current))return null;const t=this._current.geometry.clone();if(t.isPoint)return t.coords[0]=t.coords[0]*this._sx+this._tx,t.coords[1]=t.coords[1]*this._sy+this._ty,t;let s=0;for(const i of t.lengths)t.coords[2*s]=t.coords[2*s]*this._sx+this._tx,t.coords[2*s+1]=t.coords[2*s+1]*this._sy+this._ty,s+=i;return t}readCentroid(){if(!h(this._current))return null;if(!this._current.centroid){const t=this._computeCentroid();if(!t)return null;t.coords[0]=(t.coords[0]-this._tx)/this._sx,t.coords[1]=(t.coords[1]-this._ty)/this._sy,this._current.centroid=t}const t=this._current.centroid.clone();return t.coords[0]=t.coords[0]*this._sx+this._tx,t.coords[1]=t.coords[1]*this._sx+this._ty,t}_readAttribute(t,s){const i=this._current.attributes[t];if(void 0!==i)return null!=i&&s&&this._dateFields.has(t)?new Date(i):i;const e=this.readAttributes(),r=t.toLocaleLowerCase().trim();for(const t in e)if(t.toLocaleLowerCase().trim()===r){const i=this._current.attributes[t];return null!=i&&s&&this._dateFields.has(t)?new Date(i):i}}copyInto(t){super.copyInto(t),t._featureIndex=this._featureIndex,t._transform=this._transform,t._dateFields=this._dateFields}_readAttributes(){return this._current.attributes}}const N=u.getLogger("esri.views.layers.2d.features.support.AttributeStore"),k=D(z,N),B=t=>(2147483648&t)>>>31,H=t=>2147483647&t;function O(t){return 1===B(t)}const j={sharedArrayBuffer:c("esri-shared-array-buffer"),atomics:c("esri-atomics")};function L(t,s){return i=>s(t(i))}class E{constructor(t,s,i,e){this.size=0,this.texelSize=4;const{pixelType:r,layout:h,textureOnly:n}=e;this.textureOnly=n||!1,this.pixelType=r,this._ctype=s,this.layout=h,this._resetRange(),this._shared=t,this.size=i,n||(this.data=this._initData(r,i,t,s))}get buffer(){return x(this.data,(t=>t.buffer))}unsetComponentAllTexels(t,s){const i=w(this.data);for(let e=0;e<this.size*this.size;e++)i[e*this.texelSize+t]&=~s;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponentAllTexels(t,s){const i=w(this.data);for(let e=0;e<this.size*this.size;e++)i[e*this.texelSize+t]|=255&s;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponent(t,s,i){const e=w(this.data);for(const r of i)e[r*this.texelSize+t]|=s,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r)}setComponentTexel(t,s,i){w(this.data)[i*this.texelSize+t]|=s,this.dirtyStart=Math.min(this.dirtyStart,i),this.dirtyEnd=Math.max(this.dirtyEnd,i)}unsetComponentTexel(t,s,i){w(this.data)[i*this.texelSize+t]&=~s,this.dirtyStart=Math.min(this.dirtyStart,i),this.dirtyEnd=Math.max(this.dirtyEnd,i)}getData(t,s){const i=H(t);return w(this.data)[i*this.texelSize+s]}setData(t,s,i){const e=H(t);0!=(this.layout&1<<s)?(this.data[e*this.texelSize+s]=i,this.dirtyStart=Math.min(this.dirtyStart,e),this.dirtyEnd=Math.max(this.dirtyEnd,e)):N.error("mapview-attributes-store","Tried to set a value for a texel's readonly component")}lock(){5121===this.pixelType&&this._shared&&j.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,1)}unlock(){5121===this.pixelType&&this._shared&&j.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,0)}expand(t){if(this.size=t,!this.textureOnly){const s=this._initData(this.pixelType,t,this._shared,this._ctype),i=w(this.data);s.set(i),this.data=s}}toMessage(){const t=this.dirtyStart,s=this.dirtyEnd,i=this.texelSize;if(t>s)return null;this._resetRange();const e=!(this._shared||"local"===this._ctype),r=this.pixelType,h=this.layout,n=w(this.data);return{start:t,end:s,data:e&&n.slice(t*i,(s+1)*i)||null,pixelType:r,layout:h}}_initData(t,s,i,e){const r=i&&"local"!==e?SharedArrayBuffer:ArrayBuffer,h=_(t),n=new h(new r(s*s*4*h.BYTES_PER_ELEMENT));for(let t=0;t<n.length;t+=4)n[t+1]=255;return n}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}}class P{constructor(t,s){this._client=t,this.config=s,this._attributeComputeMap=new Map,this._blocks=new Array,this._filters=new Array(M),this._targetType=0,this._abortController=new AbortController,this._hasScaleExpr=!1,this._size=32,this._idsToHighlight=new Set;const i=s.supportsTextureFloat?5126:5121;k(`Creating AttributeStore ${j.sharedArrayBuffer?"with":"without"} shared memory`),this._blockDescriptors=[{pixelType:5121,layout:1},{pixelType:5121,layout:15,textureOnly:!0},{pixelType:i,layout:15},{pixelType:i,layout:15}],this._blocks=this._blockDescriptors.map((()=>null))}destroy(){this._abortController.abort()}get hasScaleExpr(){return this._hasScaleExpr}get _signal(){return this._abortController.signal}update(t,s){this.config=s;const i=s.schema.processors[0].storage,e=l(this._schema,i);if((t.targets.feature||t.targets.aggregate)&&(t.storage.data=!0),e&&(c("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:",e),t.storage.data=!0,this._schema=i,this._attributeComputeMap.clear(),!r(i))){switch(i.target){case"feature":this._targetType=0;break;case"aggregate":this._targetType=1}if("subtype"===i.type)for(const t in i.mapping){const s=i.mapping[t];if(o(s))for(const t of s.mapping)this._bindAttribute(t)}else for(const t of i.mapping)this._bindAttribute(t)}}onTileData(t,s){if(r(s.addOrUpdate))return;const i=s.addOrUpdate.getCursor();for(;i.next();){const t=i.getDisplayId();this.setAttributeData(t,i)}}invalidateResources(){this._createResourcesPromise=null,this._abortController.abort(),this._abortController=new AbortController}async setHighlight(t,s){const i=this._getBlock(0),e=s.map((t=>H(t)));i.lock(),i.unsetComponentAllTexels(0,1),i.setComponent(0,1,e),i.unlock(),this._idsToHighlight.clear();for(const s of t)this._idsToHighlight.add(s);await this.sendUpdates()}async updateFilters(t,s){const{config:i,service:e,spatialReference:r}=s,{filters:h}=i,n=h.map(((t,s)=>this._updateFilter(t,s,e,r)));(await Promise.all(n)).some((t=>t))&&(t.storage.filters=!0,c("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:","Filters changed"))}setData(t,s,i,e){const r=H(t);this._ensureSizeForTexel(r),this._getBlock(s).setData(t,i,e)}getData(t,s,i){return this._getBlock(s).getData(t,i)}getHighlightFlag(t){return this._idsToHighlight.has(t)?C:0}unsetAttributeData(t){const s=H(t);this._getBlock(0).setData(s,0,0)}setAttributeData(t,s){const i=H(t);if(this._ensureSizeForTexel(i),this._getBlock(0).setData(i,0,this.getFilterFlags(s)),this._targetType!==B(t))return;const e=this._attributeComputeMap,r=this.config.supportsTextureFloat?1:2;e.size&&e.forEach(((t,e)=>{const h=e*r%4,n=Math.floor(e*r/4),o=this._getBlock(n+S),a=t(s);if(this.config.supportsTextureFloat)o.setData(i,h,a);else if(a===T)o.setData(i,h,255),o.setData(i,h+1,255);else{const t=b(Math.round(a),-32767,32766)+32768,s=(65280&t)>>8;o.setData(i,h,255&t),o.setData(i,h+1,s)}}))}sendUpdates(){if(this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=d(),this._nextUpdate.promise;const t={blocks:this._blocks.map((t=>o(t)?t.toMessage():null))};return this._currUpdate=this._createResources().then((()=>{const s=()=>{if(this._currUpdate=null,this._nextUpdate){const t=this._nextUpdate;this._nextUpdate=null,this.sendUpdates().then((()=>t.resolve()))}},i=this._client.update(t,this._signal).then(s).catch(s);return this._client.render(this._signal),i})).catch((t=>f(t)?(this._createResourcesPromise=null,this._createResources()):(N.error(new p("mapview-attribute-store","Encountered an error during client update",t)),Promise.resolve()))),this._currUpdate}_ensureSizeForTexel(t){for(;t>=this._size*this._size;)if(this._expand())return}_bindAttribute(t){let s;if(null!=t.fieldIndex)t.normalizationField&&N.warn("mapview-arcade","Ignoring normalizationField specified with an arcade expression which is not supported."),s=s=>s.getComputedNumericAtIndex(t.fieldIndex);else{if(!t.field)return;s=t.normalizationField?s=>{const i=s.readAttribute(t.normalizationField);return i?s.readAttribute(t.field)/i:null}:s=>s.readAttribute(t.field)}t.valueRepresentation&&(s=L(s,(s=>v(s,t.valueRepresentation)))),this._attributeComputeMap.set(t.binding,L(s,(t=>null===t||isNaN(t)||t===1/0?T:t)))}_createResources(){if(o(this._createResourcesPromise))return this._createResourcesPromise;this._getBlock(F),k("Initializing AttributeStore");const t={shared:j.sharedArrayBuffer&&!("local"===this._client.type),size:this._size,blocks:g(this._blocks,(t=>({textureOnly:t.textureOnly,buffer:t.buffer,pixelType:t.pixelType})))},s=this._client.initialize(t,this._signal).catch((t=>{f(t)?this._createResourcesPromise=null:N.error(new p("mapview-attribute-store","Encountered an error during client initialization",t))}));return this._createResourcesPromise=s,s.then((()=>r(this._createResourcesPromise)?this._createResources():void 0)),s}_getBlock(t){const s=this._blocks[t];if(o(s))return s;k(`Initializing AttributeBlock at index ${t}`);const i=new E(j.sharedArrayBuffer,this._client.type,this._size,this._blockDescriptors[t]);return this._blocks[t]=i,this._createResourcesPromise=null,i}_expand(){if(this._size<this.config.maxTextureSize){const t=this._size<<=1;return k("Expanding block size to",t,this._blocks),m(this._blocks,(s=>s.expand(t))),this._createResourcesPromise=null,this._size=t,0}return N.error(new p("mapview-limitations","Maximum number of onscreen features exceeded.")),-1}async _updateFilter(t,s,i,e){const h=this._filters[s],n=o(h)&&h.hash;if(!h&&!t)return!1;if(n===JSON.stringify(t))return!1;if(r(t)){if(!h)return!1;const t=1<<s+1,i=this._getBlock(0);return this._filters[s]=null,i.setComponentAllTexels(0,t),this.sendUpdates(),!0}const a=await this._getFilter(s,i);return await a.update(t,e),!0}async _getFilter(t,s){const i=this._filters[t];if(o(i))return i;const{default:e}=await import("./p-c24f30e5.js"),r=new e({geometryType:s.geometryType,hasM:!1,hasZ:!1,timeInfo:s.timeInfo,fieldsIndex:new y(s.fields)});return this._filters[t]=r,r}isVisible(t){return!!(2&this._getBlock(0).getData(t,0))}getFilterFlags(t){let s=0;const i=(t=>1===B(t)?254:255)(t.getDisplayId());for(let e=0;e<this._filters.length;e++){const h=this._filters[e];s|=(i&1<<e&&!r(h)&&!h.check(t)?0:1)<<e}let e=0;if(this._idsToHighlight.size){const s=t.getObjectId();e=this.getHighlightFlag(s)}return s<<1|e}}class R{constructor(){this._freeIds=[],this._idCounter=1}createId(t=!1){return function(t,s){return((s?2147483648:0)|t)>>>0}(this._getFreeId(),t)}releaseId(t){this._freeIds.push(t)}_getFreeId(){return this._freeIds.length?this._freeIds.pop():this._idCounter++}}function U(t,s,i){if(!(t.length>s))for(;t.length<=s;)t.push(i)}const X=2147483647;class Y{constructor(){this._numerics=[],this._strings=[],this._idGenerator=new R,this._allocatedSize=256,this._bitsets=[],this._instanceIds=[],this._bounds=[]}createBitset(){const t=this._bitsets.length;return this._bitsets.push(I.create(this._allocatedSize,X)),t+1}getBitset(t){return this._bitsets[t-1]}_expand(){this._allocatedSize<<=1;for(const t of this._bitsets)t.resize(this._allocatedSize)}_ensureNumeric(t,s){this._numerics[t]||(this._numerics[t]=[]),U(this._numerics[t],s,0)}_ensureInstanceId(t){U(this._instanceIds,t,0)}_ensureString(t,s){this._strings[t]||(this._strings[t]=[]),U(this._strings[t],s,null)}createDisplayId(t=!1){const s=this._idGenerator.createId();return s>this._allocatedSize&&this._expand(),((t,s)=>((s?2147483648:0)|t)>>>0)(s,t)}releaseDisplayId(t){for(const s of this._bitsets)s.unset(t);return this._idGenerator.releaseId(t&X)}getComputedNumeric(t,s){return this.getComputedNumericAtIndex(t&X,0)}setComputedNumeric(t,s,i){return this.setComputedNumericAtIndex(t&X,i,0)}getComputedString(t,s){return this.getComputedStringAtIndex(t&X,0)}setComputedString(t,s,i){return this.setComputedStringAtIndex(t&X,0,i)}getComputedNumericAtIndex(t,s){const i=t&X;return this._ensureNumeric(s,i),this._numerics[s][i]}setComputedNumericAtIndex(t,s,i){const e=t&X;this._ensureNumeric(s,e),this._numerics[s][e]=i}getInstanceId(t){const s=t&X;return this._ensureInstanceId(s),this._instanceIds[s]}setInstanceId(t,s){const i=t&X;this._ensureInstanceId(i),this._instanceIds[i]=s}getComputedStringAtIndex(t,s){const i=t&X;return this._ensureString(s,i),this._strings[s][i]}setComputedStringAtIndex(t,s,i){const e=t&X;this._ensureString(s,e),this._strings[s][e]=i}getXMin(t){return this._bounds[4*(t&X)]}getYMin(t){return this._bounds[4*(t&X)+1]}getXMax(t){return this._bounds[4*(t&X)+2]}getYMax(t){return this._bounds[4*(t&X)+3]}setBounds(t,s){const i=s.readHydratedGeometry();if(!i||!i.coords.length)return!1;let e=1/0,r=1/0,h=-1/0,n=-1/0;i.forEachVertex(((t,s)=>{e=Math.min(e,t),r=Math.min(r,s),h=Math.max(h,t),n=Math.max(n,s)}));const o=t&X;return U(this._bounds,4*o+4,0),this._bounds[4*o]=e,this._bounds[4*o+1]=r,this._bounds[4*o+2]=h,this._bounds[4*o+3]=n,!0}}export{O as B,P,H as R,G as d,Y as u}