import{h as e,Q as t,aZ as r}from"./p-e58503d5.js";import{u as i}from"./p-fb38a9d0.js";import{c as s,y as a,v as o}from"./p-c048b814.js";import{C as n,G as l}from"./p-dc15ecc1.js";import{k as c,s as m}from"./p-1a7268a2.js";import{m as h}from"./p-6cd1d477.js";import{n as p,e as f,r as u}from"./p-9e860e7b.js";import{m as y}from"./p-2ae44317.js";import{B as d}from"./p-8bc9b36a.js";import"./p-53bb6ab4.js";import"./p-b79fcce3.js";import"./p-e273719b.js";import"./p-74de0937.js";import"./p-2f398ed1.js";import"./p-d3105731.js";import"./p-765e6c28.js";import"./p-025c0c8e.js";import"./p-0923eebd.js";import"./p-4019eec3.js";import"./p-2d0c34e5.js";import"./p-ea916a39.js";import"./p-47e1bd73.js";import"./p-1e473dab.js";import"./p-d1d9dbe4.js";import"./p-e6fe5d89.js";import"./p-56ed1c7a.js";import"./p-b392deaf.js";import"./p-9790d1b4.js";import"./p-e654504b.js";import"./p-9f58a277.js";import"./p-b0565d49.js";import"./p-a9a30646.js";import"./p-7a658388.js";import"./p-f94762ac.js";import"./p-8a919d07.js";import"./p-efbca0ca.js";var M;!function(e){e.Legend="legend",e.Preview="preview"}(M||(M={}));const g=(e,t,r)=>{if(e&&e.targetSize){let s;if(r){const t=Math.max(r.frame.xmax-r.frame.xmin,r.frame.ymax-r.frame.ymin);s=e.targetSize/i(t)}else s=e.targetSize/t.referenceSize;return s}return e&&e.scaleFactor?e.scaleFactor:1},b={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};class C{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._pictureMarkerCache=new Map,this._textRasterizer=new c,this._cimResourceManager=new m,this._rasterizer=new h(this._cimResourceManager)}async rasterizeCIMSymbolAsync(e,t,r,i,s,a,n,l){i=i||(t?null!=t.centroid?"esriGeometryPolygon":o(t.geometry):null)||function(e){if(!(e&&e.data&&e.data.symbol))return null;switch(e.data.symbol.type){case"CIMPointSymbol":case"CIMTextSymbol":return"esriGeometryPoint";case"CIMLineSymbol":return"esriGeometryPolyline";case"CIMPolygonSymbol":return"esriGeometryPolygon";default:return null}}(e);const c=await this.analyzeCIMSymbol(e,t?function(e){return(e?Object.keys(e):[]).map((t=>({name:t,alias:t,type:"string"==typeof e[t]?"esriFieldTypeString":"esriFieldTypeDouble"})))}(t.attributes):null,r,i,l);return this.rasterizeCIMSymbol(c,t,i,s,a,n)}async analyzeCIMSymbol(t,r,i,s,a){const o=[],l=r?{geometryType:s,spatialReference:this._spatialReference,fields:r}:null;let c;await n(t.data,l,this._cimResourceManager,o,this._avoidSDF),e(a);for(const e of o)"CIMPictureMarker"!==e.cim.type&&"CIMPictureFill"!==e.cim.type&&"CIMPictureStroke"!==e.cim.type||(c||(c=[]),c.push(this.fetchPictureMarkerResource(e,a))),i&&"text"===e.type&&"string"==typeof e.text&&e.text.indexOf("[")>-1&&(e.text=p(i,e.text,e.cim.textCase));return c&&await Promise.all(c),o}async fetchPictureMarkerResource(e,r){const i=e.materialHash;if(!this._pictureMarkerCache.get(i)){const s=(await t(e.cim.url,{responseType:"image",signal:r&&r.signal})).data;this._pictureMarkerCache.set(i,s)}}rasterizeCIMSymbol(e,t,r,i,s,a){const o=[];for(const n of e){i&&"function"==typeof i.scaleFactor&&(i.scaleFactor=i.scaleFactor(t,s,a));const e=this._getRasterizedResource(n,t,r,i,s,a);if(!e)continue;let l=0,c=e.anchorX||0,m=e.anchorY||0,h=!1,p=0,u=0;if("esriGeometryPoint"===r){const e=g(i,n,null);if(p=f(n.offsetX,t,s,a)*e||0,u=f(n.offsetY,t,s,a)*e||0,"marker"===n.type)l=f(n.rotation,t,s,a)||0,h=!!n.rotateClockwise&&n.rotateClockwise;else if("text"===n.type){if(l=f(n.angle,t,s,a)||0,void 0!==n.horizontalAlignment)switch(n.horizontalAlignment){case"left":c=-.5;break;case"right":c=.5;break;default:c=0}if(void 0!==n.verticalAlignment)switch(n.verticalAlignment){case"top":m=.5;break;case"bottom":m=-.5;break;case"baseline":m=-.25;break;default:m=0}}}null!=e&&o.push({angle:l,rotateClockWise:h,anchorX:c,anchorY:m,offsetX:p,offsetY:u,rasterizedResource:e})}return this.getSymbolImage(o)}getSymbolImage(e){const t=document.createElement("canvas"),r=t.getContext("2d");let s=0,a=0,o=0,n=0;const l=[];for(let t=0;t<e.length;t++){const c=e[t],m=c.rasterizedResource;if(!m)continue;const h=m.size,p=c.offsetX,f=c.offsetY,u=c.anchorX,y=c.anchorY,d=c.rotateClockWise||!1;let M=c.angle,g=i(p)-h[0]*(.5+u),b=i(f)-h[1]*(.5+y),C=g+h[0],j=b+h[1];if(M){d&&(M=-M);const e=Math.sin(M*Math.PI/180),t=Math.cos(M*Math.PI/180),r=g*t-b*e,i=g*e+b*t,s=g*t-j*e,a=g*e+j*t,o=C*t-j*e,n=C*e+j*t,l=C*t-b*e,c=C*e+b*t;g=Math.min(r,s,o,l),b=Math.min(i,a,n,c),C=Math.max(r,s,o,l),j=Math.max(i,a,n,c)}s=g<s?g:s,a=b<a?b:a,o=C>o?C:o,n=j>n?j:n;const I=r.createImageData(m.size[0],m.size[1]);I.data.set(new Uint8ClampedArray(m.image.buffer)),l.push({offsetX:p,offsetY:f,rotateClockwise:d,angle:M,rasterizedImage:I,anchorX:u,anchorY:y})}t.width=o-s,t.height=n-a;const c=-s,m=n;for(let e=0;e<l.length;e++){const t=l[e],s=this._imageDataToCanvas(t.rasterizedImage),a=c-t.rasterizedImage.width*(.5+t.anchorX),o=m-t.rasterizedImage.height*(.5-t.anchorY);if(t.angle){const e=(360-t.angle)*Math.PI/180;r.save(),r.translate(i(t.offsetX),-i(t.offsetY)),r.translate(c,m),r.rotate(e),r.translate(-c,-m),r.drawImage(s,a,o),r.restore()}else r.drawImage(s,a+i(t.offsetX),o-i(t.offsetY))}const h=new d({x:c/t.width-.5,y:m/t.height-.5});return{imageData:0!==t.width&&0!==t.height?r.getImageData(0,0,t.width,t.height):r.createImageData(1,1),anchorPosition:h}}_imageDataToCanvas(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,r=t.getContext("2d");return t.width=e.width,t.height=e.height,r.putImageData(e,0,0),t}_imageTo32Array(e,t,r){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const i=this._imageDataCanvas,s=i.getContext("2d");return i.width=t,i.height=r,s.drawImage(e,0,0,t,r),new Uint32Array(s.getImageData(0,0,t,r).data.buffer)}_getRasterizedResource(e,t,i,s,a,o){let n,l,c,m,h=null,p=null;if("esriGeometryPolyline"===i||"esriGeometryPolygon"===i){const m=s&&s.style?s.style:M.Legend,u="esriGeometryPolyline"===i?b.stroke[m]:b.fill[m];if("line"===e.type){if("CIMSolidStroke"!==e.cim.type){if("CIMPictureStroke"===e.cim.type){const r=f(e.width,t,a,o),{image:i,width:s,height:n}=this._getPictureResource(e,r);return this._rasterizePictureResource(e,i,s,n,u,r)}return null}({analyzedCIM:n,hash:c}=j(e,t,a,o)),l=this._embedCIMLayerInVectorMarker(n,u)}else if("marker"===e.type){if("CIMPictureMarker"===e.cim.type)return null;if("CIMVectorMarker"!==e.cim.type)return null;e.cim.offsetX=f(e.offsetX,t,a,o),e.cim.offsetY=f(e.offsetY,t,a,o),e.cim.rotation=f(e.rotation,t,a,o),e.cim.markerPlacement=e.markerPlacement,({analyzedCIM:n}=j(e,t,a,o)),c=r(JSON.stringify(n)).toString(),l=this._embedCIMLayerInVectorMarker(n,u),h=f(e.size,t,a,o),p=e.path}else{if("text"===e.type)return null;if("fill"===e.type){if("CIMHatchFill"===e.cim.type||"CIMVectorMarker"===e.cim.type||"CIMPictureMarker"===e.cim.type||"CIMPictureFill"===e.cim.type){const r=e.cim.size||e.cim.height;let i,s,l;if("CIMPictureMarker"===e.cim.type||"CIMPictureFill"===e.cim.type)({image:i,width:s,height:l}=this._getPictureResource(e,r));else{({analyzedCIM:n,hash:c}=j(e,t,a,o));const m=this._rasterizer.rasterizeJSONResource({cim:n,type:e.type,url:e.url,mosaicHash:c,size:r,path:p},1,this._avoidSDF);i=m.image,s=m.size[0],l=m.size[1]}return this._rasterizePictureResource(e,i,s,l,u,null)}if("CIMSolidFill"!==e.cim.type)return null;({analyzedCIM:n,hash:c}=j(e,t,a,o)),l=this._embedCIMLayerInVectorMarker(n,u)}}}else{if("text"===e.type)return m=this._rasterizeTextResource(e,t,s,a,o),m;({analyzedCIM:n,hash:c}=j(e,t,a,o));const r=g(s,e,null);if("CIMPictureMarker"===e.cim.type){const i=f(e.size,t,a,o)*r,{image:s,width:n,height:l}=this._getPictureResource(e,i);return m={image:s,size:[n,l],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},m}y(n,r,{preserveOutlineWidth:!1}),l=n}c+=i,s&&(c+=JSON.stringify(s));const u=this._resourceCache;return u.has(c)?u.get(c):(m=this._rasterizer.rasterizeJSONResource({cim:l,type:e.type,url:e.url,mosaicHash:c,size:h,path:p},window.devicePixelRatio||1,this._avoidSDF),u.set(c,m),m)}_rasterizeTextResource(e,t,r,i,s){const a=g(r,e,null),o=f(e.text,t,i,s);if(!o||0===o.length)return null;const n=f(e.fontName,t,i,s),l=f(e.style,t,i,s),c=f(e.weight,t,i,s),m=f(e.decoration,t,i,s),h=f(e.size,t,i,s)*a,p=f(e.horizontalAlignment,t,i,s),y=f(e.verticalAlignment,t,i,s),d=u(f(e.color,t,i,s)),M=u(f(e.outlineColor,t,i,s)),b={color:d,size:h,horizontalAlignment:p,verticalAlignment:y,font:{family:n,style:l,weight:c,decoration:m},halo:{size:f(e.outlineSize,t,i,s)||0,color:M,style:l},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,b)}_rasterizePictureResource(e,t,r,o,n,l){const c=document.createElement("canvas"),m=c.getContext("2d");c.height=i(Math.max(n.frame.ymax-n.frame.ymin,l)),c.width=i(n.frame.xmax-n.frame.xmin);const h=m.createImageData(r,o);h.data.set(new Uint8ClampedArray(t.buffer));const p=this._imageDataToCanvas(h),f=m.createPattern(p,"repeat"),u=Math.cos((-e.cim.rotation||0)*Math.PI/180),y=Math.sin((-e.cim.rotation||0)*Math.PI/180);f.setTransform({m11:u,m12:y,m21:-y,m22:u,m41:i(e.cim.offsetX)||0,m42:i(e.cim.offsetY)||0});const d=n.canvasPaths;let M,g,b;s(d)?(M=d.rings,m.fillStyle=f,g=m.fill,b=["evenodd"]):a(d)&&(M=d.paths,m.strokeStyle=f,m.lineWidth=l,g=m.stroke,M[0][0][1]=c.height/2,M[0][1][1]=c.height/2),m.beginPath();for(const e of M){const t=e?e.length:0;if(t>1){let r=e[0];m.moveTo(i(r[0]),i(r[1]));for(let s=1;s<t;++s)r=e[s],m.lineTo(i(r[0]),i(r[1]));m.closePath()}}g.apply(m,b);const C=m.getImageData(0,0,c.width,c.height),j=new Uint8Array(C.data);return{size:[c.width,c.height],image:new Uint32Array(j.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}_getPictureResource(e,t){const r=this._pictureMarkerCache.get(e.materialHash);if(!r)return null;const s=r.height/r.width,a=t?s>1?i(t):i(t)/s:r.width,o=t?s>1?i(t)*s:i(t):r.height;return{image:this._imageTo32Array(r,a,o),width:a,height:o}}_embedCIMLayerInVectorMarker(e,t){const r=s(t.geometry)?"CIMPolygonSymbol":"CIMLineSymbol",i=t.frame;return{type:"CIMVectorMarker",frame:i,size:i.ymax-i.ymin,markerGraphics:[{type:"CIMMarkerGraphic",geometry:t.geometry,symbol:{type:r,symbolLayers:[e]}}]}}}function j(e,t,r,i){let s,a;return"function"==typeof e.materialHash?(s=(0,e.materialHash)(t,r,i),a=l(e.cim,e.materialOverrides)):(s=e.materialHash,a=e.cim),{analyzedCIM:a,hash:s}}export{C as CIMSymbolRasterizer,M as GeometryStyle}