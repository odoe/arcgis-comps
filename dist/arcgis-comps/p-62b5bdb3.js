import{e as t,d as i,i as s,p as e,_ as n,af as r,c as h,u as a,A as l,$ as u,b as o,dM as c,a as d,aJ as p,ar as y}from"./p-e58503d5.js";import{h as f}from"./p-54330161.js";import{m}from"./p-889f7a78.js";import{b as g}from"./p-5e833dfc.js";import{aX as v,aY as b}from"./p-340cd100.js";import{y as w,I as x}from"./p-e31c89bd.js";import{d as O,s as E}from"./p-7392987e.js";import{y as V}from"./p-6a92ecb9.js";import{a as j}from"./p-b79fcce3.js";import{V as R}from"./p-bfea9714.js";import S from"./p-dc852195.js";import{o as C}from"./p-03d6250d.js";import{f as F}from"./p-ca295674.js";import{c as I}from"./p-0b395493.js";import{n as Q}from"./p-8fa44ebc.js";import{l as A}from"./p-7731c620.js";const M=R;let T=class extends e{constructor(t){super(t),this._dataQueryEngineInstance=null}get queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}get defaultQueryJSON(){return new g({outSpatialReference:this.spatialReference}).toJSON()}get dataQueryEngine(){return this.ensureDataQueryEngine()}destroy(){this.clear()}clear(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}async executeQueryForIdSet(t,i){return this.dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(t),i)}async executeQueryForCount(t,i){return this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(t),i)}async executeQueryForExtent(t,i){const{count:s,extent:e}=await this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(t),i);return{count:s,extent:n.fromJSON(e)}}async executeQueryForIds(t,i){return this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(t),i)}async executeQueryForLatestObservations(t,i){const s=await this.dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(t),i),e=S.fromJSON(s);return e.features.forEach((t=>{t.layer=this.layer,t.sourceLayer=this.layer})),e}async executeQuery(t,i){const s=await this.dataQueryEngine.executeQuery(this._ensureQueryJSON(t),i),e=S.fromJSON(s);return e.features.forEach((t=>{t.layer=this.layer,t.sourceLayer=this.layer})),e}_ensureQueryJSON(t){return r(t)?this.defaultQueryJSON:("outSpatialReference"in t&&!t.outSpatialReference&&(t.outSpatialReference=this.spatialReference),t.toJSON())}ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const t="timeInfo"in this.layer&&this.layer.timeInfo&&this.layer.timeInfo.toJSON()||null,i=this.layer.objectIdField,s=j.toJSON(this.queryGeometryType),e=this.layer.fields.map((t=>t.toJSON())),n=this.layerView.view.resourceController.scheduler,r=this.priority,h=this.spatialReference.toJSON(),a=this.layerView.graphics3d.graphicsCore.featureStore,{hasZ:l,hasM:u}=this.layerView;return this._dataQueryEngineInstance=new M({hasZ:l,hasM:u,geometryType:s,fields:e,timeInfo:t,spatialReference:h,objectIdField:i,featureStore:a,scheduler:n,priority:r}),this._dataQueryEngineInstance}};t([i({constructOnly:!0})],T.prototype,"layerView",void 0),t([i({constructOnly:!0})],T.prototype,"priority",void 0),t([i({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],T.prototype,"spatialReference",void 0),t([i({readOnly:!0,aliasOf:"layerView.layer"})],T.prototype,"layer",void 0),t([i({readOnly:!0})],T.prototype,"queryGeometryType",null),t([i({readOnly:!0})],T.prototype,"defaultQueryJSON",null),T=t([s("esri.views.3d.layers.graphics.QueryEngine")],T);const _=T,k=h.getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility");let G=class extends e{constructor(...t){super(...t),this._dirty=!1,this._querying=!1,this._handles=new a}get updating(){return this._dirty||this._querying||l(this._queryResult)}setup(t,i){this._layerView=t,this._core=i,this._objectIdField=t.layer.objectIdField,this._queryEngine=new _({layerView:this._layerView,priority:F.FILTER_VISIBILITY}),this._handles.add(this._layerView.view.resourceController.scheduler.registerTask(F.FILTER_VISIBILITY,this)),this._handles.add(u(i.owner,"loadedGraphics","after-changes",(t=>this._graphicsChanged(t)),(()=>this.dirty=!0))),this.filterChanged()}destroy(){this._handles.destroy(),this._handles=null,this.clear(),this._layerView=null,this._core=null}clear(){this._queryEngine.clear()&&(this._core.modifyGraphics3DGraphicVisibilities((t=>t.clearVisibilityFlag(2))),this._queryResult=null,this._querying=!1),this.dirty=!1}_graphicsChanged(t){this._queryEngine&&0==(1&t.type)||(this.dirty=!0)}updateVisibility(t){this.active&&(t.hasVisibilityFlag(2,0)||t.setVisibilityFlag(2,!1,0),this.dirty=!0)}filterChanged(){const t=this.recomputeFilter();t!==this._filter&&(this._filter=t,this.dirty=!0)}get active(){return this._filter&&this._core.graphics3DGraphics.size>0}recomputeFilter(){const t="filter"in this._layerView?this._layerView.filter:null,i="timeExtent"in this._layerView?this._layerView.timeExtent:null,s=C(this._layerView);if(r(i)&&r(s))return t;const e=l(t)?t.clone():new V;return l(i)&&(e.timeExtent=l(e.timeExtent)?e.timeExtent.intersection(i):i),l(s)&&(e.where=null==e.where||""===e.where?s:`(${e.where}) AND (${s})`),e}get running(){return this._dirty&&!this._querying||l(this._queryResult)}runTask(t){if(!this.active)return void this.clear();!this._dirty||this._querying||t.done||(this._querying=!0,this.dirty=!1,this._queryEngine.executeQueryForIdSet(this._filter).then((t=>{this._queryResult=t,this._querying=!1})).catch((t=>{if(!o(t)){k.warn("FeatureFilter query failed: "+t,{error:t});const i=new Set;this._core.graphics3DGraphics.forEach((t=>i.add(this._getFeatureId(t.graphic)))),this._queryResult=i,this._querying=!1}})),t.madeProgress());const i=this._queryResult;l(i)&&!t.done&&(this._core.modifyGraphics3DGraphicVisibilities((s=>{if(t.done)return!1;const e=i.has(this._getFeatureId(s.graphic));return!!s.setVisibilityFlag(2,e,0)&&(t.madeProgress(),!0)})),t.done||(this._queryResult=null))}_getFeatureId(t){return null==t.objectId?t.attributes[this._objectIdField]:t.objectId}set dirty(t){this._dirty=t}};t([i({readOnly:!0})],G.prototype,"updating",null),t([i({readOnly:!0})],G.prototype,"running",null),t([i()],G.prototype,"_dirty",void 0),t([i()],G.prototype,"_querying",void 0),t([i()],G.prototype,"_queryResult",void 0),G=t([s("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],G);let q=class extends e{constructor(t){super(t),this._handles=new a,this.watchUpdatingTracking=new A,this.suspendResumeExtentMode="computed",this.dataExtent=null,this.suspendResumeExtent=null}get suspended(){var t;return null==(t=this.scaleVisibility)?void 0:t.suspended}get suspendInfo(){var t,i;const s={};return null!=(t=this.scaleVisibility)&&t.suspended&&(s.outsideScaleRange=!0),null!=(i=this.frustumVisibility)&&i.suspended&&(s.outsideOfView=!0),s}get updating(){var t,i,s;return!!(null!=(t=this.graphicsCore)&&t.updating||null!=(i=this.frustumVisibility)&&i.updating||null!=(s=this.watchUpdatingTracking)&&s.updating)}normalizeCtorArgs(t){const i=t.frustumVisibilityEnabled?new I:null,s=t.scaleVisibilityEnabled?new w:null,e=(t.filterVisibilityEnabled||t.timeExtentVisibilityEnabled)&&"multipatch"!==t.layer.geometryType?new G:null,n=t.elevationAlignmentEnabled?new O:null,r=new x({owner:t.owner,layer:t.layer,preferredUpdatePolicy:t.preferredUpdatePolicy,elevationFeatureExpressionEnabled:t.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:t.owner.hasZ,hasM:t.owner.hasM}),{updateClippingExtent:h,suspendResumeExtentMode:a,dataExtent:l}=t;return{graphicsCore:r,frustumVisibility:i,scaleVisibility:s,filterVisibility:e,elevationAlignment:n,updateClippingExtent:h,suspendResumeExtentMode:a,dataExtent:l}}initialize(){this.scaleVisibility&&this.watchUpdatingTracking.add(this.layer,"scaleRangeId",(()=>this.scaleVisibility.layerMinMaxScaleChangeHandler())),this.filterVisibility&&(this.watchUpdatingTracking.add(this.owner,"filter",(()=>this.filterVisibility.filterChanged())),this.watchUpdatingTracking.add(this.owner,"timeExtent",(()=>this.filterVisibility.filterChanged()))),this.elevationAlignment&&this.watchUpdatingTracking.add(this.layer,"elevationInfo",((t,i)=>{m(t,i)&&this.watchUpdatingTracking.addPromise(this.graphicsCore.elevationInfoChange())})),this.watchUpdatingTracking.add(this.layer,"labelsVisible",(()=>this.graphicsCore.updateVisibilityInfo())),this.watchUpdatingTracking.add(this.layer,"labelingInfo",((t,i)=>{m(t,i)&&this.graphicsCore.updateLabelingInfo()}))}async setup(){this.frustumVisibility&&this.frustumVisibility.setup(this.owner);const t=this.owner,i=(t,i,s)=>this.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(t,i,s);this.scaleVisibility&&this.scaleVisibility.setup(t,this.layer,i,this.graphicsCore,this.owner.view.basemapTerrain),this.filterVisibility&&("filter"in t||"timeExtent"in t)&&this.filterVisibility.setup(t,this.graphicsCore),this.elevationAlignment&&this.elevationAlignment.setup(t,i,this.graphicsCore,t.view.elevationProvider),this._set("objectStates",new E(this.graphicsCore)),this._set("labeling",this.owner.view.labeler.addGraphicsOwner(this.graphicsCore,this.scaleVisibility)),this._set("deconfliction",t.view.deconflictor.addGraphicsOwner(this.graphicsCore)),await c(this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,filterVisibility:this.filterVisibility,deconflictor:this.deconfliction,labeler:this.labeling,objectStates:this.objectStates})),this.watchUpdatingTracking.add(this.layer,"renderer",(t=>this.watchUpdatingTracking.addPromise(this.graphicsCore.rendererChange(t)))),this.watchUpdatingTracking.add(t,"fullOpacity",(()=>this.graphicsCore.opacityChange())),this.setupSuspendResumeExtent(),this.updateClippingExtent&&(this.watchUpdatingTracking.add(t.view,"clippingArea",(()=>this._updateClippingExtent())),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&await c(this.graphicsCore.updateLabelingInfo())}destroy(){this._handles&&(this._handles.destroy(),this._handles=null);const t=["watchUpdatingTracking","frustumVisibility","scaleVisibility","filterVisibility","elevationAlignment","objectStates","graphicsCore"];for(const i of t){const t=this[i];t&&(t.destroy(),this._set(i,null))}this._set("layer",null),this._set("owner",null)}maskOccludee(t){const{set:i,handle:s}=this.objectStates.acquireSet(1,null);return this.objectStates.setUid(i,t.uid),s}highlight(t,i){if(t instanceof g){const{set:s,handle:e}=this.objectStates.acquireSet(0,i);return this.owner.queryObjectIds(t).then((t=>this.objectStates.setObjectIds(s,t))),e}if("number"==typeof t||"string"==typeof t)return this.highlight([t],i);if(t instanceof f)return this.highlight([t],i);if("toArray"in t&&(t=t.toArray()),Array.isArray(t)&&t.length>0){if(t[0]instanceof f){const s=t;if(null==Q(this.layer.fieldsIndex,s[0].attributes,i)){const t=s.map((t=>t.uid)),{set:i,handle:e}=this.objectStates.acquireSet(0,null);return this.objectStates.setUids(i,t),e}t=s.map((t=>Q(this.layer.fieldsIndex,t.attributes,i)))}if("number"==typeof t[0]||"string"==typeof t[0]){const s=t,{set:e,handle:n}=this.objectStates.acquireSet(0,i);return this.objectStates.setObjectIds(e,s),n}}return N}_updateClippingExtent(){const t=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(t,this.owner.view.spatialReference)&&(this.updateClippingExtent(t)||this.graphicsCore.recreateAllGraphics())}setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this._handles.add(d(this,"suspendResumeExtentMode",(()=>{switch(this._handles.remove(J),this.suspendResumeExtentMode){case"computed":this._handles.add([d(this.graphicsCore,"computedExtent",(t=>this.updateSuspendResumeExtent(t))),this.graphicsCore.watch("extentPadding",(()=>this.updateSuspendResumeExtent(this.graphicsCore.computedExtent)))],J);break;case"data":this._handles.add([d(this,"dataExtent",(t=>this.updateSuspendResumeExtent(t))),this.graphicsCore.watch("extentPadding",(()=>this.updateSuspendResumeExtent(this.dataExtent)))],J)}})))}updateSuspendResumeExtent(t){this.suspendResumeExtentChanged(t?this.extentToSuspendResumeRect(t,this.suspendResumeExtent):null)}extentToSuspendResumeRect(t,i){const s=this.owner.view.spatialReference;if(!t.spatialReference.equals(s)){if(!p(t,s))return;t=y(t,s)}return v(t,i,b,this.graphicsCore.extentPadding)}suspendResumeExtentChanged(t){this.frustumVisibility&&this.frustumVisibility.setExtent(t),this.scaleVisibility&&this.scaleVisibility.setExtent(t)}};t([i({aliasOf:"graphicsCore.layer"})],q.prototype,"layer",void 0),t([i({aliasOf:"graphicsCore.owner"})],q.prototype,"owner",void 0),t([i({constructOnly:!0})],q.prototype,"updateClippingExtent",void 0),t([i({constructOnly:!0})],q.prototype,"graphicsCore",void 0),t([i({constructOnly:!0})],q.prototype,"scaleVisibility",void 0),t([i({constructOnly:!0})],q.prototype,"filterVisibility",void 0),t([i({constructOnly:!0})],q.prototype,"elevationAlignment",void 0),t([i({constructOnly:!0})],q.prototype,"frustumVisibility",void 0),t([i({readOnly:!0})],q.prototype,"deconfliction",void 0),t([i({readOnly:!0})],q.prototype,"labeling",void 0),t([i({readOnly:!0})],q.prototype,"objectStates",void 0),t([i({readOnly:!0})],q.prototype,"watchUpdatingTracking",void 0),t([i()],q.prototype,"suspendResumeExtentMode",void 0),t([i()],q.prototype,"dataExtent",void 0),t([i({readOnly:!0})],q.prototype,"suspended",null),t([i({readOnly:!0})],q.prototype,"suspendInfo",null),t([i({readOnly:!0,dependsOn:["graphicsCore.updating","frustumVisibility.updating","watchUpdatingTracking.updating"]})],q.prototype,"updating",null),q=t([s("esri.views.3d.layers.graphics.Graphics3DFeatureLikeLayerView")],q);const D=q,J="suspendResumeExtentMode",N={remove(){},pause(){},resume(){}};export{_ as p,D as v}