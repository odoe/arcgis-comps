import"./p-b79fcce3.js";import{_ as t,af as n,A as e,aE as o,s as r}from"./p-e58503d5.js";import{H as i}from"./p-01e5a461.js";import{H as l,J as a,O as s,t as c,Y as u}from"./p-c93d2280.js";const f=5e-4;function h(t,n,e){return!c(t,n,e)}function m(t,n,e){const o=h(t,n,e);if(o&&!l())throw new r("rasterprojectionhelper-project","projection engine is not loaded");return o}const M=function(t,n,e){const o=(t[0]+t[4]+t[4*n.cols]+t[4*n.cols+4])/4,r=(t[1]+t[5]+t[4*n.rows+1]+t[4*n.rows+5])/4,i=(t[4*n.cols]-t[0]+t[4*n.cols+4]-t[4])/e[0]*.5,l=(t[4*n.cols+1]-t[1]+t[4*n.cols+5]-t[5])/e[1]*.5;return[0===i||isNaN(i)?0:Math.abs(o-t[2*n.rows+2])/Math.abs(i),0===l||isNaN(l)?0:Math.abs(r-t[2*n.rows+3])/Math.abs(l)]},x={3395:20037508.342789244,3410:17334193.943686873,3832:3339584.723798206,3857:20037508.342788905,3975:17367530.445161372,4087:20037508.342789244,4088:20015108.787169147,6933:17367530.445161372,8858:7396237.374497803,8859:2465412.4581659334,32662:20037508.342789244,53001:20015086.79602057,53002:10007543.39801029,53003:20015086.79602057,53004:20015086.79602057,53016:14152803.599503474,53017:17333573.624304302,53025:7276828.3848298555,53031:10384677.558821043,53034:20015086.79602057,53036:7389443.187332862,53037:2463147.729110953,53079:20015114.352186374,53080:20015114.352186374,54001:20037508.342789244,54002:10018754.171394624,54003:20037508.342789244,54004:20037508.342789244,54016:14168658.027268292,54017:17367530.44516137,54025:7311399.09166516,54031:10396310.810074743,54034:20037508.342789244,54053:1920897.3915568967,54079:20037508.342789244,54080:20037508.342789244,54100:20037508.342789244,54101:20037508.342789244,102038:4297258.582585486,102299:5013965.117483125};async function p(){if(l())return null;await a()}function d(t,n,e){return m(t.spatialReference,n)?e?u(n,t.spatialReference,t):u(t.spatialReference,n,t):null}function y(e,o,r,i=null){if(e.spatialReference.equals(o))return e;m(e.spatialReference,o,i);const l=r.center,a=new t({xmin:l.x-e.x/2,xmax:l.x+e.x/2,ymin:l.y-e.y/2,ymax:l.y+e.y/2,spatialReference:e.spatialReference}),c=s(a,o,i);return n(c)?null:{x:c.xmax-c.xmin,y:c.ymax-c.ymin}}function w(t,n=.01){return i(t)?n/i(t):0}function g(t,n,e=null,o=!0){const r=t.spatialReference;if(r.equals(n))return t;m(r,n,e);const i=s(t,n,e);if(o&&n.isGeographic){const[n,e]=j(r,!0),o=w(r);o&&null!=n&&null!=e&&(Math.abs(t.x-n)<o&&Math.abs(180-i.x)<f?i.x-=360:Math.abs(t.x-e)<o&&Math.abs(180+i.x)<f&&(i.x+=360))}return i}function R(n){const o=S(n[0].spatialReference);if(n.length<2||!e(o))return n[0];let{xmin:r,xmax:i,ymin:l,ymax:a}=n[0];for(let t=1;t<n.length;t++){const e=n[t];i=e.xmax+o*t,l=Math.min(l,e.ymin),a=Math.max(a,e.ymax)}return new t({xmin:r,xmax:i,ymin:l,ymax:a,spatialReference:n[0].spatialReference})}function N(t,n,o=null,r=!0){if(t.spatialReference.equals(n))return t;const i=z(t),l=S(t.spatialReference,!0);return e(l)&&0!==i?R(t.clone().normalize().map((t=>v(t,n,o,r)))):v(t,n,o,r)}function v(t,n,e=null,r=!0){const i=t.spatialReference;if(i.equals(n))return t;m(i,n,e);const l=s(t,n,e);let[a,c]=j(i,!0);if(l&&r&&i.isWebMercator&&n.isGeographic&&null!=a&&null!=c){const r=.001,s=1e3;if(Math.abs(t.xmin-a)<r&&Math.abs(c-t.xmax)>s&&Math.abs(180-l.xmax)<f){l.xmin=-180;const r=[];r.push(new o(t.xmax,t.ymin,i)),r.push(new o(t.xmax,(t.ymin+t.ymax)/2,i)),r.push(new o(t.xmax,t.ymax,i));const a=r.map((t=>g(t,n,e))).filter((t=>!isNaN(null==t?void 0:t.x))).map((t=>t.x));l.xmax=Math.max.apply(null,a)}if(Math.abs(t.xmax-c)<r&&Math.abs(a-t.xmin)>s&&Math.abs(180+l.xmin)<f){l.xmax=180;const r=[];r.push(new o(t.xmin,t.ymin,i)),r.push(new o(t.xmin,(t.ymin+t.ymax)/2,i)),r.push(new o(t.xmin,t.ymax,i));const a=r.map((t=>g(t,n,e))).filter((t=>!isNaN(null==t?void 0:t.x))).map((t=>t.x));l.xmin=Math.min.apply(null,a)}}[a,c]=j(n,!0);const u=w(n);return u&&null!=a&&null!=c&&l&&(Math.abs(l.xmin-a)<u&&(l.xmin=a),Math.abs(l.xmax-c)<u&&(l.xmax=c)),l}function S(t,n=!1){return t.isWebMercator?2*(n?20037508.342787:20037508.342788905):t.wkid&&t.isGeographic?360:2*x[t.wkid]||null}function j(t,n=!1){const o=[],r=S(t,n);return e(r)&&(o.push(-r/2),o.push(r/2)),o}function C(t,n,e,o){let r=(t-n)/e;return r-Math.floor(r)!=0?r=Math.floor(r):o&&(r-=1),r}function z(t,n=!1){const o=S(t.spatialReference);if(!e(o))return 0;const r=n?0:-o/2;return C(t.xmax,r,o,!0)-C(t.xmin,r,o,!1)}function P(t){const n=t.storageInfo.origin.x,o=S(t.spatialReference,!0);if(!e(o))return{originX:n,halfWorldWidth:null,pyramidsInfo:null};const r=o/2,{nativePixelSize:i,storageInfo:l,extent:a}=t,{maximumPyramidLevel:s,blockWidth:c,pyramidScalingFactor:u}=l;let f=i.x;const h=[],m=e(t.transform)&&"gcs-shift"===t.transform.type,M=n+r,x=m?o-n:r-n;for(let t=0;t<=s;t++){const t=(a.xmax-n)/f/c,e=t-Math.floor(t)==0?t:Math.ceil(t),r=(o/2-n)/f/c,i=r-Math.floor(r)==0?r:Math.ceil(r),l=Math.floor(M/f/c),s=Math.round(M/f)%c,m=(c-Math.round(x/f)%c)%c;h.push({resolutionX:f,blockWidth:c,datsetColumnCount:e,worldColumnCountFromOrigin:i,leftMargin:s,rightPadding:m,originColumnOffset:l}),f*=u}return{originX:n,halfWorldWidth:r,pyramidsInfo:h,hasGCSSShiftTransform:m}}function W(t){const n=t.isAdaptive&&null==t.spacing,e=t.spacing||[32,32];let o=F(t),r={cols:o.size[0]+1,rows:o.size[1]+1},i=M(o.offsets,r,e);const l=o.outofBoundPointCount>0&&o.outofBoundPointCount<o.offsets.length/2;return n&&(l||(i[0]+i[1])/2>4)&&(o=F({...t,spacing:[4,4]}),r={cols:o.size[0]+1,rows:o.size[1]+1},i=M(o.offsets,r,e)),o.error=i,o.coefficients=function(t,n,e){const{cols:o,rows:r}=n,i=new Float32Array((o-1)*(r-1)*2*6),l=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),a=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(let n=0;n<o-1;n++){for(let e=0;e<r-1;e++){let s=n*r*2+2*e;const c=t[s],u=t[s+1],f=t[s+2],h=t[s+3];s+=2*r;const m=t[s],M=t[s+1],x=t[s+2],p=t[s+3];let d=0,y=12*(e*(o-1)+n);for(let t=0;t<3;t++)i[y++]=l[d++]*c+l[d++]*f+l[d++]*x;d=0;for(let t=0;t<3;t++)i[y++]=l[d++]*u+l[d++]*h+l[d++]*p;d=0;for(let t=0;t<3;t++)i[y++]=a[d++]*c+a[d++]*m+a[d++]*x;d=0;for(let t=0;t<3;t++)i[y++]=a[d++]*u+a[d++]*M+a[d++]*p}if(e)for(let t=0;t<i.length;t++)isNaN(i[t])&&(i[t]=-1)}return i}(o.offsets,r,l),o}function F(t){const{projectedExtent:n,srcBufferExtent:r,pixelSize:i,datumTransformation:l,rasterTransform:a}=t,c=n.spatialReference,u=r.spatialReference;m(c,u);const{xmin:f,ymin:h,xmax:M,ymax:x}=n,p=S(u),d=t.hasWrapAround||"gcs-shift"===(null==a?void 0:a.type),y=t.spacing||[32,32],w={x:y[0]*i.x,y:y[1]*i.y},g=Math.ceil((M-f)/w.x-.1/y[0])+1,R=Math.ceil((x-h)/w.y-.1/y[1])+1,N=w.x,v=w.y,j=[];let C,z=0;const P=[];for(let t=0;t<g;t++)for(let n=0;n<R;n++)P.push(new o({x:f+N*t,y:x-v*n,spatialReference:c}));const W=function(t,n,e=null){const o=t[0].spatialReference;return o.equals(n)?t:(m(o,n,e),s(t,n,e))}(P,u,l);for(let t=0;t<g;t++){const n=[];for(let o=0;o<R;o++){let i=W[t*R+o];a&&(i=a.inverseTransform(i)),n.push(i),t>0&&d&&i&&C[o]&&e(p)&&i.x<C[o].x&&(i.x+=p),i?(j.push((i.x-r.xmin)/(r.xmax-r.xmin)),j.push((r.ymax-i.y)/(r.ymax-r.ymin))):(j.push(NaN),j.push(NaN),z++)}C=n}return{offsets:j,error:null,coefficients:null,outofBoundPointCount:z,spacing:y,size:[g-1,R-1]}}function T(t){const n=t.clone().normalize();return 1===n.length?n[0]:R(n)}function b(t,n,r){const{storageInfo:i,pixelSize:l}=n;let a,s=!1;const{pyramidResolutions:c}=i;if(e(c)&&c.length){const e=(t.x+t.y)/2,i=c[c.length-1],u=(i.x+i.y)/2,f=(l.x+l.y)/2;if(e<=f)a=0;else if(e>=u)a=c.length,s=e/u>8;else{let t,n=f;for(let o=1;o<=c.length;o++){if(t=(c[o-1].x+c[o-1].y)/2,e<=t){e===t?a=o:"down"===r?(a=o-1,s=e/n>8):a="up"===r||e-n>t-e||e/n>2?o:o-1;break}n=t}}const h=0===a?l:c[a-1];return{pyramidLevel:a,pyramidResolution:new o({x:h.x,y:h.y,spatialReference:n.spatialReference}),excessiveReading:s}}const u=Math.log(t.x/l.x)/Math.LN2,f=Math.log(t.y/l.y)/Math.LN2,h=n.storageInfo.maximumPyramidLevel||0;a="down"===r?Math.floor(Math.min(u,f)):"up"===r?Math.ceil(Math.max(u,f)):Math.round((u+f)/2),a<0?a=0:a>h&&(s=a>h+3,a=h);const m=2**a;return{pyramidLevel:a,pyramidResolution:new o({x:m*n.nativePixelSize.x,y:m*n.nativePixelSize.y,spatialReference:n.spatialReference}),excessiveReading:s}}function k(t,n,e=512,r=!0){const{extent:l,spatialReference:a,pixelSize:s}=t,c=y(new o({x:s.x,y:s.y,spatialReference:a}),n,l);if(null==c)return{projectedPixelSize:null,scales:null,srcResolutions:null,isCustomTilingScheme:!1};const u=(c.x+c.y)/2,f=i(n),h=u*f*96*39.37,m=n.isGeographic?256/e*295828763.7958547:256/e*591657527.591555;let M="vector-magdir"===t.dataType||"vector-uv"===t.dataType;const x=N(l,n);M||r&&(n.isGeographic||n.isWebMercator)&&(M=x.xmin*x.xmax<0);let p,d=h;const w=1.001;if(M){d=m;const t=n.isGeographic?1341104507446289e-21:.29858214164761665,e=t*(96*f*39.37);p=y(new o({x:t,y:t,spatialReference:{wkid:n.isGeographic?4326:3857}}),a,x),p.x*=d/e,p.y*=d/e}else{p={x:s.x,y:s.y};const n=Math.ceil(Math.log(Math.min(t.width,t.height)/32)/Math.LN2);let e=0;for(;d<m*(w/2)&&e<n;)e++,d*=2,p.x*=2,p.y*=2;Math.max(d,m)/Math.min(d,m)<=w&&(d=m)}const g=[d],R=[{x:p.x,y:p.y}],v=Math.min(70.5310735,h)/w;for(;d>=v;)d/=2,p.x/=2,p.y/=2,g.push(d),R.push({x:p.x,y:p.y});return{projectedPixelSize:c,scales:g,srcResolutions:R,isCustomTilingScheme:!M}}export{b as A,k as F,z as G,W as L,S as P,y as R,P as T,p as d,N as j,T as q,g as v,d as w,h as x}