import{r as t,c as e,h as i,g as s}from"./p-53bb6ab4.js";import{s as n,e as r,d as o,i as a,a1 as h,a2 as l,a3 as c,D as u,a0 as d,A as p,aW as f,_ as g,aE as m,a8 as v,c as y,af as w,bE as x,ar as b,aJ as C,T as M,bu as S,V as P,p as T,aT as A,S as _,f as D,ah as O,ao as R,b as F,bT as z,n as L,u as E,I,a5 as V,a6 as j,Z as N,ac as k,c5 as B,r as G,aK as q,aP as W,bs as U,cc as H,cs as Z,ct as Q,ai as Y,$ as X,cq as K,bF as $,bo as J,a as tt,cu as et,cv as it,cw as st,bp as nt,bG as rt,ca as ot,aF as at,bx as ht,cx as lt,cy as ct,ax as ut,K as dt,cg as pt,aN as ft,bK as gt,h as mt,aw as vt,ap as yt,cz as wt,ce as xt,cA as bt,k as Ct,cB as Mt,aI as St,cC as Pt,cD as Tt,b9 as At,bU as _t,q as Dt,bO as Ot,bI as Rt,bv as Ft,cj as zt,C as Lt,cE as Et,o as It,cF as Vt,cG as jt,c1 as Nt,c2 as kt,ck as Bt,cH as Gt,cI as qt,cl as Wt,cJ as Ut,aU as Ht,m as Zt,cK as Qt,bN as Yt,cp as Xt,by as Kt,B as $t,ad as Jt}from"./p-e58503d5.js";import{A as te,j as ee,n as ie,c as se,y as ne,i as re,s as oe,z as ae,d as he,u as le,g as ce,o as ue,m as de,p as pe,q as fe,B as ge,U as me,C as ve,D as ye,r as we,v as xe,a as be,x as Ce,P as Me}from"./p-6484267b.js";import{u as Se,d as Pe}from"./p-eee9ef50.js";import{n as Te,t as Ae,m as _e,B as De}from"./p-efbca0ca.js";import{n as Oe}from"./p-9b7a2176.js";import{l as Re,O as Fe}from"./p-d208934e.js";import{r as ze}from"./p-389c5380.js";import{v as Le}from"./p-afac6fb2.js";import{w as Ee,b as Ie,R as Ve,O as je,x as Ne,v as ke,t as Be,$ as Ge,c as qe,j as We,d as Ue,u as He,n as Ze}from"./p-c93d2280.js";import{r as Qe}from"./p-76f37e40.js";import{d as Ye}from"./p-c048b814.js";import Xe from"./p-0eb619a6.js";import{a as Ke,i as $e,l as Je,b as ti,n as ei,c as ii,d as si,E as ni,w as ri,s as oi,T as ai,e as hi,f as li,p as ci,g as ui,V as di,h as pi,r as fi,j as gi,S as mi,o as vi,k as yi,m as wi,t as xi,y as bi,q as Ci,u as Mi,L as Si,v as Pi,H as Ti,x as Ai,M as _i,I as Di,z as Oi,A as Ri,B as Fi,C as zi,D as Li,F as Ei,G as Ii,J as Vi}from"./p-d2d87566.js";import{a as ji}from"./p-21bd46cc.js";import{h as Ni}from"./p-e273719b.js";import{r as ki}from"./p-a9a30646.js";import{s as Bi,t as Gi,L as qi,u as Wi,v as Ui}from"./p-8bc9b36a.js";import{x as Hi}from"./p-400ca3dc.js";import{a as Zi,n as Qi}from"./p-e654504b.js";import{d as Yi,s as Xi,u as Ki,r as $i,g as Ji,c as ts,z as es,a as is,_ as ss,m as ns,l as rs,I as os,M as as,b as hs,v as ls,q as cs,S as us,o as ds,L as ps,e as fs,G as gs,h as ms,i as vs,k as ys,y as ws,H as xs,f as bs,n as Cs,t as Ms,F as Ss,X as Ps,A as Ts,B as As,Y as _s,P as Ds,C as Os,D as Rs,J as Fs,T as zs,E as Ls,K as Es,N as Is,O as Vs}from"./p-2f398ed1.js";import{n as js,r as Ns,b as ks,f as Bs,e as Gs,i as qs,u as Ws}from"./p-d3105731.js";import{b as Us}from"./p-3e39c093.js";import{u as Hs}from"./p-1ab449fc.js";import{y as Zs,p as Qs}from"./p-1189fa83.js";import{F as Ys,P as Xs,U as Ks,p as $s,I as Js,w as tn,q as en,S as sn,x as nn,d as rn}from"./p-6ded4c02.js";import"./p-b79fcce3.js";import{h as on}from"./p-54330161.js";import{a as an,o as hn,p as ln,f as cn,u as un,n as dn}from"./p-b9aa4901.js";import{e as pn,a as fn}from"./p-8f986f60.js";import{e as gn,r as mn,a as vn}from"./p-2c84c65f.js";import{B as yn,p as wn,S as xn,G as bn,h as Cn,f as Mn,a as Sn,I as Pn,N as Tn,y as An,v as _n,u as Dn,A as On,x as Rn}from"./p-f94762ac.js";import{b as Fn,D as zn,u as Ln,m as En,B as In,d as Vn,h as jn,k as Nn,s as kn,l as Bn,a as Gn,o as qn,R as Wn,f as Un,p as Hn,c as Zn,G as Qn,M as Yn,E as Xn,q as Kn,g as $n}from"./p-ea916a39.js";import{y as Jn,i as tr,z as er,e as ir,P as sr,c as nr,o as rr,a as or,b as ar,J as hr,I as lr,W as cr,d as ur,n as dr,f as pr,g as fr,w as gr,x as mr,O as vr,R as yr,q as wr,C as xr,t as br,K as Cr,h as Mr,j as Sr,A as Pr,k as Tr,l as Ar,s as _r,m as Dr,S as Or,p as Rr,r as Fr,u as zr,v as Lr,B as Er,D as Ir,E as Vr,F as jr,G as Nr,_ as kr,H as Br,L as Gr,M as qr,N as Wr,Q as Ur,T as Hr,U as Zr}from"./p-340cd100.js";import{p as Qr,d as Yr,H as Xr}from"./p-01e5a461.js";import{i as Kr}from"./p-fd584619.js";import{r as $r,m as Jr,b as to,f as eo,n as io,h as so,Q as no,F as ro,e as oo,l as ao,c as ho,s as lo,E as co,C as uo}from"./p-ccdb8e80.js";import{f as po,C as fo,D as go,R as mo}from"./p-ca295674.js";import{c as vo}from"./p-31225789.js";import{r as yo,c as wo}from"./p-765e6c28.js";import{r as xo}from"./p-a4587ab0.js";import{c as bo}from"./p-480e5606.js";import{i as Co,d as Mo,x as So,c as Po,p as To,s as Ao}from"./p-fb38a9d0.js";import{J as _o,_ as Do,c as Oo,G as Ro,D as Fo,l as zo,H as Lo,z as Eo}from"./p-ea0c022e.js";import{O as Io,Z as Vo,f as jo,j as No,U as ko,q as Bo,F as Go,k as qo,d as Wo,P as Uo,I as Ho,L as Zo,i as Qo,E as Yo}from"./p-95909347.js";import{i as Xo,d as Ko,u as $o,_ as Jo,a as ta,c as ea}from"./p-612a2c14.js";import{h as ia}from"./p-954786fa.js";import{n as sa,r as na,e as ra,_ as oa,t as aa}from"./p-4d38e149.js";import{i as ha,p as la}from"./p-5d962998.js";import{o as ca,n as ua,r as da}from"./p-81b9df84.js";import{r as pa,d as fa,a as ga,o as ma,s as va,l as ya,_ as wa,j as xa,x as ba,v as Ca,q as Ma}from"./p-e6fe5d89.js";import{n as Sa,t as Pa,f as Ta}from"./p-746a9d8f.js";import{t as Aa,n as _a,a as Da,x as Oa,u as Ra,l as Fa,b as za,i as La,d as Ea,c as Ia,e as Va,f as ja,r as Na,g as ka,h as Ba,j as Ga,k as qa}from"./p-d87e82bf.js";import{n as Wa,t as Ua,a as Ha,e as Za,b as Qa,c as Ya,d as Xa,o as Ka,f as $a,i as Ja,s as th,g as eh,h as ih,j as sh,r as nh,k as rh,l as oh,m as ah,p as hh,q as lh,O as ch,T as uh,L as dh,u as ph,v as fh,w as gh,x as mh,y as vh,z as yh,A as wh,B as xh,C as bh,M as Ch,D as Mh,E as Sh,F as Ph,G as Th,H as Ah,I as _h,J as Dh,K as Oh,N as Rh,P as Fh,Q as zh,R as Lh,S as Eh,U as Ih,V as Vh,W as jh,X as Nh,Y as kh,Z as Bh}from"./p-eb48bb01.js";import{g as Gh,e as qh,r as Wh,t as Uh,i as Hh,a as Zh,l as Qh,u as Yh,c as Xh,s as Kh,b as $h,d as Jh}from"./p-bdf9e611.js";import{w as tl,F as el}from"./p-a3955219.js";import{r as il,f as sl,c as nl}from"./p-3c70d22f.js";import{a as rl,t as ol,r as al,e as hl,n as ll}from"./p-c2152437.js";import{l as cl,r as ul,f as dl,h as pl,n as fl,e as gl}from"./p-19bc1e3d.js";import{o as ml}from"./p-0bb84768.js";import{t as vl}from"./p-04a0cfca.js";import{A as yl}from"./p-a72732f2.js";import{d as wl,i as xl,q as bl,f as Cl,v as Ml,D as Sl}from"./p-7f47b970.js";import{l as Pl}from"./p-7731c620.js";import{j as Tl,i as Al,c as _l,s as Dl,a as Ol,r as Rl,e as Fl,k as zl,b as Ll,o as El,d as Il,p as Vl,f as jl}from"./p-cbbdb7db.js";import{n as Nl}from"./p-b5b00e38.js";import{k as kl,D as Bl,p as Gl,v as ql,W as Wl,z as Ul,A as Hl,P as Zl,y as Ql,R as Yl}from"./p-dcdb33cf.js";import{m as Xl,s as Kl,g as $l,o as Jl}from"./p-70787875.js";import{t as tc,a as ec,s as ic,b as sc,h as nc,o as rc,c as oc,d as ac}from"./p-1f1360f9.js";import{createLabelFunction as hc}from"./p-1a2ab148.js";import{l as lc,n as cc}from"./p-58c16730.js";import{b as uc,l as dc}from"./p-37f005a2.js";import{g as pc,j as fc,o as gc,T as mc}from"./p-728dcbb0.js";import{r as vc,n as yc}from"./p-09dd2137.js";import{getGeometryServiceURL as wc}from"./p-42bb6c1e.js";import{a as xc,n as bc}from"./p-2e37d910.js";import{h as Cc,i as Mc}from"./p-b0565d49.js";import{p as Sc}from"./p-e94b450b.js";import{p as Pc}from"./p-fe68aab5.js";import{n as Tc}from"./p-24d8fcee.js";import{d as Ac,u as _c}from"./p-fbb06b4d.js";import{u as Dc}from"./p-a63f7978.js";import{i as Oc,o as Rc,s as Fc,l as zc,f as Lc,n as Ec,r as Ic,u as Vc,m as jc,c as Nc}from"./p-6fe4db61.js";import{i as kc,x as Bc}from"./p-f06611ed.js";import{r as Gc,e as qc}from"./p-f6a340f9.js";import{r as Wc,o as Uc}from"./p-025c0c8e.js";import{e as Hc}from"./p-2f5c7e83.js";import{p as Zc,f as Qc,D as Yc,i as Xc,t as Kc,d as $c,w as Jc,e as tu}from"./p-9fe35ea1.js";import{n as eu}from"./p-e9596294.js";import{a as iu,f as su,d as nu,o as ru,c as ou}from"./p-de5b11d6.js";import{t as au,r as hu}from"./p-db4d63dc.js";import{t as lu}from"./p-f70b836b.js";import{t as cu}from"./p-ca657fcf.js";var uu;let du=uu=class extends h{constructor(t){super(t),this.viewing=null}clone(){return new uu({viewing:this.viewing?this.viewing.clone():null})}};r([o({type:Ke,json:{write:!0}})],du.prototype,"viewing",void 0),du=uu=r([a("esri.webscene.ApplicationProperties")],du);const pu=du;var fu;let gu=fu=class extends h{constructor(t){super(t),this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null}readDate(t,e){return null!=e.datetime&&new Date(e.datetime)||null}writeDate(t,e,i){e[i]=t.getTime()}readDirectShadowsEnabled(t,e){return!!e.directShadows}writedirectShadowsEnabled(t,e,i){t&&(e[i]=t)}writeDisplayUTCOffset(t,e){null!=t&&(e.displayUTCOffset=t)}clone(){return new fu(this.cloneConstructProperties())}cloneConstructProperties(){const t={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:null!=this.displayUTCOffset?this.displayUTCOffset:null};return null!=this.date&&(t.date=new Date(this.date.getTime())),t}};r([o({type:Date,json:{type:Number,write:{target:"datetime"}}})],gu.prototype,"date",void 0),r([l("date",["datetime"])],gu.prototype,"readDate",null),r([c("date")],gu.prototype,"writeDate",null),r([o({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],gu.prototype,"directShadowsEnabled",void 0),r([l("directShadowsEnabled",["directShadows"])],gu.prototype,"readDirectShadowsEnabled",null),r([c("directShadowsEnabled")],gu.prototype,"writedirectShadowsEnabled",null),r([o({type:Number,json:{write:!0}})],gu.prototype,"displayUTCOffset",void 0),r([c("displayUTCOffset")],gu.prototype,"writeDisplayUTCOffset",null),gu=fu=r([a("esri.webscene.Lighting")],gu);const mu=gu;let vu=class extends h{constructor(t){super(t)}clone(){}};r([o({readOnly:!0,json:{read:!1}})],vu.prototype,"type",void 0),vu=r([a("esri.webscene.background.Background")],vu);const yu=vu;var wu;const xu={...Bi,nonNullable:!0};let bu=wu=class extends yu{constructor(t){super(t),this.type="color",this.color=new Ni([0,0,0,1])}clone(){return new wu(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};r([ki({color:"color"},{readOnly:!0})],bu.prototype,"type",void 0),r([o(xu)],bu.prototype,"color",void 0),bu=wu=r([a("esri.webscene.background.ColorBackground")],bu);const Cu=bu,Mu={base:yu,key:"type",typeMap:{color:Cu}},Su={types:Mu,json:{read:function(t){return(e,i,s)=>{if(!e)return e;for(const i in t.typeMap)if(e.type===i){const n=new t.typeMap[i];return n.read(e,s),n}}}(Mu),write:{overridePolicy:(t,e,i)=>({enabled:!i||!i.isPresentation})}}};var Pu;const Tu=(t,e,i)=>({enabled:!i||!i.isPresentation});let Au=Pu=class extends h{constructor(t){super(t),this.lighting=new mu,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}clone(){return new Pu(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:mu.prototype.clone.call(this.lighting),background:u(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled}}};r([o({type:mu,json:{write:!0}})],Au.prototype,"lighting",void 0),r([o(Su)],Au.prototype,"background",void 0),r([o({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:Tu}}})],Au.prototype,"atmosphereEnabled",void 0),r([o({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:Tu}}})],Au.prototype,"starsEnabled",void 0),Au=Pu=r([a("esri.webscene.Environment")],Au);const _u=Au;var Du;let Ou=Du=class extends h{constructor(t){super(t),this.environment=new _u,this.spatialReference=null,this.viewpoint=null}set viewingMode(t){this._set("viewingMode",t)}clone(){return new Du({environment:this.environment.clone(),spatialReference:this.spatialReference?this.spatialReference.clone():null,viewingMode:this.viewingMode,viewpoint:this.viewpoint?this.viewpoint.clone():null})}};r([o({type:_u,json:{write:{isRequired:!0}}})],Ou.prototype,"environment",void 0),r([o({type:d})],Ou.prototype,"spatialReference",void 0),r([o({type:["local","global"]})],Ou.prototype,"viewingMode",null),r([o({type:Se,json:{write:{isRequired:!0}}})],Ou.prototype,"viewpoint",void 0),Ou=Du=r([a("esri.webscene.InitialViewProperties")],Ou);const Ru=Ou;function Fu(t,e,i,s){return p(t.renderCoordsHelper.fromRenderCoords(e.eye,Vu,s))&&Fn(i,Vu)}function zu(t,e){return t.elevationProvider?f(t.elevationProvider.getElevation(e[0],e[1],e[2],t.renderCoordsHelper.spatialReference,"ground"),0):0}function Lu(t,e,i,s){const n=t.state.camera.clone();e&&(n.eye=e,n.center=i,n.up=s),function(t,e,i){let s=Iu[t.viewingMode];s||(s=new Jn(t.state.viewingMode),s.options.backfacesTerrain=!t.state.isGlobal,s.options.invisibleTerrain=!0,Iu[t.viewingMode]=s);const{isGlobal:n}=t.state;return!(!t.sceneIntersectionHelper.intersectRay(e,s,i)||Eu(t,e.origin,i))||!(!t.renderCoordsHelper.intersectManifold(e,0,i)||Eu(t,e.origin,i))||!!n&&function(t,e,i){const s=es(t.origin,t.origin)-i*i,n=s>0?Math.sqrt(s)/3:1;return Yi(e,t.direction,n/Xi(t.direction)),Ki(e,e,t.origin),!0}(e,i,Qr(t.spatialReference).radius)}(t,n.ray,ju)||$i(ju,n.center);const r=t.state.constraints,o=r.minimumPoiDistance;if(Ji(n.eye,ju)<o){const e=r.collision.enabled;$i(Nu,n.viewForward),Yi(Nu,Nu,o),e?n.eye=ts(Vu,ju,Nu):Ki(ju,n.eye,Nu);const i=t.renderCoordsHelper,s=i.getAltitude(n.eye),a=r.collision.elevationMargin;e&&s<a&&(ts(Nu,ju,n.eye),n.eye=i.setAltitude(Vu,a,n.eye),Ki(ju,n.eye,Nu))}return n.center=ju,n}function Eu(t,e,i){if(!t.state.isGlobal)return!1;const s=zu(t,e),n=t.stateManager.constraintsManager.nearFarHeuristic,{far:r}=n.compute(e,i,t.renderDataExtent,s,ku),o=r*r;return Ji(e,i)>o}const Iu={},Vu=js(),ju=js(),Nu=js(),ku={near:0,far:0},Bu=js(),Gu=js();function qu(){return{direction:js(),up:js()}}function Wu(t,e,i,s,n){let r=is(Bu,t),o=es(r,s);const a=o>0;o=Math.abs(o),o>.99&&(o=Math.abs(es(e,s)),o<.99?($i(r,e),a&&Yi(r,r,-1)):r=null);let h=0;if(r){Yi(Gu,s,es(s,r)),ts(r,r,Gu);const t=es(r,n)/(Xi(r)*Xi(n));ss(Gu,r,n),h=(es(Gu,s)>0?1:-1)*ns(rs(t))}const l=ns(rs(-es(s,t)/Xi(t)));return i?(i.heading=h,i.tilt=l,i):{heading:h,tilt:l}}const Uu=Ns(0,1,0),Hu=Ns(0,0,1),Zu=gn(),Qu=js(),Yu=js();function Xu(t,e,i,s=qu()){$r(Zu);const{direction:n,up:r}=s;return Jr(Zu,Zu,-as(e)),to(Zu,Zu,as(i)),os(n,Hu,Zu),Yi(n,n,-1),os(r,Uu,Zu),s}function Ku(t,e,i,s,n){const r=t.renderSpatialReference,o=t.map&&t.spatialReference||e.spatialReference;return Ee(e,Qu,r),Ee(e,Yu,r),Qu[0]-=i/2,Yu[0]+=i/2,Qu[1]-=s/2,Yu[1]+=s/2,Ie(Qu,r,Qu,o),Ie(Yu,r,Yu,o),n?(n.xmin=Qu[0],n.ymin=Qu[1],n.xmax=Yu[0],n.ymax=Yu[1],n.spatialReference=o):n=new g(Qu[0],Qu[1],Yu[0],Yu[1],o),n}const $u=Object.freeze({__proto__:null,headingTiltToDirectionUp:Xu,directionToHeadingTilt:function(t,e,i,s){return Wu(e,i,s,Hu,Uu)},eyeForCenterWithHeadingTilt:function(t,e,i,s){const n=Xu(0,i,s),r=js();return Yi(r,n.direction,-e),Ki(r,r,t),{up:n.up,eye:r,heading:i,tilt:s}},lookAtTiltToEyeTilt:function(t){return ns(t)},eyeTiltToLookAtTilt:function(t){return as(t)},toExtent:Ku});function Ju(t,e,i){return function(t,e,i,s,n){const r=as(i),o=as(n),a=r-o,h=as(e)-as(s),l=Math.sin(a/2),c=Math.sin(h/2),u=2*hs(Math.sqrt(l*l+Math.cos(r)*Math.cos(o)*c*c))*t;return Math.round(1e4*u)/1e4}(t,e.longitude,e.latitude,i.longitude,i.latitude)}function td(t,e){e||(e={hours:0,minutes:0,seconds:0}),e.hours=function(t){let e=t/15;return e}(t[0]);const i=e.hours%1;e.hours-=i,e.minutes=60*i;const s=e.minutes%1;return e.minutes-=s,e.seconds=Math.round(60*s),e}const ed=Ns(0,0,1),id=is(js(),Ns(1,1,1)),sd=new Xs(-180,180),nd=gn(),rd=js(),od=js();function ad(t,e,i,s=qu()){ss(rd,t,ed),0===es(rd,rd)&&ss(rd,t,id),$r(nd),eo(nd,nd,-as(e),t),eo(nd,nd,-as(i),rd);const{up:n,direction:r}=s;return ss(n,rd,t),is(n,n),os(n,n,nd),is(r,t),ls(r,r),os(r,r,nd),s}function hd(t){const e=t[1];t[1]=-t[2],t[2]=e}function ld(t,e){const i=ad(e,t.heading,t.tilt);return t.up=i.up,t}function cd(t,e,i,s,n){let r,o,a,h;const l=e.latitude,c=e.longitude,u=function(t,e,i){const s=e/i,n=as(t),r=Math.sin(s/2),o=Math.cos(n),a=2*hs(Math.sqrt(r*r/(o*o)));return ns(a)}(l,i,Qr(t.spatialReference).radius)/2;r=c-u,o=c+u;const p=as(l),f=Qr(t.spatialReference).radius,m=(1+Math.sin(p))/(1-Math.sin(p)),y=(m+1)*Math.tan(s/f/2);function w(t){const e=Math.PI/2;return(t=Ys.normalize(t,-e))>e&&(t=Math.PI-t),t}if(a=1.5*Math.PI-2*Math.atan(.5*(y+Math.sqrt(4*m+y*y))),h=a+s/f,a=w(a),h=w(h),h<a){const t=h;h=a,a=t}if(a=Math.max(ns(a),-90),h=Math.min(ns(h),90),o=sd.monotonic(r,o),o-r>180){const t=(o-r-180)/2;r+=t,o-=t}const x=t.spatialReference&&t.spatialReference.isGeographic?t.spatialReference:d.WGS84;return n?(n.xmin=r,n.ymin=a,n.xmax=o,n.ymax=h,n.spatialReference=x):n=new g(r,a,o,h,x),t.spatialReference&&t.spatialReference.isWebMercator&&v(n,!1,n),n}const ud=Object.freeze({__proto__:null,headingTiltToDirectionUp:ad,directionToHeadingTilt:function(t,e,i,s){const n=rd,r=od;return is(n,t),ss(od,n,ed),0===es(od,od)&&ss(od,n,id),ss(r,od,n),Wu(e,i,s,n,r)},eyeForCenterWithHeadingTilt:function(t,e,i,s){const n={eye:js(),up:null,tilt:s,heading:i},r=rd;r[0]=t[0],r[1]=t[2],r[2]=-t[1];const o=e,a=as(i),h=as(s),l=Math.sin(a),c=Math.cos(a),u=Math.sin(h),d=Math.cos(h),p=Xi(r);let f;if(Math.abs(h)<1e-8)f=o+p;else{const t=p/u,e=hs(o/t),i=Math.PI-h-e;f=t*Math.sin(i)}const g=d*o,m=o*o*(u*u),v=c*c*m,y=f-g,w=y*y,x=v*(v+w-r[1]*r[1]);if(x<0)return Yi(n.eye,r,f/p),n.tilt=0,n;const b=Math.sqrt(x),C=r[1]*y,M=v+w;let S;if(S=c>0?-b+C:b+C,Math.abs(M)<1e-8)return p<1e-8?(n.eye[0]=0,n.eye[1]=0,n.eye[2]=o):Yi(n.eye,r,f/p),n.tilt=0,hd(n.eye),ld(n,t);n.eye[1]=S/M;const P=l*l*m,T=u*o,A=c*T*n.eye[1],_=n.eye[1]*n.eye[1],D=1-_,O=Math.sqrt(D),R=v*_+P-2*A*O*y+D*w;return Math.abs(R)<1e-8?(Yi(n.eye,r,f/p),n.tilt=0,hd(n.eye),ld(n,t)):(n.eye[0]=(D*(f*r[0]-g*r[0])-T*O*(r[0]*n.eye[1]*c+r[2]*l))/R,n.eye[2]=(D*(f*r[2]-g*r[2])-T*O*(r[2]*n.eye[1]*c-r[0]*l))/R,Yi(n.eye,n.eye,f),hd(n.eye),ld(n,t))},lookAtTiltToEyeTilt:function(t,e,i){const s=Xi(e),n=Math.sqrt(i*i+s*s-2*i*s*Math.cos(Math.PI-t)),r=hs(i/(n/Math.sin(t)));return ns(t-r)},eyeTiltToLookAtTilt:function(t,e,i){const s=as(t),n=Xi(e);return hs(i/(n/Math.sin(s)))+s},toExtent:cd}),dd=y.getLogger("esri.views.3d.support.cameraUtils"),pd=js(),fd=js(),gd={heading:0,tilt:0},md=new m,vd=new Xs(-20037508.342788905,20037508.342788905),yd=new Xs(-180,180);function wd(t){return t.spatialReference||d.WGS84}function xd(t){return"global"===t.viewingMode?ud:$u}function bd(t,e){if(w(e))return null;const i=t.renderSpatialReference,s=xd(t).headingTiltToDirectionUp,n=js();if(!Ee(e.position,n,i))return null;const r=s(n,e.heading,e.tilt);Yi(r.direction,r.direction,t.state.camera.distance),Ki(r.direction,r.direction,n);const o=Lu(t,n,r.direction,r.up);return o.fov=as(e.fov),o}const Cd=js();function Md(t,e,i){const s=t.renderSpatialReference,n=_d(t,e.eye,e.viewForward,e.up,gd);let r=wd(t);return Ie(e.eye,s,Cd,r)||(r=d.WGS84,Ie(e.eye,s,Cd,r)),w(i)?new Pe(new m(Cd,r),n.heading,n.tilt,ns(e.fov)):(i.position.x=Cd[0],i.position.y=Cd[1],i.position.z=Cd[2],i.position.spatialReference=r,i.heading=n.heading,i.tilt=n.tilt,i.fov=ns(e.fov),i)}function Sd(t,e,i){const s=t.state.camera,n=s.width/2/s.pixelRatio;return 1===t.renderCoordsHelper.viewingMode&&null!=i&&(e*=Math.cos(as(i))),n/(96*39.37/(e/=t.renderCoordsHelper.unitInMeters))/Math.tan(s.fovX/2)}function Pd(t,e,i){const s=t.state.camera,n=e*Math.tan(s.fovX/2);let r=96*39.37/(s.width/2/s.pixelRatio/n);return 1===t.renderCoordsHelper.viewingMode&&(r/=Math.cos(as(i))),r*=t.renderCoordsHelper.unitInMeters,r}function Td(t,e,i,s,n,r){return Ad(t,e,Sd(t,i,e.latitude),s,n,r)}function Ad(t,e,i,s,n,r){if(Nd(r)){const o=new jd(r.signal);return Dd(t,s.heading,s.tilt,e,i,n,o),void o.resolver.promise.then((e=>{const i=Ld(t,e,s.fov);if(!w(i))return r.resolver.resolve(i);r.resolver.reject()}),(t=>r.resolver.reject(t)))}const o=Dd(t,s.heading,s.tilt,e,i,n);return Ld(t,o,s.fov,r)}function _d(t,e,i,s,n){return xd(t).directionToHeadingTilt(e,i,s,n)}function Dd(t,e,i,s,n,r,o){const a=s&&s instanceof m?s:null;if(Nd(o))return async function(t,e,i){const s=js();if(e)if(e instanceof m){if(Ee(e,s,t.renderSpatialReference),null==e.z&&null!=t.basemapTerrain){const n=await t.elevationProvider.queryElevation(e.x,e.y,e.z,e.spatialReference,"ground",i);return p(n)&&t.renderCoordsHelper.setAltitude(s,n),s}}else $i(s,e);else $i(s,t.state.camera.center);return s}(t,s,o.signal).then((s=>{Od(t,e,i,a,s,n,r,o)}),(t=>o.resolver.reject(t))),null;const h=function(t,e){const i=js();if(e&&e instanceof m){if(Ee(e,i,t.renderSpatialReference),null==e.z&&null!=t.basemapTerrain){const s=tr(t.elevationProvider,e);p(s)&&t.renderCoordsHelper.setAltitude(i,s)}}else $i(i,e||t.state.camera.center);return i}(t,s);return Od(t,e,i,a,h,n,r,o)}function Od(t,e,i,s,n,r,o,a){if(w(s)&&(s=Ve(n,t.renderSpatialReference,wd(t)),w(s)))return null;r=Math.max(r,t.state.constraints.minimumPoiDistance);const h=function(t,e,i,s,n,r){let o=0;return 1===r&&function(t,e,i){const s=t.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(i/s)/Math.LN2>8)return!0;const n=t.renderSpatialReference,r=wd(t),o=Ve(e,n,r),a=Ve(t.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,n,r);if(w(o)||w(a))return!1;const h=Math.tan(.5*t.state.camera.fov)*s;return a.distance(o)/h>5}(t,s,n)?(e=0,o=function(t,e,i,s){const n=t.state.constraints.tilt(e);n.max=Math.min(n.max,.5*Math.PI);const r=n.min*(1-.7)+.7*n.max,o=zd(t,s,e,i);return Math.min(o,r)}(t,n,i,s)):o=zd(t,s,n,i),o=t.state.constraints.clampTilt(n,o),{heading:e,tilt:i=Fd(t,s,n,o)}}(t,e,i,n,r,o),l=(0,xd(t).eyeForCenterWithHeadingTilt)(n,r,h.heading,h.tilt);if(1===o&&"global"===t.viewingMode&&i>0){const h=()=>{const h=Fd(t,n,r,function(t,e,i,s){const n=t.state.constraints.tilt(e);let r=zd(t,s,e,i);return r=Math.min(r,.5*Math.PI),n.min*(1-.7)+.7*r}(t,r,i,n));return Od(t,e,h,s,n,r,o=i-h<1?0:1,a)},c=t.map.ground.navigationConstraint;if(!c||"stay-above"===c.type){if(function(t,e){return!!(t.basemapTerrain&&t.renderCoordsHelper.fromRenderCoords(e,md,t.spatialReference)&&f(tr(t.elevationProvider,md),0)>md.z-1)}(t,l.eye))return h();if(Nd(a))return async function(t,e,i){if(!t.renderCoordsHelper.fromRenderCoords(e,md,t.spatialReference))return!1;const s=await t.elevationProvider.queryElevation(md.x,md.y,md.z,md.spatialReference,"ground",i);return f(s,0)>md.z-1}(t,l.eye,a.signal).then((t=>t?h():(a.resolver.resolve({eye:l.eye,up:l.up,center:ks(n),heading:l.heading,tilt:l.tilt}),null))),null}}const c=!a||Nd(a)?{center:js(),eye:js(),up:js(),tilt:0,heading:0}:a;return c.eye=l.eye,c.up=l.up,c.center=ks(n),c.heading=l.heading,c.tilt=l.tilt,Nd(a)&&a.resolver.resolve(c),c}function Rd(t,e,i,s,n,r=null){const o=null!=e.zmax&&null!=e.zmin;let a,h,l;if("global"===t.viewingMode){if(!$e(e.spatialReference,"global"))return Nd(r)&&r.resolver.reject(),null;const t=new m(e.xmin,e.ymin,e.spatialReference),i=new m(e.xmax,e.ymax,e.spatialReference),s=e.spatialReference.isGeographic?yd:vd;a=new m({x:s.center(t.x,i.x),y:(i.y+t.y)/2,z:o?(e.zmax+e.zmin)/2:null,spatialReference:e.spatialReference});const n=Qr(e.spatialReference),c=function(t,e,i){const s=e.spatialReference,n=Qr(s),r=new m(e.x,t.y,s),o=new m(i.x,t.y,s),a=new m(t.x,e.y,s),h=new m(t.x,i.y,s);return{lon:Ju(n.radius,r,o),lat:Ju(n.radius,a,h)}}(a,t,i);h=c.lon,l=c.lat,s.diff(t.x,i.x)>s.range/2&&(h+=n.halfCircumference),h=Math.min(h,n.halfCircumference),l=Math.min(l,n.halfCircumference)}else{const i=f(t.renderSpatialReference,e.spatialReference);i.equals(e.spatialReference)||(e=je(e,i)),h=e.xmax-e.xmin,l=e.ymax-e.ymin,a=new m({x:e.xmin+.5*h,y:e.ymin+.5*l,z:o?(e.zmax+e.zmin)/2:null,spatialReference:i})}const c=o?e.zmax-e.zmin:0,u=t.state.camera,d=1/Math.tan(u.fovX/2),p=1/Math.tan(u.fovY/2),g=1/Math.tan(u.fov/2),v=Math.max(.5*h*d,.5*l*p,.5*c*g)/1;if(Nd(r)){const e=new jd(r.signal);return Dd(t,i,s,a,v,n,e),void e.resolver.promise.then((e=>{const i=Ld(t,e,t.camera.fov);if(!w(i))return r.resolver.resolve(i);r.resolver.reject()}),(t=>r.resolver.reject(t)))}const y=Dd(t,i,s,a,v,n);return Ld(t,y,t.camera.fov,r)}function Fd(t,e,i,s){return xd(t).lookAtTiltToEyeTilt(s,e,i)}function zd(t,e,i,s){return xd(t).eyeTiltToLookAtTilt(s,e,i)}function Ld(t,e,i,s){if(w(e))return null;const n=Ve(e.eye,t.renderSpatialReference,wd(t));return w(n)?null:p(s)?(s.position=n,s.heading=e.heading,s.tilt=e.tilt,s.fov=i,s):new Pe(n,e.heading,e.tilt,i)}function Ed(t,e){var i;const s=null==(i=t.basemapTerrain)?void 0:i.tilingScheme;if(s)return s.levelAtScale(e);dd.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function Id(t,e){var i;const s=null==(i=t.basemapTerrain)?void 0:i.tilingScheme;if(s)return s.scaleAtLevel(e);dd.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function Vd(t,e,i){const s=t.renderSpatialReference;let n,r;e||(e=t.state.camera);const o=d.WGS84;return e instanceof Pe?(n=e.position.latitude,Ee(e.position,pd,s),Ee(i,fd,s),r=cs(pd,fd)):(Ie(e.center,s,fd,o),n=fd[1],r=e.distance),Pd(t,r,n)}class jd{constructor(t){this.signal=t,this.resolver=x()}}function Nd(t){return t&&"resolver"in t}function kd(t){return 360-Ks.normalize(t)}function Bd(t){return Ks.normalize(360-t)}function Gd(t){return p(t)&&t.resolver&&t.resolver.reject(),null}function qd(t,e,i,s=null){if(!e)return Gd(s);const n=t.spatialReference||d.WGS84;if(p(e.camera)){const t=b(e.camera.position,n);if(w(t))return Gd(s);const i=e.camera.clone();return i.position=t,function(t,e){return p(t)&&t.resolver&&t.resolver.resolve(e),e}(s,i)}if(w(e.targetGeometry))return Gd(s);const r=e.get("targetGeometry.spatialReference");if(r&&!C(r,n))return Gd(s);const o=Md(t,t.state.camera);let a=1;if(null!=e.rotation&&(o.heading=kd(e.rotation),a=0),null!=i&&(o.tilt=i),"point"===e.targetGeometry.type){const i=e.targetGeometry;let n;const r=e.targetGeometry.clone();return n=null!=e.scale?Sd(t,e.scale,i.latitude):t.state.camera.distance,Ad(t,r,n,o,a,s)}return Rd(t,e.targetGeometry.extent,o.heading,o.tilt,a,s)}async function Wd(t,e,i){const s=function(t,e){if(!e||!t.spatialReference)return null;const i={target:null};if("declaredClass"in e||Array.isArray(e))i.target=e;else{for(const t in e)i[t]=e[t];e.center&&!i.target&&(i.target=e.center)}return i}(t,e);if(!s)throw new n("viewpointutils-create:no-target","Missing target for creating viewpoint");const r=new Pe({fov:t.camera.fov}),o=new Se({camera:r});if(s.target instanceof Se)return $d(await async function(t,e,i,s,n){if(p(e.camera))return Xd(t,e.camera,n);n.scale=e.scale,n.rotation=e.rotation,n.targetGeometry=p(e.targetGeometry)?e.targetGeometry.clone():null,n.camera=null,null!=i.heading?n.rotation=Bd(i.heading):null!=i.rotation&&(n.rotation=i.rotation);const r=Ud(t,i);null!=r&&(n.scale=r);const o=new jd(s);return qd(t,n,i.tilt,o),n.camera=await o.resolver.promise,n}(t,s.target,s,i,o));if(s.target instanceof Pe)return $d(Xd(t,s.target,o));const a=null!=s.scale||null!=s.zoom;if(s.target instanceof g){const e=s.target.xmin===s.target.xmax||s.target.ymin===s.target.ymax;return $d(a||e?await Kd(t,s,s.target.center,r,i,o):await async function(t,e,i,s,n,r){r.targetGeometry=i.clone();Md(t,Lu(t),s);const o=Hd(s,e)?0:1,a=new jd(n);return Rd(t,i,s.heading,s.tilt,o,a),r.camera=await a.resolver.promise,r}(t,s,s.target,r,i,o))}const h={boundingBox:yn(),hasZ:!1,screenSpaceObjects:[]},l=a?function(t,e){return function(t,e){return t.spatialReference?Kr(e,t.spatialReference):void 0}(t,Ud(t,e))}(t,s):void 0;if(await Yd(t,s.target,l,h),isFinite(h.boundingBox[0])){let e;if(wn(h.boundingBox,Jd),hp.x=Jd[0],hp.y=Jd[1],hp.z=Jd[2],hp.spatialReference=t.spatialReference,isFinite(hp.z)&&h.hasZ?e=xn(h.boundingBox):(hp.z=void 0,e=zn(bn(h.boundingBox,sp))),a||e)return $d(await Kd(t,s,hp,r,i,o));const n=function(t,e){if(!e.length)return.66;let i=Number.NEGATIVE_INFINITY;for(let t=0;t<e.length;t++){const s=e[t].screenSpaceBoundingRect;i=Math.max(i,Math.abs(s[0]),Math.abs(s[1]),Math.abs(s[2]),Math.abs(s[3]))}return.66-i/Math.min(t.width,t.height)*2}(t,h.screenSpaceObjects);return $d(await async function(t,e,i,s,n,r,o,a){a.targetGeometry=i.clone();const h=Lu(t),l=function(t,e,i,s,n){let r=0;i.hasZ?r=i.z:t.basemapTerrain&&(r=P(tr(t.elevationProvider,i))),ds(Jd,i.x,i.y,r),ke(t.spatialReference,Jd,tp,t.renderSpatialReference),an(ep,tp),hn(ep,ep),yn(ip);const o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let e=0;e<o.length;e++){const i=o[e];let n=s[i[2]];isFinite(n)||(n=r),ds(Jd,s[i[0]],s[i[1]],n),Ie(Jd,t.spatialReference,Jd,t.renderSpatialReference),Cn(ip,ps(Jd,Jd,ep))}const a=Pn(ip),h=Tn(ip),l=An(ip),c=1/Math.tan(e.fovX/2),u=1/Math.tan(e.fovY/2),d=.5*Math.sqrt(a*a+l*l)*Math.max(u,c)+.5*h,p=.5*h*u+.5*Math.max(a,l);return Math.max(d,p)/n}(t,h,i,s,n);Md(t,h,r);const c=Hd(r,e)?0:1;a.scale=Pd(t,l,a.targetGeometry.latitude);const u=new jd(o);return Td(t,a.targetGeometry,a.scale,r,c,u),a.camera=await u.resolver.promise,a}(t,s,hp,h.boundingBox,n,r,i,o))}return $d(s.position?function(t,e,i,s){const n=Lu(t);return $i(np,n.viewForward),_d(t,n.eye,np,n.up,ap),i.position=new m(e.position),i.heading=null!=e.heading?e.heading:ap.heading,i.tilt=null!=e.tilt?e.tilt:ap.tilt,Zd(t,null,i,s)}(t,s,r,o):await async function(t,e,i,s,n){const r=Lu(t);return Kd(t,e,Ve(r.center,t.renderSpatialReference,t.spatialReference),i,s,n)}(t,s,r,i,o))}function Ud(t,e){return null==e.scale&&null!=e.zoom?Id(t,e.zoom):e.scale}function Hd(t,e){let i=!1;return null!=e.heading?(t.heading=e.heading,i=!0):null!=e.rotation&&(t.heading=kd(e.rotation),i=!0),null!=e.tilt&&(t.tilt=e.tilt,i=!0),null!=e.fov&&(t.fov=e.fov),i}function Zd(t,e,i,s){const n=t.spatialReference||d.WGS84;return e=p(e)?e:bd(t,i),w(e)||(s.targetGeometry=Ve(e.center,t.renderSpatialReference,n),s.scale=Vd(t,e),s.rotation=Bd(i.heading),s.camera=i),s}function Qd(t,e,i){if(!e)return;if(!C(e.spatialReference,t.spatialReference))throw new n("viewpointutils:incompatible-spatialreference",`Spatial reference (${e.spatialReference?e.spatialReference.wkid:"unknown"}) is incompatible with the view (${t.spatialReference.wkid})`,{geometry:e});const s=[];if(!e.hasZ&&t.basemapTerrain){let i;switch(e.type){case"point":i=e;break;case"multipoint":case"polyline":i=e.extent.center;break;case"mesh":i=e.origin;break;case"extent":i=e.center;break;case"polygon":i=e.centroid}Jd[2]=i&&C(i,t.basemapTerrain.spatialReference)?f(tr(t.elevationProvider,i),0):0}(0,lp[e.type])(e,(t=>{s.push(t[0],t[1],t[2])}),Jd);const r=s.length/3;if(0===r)return;const o=new Array(s.length);if(Ne(s,e.spatialReference,0,o,t.spatialReference,0,r)){e.hasZ&&(i.hasZ=!0);for(let t=0;t<o.length;t+=3)e.hasZ?(Jd[0]=o[t+0],Jd[1]=o[t+1],Jd[2]=o[t+2]):(Jd[0]=o[t+0],Jd[1]=o[t+1]),Cn(i.boundingBox,Jd)}}async function Yd(t,e,i,s){if(Array.isArray(e)&&2===e.length){const i=e[0],n=e[1];if("number"==typeof i&&"number"==typeof n)return hp.x=i,hp.y=n,hp.z=void 0,hp.spatialReference=t.spatialReference.isGeographic?t.spatialReference:d.WGS84,void Qd(t,hp,s)}e&&"function"==typeof e.map?await M(e.map((e=>Yd(t,e,i,s)))):e instanceof S?Qd(t,e,s):e instanceof on&&await async function(t,e,i,s){const n=await Zi(t.whenViewForGraphic(e));if(!1===n.ok||w(n.value)||!("whenGraphicBounds"in n.value))return void Qd(t,e.geometry,s);const r=n.value,o=await Zi(r.whenGraphicBounds(e,{minDemResolution:i}));if(!1===o.ok)return void Qd(t,e.geometry,s);const{screenSpaceObjects:a,boundingBox:h}=o.value;Mn(s.boundingBox,h),a&&a.forEach((t=>{s.screenSpaceObjects.push(t)})),isFinite(h[2])&&(s.hasZ=!0)}(t,e,i,s)}function Xd(t,e,i){const s=b(e.position,t.spatialReference);return w(s)?null:((e=e.clone()).fov=t.camera.fov,e.position=s,Zd(t,null,e,i))}async function Kd(t,e,i,s,r,o){if(w(i))throw new n("createfromcenter","invalid point");o.targetGeometry=i.clone();const a=Lu(t);if(e.position)return function(t,e,i,s,n,r){const o=t.renderSpatialReference;return Ee(i.position,rp,o),Ee(e,op,o),r.targetGeometry=new m(e),n.position=new m(i.position),ts(np,op,rp),_d(t,rp,np,s.up,n),r.scale=Pd(t,cs(rp,op),r.targetGeometry.latitude),r.rotation=Bd(n.heading),r.camera=n,r}(t,o.targetGeometry,e,a,s,o);if(e.zoomFactor){const s=a.distance/e.zoomFactor,n=Yi(Jd,a.viewForward,-s);a.eye=Ki(Jd,a.center,n),o.scale=Pd(t,s,i.latitude)}Md(t,a,s);const h=Hd(s,e)?0:1;if(!e.zoomFactor){o.scale=Ud(t,e),null==o.scale&&(Ee(i,Jd,t.renderSpatialReference),o.scale=er(a.frustum,Jd)?Pd(t,cs(a.eye,Jd),i.latitude):Vd(t,a));const n=new jd(r);Td(t,o.targetGeometry,o.scale,s,h,n),o.camera=await n.resolver.promise}return o}function $d(t){return t&&p(t.camera)&&(t.rotation=Bd(t.camera.heading)),t}const Jd=js(),tp=gn(),ep=pn(),ip=Sn(),sp=Ln(),np=js(),rp=js(),op=js(),ap={heading:0,tilt:0},hp=new m,lp={point(t,e,i){i[0]=t.x,i[1]=t.y,t.hasZ&&(i[2]=t.z),e(i)},polygon(t,e,i){const s=t.hasZ;for(let n=0;n<t.rings.length;n++){const r=t.rings[n];for(let t=0;t<r.length;t++)i[0]=r[t][0],i[1]=r[t][1],s&&(i[2]=r[t][2]),e(i)}},polyline(t,e,i){const s=t.hasZ;for(let n=0;n<t.paths.length;n++){const r=t.paths[n];for(let t=0;t<r.length;t++)i[0]=r[t][0],i[1]=r[t][1],s&&(i[2]=r[t][2]),e(i)}},multipoint(t,e,i){const s=t.points,n=t.hasZ;for(let t=0;t<s.length;t++)i[0]=s[t][0],i[1]=s[t][1],n&&(i[2]=s[t][2]),e(i)},extent(t,e,i){t.hasZ?(e(ds(i,t.xmin,t.ymin,t.zmin)),e(ds(i,t.xmax,t.ymin,t.zmin)),e(ds(i,t.xmin,t.ymax,t.zmin)),e(ds(i,t.xmax,t.ymax,t.zmin)),e(ds(i,t.xmin,t.ymin,t.zmax)),e(ds(i,t.xmax,t.ymin,t.zmax)),e(ds(i,t.xmin,t.ymax,t.zmax)),e(ds(i,t.xmax,t.ymax,t.zmax))):(e(ds(i,t.xmin,t.ymin,i[2])),e(ds(i,t.xmax,t.ymin,i[2])),e(ds(i,t.xmin,t.ymax,i[2])),e(ds(i,t.xmax,t.ymax,i[2])))},mesh(t,e,i){const s=t.vertexAttributes&&t.vertexAttributes.position;if(s)for(let t=0;t<s.length;t+=3)e(ds(i,s[t+0],s[t+1],s[t+2]))}};var cp;let up=cp=class extends h{constructor(){super(...arguments),this.text=""}clone(){return new cp({text:this.text})}};r([o({type:String,json:{write:!0}})],up.prototype,"text",void 0),up=cp=r([a("esri.webscene.support.Description")],up);const dp=up;var pp;let fp=pp=class extends T{constructor(t){super(t),this.type="cloudy",this.cloudCoverage=.5}clone(){return new pp({cloudCoverage:this.cloudCoverage})}};r([ki({cloudy:"cloudy"})],fp.prototype,"type",void 0),r([o({type:Number,nonNullable:!0,range:{min:0,max:1}})],fp.prototype,"cloudCoverage",void 0),fp=pp=r([a("esri.view.3d.environment.CloudyWeather")],fp);const gp=fp;var mp;let vp=mp=class extends T{constructor(t){super(t),this.type="foggy",this.fogStrength=.5}clone(){return new mp({fogStrength:this.fogStrength})}};r([ki({foggy:"foggy"})],vp.prototype,"type",void 0),r([o({type:Number,nonNullable:!0,range:{min:0,max:1}})],vp.prototype,"fogStrength",void 0),vp=mp=r([a("esri.view.3d.environment.FoggyWeather")],vp);const yp=vp;var wp;let xp=wp=class extends T{constructor(t){super(t),this.type="rainy",this.cloudCoverage=.5}clone(){return new wp({cloudCoverage:this.cloudCoverage})}};r([ki({rainy:"rainy"})],xp.prototype,"type",void 0),r([o({type:Number,nonNullable:!0,range:{min:0,max:1}})],xp.prototype,"cloudCoverage",void 0),xp=wp=r([a("esri.view.3d.environment.RainyWeather")],xp);const bp=xp;var Cp;let Mp=Cp=class extends T{constructor(t){super(t),this.type="sunny",this.cloudCoverage=.5}clone(){return new Cp({cloudCoverage:this.cloudCoverage})}};r([ki({sunny:"sunny"})],Mp.prototype,"type",void 0),r([o({type:Number,nonNullable:!0,range:{min:0,max:1}})],Mp.prototype,"cloudCoverage",void 0),Mp=Cp=r([a("esri.view.3d.environment.SunnyWeather")],Mp);const Sp={key:"type",base:null,typeMap:{sunny:Mp,cloudy:gp,rainy:bp,foggy:yp}};var Pp;let Tp=Pp=class extends h{constructor(){super(...arguments),this.lighting=new mu,this.weather=null}clone(){return new Pp({lighting:mu.prototype.clone.call(this.lighting),weather:p(this.weather)?this.weather.clone():null})}};var Ap;r([o({type:mu,json:{write:!0}})],Tp.prototype,"lighting",void 0),r([o({types:Sp,json:{write:!1}})],Tp.prototype,"weather",void 0),Tp=Pp=r([a("esri.webscene.Environment")],Tp);let _p=Ap=class extends h{constructor(){super(...arguments),this.opacity=null}clone(){return new Ap({opacity:this.opacity})}cloneAndApplyTo(t){return null==this.opacity||((t=null!=t?t.clone():new te).opacity=this.opacity),t}static fromGround(t){return new Ap({opacity:t.opacity})}};r([o({type:Number,json:{type:A,read:{reader:yo,source:"transparency"},write:{writer:(t,e)=>{e.transparency=wo(t)},target:"transparency"}}})],_p.prototype,"opacity",void 0),_p=Ap=r([a("esri.webscene.support.SlideGround")],_p);const Dp=_p;var Op;let Rp=Op=class extends h{constructor(t){super(t),this.id="",this.sublayerIds=null}clone(){return new Op({id:this.id,sublayerIds:u(this.sublayerIds)})}};r([o({type:String,json:{write:!0}})],Rp.prototype,"id",void 0),r([o({type:[A],json:{read:{source:"subLayerIds"},write:{target:"subLayerIds"}}})],Rp.prototype,"sublayerIds",void 0),Rp=Op=r([a("esri.webscene.support.SlideVisibleLayer")],Rp);const Fp=Rp;var zp;let Lp=zp=class extends h{constructor(){super(...arguments),this.text=""}clone(){return new zp({text:this.text})}};r([o({type:String,json:{write:{isRequired:!0}}})],Lp.prototype,"text",void 0),Lp=zp=r([a("esri.webscene.support.Title")],Lp);const Ep=Lp;let Ip=0;const Vp=_.ofType(Fp),jp=y.getLogger("esri.webscene.Slide");let Np=class extends h{constructor(t){super(t),this.id=Date.now().toString(16)+"-slide-"+Ip++,this.title=new Ep,this.description=new dp,this.thumbnail=new vo,this.viewpoint=null,this.basemap=null,this.ground=null,this.environment=new Tp,this.visibleLayers=new Vp}destroy(){this.visibleLayers.removeAll(),this.basemap=null,this.thumbnail&&this.thumbnail.destroy(),this.description=null,this.title=null,this.thumbnail=null}castTitle(t){return"string"==typeof t?new Ep({text:t}):O(Ep,t)}castDescription(t){return"string"==typeof t?new dp({text:t}):O(dp,t)}castThumbnail(t){return"string"==typeof t?new vo({url:t}):O(vo,t)}castBasemap(t){return Zs(t)}set visibleLayers(t){this._set("visibleLayers",Te(t,this._get("visibleLayers"),Vp))}castVisibleLayers(t){return t&&"function"==typeof t.map?t.map((t=>{if("string"==typeof t)return{id:t};if(t instanceof Us){const e=Bp(t);return{id:t.id,sublayerIds:e}}return t.id?{id:t.id,sublayerIds:t.sublayerIds}:(jp.warn('Invalid visible layer, expected { id }, Layer or "id"'),t)})):null}clone(){return new this.constructor({id:this.id,title:this.title.clone(),thumbnail:this.thumbnail.clone(),description:this.description&&this.description.clone()||null,viewpoint:this.viewpoint&&this.viewpoint.clone()||null,basemap:this.basemap&&this.basemap.clone()||null,ground:this.ground&&this.ground.clone()||null,visibleLayers:this.visibleLayers.clone(),environment:this.environment&&this.environment.clone()||null})}_updateVisibleLayersFrom(t){const e=[];return M(this._getLayers(t.map).map((i=>t.whenLayerView(i).then((t=>{if(t.visible){const s=Bp(i);e.push(new Fp({id:t.layer.id,sublayerIds:s}))}})))).toArray()).then((()=>{this.visibleLayers.removeAll(),this.visibleLayers.addMany(e)}))}updateFrom(t,e){return e={screenshot:{format:"png",quality:80,width:120,height:75,disableDecorations:!0,...e&&e.screenshot}},t.when((()=>(this.viewpoint=t.viewpoint.clone(),this.environment.lighting=mu.prototype.clone.apply(t.environment.lighting),this.environment.weather=p(t.environment.weather)?t.environment.weather.clone():null,this.basemap=t.map.basemap&&t.map.basemap.clone()||null,this.ground=t.map.ground?Dp.fromGround(t.map.ground):null,this._updateVisibleLayersFrom(t)))).then((()=>t.takeScreenshot(e.screenshot))).then((t=>(this.thumbnail=new vo({url:t.dataUrl}),this)))}async applyTo(t,e){p(this._applyToController)&&this._applyToController.abort();let i=new AbortController;this._applyToController=i;const s=R(e,(()=>i.abort())),n=t.resourceController.scheduler.registerTask(po.SLIDE);let r=!1;e={animate:!0,...e,signal:this._applyToController.signal};const o=await Zi(t.addUpdatingPromise((async()=>{await z([n.schedule((()=>r=this._setViewpointOfInterest(t,e))),n.schedule((()=>this._applyBasemap(t,e)),e.signal)]),await z([n.schedule((()=>this._applyLayerVisibility(t)),e.signal),n.schedule((()=>this._applyGround(t)),e.signal),n.schedule((()=>this._applyWeather(t)),e.signal),n.schedule((()=>this._applyViewpoint(t,e)),e.signal)])})()));if(r&&(t.contentCamera=null),n.remove(),this._applyToController===i&&(this._applyToController=null),i=null,null==s||s.remove(),!1===o.ok)throw o.error;return this}async _applyBasemap(t,e){if(this.basemap){try{await this.basemap.load(e)}catch(t){if(F(t))throw t}t.map.basemap=Qs(this.basemap,t.map.basemap)}}_applyGround(t){this.ground&&(t.map.ground=this.ground.cloneAndApplyTo(t.map.ground))}_getLayers(t){const e=new _;return this._collectLayers(t,e),this._collectLayers(t.ground,e),e}_collectLayers(t,e){t.layers.forEach((t=>{Hs(t)&&(e.add(t),"layers"in t&&this._collectLayers(t,e))}))}_applyLayerVisibility(t){this.visibleLayers&&this._getLayers(t.map).forEach((t=>{const e=this.visibleLayers.find((e=>e.id===t.id));t.visible=null!=e;const i=e&&e.sublayerIds,s=kp(t);i&&s&&s.forEach((t=>t.visible=i.indexOf(t.id)>=0))}))}_setViewpointOfInterest(t,e){if(t.state.fixedContentCamera||!this.viewpoint||e.ignoreViewpoint||!e.useDestinationCamera)return!1;const i=qd(t,this.viewpoint);return t.contentCamera=i,p(i)}_applyWeather(t){this.environment.weather!==t.environment.weather&&(t.environment.weather=p(this.environment.weather)?this.environment.weather.clone():null)}async _applyViewpoint(t,e){if(this.viewpoint&&!e.ignoreViewpoint){if(p(this.viewpoint.camera)&&(this.viewpoint.camera.fov=t.camera.fov),e.animate&&this.get("environment.lighting.date"))return void await this._animateToLighting(t,e);e.animate&&(t.environment.applyLighting(this.environment.lighting.clone()),await t.goTo(this.viewpoint,e)),t.viewpoint=this.viewpoint}t.environment.applyLighting(this.environment.lighting.clone())}async _animateToLighting(t,e){let i=null;"global"===t.viewingMode&&(i=this._animateLightingWithCamera(t)),t.environment.lighting.cameraTrackingEnabled=!1,t.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled,null!=this.environment.lighting.displayUTCOffset&&(t.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset);const s=t.goTo(this.viewpoint,e),n=()=>{i&&i.remove(),t.environment.lighting.cameraTrackingEnabled=!0};return s.then((()=>{t.environment.applyLighting(this.environment.lighting.clone()),n()}),(t=>{throw n(),t}))}_getTime(t){return[t.getTime(),3600*t.getUTCHours()+60*t.getUTCMinutes()+t.getUTCSeconds()]}_setTime(t,e,i){return t.setTime(e),t.setUTCHours(i/3600),t.setUTCMinutes(i%3600/60),t.setUTCSeconds(i%3600%60),t}_animateLightingWithCamera(t){const e=new Date(t.environment.lighting.date.toString()),[i,s]=this._getTime(e),[n,r]=this._getTime(this.environment.lighting.date),o=function(t,e){let i=e-t;return i>43200&&(i-=86400),i<-43200&&(i+=86400),i}(s,r),a=t.renderCoordsHelper,h=js();a.toRenderCoords(t.camera.position,h);const l=js(),c=js();p(this.viewpoint.camera)&&a.toRenderCoords(this.viewpoint.camera.position,l);const u=new Date;return t.watch("camera",(e=>{a.toRenderCoords(e.position,c);const r=Ji(h,c),d=Ji(l,c);let p=0;r+d!==0&&(p=r/(r+d));const f=i+(n-i)*p,g=function(t,e){return $s(t+e,Gp)}(s,o*p);t.environment.lighting.date=this._setTime(u,f,g)}))}static createFrom(t,e){return(new this).updateFrom(t,e)}};function kp(t){if("building-scene"===t.type||"map-image"===t.type)return t.allSublayers.toArray()}function Bp(t){const e=kp(t);if(e)return e.filter((t=>t.visible)).map((t=>t.id))}r([o({type:String,json:{write:{isRequired:!0}}})],Np.prototype,"id",void 0),r([o({type:Ep,json:{default:()=>new Ep({text:""}),write:{isRequired:!0}}})],Np.prototype,"title",void 0),r([D("title")],Np.prototype,"castTitle",null),r([o({type:dp,json:{write:{overridePolicy:t=>({enabled:!(!t||!t.text)})}}})],Np.prototype,"description",void 0),r([D("description")],Np.prototype,"castDescription",null),r([o({type:vo,json:{default:()=>new vo({url:""}),write:{isRequired:!0}}})],Np.prototype,"thumbnail",void 0),r([D("thumbnail")],Np.prototype,"castThumbnail",null),r([o({type:Se,nonNullable:!0,json:{write:{isRequired:!0}}})],Np.prototype,"viewpoint",void 0),r([o({type:Hi,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],Np.prototype,"basemap",void 0),r([D("basemap")],Np.prototype,"castBasemap",null),r([o({type:Dp,json:{write:!0}})],Np.prototype,"ground",void 0),r([o({type:Vp,json:{write:{isRequired:!0}}})],Np.prototype,"visibleLayers",null),r([D("visibleLayers")],Np.prototype,"castVisibleLayers",null),r([o({type:Tp,json:{write:!0}})],Np.prototype,"environment",void 0),Np=r([a("esri.webscene.Slide")],Np);const Gp=86400,qp=_.ofType(Np);let Wp=class extends h{constructor(t){super(t),this.slides=new qp}destroy(){this.slides.forEach((t=>t.destroy())),this.slides.removeAll()}set slides(t){t&&(t=t.filter((t=>!!t.viewpoint))),this._set("slides",Te(t,this._get("slides"),qp))}clone(){return new this.constructor({slides:this.slides.clone()})}};r([o({type:qp,nonNullable:!0,json:{write:!0}}),D(Ae)],Wp.prototype,"slides",null),Wp=r([a("esri.webscene.Presentation")],Wp);const Up=Wp;var Hp;let Zp=Hp=class extends h{constructor(t){super(t)}clone(){return new Hp({name:this.name,path:this.path,title:this.title})}};r([o({type:String,json:{write:!0}})],Zp.prototype,"name",void 0),r([o({type:String,json:{write:!0}})],Zp.prototype,"path",void 0),r([o({type:String,json:{write:!0}})],Zp.prototype,"title",void 0),Zp=Hp=r([a("esri.webscene.TransportationNetwork")],Zp);const Qp=Zp;class Yp extends xo{constructor(t,e){super(t,e,"webscene")}get supportsGround(){return this.since(1,8)}get supportsVisibleElevationLayersInSlides(){return this.lessThan(1,8)}}const Xp=y.getLogger("esri.WebScene"),Kp=new Yp(1,26),$p="Web Scene",Jp="ViewingMode-Local";let tf=class extends(_e.LoadableMixin(L(Re(ee)))){constructor(t){super(t),this._handles=new E,this.applicationProperties=null,this.clippingArea=null,this.clippingEnabled=!1,this.floorInfo=null,this.heightModelInfo=null,this.sourceVersion=null,this.supportsHeightModelInfo=!0,this.transportationNetworks=null,this.presentation=new Up,this.initialViewProperties=new Ru,this.portalItem=null,this.resourceInfo=null,this.debouncedSaveOperations=I((async(t,e,i)=>{switch(t){case 0:return this._saveImpl(e);case 1:return this._saveAsImpl(i,e)}})),this.resourceReferences={portalItem:null,paths:[]},this.authoringApp=null,this.authoringAppVersion=null,this._isAuthoringAppSetByUser=!1,this._isAuthoringAppVersionSetByUser=!1}initialize(){if(this.when().catch((t=>{Xp.error("#load()","Failed to load web scene",t)})),this.resourceInfo){let t;try{t=this._validateJSON(this.resourceInfo)}catch(t){return void this.addResolvingPromise(Promise.reject(t))}this.read(t),this.addResolvingPromise(this._validateSpatialReference()),this.addResolvingPromise(this._validateHeightModelInfo())}this._handles.add(this.allLayers.on("change",(()=>this._scheduleLayersIdGC())))}destroy(){this._unscheduleLayersIdGC(),this._handles.destroy(),this.presentation&&this.presentation.destroy();const t=this.portalItem;this.portalItem=null,null==t||t.destroy()}writeClippingArea(t,e){e.clippingArea||(e.clippingArea={}),e.clippingArea.geometry=t.toJSON()}readClippingEnabled(t,e){return!!e.clippingArea&&!!e.clippingArea.clip}writeClippingEnabled(t,e){this.clippingArea&&(e.clippingArea||(e.clippingArea={}),e.clippingArea.clip=t)}writeLayers(t,e,i,s){const n={...s,layerContainerType:"operational-layers"},r=t.map((t=>this.verifyWriteLayer(t,s)?t.write({},n):null)).filter((t=>!!t));e[i]=r.toArray()}verifyWriteLayer(t,e){return"write"in t||(e&&e.messages&&e.messages.push(new n("layer:unsupported",`Layers (${t.title}, ${t.id}) of type '${t.declaredClass}' cannot be persisted in web scenes`,{layer:t})),!1)}readSourceVersion(t,e){const[i,s]=e.version.split(".");return new Yp(parseInt(i,10),parseInt(s,10))}writeSourceVersion(t,e,i){e[i]=`${Kp.major}.${Kp.minor}`}get thumbnailUrl(){return this.portalItem&&this.portalItem.thumbnailUrl||null}set thumbnailUrl(t){t?this._override("thumbnailUrl",t):(this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"))}set authoringApp(t){this._isAuthoringAppSetByUser=!0,this._set("authoringApp",t)}writeAuthoringApp(t,e){e.authoringApp=t&&this._isAuthoringAppSetByUser?t:"ArcGIS API for JavaScript"}set authoringAppVersion(t){this._isAuthoringAppVersionSetByUser=!0,this._set("authoringAppVersion",t)}writeAuthoringAppVersion(t,e){e.authoringAppVersion=t&&this._isAuthoringAppVersionSetByUser?t:V}writeGround(t,e,i,s){e[i]=t?t.write({},s):{transparency:0,layers:[]}}readInitialViewProperties(t,e){const i={};return e.initialState&&e.initialState.environment&&(i.environment=_u.fromJSON(e.initialState.environment)),i.spatialReference=e.spatialReference?d.fromJSON(e.spatialReference):d.WebMercator,i.viewingMode=e.viewingMode||"global",e.initialState&&e.initialState.viewpoint&&(i.viewpoint=Se.fromJSON(e.initialState.viewpoint)),new Ru(i)}get spatialReference(){var t,e;return null!=(t=null==(e=this.initialViewProperties)?void 0:e.spatialReference)?t:d.WebMercator}get viewingMode(){var t,e;return null!=(t=null==(e=this.initialViewProperties)?void 0:e.viewingMode)?t:"global"}load(t){return this.addResolvingPromise(this._loadFromSource()),Promise.resolve(this)}loadAll(){return Oe(this,(t=>{const e=this.presentation&&this.presentation.slides;t(this.ground,this.basemap,this.layers,e&&e.map((t=>t.basemap)))}))}read(t,e){e={...e,origin:"web-scene"};const i=this._isAuthoringAppVersionSetByUser,s=this._isAuthoringAppSetByUser;if(j(this,t,(e=>super.read(t,e)),e),s||(this._isAuthoringAppSetByUser=!1),i||(this._isAuthoringAppVersionSetByUser=!1),t.baseMap&&Array.isArray(t.baseMap.elevationLayers)&&this.sourceVersion.supportsVisibleElevationLayersInSlides){const e=t.baseMap.elevationLayers.map((t=>({id:t.id}))),i=this.presentation.slides,s=(t,e)=>t.visibleLayers.some((t=>t.id===e)),n=e.filter((t=>!i.some((e=>s(e,t.id)))));i.forEach((t=>{t.visibleLayers.addMany(n)}))}}_writeBasemapElevationLayers(t){const e=t.ground&&t.ground.layers;!t.baseMap&&e&&e.length&&(t.baseMap={title:"Basemap",baseMapLayers:[]}),t.baseMap&&(t.baseMap.elevationLayers=u(e))}write(t,e){var i;if("loaded"!==this.loadStatus){const t=new n("webscene:not-loaded","Web scene must be loaded before it can be serialized");throw Xp.error("#toJSON()","Web scene must be loaded before it can be serialized",this.loadError||this.loadStatus),t}this._runLayersIdGC();const s=!(null!=(i=e)&&i.messages);e={messages:[],...e,origin:"web-scene"};const r=super.write(t,e);if(s){const t=e.messages.filter((t=>"web-document-write:property-required"===t.name));if(t.length){const e=new n("web-document:property-required","One or more properties that are required in the webscene JSON are missing, see details for the specific errors",{errors:t});throw Xp.error("#toJSON()","One or more properties that are required in the webscene JSON are missing",t),e}}return this._writeBasemapElevationLayers(r),r}async save(t){return this.debouncedSaveOperations(0,t)}async _saveImpl(t){this.portalItem||(Xp.error("save(): requires the .portalItem property to be set"),await Promise.reject(new n("webscene:portal-item-not-set","Portal item to save to has not been set on the WebScene"))),this.portalItem.type!==$p&&await Promise.reject(new n("webscene:portal-item-wrong-type",`Portal item needs to have type "${$p}"`));const e=this._updateFromPromise;await this._ensureLoadBeforeSave();const i=this._enableVerifyItemRelativeUrls({origin:"web-scene",url:this.portalItem.itemUrl&&N(this.portalItem.itemUrl),messages:[],portal:this.portalItem.portal||De.getDefault(),portalItem:this.portalItem,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}}),s=this.write({},i);return await Promise.all(i.resources.pendingOperations),await this._verifySave(s,i,t),this._updateTypeKeywords(this.portalItem),await this.portalItem.update({data:s}),await ji(this.resourceReferences,i,null),ze(i),e&&await e,await this._saveThumbnail(),this.portalItem}async saveAs(t,e){return this.debouncedSaveOperations(1,e,t)}async _saveAsImpl(t,e){let i=Xe.from(t);i||(Xp.error("saveAs(portalItem): requires a portal item parameter"),await Promise.reject(new n("webscene:portal-item-required","saveAs requires a portal item to save to"))),i.id&&(i=i.clone(),i.id=null);const s=i.portal||De.getDefault();await this._ensureLoadBeforeSave(),i.type=$p,i.portal=s;const r=this._enableVerifyItemRelativeUrls({origin:"web-scene",url:null,messages:[],portal:s,portalItem:i,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}}),o=this.write({},r);await Promise.all(r.resources.pendingOperations),await this._verifySaveAs(o,r,e);const a=this.thumbnailUrl,h=!this._isOverridden("thumbnailUrl");return this._updateTypeKeywords(i),await s._signIn(),await s.user.addItem({item:i,folder:e&&e.folder,data:o}),await ji(this.resourceReferences,r,null),this.portalItem=i,Fe.prototype.read.call(this,{version:o.version,authoringApp:o.authoringApp,authoringAppVersion:o.authoringAppVersion},{name:"web-scene",ignoreDefaults:!0,url:i.itemUrl&&N(i.itemUrl)}),ze(r),a&&(this.thumbnailUrl=h?k(a,"w","8192"):a),r.portalItem=i,await this._saveThumbnail(),i}async _saveThumbnail(){this._isOverridden("thumbnailUrl")&&(await this.portalItem.updateThumbnail({thumbnail:this.thumbnailUrl}),this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"))}_verifySave(t,e,i,s=!1){if(!B(this.spatialReference))return Promise.reject(new n("webscene:unsupported-spatial-reference","Webscenes using spatial reference systems from Mars or Moon can not be saved currently."));let r,o=e.messages.filter((t=>"error"===t.type)).map((t=>new n(t.name,t.message,t.details)));e.blockedRelativeUrls&&(o=o.concat(e.blockedRelativeUrls.map((t=>new n("url:unsupported",`Relative url '${t}' is not supported in Web Scene`))))),i&&i.ignoreUnsupported&&(o=o.filter((t=>"layer:unsupported"!==t.name&&"symbol:unsupported"!==t.name&&"symbol-layer:unsupported"!==t.name&&"property:unsupported"!==t.name&&"url:unsupported"!==t.name&&"scenemodification:unsupported"!==t.name))),null!=i&&i.requiredPropertyChecksDisabled&&(o=o.filter((t=>"web-document-write:property-required"!==t.name)));const a=i&&i.strictSchemaValidationEnabled;return r=a?import("./p-42e11afb.js").then((e=>{const i=e.validate(t);if(i.length>0){const t=`webscene did not validate:\n${i.join("\n")}`;Xp.error(`${s?"saveAs":"save"}(): ${t}`)}return i.map((t=>new n("webscene:schema-validation",t)))})).then((t=>{if(a&&t.length>0)throw function(t){return new n("webscene:schema-validation","Failed to save webscene due to schema validation errors. See 'details.errors' for more detailed information",{errors:t})}(t.concat(o));return o})):Promise.resolve(o),r.then((t=>{if(t.length>0)return Promise.reject(new n("webscene:save","Failed to save webscene due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:t}))}))}_verifySaveAs(t,e,i){return this.canNotSaveAs(e)?Promise.reject(new n("webscene:failed-to-copy-embedded-resources","Copying of embedded resources is currently not supported")):this._verifySave(t,e,i,!0)}verifySaveAs(t){const e=this._enableVerifyItemRelativeUrls({origin:"web-scene",messages:[]}),i=this.write({},e);return this._verifySaveAs(i,e,t)}canNotSaveAs(t){return t||(t=this._enableVerifyItemRelativeUrls({origin:"web-scene",messages:[]}),this.write({},t)),t.verifyItemRelativeUrls&&t.verifyItemRelativeUrls.writtenUrls.length>0}async updateFrom(t,e={}){const i=this._updateFromInternal(t,e);this._updateFromPromise=i,await i,this._updateFromPromise===i&&(this._updateFromPromise=null)}async _updateFromInternal(t,e={}){if(await t.whenReady(),!e.environmentExcluded&&t.environment&&(this.initialViewProperties.environment=_u.prototype.clone.apply(t.environment)),!e.viewpointExcluded&&t.viewpoint&&(this.initialViewProperties.viewpoint=t.viewpoint.clone()),this.initialViewProperties.spatialReference=t.spatialReference.clone(),this.initialViewProperties.viewingMode=t.viewingMode,p(t.clippingArea)?t.clippingArea!==this.clippingArea&&(this.clippingArea=t.clippingArea.clone(),this.clippingEnabled=!0):this.clippingEnabled=!1,t.heightModelInfo&&(this.heightModelInfo=t.heightModelInfo.clone()),t.map===this)for(const e of t.allLayerViews){const t="visible";t in e&&t in e.layer&&e._isOverridden(t)&&(e.layer[t]=e[t])}(!1===e.thumbnailExcluded||null==e.thumbnailExcluded&&!e.viewpointExcluded)&&await this._updateFromThumbnail(t,e.thumbnailSize||void 0)}async _updateFromThumbnail(t,e){const i=ti(t,e),s=await t.takeScreenshot({format:"jpg",width:i.width,height:i.height,disableDecorations:!0});this.thumbnailUrl=s.dataUrl}_loadFromSource(){return this.resourceInfo?this._loadFromJSON(this.resourceInfo,{origin:"web-scene"}):this.portalItem&&this.portalItem.id?this._loadFromItem(this.portalItem):this._loadObjectsWithLayers()}_readAndLoadFromJSON(t,e){const i=this._validateJSON(t);return this.read(i,e),this._loadFromJSON(i,e)}_extractOperationalLayers(t){const e=[];if(!this.sourceVersion.supportsGround&&t.baseMap&&Array.isArray(t.baseMap.elevationLayers))for(const i of t.baseMap.elevationLayers)e.push(i);const i=[],s=t=>(t.layers&&(t.layers=t.layers.filter(s)),"ArcGISTiledElevationServiceLayer"!==t.layerType||(this.sourceVersion.supportsGround||i.push(t),!1));return{operationalLayers:t.operationalLayers?t.operationalLayers.filter(s):[],operationalElevationLayers:i,basemapElevationLayers:e}}_loadFromJSON(t,e){const i=new _;return this._validateSpatialReference().then((()=>this._validateHeightModelInfo())).then((()=>import("./p-c39ae740.js"))).then((({populateOperationalLayers:s})=>{const{operationalLayers:n,operationalElevationLayers:r,basemapElevationLayers:o}=this._extractOperationalLayers(t),a=[],h={context:{...e,layerContainerType:"operational-layers"}};if(this.portalItem&&(h.context.portal=this.portalItem.portal||De.getDefault()),o.length>0){const t={...h,context:{...h.context,layerContainerType:"ground"}};t.defaultLayerType="ArcGISTiledElevationServiceLayer",a.push(s(this.ground.layers,o,t))}if(r.length>0){const t={...h,context:{...h.context,layerContainerType:"ground"}};t.defaultLayerType="ArcGISTiledElevationServiceLayer",a.push(s(i,r,t))}return n&&n.length>0&&a.push(s(this.layers,n,h)),M(a).then((()=>{}))})).then((()=>this._loadObjectsWithLayers())).then((()=>{this.ground.layers.addMany(i)}))}async _ensureLoadBeforeSave(){await this.load(),await this._loadObjectsWithLayers();const t=[];for(const e of this.allLayers.items)if("beforeSave"in e&&"function"==typeof e.beforeSave){const i=e.beforeSave();i&&t.push(i)}await M(t)}async _loadObjectsWithLayers(){const t=[];this.ground&&t.push(this.ground.load()),this.basemap&&t.push(this.basemap.load()),this.presentation.slides.forEach((e=>{e.basemap&&t.push(e.basemap.load())})),await M(t)}async _loadFromItem(t){if(await t.load().catch((t=>{throw new n("webscene:load-portal-item","Failed to load portal item",{error:t})})),"Web Scene"!==t.type)throw new n("webscene:invalid-portal-item","Invalid portal item type '${type}', expected 'Web Scene'",{type:t.type});const e=await t.fetchData();this.resourceInfo=e;const i={origin:"web-scene",url:N(t.itemUrl),portal:t.portal||De.getDefault(),portalItem:t,readResourcePaths:[]};await this._readAndLoadFromJSON(e,i),this.resourceReferences={portalItem:t,paths:i.readResourcePaths}}_validateSpatialReference(){const t=this.initialViewProperties,e=this._sceneSpatialReference;let i;if("local"!==t.viewingMode){if(!$e(e,"global"))return Promise.reject(new n("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in global mode, only Web Mercator, WGS84 GCS or CGCS2000 are supported",{spatialReference:e,viewingMode:t.viewingMode}));i=t=>!t||Be(t,e)}else{if(!$e(e,"local"))return Promise.reject(new n("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in local mode, only projected coordinate systems are supported",{spatialReference:e,viewingMode:t.viewingMode}));i=t=>!t||t.equals(e)}const s=t=>t&&(p(t.camera)&&t.camera.position&&t.camera.position.spatialReference||p(t.targetGeometry)&&t.targetGeometry.spatialReference),r=s(t.viewpoint);if(r&&!i(r))return Promise.reject(new n("webscene:incompatible-camera-spatial-reference","Camera spatial reference (${cameraSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{cameraSpatialReference:r,sceneSpatialReference:e,viewingMode:t.viewingMode}));const o=this.presentation.slides.find((t=>!i(s(t.viewpoint))));if(o){const i=s(o.viewpoint);return Promise.reject(new n("webscene:incompatible-slide-spatial-reference","Slide spatial reference (${slideSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{slideSpatialReference:i,sceneSpatialReference:e,viewingMode:t.viewingMode}))}return Promise.resolve()}_validateHeightModelInfo(){const t=Qe(this.heightModelInfo,this._sceneSpatialReference);return t?Promise.reject(t):Promise.resolve()}_validateJSON(t){const e=Yp.parse(t.version||"","webscene");return Kp.validate(e),t.version=`${e.major}.${e.minor}`,1===e.major&&e.minor<=2&&(t.spatialReference=d.WebMercator.toJSON()),t}_updateTypeKeywords(t){"local"===this.initialViewProperties.viewingMode?t.typeKeywords?-1===t.typeKeywords.indexOf(Jp)&&t.typeKeywords.push(Jp):t.typeKeywords=[Jp]:"global"===this.initialViewProperties.viewingMode&&t.typeKeywords&&(t.typeKeywords=t.typeKeywords.filter((t=>t!==Jp))),t.typeKeywords&&(t.typeKeywords=t.typeKeywords.filter(((t,e,i)=>i.indexOf(t)===e)))}get _sceneSpatialReference(){return this.initialViewProperties.spatialReference||d.WebMercator}get _verifyItemRelativeRootPath(){return this.portalItem&&this.portalItem.itemUrl?N(this.portalItem.itemUrl).path:null}_enableVerifyItemRelativeUrls(t){const e=this._verifyItemRelativeRootPath;return e&&(t.verifyItemRelativeUrls={rootPath:e,writtenUrls:[]}),t}_unscheduleLayersIdGC(){this._layersIdGCTimeoutId&&(clearTimeout(this._layersIdGCTimeoutId),this._layersIdGCTimeoutId=0)}_scheduleLayersIdGC(){this._unscheduleLayersIdGC(),this._layersIdGCTimeoutId=setTimeout((()=>{this._layersIdGCTimeoutId=0,this._runLayersIdGC()}),3e3)}_runLayersIdGC(){this._unscheduleLayersIdGC();const t=this.applicationProperties&&this.applicationProperties.viewing&&this.applicationProperties.viewing.search,e=t=>!!this.allLayers.find((e=>e.id===t));t&&t.layers&&(t.layers=t.layers.filter((t=>e(t.id))));const i=this.presentation&&this.presentation.slides;i&&i.forEach((t=>{t.visibleLayers&&(t.visibleLayers=t.visibleLayers.filter((t=>e(t.id))))}))}static fromJSON(t){if(!t)throw new n("webscene:empty-resource","Expected a JSON resource but got nothing");return new this({resourceInfo:t})}};tf.VERSION=Kp,r([o({type:pu,json:{write:!0}})],tf.prototype,"applicationProperties",void 0),r([o({json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],tf.prototype,"basemap",void 0),r([o({type:g,json:{read:{source:"clippingArea.geometry",reader:Ye},write:{target:"clippingArea.geometry"}}})],tf.prototype,"clippingArea",void 0),r([c("clippingArea")],tf.prototype,"writeClippingArea",null),r([o({type:Boolean,json:{write:{target:"clippingArea.clip"}}})],tf.prototype,"clippingEnabled",void 0),r([l("clippingEnabled",["clippingArea"])],tf.prototype,"readClippingEnabled",null),r([c("clippingEnabled")],tf.prototype,"writeClippingEnabled",null),r([o({type:Je,json:{read:{source:"mapFloorInfo"},write:{target:"mapFloorInfo"}}})],tf.prototype,"floorInfo",void 0),r([o({type:Le,json:{write:!0}})],tf.prototype,"heightModelInfo",void 0),r([o({json:{write:{target:"operationalLayers",ignoreOrigin:!0}}})],tf.prototype,"layers",void 0),r([c("layers")],tf.prototype,"writeLayers",null),r([o({readOnly:!0,type:Yp,json:{type:(()=>{const t=[],e=Kp.major;for(let i=8;i<=Kp.minor;i++)t.push(`${e}.${i}`);return t})(),write:{ignoreOrigin:!0,target:"version",isRequired:!0,overridePolicy:()=>({enabled:!0,allowNull:!0,ignoreOrigin:!0})}}})],tf.prototype,"sourceVersion",void 0),r([l("sourceVersion",["version"])],tf.prototype,"readSourceVersion",null),r([c("sourceVersion")],tf.prototype,"writeSourceVersion",null),r([o({json:{read:!1,write:!1}})],tf.prototype,"tables",void 0),r([o()],tf.prototype,"thumbnailUrl",null),r([o({type:String,json:{write:{writerEnsuresNonNull:!0,ignoreOrigin:!0}}})],tf.prototype,"authoringApp",null),r([c("authoringApp")],tf.prototype,"writeAuthoringApp",null),r([o({type:String,json:{write:{writerEnsuresNonNull:!0,ignoreOrigin:!0}}})],tf.prototype,"authoringAppVersion",null),r([c("authoringAppVersion")],tf.prototype,"writeAuthoringAppVersion",null),r([o({json:{write:{isRequired:!0,allowNull:!0,ignoreOrigin:!0,enabled:!0}}})],tf.prototype,"ground",void 0),r([c("ground")],tf.prototype,"writeGround",null),r([o({type:_.ofType(Qp),json:{write:!0}})],tf.prototype,"transportationNetworks",void 0),r([o({type:Up,nonNullable:!0,json:{write:{ignoreOrigin:!0,writer:(t,e,i,s)=>{if(t.slides&&t.slides.length>0){const i={...s,isPresentation:!0};e.presentation=t.write({},i)}}}}})],tf.prototype,"presentation",void 0),r([o({type:Ru,nonNullable:!0,json:{write:{target:"initialState",isRequired:!0,ignoreOrigin:!0},default:()=>new Ru({viewingMode:"global",spatialReference:d.WebMercator})}})],tf.prototype,"initialViewProperties",void 0),r([l("initialViewProperties",["initialState.environment","spatialReference","viewingMode","initialState.viewpoint"])],tf.prototype,"readInitialViewProperties",null),r([o({type:d,json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],tf.prototype,"spatialReference",null),r([o({type:["local","global"],json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],tf.prototype,"viewingMode",null),r([o({type:Xe})],tf.prototype,"portalItem",void 0),r([o()],tf.prototype,"resourceInfo",void 0),tf=r([a("esri.WebScene")],tf);const ef=tf;function sf(t,e,i=function(t){return{operations:t,value:t.create()}}(t)){return i.operations=t,t.copy(e,i.value),i}const nf=2**50;function rf(t,e,i,s){return t.operations.setAltitudeAt(t.value,e,i,s)}function of(t,e,i){return t.operations.elevate(t.value,e,i.value)}const af=js();function hf(t,e,i,s,n){return n[0]=es(t,e),n[1]=es(t,i),n[2]=es(t,s),n}function lf(t,e,i,s,n){$i(i,t),$i(cf,e),is(cf,cf),ss(s,cf,i),ss(n,s,i)}const cf=js(),uf=y.getLogger("esri.views.support.GroundViewElevationSampler");let df=class extends G.EventedAccessor{constructor(t){super(t),this.demResolution={min:-1,max:-1},this.noDataValue=ei}initialize(){this.view.basemapTerrain.on("elevation-change",(()=>this.emit("changed",{})))}get extent(){const t=this.view.basemapTerrain;return p(t.extent)&&t.spatialReference?En(t.extent,t.spatialReference):null}elevationAt(t){const e=t.spatialReference,i=this.spatialReference;if(!C(e,i))return uf.error(`Cannot sample elevation at a location with spatial reference (${e?e.wkid:"unknown"}) different from the view (${i.wkid})`),null;if(w(this.extent)||!q(this.extent,t)){const e=p(this.extent)?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return uf.warn("#elevationAt()",`Point used to sample elevation (${t.x}, ${t.y}) is outside of the sampler extent (${e})`),this.noDataValue}return tr(this.view.elevationProvider,t)}queryElevation(t){return ia(t.clone(),this)}};r([o({readOnly:!0})],df.prototype,"demResolution",void 0),r([o({readOnly:!0})],df.prototype,"extent",null),r([o({readOnly:!0})],df.prototype,"noDataValue",void 0),r([o({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],df.prototype,"spatialReference",void 0),r([o({constructOnly:!0})],df.prototype,"view",void 0),df=r([a("esri.views.support.GroundViewElevationSampler")],df);const pf=df;let ff=class extends T{constructor(t){super(t),this.handles=new E,this.view=null,this.layerViews=new _}initialize(){this.handles.add(W(this,"view.map.ground",(t=>t.load()))),this.handles.add(this.layerViews.on("after-changes",(()=>this.layerViewsAfterChangesHandler())))}destroy(){this._set("view",null),this.handles&&(this.handles.destroy(),this.handles=null)}get elevationSampler(){return this.view?"2d"===this.view.type?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new pf({view:this.view}):null:null}get updating(){return!this.suspended&&this.layerViews.some((t=>t.updating))}get suspended(){return!this.view||this.view.suspended}layerViewsAfterChangesHandler(){this.handles.remove("updating"),this.handles.add(this.layerViews.map((t=>t.watch("updating",(()=>this.updateUpdating()),!0))).toArray(),"updating"),this.updateUpdating()}updateUpdating(){this.notifyChange("updating")}};r([o({readOnly:!0})],ff.prototype,"elevationSampler",null),r([o({type:Boolean,readOnly:!0})],ff.prototype,"updating",null),r([o({constructOnly:!0})],ff.prototype,"view",void 0),r([o({type:_,readOnly:!0})],ff.prototype,"layerViews",void 0),r([o({readOnly:!0})],ff.prototype,"suspended",null),ff=r([a("esri.views.GroundView")],ff);const gf=ff;function mf(t){return"global"===t?1:2}const vf=()=>import("./p-73b408ba.js"),yf=()=>Promise.resolve().then((function(){return mS})),wf={analysis:()=>import("./p-07c77c1a.js"),"base-dynamic":()=>import("./p-9e53bb66.js"),"base-elevation":yf,"base-tile":vf,"bing-maps":vf,"building-scene":()=>import("./p-144e3058.js"),csv:()=>import("./p-db9d588f.js"),elevation:yf,feature:()=>import("./p-6ba3d0fc.js"),geojson:()=>import("./p-2b9354ce.js"),graphics:()=>import("./p-9d6eeb1d.js"),group:()=>import("./p-7db2c23d.js"),imagery:()=>import("./p-c3973a6c.js"),"integrated-mesh":()=>import("./p-8084c423.js"),"map-image":()=>import("./p-78c3fb0c.js"),"ogc-feature":()=>import("./p-3f009130.js"),"open-street-map":vf,"point-cloud":()=>import("./p-4d1c4e55.js").then((function(t){return t.P})),voxel:()=>import("./p-ed8f6800.js"),scene:t=>null==t.profile||"mesh-pyramids"===t.profile?import("./p-42c438d8.js"):import("./p-3a404ac5.js"),stream:()=>import("./p-31d7ec47.js"),tile:vf,"imagery-tile":()=>import("./p-0822d9f2.js"),"vector-tile":()=>import("./p-6add36d4.js"),wcs:()=>import("./p-0822d9f2.js"),"web-tile":vf,wfs:()=>import("./p-60f8997c.js"),wms:()=>import("./p-19ee985e.js"),wmts:()=>import("./p-7d10702d.js"),"geo-rss":null,kml:null,"map-notes":null,route:null,"subtype-group":null,unknown:null,unsupported:null},xf=y.getLogger("esri.views.3d.state.Constraints");let bf=class extends T{constructor(t){super(t),this.collision=new Pf,this.distance=1/0,this.minimumPoiDistance=4}get altitude(){return 2===this.mode?null:this._get("altitude")||null}set altitude(t){2!==this.mode?this._set("altitude",t):xf.warn("Altitude constraint is ignored in local scenes")}clampAltitude(t){return this.altitude?fs(t,this.altitude.min,this.altitude.max):t}clampTilt(t,e){if(!this.tilt)return e;const i=this.tilt(t);return fs(e,i.min,i.max)}clampDistance(t){return Math.min(t,this.distance)}createDefaultTilt(){return 2===this.mode?this.createDefaultTiltLocal():this.createDefaultTiltGlobal()}createConstantMaxTilt(t){return(e,i=Sf)=>(i.min=Mf.min,i.max=t,i)}createDefaultTiltLocal(){const t=this.collision.enabled?Js([[4e3,Mf.max],[1e4,as(88)],[6e6,as(88)]]):()=>Mf.max;return(e,i=Sf)=>(i.min=Mf.min,i.max=t(e),i)}createDefaultTiltGlobal(){const t=Js(this.collision.enabled?[[4e3,Mf.max],[5e4,as(88)],[6e6,as(88)],[2e7,Mf.min]]:[[3e5,Mf.max],[3e6,as(88)],[6e6,as(88)],[2e7,Mf.min]]);return(e,i=Sf)=>(i.min=Mf.min,i.max=t(e),i)}};r([o()],bf.prototype,"altitude",null),r([o({readOnly:!0})],bf.prototype,"collision",void 0),r([o()],bf.prototype,"distance",void 0),r([o({readOnly:!0})],bf.prototype,"minimumPoiDistance",void 0),r([o()],bf.prototype,"tilt",void 0),r([o({constructOnly:!0})],bf.prototype,"mode",void 0),bf=r([a("esri.views.3d.state.Constraints")],bf);const Cf={min:-2e5,max:4*U.radius},Mf={min:as(.5),max:as(179.5)},Sf={min:0,max:0};let Pf=class extends T{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};r([o({type:Boolean})],Pf.prototype,"enabled",void 0),r([o({type:Number})],Pf.prototype,"elevationMargin",void 0),Pf=r([a("esri.views.3d.state.Constraints.CollisionConstraint")],Pf);const Tf=bf;let Af=class extends T{constructor(){super(...arguments),this.min=Cf.min,this.max=Cf.max}set mode(t){H(y.getLogger(this.declaredClass),"esri.views.SceneView.constraints.altitude.mode is deprecated. The altitude constraint no longer applies to local scenes and does not have an automatic mode anymore.",{version:"4.6"})}get mode(){return H(y.getLogger(this.declaredClass),"esri.views.SceneView.constraints.altitude.mode is deprecated. The altitude constraint no longer applies to local scenes and does not have an automatic mode anymore.",{version:"4.6"}),"manual"}};r([o({type:Number})],Af.prototype,"min",void 0),r([o({type:Number})],Af.prototype,"max",void 0),Af=r([a("esri.views.3d.constraints.AltitudeConstraint")],Af);const _f=Af;let Df=class extends T{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(t){this._set("near",t),t>=this._get("far")&&(this.far=t+1e-9),this.mode="manual"}castNear(t){return Math.max(1e-8,t)}get far(){return this._get("far")}set far(t){this._set("far",t),t<=this._get("near")&&(this.near=t-1e-9),this.mode="manual"}castFar(t){return Math.max(1e-8,t)}autoUpdate(t,e){"auto"===this.mode&&(this._get("near")!==t&&this._set("near",t),this._get("far")!==e&&this._set("far",e))}};r([o({type:Number,value:1e-8})],Df.prototype,"near",null),r([D("near")],Df.prototype,"castNear",null),r([o({type:Number,value:1e-8})],Df.prototype,"far",null),r([D("far")],Df.prototype,"castFar",null),r([o({type:["auto","manual"]})],Df.prototype,"mode",void 0),Df=r([a("esri.views.3d.constraints.ClipDistanceConstraint")],Df);const Of=Df,Rf={min:ns(Mf.min),max:ns(Mf.max)};let Ff=class extends T{constructor(){super(...arguments),this.mode="auto"}get max(){return this._get("max")}set max(t){this._set("max",t),this.mode="manual"}castMax(t){return fs(t,Rf.min,Rf.max)}autoUpdate(t){"auto"===this.mode&&this._get("max")!==t&&this._set("max",t)}};r([o({type:["auto","manual"]})],Ff.prototype,"mode",void 0),r([o({type:Number,value:Rf.max})],Ff.prototype,"max",null),r([D("max")],Ff.prototype,"castMax",null),Ff=r([a("esri.views.3d.constraints.TiltConstraint")],Ff);const zf=Ff;let Lf=class extends T{constructor(){super(...arguments),this.tilt=new zf,this.altitude=new _f,this.clipDistance=new Of}};r([o({type:zf})],Lf.prototype,"tilt",void 0),r([o({type:_f})],Lf.prototype,"altitude",void 0),r([o({type:Of})],Lf.prototype,"clipDistance",void 0),Lf=r([a("esri.views.3d.constraints.Constraints")],Lf);const Ef=Lf;var If;let Vf=If=class extends T{set quality(t){-1!==["low","high"].indexOf(t)&&this._set("quality",t)}clone(){return new If({quality:this.quality})}};r([o({type:["low","high"],value:"low"})],Vf.prototype,"quality",null),Vf=If=r([a("esri.views.3d.environment.SceneViewAtmosphere")],Vf);const jf=Vf;var Nf;let kf=Nf=class extends(G.EventedMixin(mu)){constructor(t){super(t),this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0},this.cameraTrackingEnabled=!0,this.ambientOcclusionEnabled=!1,this.waterReflectionEnabled=!1;const e=(new Date).getFullYear(),i=new Date("March 15, "+e+" 12:00:00 UTC");this._set("defaultDate",i),this._set("date",i)}static fromWebsceneLighting(t){return new Nf({...t.cloneConstructProperties()})}get defaultDate(){return new Date(this._get("defaultDate").getTime())}set defaultDate(t){const e=this._get("date")===this._get("defaultDate");t=new Date(t.getTime()),this._set("defaultDate",t),e&&this._set("date",t)}set date(t){null!=t&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(t.getTime())))}autoUpdate(t,e){const i=Bf(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=e.hours,this.positionTimezoneInfo.minutes=e.minutes,this.positionTimezoneInfo.seconds=e.seconds;let s=null;null!=t&&(this.positionTimezoneInfo.autoUpdated=!0,s=this.date&&this.date.getTime(),this._set("date",new Date(t.getTime())));const n=Bf(this.positionTimezoneInfo);if(i!==n&&(Gf.target=this,Gf.timezoneOffset=n,this.emit("timezone-will-change",Gf)),null!=t)return s!==t.getTime()}clone(){const t=this._get("date")===this._get("defaultDate"),e=new Nf({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled,ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled});return t&&e._set("date",e._get("defaultDate")),e.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,e.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,e.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,e.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,e}cloneWithWebsceneLighting(t){const e=this.clone();return null!=t.date&&(e.date=t.date),e.directShadowsEnabled=t.directShadowsEnabled,e.displayUTCOffset=t.displayUTCOffset,e}};function Bf({hours:t,minutes:e,seconds:i}){return Math.round(t+e/60+i/3600)}r([o({type:Boolean})],kf.prototype,"cameraTrackingEnabled",void 0),r([o({type:Boolean})],kf.prototype,"ambientOcclusionEnabled",void 0),r([o({type:Boolean})],kf.prototype,"waterReflectionEnabled",void 0),r([o({type:Date})],kf.prototype,"defaultDate",null),r([o({type:Date})],kf.prototype,"date",null),kf=Nf=r([a("esri.views.3d.environment.SceneViewLighting")],kf);const Gf={target:null,timezoneOffset:0};var qf;let Wf=qf=class extends _u{constructor(t){super(t),this.atmosphere=new jf,this.weather=null}static fromWebsceneEnvironment(t){const e=t.cloneConstructProperties();return new qf({...e,lighting:kf.fromWebsceneLighting(e.lighting)})}castLighting(t){return this.convertLighting(t)}applyLighting(t){this.lighting=this.convertLighting(t)}convertLighting(t){return t?t instanceof kf?t:t instanceof mu?this.lighting?this.lighting.cloneWithWebsceneLighting(t):kf.fromWebsceneLighting(t):O(kf,t):new kf}clone(){return new qf({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),weather:p(this.weather)?this.weather.clone():null,atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:u(this.background)})}cloneWithWebsceneEnvironment(t){return new qf({atmosphere:this.atmosphere.clone(),weather:p(this.weather)?this.weather.clone():null,atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:u(this.background),...t.cloneConstructProperties(),lighting:null!=this.lighting?this.lighting.cloneWithWebsceneLighting(t.lighting):kf.fromWebsceneLighting(t.lighting)})}};r([o({type:jf,json:{read:!1}})],Wf.prototype,"atmosphere",void 0),r([o({types:Sp,json:{write:!1}})],Wf.prototype,"weather",void 0),r([o()],Wf.prototype,"lighting",void 0),r([D("lighting")],Wf.prototype,"castLighting",null),Wf=qf=r([a("esri.views.3d.environment.SceneViewEnvironment")],Wf);const Uf=Wf;function Hf(t){return Math.min(1,Math.max(0,(t-1e5)/9e5))}const Zf=Ns(5802e-9,13558e-9,331e-7),Qf=Ns(65e-8*3,5643e-9,255e-9);function Yf(t){const e=new Wa;return e.attributes.add("position","vec2"),e.include(Aa,{attributeTextureCoordinates:1}),e.varyings.add("worldRay","vec3"),e.varyings.add("eyeDir","vec3"),e.vertex.uniforms.add("projectionInverse","mat4"),e.vertex.uniforms.add("viewInverse","mat4"),e.vertex.code.add(Ua`void main(void) {
vec3 posViewNear = (projectionInverse * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (viewInverse * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),e.fragment.uniforms.add("lightingMainDirection","vec3").add("radii","vec2").add("scaleHeight","float").add("cameraPosition","vec3").add("nearFar","vec2").add("heightParameters","vec4").add("innerFadeDistance","float").add("altitudeFade","float").add("depthTex","sampler2D").add("betaRayleigh","vec3").add("betaCombined","vec3").add("betaMie","float"),e.include(ir),t.haze&&e.fragment.include(Ha),e.fragment.code.add(Ua`vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = planet ? heightParameters[1] - radius * radius : heightParameters[2];
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),e.fragment.code.add(Ua`float chapmanApproximation(float X, float h, float cosZenith) {
float c = sqrt(X + h);
float cExpH = c * exp(-h);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),e.fragment.code.add(Ua`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),e.fragment.code.add(Ua`
    const int STEPS = 6;

    float getGlow(float dist, float radius, float intensity) {
      return pow(radius / max(dist, 1e-6), intensity);
    }

    vec3 getAtmosphereColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      float reducedPlanetRadius = radii[0] * 0.995;
      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);
      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);
      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
      bool insideAtmosphere = heightParameters[0] < radii[1];

      if (!(hitsAtmosphere || insideAtmosphere)) {
        return vec3(0);
      }

      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;

      float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;

      if (heightParameters[0] < reducedPlanetRadius) {
        // Long light rays from the night side of the planet lead to numerical instability
        // Do not render the atmosphere in such cases
        if (dot(rayDir, normalize(cameraPos)) < -0.025) {
          return vec3(0);
        }
        start = rayPlanetIntersect.y;
      }

      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
      float maxEnd = end;

      ${t.haze?Ua`if (terrainDepth != -1.0) { end = terrainDepth; }`:""}

      vec3 samplePoint = cameraPos + rayDir * end;
      float multiplier = hitsPlanet ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (end - start) / float(STEPS);
      for (int i = 0; i < STEPS; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= exp(-(betaRayleigh + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {

          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);

          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${t.haze?"":Ua`scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);`}
        }

        lastOpticalDepth = opticalDepth;

      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.05968310365 * mumu;

      ${t.haze?Ua`return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;`:Ua`
            const float g = 0.8;
            const float gg = g * g;
            float phaseMie = end == maxEnd ? 0.11936620731 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;
            phaseMie += getGlow(1.0 - mu, 5e-5, 3.0) * smoothstep(0.01, 0.1, length(scattering));
            phaseMie = clamp(phaseMie, 0.0, 128.0);
            return 4.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }

    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
      vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);
      if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
        return fragColor;
      }

      float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
      vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
      float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
      if (relDist > 1.0) {
        return surfaceColor;
      }

      return mix(gl_FragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${t.haze?Ua`
          vec4 depthSample = texture2D(depthTex, vuv0).rgba;
          if (depthSample != vec4(0)) {
            vec3 cameraSpaceRay = normalize(eyeDir);
            cameraSpaceRay /= cameraSpaceRay.z;
            cameraSpaceRay *= -linearDepthFromTexture(depthTex, vuv0, nearFar);
            terrainDepth = max(0.0, length(cameraSpaceRay));
          }`:Ua`
          float depthSample = texture2D(depthTex, vuv0).r;
          if (depthSample != 1.0) {
            gl_FragColor = vec4(0);
            return;
          }`}

      ${t.haze?Ua`
            vec3 col = vec3(0);
            if(depthSample != vec4(0)){
              col = getAtmosphereColour(cameraPosition, rayDir, lightingMainDirection, terrainDepth);
            }
            float alpha = 1.0;`:Ua`
            vec3 col = getAtmosphereColour(cameraPosition, rayDir, lightingMainDirection, terrainDepth);;
            float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));`}
      col = tonemapACES(col);
      gl_FragColor = delinearizeGamma(vec4(col, alpha));
      ${t.haze?"":Ua`
          if (depthSample == 1.0) {
            gl_FragColor = applyUndergroundAtmosphere(rayDir, lightingMainDirection, gl_FragColor);
          }`}
    }
  `),e}const Xf=Object.freeze({__proto__:null,build:Yf});class Kf extends Ya{initializeProgram(t){const e=Kf.shader.get().build({haze:this.configuration.haze});return new Xa(t.rctx,e,Ka)}initializePipeline(){return Gh(this.configuration.haze?{blending:qh(1,0,769,1),colorWrite:Wh}:{blending:qh(770,1,771,771),depthTest:{func:515},colorWrite:Wh})}}Kf.shader=new $a(Xf,(()=>import("./p-76a876b8.js")));class $f extends Qa{constructor(){super(...arguments),this.haze=!1}}r([Za()],$f.prototype,"haze",void 0);class Jf{constructor(t){this._view=t,this.canRender=!0,this._skyslot=12,this._hazeSlot=13,this._cameraPosition=js(),this._projectionInverse=gn(),this._viewInverse=gn(),this._heightParameters=sa(),this._betasRayleigh=js(),this._betasCombined=js(),this._scaleHeight=0,this._radii=Sa(),this._nearFar=Sa(),this._cameraHeight=0,this._cameraHeightSq=0,this._cAtmosphere=0,this._innerFadeDistance=0,this._altitudeFade=0,this._lowerElevationBoundRadius=0,this._lowerBoundEarthRadius=U.radius,this._updateRadius(U.radius)}destroy(){this._atmosphereTechnique=Z(this._atmosphereTechnique),this._atmosphereHazeTechnique=Z(this._atmosphereHazeTechnique),this._vao=Q(this._vao),this._handles=Y(this._handles)}when(){return Promise.resolve()}initializeRenderContext(t){const e=t.renderContext.rctx;this._handles=new E,p(this._view.basemapTerrain.rootTiles)&&this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,context:"ground"}),this._handles.add(X(this._view,"basemapTerrain","elevation-change",(t=>this._updateElevation(t)),(()=>this._updateElevation()))),this._handles.add(X(this._view,"basemapTerrain","elevation-bounds-change",(()=>this._updateVisibleElevationBounds())));const i=new $f;i.haze=!1,this._atmosphereTechnique=t.shaderTechniqueRep.acquire(Kf,i),i.haze=!0,this._atmosphereHazeTechnique=t.shaderTechniqueRep.acquire(Kf,i),this._vao=Ja(e,th),this._scaleHeight=8500,ds(this._betasRayleigh,Zf[0],Zf[1],Zf[2]),ds(this._betasCombined,Zf[0]+Qf[0],Zf[1]+Qf[1],Zf[2]+Qf[2])}uninitializeRenderContext(){this.destroy()}render(t){if(t.slot!==this._hazeSlot&&t.slot!==this._skyslot||0!==t.pass)return!1;this._update(t.camera);const e=t.rctx,i=t.offscreenRenderingHelper,s=t.slot===this._skyslot?this._atmosphereTechnique:this._atmosphereHazeTechnique,n=t.slot===this._skyslot?i.depthTexture:i.linearDepthTexture;return e.useProgram(s.program),s.bindPipelineState(e),i.renderDepthDetached((()=>{s.program.bindTexture(n,"depthTex"),this._renderCommon(s.program,t)})),!0}_renderCommon(t,e){if(w(this._vao))return!1;const i=e.rctx;return e.scenelightingData.setLightDirectionUniform(t),t.setUniform4fv("heightParameters",this._heightParameters),t.setUniform3fv("cameraPosition",this._cameraPosition),t.setUniformMatrix4fv("projectionInverse",this._projectionInverse),t.setUniformMatrix4fv("viewInverse",this._viewInverse),t.setUniform2fv("nearFar",this._nearFar),t.setUniform2fv("radii",this._radii),t.setUniform1f("scaleHeight",this._scaleHeight),t.setUniform1f("betaMie",3996e-9),t.setUniform3fv("betaRayleigh",this._betasRayleigh),t.setUniform3fv("betaCombined",this._betasCombined),t.setUniform1f("innerFadeDistance",this._innerFadeDistance),t.setUniform1f("altitudeFade",this._altitudeFade),i.bindVAO(this._vao),t.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(5,0,4),!0}_adjustRadiusForTesselation(t){return t*Math.cos(Math.PI/16/16)}_updateElevation(t){const e=t?t.tile:f(this._view.basemapTerrain.rootTiles,[null])[0];if(w(e)||0!==e.lij[0])return;const i=this._adjustRadiusForTesselation(U.radius+e.elevationBounds[0]);i!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=i,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const t=this._adjustRadiusForTesselation(U.radius+this._view.basemapTerrain.elevationBounds.min);(this._lowerBoundEarthRadius<0||t<this._lowerBoundEarthRadius)&&this._updateRadius(t)}_updateRadius(t){this._lowerBoundEarthRadius=t,pa(this._radii,t,t+1e5),this._innerFadeDistance=2*Math.sqrt(1e4*(2*t-1e4))}_update(t){if(w(t))return;this._cameraHeight=Xi(t.eye),this._cameraHeightSq=this._cameraHeight*this._cameraHeight,this._cAtmosphere=this._cameraHeightSq-this._radii[1]*this._radii[1];const e=Math.min(1,Math.max(0,(this._cameraHeight-this._radii[0])/1e5));this._heightParameters=na(this._cameraHeight,this._cameraHeightSq,this._cAtmosphere,e),$i(this._cameraPosition,t.eye),so(this._projectionInverse,t.projectionMatrix),so(this._viewInverse,t.viewMatrix),pa(this._nearFar,t.near,t.far),this._altitudeFade=Hf(this._cameraHeight-this._lowerBoundEarthRadius)}static isSupported(t){return t.renderContext.rctx.capabilities.depthTexture}}function tg(t=sg){return[t[0],t[1],t[2],t[3]]}function eg(t,e){return function(t,e,i,s,n=tg()){return n[0]=t,n[1]=e,n[2]=i,n[3]=s,n}(t[0],t[1],t[2],e,il.get())}function ig(t,e,i=tg()){return ss(i,t,e),is(i,i),i[3]=jo(t,e),i}const sg=[0,0,1,0];function ng(t){t.fragment.uniforms.add("anchorPosition","vec3").add("anchorPositionCrossFade","vec3").add("fadeInOutFactor","float").add("cloudsHeight","float").add("rotationMatrixClouds","mat4").add("rotationMatrixCloudsCrossFade","mat4").add("radiusCurvatureCorrectionFactor","float").add("radius","float").add("cameraPosition","vec3").add("totalFadeInOut","float").add("crossFade","int").add("crossFadeAnchorFactor","float").add("cloudVariables","vec2"),t.include(eh),t.fragment.code.add(Ua`vec3 intersectWithCloudLayer(vec3 dir, vec3 camPos, vec3 spherePos, float radiusReduction)
{
vec3 dirAnchor = normalize(spherePos);
vec3 sphereOriginOffset = dirAnchor * radiusReduction;
float radiusClouds = radius + cloudsHeight - radiusReduction;
float B = 2.0 * dot(camPos - sphereOriginOffset, dir);
float C = dot(camPos - sphereOriginOffset, camPos - sphereOriginOffset) - radiusClouds * radiusClouds;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
vec3 intersectionPont = camPos + dir * pointIntDist;
intersectionPont =  intersectionPont - spherePos;
return intersectionPont;
}`),t.fragment.code.add(Ua`vec3 correctForPlanetCurvature(vec3 dir)
{
dir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;
return dir;
}`),t.fragment.code.add(Ua`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)
{
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),t.fragment.code.add(Ua`const float SUNSET_TRANSITION_FACTOR = 0.3;
const vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);
const float RIM_SCATTERING_FACTOR = 140.0;
const float BACKLIGHT_FACTOR = 0.2;
const float BACKLIGHT_SCATTERING_FACTOR = 10.0;
const float BACKLIGHT_TRANSITION_FACTOR = 0.3;
const float GAMMA_SRGB = 2.1;
const float INV_GAMMA_SRGB = 0.4761904;
vec3 calculateCloudColor(vec3 worldSpaceRay, vec4 clouds)
{
float upDotLight = dot(normalize(cameraPosition), normalize(lightingMainDirection));
float dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(lightingMainDirection)), 0.0);
float sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);
vec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);
vec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);
vec3 combinedLight = clamp((lightingMainIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA_SRGB)), vec3(INV_GAMMA_SRGB));
float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
float rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);
vec3 directSunScattering = RIM_COLOR * rimLightIntensity * pow(dirDotLight, RIM_SCATTERING_FACTOR) * scatteringMod;
float additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;
return vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);
}`),t.fragment.code.add(Ua`vec4 getCloudData(vec3 rayDir)
{
vec4 cloudData = textureCube(cubeMap, rayDir);
float mu = dot(rayDir, vec3(0, 0, 1));
return mix(vec4(vec3(clamp(1.0 - cloudVariables.y, 0.5, 1.0)), 0.0), cloudData, smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(mu)));
}`),t.fragment.code.add(Ua`vec4 renderCloud(vec3 worldRay)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition, 0.0);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected);
float totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudData.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(calculateCloudColor(normalize(-worldRay), cloudData), totalTransmittance);
}`),t.fragment.code.add(Ua`vec4 renderCloudCrossFade(vec3 worldRay)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition, 0.0);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected);
vec4 cloudColor = vec4(calculateCloudColor(normalize(-worldRay), cloudData), cloudData.a);
intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPositionCrossFade, 0.0);
worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = getCloudData(worldRayRotatedCorrected);
vec4 cloudColorCrossFade = vec4(calculateCloudColor(normalize(-worldRay), cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);
float totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudColor.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(cloudColor.rgb, totalTransmittance);
}`)}function rg(){const t=new Wa;return t.attributes.add("position","vec2"),t.varyings.add("worldRay","vec3"),t.vertex.uniforms.add("inverseProjectionMatrix","mat4"),t.vertex.uniforms.add("inverseViewMatrix","mat4"),t.vertex.code.add(Ua`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;
gl_Position = vec4(position, 1.0, 1.0);
}`),t.fragment.uniforms.add("lightingMainDirection","vec3").add("cubeMap","samplerCube"),t.fragment.include(ih),t.fragment.include(sh),t.include(_a),t.include(Da,{pbrMode:0,lightingSphericalHarmonicsOrder:2}),t.include(ng),t.fragment.code.add(Ua`void main() {
vec4 cloudsColor = crossFade == 0 ? renderCloud(normalize(worldRay)) : renderCloudCrossFade(normalize(worldRay));
gl_FragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);
}`),t}const og=Object.freeze({__proto__:null,build:rg});class ag extends Ya{initializeProgram(t){const e=ag.shader.get().build();return new Xa(t.rctx,e,Ka)}initializePipeline(){return Gh({blending:Uh(1,770),depthTest:{func:515},colorWrite:Wh})}}var hg,lg,cg,ug;ag.shader=new $a(og,(()=>import("./p-22cf3ece.js"))),function(t){t[t.FINISHED=0]="FINISHED",t[t.CHANGE_ANCHOR=1]="CHANGE_ANCHOR",t[t.FADE_IN=2]="FADE_IN"}(hg||(hg={})),function(t){t[t.FINISHED=0]="FINISHED",t[t.FADE_OUT=1]="FADE_OUT",t[t.FADE_IN=2]="FADE_IN"}(lg||(lg={})),function(t){t[t.FINISHED=0]="FINISHED",t[t.CROSS_FADE=1]="CROSS_FADE"}(cg||(cg={})),function(t){t[t.FINISHED=0]="FINISHED",t[t.HEIGHT_FADE=1]="HEIGHT_FADE"}(ug||(ug={}));class dg{constructor(t,e,i,s){this._viewingMode=e,this._inverseProjectionMatrix=gn(),this._inverseViewMatrix=gn(),this._cameraPositionLastFrame=js(),this._cloudCompositionTechnique=new ag({rctx:t,viewingMode:this._viewingMode},null),this._vao=Ja(t),this._setDefaultParallax(i,s)}destroy(){this._cloudCompositionTechnique=Z(this._cloudCompositionTechnique),this._vao=Q(this._vao)}render(t,e,i,s,n){const r=t.camera;if(w(this._vao)||w(r))return!1;const o=t.rctx,a=this._cloudCompositionTechnique.program;return o.useProgram(a),this._cloudCompositionTechnique.bindPipelineState(o),this._isCameraAnimating=i,t.scenelightingData.setLightDirectionUniform(a),t.scenelightingData.setUniforms(a),so(this._inverseProjectionMatrix,r.projectionMatrix),so(this._inverseViewMatrix,r.viewMatrix),a.setUniformMatrix4fv("inverseProjectionMatrix",this._inverseProjectionMatrix),a.setUniformMatrix4fv("inverseViewMatrix",this._inverseViewMatrix),a.bindTexture(e.colorTexture,"cubeMap"),a.setUniform2fv("cloudVariables",[s,n]),this._setParallaxParams(r.eye),this._bindParallaxParams(a,t.camera),o.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao),o.drawArrays(5,0,4),!0}isFading(){return this._crossFadeParams.crossFadeStage!==cg.FINISHED||this._fadeInOutParams.fadeInOutStage!==lg.FINISHED||this._fadeInParams.fadeInStage!==hg.FINISHED||this._fadeInOutHeightParams.fadeHeightStage!==ug.FINISHED}_setDefaultParallax(t,e){this._parallaxParams={anchorPointClouds:js(),radius:t,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:gn()},this._parallaxParamsNew={anchorPointClouds:js(),radius:t,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:gn()},this._crossFadeParams={crossFadeStage:cg.FINISHED,crossFadeFactor:0,distanceThresholdFactor:.3},this._fadeInOutParams={fadeInOutStage:lg.FINISHED,fadeInOutFactor:0,distanceThresholdFactor:.6},this._fadeInParams={fadeInStage:hg.FINISHED,fadeInFactor:0,distanceThresholdFactor:2},this._fadeInOutHeightParams={fadeHeightStage:ug.FINISHED,fadeHeightFactor:e>1e4?1:0,heightThresholdFactor:1e4}}_isCameraPossitionFinal(t){return gs(this._cameraPositionLastFrame,t)}_setFadeInStage(t){const e=this._isCameraPossitionFinal(t);this._fadeInParams.fadeInStage===hg.FINISHED&&(this._fadeInParams.fadeInFactor=1,$i(this._parallaxParams.anchorPointClouds,gg),this._fadeInParams.fadeInStage=hg.CHANGE_ANCHOR,this._crossFadeParams.crossFadeStage=cg.FINISHED,this._fadeInOutParams.fadeInOutStage=lg.FINISHED),this._fadeInParams.fadeInStage===hg.CHANGE_ANCHOR&&e&&($i(this._parallaxParams.anchorPointClouds,gg),this._fadeInParams.fadeInStage=hg.FADE_IN,this._startTime=performance.now()),this._fadeInParams.fadeInFactor>0&&this._fadeInParams.fadeInStage===hg.FADE_IN&&(this._fadeInParams.fadeInFactor=1-(performance.now()-this._startTime)/500),this._fadeInParams.fadeInFactor<=0&&this._fadeInParams.fadeInStage===hg.FADE_IN&&(this._fadeInParams.fadeInStage=hg.FINISHED,this._fadeInParams.fadeInFactor=0)}_setCrossFadingStage(){this._crossFadeParams.crossFadeStage===cg.FINISHED&&($i(this._parallaxParamsNew.anchorPointClouds,gg),this._startTime=performance.now(),this._crossFadeParams.crossFadeFactor=0,this._crossFadeParams.crossFadeStage=cg.CROSS_FADE),this._crossFadeParams.crossFadeFactor<1&&this._crossFadeParams.crossFadeStage===cg.CROSS_FADE&&(this._crossFadeParams.crossFadeFactor=(performance.now()-this._startTime)/500),this._crossFadeParams.crossFadeFactor>=1&&this._crossFadeParams.crossFadeStage===cg.CROSS_FADE&&(this._crossFadeParams.crossFadeStage=cg.FINISHED,this._crossFadeParams.crossFadeFactor=1,$i(this._parallaxParams.anchorPointClouds,this._parallaxParamsNew.anchorPointClouds))}_setFadeInOutStage(t){const e=this._isCameraPossitionFinal(t);this._fadeInOutParams.fadeInOutStage===lg.FINISHED&&(this._startTime=performance.now(),this._fadeInOutParams.fadeInOutFactor=0,this._fadeInOutParams.fadeInOutStage=lg.FADE_OUT),this._fadeInOutParams.fadeInOutFactor<1&&this._fadeInOutParams.fadeInOutStage===lg.FADE_OUT&&(this._fadeInOutParams.fadeInOutFactor=(performance.now()-this._startTime)/250),this._fadeInOutParams.fadeInOutFactor>=1&&this._fadeInOutParams.fadeInOutStage===lg.FADE_OUT&&(this._fadeInOutParams.fadeInOutFactor=1,$i(this._parallaxParams.anchorPointClouds,gg)),this._fadeInOutParams.fadeInOutFactor>=1&&this._fadeInOutParams.fadeInOutStage===lg.FADE_OUT&&e&&(this._startTime=performance.now(),this._fadeInOutParams.fadeInOutFactor=1,this._fadeInOutParams.fadeInOutStage=lg.FADE_IN,this._crossFadeParams.crossFadeStage=cg.FINISHED,this._crossFadeParams.crossFadeFactor=0),this._fadeInOutParams.fadeInOutFactor>0&&this._fadeInOutParams.fadeInOutStage===lg.FADE_IN&&(this._fadeInOutParams.fadeInOutFactor=1-(performance.now()-this._startTime)/500),this._fadeInOutParams.fadeInOutFactor<=0&&this._fadeInOutParams.fadeInOutStage===lg.FADE_IN&&(this._fadeInOutParams.fadeInOutStage=lg.FINISHED,this._fadeInOutParams.fadeInOutFactor=0)}_setFadeInOutHeight(t){const e=performance.now();this._startTimeHeightFade=this._fadeInOutHeightParams.fadeHeightStage===ug.FINISHED?e:this._startTimeHeightFade,t?this._fadeInOutHeightParams.fadeHeightFactor+=(e-this._startTimeHeightFade)/500:this._fadeInOutHeightParams.fadeHeightFactor-=(e-this._startTimeHeightFade)/500,this._startTimeHeightFade=e,this._fadeInOutHeightParams.fadeHeightFactor=fs(this._fadeInOutHeightParams.fadeHeightFactor,0,1),this._fadeInOutHeightParams.fadeHeightStage=ug.HEIGHT_FADE}_setParallaxParams(t){is(gg,t),Yi(gg,gg,this._parallaxParams.radius),0===this._parallaxParams.anchorPointClouds[0]&&0===this._parallaxParams.anchorPointClouds[1]&&0===this._parallaxParams.anchorPointClouds[2]&&$i(this._parallaxParams.anchorPointClouds,gg);const e=Xi(ts(mg,this._parallaxParams.anchorPointClouds,gg));let i=!0;e>this._fadeInParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._fadeInParams.fadeInStage!==hg.FINISHED?this._setFadeInStage(t):e>this._fadeInOutParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._fadeInOutParams.fadeInOutStage!==lg.FINISHED?this._setFadeInOutStage(t):(e>this._crossFadeParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._crossFadeParams.crossFadeStage!==cg.FINISHED)&&!this._isCameraAnimating?this._setCrossFadingStage():i=!1;const s=Xi(t),n=s-this._parallaxParams.radius;n>1.7*this._fadeInOutHeightParams.heightThresholdFactor&&this._fadeInOutHeightParams.fadeHeightFactor<1?this._fadeInOutHeightParams.fadeHeightFactor=1:n>this._fadeInOutHeightParams.heightThresholdFactor&&this._fadeInOutHeightParams.fadeHeightFactor<1?this._setFadeInOutHeight(!0):n<this._fadeInOutHeightParams.heightThresholdFactor&&this._fadeInOutHeightParams.fadeHeightFactor>0?this._setFadeInOutHeight(!1):this._fadeInOutHeightParams.fadeHeightStage=ug.FINISHED,this._parallaxParams.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(s*s-this._parallaxParams.radius*this._parallaxParams.radius,0))/s,ig(pg,this._parallaxParams.anchorPointClouds,fg),this._parallaxParams.transform=gn(),eo(this._parallaxParams.transform,this._parallaxParams.transform,fg[3],fg),i&&(ig(pg,this._parallaxParamsNew.anchorPointClouds,fg),this._parallaxParamsNew.transform=gn(),eo(this._parallaxParamsNew.transform,this._parallaxParamsNew.transform,fg[3],fg)),$i(this._cameraPositionLastFrame,t)}_bindParallaxParams(t,e){t.setUniform1f("cloudsHeight",this._parallaxParams.cloudsHeight),t.setUniformMatrix4fv("rotationMatrixClouds",this._parallaxParams.transform),t.setUniformMatrix4fv("rotationMatrixCloudsCrossFade",this._parallaxParamsNew.transform),t.setUniform3fv("anchorPosition",this._parallaxParams.anchorPointClouds),t.setUniform3fv("anchorPositionCrossFade",this._parallaxParamsNew.anchorPointClouds),t.setUniform1f("totalFadeInOut",this._fadeInOutParams.fadeInOutStage!==lg.FINISHED?this._fadeInOutHeightParams.fadeHeightFactor+Math.max(fs(this._fadeInOutParams.fadeInOutFactor,0,1)):this._fadeInOutHeightParams.fadeHeightFactor+Math.max(fs(this._fadeInParams.fadeInFactor,0,1))),t.setUniform1f("radiusCurvatureCorrectionFactor",this._parallaxParams.radiusCurvatureCorrectionFactor),t.setUniform1i("crossFade",this._crossFadeParams.crossFadeStage),t.setUniform1f("crossFadeAnchorFactor",fs(this._crossFadeParams.crossFadeFactor,0,1)),t.setUniform1f("radius",this._parallaxParams.radius),t.setUniform3fv("cameraPosition",e.eye)}}const pg=Ns(0,0,1),fg=tg(),gg=js(),mg=js();function vg(){const t=new Wa;return t.attributes.add("position","vec3"),t.fragment.uniforms.add("cloudRadius","float").add("halfCubeMapSize","float").add("power","float").add("sigmaE","float").add("density","float").add("cloudSize","float").add("detailSize","float").add("smoothness","float").add("cloudHeight","float").add("coverage","float").add("viewMatrix","mat3").add("cloudShapeTexture","sampler2D"),t.vertex.code.add(Ua`void main(void) {
gl_Position = vec4(position, 1.0);
}`),t.fragment.code.add(Ua`const int STEPS = 200;
const int STEPS_LIGHT = 6;
const float stepL = 300.0 / float(STEPS_LIGHT);
const float cloudStart = 1500.0;
vec3 rayDirection(vec2 fragCoord) {
vec2 xy = fragCoord - halfCubeMapSize;
return normalize(vec3(-xy, -halfCubeMapSize));
}
float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}
float saturate(float x) {
return clamp(x, 0.0, 1.0);
}`),t.fragment.code.add("\n    float getCloudShape(vec3 pos, float pOffset) {\n      const float textureWidth = 1560.0;\n      const float dataWidth = 1560.0;\n      const float tileRows = 12.0;\n      const vec3 atlasDimensions = vec3(128.0, 128.0, 144.0);\n\n      //Change from Y being height to Z being height\n      vec3 p = pos.xzy;\n\n      //Pixel coordinates of point in the 3D data\n      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));\n      float f = fract(coord.z);\n      float level = floor(coord.z);\n      float tileY = floor(level / tileRows);\n      float tileX = level - tileY * tileRows;\n\n      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column\n      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;\n      vec2 pixel = coord.xy + offset;\n      vec2 data = texture2D(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;\n\n      return 1.0 - mix(data.x, data.y, f);\n    }"),t.fragment.code.add("\n    float clouds(vec3 p) {\n      float cloudVariations = getCloudShape(0.002 * p, 0.5);\n\n      float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));\n      cloud += (cloudVariations * 0.6 - 0.3) * ( -4.0 * (coverage * coverage - coverage));\n      float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);\n\n      //Round the bottom and top of the clouds\n      cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * saturate(remap(heightFraction, 0.75, 1.0, 1.0, 0.0));\n\n      float shape = getCloudShape(cloudSize * p, 0.0);\n      shape *= mix(0.0, 1.0, min(2.0 * (1.0 - coverage), 1.0));\n      cloud = saturate(remap(cloud, shape, 1.0, 0.0, 1.0));\n\n      if (cloud <= 0.0) {\n        return 0.0;\n      }\n\n      return density * saturate(remap(cloud, smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));\n    }"),t.fragment.code.add("\n    vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {\n      float a = dot(dir, dir);\n      float b = 2.0 * dot(dir, start);\n      float c = dot(start, start) - (radius * radius);\n      float d = (b * b) - 4.0 * a * c;\n\n      if (d < 0.0) {\n        return vec2(1e5, -1e5);\n      }\n\n      return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));\n    }\n      \n    float HenyeyGreenstein(float g, float costh) {\n      return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));\n    }\n    "),t.fragment.code.add("\n    vec3 multipleOctaves(float extinction, float mu, float stepL) {\n      float attenuation = 1.0;\n      float contribution = 1.0;\n      float phaseAttenuation = 1.0;\n      vec3 luminance = vec3(0);\n\n      for (int i = 0; i < 4; i++) {\n        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);\n        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);\n        attenuation *= 0.2;\n        contribution *= 0.6;\n        phaseAttenuation *= 0.5;\n      }\n\n      return luminance;\n    }"),t.fragment.code.add("\n    vec3 lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {\n      float lightRayDensity = clouds(p);\n      lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);\n      lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);\n      lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);\n      lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);\n      lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);\n      \n      vec3 beersLaw = multipleOctaves(lightRayDensity, mu, stepL);\n\n      return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);\n    }"),t.fragment.code.add('\n    vec3 mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {\n\n      // This is never true but having the if statement stops later loop unrolling, texture prefetching and WebGL context crashes\n      if (dir.z < 0.0) {\n        return vec3(0);\n      }\n\n      //Variable to track transmittance along view ray. Assume clear sky and attenuate light when encountering clouds.\n      totalTransmittance = 1.0;\n\n      float stepS = totalDistance / float(STEPS);\n      float cameraHeight = length(org);\n\n      //Alignment of view and light directions.\n      float mu = 0.5 + 0.5 * dot(sunDirection, dir);\n      float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);\n      \n      vec3 p = org + distToStart  * dir;\n      float dist = distToStart;\n      vec3 color = vec3(0.0);\n\n      for (int i = 0; i < STEPS; i++) {\n\n        float sampleDensity = clouds(p);\n        float sampleSigmaE = sampleDensity * sigmaE;\n\n        if (sampleDensity > 0.0 ) {\n          float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));\n\n          vec3 luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));\n          float transmittance = exp(-sampleSigmaE * stepS);\n\n          //Better energy conserving integration\n          //"From Physically based sky, atmosphere and cloud rendering in Frostbite" 5.6\n          color += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;\n\n          totalTransmittance *= transmittance;\n\n          //If ray combined transmittance is close to 0, nothing beyond this sample point is visible, so break early.\n          if (totalTransmittance <= 0.001) {\n            totalTransmittance = 0.0;\n            break;\n          }\n\n        }\n\n        dist += stepS;\n        p = org + dir * dist;\n      }\n\n      return color;\n    }'),t.fragment.code.add("\n    void main() {\n      vec3 rayDir = rayDirection(gl_FragCoord.xy);\n      rayDir = normalize(viewMatrix * rayDir);\n\n      vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);\n\n      bool hitsPlanet = rayDir.z < 0.0;\n\n      if (hitsPlanet) {\n        gl_FragColor = vec4(vec3(0), 1);\n        return;\n      }\n\n      vec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);\n      vec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);\n      float distToStart = rayStartIntersect.y;\n      float totalDistance = rayEndIntersect.y - distToStart;\n\n      float totalTransmittance = 1.0;\n      vec3 sunDirection = normalize(vec3(0, 0, 1));\n      vec3 col = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance).rgb;\n\n      gl_FragColor = vec4(col, totalTransmittance);\n    }\n  "),t}const yg=Object.freeze({__proto__:null,build:vg});class wg extends Ya{initializeProgram(t){const e=wg.shader.get().build();return new Xa(t.rctx,e,Ka)}initializePipeline(){return Gh({blending:qh(1,1,0,0),depthTest:{func:515},colorWrite:Wh})}}function xg(){const t=new Wa;return t.attributes.add("position","vec3"),t.vertex.code.add(Ua`void main(void) {
gl_Position = vec4(position, 1.0);
}`),t.fragment.uniforms.add("tileRows","float").add("tileSize","float"),t.fragment.code.add("\n    #define NUM_CELLS 2.0\n    #define PERLIN_WORLEY 0\n    #define WORLEY 1\n\n    float remap(float x, float low1, float high1, float low2, float high2) {\n      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);\n    }\n\n    float saturate(float x) {\n      return clamp(x, 0.0, 1.0);\n    }\n\n    vec4 taylorInvSqrt(vec4 r) {\n      return 1.79284291400159 - 0.85373472095314 * r;\n    }\n\n    vec4 mod289(vec4 x) {\n      return x - floor( x * (1.0 / 289.0)) * 289.0;\n    }\n\n    vec4 permute(vec4 x) {\n      return mod289(((x * 34.0) + 1.0) * x);\n    }\n\n    vec4 fade(vec4 t) {\n      return (t * t * t) * (t * (t * vec4(6) - vec4(15)) + vec4(10));\n    }\n\n    float glmPerlin(vec4 Position, vec4 rep) {\n      vec4 Pi0 = mod(floor(Position), rep);\n      vec4 Pi1 = mod(Pi0 + float(1), rep);\n      vec4 Pf0 = fract(Position);\n      vec4 Pf1 = Pf0 - float(1);\n      vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);\n      vec4 iy = vec4(Pi0.y, Pi0.y, Pi1.y, Pi1.y);\n      vec4 iz0 = vec4(Pi0.z);\n      vec4 iz1 = vec4(Pi1.z);\n      vec4 iw0 = vec4(Pi0.w);\n      vec4 iw1 = vec4(Pi1.w);\n\n      vec4 ixy = permute(permute(ix) + iy);\n      vec4 ixy0 = permute(ixy + iz0);\n      vec4 ixy1 = permute(ixy + iz1);\n      vec4 ixy00 = permute(ixy0 + iw0);\n      vec4 ixy01 = permute(ixy0 + iw1);\n      vec4 ixy10 = permute(ixy1 + iw0);\n      vec4 ixy11 = permute(ixy1 + iw1);\n\n      vec4 gx00 = ixy00 / float(7);\n      vec4 gy00 = floor(gx00) / float(7);\n      vec4 gz00 = floor(gy00) / float(6);\n      gx00 = fract(gx00) - float(0.5);\n      gy00 = fract(gy00) - float(0.5);\n      gz00 = fract(gz00) - float(0.5);\n      vec4 gw00 = vec4(0.75) - abs(gx00) - abs(gy00) - abs(gz00);\n      vec4 sw00 = step(gw00, vec4(0));\n      gx00 -= sw00 * (step(float(0), gx00) - float(0.5));\n      gy00 -= sw00 * (step(float(0), gy00) - float(0.5));\n\n      vec4 gx01 = ixy01 / float(7);\n      vec4 gy01 = floor(gx01) / float(7);\n      vec4 gz01 = floor(gy01) / float(6);\n      gx01 = fract(gx01) - float(0.5);\n      gy01 = fract(gy01) - float(0.5);\n      gz01 = fract(gz01) - float(0.5);\n      vec4 gw01 = vec4(0.75) - abs(gx01) - abs(gy01) - abs(gz01);\n      vec4 sw01 = step(gw01, vec4(0.0));\n      gx01 -= sw01 * (step(float(0), gx01) - float(0.5));\n      gy01 -= sw01 * (step(float(0), gy01) - float(0.5));\n\n      vec4 gx10 = ixy10 / float(7);\n      vec4 gy10 = floor(gx10) / float(7);\n      vec4 gz10 = floor(gy10) / float(6);\n      gx10 = fract(gx10) - float(0.5);\n      gy10 = fract(gy10) - float(0.5);\n      gz10 = fract(gz10) - float(0.5);\n      vec4 gw10 = vec4(0.75) - abs(gx10) - abs(gy10) - abs(gz10);\n      vec4 sw10 = step(gw10, vec4(0.0));\n      gx10 -= sw10 * (step(float(0), gx10) - float(0.5));\n      gy10 -= sw10 * (step(float(0), gy10) - float(0.5));\n\n      vec4 gx11 = ixy11 / float(7);\n      vec4 gy11 = floor(gx11) / float(7);\n      vec4 gz11 = floor(gy11) / float(6);\n      gx11 = fract(gx11) - float(0.5);\n      gy11 = fract(gy11) - float(0.5);\n      gz11 = fract(gz11) - float(0.5);\n      vec4 gw11 = vec4(0.75) - abs(gx11) - abs(gy11) - abs(gz11);\n      vec4 sw11 = step(gw11, vec4(float(0)));\n      gx11 -= sw11 * (step(float(0), gx11) - float(0.5));\n      gy11 -= sw11 * (step(float(0), gy11) - float(0.5));\n\n      vec4 g0000 = vec4(gx00.x, gy00.x, gz00.x, gw00.x);\n      vec4 g1000 = vec4(gx00.y, gy00.y, gz00.y, gw00.y);\n      vec4 g0100 = vec4(gx00.z, gy00.z, gz00.z, gw00.z);\n      vec4 g1100 = vec4(gx00.w, gy00.w, gz00.w, gw00.w);\n      vec4 g0010 = vec4(gx10.x, gy10.x, gz10.x, gw10.x);\n      vec4 g1010 = vec4(gx10.y, gy10.y, gz10.y, gw10.y);\n      vec4 g0110 = vec4(gx10.z, gy10.z, gz10.z, gw10.z);\n      vec4 g1110 = vec4(gx10.w, gy10.w, gz10.w, gw10.w);\n      vec4 g0001 = vec4(gx01.x, gy01.x, gz01.x, gw01.x);\n      vec4 g1001 = vec4(gx01.y, gy01.y, gz01.y, gw01.y);\n      vec4 g0101 = vec4(gx01.z, gy01.z, gz01.z, gw01.z);\n      vec4 g1101 = vec4(gx01.w, gy01.w, gz01.w, gw01.w);\n      vec4 g0011 = vec4(gx11.x, gy11.x, gz11.x, gw11.x);\n      vec4 g1011 = vec4(gx11.y, gy11.y, gz11.y, gw11.y);\n      vec4 g0111 = vec4(gx11.z, gy11.z, gz11.z, gw11.z);\n      vec4 g1111 = vec4(gx11.w, gy11.w, gz11.w, gw11.w);\n\n      vec4 norm00 = taylorInvSqrt(vec4(dot(g0000, g0000), dot(g0100, g0100), dot(g1000, g1000), dot(g1100, g1100)));\n      g0000 *= norm00.x;\n      g0100 *= norm00.y;\n      g1000 *= norm00.z;\n      g1100 *= norm00.w;\n\n      vec4 norm01 = taylorInvSqrt(vec4(dot(g0001, g0001), dot(g0101, g0101), dot(g1001, g1001), dot(g1101, g1101)));\n      g0001 *= norm01.x;\n      g0101 *= norm01.y;\n      g1001 *= norm01.z;\n      g1101 *= norm01.w;\n\n      vec4 norm10 = taylorInvSqrt(vec4(dot(g0010, g0010), dot(g0110, g0110), dot(g1010, g1010), dot(g1110, g1110)));\n      g0010 *= norm10.x;\n      g0110 *= norm10.y;\n      g1010 *= norm10.z;\n      g1110 *= norm10.w;\n\n      vec4 norm11 = taylorInvSqrt(vec4(dot(g0011, g0011), dot(g0111, g0111), dot(g1011, g1011), dot(g1111, g1111)));\n      g0011 *= norm11.x;\n      g0111 *= norm11.y;\n      g1011 *= norm11.z;\n      g1111 *= norm11.w;\n\n      float n0000 = dot(g0000, Pf0);\n      float n1000 = dot(g1000, vec4(Pf1.x, Pf0.y, Pf0.z, Pf0.w));\n      float n0100 = dot(g0100, vec4(Pf0.x, Pf1.y, Pf0.z, Pf0.w));\n      float n1100 = dot(g1100, vec4(Pf1.x, Pf1.y, Pf0.z, Pf0.w));\n      float n0010 = dot(g0010, vec4(Pf0.x, Pf0.y, Pf1.z, Pf0.w));\n      float n1010 = dot(g1010, vec4(Pf1.x, Pf0.y, Pf1.z, Pf0.w));\n      float n0110 = dot(g0110, vec4(Pf0.x, Pf1.y, Pf1.z, Pf0.w));\n      float n1110 = dot(g1110, vec4(Pf1.x, Pf1.y, Pf1.z, Pf0.w));\n      float n0001 = dot(g0001, vec4(Pf0.x, Pf0.y, Pf0.z, Pf1.w));\n      float n1001 = dot(g1001, vec4(Pf1.x, Pf0.y, Pf0.z, Pf1.w));\n      float n0101 = dot(g0101, vec4(Pf0.x, Pf1.y, Pf0.z, Pf1.w));\n      float n1101 = dot(g1101, vec4(Pf1.x, Pf1.y, Pf0.z, Pf1.w));\n      float n0011 = dot(g0011, vec4(Pf0.x, Pf0.y, Pf1.z, Pf1.w));\n      float n1011 = dot(g1011, vec4(Pf1.x, Pf0.y, Pf1.z, Pf1.w));\n      float n0111 = dot(g0111, vec4(Pf0.x, Pf1.y, Pf1.z, Pf1.w));\n      float n1111 = dot(g1111, Pf1);\n\n      vec4 fade_xyzw = fade(Pf0);\n      vec4 n_0w = mix(vec4(n0000, n1000, n0100, n1100), vec4(n0001, n1001, n0101, n1101), fade_xyzw.w);\n      vec4 n_1w = mix(vec4(n0010, n1010, n0110, n1110), vec4(n0011, n1011, n0111, n1111), fade_xyzw.w);\n      vec4 n_zw = mix(n_0w, n_1w, fade_xyzw.z);\n      vec2 n_yzw = mix(vec2(n_zw.x, n_zw.y), vec2(n_zw.z, n_zw.w), fade_xyzw.y);\n      float n_xyzw = mix(n_yzw.x, n_yzw.y, fade_xyzw.x);\n      return float(2.2) * n_xyzw;\n    }\n\n    float getPerlinNoise(vec3 pos, float frequency) {\n      const float octaveFrequencyFactor = 2.0;\n\n      float sum = 0.0;\n      float weightSum = 0.0;\n      float weight = 1.0;\n\n      for (int oct = 0; oct < 3; oct++) {\n        vec3 p = pos * frequency;\n        float val = 0.5 + 0.5 * glmPerlin(vec4(p, 0.0), vec4(frequency));\n        sum += val * weight;\n        weightSum += weight;\n        weight *= 0.5;\n        frequency *= octaveFrequencyFactor;\n      }\n\n      float noise = (sum / weightSum);\n      noise = saturate(noise);\n      return noise;\n    }\n\n    float hash(float p) {\n      p = fract(p * 0.1031);\n      p *= p + 33.33;\n      p *= p + p;\n      return fract(p);;\n    }\n\n    float noise(vec3 x) {\n      vec3 p = floor(x);\n      vec3 f = fract(x);\n\n      f = f * f * (3.0 - 2.0 * f);\n      float n = p.x + p.y * 57.0 + 113.0 * p.z;\n\n      return mix(\n      mix(\n        mix(hash(n + 0.0), hash(n + 1.0), f.x),\n        mix(hash(n + 57.0), hash(n + 58.0), f.x),\n        f.y),\n      mix(\n        mix(hash(n + 113.0), hash(n + 114.0), f.x),\n        mix(hash(n + 170.0), hash(n + 171.0), f.x),\n        f.y),\n      f.z);\n    }\n\n    float worley(vec3 pos, float numCells) {\n      vec3 p = pos * numCells;\n      float d = 1.0e10;\n\n      for (int x = -1; x <= 1; x++) {\n        for (int y = -1; y <= 1; y++) {\n          for (int z = -1; z <= 1; z++) {\n            vec3 tp = floor(p) + vec3(x, y, z);\n            tp = p - tp - noise(mod(tp, numCells));\n            d = min(d, dot(tp, tp));\n          }\n        }\n      }\n\n      return 1.0 - clamp(d, 0.0, 1.0);\n    }\n\n    vec3 get3Dfrom2D(vec2 uv, float tileRows) {\n      vec2 tile = floor(uv);\n      float z = floor(tileRows * tile.y + tile.x);\n      return vec3(fract(uv), z);\n    }\n\n    float getTextureForPoint(vec3 p, int type) {\n      if (type == PERLIN_WORLEY) {\n\n        const float frequency = 8.0;\n        float perlinNoise = getPerlinNoise(p, frequency);\n\n        float worley0 = worley(p, NUM_CELLS * 2.0);\n        float worley1 = worley(p, NUM_CELLS * 8.0);\n        float worley2 = worley(p, NUM_CELLS * 14.0);\n\n        float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;\n        return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);\n      }\n\n      float worley0 = worley(p, NUM_CELLS);\n      float worley1 = worley(p, NUM_CELLS * 2.0);\n      float worley2 = worley(p, NUM_CELLS * 4.0);\n      float worley3 = worley(p, NUM_CELLS * 8.0);\n\n      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;\n      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;\n      float FBM2 = worley2 * 0.75 + worley3 * 0.25;\n\n      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;\n    }\n  "),t.fragment.code.add("\n    void main() {\n      const float padWidth = 1.0;\n      float paddedSize = tileSize + 2.0 * padWidth;\n      float tileCount = tileRows * tileRows;\n      vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);\n\n      bool padCell = false;\n      if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {\n        padCell = true;\n      }\n\n      if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {\n        padCell = true;\n      }\n\n      bool startPadX = false;\n      bool startPadY = false;\n      bool endPadX = false;\n      bool endPadY = false;\n\n      if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {\n        startPadX = true;\n      }\n\n      if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {\n        startPadY = true;\n      }\n\n      if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {\n        endPadX = true;\n      }\n\n      if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {\n        endPadY = true;\n      }\n\n      vec2 padding = vec2(2.0 * padWidth) * tile;\n      vec2 uv;\n\n      if (padCell) {\n        vec2 pixel = gl_FragCoord.xy - padWidth - padding;\n\n        if (startPadX) {\n          pixel.x += tileSize;\t\n        }\n\n        if (startPadY) {\n          pixel.y += tileSize;\t\n        }\n\n        if (endPadX) {\n          pixel.x -= tileSize;\t\n        }\n\n        if (endPadY) {\n          pixel.y -= tileSize;\t\n        }\n\n        uv = vec2(pixel.xy / tileSize);\n      } else {\n        vec2 pixel = gl_FragCoord.xy - padWidth - padding;\n        uv = vec2(pixel.xy / tileSize);\n      }\n\n      vec3 p_ = get3Dfrom2D(uv, tileRows);\n      vec3 p = p_;\n      p.z /= (tileRows * tileRows);\n\n      float worleyPerlinNoise = getTextureForPoint(p, PERLIN_WORLEY);\n      float worleyNoise = getTextureForPoint(p, WORLEY);\n\n      gl_FragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));\n\n      p_ = mod(p_ + 1.0, tileRows * tileRows);\n      p = p_;\n      p.z /= (tileRows * tileRows);\n\n      worleyPerlinNoise = getTextureForPoint(p, PERLIN_WORLEY);\n      worleyNoise = getTextureForPoint(p, WORLEY);\n\n      gl_FragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));\n\n    \tgl_FragColor.ba = vec2(0, 1);\n    }\n  "),t}wg.shader=new $a(yg,(()=>import("./p-3745a720.js")));const bg=Object.freeze({__proto__:null,build:xg});class Cg extends Ya{initializeProgram(t){const e=Cg.shader.get().build();return new Xa(t.rctx,e,Ka)}initializePipeline(){return Gh({blending:Uh(1,0),depthTest:{func:515},colorWrite:Wh})}}Cg.shader=new $a(bg,(()=>import("./p-454452bd.js")));class Mg{constructor(t,e){this._shapeTextureDescriptor={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,hasMipmap:!1,width:1,height:1},this._tileSize=1,this._tileRows=1,this._frameBuffer=new cl(t,{colorTarget:0}),this._vao=Ja(t),this.textureAtlas=new ml(t,this._shapeTextureDescriptor,null),this._technique=new Cg({rctx:t,viewingMode:e.state.viewingMode},null)}destroy(){this._technique=Z(this._technique),this._frameBuffer=Q(this._frameBuffer),this._vao=Q(this._vao),this.textureAtlas=Q(this.textureAtlas)}render(t,e){if(w(this._vao)||w(this.textureAtlas))return!1;this._tileSize=t,this._tileRows=Math.ceil(Math.sqrt(this._tileSize));const i=(t+2)*this._tileRows;this._frameBuffer.resize(i,i),this.textureAtlas.resize(i,i),this._frameBuffer.attachColorTexture(this.textureAtlas),e.bindFramebuffer(this._frameBuffer);const s=this._technique.program;e.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),this._technique.bindPipelineState(e),e.useProgram(s),s.setUniform1f("tileSize",this._tileSize),s.setUniform1f("tileRows",this._tileRows);const n=e.getViewport();return e.setViewport(0,0,i,i),e.gl.drawArrays(e.gl.TRIANGLE_STRIP,0,4),this._frameBuffer.detachColorTexture(),e.setViewport(n.x,n.y,n.width,n.height),!0}}class Sg{constructor(t,e,i){this.rctx=t,this.requestRender=i,this._cubeMapSize=2048,this._viewMat3=pn(),this._eye=rl(),this._didRenderFaces=!1,this.viewDirections=[ol(1,0,0),ol(-1,0,0),ol(0,1,0),ol(0,-1,0),ol(0,0,1)],this.upDirections=[ol(0,1,0),ol(0,1,0),ol(0,0,-1),ol(0,0,1),ol(0,1,0)],this._cloudRadius=0,this._viewMatrix=gn();const s=Tg.sunny;this.coverage=s.coverage[1]-.5*s.coverage[0],this.density=s.density[1]-.5*s.density[0],this.absorption=s.absorption[1]-.5*s.absorption[0],this.cloudSize=s.cloudSize[1]-.5*s.cloudSize[0],this.detailSize=s.detailSize[1]-.5*s.detailSize[0],this.smoothness=s.smoothness[1]-.5*s.smoothness[0],this.cloudHeight=s.cloudHeight[1]-.5*s.cloudHeight[0],this._noiseTextureAtlas=new Mg(t,e),this._noiseTextureAtlas.render(128,t),this._frameBufferCube=new cl(t,{colorTarget:2,width:this._cubeMapSize,height:this._cubeMapSize},{target:34067,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,hasMipmap:!1,width:this._cubeMapSize,height:this._cubeMapSize}),this._vao=Ja(t),this._technique=new wg({rctx:t,viewingMode:e.state.viewingMode},null);const n=Qr(e.spatialReference);this._cloudRadius=.5*n.radius,this.resetRenderFlags()}set coverage(t){this._coverage=t,this.resetRenderFlags()}get coverage(){return this._coverage}set density(t){this._density=this.remap(t,0,1,0,.3),this.resetRenderFlags()}set cloudSize(t){this._cloudSize=this.remap(Math.max(.01,1-t),0,1,0,.02),this.resetRenderFlags()}set detailSize(t){this._detailSize=this.remap(Math.max(.01,1-t),0,1,0,.2),this.resetRenderFlags()}set smoothness(t){this._smoothness=this.remap(1-t,0,1,0,.5),this.resetRenderFlags()}set absorption(t){this._sigmaE=1+t,this._power=this.remap(t,0,1,35,70),this.resetRenderFlags()}get absorption(){return this._sigmaE-1}set cloudHeight(t){this._cloudHeight=this.remap(t,0,1,0,1500),this.resetRenderFlags()}get cloudHeight(){return this._cloudHeight}destroy(){this._technique=Z(this._technique),this._frameBufferCube=Q(this._frameBufferCube),this._vao=Q(this._vao),this._noiseTextureAtlas=Y(this._noiseTextureAtlas)}resetRenderFlags(){this._didRenderFaces=!1}remap(t,e,i,s,n){return s+(t-e)*(n-s)/(i-e)}get running(){return!this._didRenderFaces}runTask(t){if(t.done)return;if(w(this._vao)||this._didRenderFaces)return;const e=this.rctx.getViewport();this.rctx.setViewport(0,0,this._cubeMapSize,this._cubeMapSize),this.rctx.bindFramebuffer(this._frameBufferCube,!1,34069);const i=this._technique.program;this.rctx.useProgram(i),i.bindTexture(this._noiseTextureAtlas.textureAtlas,"cloudShapeTexture"),i.setUniform1f("cloudRadius",this._cloudRadius),i.setUniform1f("halfCubeMapSize",.5*this._cubeMapSize),i.setUniform1f("power",this._power),i.setUniform1f("sigmaE",this._sigmaE),i.setUniform1f("density",this._density),i.setUniform1f("cloudSize",this._cloudSize),i.setUniform1f("detailSize",this._detailSize),i.setUniform1f("smoothness",this._smoothness),i.setUniform1f("cloudHeight",this._cloudHeight),i.setUniform1f("coverage",this._coverage),this.rctx.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),this._technique.bindPipelineState(this.rctx);for(let t=0;t<5;t++)no(this._viewMatrix,this._eye,this.viewDirections[t],this.upDirections[t]),an(this._viewMat3,this._viewMatrix),i.setUniformMatrix3fv("viewMatrix",this._viewMat3),this._frameBufferCube.framebufferTexture2D(this._frameBufferCube.colorAttachment.glName,this.rctx.gl,36064,34069+t),this.rctx.gl.drawArrays(this.rctx.gl.TRIANGLE_STRIP,0,4),this.rctx.gl.flush();this._didRenderFaces=!0,this.rctx.setViewport(e.x,e.y,e.width,e.height),t.madeProgress(),this.requestRender()}get test(){return{coverage:this._coverage,density:this.remap(this._density,0,.3,0,1),absorption:this._sigmaE-1,cloudSize:1-this.remap(this._cloudSize,0,.02,0,1),detailSize:1-this.remap(this._detailSize,0,.2,0,1),smoothness:1-this.remap(this._smoothness,0,.5,0,1),cloudHeight:this.remap(this._cloudHeight,0,1500,0,1)}}}class Pg{constructor(t,e,i,s,n,r,o,a=.5){this.coverage=t,this.density=e,this.absorption=i,this.cloudSize=s,this.detailSize=n,this.smoothness=r,this.cloudHeight=o,this.median=a}}const Tg={sunny:new Pg([.1,.7],[.02,.02],[0,0],[.86,.86],[.8,.8],[.5,.5],[.05,.05]),cloudy:new Pg([.2,.6],[.2,.4],[0,0],[.5,.7],[.65,.7],[.77,.6],[1,1],.4),rainy:new Pg([.7,1],[.2,.5],[.2,1],[.8,.8],[.75,.8],[.75,.5],[.1,1]),foggy:new Pg([.75,1],[.1,.1],[0,0],[.8,.9],[.5,.93],[.75,.9],[.2,.4])};function Ag(){const t=new Wa;return t.attributes.add("position","vec2"),t.include(Aa,{attributeTextureCoordinates:1}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3"),t.vertex.uniforms.add("projectionInverse","mat4"),t.vertex.uniforms.add("viewInverse","mat4"),t.vertex.code.add(Ua`void main(void) {
vec3 posViewNear = (projectionInverse * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (viewInverse * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),t.fragment.uniforms.add("lightingMainDirection","vec3").add("heightParameters","vec2").add("cameraPosition","vec3").add("nearFar","vec2").add("depthTex","sampler2D").add("strength","float").add("renderSkyFog","int"),t.include(ir),t.fragment.include(Ha),t.fragment.code.add(Ua`vec2 sphereIntersect(vec3 start, vec3 dir) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = heightParameters[1];
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),t.fragment.code.add(Ua`vec4 applyFog(vec3  rgb, float dist, vec3 cameraPos, vec3 rayDir, vec3 sunDir){
bool sky = false;
if(dist == -1.0){
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir);
dist = 0.1 * rayAtmosphereIntersect.y;
sky = true;
}
float fogAmount = smoothstep(10000.0, 9000.0, heightParameters[0]) * (1.0 - exp(-dist * strength));
float sunAmount = max(0.0, dot(rayDir, sunDir));
float lightAngle = max(0.0, dot(normalize(cameraPos + dist * rayDir), sunDir));
vec3 fogColor = mix(vec3(0.15), vec3(1.5), lightAngle);
float phase = sky ? pow(sunAmount, 16.0) : 0.0;
vec3 col = (lightAngle * vec3(1.0, 0.6, 0.3) * phase + fogColor) * fogAmount;
return vec4(col, fogAmount);
}`),t.fragment.code.add(Ua`vec3 tonemapACES(vec3 x) {
return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
}
void main() {
vec3 rayDir = normalize(worldRay);
float terrainDepth = -1.0;
vec4 depthSample = texture2D(depthTex, vuv0).rgba;
if (depthSample != vec4(0)) {
vec3 cameraSpaceRay = normalize(eyeDir);
cameraSpaceRay /= cameraSpaceRay.z;
cameraSpaceRay *= -linearDepthFromTexture(depthTex, vuv0, nearFar);
terrainDepth = max(0.0, length(cameraSpaceRay));
}else if(renderSkyFog == 0){
gl_FragColor = vec4(0);
return;
}
vec4 fog = applyFog(vec3(0), terrainDepth, cameraPosition, rayDir, lightingMainDirection);
vec3 col =  fog.rgb;
gl_FragColor = delinearizeGamma(vec4(tonemapACES(col), fog.a));
}`),t}const _g=Object.freeze({__proto__:null,build:Ag});class Dg extends Ya{initializeProgram(t){const e=Dg.shader.get().build();return new Xa(t.rctx,e,Ka)}initializePipeline(){return Gh({blending:qh(770,0,771,1),colorWrite:Wh})}}Dg.shader=new $a(_g,(()=>import("./p-dd5cfa72.js")));class Og{constructor(t,e){this.canRender=!0,this._slot=13,this._cameraPosition=js(),this._projectionInverse=gn(),this._viewInverse=gn(),this._nearFar=Sa(),this._renderSkyFog=!1,this._heightParameters=Sa(),this.strength=1e-5,this._technique=new Dg({rctx:t,viewingMode:e.state.viewingMode},null),this._vao=Ja(t,th);const i=Qr(e.spatialReference);this._planetRadius=i.radius,this._atmosphereRadius=i.radius+1e5}set strength(t){this._strength=t}get strength(){return this._strength}set renderSkyFog(t){this._renderSkyFog=t}get renderSkyFog(){return this._renderSkyFog}destroy(){this._technique=Z(this._technique),this._vao=Q(this._vao)}when(){return Promise.resolve()}render(t){if(t.slot!==this._slot||0!==t.pass)return!1;this._update(t.camera);const e=t.rctx,i=t.offscreenRenderingHelper,s=i.linearDepthTexture;return e.useProgram(this._technique.program),this._technique.bindPipelineState(e),i.renderDepthDetached((()=>{this._technique.program.bindTexture(s,"depthTex"),this._renderFog(this._technique.program,t)})),!0}_renderFog(t,e){if(w(this._vao))return!1;const i=e.rctx;return e.scenelightingData.setLightDirectionUniform(t),t.setUniform3fv("cameraPosition",this._cameraPosition),t.setUniformMatrix4fv("projectionInverse",this._projectionInverse),t.setUniformMatrix4fv("viewInverse",this._viewInverse),t.setUniform2fv("nearFar",this._nearFar),t.setUniform2fv("heightParameters",this._heightParameters),t.setUniform1f("strength",this._strength),t.setUniform1i("renderSkyFog",this._renderSkyFog?1:0),i.bindVAO(this._vao),t.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(5,0,4),!0}_update(t){if(w(t))return;$i(this._cameraPosition,t.eye),so(this._projectionInverse,t.projectionMatrix),so(this._viewInverse,t.viewMatrix),pa(this._nearFar,t.near,t.far);const e=Xi(t.eye);this._heightParameters=Pa(e-this._planetRadius,e*e-this._atmosphereRadius*this._atmosphereRadius)}static isSupported(t){return t.renderContext.rctx.capabilities.depthTexture}}function Rg(t){const e=new Wa;if(2===t.geometry)e.attributes.add("position","vec2"),e.varyings.add("color","vec4"),e.vertex.uniforms.add("lightingMainDirection","vec3").add("cameraPosition","vec3").add("undergroundFadeAlpha","float"),e.vertex.code.add(Ua`void main(void) {
float ndotl = dot(normalize(cameraPosition), lightingMainDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);
}`),e.fragment.code.add(Ua`void main() {
gl_FragColor = color;
}`);else{e.include(nh,{linearDepth:!1}),e.attributes.add("position","vec3"),e.varyings.add("vtc","vec2"),e.varyings.add("falloff","float");const i=1===t.geometry;e.vertex.uniforms.add("proj","mat4").add("view","mat4").add("lightingMainDirection","vec3"),i||(e.varyings.add("innerFactor","float"),e.vertex.uniforms.add("silCircleCenter","vec3").add("silCircleV1","vec3").add("silCircleV2","vec3").add("texV","vec2").add("innerScale","float"));const s=6.2831853,n=1/128;e.vertex.code.add(Ua`
		void main(void) {
      ${i?Ua`
      vec3 pos = position;
      float ndotl = lightingMainDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:Ua`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${Ua.float(s*n)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), lightingMainDirection);
      vtc.x = position.x  * ${Ua.float(n)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
    }
	  `),e.fragment.uniforms.add("tex","sampler2D"),i||e.fragment.uniforms.add("altitudeFade","float"),e.fragment.code.add(Ua`
		void main() {
			vec4 atmosphereColor = texture2D(tex, vtc) * falloff;
      ${i?Ua`gl_FragColor = atmosphereColor;`:Ua`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			gl_FragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));
      `}
    }`)}return e}const Fg=Object.freeze({__proto__:null,build:Rg});class zg extends Ya{initializeProgram(t){const e=zg.shader.get().build({geometry:this.configuration.geometry});return new Xa(t.rctx,e,Ka)}initializePipeline(){return Gh(1===this.configuration.geometry?{blending:qh(770,1,771,771),culling:Hh,depthTest:{func:515},colorWrite:Wh}:{blending:qh(770,1,771,771),depthTest:{func:515},colorWrite:Wh})}}zg.shader=new $a(Fg,(()=>import("./p-028decf2.js")));class Lg extends Qa{constructor(){super(...arguments),this.geometry=0}}r([Za({count:3})],Lg.prototype,"geometry",void 0);const Eg="data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAABD1gYFAAAACXBIWXMAAC4jAAAuIwF4pT92AAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAXVJREFUeNq0k9GWhDAIQ3PjzP9/cuehFqhW19mz++IhkCZAq1prsqT+kSQS9g8Vnqp6VGVWkYVktR6tj3Gr968nLnfwlHzHYyHapkKS73bPd/39eI38AYWj24OGvqdwWjZ3l8IDgacXyl1Dj9tdLOzZiicj+P1YcGk0H2O2vN/VQpTveEHmPHQxZxYlqsQdhUeuCWREuDEvAjqlCqDIMYwIo2ijR1HdYUS58dQrKpgQ0EGeMocsTNXrxzyOhS9kfzlWjn82YuWLqwAnvfNEWJFjYXkJCT0s7AmS0NG4x7Lt6Cpy2MiVPBZmS668QT5AR1cevp7b6CpzQ/ZSNH0vmhy5CsNtdax0MBpXDBiFsrDiMSLKMc8b6hH93bNbEpRsIyHDUhNcfTyeKF16PC7c/2QdczvUnvOB1ylZHVFSMtd5s8C2IW/7w6hwM5GLavLCd1zkiFjB+BwH1DSgctQ7mPOimBLJrw35beSXkd8BM/cCqbXWPgMA+GQQ5sIgkfAAAAAASUVORK5CYII=",Ig=y.getLogger("esri.views.3d.environment.PanoramicAtmosphere");class Vg{constructor(){this.slot=12,this._atmosphereTechniqueConfig=new Lg,this._readyResolver=x(),this._readyController=new AbortController}get canRender(){return null!=this._texture}destroy(){this._readyResolver.reject(),this._texture=Q(this._texture),this._vao=Q(this._vao),this._readyController=K(this._readyController)}when(){return this._readyResolver.promise}initializeRenderContext(t){this._atmosphereTechniqueConfig.geometry=1,this._atmosphereTechnique=t.shaderTechniqueRep.acquire(zg,this._atmosphereTechniqueConfig);const e=t.renderContext.rctx;this._vao=this._createVertexArrayObject(e),this._vaoCount=ul(this._vao,"geometry"),Zh(Eg,{signal:this._readyController.signal}).then((i=>{this._texture=new ml(e,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},i),t.requestRender(),this._readyController=null,this._readyResolver.resolve()})).catch((t=>{F(t)||Ig.error("Unable to initialize atmosphere: image request failed",t),this._readyResolver.reject()}))}uninitializeRenderContext(){this.destroy()}render(t){if(t.slot!==this.slot||0!==t.pass)return!1;const e=t.rctx,i=this._atmosphereTechnique.program;return e.useProgram(i),this._atmosphereTechnique.bindPipelineState(e),i.bindTexture(this._texture,"tex"),rh(i,t.camera.projectionMatrix),function(t,e){io(t,e),t[12]=0,t[13]=0,t[14]=0,t[15]=1}(jg,t.camera.viewMatrix),i.setUniformMatrix4fv("view",jg),i.setUniform4f("color",1,1,1,1),t.scenelightingData.setLightDirectionUniform(i),e.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),e.drawArrays(4,0,this._vaoCount),!0}_createVertexArrayObject(t){const e=sr.createPolySphereGeometry(1,2,!1),i=e.indices.get("position");for(let t=0;t<i.length;t+=3){const e=i[t];i[t]=i[t+2],i[t+2]=e}const s=e.vertexAttributes.get("position").data,n=Ng.createBuffer(i.length),r=n.position;for(let t=0;t<i.length;++t){const e=3*i[t];r.set(t,0,s[e]),r.set(t,1,s[e+1]),r.set(t,2,s[e+2])}return new dl(t,Ka,{geometry:vl(Ng)},{geometry:pl.createVertex(t,35044,n.buffer)})}}const jg=gn(),Ng=yl().vec3f("position");function kg(t){const e=new Wa;return e.attributes.add("position","vec2"),e.attributes.add("uv0","vec2"),e.varyings.add("worldRay","vec3"),e.varyings.add("vtc","vec2"),t.haze&&e.varyings.add("eyeDir","vec3"),e.vertex.uniforms.add("projectionInverse","mat4"),e.vertex.uniforms.add("viewInverse","mat4"),e.vertex.code.add(Ua`
    void main(void) {
      vec3 posViewNear = (projectionInverse * vec4(position, -1, 1)).xyz;

      worldRay = (viewInverse * vec4(posViewNear, 0)).xyz;
      vtc = uv0;

      ${t.haze?Ua`eyeDir = posViewNear;`:""}

      gl_Position = vec4(position, 1, 1);
    }
  `),e.fragment.uniforms.add("lightingMainDirection","vec3").add("radii","vec2").add("atmosphereParameters1","vec4").add("atmosphereParameters2","vec4").add("cameraPosition","vec3").add("nearFar","vec2").add("heightParameters","vec4"),t.haze?e.fragment.uniforms.add("depthTex","sampler2D"):e.fragment.uniforms.add("atmosphereParameters3","vec3").add("innerFadeDistance","float").add("altitudeFade","float"),e.fragment.include(ih),e.fragment.code.add(Ua`
  const vec3 invWavelength = vec3(${Ua.float(t.invWavelength[0])}, ${Ua.float(t.invWavelength[1])}, ${Ua.float(t.invWavelength[2])});

  const vec3 invWavelengthScaled = vec3(${Ua.float(t.invWavelengthScaled[0])}, ${Ua.float(t.invWavelengthScaled[1])}, ${Ua.float(t.invWavelengthScaled[2])});

  // Atmosphere
  const float krESun = 0.075;        // Kr * ESun = 0.005 * 15.0
  const float kmESun = 0.015;        // Km * ESun = 0.005 * 15

  // The inner (planetary) radius
  #define innerRadius radii[0]
  // The outer (atmosphere) radius
  #define outerRadius radii[1]

  // Atmosphere parameters:

  // shellScale:               1.0 / (outerRadius - innerRadius)
  #define shellScale atmosphereParameters1.x

  // shellDepth:               The scale depth (i.e. the altitude at which the atmosphere's average density is found)
  // scaleDepthBlue:           The scale depth (i.e. the altitude at which the atmosphere's average density is found)
  #define shellDepth vec2(atmosphereParameters1.y, atmosphereParameters2.y)

  // scaleOverScaleDepth:      scale / shellDepth
  // scaleOverScaleDepthBlue:  scale / scaleDepthBlue
  #define scaleOverScaleDepth vec2(atmosphereParameters1.z, atmosphereParameters2.z)

  // oneOverScaleDepth:        1.0 / shellDepth
  // oneOverScaleDepthBlue;    1.0 / scaleDepthBlue
  #define oneOverScaleDepth vec2(atmosphereParameters1.w, atmosphereParameters2.w)
  `),t.haze||e.fragment.code.add(Ua`#define g atmosphereParameters2.x
#define gSq atmosphereParameters3.x
#define miePhaseCoefficients atmosphereParameters3.y
#define lowerAlphaBlendBound atmosphereParameters3.z`),e.fragment.code.add(Ua`
  // The camera's current height
  #define cameraHeight heightParameters[0]
  // cameraHeight^2
  #define cameraHeightSq heightParameters[1]
  // cameraHeightSq - outerRadiusSq; // C = ||o-c||^2 - r^2
  #define C heightParameters[2]
  // cameraHeightSq - (innerRadiusSq - 63756370000.0); // C = ||o-c||^2 - r^2
  #define CSur heightParameters[3]

  ${t.haze?"// Camera HDR\n        const float exposure = 1.5;\n        const vec3 oneOverGamma = vec3(1.0); //Gamma = 1.0":"const float exposure = 2.0;\n        const vec3 oneOverGamma = vec3(0.454545); // Gamma = 2.2\n        vec3 reinhardTM(vec3 inputColor, float _exposure) {\n          vec3 intermediate = inputColor * _exposure;\n          intermediate /= ( 1.0 + intermediate );\n          return pow(intermediate, oneOverGamma);\n        }\n        "}
    // Loop constants for integral approximation
    const float samples = 5.0;
    const int maxSamples = 5;

    // ToneMapping operators
    vec3 expTM(vec3 inputColor,float _exposure) {
        return pow(1.0 - exp(inputColor * -_exposure), oneOverGamma);
    }

    // Approximation for inner integral based on a radii ratio of 10.25:10
    float scale(float _cos) {
      float x = 1.0 - _cos;
      return exp( -0.00287 + x * ( 0.459 + x * ( 3.83 + x * (-6.80 + x * 5.25 ))));
    }

    void main() {
      // Obtain ray from Camera
      vec3 worldSpaceRay = normalize(worldRay);

      // Compute Atmosphere intersection; i.e. ray/sphere intersection
      float B = 2.0 * dot(cameraPosition, worldSpaceRay); // B = 2(l * (o-c))
      float det = B * B - 4.0 * C; // det = B^2 - 4.0* C

      // idealized sphere intersection to discard early some pixels
      float detSur = B * B - 4.0 * CSur; // det = B^2 - 4.0* C

      // the minimal sample start position:
      // at the camera by default, on the earth radius surface if the camera is underground.
      float minRayStart = 0.0;
  `),t.haze||e.fragment.code.add(Ua`float surfaceBlend = 0.0;
vec4 surfaceColor = vec4(0.0);
if (detSur >= 0.0) {
float nearSurface = max(0.0, 0.5 *(-B - sqrt(detSur)));
float farSurface = max(0.0, 0.5 *(-B + sqrt(detSur)));
if (nearSurface == 0.0) {
minRayStart = farSurface;
}
vec3 vPos = cameraPosition + worldSpaceRay * nearSurface;
float lightAngle = dot(lightingMainDirection, normalize(vPos));
float brightness = max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)));
surfaceColor = vec4(brightness, brightness, brightness, 1.0 - altitudeFade);
float relDist = (farSurface - nearSurface) / innerFadeDistance;
if (relDist > 1.0) {
gl_FragColor = surfaceColor;
return;
}
surfaceBlend = smoothstep(0.0, 1.0, relDist * relDist);
}`),e.fragment.code.add(Ua`
    if (det >= 0.0) {
    ${t.haze?"\n          float depthSample = texture2D(depthTex, vtc).r;\n\n          float zNear = nearFar[0];\n          float zFar = nearFar[1];\n\n          // http://web.archive.org/web/20130416194336/http://olivers.posterous.com/linear-depth-in-glsl-for-real\n          float zNorm = 2.0 * depthSample - 1.0;\n          float linDepth = 2.0 * zNear * zFar /\n            (zFar + zNear - zNorm * (zFar - zNear));\n\n          float rayEnd;\n          float altitudeAlpha = 1.0;\n\n          // find intersections with ground, but only between the near and far\n          // clipping planes.\n          if (depthSample < 1.0 && depthSample > 0.0) {\n            vec3 cameraSpaceRay = normalize(eyeDir);\n            cameraSpaceRay /= cameraSpaceRay.z;\n            cameraSpaceRay *= linDepth;\n\n            float cameraSpaceRayLength = length(cameraSpaceRay);\n\n            vec3 world = cameraPosition + worldSpaceRay * cameraSpaceRayLength;\n            float worldRadiusSq = dot(world, world);\n\n            // Handle tall structures:\n            // https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/5450\n            float transitionStart = innerRadius + 20000.0;\n            float transitionHeight = 25000.0;\n            float transitionEnd = transitionStart + transitionHeight;\n\n            float edge0 = transitionStart * transitionStart;\n            float edge1 = transitionEnd * transitionEnd;\n\n            altitudeAlpha = 1.0 - clamp((worldRadiusSq - edge0) / (edge1 - edge0), 0.0, 1.0);\n            rayEnd = cameraSpaceRayLength;\n\n            if (altitudeAlpha > 0.0 && detSur > 0.0) {\n              float nearSurface = 0.5 * ( -B - sqrt(detSur) );\n              float interp = clamp(((cameraHeight - innerRadius) - 2000000.0) / 6000000.0, 0.0, 1.0);\n              rayEnd = mix(cameraSpaceRayLength, nearSurface, interp);\n            }\n          }":""}
    float rayStart = 0.5 *(-B - sqrt(det)); //near intersection with atmosphere
    ${t.haze?"float near = abs(rayStart);\n        float far = abs(rayEnd);":"float rayEnd = 0.5 *(-B + sqrt(det)); //far intersection with atmosphere"}

    float scatterDistance; // calculate its scattering offset
    // Calculate the ray's starting position
    if (rayStart < minRayStart)
    { // ray starts from camera or inner radius sphere to far
      rayStart = minRayStart;
      ${t.haze?"":"// clamp to value at inner radius altitude\n          scatterDistance = shellScale * min(0.0, innerRadius - cameraHeight);"}
    }
    ${t.haze?"":"else { // outside atmosphere\n          scatterDistance = -1.0;\n        }"}
    // Initialize the scattering loop variables
    vec3 start = cameraPosition + worldSpaceRay * rayStart;
  `),t.haze&&e.fragment.code.add(Ua`vec3 end = cameraPosition + worldSpaceRay * rayEnd;
float endLength = length(end);
vec2 altitudeInterval = vec2(length(start) - innerRadius, endLength - innerRadius);
if (altitudeInterval.x < 0.0) {
altitudeInterval = -altitudeInterval;
}
float lightAngle = dot(lightingMainDirection, end) / endLength;
if (near > far)
{
if (altitudeInterval.x < altitudeInterval.y)
{
end = cameraPosition + worldSpaceRay * rayStart;
start = cameraPosition + worldSpaceRay * rayEnd;
worldSpaceRay *= -1.0;
float tmp = altitudeInterval.x;
altitudeInterval.x = altitudeInterval.y;
altitudeInterval.y = tmp;
}
else if (altitudeInterval.x == altitudeInterval.y)
{
altitudeInterval.x += 1.0;
}
}
if (altitudeInterval.x > outerRadius - innerRadius)
{
scatterDistance = innerRadius - outerRadius;
} else
{
scatterDistance = altitudeInterval.y - altitudeInterval.x;
}`),e.fragment.code.add(Ua`vec2 opticalStartDepth = exp(scatterDistance * oneOverScaleDepth);
float rayLength = rayEnd - rayStart;
float sampleLength = rayLength / samples;
float scaledLength = sampleLength * shellScale;
vec3 sampleRay = worldSpaceRay * sampleLength;
vec3 samplePoint = start + sampleRay * 0.5;`),e.fragment.code.add(t.haze?Ua`float cameraAngle = dot(-worldSpaceRay, end) / length(end);
float scaleCameraAngle = scale(cameraAngle);
vec2 cameraOffset = scaleCameraAngle * opticalStartDepth;
float scaledValues = scale(lightAngle) + scaleCameraAngle;
vec2 scaledValuesDepth = scaledValues * shellDepth;`:Ua`float cameraAngle = dot(worldSpaceRay, start / length(start));
float angleMultiplier = cameraAngle > 0.0 ? cameraAngle : 0.0;
float scaleCameraAngle = scale(cameraAngle);
vec2 cameraOffset = scaleCameraAngle * opticalStartDepth * shellDepth;`),e.fragment.code.add(Ua`vec3 frontColor = vec3(0.0);
vec3 frontColorBlue = vec3(0.0);
vec3 attenuate = vec3(0.0);
vec3 attenuateBlue = vec3(0.0);
for(int i=0; i<maxSamples; i++) {
float height = length(samplePoint);
float altitude = abs(height - innerRadius);
vec2 depth = exp(-altitude * scaleOverScaleDepth);`),e.fragment.code.add(t.haze?Ua`vec2 scatter = depth * scaledValuesDepth - cameraOffset;`:Ua`float lightAngle = dot(lightingMainDirection, samplePoint) / height;
float cameraAngle = dot(worldSpaceRay, samplePoint) / height;
float tmpScaledValues = scale(lightAngle) - scale(cameraAngle);
vec2 scatter = cameraOffset + tmpScaledValues * depth * shellDepth;`),e.fragment.code.add(Ua`attenuate = exp(-scatter.x * invWavelengthScaled);
attenuateBlue = exp(-scatter.y * invWavelengthScaled);
frontColor += attenuate * depth.x;
frontColorBlue += attenuateBlue * depth.y;
samplePoint += sampleRay;
}
float LdotR = clamp(dot(lightingMainDirection, -worldSpaceRay ),-0.9999999,1.0);
float LdotRSq = LdotR * LdotR + 1.0;`),e.fragment.code.add(t.haze?Ua`vec3 colorCoefficients = (scaledLength * 0.75 * LdotRSq) * (krESun * invWavelength + kmESun );
vec3 color = colorCoefficients * frontColor;
vec3 colorBlue = colorCoefficients * frontColorBlue;`:Ua`vec3 rayleighCoefficients = (scaledLength * 0.75 * LdotRSq * krESun) * invWavelength;
float mieCoefficients = scaledLength * kmESun * miePhaseCoefficients * LdotRSq / pow(1.0 + gSq - 2.0 * g * LdotR, 1.5);
vec3 color = rayleighCoefficients * frontColor + mieCoefficients * frontColor;
vec3 colorBlue = rayleighCoefficients * frontColorBlue + mieCoefficients * frontColorBlue;`),e.fragment.code.add(Ua`vec3 ldrBlue = expTM(colorBlue, 2.0 * exposure);
vec3 ldrRed = expTM(color, exposure);
vec3 LDR = mix(ldrBlue, ldrRed, 0.2);`),e.fragment.code.add(t.haze?Ua`LDR *= (1.0 - cameraAngle);
vec3 hsv = rgb2hsv(LDR);
hsv.y = clamp(hsv.y * 1.5, 0.0, 1.0);
LDR = hsv2rgb(hsv);
vec3 finalColor = LDR;`:Ua`vec3 ldrReinhard = reinhardTM(color, exposure);
LDR += angleMultiplier * ldrReinhard;
float side = (rayEnd + rayStart) * 0.5;
float atmoHeight = sqrt(cameraHeightSq - side * side);
float h2 = clamp(1.0 - ( atmoHeight - lowerAlphaBlendBound ) / ( outerRadius - lowerAlphaBlendBound ), 0.0, 1.0);
vec3 finalColor = LDR * h2;
vec3 hsv = rgb2hsv(finalColor);
hsv.y = clamp(hsv.y * 1.5, 0.0, 1.0);
finalColor = hsv2rgb(hsv);`),e.fragment.code.add(Ua`
    ${t.haze?"gl_FragColor = vec4(finalColor, 1.0) * altitudeAlpha;":"float atmosStrength = clamp((length(ldrRed) - 0.05) * 1.05, 0.0, 1.0);\n          gl_FragColor = vec4(finalColor, atmosStrength * clamp(1.0 - ( atmoHeight - innerRadius ) / (outerRadius - innerRadius), 0.0, 1.0));\n          if (surfaceBlend > 0.0) {\n            gl_FragColor = mix(gl_FragColor, surfaceColor, surfaceBlend);\n          }"}
      } else { // Outside Atmosphere
        gl_FragColor = vec4(0.0);
      }
    }
  `),e}const Bg=Object.freeze({__proto__:null,build:kg});class Gg extends Ya{initializeProgram(t){const e=.02*Math.PI,i=.004*Math.PI,s=Ns(1/.65**4,1/.57**4,1/.475**4),n=ks(s);Yi(n,n,e),Ki(n,n,Ns(i,i,i));const r=Gg.shader.get().build({haze:this.configuration.haze,invWavelength:s,invWavelengthScaled:n});return new Xa(t.rctx,r,Ka)}initializePipeline(){return Gh(this.configuration.haze?{blending:qh(1,0,769,1),colorWrite:Wh}:{blending:qh(770,1,771,771),depthTest:{func:515},colorWrite:Wh})}}Gg.shader=new $a(Bg,(()=>import("./p-4f9cd926.js")));class qg extends Qa{constructor(){super(...arguments),this.haze=!1}}r([Za()],qg.prototype,"haze",void 0);class Wg{constructor(t){this._view=t,this.canRender=!0,this._skyslot=12,this._hazeSlot=13,this._renderData={texDepth:Sa(),cameraPosition:js(),projectionInverse:gn(),viewInverse:gn(),heightParameters:sa(),atmosphereParameters1:sa(),atmosphereParameters2:sa(),atmosphereParameters3:js(),radii:Sa(),scale:0,scaleDepth:Ug,lowerAlphaBlendBound:0,scaleOverScaleDepth:0,oneOverScaleDepth:0,scaleDepthBlue:Hg,oneOverScaleDepthBlue:Qg,scaleOverScaleDepthBlue:0,g:Yg,g2:Yg*Yg,miePhaseCoefficients:Xg,nearFar:Sa(),cameraHeight:0,cameraHeightSq:0,C:0,CSur:0,innerFadeDistance:0,altitudeFade:0},this._lowerElevationBoundRadius=0,this._lowerBoundEarthRadius=U.radius,this._updateRadius(U.radius)}destroy(){this._handles&&(this._handles.destroy(),this._handles=null),this._vao&&(this._vao.dispose(),this._vao=null)}when(){return Promise.resolve()}initializeRenderContext(t){const e=t.renderContext.rctx;this._handles=new E,p(this._view.basemapTerrain.rootTiles)&&this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,context:"ground"}),this._handles.add(X(this._view,"basemapTerrain","elevation-change",(t=>this._updateElevation(t)),(()=>this._updateElevation()))),this._handles.add(X(this._view,"basemapTerrain","elevation-bounds-change",(()=>this._updateVisibleElevationBounds()),(()=>this._updateVisibleElevationBounds())));const i=new qg;i.haze=!1,this._atmosphereTechnique=t.shaderTechniqueRep.acquire(Gg,i),i.haze=!0,this._atmosphereHazeTechnique=t.shaderTechniqueRep.acquire(Gg,i),this._vao=this._createVertexArrayObject(e)}uninitializeRenderContext(){this.destroy()}render(t){return(t.slot===this._hazeSlot||t.slot===this._skyslot)&&0===t.pass&&(this._update(t.camera),t.slot===this._skyslot&&this._renderSky(t),t.slot===this._hazeSlot&&this._renderHaze(t),!0)}_renderSky(t){const e=t.rctx,i=this._atmosphereTechnique.program;e.useProgram(i),this._atmosphereTechnique.bindPipelineState(e),i.setUniform3fv("atmosphereParameters3",this._renderData.atmosphereParameters3),this._renderCommon(i,t)}_renderHaze(t){const e=t.rctx,i=t.offscreenRenderingHelper,s=this._atmosphereHazeTechnique.program;e.useProgram(s),this._atmosphereHazeTechnique.bindPipelineState(e),i.renderDepthDetached((()=>{s.bindTexture(i.depthTexture,"depthTex"),this._renderCommon(s,t)}))}_renderCommon(t,e){const i=e.rctx;e.scenelightingData.setLightDirectionUniform(t),t.setUniform4fv("heightParameters",this._renderData.heightParameters),t.setUniform3fv("cameraPosition",this._renderData.cameraPosition),t.setUniformMatrix4fv("projectionInverse",this._renderData.projectionInverse),t.setUniformMatrix4fv("viewInverse",this._renderData.viewInverse),t.setUniform2fv("nearFar",this._renderData.nearFar),t.setUniform2fv("radii",this._renderData.radii),t.setUniform4fv("atmosphereParameters1",this._renderData.atmosphereParameters1),t.setUniform4fv("atmosphereParameters2",this._renderData.atmosphereParameters2),t.setUniform1f("innerFadeDistance",this._renderData.innerFadeDistance),t.setUniform1f("altitudeFade",this._renderData.altitudeFade),i.bindVAO(this._vao),t.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(5,0,4)}_createVertexArrayObject(t){const e=Kg.createBuffer(4);return e.position.setVec(0,[-1,-1]),e.position.setVec(1,[1,-1]),e.position.setVec(2,[-1,1]),e.position.setVec(3,[1,1]),e.uv0.setVec(0,[0,0]),e.uv0.setVec(1,[1,0]),e.uv0.setVec(2,[0,1]),e.uv0.setVec(3,[1,1]),new dl(t,Ka,{geometry:vl(Kg)},{geometry:pl.createVertex(t,35044,e.buffer)})}_adjustRadiusForTesselation(t){const e=Math.PI/16/16;return t*Math.cos(e)}_updateElevation(t){const e=t?t.tile:f(this._view.basemapTerrain.rootTiles,[null])[0];if(w(e)||0!==e.lij[0])return;const i=this._adjustRadiusForTesselation(U.radius+e.elevationBounds[0]);i!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=i,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const t=this._adjustRadiusForTesselation(U.radius+this._view.basemapTerrain.elevationBounds.min);(this._lowerBoundEarthRadius<0||t<this._lowerBoundEarthRadius)&&this._updateRadius(t)}_updateRadius(t){this._lowerBoundEarthRadius=t;const e=t,i=e/10*10.25,s=1/(i-e),n=s/Ug,r=s/Hg,o=.3*(i-e)+e,a=this._renderData;ms(a.atmosphereParameters1,s,Ug,n,Zg),ms(a.atmosphereParameters2,Yg,Hg,r,Qg),ds(a.atmosphereParameters3,Yg*Yg,Xg,o),pa(a.radii,e,i),a.scale=s,a.lowerAlphaBlendBound=o,a.scaleOverScaleDepth=n,a.scaleOverScaleDepthBlue=r,a.innerFadeDistance=2*Math.sqrt(1e4*(2*e-1e4))}_update(t){t&&(this._renderData.cameraHeight=Xi(t.eye),this._renderData.cameraHeightSq=this._renderData.cameraHeight*this._renderData.cameraHeight,this._renderData.C=this._renderData.cameraHeightSq-this._renderData.radii[1]*this._renderData.radii[1],this._renderData.CSur=this._renderData.cameraHeightSq-this._renderData.radii[0]*this._renderData.radii[0],this._renderData.heightParameters=na(this._renderData.cameraHeight,this._renderData.cameraHeightSq,this._renderData.C,this._renderData.CSur),$i(this._renderData.cameraPosition,t.eye),so(this._renderData.projectionInverse,t.projectionMatrix),so(this._renderData.viewInverse,t.viewMatrix),pa(this._renderData.nearFar,t.near,t.far),this._renderData.altitudeFade=Hf(this._renderData.cameraHeight-this._lowerBoundEarthRadius))}static isSupported(t){return t.renderContext.rctx.capabilities.depthTexture}}const Ug=.25,Hg=.05,Zg=1/Ug,Qg=1/Hg,Yg=-.99999,Xg=(1-Yg*Yg)/(2+Yg*Yg)*1.5,Kg=yl().vec2f("position").vec2f("uv0"),$g=y.getLogger("esri.views.3d.environment.SimpleAtmosphere"),Jg=Js([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);class tm{constructor(t){this.view=t,this.slot=12,this._renderData={texV:Sa(),silCircleCenter:js(),silCircleV1:js(),silCircleV2:js(),altitudeFade:0,innerScale:0,undergroundFadeAlpha:0},this._fadeVaoCount=0,this._readyResolver=x(),this._readyController=new AbortController,this.texV1=1,this.isOnMars=$(t.spatialReference);const e=Qr(t.spatialReference);this.planetRadius=e.radius,this.outerRimWidth=e.outerAtmosphereRimWidth,this.innerRimFactor=(this.planetRadius+-1e4)/this.planetRadius,this.middleRimFactor=(this.planetRadius+0)/this.planetRadius,this.outerRimFactor=(this.planetRadius+this.outerRimWidth)/this.planetRadius,this.texV0=0/this.outerRimWidth,this.texVScale=this.texV1-this.texV0}get canRender(){return null!=this._texture}destroy(){this._readyResolver.reject(),this._cameraChangeHandle=J(this._cameraChangeHandle),this._texture=Q(this._texture),this._fadeVao=Q(this._fadeVao),this._vao=Q(this._vao),this._readyController=K(this._readyController)}when(){return this._readyResolver.promise}initializeRenderContext(t){this._shaderTechniqueRepository=t.shaderTechniqueRep;const e=t.renderContext.rctx;this._cameraChangeHandle=tt(this.view,"state.camera",(()=>t.requestRender()),!0),this._vao=this._createRibbon(e),this._vaoCount=ul(this._vao,"geometry"),this._fadeVao=Ja(e),this._fadeVaoCount=ul(this._fadeVao,"geometry"),Zh(this.isOnMars?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAAE00TaTAAAACXBIWXMAAA7AAAAOwAFq1okJAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAp1JREFUSMd9lcmSEzEQRCtflnqxYZgIThBDAP//kXDQ0pJtuDhqycxWZ5fKERFCERARIAVEyCjCtSFFEjWVa9q7OdJE0oiidIhKhRBROlhloiGVhaYERQHJWFEwMpYKrjUlibI2cqSJIJEpKNmM2c3GkRTOJDnThTMpnMWu0VFszs3Jfbe5bza3w+a229yOIs6zmP3czfn1K2w/for8+EVU15pNmmyqkeJyclinXNJRu1xrUaJmjmdzJiejVNt7zZVBRAIq1RwrsrrWnez+SR7WmQQP/1itKz2q/pmzuJtYnNy2bth9x9z2NLfDcB7FHOcGx6ebOb9/iPzxG/ztg4iorglFiKjzF9HSNphCoRb1OY3RZQJrYgRdT68bmgXGDdBzrTG8qNS7QP/m19ef7tGlcoH7vESYkK70uoPuOLEetz0IqeGoWQW6MlB/j36EnipYGKPWwDRg/RkNhXCNJIzAhMk6PrDePJNII6JHqM5VWqYApCtNFPe0GFFGtOWopWCrEVBSoiQi06KkRRaD08IlxXa/ifz8Jvz2LvjyLnh7F/r8Rei8a8xfjNkIrpmMOQ1C02COrkTEHxGhh+6DQJfXc/eZprXxcIyVIf1LJVgWvKaHvwI/1aQxtv851SQ/nqGXL6MHFVY3nmhLyqKsWO/+qzWif+yS1TpNKq8NezjGPCV69ciZoQj1PwfN6QRpWyCGVMe1D/AAHt3/gefu1Ign3AVpjOiNXkN90JlpL6TUnzFEUU+Jvks0tkp/dY3Fy1TzI24BWwsYJPyg11Q0FqDwK72xIz2kLojbeuxS1FpgtfNWyMX1gFw0j3W7RNeSHTVEe3VaV7SdCzVywFaEt02w7QH7Eeg4AvZDNdJ+Cu1HENsutO+Byi6ilEBZ9BeCNBJceJIjHgAAAABJRU5ErkJggg==":Eg,{signal:this._readyController.signal}).then((i=>{this._texture=new ml(e,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},i),t.requestRender(),this._readyController=null,this._readyResolver.resolve()})).catch((t=>{F(t)||$g.error("Unable to initialize simple atmosphere: image request failed",t),this._readyResolver.reject()}))}uninitializeRenderContext(){this.destroy()}get atmosphereConeTechnique(){if(w(this._atmosphereConeTechnique)){const t=new Lg;t.geometry=0,this._atmosphereConeTechnique=this._shaderTechniqueRepository.acquire(zg,t)}return this._atmosphereConeTechnique}get atmosphereUndergroundTechnique(){if(w(this._atmosphereUndergroundTechnique)){const t=new Lg;t.geometry=2,this._atmosphereUndergroundTechnique=this._shaderTechniqueRepository.acquire(zg,t)}return this._atmosphereUndergroundTechnique}render(t){if(t.slot!==this.slot||0!==t.pass)return!1;this._update(t.camera);const e=t.rctx;if(this.atmosphereConeTechnique.bindPipelineState(e),this._renderData.undergroundFadeAlpha<1){const i=this.atmosphereConeTechnique.program;e.useProgram(i),i.setUniformMatrix4fv("proj",t.camera.projectionMatrix),i.setUniformMatrix4fv("view",t.camera.viewMatrix),i.setUniform3fv("silCircleCenter",this._renderData.silCircleCenter),i.setUniform3fv("silCircleV1",this._renderData.silCircleV1),i.setUniform3fv("silCircleV2",this._renderData.silCircleV2),i.setUniform2fv("texV",this._renderData.texV),i.bindTexture(this._texture,"tex"),t.scenelightingData.setLightDirectionUniform(i),i.setUniform1f("altitudeFade",this._renderData.altitudeFade),i.setUniform1f("innerScale",this._renderData.innerScale),e.bindVAO(this._vao),e.drawArrays(4,0,this._vaoCount)}if(this._renderData.undergroundFadeAlpha>0){const i=this.atmosphereUndergroundTechnique.program;e.useProgram(i),i.setUniform1f("undergroundFadeAlpha",this._renderData.undergroundFadeAlpha),t.scenelightingData.setLightDirectionUniform(i),i.setUniform3fv("cameraPosition",t.camera.eye),e.bindVAO(this._fadeVao),e.drawArrays(5,0,this._fadeVaoCount)}return!0}_update(t){const e=js(),i=this.planetRadius,s=Xi(t.eye),n=s-i;if(n<0){const t=Math.min(-n/5e3,1);this._renderData.undergroundFadeAlpha=t}else this._renderData.undergroundFadeAlpha=0;const r=Math.max(50,n);this._renderData.innerScale=function(t,e,i){return t*t/(Math.sqrt(t*t-e*e)*Math.sqrt(t*t-i*i)+e*i)}(i+r,i,i+-1e4)-1,this._renderData.altitudeFade=Hf(n),Yi(e,t.eye,(i+50)/s),em(e,t.center,t.up,i,this._renderData);const o=this._computeScreenRimWidth(t,e,t.up,this._renderData),a=1-511/512,h=Jg(n);let l=this.texV0+a*this.texVScale,c=this.texV0+o*h*this.texVScale;if(n>50){em(t.eye,t.center,t.up,i,this._renderData);const e=this._computeScreenRimWidth(t,t.eye,t.up,this._renderData),s=fs((e-1.5)/(o-1.5),0,1);l=this.texV0+s*a*this.texVScale,c=this.texV0+ys(this.texV1,o*h,s)*this.texVScale}pa(this._renderData.texV,l,c)}_createRibbon(t){const e=new Float32Array(1155),i=new Uint32Array(1920);e[0]=0,e[1]=0,e[2]=-1;for(let t=0;t<128;t++){const s=9*t+3;e[s+0]=t,e[s+1]=this.innerRimFactor,e[s+2]=-1,e[s+3]=t,e[s+4]=this.middleRimFactor,e[s+5]=0,e[s+6]=t,e[s+7]=this.outerRimFactor,e[s+8]=1;const n=3*t+1,r=127===t?1:n+3,o=15*t;i[o+0]=n,i[o+1]=n+1,i[o+2]=r+1,i[o+3]=r+1,i[o+4]=r,i[o+5]=n,i[o+6]=n+1,i[o+7]=n+2,i[o+8]=r+2,i[o+9]=r+2,i[o+10]=r+1,i[o+11]=n+1,i[o+12]=n,i[o+13]=r,i[o+14]=0}const s=rm.createBuffer(i.length),n=s.position;for(let t=0;t<i.length;++t){const s=3*i[t];n.set(t,0,e[s]),n.set(t,1,e[s+1]),n.set(t,2,e[s+2])}return new dl(t,Ka,{geometry:vl(rm)},{geometry:pl.createVertex(t,35044,s.buffer)})}_computeScreenRimWidth(t,e,i,s){return Ki(sm,s.silCircleCenter,s.silCircleV2),Yi(nm,sm,this.outerRimFactor),ro(im,e,sm,i),wl(sm,im,t.projectionMatrix,t.viewport),wl(nm,im,t.projectionMatrix,t.viewport),cs(sm,nm)/t.height}}function em(t,e,i,s,n){const r=Xi(t),o=s*Math.sqrt(r*r-s*s)/r,a=Math.sqrt(s*s-o*o),h=n.silCircleV1,l=n.silCircleV2;return Yi(n.silCircleCenter,t,a/r),ss(h,t,e),vs(h)<1&&ss(h,t,i),Yi(h,h,o/Xi(h)),ss(l,h,t),Yi(l,l,o/Xi(l)),o}const im=gn(),sm=js(),nm=js(),rm=yl().vec3f("position");function om(){const t=new Wa;return t.attributes.add("position","vec3"),t.attributes.add("color","vec4"),t.attributes.add("size","float"),t.varyings.add("vcolor","vec4"),t.varyings.add("vsize","float"),t.vertex.uniforms.add("transform","mat4").add("viewport","vec4").add("pixelRatio","float"),t.include(nr),t.vertex.code.add(Ua`void main(void) {
vec4 posProj = transform * vec4(position, 0);
gl_Position = alignToPixelCenter(posProj, viewport.zw);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;
}`),t.fragment.code.add(Ua`void main() {
float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
gl_FragColor = vec4(vcolor.xyz, intensity);
}`),t}const am=Object.freeze({__proto__:null,build:om});class hm extends Ya{initializeProgram(t){const e=hm.shader.get().build();return new Xa(t.rctx,e,Ka)}initializePipeline(){return Gh({blending:qh(770,1,771,771),depthTest:{func:515},colorWrite:Wh})}bindPass(t){const e=this.makeInfiniteProjectionMatrix(t.camera.projectionMatrix,t.camera.near,lm);oo(e,e,t.camera.viewMatrix),oo(e,e,t.modelMatrix),this.program.setUniformMatrix4fv("transform",e),this.program.setUniform4fv("viewport",t.camera.fullViewport),this.program.setUniform1f("pixelRatio",t.camera.pixelRatio)}makeInfiniteProjectionMatrix(t,e,i){const s=24e-8;return io(i,t),i[10]=s-1,i[11]=-1,i[14]=(s-2)*e,i}}hm.shader=new $a(am,(()=>import("./p-573446e1.js")));const lm=gn(),cm=y.getLogger("esri.views.3d.environment.Stars");let um=class extends T{constructor(t){super(t),this._loadDataTask=null,this._numPoints=0,this._renderParameter={camera:null,modelMatrix:gn()},this._updatingTracking=new Pl}get updating(){return this._updatingTracking.updating||this.loading}get loading(){return p(this._loadDataTask)&&!this._loadDataTask.finished}get canRender(){return!this.loading}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=K(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=Q(this._technique),this._vao=Q(this._vao)}render(t,e){if(this._ensureResources(t),w(this._technique)||w(this._vao))return!1;const i=this._technique.program;return t.useProgram(i),this._renderParameter.camera=e,this._technique.bindPass(this._renderParameter),this._technique.bindPipelineState(t),t.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(0,0,this._numPoints),!0}_ensureResources(t){if(p(this._technique)||w(vm))return;this._technique=new hm({rctx:t,viewingMode:this.view.state.viewingMode},null),this._numPoints=vm.byteLength/gm;const e=new Float32Array(vm,0,2*this._numPoints),i=new Uint8Array(vm,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(t,e,i,this._numPoints),this._updatingTracking.add(this.view,"environment.lighting.date",(t=>this._update(t)),2)}_computeDayDuration(t){const e=t,i=new Date(t.getFullYear(),0,1,11,58,56);return(+e-+i)/(+new Date(t.getFullYear()+1,0,1,11,58,55)-+i)}_update(t){if(!t)return;const e=(t.getHours()/12+t.getMinutes()/60*(2/24)+t.getSeconds()/60*(2/1440)-.9972222)%2,i=2*this._computeDayDuration(t),s=this._renderParameter.modelMatrix;io(s,fm),Jr(s,s,-i*Math.PI),oo(s,pm,s),Jr(s,s,-e*Math.PI),this.requestRender()}_hexToRGB(t){return[parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16),parseInt(t.substring(4,6),16)]}_unpackUint8Attributes(t){return t>=192?[2.9,t-192]:t>=160?[2.5,t-160]:t>=128?[2,t-128]:t>=96?[1.5,t-96]:t>=64?[1,t-64]:t>=32?[.7,t-32]:[.4,t]}_createVertexArrayObject(t,e,i,s){const n=mm.createBuffer(s),r=n.position,o=n.color,a=n.size;for(let t=0;t<s;t++){const s=e[2*t+0],n=e[2*t+1];r.set(t,0,-Math.cos(s)*Math.sin(n)),r.set(t,1,-Math.sin(s)*Math.sin(n)),r.set(t,2,-Math.cos(n));const h=this._unpackUint8Attributes(i[t]),l=this._hexToRGB(dm[h[1]]);o.set(t,0,255*l[0]),o.set(t,1,255*l[1]),o.set(t,2,255*l[2]),o.set(t,3,255),a.set(t,h[0])}return new dl(t,Ka,{geometry:vl(mm)},{geometry:pl.createVertex(t,35044,n.buffer)})}_createLoadDataTask(){if(p(vm))return null;const t=et((async t=>{const{data:e}=await it("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:t});this._verifyStarData(e),vm=e}));return t.promise.catch((t=>{F(t)||cm.error(t)})).then((()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"))})),t}_verifyStarData(t){if(!t)throw new n("stars:no-data-received","Failed to create stars because star catalogue is missing");const e=t.byteLength/gm;if(e%1!=0||e>5e4||e<5e3)throw new n("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};r([o({constructOnly:!0})],um.prototype,"view",void 0),r([o({constructOnly:!0})],um.prototype,"requestRender",void 0),r([o({readOnly:!0})],um.prototype,"updating",null),r([o()],um.prototype,"_loadDataTask",void 0),r([o()],um.prototype,"_updatingTracking",void 0),um=r([a("esri.views.3d.environment.Stars")],um);const dm=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],pm=mn(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),fm=mn(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),gm=9,mm=yl().vec3f("position").vec4u8("color").f32("size");let vm=null;const ym=[12,13];let wm=class extends T{constructor(){super(...arguments),this._cloudsGeneratorTask=null,this._handles=new E,this._context=null,this._enableNewAtmosphere=ca(),this._pendingAtmosphere=null,this._atmosphere=null,this._stars=null,this._clouds=null,this._cloudComposition=null,this._fog=null,this._fogEnabled=!1}get needsLinearDepth(){return this._fogEnabled}get canRender(){return!(!this.view.basemapTerrain||!this.view.basemapTerrain.renderer.canRender)||"global"!==this.view.viewingMode}get updating(){return p(this._pendingAtmosphere)||p(this._stars)&&this._stars.updating||p(this._cloudsGeneratorTask)&&this._cloudsGeneratorTask.updating}get weatherEnabled(){var t,e,i;const s=null!==(null==(t=this.view)||null==(e=t.environment)?void 0:e.weather),n=ua();return(s||n)&&B(null==(i=this.view)?void 0:i.spatialReference)}renderCubeMap(){p(this._clouds)&&p(this._context)&&(this._clouds.resetRenderFlags(),this._context.requestRender())}initialize(){this.view._stage.addRenderPlugin(ym,this)}destroy(){this._pendingAtmosphere=Y(this._pendingAtmosphere),this._atmosphere=Y(this._atmosphere),this._stars=Y(this._stars),this._handles=Y(this._handles),this._clouds=Y(this._clouds),this._cloudComposition=Y(this._cloudComposition),this._cloudsGeneratorTask=J(this._cloudsGeneratorTask),this._fog=Y(this._fog),this.view&&null!=this.view._stage&&(this.view._stage.removeRenderPlugin(this),this._set("view",null))}initializeRenderContext(t=null){this._context=t,this._handles.add([W(this.view,"basemapTerrain",(()=>this._updateBasemapTerrain()),!0),ha((()=>({viewingMode:this.view.viewingMode,atmosphereEnabled:this.view.environment.atmosphereEnabled,atmosphereQuality:this.view.environment.atmosphere.quality})),(()=>this._updateAtmosphere()),la),ha((()=>this._starsUpdateParameters),(t=>this._updateStars(t)),{sync:!0,initial:!0,equals:st}),ha((()=>this._cloudsCreationParameters),(t=>this._createOrDestroyClouds(t)),{sync:!0,initial:!0,equals:st}),ha((()=>this._fogCreationParameters),(t=>this._createOrDestroyFog(t)),{sync:!0,initial:!0,equals:st}),ha((()=>this._weatherUpdateParameters),(t=>{this._updateWeather(t),this._updateFog(t)}),la)])}uninitializeRenderContext(){p(this._stars)&&(this._stars.destroy(),this._stars=null),p(this._atmosphere)&&(this._atmosphere.uninitializeRenderContext(),this._atmosphere.destroy(),this._atmosphere=null),this._clouds=Y(this._clouds),this._cloudComposition=Y(this._cloudComposition),this._fog=Y(this._fog)}render(t){let e=!1;return p(this._stars)&&this._stars.canRender&&12===t.slot&&0===t.pass&&this._stars.render(t.rctx,t.camera)&&(e=!0),p(this._atmosphere)&&this._atmosphere.canRender&&this._atmosphere.render(t)&&(e=!0),p(this._clouds)&&!this._clouds.running&&p(this._cloudComposition)&&12===t.slot&&0===t.pass&&(this._cloudComposition.render(t,this._clouds._frameBufferCube,p(this.view.animation),this._clouds.coverage,this._clouds.absorption)&&(e=!0),this._cloudComposition.isFading()&&this._setNeedsRender()),p(this._fog)&&this._fog.canRender&&13===t.slot&&0===t.pass&&(e=this._fog.render(t)&&e),e}get _cloudsCreationParameters(){return this.weatherEnabled?{view:this.view,viewingMode:this.view.state.viewingMode,rctx:p(this._context)?this._context.renderContext.rctx:null,radius:Qr(this.view.spatialReference).radius}:null}_createOrDestroyClouds(t){this._clouds=Y(this._clouds),this._cloudsGeneratorTask=J(this._cloudsGeneratorTask),this._cloudComposition=Y(this._cloudComposition),nt(t,(({view:t,viewingMode:e,rctx:i,radius:s})=>{this._clouds=new Sg(i,t,(()=>this._setNeedsRender())),this._cloudsGeneratorTask=this.view.resourceController.scheduler.registerTask(po.CLOUDS_GENERATOR,this._clouds),this._cloudComposition=new dg(i,e,s,Xi(t.state.camera.eye)-s)})),this._setNeedsRender()}get _weatherUpdateParameters(){var t,e;const i=null==(t=this.view)||null==(e=t.environment)?void 0:e.weather;return w(i)?null:{type:i.type,presetAdjustment:"foggy"===i.type?i.fogStrength:i.cloudCoverage}}_updateWeather(t){if(w(this._clouds)||w(t))return;const e=Tg[t.type].median;for(const i in Tg[t.type])if("median"!==i){const s=Tg[t.type][i],n=ys(s[0],s[1],e);this._clouds[i]=t.presetAdjustment<.5?ys(s[0],n,2*t.presetAdjustment):ys(n,s[1],2*(t.presetAdjustment-.5))}}_setNeedsRender(){p(this._context)&&this._context.requestRender()}get _starsUpdateParameters(){var t,e,i;return{view:this.view,starsEnabled:null!=(t=null==(e=this.view)||null==(i=e.environment)?void 0:i.starsEnabled)&&t}}_updateStars({view:t,starsEnabled:e}){e&&w(this._stars)?(this._stars=new um({view:t,requestRender:()=>this._setNeedsRender()}),this._setNeedsRender()):!e&&p(this._stars)&&(this._stars.destroy(),this._stars=null,this._setNeedsRender())}_updateFog(t){w(this._fog)||w(t)||("foggy"===t.type?(this._fog.strength=ys(1e-5,5e-4,t.presetAdjustment),this._fog.renderSkyFog=!0):(this._fog.strength=1e-5,this._fog.renderSkyFog=!1))}get _fogCreationParameters(){return this.weatherEnabled?{view:this.view,rctx:p(this._context)?this._context.renderContext.rctx:null,fogEnabled:this._fogEnabled}:null}_createOrDestroyFog(t){this.weatherEnabled&&this._fogEnabled&&w(this._fog)?(nt(t,(({view:t,rctx:e})=>{this._fog=new Og(e,t)})),this._updateFog(this._weatherUpdateParameters),this._setNeedsRender()):p(this._fog)&&(this._fog.destroy(),this._fog=null,this._setNeedsRender())}_updateAtmosphere(){const t=this._getAtmosphereType();if(this.atmosphereType===t)return;this.atmosphereType=t,p(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null);const e=this._getAtmosphereClass();if(!e)return p(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),void this._updateBasemapTerrain();const i=new e(this.view);p(this._context)&&i.initializeRenderContext(this._context),w(this._atmosphere)&&(this._atmosphere=i,this._setNeedsRender()),this._pendingAtmosphere=i,i.when().then((()=>{p(this._atmosphere)&&this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere),this._pendingAtmosphere=null,this._setNeedsRender(),this._updateBasemapTerrain()})).catch((()=>{this._pendingAtmosphere===i&&(this._pendingAtmosphere=null)}))}_getAtmosphereClass(){const t=this._getAtmosphereType();if(this.atmosphereClassFromType)return this.atmosphereClassFromType(t);switch(t){case"none":return null;case"chapman":return Jf;case"realistic":return Wg;case"panoramic":return Vg;case"simple":return tm;default:return}}_getAtmosphereType(){const t=this.view.get("environment.atmosphereEnabled"),e=this.view.get("environment.atmosphere.quality"),i=this.view.viewingMode;return!t||null==e||rt(this.view.spatialReference)?"none":"local"===i?"panoramic":"high"===e&&this._enableNewAtmosphere&&p(this._context)&&Jf.isSupported(this._context)&&!$(this.view.spatialReference)?"chapman":"high"===e&&p(this._context)&&Wg.isSupported(this._context)&&!$(this.view.spatialReference)?"realistic":"simple"}_updateBasemapTerrain(){this.view.basemapTerrain&&(this.view.basemapTerrain.velvetOverground=p(this._atmosphere)&&"simple"===this.atmosphereType)}get test(){return{atmosphere:this._atmosphere,clouds:this._clouds,enableNewAtmosphere:t=>{this._enableNewAtmosphere=t},updateAtmosphere:()=>{this._updateAtmosphere()},enableFog:t=>{this._fogEnabled=t}}}};r([o({constructOnly:!0})],wm.prototype,"view",void 0),r([o({constructOnly:!0})],wm.prototype,"atmosphereClassFromType",void 0),r([o()],wm.prototype,"_cloudsGeneratorTask",void 0),r([o({type:Boolean,readOnly:!0})],wm.prototype,"updating",null),r([o()],wm.prototype,"_pendingAtmosphere",void 0),r([o()],wm.prototype,"_stars",void 0),r([o()],wm.prototype,"_clouds",void 0),r([o()],wm.prototype,"_cloudComposition",void 0),r([o()],wm.prototype,"_fog",void 0),r([o()],wm.prototype,"_fogEnabled",void 0),r([o()],wm.prototype,"weatherEnabled",null),r([o()],wm.prototype,"_cloudsCreationParameters",null),r([o()],wm.prototype,"_weatherUpdateParameters",null),r([o()],wm.prototype,"_starsUpdateParameters",null),r([o()],wm.prototype,"_fogCreationParameters",null),wm=r([a("esri.views.3d.environment.EnvironmentRenderer")],wm);var xm,bm,Cm={exports:{}};xm=Cm,void 0!==(bm=function(){var t=Math.PI,e=Math.sin,i=Math.cos,s=Math.tan,n=Math.asin,r=Math.atan2,o=Math.acos,a=t/180,h=864e5,l=2440588,c=2451545,u={dec:0,ra:0};function d(t){return new Date((t+.5-l)*h)}function p(t){return function(t){return t.valueOf()/h-.5+l}(t)-c}var f=23.4397*a;function g(t,n){return r(e(t)*i(f)-s(n)*e(f),i(t))}function m(t,s){return n(e(s)*i(f)+i(s)*e(f)*e(t))}function v(t,n,o){return r(e(t),i(t)*e(n)-s(o)*i(n))}function y(t,s,r){return n(e(s)*e(r)+i(s)*i(r)*i(t))}function w(t,e){return a*(280.16+360.9856235*t)-e}function x(t){return a*(357.5291+.98560028*t)}function b(t){return a*(1.9148*e(t)+.02*e(2*t)+3e-4*e(3*t))}function C(e,i){return e+i+102.9372*a+t}function M(t,e){var i=x(t),s=C(i,b(i));return e||(e={dec:0,ra:0}),e.dec=m(s,0),e.ra=g(s,0),e}var S={POLAR_EXCEPTION:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(t,e,i,s){var n=a*-i,r=a*e,o=p(t),h=M(o,u),l=w(o,n)-h.ra;return s||(s={azimuth:0,altitude:0}),s.azimuth=v(l,r,h.dec),s.altitude=y(l,r,h.dec),s}},P=[[-.83,"sunrise","sunset"]];S.addTime=function(t,e,i){P.push([t,e,i])};var T=9e-4;function A(e,i){return Math.round(e-T-i/(2*t))}function _(e,i,s){return T+(e+i)/(2*t)+s}function D(t,i,s){return c+t+.0053*e(i)-.0069*e(2*s)}function O(t,s,n){return o((e(t)-e(s)*e(n))/(i(s)*i(n)))}function R(t){var s=a*(134.963+13.064993*t),n=a*(93.272+13.22935*t),r=a*(218.316+13.176396*t)+6.289*a*e(s),o=5.128*a*e(n),h=385001-20905*i(s);return{ra:g(r,o),dec:m(r,o),dist:h}}return S.getTimes=function(t,s,n){var r=a*-n,o=a*s,h=A(p(t),r),l=_(0,r,h),c=x(l),u=b(c),f=C(c,u),g=m(f,0),v=D(l,c,f);function y(t){return D(_(O(t,o,g),r,h),c,f)}var w,M,T,R,F,z={solarNoon:d(v),nadir:d(v-.5),polarException:S.POLAR_EXCEPTION.NORMAL};for(w=0,M=P.length;w<M;w+=1)F=v-((R=y((T=P[w])[0]*a))-v),z[T[1]]=d(F),z[T[2]]=d(R);return z.polarException=function(t){var s=(e(t)-e(o)*e(g))/(i(o)*i(g));return s<-1?S.POLAR_EXCEPTION.MIDNIGHT_SUN:s>1?S.POLAR_EXCEPTION.POLAR_NIGHT:S.POLAR_EXCEPTION.NORMAL}(P[0][0]*a),z},S.getMoonPosition=function(t,e,i){var n=a*-i,r=a*e,o=p(t),h=R(o),l=w(o,n)-h.ra,c=y(l,r,h.dec);return c+=.017*a/s(c+10.26*a/(c+5.1*a)),{azimuth:v(l,r,h.dec),altitude:c,distance:h.dist}},S.getMoonFraction=function(t){var s=p(t),n=M(s),a=R(s),h=149598e3,l=o(e(n.dec)*e(a.dec)+i(n.dec)*i(a.dec)*i(n.ra-a.ra)),c=r(h*e(l),a.dist-h*i(l));return(1+i(c))/2},S}())&&(xm.exports=bm);const Mm=Cm.exports,Sm={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,diffuseAtNoon:.65,diffuseAtTwilight:.7},global:{altitude:8e5,ambient:.015,diffuse:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};const Pm=Ns(.5773502691896258,-.5773502691896258,.5773502691896258);class Tm{constructor(){this.ambient={color:Ns(1,1,1),intensity:.55},this.diffuse={color:Ns(1,1,1),intensity:.55,directionToLightSource:ks(Pm)},this.noonFactor=.5,this.globalFactor=0}}const Am=gn(),_m={azimuth:0,altitude:0};function Dm(t,e,i,s){const n=[];for(let r=0;r<i.length;r++)n[r]=(s[r]-i[r])*t/e+i[r];return n}let Om=class extends G.EventedAccessor{constructor(){super(),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandles=new E,this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this._referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new rr,this._ambientLight=new or,this._moonLight=new ar,this._renderer=null,this._referencePosWGS84Comparable=null,this._resetReferencePosition()}destroy(){this.disconnectView(),this._viewHandles.destroy()}get _view(){var t;return null==(t=this._renderer)?void 0:t.view}get updating(){return!!(!this.disableQueries&&(this._referencePosUpdateQuery||this._referencePosMapCoordsRequested)||this._renderer&&this._renderer.updating)}get referencePositionWGS84Comparable(){return this._referencePosWGS84Comparable}connectView(t){this._renderer||(this._renderer=new wm({view:t}),this._viewHandles.add([t.watch("environment.lighting.date",(t=>this._lightingDateHandler(t)),!0),t.watch("stationary",(()=>this._interactingStationaryHandler())),t.watch(["environment.lighting.directShadowsEnabled","environment.lighting.ambientOcclusionEnabled","environment.lighting.waterReflectionEnabled","environment.background.color"],(()=>this._updateRenderParamsHandler()),!0),t.watch("spatialReference",(()=>this._resetReferencePosition(!0)),!0),tt(t,"viewingMode",(()=>this._resetReferencePosition(!0)),!0),tt(t,"environment.lighting.cameraTrackingEnabled",(t=>this._updateCameraTracking(t)),!0),tt(t,"state.camera",(()=>this._cameraHandler()),!0),this.watch("disableQueries",(()=>this._cameraHandler()))]),this._updateRenderParamsHandler(),this._updateLightParams(),this._cameraHandler(),this.notifyChange("updating"))}disconnectView(){this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer=Y(this._renderer)}_updateCameraTracking(t){if(this._trackingEnabled=t,t)this._cameraHandler();else{const t=this._view.environment.lighting;t&&(t.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(t){if(!t)return;const e=this._view.environment.lighting;if(!e.positionTimezoneInfo.autoUpdated){if(this._preserveAbsoluteDateTime=!0,!Ge(this._view.spatialReference)){const t=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(t))return void this._requestReferencePositionUpdate(t)}if(this._preupdateTracking(t),p(this._referencePosWGS84Comparable)){const t=td(this._referencePosWGS84Comparable,Lm);p(t)&&(e.autoUpdate(null,t),this._trackingEnabled&&(e.positionTimezoneInfo.autoUpdated=!0))}}this._updateLightParams(t)}_preupdateTracking(t){!this._trackingEnabled&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(t)}_cameraHandler(t=null){const e=this._view;if(!e.ready)return;const i=e.stateManager.camera;i&&(this._cameraHandlerClientSide(i,t)||this._cameraHandlerServerSide(i))}_cameraHandlerClientSide(t,e){const i=B(this._view.spatialReference);if(i&&!Ge(this._view.spatialReference))return!1;const s=t.position;return w(this._referencePosWGS84Comparable)&&(this._referencePosWGS84Comparable=js()),i?qe(s,this._referencePosWGS84Comparable):ds(this._referencePosWGS84Comparable,s.longitude,s.latitude,s.z),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,e)||this._updateLightParams(e),!0}_cameraHandlerServerSide(t){const e=t.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(e))&&this._requestReferencePositionUpdate(e,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=e.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLightParams(t){const e=this._view,i=t||e.environment.lighting.date,s=e._stage,n=this._referencePosWGS84Comparable,r=p(n)?Rm:Fm;p(n)&&function(t,e,i,s){const n=e[2];ds(s.ambient.color,1,1,1),s.ambient.intensity=Sm.global.ambient,ds(s.diffuse.color,1,1,1),s.diffuse.intensity=Sm.global.diffuse;const r=fs((Math.abs(n)-Sm.local.altitude)/(Sm.global.altitude-Sm.local.altitude),0,1);s.globalFactor=r;const o=Mm.getTimes(t,e[1],e[0]);if(r<1){const e=function(t,e){const i=t.valueOf();let s,n;e.polarException===Mm.POLAR_EXCEPTION.MIDNIGHT_SUN?(s=i-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,n=s+432e6):e.polarException===Mm.POLAR_EXCEPTION.POLAR_NIGHT?(s=i-2,n=i-1):(s=e.sunrise.valueOf(),n=e.sunset.valueOf());const r=n-s,o=s+r/2,a=r/4,h=o-a,l=o+a,c=.06*r,u=s-c/2,d=s+c/2,p=n-c/2,f=n+c/2,g=Sm.local,m=[.01,g.ambientAtNight],v=[.8,.8,1],y=[.01,.01,.01],w=[g.diffuseAtTwilight,g.ambientAtTwilight],x=[1,.75,.75],b=[.8,.8,1],C=[.9*g.diffuseAtNoon,g.ambientAtNoon],M=[1,.98,.98],S=[.98,.98,1],P=[g.diffuseAtNoon,g.ambientAtNoon],T=[1,1,1],A=[1,1,1],_=C,D=M,O=S,R=w,F=x,z=b;let L,E,I=[0,0],V=[0,0,0],j=[0,0,0];return i<u||i>f?(I=m,V=y,j=v,E="night"):i<d?(L=d-u,I=Dm(i-u,L,m,w),V=Dm(i-u,L,y,x),j=Dm(i-u,L,v,b),E="sun rising"):i<h?(L=h-d,I=Dm(i-d,L,w,C),V=Dm(i-d,L,x,M),j=Dm(i-d,L,b,S),E="early morning"):i<o?(L=o-h,I=Dm(i-h,L,C,P),V=Dm(i-h,L,M,T),j=Dm(i-h,L,S,A),E="late morning"):i<l?(L=l-o,I=Dm(i-o,L,P,_),V=Dm(i-o,L,T,D),j=Dm(i-o,L,A,O),E="early afternoon"):i<p?(L=p-l,I=Dm(i-l,L,_,R),V=Dm(i-l,L,D,F),j=Dm(i-l,L,O,z),E="late afternoon"):i<f&&(L=f-p,I=Dm(i-p,L,R,m),V=Dm(i-p,L,F,y),j=Dm(i-p,L,z,v),E="sun setting"),{diffuse:{intensity:I[0],color:Ns(V[0],V[1],V[2])},ambient:{intensity:I[1],color:Ns(j[0],j[1],j[2])},timeOfDay:E}}(t,o);ws(s.ambient.color,e.ambient.color,s.ambient.color,r),s.ambient.intensity=ys(e.ambient.intensity,s.ambient.intensity,r),ws(s.diffuse.color,e.diffuse.color,s.diffuse.color,r),s.diffuse.intensity=ys(e.diffuse.intensity,s.diffuse.intensity,r)}s.noonFactor=function(t,e){const i=t.valueOf();let s,n;return e.polarException===Mm.POLAR_EXCEPTION.MIDNIGHT_SUN?(s=i-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,n=s+432e6):e.polarException===Mm.POLAR_EXCEPTION.POLAR_NIGHT?(s=i-2,n=i-1):(s=e.sunrise.valueOf(),n=e.sunset.valueOf()),1-fs(Math.abs(i-(s+(n-s)/2))/432e5,0,1)}(t,o),function(t,e,i,s){const n=_m,r=$r(Am);if(1===i)Mm.getPosition(t,0,0,n),ds(s,0,0,-1),to(r,r,-n.azimuth),ao(r,r,-n.altitude),os(s,s,r);else{const i=Sm.planarDirection,o=i.globalAngles;let a=(Math.abs(e[2])-i.localAltitude)/(i.globalAltitude-i.localAltitude);a=fs(a,0,1),a<1?(Mm.getPosition(t,e[1],e[0],n),n.azimuth=(1-a)*n.azimuth+a*o.azimuth,n.altitude=(1-a)*n.altitude+a*o.altitude):(n.azimuth=o.azimuth,n.altitude=o.altitude),ds(s,0,-1,0),Jr(r,r,-n.azimuth),to(r,r,-n.altitude),os(s,s,r)}}(t,e,i,s.diffuse.directionToLightSource)}(i,n,e.state.viewingMode,Rm);const o=this._mainLight,a=r.diffuse;Yi(o.intensity,a.color,a.intensity*Math.PI),$i(o.direction,a.directionToLightSource);const h=this._ambientLight;Yi(h.intensity,r.ambient.color,r.ambient.intensity);const l=this._moonLight;ws(l.intensity,Em,Im,r.globalFactor),Yi(l.intensity,l.intensity,(1-.5*r.globalFactor)*(1-.4*r.noonFactor*(1-r.globalFactor))),$i(l.direction,a.directionToLightSource),s.renderView.updateLightSources([o,h,l],1-r.noonFactor,r.globalFactor),this._updateRenderParamsHandler()}_autoUpdateTimezone(t,e=null){if(!this._view.environment.lighting.cameraTrackingEnabled||w(t))return!1;const i=zm;i.setTime((e||this._view.environment.lighting.date).getTime());const s=td(t,Lm);if(w(s))return!1;let n=this._view.environment.lighting.positionTimezoneInfo;if(n.autoUpdated){if(n.hours===s.hours&&n.minutes===s.minutes&&n.seconds===s.seconds)return!1}else n=s;const r=i.getUTCHours()-(s.hours-n.hours),o=i.getUTCMinutes()-(s.minutes-n.minutes),a=i.getUTCSeconds()-(s.seconds-n.seconds);return i.setUTCHours(r),i.setUTCMinutes(o),i.setUTCSeconds(a),!e&&this._view.environment.lighting.autoUpdate(i,s)}_updateRenderParamsHandler(){const t=this._view._stage;if(!t)return;const e=ot(this._referencePosWGS84Comparable,!0,(t=>function(t,e){if(1===e)return!0;const i=Sm.planarDirection;return Math.abs(t)<i.localAltitude}(t[2],this._view.state.viewingMode))),i=this._view.environment.background,s=i instanceof Cu?{type:"color",color:ra(Ni.toUnitRGBA(i.color))}:{type:"color",color:na(0,0,0,1)};t.renderView.setRenderParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&e,ssao:this._view.environment.lighting.ambientOcclusionEnabled,waterReflectionEnabled:this._view.environment.lighting.waterReflectionEnabled,background:s})}_resetReferencePosition(t=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),t&&this._cameraHandler()}_requestReferencePositionUpdate(t,e=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(t):this._referencePosMapCoordsRequested=t.clone(),this._referencePosResetPreserveAbsoluteTime=!!e,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){const t=this._referencePosUpdateQuery=at(this._referencePointUpdateDelay).then((()=>{if(this._referencePosUpdateQuery===t)return this._doReferencePositionUpdateQuery((()=>this._referencePosUpdateQuery!==t))})).catch((t=>{"mapcoordshelper:missing-geometry-service"===t.name&&(this.disableQueries=!0)})).then((()=>{this._referencePosUpdateQuery===t&&(this._referencePosUpdateQuery=null,this._referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))})),e=this._referencePosUpdateTimer=at(this._referencePointUpdateInterval).then((()=>{this._referencePosUpdateTimer===e&&(this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())}));this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(t){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const e=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!t()&&!isNaN(e[0])&&!isNaN(e[1])){const t=this._referencePosMapCoords.z*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=e[0],this._referencePosWGS84Comparable[1]=e[1],this._referencePosWGS84Comparable[2]=t):this._referencePosWGS84Comparable=[e[0],e[1],t],this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const t=this._referencePosMapCoordsRequested;t&&this._requestReferencePositionUpdate(t,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLightParams():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLightParams(),this.notifyChange("referencePositionWGS84Comparable")}_exceedsReferencePosDistThreshold(t){if(this._referencePosMapCoords){let e=this._referencePosMapCoords.distance(t);return this._view.mapCoordsHelper&&(e*=this._view.mapCoordsHelper.unitInMeters),e>this._referencePointUpdateDistThreshold}return!0}_cancelReferencePosUpdates(){const t=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,t}get test(){const t=this;return{renderer:this._renderer,set referencePointUpdateInterval(e){t._referencePointUpdateInterval=e},set referencePointUpdateDistThreshold(e){t._referencePointUpdateDistThreshold=e},set referencePosUpdateTimer(e){t._referencePosUpdateTimer=e},set referencePointUpdateDelay(e){t._referencePointUpdateDelay=e}}}};r([o({type:Boolean,readOnly:!0})],Om.prototype,"updating",null),r([o()],Om.prototype,"disableQueries",void 0),r([o()],Om.prototype,"referencePositionWGS84Comparable",null),r([o()],Om.prototype,"_renderer",void 0),r([o()],Om.prototype,"_referencePosWGS84Comparable",void 0),Om=r([a("esri.views.3d.environment.SceneViewEnvironmentManager")],Om);const Rm=new Tm,Fm=new Tm,zm=new Date,Lm={hours:0,minutes:0,seconds:0},Em=Ns(.22,.22,.33),Im=Ns(.22,.22,.22);function Vm(t,e){return 0!=(t&e)}function jm(t,e,i,s,n,r){0!==t&&(i?(r.min=Math.min(r.min,e),r.max=Math.max(r.max,e)):null!=s?(r.min-=Math.max(0,(e-r.min)*(1-s)),r.max+=Math.max(0,(e-r.max)*(1-s))):n&&(r.min-=Math.max(0,e-r.min-n),r.max+=Math.max(0,e-r.max-n)))}const Nm={selection:0,interactionType:0,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0};function km(t,e,i,s){return $i(s,e=e||t.viewForward),Yi(s,s,Math.sign(es(e,i))),s}function Bm(t,e,i=Nm){if(!function(t,e){return!(!t.state.isGlobal||!t.state.constraints.altitude||2===e.interactionType&&Vm(e.selection,1))}(t,i))return 0;const s=function(t,e){return e.min=t.min,e.max=t.max,e}(t.state.constraints.altitude,Gm);!function(t,e,i){const s=e.interactionType;if(0===s)return;const{min:n,max:r}=i,{interactionStartCamera:o,interactionFactor:a}=e,h=2===s||1===s,l=Bm(t,o),c=0===l?0:t.renderCoordsHelper.getAltitude(o.eye);i.min=n,i.max=r,jm(l,c,h,a,.05*c,i)}(t,i,s);const n=t.renderCoordsHelper.getAltitude(e.eye),r=fs(n,s.min,s.max)-n;return Math.abs(r)<=1e-6?0:r}const Gm={min:0,max:0},qm=js(),Wm=js(),Um=js(),Hm=js();function Zm(t,e,i=Nm){if(!t.state.isLocal)return 0;const s=t.state.constraints.distance;if(!t.pointsOfInterest.surfaceOrigin.renderLocation||s===1/0)return 0;Ym.min=0,Ym.max=s,function(t,e,i){const s=e.interactionType;if(0===s)return;const{min:n,max:r}=i,{interactionStartCamera:o,interactionFactor:a}=e,h=1===s||4===s,l=Zm(t,o),c=0===l?0:Qm(t,o);i.min=n,i.max=r,jm(l,c,h,a,.05*c,i)}(t,i,Ym);const n=Qm(t,e),r=Ym.max-n;return r>=-1e-6?0:r}function Qm(t,e){return cs(e.eye,t.pointsOfInterest.surfaceOrigin.renderLocation)}const Ym={min:0,max:0},Xm=js(),Km=js(),$m=js(),Jm=js(),tv=js();function ev(t,e,i=0){const s=t.state.constraints;if(!s.collision.enabled)return!1;const n=zu(t,e.eye),r=t.renderCoordsHelper.getAltitude(e.eye),o=n+s.collision.elevationMargin;if(r>=o)return!1;const a=Xi(e.eye);return ts(iv,e.center,e.eye),e.eye=t.renderCoordsHelper.setAltitude(sv,o,e.eye),1===i?e.center=Ki(iv,e.eye,iv):2===i&&(e.center=Yi(iv,e.center,(a-r+o)/a)),!0}const iv=js(),sv=js();function nv(t,e,i){t.worldUpAtPosition(e,rv),ts(ov,i,e);const s=Xi(ov);return 0===s?0:rs(es(ov,rv)/s)}const rv=js(),ov=js();function av(t,e,i=Nm,s=Nm,n){if(!t.state.constraints.tilt)return 0;const r=t.state.constraints.tilt(e.distance,gv);return function(t,e,i){if(0===e.interactionType)return;const{interactionStartCamera:s,interactionFactor:n}=e,{min:r,max:o}=i,a=av(t,s,Nm,e),h=0===a?0:nv(t.renderCoordsHelper,s.center,s.eye);i.min=r,i.max=o,2===e.interactionType?(Vm(e.selection,2)&&cv(t,s,i),jm(a,h,!0,n,fv,i)):jm(a,h,!1,n,fv,i)}(t,i,r),2===s.interactionType&&Vm(s.selection,2)&&cv(t,s.interactionStartCamera,r),1===i.tiltMode||1===s.tiltMode?function(t,e,i,s){switch(s&&(s.requiresTwoSteps=!1),t.viewingMode){case"global":return function(t,e,i,s){const n=function(t,e,i){const s=t.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,n=s+Qr(t.spatialReference).radius,r=t.renderCoordsHelper.intersectManifold(e.ray,s,pv);return i.eyeCenterDistance=e.distance,i.centerIsOnSurface=!1,p(r)?(i.eyeCenterDistance=cs(e.eye,r),i.tiltAtCenter=nv(t.renderCoordsHelper,r,e.eye),i.centerIsOnSurface=!0):t.state.isLocal?i.tiltAtCenter=nv(t.renderCoordsHelper,e.center,e.eye):(Go(qo(n),e.ray,pv),i.eyeCenterDistance=cs(e.eye,pv),i.tiltAtCenter=rs(-es(e.viewForward,is(pv,pv)))),i.radius=n,i.eyeRadius=Xi(e.eye),i.constraints=t.state.constraints,i}(t,e,mv),r=fs(n.tiltAtCenter,i.min,i.max);if(!hv(n.tiltAtCenter-r))return 0;let o,a;return n.centerIsOnSurface?(o=function(t){const{constraints:e,eyeCenterDistance:i,tiltAtCenter:s}=t;let n=s,r=e.clampTilt(i,s);const o=lv(t,r);if(e.clampTilt(o,s)===r)return r;let a=0;for(;a<10&&hv(r-n);){const i=(n+r)/2,s=lv(t,i);hv(e.clampTilt(s,i)-i)?n=i:r=i,a++}return r}(n),a=function(t,e){const i=hs(t.radius/t.eyeRadius*Math.sin(t.tiltAtCenter)),s=hs(t.radius/t.eyeRadius*Math.sin(e));return t.eyeRadius>t.radius?i-s:s-i}(n,o)):(o=n.constraints.clampTilt(n.eyeCenterDistance,n.tiltAtCenter),s&&o<Math.PI/2&&(s.requiresTwoSteps=!0,o=Math.PI/2-1e-5),a=function(t,e){return t.tiltAtCenter-Math.PI/2-(e-Math.PI/2)}(n,o)),s&&(s.eyeCenterDistance=lv(n,o)),a}(t,e,i,s);case"local":return function(t,e,i,s){const n=nv(t.renderCoordsHelper,e.center,e.eye),r=fs(n,i.min,i.max),o=n-r;if(!hv(o))return 0;if(s){const i=t.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,n=t.renderCoordsHelper.getAltitude(e.eye)-i,o=Math.cos(r);s.eyeCenterDistance=Math.abs(o)>1e-4?n/o:e.distance}return o}(t,e,i,s);default:return void Nl()}}(t,e,r,n):function(t,e,i){const s=nv(t.renderCoordsHelper,e.center,e.eye),n=s-fs(s,i.min,i.max);return hv(n)?n:0}(t,e,r)}function hv(t){return Math.abs(t)>1e-9}function lv(t,e){if(!t.centerIsOnSurface)return t.eyeCenterDistance;const i=Math.PI-fs(e,0,Math.PI),s=hs(t.radius/t.eyeRadius*Math.sin(i)),n=Math.PI-i-s,r=Math.sin(n)/Math.sin(i);if(t.eyeRadius<t.radius&&r>1){const e=Math.PI-s,n=Math.PI-i-e;return Math.sin(n)/Math.sin(i)*t.eyeRadius}return r*t.eyeRadius}function cv(t,e,i){if(t.state.isLocal)return;const s=t.state.constraints;if(!s.altitude)return;const n=vs(e.center),r=Math.sqrt(n),o=e.distance,a=Qr(t.spatialReference).radius,h=s.altitude.min+a,l=s.altitude.max+a,c=(h*h-o*o-n)/(-2*r*o);i.min=Math.max(i.min,Math.min(Math.PI-rs((l*l-o*o-n)/(-2*r*o)),i.max)),i.max=Math.min(i.max,Math.PI-rs(c))}const uv=js(),dv=gn(),pv=js(),fv=as(5),gv={min:0,max:0},mv={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},vv={eyeCenterDistance:0,requiresTwoSteps:!1},yv=t=>t*t,wv=t=>1-yv(1-t),xv=t=>t*t*t,bv=t=>1-xv(1-t),Cv=t=>t<.5?xv(2*t)/2:(bv(2*(t-.5))+1)/2,Mv=t=>t*t*t*t,Sv=t=>1-Mv(1-t),Pv=t=>t*t*t*t*t,Tv=t=>1-Pv(1-t),Av=t=>1-Math.cos(t*Math.PI/2),_v=t=>1-Av(1-t),Dv=t=>2**(10*(t-1)),Ov=t=>1-Dv(1-t),Rv=t=>-(Math.sqrt(1-t*t)-1),Fv=t=>1-Rv(1-t);function zv(t){const e=2*(t-Math.sqrt((t-1)*t)),i=e/2/t;return s=>s<i?t*s*s:e*s-e+1}function Lv(t,e){return(i,s)=>i<e?e*t(i/e,s):1-t((1-i)/(1-e),s)*(1-e)}const Ev=Lv(zv(1),1),Iv=Lv(zv(1),0),Vv=Lv(zv(1),.5),jv=Lv(zv(2),1),Nv=Lv(zv(2),0),kv=Lv(zv(2),.5),Bv=Lv(zv(3),1),Gv=Lv(zv(3),0),qv=Lv(zv(3),.5),Wv=Lv(zv(4),1),Uv=Lv(zv(4),0),Hv=Lv(zv(4),.5),Zv={linear:function(t){return t},"in-quad":yv,"out-quad":wv,"in-out-quad":t=>t<.5?yv(2*t)/2:(wv(2*(t-.5))+1)/2,"in-coast-quad":Ev,"out-coast-quad":Iv,"in-out-coast-quad":Vv,"in-cubic":xv,"out-cubic":bv,"in-out-cubic":Cv,"in-coast-cubic":jv,"out-coast-cubic":Nv,"in-out-coast-cubic":kv,"in-quart":Mv,"out-quart":Sv,"in-out-quart":t=>t<.5?Mv(2*t)/2:(Sv(2*(t-.5))+1)/2,"in-coast-quart":Bv,"out-coast-quart":Gv,"in-out-coast-quart":qv,"in-quint":Pv,"out-quint":Tv,"in-out-quint":t=>t<.5?Pv(2*t)/2:(Tv(2*(t-.5))+1)/2,"in-coast-quint":Wv,"out-coast-quint":Uv,"in-out-coast-quint":Hv,"in-sine":Av,"out-sine":_v,"in-out-sine":t=>t<.5?Av(2*t)/2:(_v(2*(t-.5))+1)/2,"in-expo":Dv,"out-expo":Ov,"in-out-expo":t=>t<.5?Dv(2*t)/2:(Ov(2*(t-.5))+1)/2,"in-circ":Rv,"out-circ":Fv,"in-out-circ":t=>t<.5?Rv(2*t)/2:(Fv(2*(t-.5))+1)/2};function Qv(t,e,i=Kv,s=e){let n=!1;s!==e&&s.copyFrom(e),s.computeUp(t.state.viewingMode);for(let e=0;e<$v;e++){let e=0;for(const r of Xv)if(Vm(i.selection,r.type)){const o=Math.abs(r.error(t,s,i));r.apply(t,s,i)&&(n=!0,e+=o)}if(0===e)break}const r=Vm(i.selection,8),o=function(t,e){switch(t){case 4:return 1;case 5:return e.state.isGlobal?2:1;default:return 0}}(i.interactionType,t);return r&&ev(t,s,o)&&(n=!0),n&&s.computeUp(t.state.viewingMode),n}function Yv(t,e){const i="number"==typeof t?t:fa(t,e),s=Math.min(1,i/150);return Cv(s)}const Xv=[{type:1,error:function(t,e,i){return av(t,e,i)*e.distance},apply:function t(e,i,s=Nm,n=!0){vv.eyeCenterDistance=0,vv.requiresTwoSteps=!1;const r=av(e,i,s,void 0,vv);if(0===r)return!1;switch($r(dv),eo(dv,dv,-r,i.viewRight),s.tiltMode){case 1:os(uv,i.viewForward,dv),Yi(uv,uv,vv.eyeCenterDistance),i.center=Ki(pv,i.eye,uv);break;case 0:ts(uv,i.center,i.eye),os(uv,uv,dv),i.eye=ts(pv,i.center,uv)}return i.up=os(pv,i.up,dv),!vv.requiresTwoSteps||!n||t(e,i,s,!1)}},{type:2,error:Bm,apply:function(t,e,i=Nm){const s=Bm(t,e,i);if(0===s)return!1;const n=t.renderCoordsHelper,r=n.getAltitude(e.eye)+s,o=km(e,i.interactionDirection,function(t,e,i,s){return t.renderCoordsHelper.worldUpAtPosition(e.eye,s),Yi(s,s,i),s}(t,e,Math.sign(s),Wm),qm),a=$i(Um,e.viewForward),h=n.intersectInfiniteManifold(No(e.eye,o),r,Hm);return e.eye=p(h)?h:n.setAltitude(Hm,r,e.eye),e.center=Tl(Hm,e.eye,a,e.center),!0}},{type:4,error:Zm,apply:function(t,e,i=Nm){const s=Zm(t,e,i);if(0===s)return!1;const n=t.pointsOfInterest.surfaceOrigin,r=Qm(t,e)+s,o=$i(Xm,e.eye),a=km(e,i.interactionDirection,function(t,e){return xs(Jm,e.eye,t.pointsOfInterest.surfaceOrigin.renderLocation)}(t,e),$m);if(!ko(Bo(n.renderLocation,r),No(e.eye,a),tv))return!1;e.eye=tv;const h=ts(Km,e.eye,o);e.center=Ki(tv,e.center,h);const l=t.renderCoordsHelper.getAltitude(e.center),c=t.renderCoordsHelper.intersectInfiniteManifold(e.ray,l,tv);return p(c)&&(e.center=c),!0}}],Kv={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0},$v=5,Jv=js(),ty=js(),ey=js(),iy=js(),sy=js(),ny=js(),ry={upward:Ns(0,0,1),forward:Ns(0,1,0),sideway:Ns(1,0,0)},oy=pn();class ay{constructor(t=1){this.viewingMode=t,this.center=js(),this.pitch=0,this.yaw=0,this.distance=0,this.lookAtDirection=ks(ry.forward)}pixelsPerPanAtZoom(t){return this.size/2/(this._zoomToPanScale*t)}zoomAtPixelsPerPan(t){return this.size/2/(this._zoomToPanScale*t)}pixelsPerRotateAtZoom(){const t=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/t}compareTo(t,e){if(e||(e={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),1===this.viewingMode){const i=(Xi(this.center)+Xi(t.center))/2;e.pan=tn(this.center,t.center)*i}else e.pan=cs(this.center,t.center);let i=Math.abs(t.yaw-this.yaw);i>=Math.PI&&(i=2*Math.PI-i);const s=Math.abs(t.pitch-this.pitch);return e.rotate=Math.max(i,s),e.sourceZoom=this.distance,e.targetZoom=t.distance,e}interpolate(t,e,i){1===this.viewingMode?en(t.center,e.center,i.pan,this.center):ws(this.center,t.center,e.center,i.pan),this.distance=ys(t.distance,e.distance,i.zoom),this.pitch=ys(t.pitch,e.pitch,i.rotate);let s=t.yaw;const n=e.yaw;Math.abs(n-s)>=Math.PI&&(s+=2*(s<n?1:-1)*Math.PI),this.yaw=ys(s,n,i.rotate)}copyFrom(t){$i(this.center,t.center),this.pitch=t.pitch,this.yaw=t.yaw,this.distance=t.distance,$i(this.lookAtDirection,t.lookAtDirection),this.size=t.size,this.copyFromCommon(t),this.viewingMode=t.viewingMode}copyFromRenderCamera(t){const e=this._lookAtOrientation(t.center,oy);$i(this.center,t.center),ts(iy,t.center,t.eye),ps(iy,iy,e),ps(sy,t.up,e),this.distance=Xi(iy),iy[0]/=this.distance,iy[1]/=this.distance,iy[2]/=this.distance,this.pitch=this._eyeUpToPitch(iy),this.yaw=this._eyeUpToYaw(iy,sy),this.size=Math.sqrt(t.width*t.width+t.height*t.height),this.copyFromCommon(t)}copyFromCommon(t){this.fov=t.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}copyToRenderCamera(t){const e=this._lookAtOrientation(this.center,oy);hn(e,e),this._axisAngleVec3(ry.sideway,this.pitch-Math.PI/2,ry.forward,iy),this._axisAngleVec3(ry.upward,this.yaw,iy),this._axisAngleVec3(ry.sideway,this.pitch-Math.PI/2,ry.upward,sy),this._axisAngleVec3(ry.upward,this.yaw,sy),Yi(iy,iy,this.distance),ps(iy,iy,e),ps(sy,sy,e),t.center=this.center,t.eye=ts(iy,this.center,iy),t.up=sy}_axisAngleVec3(t,e,i,s=i){const n=Math.cos(e),r=Math.sin(e);return Yi(Jv,i,n),ss(ty,t,i),Yi(ty,ty,r),Yi(ey,t,(1-n)*es(t,i)),Ki(s,Ki(s,Jv,ty),ey)}_lookAtOrientation(t,e=pn()){return this._upAtLookAt(t,ey),ss(Jv,this.lookAtDirection,ey),is(Jv,Jv),0===Jv[0]&&0===Jv[1]&&0===Jv[2]&&$i(Jv,ry.sideway),ss(ty,ey,Jv),is(ty,ty),e[0]=Jv[0],e[1]=ty[0],e[2]=ey[0],e[3]=Jv[1],e[4]=ty[1],e[5]=ey[1],e[6]=Jv[2],e[7]=ty[2],e[8]=ey[2],e}_upAtLookAt(t,e){return 2===this.viewingMode?$i(e,ry.upward):is(e,t)}_eyeUpToPitch(t){return Math.PI-tn(ry.upward,t)}_eyeUpToYaw(t,e){const i=ny;return Math.abs(e[2])<.5?($i(i,e),t[2]>0&&Yi(i,i,-1)):$i(i,t),ss(ty,i,ry.upward),is(ty,ty),tn(ry.sideway,ty,ry.upward)}}const hy=ht(500),ly=ht(8e3);class cy{constructor(t){this.createCamera=t,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:2},this.source=t(),this.target=t()}clone(){const t=new cy(this.createCamera);return t.copyFrom(this),t}copyFrom(t){this.update(t.source,t.target,t.settings)}update(t,e,i){this.source!==t&&this.source.copyFrom(t),this.target!==e&&this.target.copyFrom(e),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=null!=i.desiredScreenFlow?i.desiredScreenFlow:2,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(t){const e=this.target.pixelsPerPanAtZoom(t);return this.halfWindowSize/e}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>1e-9}get hasRotate(){return this.compared.rotate>1e-9}}class uy{constructor(t){t&&this.update(t)}get time(){return this._time}update(t){t&&(this.definition?this.definition.copyFrom(t):this.definition=t.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const t=this.definition,e=t.compared,i=e.sourceZoom,s=e.targetZoom;this._zoomSign=i>s?1:-1,this._panPixelsAtSource=e.pan*t.source.pixelsPerPanAtZoom(i);const n=(t.source.pixelsPerRotateAtZoom(i)+t.target.pixelsPerRotateAtZoom(s))/2;this._rotatePixels=e.rotate*n}_updatePixelFlow(){const t=this.definition.compared.sourceZoom,e=this.definition.compared.targetZoom,{hasZoom:i,hasPan:s,hasRotate:n}=this.definition;let r=0,o=0;i&&(s&&(r=(e/t-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),n&&(o=this._zoomSign*(Math.log(t/e)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const a=this.definition.desiredPixelFlow;if(i&&s&&n){const t=r+o+r*o;this._zoomPixelFlow=r*o/t*a,this._panPixelFlow=o/t*a,this._rotatePixelFlow=r/t*a}else if(i&&s){const t=1+r;this._zoomPixelFlow=r/t*a,this._panPixelFlow=1/t*a}else if(i&&n){const t=1+o;this._zoomPixelFlow=o/t*a,this._rotatePixelFlow=1/t*a}else if(s&&n){const t=this._panPixelsAtSource/this._rotatePixels,e=1+t;this._panPixelFlow=t/e*a,this._rotatePixelFlow=1/e*a}else s?this._panPixelFlow=a:i?this._zoomPixelFlow=a:n&&(this._rotatePixelFlow=a);this._time=n?this.rotateTime:i?this.zoomTime:s?this.panTime:lt(0)}get rotateTime(){return lt(this.definition.hasRotate?this._rotatePixels/this._rotatePixelFlow:0)}get zoomTime(){return lt(this.definition.hasZoom?this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow:0)}get panTime(){if(this.definition.hasPan){if(this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2;return lt(Math.log(t*this._panPixelsAtSource*(this._zoomPixelFlow/this._panPixelFlow)+1)/(t*this._zoomPixelFlow))}return lt(this._panPixelsAtSource/this._panPixelFlow)}return lt(0)}_interpolateComponentsZoom(t){if(0===t||1===t)return t;if(this.definition.hasZoom){const e=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom;return(e*(e/i)**-t-e)/(i-e)}return t}_interpolateComponentsPan(t){if(0===t||1===t)return t;if(this.definition.hasPan&&this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(e*t*this._time)-1))/(e*Math.LN2)}return t}_interpolateComponentsRotate(t){return t}interpolateComponentsAt(t,e){t=Math.min(Math.max(t,0),1);const i=this._interpolateComponentsZoom(t),s=this._interpolateComponentsPan(t),n=this._interpolateComponentsRotate(t);return e?(e.zoom=i,e.pan=s,e.rotate=n):e={zoom:i,pan:s,rotate:n},e}}function dy(t,e,i){const s=t.halfWindowPanAtZoom(e-t.compared.sourceZoom);return-t.halfWindowSize*(i.ascensionFactor*Math.LN2*t.compared.pan+s)*Math.log(t.compared.sourceZoom/e)/(t.desiredPixelFlow*Math.LN2*s)}function py(t,e,i){const s=1/e,n=Math.log(t.compared.sourceZoom*s),r=1/t.desiredPixelFlow,o=1/Math.LN2,a=e-t.compared.sourceZoom,h=1/a,l=(i.ascensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(a))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*s*r*o*h*l-t.halfWindowSize*n*r*o*h+t.halfWindowSize*n*r*o*l/(a*a)}function fy(t,e,i){const s=e-t.compared.sourceZoom,n=1/s,r=1/e,o=Math.log(t.compared.sourceZoom*r),a=(i.ascensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(s))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*n*(-2*n*r*a+2*n*o+2*r-2*o*a/(s*s)-a/(e*e))/(t.desiredPixelFlow*Math.LN2)}function gy(t,e){return-t.halfWindowSize*Math.log(t.compared.sourceZoom/e)/(t.desiredPixelFlow*Math.LN2)}function my(t,e){return t.halfWindowSize/(e*t.desiredPixelFlow*Math.LN2)}function vy(t,e){return-t.halfWindowSize/(e*e*t.desiredPixelFlow*Math.LN2)}function yy(t,e,i){return t.halfWindowSize*(-t.halfWindowPanAtZoom(e)-i.descensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(t.compared.targetZoom))*Math.log(e/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2*t.halfWindowPanAtZoom(-e+t.compared.targetZoom))}function wy(t,e,i){const s=Math.log(e/t.compared.targetZoom),n=1/t.desiredPixelFlow,r=1/Math.LN2,o=-e+t.compared.targetZoom,a=1/o,h=(-t.halfWindowPanAtZoom(e)-i.descensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(t.compared.targetZoom))/t.halfWindowPanAtZoom(1);return-t.halfWindowSize*s*n*r*a+t.halfWindowSize*s*n*r*h/(o*o)+t.halfWindowSize*n*r*a*h/e}function xy(t,e,i){const s=e-t.compared.targetZoom,n=1/s,r=1/e,o=Math.log(e/t.compared.targetZoom),a=(t.halfWindowPanAtZoom(e)+i.descensionFactor*Math.LN2*t.compared.pan-t.halfWindowPanAtZoom(t.compared.targetZoom))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*n*(-2*n*r*a-2*n*o+2*r+2*o*a/(s*s)-a/(e*e))/(t.desiredPixelFlow*Math.LN2)}function by(t,e){return t.halfWindowSize*Math.log(e/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2)}function Cy(t,e){return t.halfWindowSize/(e*t.desiredPixelFlow*Math.LN2)}function My(t,e){return-t.halfWindowSize/(e*e*t.desiredPixelFlow*Math.LN2)}class Sy extends class{constructor(){this.segments=[]}get time(){return this.segments.reduce(((t,e)=>lt(t+e.time)),lt(0))}interpolateComponentsAt(t,e){t=Math.min(Math.max(t,0),1),t*=this.time;let i=0,s=0;const n=this.definition;for(let r=0;r<this.segments.length;r++){const o=this.segments[r],a=o.definition;if(t<=o.time||r===this.segments.length-1){(e=this.segmentInterpolateComponentsAt(o,t/o.time,e)).pan=n.hasPan?(i+a.compared.pan*e.pan)/n.compared.pan:1,e.rotate=n.hasRotate?(s+a.compared.rotate*e.rotate)/n.compared.rotate:1;const r=e.zoom*(a.compared.targetZoom-a.compared.sourceZoom)+a.compared.sourceZoom,h=this.segments[0].definition.compared.sourceZoom,l=this.segments[this.segments.length-1].definition.compared.targetZoom;return e.zoom=n.hasZoom?(r-h)/(l-h):1,e}t-=o.time,i+=a.compared.pan,s+=a.compared.rotate}}segmentInterpolateComponentsAt(t,e,i){return t.interpolateComponentsAt(e,i)}}{constructor(t,e){super(),this._preallocSegments=[new uy,new uy,new uy],this.update(t,e)}update(t,e){if(!t)return;this.definition?this.definition.copyFrom(t):this.definition=t.clone();let i=null;e&&e.apex&&(i=function(t,e){let i=function(t,e){const i=Math.max(t.compared.sourceZoom,t.compared.targetZoom),s=t.source.zoomAtPixelsPerPan(t.desiredPixelFlow/t.compared.pan)/2;return s<i?null!=e.maximumDistance?i+(e.maximumDistance-i)/2:1.5*i:e.maximumDistance?Math.min(e.maximumDistance,s):s}(t,e);const s={ascensionFactor:null!=e.ascensionFactor?e.ascensionFactor:.5,descensionFactor:null!=e.descensionFactor?e.descensionFactor:.5},n=0===s.ascensionFactor,r=0===s.descensionFactor,o=n?gy:dy,a=n?my:py,h=n?vy:fy,l=r?by:yy,c=r?Cy:wy,u=r?My:xy,d=e=>o(t,e,s)+function(t,e,i){return-t.compared.pan*t.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e))}(t,e,s)+l(t,e,s),p=e=>a(t,e,s)+function(t,e,i){return t.compared.pan*t.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e*e))}(t,e,s)+c(t,e,s),f=e=>h(t,e,s)+function(t,e,i){return-2*t.compared.pan*t.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e*e*e))}(t,e,s)+u(t,e,s);let g=d(i);const m=function(t){const e=Math.LN2*t.compared.pan,i=t.halfWindowPanAtZoom(t.compared.sourceZoom-t.compared.targetZoom),s=t.halfWindowSize*Math.log(t.compared.sourceZoom/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2*i);return t.compared.sourceZoom<=t.compared.targetZoom?s*(e-i):s*(e+i)}(t);let v;const y=e.maximumIterations||20,w=null!=e.maximumDistance?e.maximumDistance:1/0;for(v=0;v<y;v++){const e=1e-6,s=(p(i)+e)/f(i);if(isNaN(s)||i>=w&&s<0){if(!isFinite(w))return null;i=w,g=d(i);break}if(i-=s,i<t.compared.sourceZoom||i<t.compared.targetZoom)return null;const n=d(i);if(Math.abs(n-g)/g<=.005)break;g=n}return g>.7*m||i<t.compared.sourceZoom||i<t.compared.targetZoom?null:i}(t,e.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,null==i?this._updateWithoutApex():this._updateWithApex(i,e.apex)}segmentInterpolateComponentsAt(t,e,i){return i=t.interpolateComponentsAt(e,i),t===this._ascensionSegment?i.zoom=wv(i.zoom):t===this._descensionSegment&&(i.zoom=yv(i.zoom)),i}_updateWithApex(t,e){const[i,s,n]=this._preallocSegments,r=null!=e.ascensionFactor?e.ascensionFactor:.5,o=Math.min(1-r,null!=e.ascensionFactor?e.descensionFactor:.5),a=1-r-o;i.definition?i.definition.copyFrom(this.definition):i.definition=this.definition.clone(),i.definition.compared.targetZoom=t,i.definition.compared.pan=this.definition.compared.pan*r,i.definition.compared.rotate=this.definition.compared.rotate*r,i.update(),this._ascensionSegment=i,this.segments.push(i),a>0&&(s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.copyFrom(this.definition),s.definition.compared.sourceZoom=t,s.definition.compared.targetZoom=t,s.definition.compared.pan=this.definition.compared.pan*a,s.definition.compared.rotate=this.definition.compared.rotate*a,s.update(),this.segments.push(s)),n.definition?n.definition.copyFrom(this.definition):n.definition=this.definition.clone(),n.definition.compared.sourceZoom=t,n.definition.compared.pan=this.definition.compared.pan*o,n.definition.compared.rotate=this.definition.compared.rotate*o,n.update(),this._descensionSegment=n,this.segments.push(n)}_updateWithoutApex(){const[t]=this._preallocSegments;t.update(this.definition),this.segments.push(t)}}const Py={zoom:0,pan:0,rotate:0};class Ty{constructor(t){this.createCamera=t,this._time=ht(0),this.definition=new cy(t),this.path=new Sy}get time(){return this._time}update(t,e,i){this.definition.update(t,e,i),this.path.update(this.definition,i),this._time=this._applyTimeSettings(ct(this.path.time),i),this._easing=i.easing?i.easing:this._time>=1e3?Vv:Ov}cameraAt(t,e){e=e||this.createCamera(),t=Math.min(Math.max(0,t),1),t=this._normalizedEasing(t);const i=this.path.interpolateComponentsAt(t,Py);return e.interpolate(this.definition.source,this.definition.target,i),e}_normalizedEasing(t){const e=this._easing(0,this._time),i=this._easing(1,this._time);return(this._easing(t,this._time)-e)/(i-e)}_applyTimeSettings(t,e){const i=null!=e.speedFactor?e.speedFactor:1;null!=e.duration?t=e.duration:null!=e.speedFactor&&(t=ht(t/i));const s=null!=e.maxDuration?e.maxDuration:ly/i;return ht(Math.min(Math.max(null!=e.minDuration?e.minDuration:hy/i,t),s))}}const Ay=js();class _y{constructor(t){this.currentTime=ht(0),this._animation=new Ty((()=>new ay(t))),this._current=new ay(t)}get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}update(t,e,i){const s=this._animation.definition.source,n=this._animation.definition.target,r=ts(Ay,e.center,t.center),o=Xi(r);o>=1e-5?(r[0]/=o,r[1]/=o,r[2]/=o):(r[0]=0,r[1]=1,r[0]=0),$i(s.lookAtDirection,r),$i(n.lookAtDirection,r),s.copyFromRenderCamera(t),n.copyFromRenderCamera(e),this._current.copyFrom(s),this._animation.update(s,n,i),this.currentTime=ht(0),t.almostEquals(e)&&(this.currentTime=this._animation.time)}cameraAt(t,e){return this._animation.cameraAt(t,this._current),e=e||new hr,this._current.copyToRenderCamera(e),e}step(t,e){return this.finished||(this.currentTime=ht(this.currentTime+ct(t)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,e)}}var Dy;!function(t){t.Ready="ready",t.Rejected="rejected",t.Running="running",t.Stopped="stopped",t.Finished="finished"}(Dy||(Dy={}));let Oy=class extends T{constructor(){super(...arguments),this.state=Dy.Ready}get active(){return this.state===Dy.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=Dy.Stopped,!0)}finishController(){this.state=Dy.Finished}get steppingFinished(){return!1}};r([o({readOnly:!0})],Oy.prototype,"active",null),r([o()],Oy.prototype,"state",void 0),Oy=r([a("esri.views.3d.state.controllers.CameraController")],Oy);let Ry=class extends Oy{get canStop(){return!0}set asyncResult(t){this._asyncResult&&(this._asyncResult.reject(ut()),this._asyncResult=null),this.state===Dy.Finished||this.state===Dy.Stopped?this.state===Dy.Finished?t.resolve():t.reject(ut()):this._asyncResult=t}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=Dy.Running,p(this.viewAnimation)&&this.viewAnimation.when((()=>this.updateStateFromViewAnimation()),(()=>this.updateStateFromViewAnimation()))}updateStateFromViewAnimation(){!p(this.viewAnimation)||this.state!==Dy.Ready&&this.state!==Dy.Running||(this.viewAnimation.state===ie.State.FINISHED?this.finish():this.viewAnimation.state===ie.State.STOPPED&&(this.state=Dy.Stopped))}onControllerEnd(){p(this.viewAnimation)&&!this.viewAnimation.done&&(this.state===Dy.Finished?this.viewAnimation.finish():this.state===Dy.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===Dy.Finished?this._asyncResult.resolve():this._asyncResult.reject(ut()))}finish(){this.finishController()}};Ry=r([a("esri.views.3d.state.controllers.AnimationController")],Ry);let Fy=class extends Ry{constructor(t){super(t),this.view=null,this.mode="interaction",this.hasTarget=!1}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.animation=new _y(this.view.state.viewingMode),this.viewAnimation="interaction"===this.mode?null:new ie}get isInteractive(){return"interaction"===this.mode}begin(t,e){this.hasTarget=!0;const i=this.animationSettings(e);zy.copyFrom(this.view.state.camera);const s=new Jn(this.view.state.viewingMode);this.intersectionHelper.intersectRay(zy.ray,s,Ly)&&(zy.center=Ly),this.animation.update(zy,t,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this.hasTarget&&this.animation.finished}stepController(t,e){this.hasTarget&&this.animation.step(t,e)}onControllerEnd(t){this.hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,t),this.animation.currentTime=this.animation.time),super.onControllerEnd(t)}animationSettings(t={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...t,easing:"string"==typeof t.easing?Zv[t.easing]:t.easing}}};r([o({constructOnly:!0})],Fy.prototype,"view",void 0),r([o({constructOnly:!0})],Fy.prototype,"mode",void 0),Fy=r([a("esri.views.3d.state.controllers.PointToPointAnimationController")],Fy);const zy=new hr,Ly=js();function Ey(t,e,i,s){const n=Xl(e,i,Iy);return ko(t,n,s)}const Iy=Wo();function Vy(t,e,i){return i[0]=e[0]/(t.fullWidth/t.pixelRatio),i[1]=e[1]/(t.fullHeight/t.pixelRatio),i}function jy(t){for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;return t}function Ny(t,e,i){const s=sl.get();$r(s),eo(s,s,i[3],i),ts(_w,t.eye,e),os(_w,_w,s),t.eye=Ki(_w,_w,e),ts(_w,t.center,e),os(_w,_w,s),t.center=Ki(_w,_w,e),t.up=os(_w,t.up,s)}function ky(t,e,i,s){return Bl(t,Kl(e,i,zw),s)}function By(t,e,i,s){const n=nl.get();let r=1-i;ts(n,e,t.eye);const o=Xi(n);let a=o*(1-r);r>=0&&a<s&&(a=s,r=-(a-o)/o),Math.abs(o-a)<1e-6||(Yi(n,n,r),t.eye=Ki(_w,t.eye,n),t.center=ws(_w,t.center,e,r))}function Gy(t,e,i){e.getScreenCenter(qy),Ey(t,e,qy,_w)&&(e.center=_w);const s=e.distance,n=s*i;if(Math.abs(s-n)<1e-6)return;const r=Yi(nl.get(),e.viewForward,n);e.eye=ts(_w,e.center,r)}const qy=Co();function Wy(t,e){ds(e,0,0,0);for(const i of t)Ki(e,e,i);Yi(e,e,1/t.length)}function Uy(t,e,i,s){return Math.sin(t/Xi(e))*(i+s.radius)}function Hy(t,e,i,s){return Uy(Math.PI/2,e,i,s)+(t-Math.PI/2)}var Zy;!function(t){t[t.Vertical=0]="Vertical",t[t.Horizontal=1]="Horizontal"}(Zy||(Zy={}));const Qy=as(6),Yy={Pole:.95,Angle:as(18),Tilt:45},Xy=as(80);function Ky(t,e,i,s,n){const r=js(),o=Uo();let a=!0,h=!0;return t.intersectScreen(i,r)?o[3]=Xi(r):(h=!1,o[3]=e.aboveGround?Math.max(Xi(e.center),.9*n.radius):Xi(e.eye)-e.relativeElevation,s?ew(o,e,i,r):a=Ey(o,e,i,r)),{sphere:o,scenePickPoint:a?r:null,hasGeometryIntersection:h}}function $y(t,e,i,s){return Xi(t.eye)-s.radius>3e4?Zy.Horizontal:i?(Xl(t,e,Lw),-Math.sign(t.relativeElevation)*(.5*Math.PI+jo(t.eye,Lw.direction))<Qy?Zy.Vertical:Zy.Horizontal):Zy.Vertical}function Jy(t,e,i){ts(tw,i,e),t.eye=ts(_w,t.eye,tw),t.center=ts(_w,t.center,tw)}const tw=js();function ew(t,e,i,s){const n=Xl(e,i,zw);return!(w(n)||(Go(t,n,iw),ko(t,n,s)?Ji(iw,n.origin)<Ji(s,n.origin)&&($i(s,iw),1):(ts(sw,e.eye,e.center),is(sw,sw),kl(sw,-es(is(sw,sw),iw),nw),Bl(nw,n,s),1)))}const iw=js(),sw=js(),nw=Gl();function rw(t,e,i,s,n,r){let o;if(ss(Rw,t,e),ts(Dw,t,e),Xi(t)<=n||!s.aboveGround){ss(i,Dw,s.eye);const a=es(t,e)/(Xi(t)*Xi(e)),h=Math.cos(fs(sn.normalize(as(r)),0,Xy));o=-rs(a)-Math.max(0,Xi(e)-n)/(h*n)}else ts(ow,s.eye,s.center),ss(i,Dw,ow),o=-Xi(Dw)/n;return is(i,i),Yi(i,i,Xi(Rw)),o}const ow=js();function aw(t,e,i,s){let n,r;const o=Math.cos(fs(sn.normalize(as(s)),0,Xy));return n=e>i?-(e-i)/(o*i):e<-i?Math.PI-(e+i)/(o*i):rs(e/i),r=t>i?-(t-i)/(o*i):t<-i?Math.PI-(t+i)/(o*i):rs(t/i),(r-n)*i}function hw(t,e,i,s,n,r,o,a,h,l){ss(Rw,t,e),lf(r.up,r.eye,vw,yw,ww),lf([0,0,1],r.eye,fw,gw,mw),$i(i,gw),$i(s,fw),is(i,i),Yi(i,i,Xi(Rw)),hf(t,is(yw,yw),is(ww,ww),is(vw,vw),xw),hf(e,yw,ww,vw,bw),function(t,e,i,s,n,r,o,a,h,l){const c=aw(t[2],e[2],o[3],h),u=l?aw(t[0],e[0],o[3],180):e[0]-t[0],d=Math.sin(a)*u-Math.cos(a)*c,p=Math.cos(a)*u+Math.sin(a)*c;is(_w,n);const f=l?d/Math.sqrt(Math.abs(o[3]**2-es(i,_w)**2)):d/o[3],g=p/Math.sqrt(Math.abs(o[3]**2-es(i,s)**2));pa(r,f,g)}(xw,bw,t,fw,gw,n,o,a,h,l)}function lw(t,e,i,s,n,r,o){$r(Sw),$r(Pw),$r(Tw),eo(Sw,Sw,n,s),eo(Pw,Pw,o,r),oo(Tw,Sw,Pw),ts(e,t,i),os(e,e,Tw),Ki(e,e,i)}function cw(t,e,i,s,n,r){$r(Sw),$r(Pw),$r(Tw),eo(Sw,Sw,s,i),eo(Pw,Pw,r,n),oo(Tw,Sw,Pw),ts(_w,t.eye,e),os(_w,_w,Tw),t.eye=Ki(_w,_w,e),ts(_w,t.center,e),os(_w,_w,Tw),t.center=Ki(_w,_w,e),ts(_w,t.up,e),os(_w,_w,Tw),t.up=Ki(_w,_w,e)}function uw(t,e,i,s,n,r,o=Yy.Pole,a=Yy.Angle){const h=Math.abs(s)>Math.PI-a||Math.abs(s)<a,l=Math.abs(t[2])<i*o||Math.abs(e)>i;return!!(h&&l&&r.aboveGround&&n<Yy.Tilt)}function dw(t,e,i,s,n,r){if(r)ig(i,s,Mw),Ny(e,t,Mw);else{const r=rw(i,s,Fw,e,t[3],n);Ny(e,t,eg(Fw,r))}}function pw(t,e,i,s,n,r,o){const a=o?20:1;let h,l;$i(Aw,s),Ow.copyFrom(e);for(let s=0;s<a&&Ji(i,Aw)>1e-12&&(h=Ji(i,Aw),hw(i,Aw,gw,fw,Cw,Ow,t,n,r,o),cw(Ow,t,fw,Cw[1],gw,Cw[0]),lw(Aw,Aw,t,fw,Cw[1],gw,Cw[0]),l=Ji(i,Aw),l<h||0===s);s++)e.copyFrom(Ow)}const fw=js(),gw=js(),mw=js(),vw=js(),yw=js(),ww=js(),xw=js(),bw=js(),Cw=Sa(),Mw=tg(),Sw=gn(),Pw=gn(),Tw=gn(),Aw=js(),_w=js(),Dw=js(),Ow=new hr,Rw=js(),Fw=js(),zw={origin:js(),direction:js()},Lw={origin:js(),direction:js()};let Ew=class extends Fy{constructor(){super(...arguments),this.zoomLocation=js(),this.tmpCamera=new hr,this.tmpViewDir=js(),this.tmpRayDir={origin:js(),direction:js()},this.targetOnSphere=js(),this.tmpCenter=js(),this.constraintOptions={selection:7,interactionType:1,interactionFactor:null,interactionStartCamera:new hr,interactionDirection:null,tiltMode:0},this.sphere=Uo()}initialize(){this.intersector=new Jn(this.view.state.viewingMode)}zoomStep(t,e){if(!this.active)return;const i=this.view.state,{interactionStartCamera:s}=this.constraintOptions;this.animation.finished?s.copyFrom(i.camera):this.animation.cameraAt(1,s);let n=!1,r=!1;this.intersectionHelper.intersectScreen(e,this.zoomLocation)&&(n=t>0,r=!0),this.tmpCamera.copyFrom(i.camera),n?this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter):this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:$i(this.zoomLocation,this.tmpCamera.center),this.updateCamera(this.tmpCamera,t,this.zoomLocation,e,r),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:ht(600),easing:Ov}}updateCamera(t,e,i,s,n){if($y(t,s,n,Qr(this.view.spatialReference))===Zy.Horizontal||dt("disable-feature:context-navigation")){let n=.6**e;this.sphere[3]=Xi(i),ts(this.tmpViewDir,t.center,t.eye);const r=Xi(this.tmpViewDir);let o=r*n;if(n<=1&&o<4&&(o=4,n=o/r),Math.abs(r-o)<1e-6)return;const a=Xi(t.center);this.sphere[3]!==a&&(t.center=Yi(Iw,t.center,(this.sphere[3]+n*(a-this.sphere[3]))/a)),Yi(this.tmpViewDir,this.tmpViewDir,-n),t.eye=Ki(Iw,t.center,this.tmpViewDir),Qv(this.view,t,this.constraintOptions),Ji(i,t.center)>1e-12&&Ey(this.sphere,t,s,this.targetOnSphere)&&function(t,e,i,s,n,r){uw(i,es(e.up,i),t[3],-sn.normalize(as(n)),r,e,Yy.Pole,Yy.Angle)?pw(t,e,i,s,-sn.normalize(as(n)),r,true):dw(t,e,i,s,r,true)}(this.sphere,t,i,this.targetOnSphere,this.view.camera.heading,this.view.camera.tilt)}else{let n=.6**Math.abs(e);const r=e>0?1:-1;let o;Xl(t,s,this.tmpRayDir),is(this.tmpRayDir.direction,this.tmpRayDir.direction),this.view.camera.position.hasZ&&(o=Math.abs(this.view.camera.position.z));let a=Math.max(12*o,20);const h=this.view._stage.renderView.getMinimalDepthForArea(s[0],s[1],this.view.state.camera,60);a=a>h?h:a,Yi(this.tmpRayDir.direction,this.tmpRayDir.direction,a),Ki(i,this.tmpRayDir.origin,this.tmpRayDir.direction);let l=a*n;if(e>0&&l<4&&(l=4,n=l/a),Math.abs(a-l)<1e-6)return;Yi(this.tmpRayDir.direction,this.tmpRayDir.direction,r*(1-n)),t.eye=Ki(Iw,t.eye,this.tmpRayDir.direction),t.center=Ki(Iw,t.center,this.tmpRayDir.direction)}ev(this.view,t)}};Ew=r([a("esri.views.3d.state.controllers.global.ZoomStepController")],Ew);const Iw=js();let Vw=class extends Fy{constructor(){super(...arguments),this.zoomLocation=js(),this.tmpCamera=new hr,this.tmpRayDir=js(),this.tmpCenter=js(),this.constraintOptions={selection:15,interactionType:1,interactionFactor:null,interactionStartCamera:new hr,interactionDirection:null,tiltMode:0}}zoomStep(t,e){if(!this.active)return;const i=this.view.state,{interactionStartCamera:s}=this.constraintOptions;this.animation.finished?s.copyFrom(i.camera):this.animation.cameraAt(1,s),this.tmpCamera.copyFrom(i.camera);const n=new Jn(this.view.state.viewingMode);t>0?(this.intersectionHelper.intersectScreenFreePointFallback(e,this.zoomLocation),this.intersectionHelper.intersectRay(this.tmpCamera.ray,n,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter)):this.intersectionHelper.intersectRay(this.tmpCamera.ray,n,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:$i(this.zoomLocation,this.tmpCamera.center);const r=.6**t;if(!da()){let t=this.view._stage.renderView.getMinimalDepthForArea(e[0],e[1],this.view.state.camera,60);const i=Math.max(14*Math.abs(this.view.camera.position.z),20);if(t=t?Math.min(t,i):i,t){const e=js();ts(e,this.zoomLocation,this.tmpCamera.eye),t<Xi(e)&&(is(e,e),Ki(this.zoomLocation,this.tmpCamera.eye,Yi(e,e,t)))}}this.updateCamera(this.tmpCamera,r,this.zoomLocation),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:ht(600),easing:Ov}}updateCamera(t,e,i){ts(this.tmpRayDir,i,t.eye);const s=Xi(this.tmpRayDir);let n=s*e;e<=1&&n<4&&(n=4,e=n/s),Math.abs(s-n)<1e-6||(Yi(this.tmpRayDir,this.tmpRayDir,e),t.eye=ts(jw,i,this.tmpRayDir),t.center=ws(jw,t.center,i,1-e),Qv(this.view,t,this.constraintOptions))}};Vw=r([a("esri.views.3d.state.controllers.local.ZoomStepController")],Vw);const jw=js();class Nw extends Xo{constructor(t,e){super(!0),this.view=t,this.registerIncoming("double-click",e,(t=>this.handleDoubleClick(t)))}handleDoubleClick(t){const e=t.data;if(se(e,"primary")){const i=this.view.state.isGlobal?new Ew({view:this.view,mode:"animation"}):new Vw({view:this.view,mode:"animation"});this.view.state.switchCameraController(i),i.zoomStep(Math.log(.5)/Math.log(.6),Co(e.x,e.y)),t.stopPropagation()}}}let kw=class extends Oy{constructor(){super(...arguments),this.startCamera=new hr,this.currentCamera=new hr}get isInteractive(){return!0}stepController(t,e){e.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(e)}onControllerStart(t){this.state=Dy.Running,this.startCamera.copyFrom(t),this.currentCamera.copyFrom(t)}onControllerEnd(t){t.copyViewFrom(this.currentCamera)}};kw=r([a("esri.views.3d.state.controllers.InteractiveController")],kw);let Bw=class extends kw{constructor(t){super(t),this.view=null,this.pivot=0,this.lastPoint=Sa(),this.tmpWorldUp=js(),this.tmpViewDir=js(),this.tmpRotCurPoint=Sa(),this.tmpTransf=gn(),this.tmpAxis=js(),this.tmpPivotPoint=js(),this.pivotPos=js(),this.constraintOptions={selection:15,interactionType:2,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0}}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.rotScale=0===this.pivot?3:1.5}begin(t){if(this.active){switch(this.pivot){case 1:$i(this.pivotPos,this.startCamera.eye),this.constraintOptions.interactionType=3,this.constraintOptions.tiltMode=1,this.constraintOptions.selection=0;break;case 0:this.intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this.pivotPos)||$i(this.pivotPos,this.startCamera.center),dt("disable-feature:context-navigation")||this.constrainPivotPoint(t),this.startCamera.center=this.pivotPos,this.constraintOptions.interactionType=2,this.constraintOptions.tiltMode=0,this.constraintOptions.selection=11}this.constraintOptions.interactionStartCamera=this.startCamera,Vy(this.startCamera,t,this.lastPoint)}}constrainPivotPoint(t){const e=this.startCamera,i=js();ts(i,this.pivotPos,e.eye);let s=Xi(i);this.view.camera.position.hasZ&&(s=Math.min(s,7*Math.abs(this.view.camera.position.z)));const n=Qr(this.view.spatialReference),r=Co(e.width/e.pixelRatio*.5,e.height/e.pixelRatio*.5),o=$y(this.startCamera,r,!0,n);let a=this.view._stage.renderView.getMinimalDepthForArea(e.fullWidth/e.pixelRatio*.5,e.fullHeight/e.pixelRatio*.5,e,225,90),h=this.view._stage.renderView.getMinimalDepthForArea(t[0],t[1],e,90);void 0===a&&void 0===h||(a=void 0===a?h:a,h=void 0===h||o===Zy.Horizontal?a:h,s=a>h?h:a),is(i,i),$i(this.pivotPos,Ki(this.tmpPivotPoint,e.eye,Yi(this.tmpPivotPoint,i,s)))}update(t){if(this.active){switch(this.pivot){case 1:this.currentCamera.center=this.applyRotation(this.currentCamera,t,this.currentCamera.center,this.pivotPos);break;case 0:this.currentCamera.center=this.pivotPos,this.currentCamera.eye=this.applyRotation(this.currentCamera,t,this.currentCamera.eye,this.pivotPos)}Qv(this.view,this.currentCamera,this.constraintOptions)}}end(){this.active&&this.finishController()}applyRotation(t,e,i,s){this.view.renderCoordsHelper.worldUpAtPosition(s,this.tmpWorldUp),Vy(t,e,this.tmpRotCurPoint);let n=(this.lastPoint[1]-this.tmpRotCurPoint[1])*this.rotScale,r=(this.tmpRotCurPoint[0]-this.lastPoint[0])*this.rotScale;ts(this.tmpViewDir,i,s);const o=Xi(this.tmpViewDir),a=rs(es(this.tmpViewDir,this.tmpWorldUp)/o);if(1===this.pivot){n*=-.5;const t=.5*Math.PI-a,e=.5*Math.PI*.99;n=t-Math.max(-e,Math.min(e,t+n))}return n=fs(n+a,Mf.min,Mf.max)-a,$r(this.tmpTransf),ss(this.tmpAxis,t.up,this.tmpViewDir),0===this.pivot&&(r=-r),eo(this.tmpTransf,this.tmpTransf,r,this.tmpWorldUp),eo(this.tmpTransf,this.tmpTransf,n,this.tmpAxis),os(this.tmpViewDir,this.tmpViewDir,this.tmpTransf),t.up=os(Gw,t.up,this.tmpTransf),Ki(Gw,s,this.tmpViewDir),ga(this.lastPoint,this.tmpRotCurPoint),Gw}};r([o({constructOnly:!0})],Bw.prototype,"view",void 0),r([o()],Bw.prototype,"pivot",void 0),Bw=r([a("esri.views.3d.state.controllers.RotateController")],Bw);const Gw=js();class qw extends Xo{constructor(t,e,i,s){super(!0),this.view=t,this.pointerAction=e,this.pivot=i,this.registerIncoming("drag",s,(t=>this.handleDrag(t)))}handleDrag(t){const e=t.data;if(e.pointers.size>1)return;if(!ne(t.data,this.pointerAction))return;const i=Co(e.center.x,e.center.y);switch(e.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.cameraController=new Bw({view:this.view,pivot:this.pivot}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(i);break;case"update":this.cameraController&&this.cameraController.update(i);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}t.stopPropagation()}}let Ww=class extends kw{constructor(t){super(t),this.view=null,this.pickPoint=js(),this.tmpP0=Sa(),this.panAxisAngle=tg(),this.tmpRayDir=js(),this.targetOnSphere=js(),this.tmpRay={origin:js(),direction:js()},this.dragBeginPoint=Co(),this.normalizedAnchorPoint=Sa(),this.constraintOptions={selection:7,interactionType:1,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0},this.sphere=Uo(),this.hasPickPoint=!1}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(t){if(!this.active)return;ga(this.dragBeginPoint,t),Vy(this.startCamera,t,this.normalizedAnchorPoint);const e=Qr(this.view.spatialReference),i=Ky(this.intersectionHelper,this.startCamera,t,!1,e);if(this.navMode=$y(this.startCamera,t,i.hasGeometryIntersection,e),this.navMode===Zy.Horizontal||dt("disable-feature:context-navigation"))this.hasPickPoint=!!i.scenePickPoint,this.pickPoint=i.scenePickPoint,this.sphere=i.sphere;else{let e;Xl(this.startCamera,t,this.tmpRay),is(this.tmpRay.direction,this.tmpRay.direction),this.view.camera.position.hasZ&&(e=Math.abs(this.view.camera.position.z));let i=30*e;const s=this.view._stage.renderView.getMinimalDepthForArea(t[0],t[1],this.view.state.camera,70);i=i>s?s:i,this.hasPickPoint=!0,Yi(this.tmpRay.direction,this.tmpRay.direction,i),Ki(this.pickPoint,this.tmpRay.origin,this.tmpRay.direction)}this.constraintOptions.interactionStartCamera=this.startCamera}update(t){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this.navMode===Zy.Horizontal||dt("disable-feature:context-navigation")){ts(this.tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const e=Xi(this.tmpRayDir);Vy(this.currentCamera,t,this.tmpP0);const i=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let s=e*2**i;const n=this.view.state.constraints.minimumPoiDistance;if(i<0&&s<n&&(s=n),Math.abs(e-s)<1e-6)return;if(this.hasPickPoint&&s<e){const t=1-(1-s/e)*(1-this.sphere[3]/Xi(this.currentCamera.center));this.currentCamera.center=Yi(Uw,this.currentCamera.center,t)}Yi(this.tmpRayDir,this.tmpRayDir,-s/e),this.currentCamera.eye=Ki(Uw,this.currentCamera.center,this.tmpRayDir),this.constraintOptions.interactionFactor=Yv(this.dragBeginPoint,t),Qv(this.view,this.currentCamera,this.constraintOptions),this.hasPickPoint&&(ew(this.sphere,this.currentCamera,this.dragBeginPoint,this.targetOnSphere),ig(this.pickPoint,this.targetOnSphere,this.panAxisAngle),Ny(this.currentCamera,this.sphere,this.panAxisAngle))}else{const e=Xi(this.tmpRay.direction);Vy(this.currentCamera,t,this.tmpP0);const i=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let s=e*2**i;const n=this.view.state.constraints.minimumPoiDistance;if(i<0&&s<n&&(s=n),Math.abs(e-s)<1e-6)return;Yi(this.tmpRayDir,this.tmpRay.direction,1-s/e),this.currentCamera.eye=Ki(Uw,this.currentCamera.eye,this.tmpRayDir),this.currentCamera.center=Ki(Uw,this.currentCamera.center,this.tmpRayDir)}ev(this.view,this.currentCamera)}}end(){this.active&&this.finishController()}};r([o({constructOnly:!0})],Ww.prototype,"view",void 0),Ww=r([a("esri.views.3d.state.controllers.global.ZoomController")],Ww);const Uw=js();let Hw=class extends kw{constructor(t){super(t),this.view=null,this.tmpP=js(),this.tmpDir=js(),this.tmpN=js(),this.tmpP0=Sa(),this.tmpPoi=js(),this.tmpRayDir=js(),this.dragBeginPoint=Co(),this.normalizedAnchorPoint=Sa(),this.constraintOptions={selection:15,interactionType:1,interactionFactor:0,interactionStartCamera:null,interactionDirection:js(),tiltMode:0},this.plane=Gl()}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(t){if(!this.active)return;let e;ga(this.dragBeginPoint,t),Vy(this.startCamera,t,this.normalizedAnchorPoint),this.intersectionHelper.intersectScreenFreePointFallback(t,this.tmpP),ts(this.tmpDir,this.tmpP,this.startCamera.eye),is(this.tmpDir,this.tmpDir),this.view.camera.position.hasZ&&(e=Math.abs(this.view.camera.position.z));let i=30*e;const s=this.view._stage.renderView.getMinimalDepthForArea(t[0],t[1],this.view.state.camera,70);i=i>s?s:i,Yi(this.tmpDir,this.tmpDir,i),Ki(this.tmpP,this.startCamera.eye,this.tmpDir),ts(this.tmpN,this.startCamera.eye,this.startCamera.center),is(this.tmpN,this.tmpN),this.tmpN[1]<0&&ls(this.tmpN,this.tmpN),ql(this.tmpP,this.tmpN,this.plane),this.constraintOptions.interactionStartCamera=this.startCamera}update(t){if(!this.active)return;ky(this.plane,this.currentCamera,this.dragBeginPoint,this.tmpPoi)||$i(this.tmpPoi,this.currentCamera.center),Vy(this.currentCamera,t,this.tmpP0);let e=4*(this.tmpP0[1]-this.normalizedAnchorPoint[1]);ga(this.normalizedAnchorPoint,this.tmpP0),ts(this.tmpRayDir,this.tmpPoi,this.currentCamera.eye);const i=Xi(this.tmpRayDir);let s=i*(1-e);$i(this.constraintOptions.interactionDirection,this.tmpRayDir),Yi(this.constraintOptions.interactionDirection,this.constraintOptions.interactionDirection,Math.sign(e)/i);const n=this.view.state.constraints.minimumPoiDistance;e>=0&&s<n&&(s=n,e=-(s-i)/i),Math.abs(i-s)<1e-6||(Yi(this.tmpRayDir,this.tmpRayDir,e),this.currentCamera.eye=Ki(Zw,this.currentCamera.eye,this.tmpRayDir),ws(Zw,this.currentCamera.center,this.tmpPoi,e),Zw[2]=this.tmpPoi[2]>this.startCamera.center[2]?Math.max(this.startCamera.center[2],Zw[2]):Math.min(this.startCamera.center[2],Zw[2]),this.currentCamera.center=Zw,this.constraintOptions.interactionFactor=Yv(this.dragBeginPoint,t),Qv(this.view,this.currentCamera,this.constraintOptions))}end(){this.active&&this.finishController()}};r([o({constructOnly:!0})],Hw.prototype,"view",void 0),Hw=r([a("esri.views.3d.state.controllers.local.ZoomController")],Hw);const Zw=js();class Qw extends Xo{constructor(t,e,i){super(!0),this.view=t,this.pointerAction=e,this.registerIncoming("drag",i,(t=>this.handleDrag(t)))}handleDrag(t){const e=t.data;if(e.pointers.size>1)return;if(!ne(t.data,this.pointerAction))return;const i=Co(e.center.x,e.center.y);switch(e.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.cameraController=this.view.state.isGlobal?new Ww({view:this.view}):new Hw({view:this.view}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(i);break;case"update":this.cameraController&&this.cameraController.update(i);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}t.stopPropagation()}}let Yw=class extends kw{constructor(t){super(t),this.transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this.keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this.tmpCamera=new hr,this.constraintOptions={selection:15,interactionType:0,interactionStartCamera:new hr,interactionFactor:0,interactionDirection:null,tiltMode:1}}handleEventGamepad(t){const e=re(t,this.view.navigation.gamepad,this.transformation);("end"===t.action||oe(e))&&this.finishController()}activateDirection(t){this.keysButtonState[t]=1,ae(this.keysButtonState,this.transformation)}deactivateDirection(t){this.keysButtonState[t]=0;const e=ae(this.keysButtonState,this.transformation);oe(e)&&this.finishController()}onControllerStart(t){this.filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this.headingStart=this.view.camera.heading,super.onControllerStart(t)}updateFilteredSurfaceElevation(t){this.filteredSurfaceElevation+=1*(this.view.pointsOfInterest.cameraOnSurface.location.z-this.filteredSurfaceElevation)*t}stepController(t,e){this.updateStartHeading(),this.updateFilteredSurfaceElevation(t),this.currentCamera.copyViewFrom(e),this.updateCameraCenter(),this.constraintOptions.interactionStartCamera.copyFrom(this.currentCamera),this.calculateControlTransformation(t,this.currentCamera,sx),this.applyDisabledMovementTypes(sx),this.applyPan(sx.pan),this.applyRotate(sx.rotate),this.applyZoom(sx.zoom),this.applyAscend(sx.ascend),this.constraintOptions.interactionType=0,this.constraintOptions.selection=8,Qv(this.view,this.currentCamera,this.constraintOptions),super.stepController(t,e)}updateStartHeading(){0!==this.transformation.heading&&(this.headingStart=this.view.camera.heading)}applyRotate(t){if(!t.enabled)return;const e=this.currentCamera;ts(nx,e.center,e.eye),os(nx,nx,t.matrix),e.center=Ki(nx,nx,e.eye),e.up=os(nx,e.up,t.matrix),this.constraintOptions.interactionType=3,this.constraintOptions.selection=7,Qv(this.view,e,this.constraintOptions)}applyPan(t,e=this.currentCamera){t.enabled&&(e.eye=os(nx,e.eye,t.matrix),e.center=os(nx,e.center,t.matrix),this.view.state.isGlobal&&(e.up=os(nx,e.up,t.matrix)),this.constraintOptions.interactionType=4,this.constraintOptions.selection=15,Qv(this.view,e,this.constraintOptions))}applyZoom(t){if(!t)return;const e=this.currentCamera.viewForward;this.currentCamera.eye=Ki(nx,this.currentCamera.eye,Yi(nl.get(),e,t)),$i(rx,e),ls(rx,rx),this.constraintOptions.interactionDirection=rx,this.constraintOptions.interactionType=1,this.constraintOptions.selection=7,Qv(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}applyAscend(t){if(!t)return;const e=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,nl.get());if(this.constraintOptions.interactionDirection=$i(rx,e),this.view.state.isGlobal){const e=Xi(this.currentCamera.eye),i=(e+t)/e;this.currentCamera.eye=Yi(nx,this.currentCamera.eye,i),this.currentCamera.center=Yi(nx,this.currentCamera.center,i)}else{const i=Yi(nl.get(),e,t);this.currentCamera.eye=Ki(nx,this.currentCamera.eye,i),this.currentCamera.center=Ki(nx,this.currentCamera.center,i)}this.updateCameraCenter(),this.constraintOptions.interactionType=5,this.constraintOptions.selection=8,Qv(this.view,this.currentCamera,this.constraintOptions)&&this.updateCameraCenter(),this.constraintOptions.selection=7,Qv(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}calculateControlTransformation(t,e,i){!function(t){t.zoom=0,t.ascend=0,t.pan.enabled=!1,$r(t.pan.matrix),t.rotate.enabled=!1,$r(t.rotate.matrix)}(i);const s=this.computeVelocities(t);this.view.state.isLocal?this.calculateControlTransformationLocal(s,e,i):this.calculateControlTransformationGlobal(s,e,i)}updateCameraCenter(){this.currentCamera.center=this.view.renderCoordsHelper.intersectManifoldClosestSilhouette(this.currentCamera.ray,this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,nx)}calculateControlTransformationLocal(t,e,i){const{viewRight:s,viewForward:n}=e,r=this.transformation,o=this.view.navigation.gamepad,a=ds(nl.get(),n[0],n[1],0);is(a,a);const h=r.translation[0]*t.pan;if(0!==h){const t=Yi(nl.get(),s,h);ho(i.pan.matrix,i.pan.matrix,t),i.pan.enabled=!0}switch(o.mode){case"pan":{const e=-r.translation[1]*t.pan;if(0!==e){const t=Yi(nl.get(),a,e);ho(i.pan.matrix,i.pan.matrix,t),i.pan.enabled=!0}i.zoom=r.zoom*t.zoom;break}case"zoom":i.zoom=(-r.translation[1]+r.zoom)*t.zoom}i.ascend=r.translation[2]*t.ascend;const l=-r.heading*t.rotate;0!==l&&(eo(i.rotate.matrix,i.rotate.matrix,l,this.view.renderCoordsHelper.worldUpAtPosition(e.eye,nl.get())),i.rotate.enabled=!0);const c=r.tilt*t.rotate,u=nv(this.view.renderCoordsHelper,e.center,e.eye),d=fs(u+c,Mf.min,Mf.max)-u;d&&(eo(i.rotate.matrix,i.rotate.matrix,d,s),i.rotate.enabled=!0)}calculateControlTransformationGlobal(t,e,i){const{eye:s,viewRight:n}=e,r=this.transformation,o=this.view.navigation.gamepad,a=ss(nl.get(),n,s);is(a,a),ls(a,a),function(t,e,i,s,n,r,o,a,h){uw(t.center,es(t.up,t.center),Xi(t.center),-sn.normalize(as(r)),o,e)?function(t,e,i,s,n,r){const{eye:o}=t;lf([0,0,1],o,fw,gw,mw);const a=e.translation[0]*i.pan,h="zoom"===n.mode?0:e.translation[1]*i.pan,l=Math.max(Math.sqrt(Math.abs(1-es(t.center,fw)**2/Xi(t.center)**2)),.5),c=(Math.sin(r)*h+Math.cos(r)*a)/l,u=-Math.cos(r)*h+Math.sin(r)*a;switch(eo(s.pan.matrix,s.pan.matrix,c,fw),s.pan.enabled=!0,n.mode){case"pan":eo(s.pan.matrix,s.pan.matrix,u,gw),s.pan.enabled=!0;break;case"zoom":s.zoom=-e.translation[1]*i.zoom}}(e,i,s,a,h,-sn.normalize(as(n))):function(t,e,i,s,n){const{eye:r,viewRight:o}=t,a=ss(nl.get(),o,r),h=e.translation[0]*i.pan;switch(0!==h&&(eo(s.pan.matrix,s.pan.matrix,-h,a),s.pan.enabled=!0),n.mode){case"pan":{const t=e.translation[1]*i.pan;0!==t&&(eo(s.pan.matrix,s.pan.matrix,t,o),s.pan.enabled=!0);break}case"zoom":s.zoom=-e.translation[1]*i.zoom}}(e,i,s,a,h)}(this.startCamera,e,r,t,this.view.camera.heading,this.headingStart,this.view.camera.tilt,i,o),this.tmpCamera.copyFrom(this.currentCamera),this.applyPan(sx.pan,this.tmpCamera);const h=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude;i.ascend=r.translation[2]*t.ascend;const l=-r.heading*t.rotate;0!==l&&(eo(i.rotate.matrix,i.rotate.matrix,l,this.tmpCamera.eye),i.rotate.enabled=!0);const c=this.clampTiltDeltaGlobalToValidRange(r.tilt*t.rotate,e.ray,h);0!==c&&(eo(i.rotate.matrix,i.rotate.matrix,c,this.tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=r.zoom*t.zoom}clampTiltDeltaGlobalToValidRange(t,e,i){const s=Qr(this.view.spatialReference),n=Uy(Mf.min,e.origin,i,s);let r=0,o=0;const a=nl.get();return this.view.renderCoordsHelper.intersectManifold(e,i,a)?(r=Uy(nv(this.view.renderCoordsHelper,a,e.origin),e.origin,i,s),o=Uy(Mf.max,e.origin,i,s)):(Go(qo(i+s.radius),e,a),r=Hy(rs(-es(e.direction,is(a,a))),e.origin,i,s),o=Hy(Mf.max,e.origin,i,s)),fs(r+t,n,o)-r}getPointAbsoluteSurfaceElevation(t,e,i){const{renderCoordsHelper:s}=this.view,n=s.getAltitude(t),r=e+Math.abs(n-e);return s.setAltitude(i,r,t),r}clampedDistanceToSurface(t,e){const{renderCoordsHelper:i}=this.view,{camera:s}=this.view.state,{direction:n}=function(t,e,i,s,n){return xd(t).headingTiltToDirectionUp(e,0,s,n)}(this.view,e,0,Kw,ox),r=i.intersectManifoldClosestSilhouette(No(e,n),t,nl.get()),o=cs(e,r),a=i.intersectManifoldClosestSilhouette(No(e,xs(nl.get(),e,s.center)),t,nl.get()),h=cs(e,a);return Math.min(o,h)}computeHeadingRotateRadius(t){const{renderCoordsHelper:e,state:i}=this.view,{camera:s,isGlobal:n}=i,r=e.intersectManifoldClosestSilhouette(s.ray,this.filteredSurfaceElevation,nl.get());if(n){const e=ts(nl.get(),t,r),i=Xi(e);Yi(e,e,1/i);const s=is(nl.get(),t),n=rs(es(s,e));return i*Math.sin(Math.min($w,n))}{const i=$i(nl.get(),t);return e.setAltitude(i,this.filteredSurfaceElevation),cs(r,i)}}minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:tx}computeVelocities(t){const e=this.filteredSurfaceElevation,i=e+Qr(this.view.spatialReference).radius,{camera:s,isGlobal:n}=this.view.state,r=nl.get(),o=this.getPointAbsoluteSurfaceElevation(s.eye,e,r),a=this.clampedDistanceToSurface(e,r),h=s.width/2,l=Jw*s.width,c=Jw*s.width,u=a*Math.tan(.5*s.fovX)/h,d=u/i,p=u/this.computeHeadingRotateRadius(r),f=o-e;return{pan:(n?d:u)*l*t,ascend:Math.max(this.minimumAscendVelocity()*t,2**(l*t/h)*f-f),zoom:2**(l*t/h)*a-a,rotate:fs(p*c,ex,ix)*t}}applyDisabledMovementTypes(t){!p(this.disableMovements)||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(t.zoom=this.disableMovements.zoom?0:t.zoom,t.ascend=this.disableMovements.ascend?0:t.ascend,t.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&$r(t.pan.matrix),t.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&$r(t.rotate.matrix))}static activatesFor(t,e){const i=re(e,t.navigation.gamepad,Xw);return!("end"===e.action||oe(i))}};r([o({constructOnly:!0})],Yw.prototype,"view",void 0),r([o({constructOnly:!0})],Yw.prototype,"gamepadDevice",void 0),r([o({constructOnly:!0})],Yw.prototype,"disableMovements",void 0),Yw=r([a("esri.views.3d.state.controllers.GamepadKeyboardController")],Yw);const Xw={translation:[0,0,0],heading:0,tilt:0,zoom:0},Kw=80,$w=as(Kw),Jw=.75,tx=5,ex=as(30),ix=as(80),sx={zoom:0,ascend:0,pan:{enabled:!1,matrix:gn()},rotate:{enabled:!1,matrix:gn()}},nx=js(),rx=js(),ox=qu();class ax extends Xo{constructor(t){super(!0),this.view=t,this.watchHandles=new E,this.handle=this.registerIncoming("gamepad",(t=>this.handleEventGamepad(t))),this.handle.pause()}onInstall(t){super.onInstall(t),this.watchHandles.add([tt(this.view.navigation.gamepad,"enabled",(t=>{t?this.handle.resume():(this.handle.pause(),this.cameraControllerGamepad&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null))})),this.view.navigation.gamepad.watch("device",(t=>{this.cameraControllerGamepad&&t&&this.cameraControllerGamepad.gamepadDevice!==t&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null)}))])}onUninstall(){this.watchHandles.removeAll(),super.onUninstall()}handleEventGamepad(t){const e=this.view.navigation.gamepad.device;if(e&&t.data.device!==e)return;const i=this.cameraControllerGamepad&&this.cameraControllerGamepad.active;if(i||Yw.activatesFor(this.view,t.data)){if(!i){const e=new Yw({view:this.view,gamepadDevice:t.data.device});this.view.state.switchCameraController(e)&&(this.cameraControllerGamepad=e)}this.cameraControllerGamepad&&this.cameraControllerGamepad.active&&this.cameraControllerGamepad.gamepadDevice===t.data.device&&this.cameraControllerGamepad.handleEventGamepad(t.data)}}}class hx extends Xo{constructor(t,e){super(!0),this.view=t,this.disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:2},this.keyToNumber={[e.left]:0,[e.right]:1,[e.forward]:2,[e.backward]:3,[e.up]:4,[e.down]:5,[e.headingLeft]:6,[e.headingRight]:7,[e.tiltUp]:8,[e.tiltDown]:9,[e.zoomIn]:10,[e.zoomOut]:11},this.registerIncoming("key-down",null,(t=>this.handleKeyDown(t))),this.registerIncoming("key-up",null,(t=>this.handleKeyUp(t))),this.registerIncoming("blur",null,(()=>this.handleBlur()))}handleKeyDown(t){if(t.data.native.ctrlKey||t.data.native.metaKey)return;const e=this.keyToNumber[t.data.key];null!=e&&(this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active||(this.cameraControllerKeyboard=new Yw({view:this.view,disableMovements:this.disableMovements}),this.view.state.switchCameraController(this.cameraControllerKeyboard)),this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.activateDirection(e),t.stopPropagation()))}handleBlur(){this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.finishController(),this.cameraControllerKeyboard=null)}handleKeyUp(t){if(t.data.native.ctrlKey||t.data.native.metaKey)return;const e=this.keyToNumber[t.data.key];null!=e&&this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.deactivateDirection(e),t.stopPropagation())}}class lx extends Xo{constructor(t,e){super(!0),this.view=t,this.registerIncoming("mouse-wheel",e,(t=>this.handleMouseWheel(t)))}handleMouseWheel(t){if(!this.view.navigation.mouseWheelZoomEnabled)return;const e=t.data;this.cameraController&&this.cameraController.active||(this.cameraController=this.view.state.isGlobal?new Ew({view:this.view,mode:"interaction"}):new Vw({view:this.view,mode:"interaction"}),this.view.state.switchCameraController(this.cameraController)),this.cameraController.zoomStep(-1/60*e.deltaY,Co(e.x,e.y)),t.preventDefault(),t.stopPropagation()}}class cx{constructor(t){this._gain=t}reset(t){this._value=t}set gain(t){this._gain=t}get value(){return void 0===this._value?0:this._value}update(t){this._value=void 0===this._value?t:this._gain*t+(1-this._gain)*this._value}}let ux=class extends Ry{constructor(t){super(t),this.view=null,this.beginCamera=new hr,this.elapsedTimeSec=0,this.constraintOptions={selection:15,interactionType:4,interactionFactor:0,interactionStartCamera:new hr,interactionDirection:null,tiltMode:0}}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new ie}get steppingFinished(){return this.momentum.isFinished(this.elapsedTimeSec)}onControllerStart(t){this.beginCamera.copyFrom(t),this.constraintOptions.interactionStartCamera=this.beginCamera,super.onControllerStart(t)}stepController(t,e){e.copyViewFrom(this.beginCamera),this.elapsedTimeSec+=t,this.momentumStep(this.elapsedTimeSec,e),Qv(this.view,e,this.constraintOptions)}};r([o({constructOnly:!0})],ux.prototype,"view",void 0),ux=r([a("esri.views.3d.state.controllers.momentum.MomentumController")],ux);let dx=class extends ux{constructor(t){super(t),this.interactionType=4,this.tmpPan=js()}momentumStep(t,e){const i=this.momentum.value(t);Yi(this.tmpPan,this.momentum.direction,i),e.eye=ts(px,e.eye,this.tmpPan),e.center=ts(px,e.center,this.tmpPan),this.constraintOptions.interactionDirection=this.tmpPan}};r([o({constructOnly:!0})],dx.prototype,"momentum",void 0),dx=r([a("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],dx);const px=js(),fx=js(),gx=js();let mx=class extends ux{constructor(t){super(t),this.interactionType=4}momentumStep(t,e){const i=this.momentum.value1(t),s=this.momentum.value2(t);$i(gx,e.eye),is(gx,gx),ss(this.momentum.axis2,gx,this.momentum.axis1),cw(e,fx,this.momentum.axis1,i,this.momentum.axis2,s)}};r([o({constructOnly:!0})],mx.prototype,"momentum",void 0),mx=r([a("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],mx);let vx=class extends ux{constructor(t){super(t),this.interactionType=2}set center(t){this._set("center",ks(t))}set axis(t){this._set("axis",ks(t))}momentumStep(t,e){const i=this.momentum.value(t);Ny(e,this.center,eg(this.axis,i))}};r([o({constructOnly:!0})],vx.prototype,"momentum",void 0),r([o({constructOnly:!0})],vx.prototype,"center",null),r([o({constructOnly:!0})],vx.prototype,"axis",null),vx=r([a("esri.views.3d.state.controllers.momentum.MomentumController")],vx);let yx=class extends ux{constructor(t){super(t),this.interactionType=1,this.constraintOptions.interactionDirection=js()}set zoomCenter(t){this._set("zoomCenter",ks(t))}momentumStep(t,e){$i(this.constraintOptions.interactionDirection,e.eye);const i=this.momentum.valueDelta(0,t);By(e,this.zoomCenter,i,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionDirection=xs(this.constraintOptions.interactionDirection,e.eye,this.constraintOptions.interactionDirection)}};r([o({constructOnly:!0})],yx.prototype,"momentum",void 0),r([o({constructOnly:!0})],yx.prototype,"zoomCenter",null),yx=r([a("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],yx);let wx=class extends ux{constructor(t){super(t),this.interactionType=1,this.radius=0,this.tmpSceneCenter=js(),this.tmpZoomAxisAngle=tg(),this.sphere=Uo()}set screenCenter(t){this._set("screenCenter",Co(t[0],t[1]))}set sceneCenter(t){this._set("sceneCenter",ks(t))}initialize(){this.sphere[3]=this.radius}momentumStep(t,e){const i=this.momentum.valueDelta(0,t);Gy(this.sphere,e,i),this.constraintOptions.interactionType=1,Qv(this.view,e,this.constraintOptions),ew(this.sphere,e,this.screenCenter,this.tmpSceneCenter),ig(this.sceneCenter,this.tmpSceneCenter,this.tmpZoomAxisAngle),Ny(e,this.sphere,this.tmpZoomAxisAngle),this.constraintOptions.interactionType=4}};r([o({constructOnly:!0})],wx.prototype,"momentum",void 0),r([o({constructOnly:!0})],wx.prototype,"screenCenter",null),r([o({constructOnly:!0})],wx.prototype,"sceneCenter",null),r([o({constructOnly:!0})],wx.prototype,"radius",void 0),wx=r([a("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],wx);class xx{constructor(t){this.gain=t}update(t){this.filteredValue=this.hasFilteredValue?(1-this.gain)*this.filteredValue+this.gain*t:t}reset(){this.filteredValue=void 0}get hasFilteredValue(){return void 0!==this.filteredValue}}class bx extends ec{constructor(t,e,i,s,n,r=0,o){super(t,e,i),this.angularVelocity1=s,this.axis1=n,this.angularVelocity2=r,this.axis2=o}value1(t){return super.valueFromInitialVelocity(this.angularVelocity1,t)}value2(t){return super.valueFromInitialVelocity(this.angularVelocity2,t)}}class Cx{constructor(t=300,e=12,i=.84){this.minimumInitialVelocity=t,this.stopVelocity=e,this.friction=i,this.enabled=!0,this.tmpAxis1=js(),this.tmpAxis2=js(),this.tmpAngles=Sa(),this.time=new tc(.3),this.screen=[new tc(.4),new tc(.4)],this.angle1=new xx(.6),this.angle2=new xx(.6),this.axis1=js(),this.axis2=js(),this.lastScene=js()}addMomentumDirectRotation(t,e,i,s,n,r){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(i)<.01)return;let t=rw(this.lastScene,e,this.tmpAxis2,s,n,r);this.angle2.update(0),vs(this.tmpAxis2)<1e-5?t=0:is(this.axis1,this.tmpAxis2),this.angle1.update(t),$i(this.lastScene,e)}this.screen[0].update(t[0]),this.screen[1].update(t[1]),this.time.update(i)}}addMomentumPreserveHeading(t,e,i,s,n,r,o){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(i)<.01)return;hw(this.lastScene,e,this.tmpAxis2,this.tmpAxis1,this.tmpAngles,s,n,r,o,!1),vs(this.tmpAxis2)<1e-5?(this.angle1.update(0),this.angle2.update(0)):(this.angle1.update(this.tmpAngles[1]),this.angle2.update(this.tmpAngles[0]),is(this.axis1,this.tmpAxis1),is(this.axis2,this.tmpAxis2)),$i(this.lastScene,e)}this.screen[0].update(t[0]),this.screen[1].update(t[1]),this.time.update(i)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.angle1.reset(),this.angle2.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const t=this.screen[0].filteredDelta,e=this.screen[1].filteredDelta,i=Math.sqrt(t*t+e*e)/this.time.filteredDelta;return Math.abs(i)<this.minimumInitialVelocity?null:this.createMomentum(i,this.stopVelocity,this.friction)}createMomentum(t,e,i){return new bx(t,e,i,this.angle1.filteredValue/this.time.filteredDelta,this.axis1,this.angle2.filteredValue/this.time.filteredDelta,this.axis2)}}let Mx=class extends kw{constructor(t){super(t),this.view=null,this.smoothRotation=new cx(.05),this.rotationAxis=js(),this.panningPlane=Gl(),this.smoothScaling=new cx(.05),this.zoomCenterScreen=Co(),this.zoomMomentumEstimator=new ic,this.rotationMomentumEstimator=new sc,this.panSphericalMomentumEstimator=new Cx,this.panPlanarMomentumEstimator=new nc,this.adjustedSphere=Uo(),this.tmp3d=js(),this.tmpScreenPointArray=Co(),this.beginScreenPoint=Co(),this.beginScenePoint=js(),this.screenPickPoint=Co(),this.navMode=Zy.Horizontal,this.tmpInteractionDirection=js(),this.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new hr,interactionDirection:null,tiltMode:0}}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(t){if(!this.active)return;const e=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=e,this.rotationMomentumEstimator.enabled=e,this.panPlanarMomentumEstimator.enabled=e,this.panSphericalMomentumEstimator.enabled=e,this.beginHeading=-sn.normalize(as(this.view.camera.heading)),this.beginRadius=t.radius,this.pointerCount=t.pointers.size,this.beginAngle=t.angle,this.smoothRotation.reset(),Mo(t.center,this.screenPickPoint),ga(this.beginScreenPoint,this.screenPickPoint);const i=Qr(this.view.spatialReference),s=Ky(this.intersectionHelper,this.startCamera,this.screenPickPoint,!0,i);this.scenePickPoint=s.scenePickPoint,this.sphere=s.sphere,$i(this.beginScenePoint,this.scenePickPoint),this.navMode=$y(this.startCamera,this.screenPickPoint,s.hasGeometryIntersection,i),this.navMode===Zy.Vertical&&this.preparePlanarPanMode(t),this.constraintOptions.interactionStartCamera.copyFrom(this.startCamera)}preparePlanarPanMode(t){const e=ls(this.tmp3d,this.startCamera.viewForward);ql(this.scenePickPoint,e,this.panningPlane);const i=Co(this.screenPickPoint[0],0),s=js(),n=Xi(this.startCamera.eye);this.adjustedSphere[3]=n<this.sphere[3]?n-100:this.sphere[3],ew(this.adjustedSphere,this.startCamera,i,s);const r=So();if(this.startCamera.projectToRenderScreen(s,r),this.screenPickPoint[1]=Math.min(this.screenPickPoint[1],.9*r[1]),this.intersectionHelper.intersectScreen(this.screenPickPoint,this.scenePickPoint)&&ql(this.scenePickPoint,Wl(this.panningPlane),this.panningPlane),!da()){const t=js(),e=js(),i=js(),s=80,n=5,r=50;ts(t,this.scenePickPoint,this.currentCamera.eye),is(t,t);const o=n*Math.max(Math.abs(this.view.camera.position.z),r),a=this.view._stage.renderView.getMinimalDepthForArea(this.screenPickPoint[0],this.screenPickPoint[1],this.view.state.camera,s),h=a?Math.min(a,o):o;$i(i,Ki(e,this.currentCamera.eye,Yi(e,t,h))),this.panningPlane[3]=-es(this.panningPlane,i),this.startCamera.center=Ki(e,this.startCamera.eye,Yi(e,this.startCamera.viewForward,h))}const o=Mo(t.center,this.tmpScreenPointArray);ky(this.panningPlane,this.startCamera,o,this.beginScenePoint)}update(t){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const e=t.pointers.size>1;this.navMode===Zy.Horizontal?(e&&this.zoomSpherical(t),this.panningSpherical(t),e&&this.rotateSpherical(t)):(e&&this.zoomPlanar(t),this.panningPlanar(t),e&&this.rotatePlanar(t))}end(t){t.pointers.size===this.pointerCount&&this.update(t),this.finishController();const e=this.zoomMomentumEstimator.evaluateMomentum();if(e)return this.navMode===Zy.Horizontal?new wx({view:this.view,momentum:e,screenCenter:this.zoomCenterScreen,sceneCenter:this.beginScenePoint,radius:this.sphere[3]}):new yx({view:this.view,momentum:e,zoomCenter:this.beginScenePoint});const i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new vx({view:this.view,momentum:i,center:this.sphere,axis:this.rotationAxis});if(this.navMode===Zy.Horizontal){const t=this.panSphericalMomentumEstimator.evaluateMomentum();if(t)return new mx({view:this.view,momentum:t})}else{const t=this.panPlanarMomentumEstimator.evaluateMomentum();if(t)return new dx({view:this.view,momentum:t})}return null}zoomSpherical(t){const e=this.beginRadius/t.radius,i=.001875*Math.min(Math.max(t.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(e),Gy(this.sphere,this.currentCamera,this.smoothScaling.value),Mo(t.center,this.zoomCenterScreen),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*t.timestamp),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=Yv(t.radius-this.beginRadius),Qv(this.view,this.currentCamera,this.constraintOptions)}panningSpherical(t){const e=Mo(t.center,this.tmpScreenPointArray);ew(this.sphere,this.currentCamera,e,this.tmp3d),uw(this.beginScenePoint,es(this.currentCamera.up,this.beginScenePoint),this.sphere[3],this.beginHeading,this.view.camera.tilt,this.startCamera)?(pw(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.beginHeading,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumPreserveHeading(e,this.tmp3d,.001*t.timestamp,this.startCamera,this.sphere,this.beginHeading,this.view.camera.tilt)):(dw(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumDirectRotation(e,this.tmp3d,.001*t.timestamp,this.startCamera,this.sphere[3],this.view.camera.tilt)),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=Yv(this.screenPickPoint,e),Qv(this.view,this.currentCamera,this.constraintOptions)}rotateSpherical(t){is(this.rotationAxis,this.scenePickPoint),this.currentCamera.aboveGround||ls(this.rotationAxis,this.rotationAxis);const e=this.smoothRotation.value,i=e+jy(t.angle-e),s=.00125*Math.min(Math.max(t.radius,40),120);this.smoothRotation.gain=s,this.smoothRotation.update(i);const n=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(n,.001*t.timestamp),Ny(this.currentCamera,this.sphere,eg(this.rotationAxis,n)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=Yv(t.radius*i),Qv(this.view,this.currentCamera,this.constraintOptions)}panningPlanar(t){const e=Mo(t.center,this.tmpScreenPointArray);ky(this.panningPlane,this.currentCamera,e,this.tmp3d)&&(Jy(this.currentCamera,this.beginScenePoint,this.tmp3d),this.panPlanarMomentumEstimator.add(e,this.tmp3d,.001*t.timestamp),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=Yv(this.beginScreenPoint,e),this.constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this.tmpInteractionDirection),Qv(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null)}zoomPlanar(t){const e=this.beginRadius/t.radius,i=.001875*Math.min(Math.max(t.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(e),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*t.timestamp),By(this.currentCamera,this.beginScenePoint,this.smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=Yv(t.radius-this.beginRadius),Qv(this.view,this.currentCamera,this.constraintOptions)}rotatePlanar(t){$i(this.rotationAxis,this.beginScenePoint),this.currentCamera.aboveGround||ls(this.rotationAxis,this.rotationAxis);const e=this.smoothRotation.value;let i=t.angle-e;i=jy(i);const s=e+i,n=.00125*Math.min(Math.max(t.radius,40),120);this.smoothRotation.gain=n,this.smoothRotation.update(s);const r=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(r,.001*t.timestamp),Ny(this.currentCamera,this.sphere,eg(this.rotationAxis,r)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=Yv(t.radius*r),Qv(this.view,this.currentCamera,this.constraintOptions)}};r([o({constructOnly:!0})],Mx.prototype,"view",void 0),Mx=r([a("esri.views.3d.state.controllers.global.PinchAndPanController")],Mx);const Sx=Ns(0,0,1),Px=16/180*Math.PI;let Tx=class extends kw{constructor(t){super(t),this.view=null,this.rotationValueSmooth=new cx(.05),this.scalingValueSmooth=new cx(.05),this.planeHorizontal=Gl(),this.planeVertical=Gl(),this.rotationMomentumEstimator=new sc,this.panMomentumEstimator=new nc(300,12,.9),this.zoomMomentumEstimator=new ic,this.beginCenter=js(),this.tmpPoints=[],this.beginCenterScreen=Co(),this.tmpCentroid3d=js(),this.tmpCentroid2d=Co(),this.tmp2d=Co(),this.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new hr,interactionDirection:null,tiltMode:0}}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(t){if(!this.active)return;const e=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=e,this.rotationMomentumEstimator.enabled=e,this.panMomentumEstimator.enabled=e,this.beginRadius=t.radius,this.pointerCount=t.pointers.size,this.beginAngle=t.angle,this.rotationValueSmooth.reset(),this.scalingValueSmooth.reset(),Mo(t.center,this.beginCenterScreen),kl(Sx,0,this.planeHorizontal);const i=js();this.intersectionHelper.intersectScreenFreePointFallback(this.beginCenterScreen,i);const s=js();ls(s,this.startCamera.viewForward);const n=js();$i(n,Sx);const r=es(s,n),o=hs(r<0?-r:r);if(this.panMode=o>=Px?Zy.Horizontal:Zy.Vertical,Ul(this.planeHorizontal,i,this.planeHorizontal),this.startCamera.aboveGround||Hl(this.planeHorizontal,this.planeHorizontal),this.panMode===Zy.Vertical){if(Yi(n,n,r),ts(this.planeVertical,s,n),is(this.planeVertical,this.planeVertical),Ul(this.planeVertical,i,this.planeVertical),!da()){const t=js(),e=js(),s=js();ts(t,i,this.currentCamera.eye),is(t,t);const n=5*Math.max(Math.abs(this.view.camera.position.z),50),r=this.view._stage.renderView.getMinimalDepthForArea(this.beginCenterScreen[0],this.beginCenterScreen[1],this.view.state.camera,80),o=r?Math.min(r,n):n;$i(s,Ki(e,this.currentCamera.eye,Yi(e,t,o))),this.planeVertical[3]=-es(this.planeVertical,s)}this.computePlanePoints(t.pointers,this.planeVertical,this.startCamera,this.tmpPoints),Wy(this.tmpPoints,this.beginCenter)}else this.computePlanePoints(t.pointers,this.planeHorizontal,this.startCamera,this.tmpPoints),Wy(this.tmpPoints,this.beginCenter);this.constraintOptions.interactionStartCamera.copyFrom(this.startCamera)}update(t){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const e=t.pointers.size>1,i=this.panMode===Zy.Horizontal?this.planeHorizontal:this.planeVertical,s=this.beginCenter;if(e){const e=this.beginRadius/t.radius,i=.001875*Math.min(Math.max(t.radius,40),120);this.scalingValueSmooth.gain=i,this.scalingValueSmooth.update(e),By(this.currentCamera,s,this.scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this.zoomMomentumEstimator.add(this.scalingValueSmooth.value,.001*t.timestamp),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=Yv(Math.abs(t.radius-this.beginRadius)),Qv(this.view,this.currentCamera,this.constraintOptions)}if(this.computePlanePoints(t.pointers,i,this.currentCamera,this.tmpPoints),Wy(this.tmpPoints,this.tmpCentroid3d),Mo(t.center,this.tmpCentroid2d),Jy(this.currentCamera,s,this.tmpCentroid3d),this.panMomentumEstimator.add(this.tmpCentroid2d,this.tmpCentroid3d,.001*t.timestamp),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=Yv(this.beginCenterScreen,this.tmpCentroid2d),Qv(this.view,this.currentCamera,this.constraintOptions),e){const e=this.planeHorizontal,i=s,n=this.rotationValueSmooth.value,r=n+jy(t.angle-n),o=.00125*Math.min(Math.max(t.radius,40),120);this.rotationValueSmooth.gain=o,this.rotationValueSmooth.update(r);const a=this.rotationValueSmooth.value-this.beginAngle;this.rotationMomentumEstimator.add(a,.001*t.timestamp),Ny(this.currentCamera,i,eg(e,a)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=Yv(Math.abs(t.radius*a)),Qv(this.view,this.currentCamera,this.constraintOptions)}}end(t){t.pointers.size===this.pointerCount&&this.update(t),this.finishController();const e=this.zoomMomentumEstimator.evaluateMomentum();if(e)return new yx({view:this.view,momentum:e,zoomCenter:this.beginCenter});const i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new vx({view:this.view,momentum:i,center:this.beginCenter,axis:Wl(this.planeHorizontal)});const s=this.panMomentumEstimator.evaluateMomentum();return s?new dx({view:this.view,momentum:s}):null}computePlanePoints(t,e,i,s){s.length=t.size;const n=this.tmp2d;let r=0;return t.forEach((t=>{n[0]=t.x,n[1]=t.y,void 0===s[r]&&(s[r]=js()),ky(e,i,n,s[r]),r+=1})),s}};r([o({constructOnly:!0})],Tx.prototype,"view",void 0),Tx=r([a("esri.views.3d.state.controllers.local.PinchAndPanController")],Tx);class Ax extends Xo{constructor(t,e,i){super(!0),this.view=t,this.pointerAction=e,this.lastEndTimestamp=0,this.lastTimestamp=0,this.registerIncoming("drag",i,(t=>this.handleDrag(t)))}handleDrag(t){if("mouse"===t.data.pointerType&&!ne(t.data,this.pointerAction))return;const e=this.momentum&&this.momentum.active&&t.timestamp-this.lastEndTimestamp<40;switch(t.data.action){case"start":case"update":if(e)break;this.controller&&this.controller.active?t.data.timestamp-this.lastTimestamp>2&&(this.controller.update(t.data),this.lastTimestamp=t.timestamp):this.startController(t);break;case"end":case"removed":this.endController(t,!0);break;case"added":this.endController(t,!1),this.startController(t)}t.stopPropagation()}endController(t,e){if(this.controller&&this.controller.active){this.lastEndTimestamp=t.timestamp;const i=this.controller.end(t.data);e&&i&&(this.momentum=i,this.view.state.switchCameraController(this.momentum))}this.controller=null}startController(t){this.controller=this.createController(),this.view.state.switchCameraController(this.controller),this.controller.begin(t.data),this.lastTimestamp=t.timestamp}createController(){return this.view.state.isGlobal?new Mx({view:this.view}):new Tx({view:this.view})}}class _x extends Xo{constructor(t,e){super(!0),this.view=t,this.registerIncoming("pointer-down",e,(()=>this.view.state.stopActiveCameraController()))}}class Dx extends Xo{constructor(t,e){super(!0),this.key=t,this.registerIncoming("key-down",e,(t=>this._handleKeyDown(t)))}_handleKeyDown(t){t.data.key===this.key&&(this.activate(),t.stopPropagation())}}class Ox extends Dx{constructor(t,e,i){super(e,i),this.view=t}activate(){this.view.goTo({heading:0}).catch((()=>{}))}}class Rx extends Dx{constructor(t,e,i){super(e,i),this.view=t}activate(){this.view.goTo({tilt:0}).catch((()=>{}))}}class Fx extends Xo{constructor(t,e=!1){super(!0),this.view=t,this.invert=e,this.registerIncoming("vertical-two-finger-drag",(t=>this.handleTwoFinger(t)))}handleTwoFinger(t){var e,i,s;const n=Co(0,t.data.delta*(this.invert?-1:1));switch(t.data.action){case"begin":null==(e=this.cameraController)||e.end(),this.cameraController=new Bw({view:this.view,pivot:0}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(n);break;case"update":null==(i=this.cameraController)||i.update(n);break;case"end":null==(s=this.cameraController)||s.end(),this.cameraController=null}}}class zx extends Xo{constructor(t=20,e=40){super(!1),this._threshold=t,this._maxDelta=e,this.state="ready",this.emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this.dragEventSeparator=new he({start:(t,e)=>this.observeStart(t,e),update:(t,e,i)=>this.observeUpdate(t,e,i),end:(t,e)=>this.observeEnd(e)}),this.registerIncoming("drag",(t=>this.dragEventSeparator.handle(t)))}get failed(){return"failed"===this.state}observeStart(t,e){1===t&&this.emittedArtificalEnd2&&(this.emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:e.data.button,buttons:e.data.buttons,pointerType:e.data.pointerType,timestamp:e.data.timestamp,pointers:e.data.pointers,pointer:e.data.pointer,angle:e.data.angle,radius:e.data.radius,center:e.data.center}),e.stopPropagation()),this.state=2===t?"ready":"failed"}observeUpdate(t,e,i){if("failed"!==this.state&&2===t)return"active"===this.state?(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void e.stopPropagation()):void(this.checkMovementWithinLimits(e.data,i.data)?this.checkVerticalThresholdReached(e.data,i.data)&&(this.state="active",this.emittedArtificalEnd2=!0,this._thresholdReachedCenter=e.data.center,this._artificalDrag.emit({action:"end",button:e.data.button,buttons:e.data.buttons,pointerType:e.data.pointerType,timestamp:e.data.timestamp,pointers:e.data.pointers,pointer:e.data.pointer,angle:e.data.angle,radius:e.data.radius,center:e.data.center}),this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),e.stopPropagation()):this.state="failed")}observeEnd(t){"active"===this.state&&(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this.state="ready",t.stopPropagation())}checkMovementWithinLimits(t,e){let i=-1/0,s=1/0,n=-1/0,r=1/0;e.pointers.forEach((t=>{i=Math.max(i,t.x),s=Math.min(s,t.x),n=Math.max(n,t.y),r=Math.min(r,t.y)}));let o=-1/0,a=1/0,h=-1/0,l=1/0;t.pointers.forEach((t=>{o=Math.max(o,t.x),a=Math.min(a,t.x),h=Math.max(h,t.y),l=Math.min(l,t.y)}));const c=i-s,u=n-r,d=o-a,p=h-l;return Math.abs(t.center.x-e.center.x)<this._threshold&&Math.abs(d-c)<=this._maxDelta&&Math.abs(p-u)<=this._maxDelta}checkVerticalThresholdReached(t,e){let i=Math.abs(t.center.y-e.center.y);return t.pointers.forEach(((t,s)=>{const n=e.pointers.get(s);i=Math.min(i,Math.abs(t.y-n.y))})),i>=this._threshold}}let Lx=class extends T{constructor(){super(...arguments),this._handles=new E}destroy(){this._handles&&(this._handles.removeAll(),this._handles=null),this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(t){"pan"!==t&&"rotate"!==t||t===this._get("primaryDragAction")||(this._set("primaryDragAction",t),this._updateMode())}get mode(){return this._get("mode")}set mode(t){"default"!==t&&"pro"!==t||t===this._get("mode")||(this._set("mode",t),this._updateMode())}disconnect(){this.view.viewEvents.disconnect(),this._inputManager&&(this._inputManager.destroy(),this._inputManager=null),this._source&&(this._source.destroy(),this._source=null)}connect(){const t=this.view;this._source=new le(this.view.surface,t.input);const e=[new ce,new ue,new de,new pe(this.view.navigation),new zx],i=new Ko({eventSource:this._source,recognizers:e});this._inputManager=i,i.installHandlers("prevent-context-menu",[new fe],$o.INTERNAL),this._modeDragPan=new Ax(t,"primary"),this._modeDragRotate=new qw(t,"secondary",0),this._modeDragZoom=new Qw(t,"tertiary");i.installHandlers("navigation",[new _x(t),new Nw(t),new ax(t),new hx(t,{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"}),new lx(t),new Rx(t,"p"),new Ox(t,"n"),new qw(t,"primary",1,["b"]),new qw(t,"secondary",0,["b"]),new Ax(t,"tertiary",["b"]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new Fx(t)],$o.INTERNAL),this.view.viewEvents.connect(i),this._updateMode(),tt(this.view.navigation,"browserTouchPanEnabled",(t=>{this._source.browserTouchPanningEnabled=!t}))}_updateMode(){const t=this.primaryDragAction,e=Ex.get(this.mode).get(t);this._modeDragPan&&(this._modeDragPan.pointerAction=e.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=e.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=e.zoom)}get test(){return{inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}};r([o()],Lx.prototype,"view",void 0),r([o({value:"pan"})],Lx.prototype,"primaryDragAction",null),r([o({value:"default"})],Lx.prototype,"mode",null),r([o({readOnly:!0,aliasOf:"_inputManager.hasPendingInputs"})],Lx.prototype,"hasPendingInputs",void 0),r([o({readOnly:!0,aliasOf:"_inputManager.latestPointerType"})],Lx.prototype,"latestPointerType",void 0),r([o()],Lx.prototype,"_inputManager",void 0),Lx=r([a("esri.views.3d.input.SceneInputManager")],Lx);const Ex=new Map,Ix=new Map,Vx=new Map;Ix.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),Ix.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),Vx.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),Vx.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),Ex.set("default",Ix),Ex.set("pro",Vx);const jx=Lx;let Nx,kx,Bx=!1,Gx=!1,qx=!1,Wx=!1,Ux=null;function Hx(){Ux&&(Ux(),Ux=null)}function Zx(t,e,i,s,n){Hx();const r=Nx.height,o=kx;o.beginPath(),o.lineWidth=1,o.strokeStyle=n,o.moveTo(t,r-i),o.lineTo(e,r-i),o.stroke(),o.lineTo(e,r-s),o.stroke(),o.lineTo(e,r-i),o.stroke(),o.lineTo(t,r-i),o.stroke(),o.lineTo(t,r-i),o.stroke(),o.closePath()}function Qx(t,e){Bx&&(e&&qx||!e&&Wx)&&Zx(t.aabr[0],t.aabr[2],t.aabr[1],t.aabr[3],e?"green":"red")}const Yx=js(),Xx=sa(),Kx=sa(),$x=js(),Jx=gn(),tb=Uo(),eb=Wo(),ib=js(),sb=Ln();class nb{constructor(){this.aabr=Ln(),this.distance=0,this.culled=!1,this.visible=!1}}class rb{constructor(t,e,i={}){this.graphics3DGraphic=t,this.slicePlaneEnabled=e,this.info=i}}class ob{constructor(){this.active=new Map,this.visible=new Map}clear(){this.active.clear(),this.visible.clear()}}class ab{}class hb{constructor(){this.sortArray=new pt({allocator:t=>t||new ab})}}class lb{constructor(){this.camera=new hr,this.slicePlane=Ro(),this.slicePlaneEnabled=!1}copyFrom(t){this.camera.copyFrom(t.camera),Fo(t.slicePlane,this.slicePlane),this.slicePlaneEnabled=t.slicePlaneEnabled}}let cb=class extends T{constructor(){super(...arguments),this._dirty=!1,this._runningViewState=new lb,this._state=0,this.graphics=new ob,this.iterators=new hb,this.accBinsNumX=15,this.accBinsNumY=20,this.accBinsSizeX=0,this.accBinsSizeY=0,this.accBins=null,this.accNumTests=0}get dirty(){return this._dirty}get state(){return this._state}destroy(){this.graphics.clear(),this.iterators=null}setDirty(){!this._dirty&&this.graphics.active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return 0!==this._state||this._dirty}get updatingProgress(){if(!this.updating)return 1;const t=this._state/4;return this._dirty?.5*t:t}get running(){return this.view.ready&&null!=this.view.state&&this.updating}runTask(t){switch(this._state){case 0:this.startUpdate(),t.madeProgress();case 1:if(this._state=1,!this.processActiveGraphics(t))return;case 2:if(this._state=2,!this.sortVisibleGraphics(t))return;case 3:if(this._state=3,!this.deconflictVisibleGraphics(t))return;default:(function(t,e){if(!Gx||!kx)return;Hx();const i=kx;let s=0;for(let e=0;e<t.accBinsNumX;e++)for(let n=0;n<t.accBinsNumY;n++){const r=t.accBins[e][t.accBinsNumY-1-n];s+=r.length;const o=e*t.accBinsSizeX,a=(e+1)*t.accBinsSizeX,h=n*t.accBinsSizeY,l=(n+1)*t.accBinsSizeY;i.fillText(r.length.toFixed(),o+5,h+15),Zx(o,a,h,l,"blue")}i.fillText("total totalShownLabels: "+s,70,40),i.fillText("total visible labels: "+e.size,70,50),i.fillText("total numTests: "+t.accNumTests,70,30)})(this,this.graphics.visible),this._state=0,this.notifyChange("updating")}}modifyGraphics(t,e){t.forEach(e?t=>this.addToActiveGraphics(t):t=>this.removeFromActiveGraphics(t)),this.setDirty()}layerSupportsDeconfliction(t){if(w(t)||"object3d"!==t.type)return!1;const e=t.stageObject;return 1===(e?e.geometryRecords.length:0)&&e.geometryRecords[0].material instanceof cr}startUpdate(){(function(t){qx=lr.DECONFLICTOR_SHOW_VISIBLE,Wx=lr.DECONFLICTOR_SHOW_INVISIBLE,Bx=qx||Wx,Gx=lr.DECONFLICTOR_SHOW_GRID,Ux=null,Bx||Gx?Ux=()=>function(t){null==Nx&&(Nx=document.createElement("canvas"),Nx.setAttribute("id","canvas2d"),t.surface.parentElement.style.position="relative",t.surface.parentElement.appendChild(Nx));const e=t.height*t.pixelRatio;Nx.setAttribute("width",t.width*t.pixelRatio+"px"),Nx.setAttribute("height",`${e}px`),Nx.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${t.width}px;height:${t.height}px`),kx=Nx.getContext("2d"),kx.clearRect(0,0,t.width,t.height),kx.font="12px Arial"}(t):Nx&&(Nx.parentElement.removeChild(Nx),Nx=null)})(this.view),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);const{fullWidth:t,fullHeight:e}=this._runningViewState.camera;this.initBins(t,e),this.resetIterators()}addToActiveGraphics(t){t.info[this.visibilityGroup]=new nb,this.graphics.active.set(t.graphics3DGraphic.graphic.uid,t),this.setDirty()}removeFromActiveGraphics(t){this.removeFromVisibleGraphics(t),function(t,e){const i=t.graphics3DGraphic;i.destroyed||i.clearVisibilityFlag(3,e)}(t,this.visibilityGroup),delete t.info[this.visibilityGroup],this.graphics.active.delete(t.graphics3DGraphic.graphic.uid),this.setDirty()}addToVisibleGraphics(t){this.graphics.visible.set(t.graphics3DGraphic.graphic.uid,t)}removeFromVisibleGraphics(t){this.graphics.visible.delete(t.graphics3DGraphic.graphic.uid)}processActiveGraphics(t){const e=this.ensureActiveGraphicsIterator(),i=so(Jx,this._runningViewState.camera.projectionMatrix),s="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this._runningViewState.camera.relativeElevation>0?tb:null;let n=0;for(p(s)&&(os(s,Bs,this._runningViewState.camera.viewMatrix),s[3]=Qr(this.view.spatialReference).radius,n=Ho(s,Bs));!t.done;){t.madeProgress();const r=e.next();if(r.done)return this.resetActiveGraphicsIterator(),!0;const o=r.value,a=o&&o.info[this.visibilityGroup];a&&(this.collectGraphics3DGraphics(o,i,s,n),a.culled?this.removeFromVisibleGraphics(o):this.addToVisibleGraphics(o))}return!1}sortVisibleGraphics(t){const e=this.ensureSortGraphicsIterator();for(;!t.done;){const i=e.next();if(t.madeProgress(),i.done)return this.resetSortGraphicsIterator(),!0}return!1}deconflictVisibleGraphics(t){const e=this.ensureVisibleGraphicsIterator(),i=1===this.visibilityGroup;for(;!t.done;){t.madeProgress();const s=e.next();if(s.done)return this.resetVisibleGraphicsIterator(),!0;const n=s.value,r=n.info[this.visibilityGroup];if(!r||r.culled)continue;const o=n.graphics3DGraphic,a=(!i||o.isVisible())&&!this.isConflicted(n);a&&this.addToBins(n),r.visible=a,this.setGraphicVisibility(n,a),Qx(r,a)}return!1}resetIterators(){this.iterators.active=null,this.iterators.visible=null,this.iterators.sort=null}ensureActiveGraphicsIterator(){return this.iterators.active||(this.iterators.active=ub(this.graphics.active)),this.iterators.active}resetActiveGraphicsIterator(){this.iterators.active=null}ensureVisibleGraphicsIterator(){return this.iterators.visible||(this.iterators.visible=ub(this.graphics.visible)),this.iterators.visible}resetVisibleGraphicsIterator(){this.iterators.visible=null}ensureSortGraphicsIterator(){return this.iterators.sort||(this.iterators.sort=function*(t,e,i){e.clear(),t.forEach(((t,s)=>{const n=e.pushNew();n.id=s,n.prio=t.info?-t.info[i].distance:Number.MAX_VALUE})),yield;const s=e.iterableSort(((t,e)=>e.prio-t.prio));for(let t=s.next();!t.done;t=s.next())yield;e.forAll((e=>{const i=t.get(e.id);i&&(t.delete(e.id),t.set(e.id,i))})),e.clear()}(this.graphics.visible,this.iterators.sortArray,this.visibilityGroup)),this.iterators.sort}resetSortGraphicsIterator(){this.iterators.sort=null}collectGraphics3DGraphics(t,e,i,s){const n=t.graphics3DGraphic;if(n.destroyed)return;const r=t.info[this.visibilityGroup];if(!n.isVisible(0,3))return void(r.culled=!0);const o=this.getGraphicsLayers(n);In(r.aabr);let a=null;for(const n of o){if(!this.layerSupportsDeconfliction(n))continue;const o=n.stageObject.geometryRecords[0].material;if(w(a)){if(a=this.getProjectionInfo(n,e,pb),a.isOutsideScreen||this.isCulledBySlice(t,Yx)||p(i)&&this.isCulledByHorizon(a,i,s))return void(r.culled=!0);!lr.TESTS_DISABLE_OPTIMIZATIONS&&r.visible&&(a.distance*=.7)}this.expandBoundingRect(r,n,o,a)}w(a)?r.culled=!0:(r.distance=a.distance,r.culled=!1)}getProjectionInfo(t,e,i){const s=this._runningViewState.camera,n=t.stageObject,r=n.geometryRecords[0],o=r.material,a=Zo(n.boundingVolumeWorldSpace.bounds);os(Yx,a,s.viewMatrix);const h=r.geometry.vertexAttributes,l=h.get("normal").data,c=h.get("auxpos1").data;return o.applyShaderOffsetsView(Yx,l,n.transformation,c,s,i.scaleInfo,Yx),ms(Xx,Yx[0],Yx[1],Yx[2],1),bs(Kx,Xx,s.projectionMatrix),Yi(i.positionNDC,Kx,1/Kx[3]),o.applyShaderOffsetsNDC(i.positionNDC,c,s,i.positionNDC,$x),i.distanceWithoutPolygonOffset=s.depthNDCToWorld($x[2]),i.distance=$x[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:s.depthNDCToWorld(i.positionNDC[2]),ms(Kx,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),bs(Xx,Kx,e),Cs(Xx,Xx,1/Xx[3]),ds(i.positionView,Yx[0],Yx[1],Yx[2]),i}isCulledByHorizon(t,e,i){return $i(eb.direction,t.positionView),ds(eb.origin,0,0,0),!!ko(e,eb,ib)&&t.distanceWithoutPolygonOffset>i}isCulledBySlice(t,e){return t.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&Oo(this._runningViewState.slicePlane,e)}expandBoundingRect(t,e,i,{positionNDC:s,scaleInfo:n}){const r=this._runningViewState.camera,o=e.getScreenSize(db);oh(o,n.factor,o),o[0]*=r.pixelRatio,o[1]*=r.pixelRatio;const a=Vn(i.calculateRelativeScreenBounds(o,n.factorAlignment.scale,sb),ys(0,r.fullWidth,.5+.5*s[0]),ys(0,r.fullHeight,.5+.5*s[1])),h=this.iconMarginFactor;if(0!==h){const t=h*Math.min(kn(a),Bn(a));a[0]-=t,a[1]-=t,a[2]+=t,a[3]+=t}jn(t.aabr,a,t.aabr)}isConflicted(t){const e=t.graphics3DGraphic.graphic.uid,i=t.info[this.visibilityGroup];for(let t=Math.floor(i.aabr[0]/this.accBinsSizeX);t<=Math.floor(i.aabr[2]/this.accBinsSizeX);t++)if(!(t<0||t>=this.accBinsNumX))for(let s=Math.floor(i.aabr[1]/this.accBinsSizeY);s<=Math.floor(i.aabr[3]/this.accBinsSizeY);s++){if(s<0||s>=this.accBinsNumY)continue;const n=this.accBins[t][s];for(let t=0;t<n.length;t++){const s=n.data[t],r=s.info[this.visibilityGroup];if(r&&r.visible&&s.graphics3DGraphic.graphic.uid!==e&&(this.accNumTests++,Nn(r.aabr,i.aabr)))return!0}}return!1}initBins(t,e){if(null==this.accBins){this.accBins=[];for(let t=0;t<this.accBinsNumX;t++){this.accBins.push([]);const t=this.accBins[this.accBins.length-1];for(let e=0;e<this.accBinsNumY;e++)t.push(new pt)}}else for(let t=0;t<this.accBinsNumX;t++)for(let e=0;e<this.accBinsNumY;e++)this.accBins[t][e].clear();this.accBinsSizeX=t/this.accBinsNumX,this.accBinsSizeY=e/this.accBinsNumY,this.accNumTests=0}addToBins(t){const e=t.info[this.visibilityGroup],i=Math.floor(e.aabr[0]/this.accBinsSizeX),s=Math.floor(e.aabr[2]/this.accBinsSizeX),n=Math.floor(e.aabr[1]/this.accBinsSizeY),r=Math.floor(e.aabr[3]/this.accBinsSizeY);for(let e=i;e<=s;e++)if(!(e<0||e>=this.accBinsNumX))for(let i=n;i<=r;i++)i<0||i>=this.accBinsNumY||this.accBins[e][i].push(t)}setGraphicVisibility(t,e){const i=t.graphics3DGraphic;i.destroyed||(i.setVisibilityFlag(3,e,this.visibilityGroup),1===this.visibilityGroup&&this.view.labeler.setLabelGraphicVisibility(i,e))}};function*ub(t){if(Map.prototype.entries){const e=t.entries();for(let t=e.next();!t.done;t=e.next())yield t.value[1]}else yield*t.values()}r([o({constructOnly:!0})],cb.prototype,"view",void 0),r([o({type:Boolean,readOnly:!0})],cb.prototype,"updating",null),cb=r([a("esri.views.3d.layers.graphics.Deconflictor")],cb);const db=Sa(),pb=new class{constructor(){this.positionView=js(),this.positionNDC=js(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}}}get isOutsideScreen(){const t=this.positionNDC;return t[0]<-1||t[1]<-1||t[2]<-1||t[0]>=1||t[1]>=1}};let fb=class extends cb{constructor(){super(...arguments),this.visibilityGroup=1,this.iconMarginFactor=0,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(t){if(this.parent.running)return;const e=performance.now();(2===t.state||e-this._lastDeconfliction>2e3)&&(super.runTask(t),0===this.state&&(this._lastDeconfliction=e))}enabledChanged(t,e){this.modifyGraphics(e,t.labelsEnabled)}getGraphicsLayers(t){return t.labelGraphics}};r([o({constructOnly:!0})],fb.prototype,"parent",void 0),fb=r([a("esri.views.3d.layers.graphics.LabelDeconflictor")],fb);let gb=class extends cb{constructor(){super(...arguments),this._handles=new E,this._contexts=new Map,this._viewState=new lb,this.visibilityGroup=0,this._iconMarginFactor=-.1}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._handles.add([this.view.watch("state.camera",(()=>{this.updateViewState(),this.setDirty()})),this.view.watch("map.ground.opacity",((t,e)=>{1!==t&&1!==e||this.setDirty()})),tt(this.view,"slicePlane",(()=>{this.updateSlicePlane(),this.slicePlaneChanged()}))]),this._frameTask=this.view.resourceController.scheduler.registerTask(po.GRAPHICS_DECONFLICTOR,this),this._labels=new fb({view:this.view,parent:this})}destroy(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null)}get iconMarginFactor(){return this._iconMarginFactor}set iconMarginFactor(t){this._iconMarginFactor=t,this.setDirty()}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(t){super.runTask(t),this.running||this._labels.setDirty()}setInitialIconVisibilityFlag(t,e){const i=!(this._graphicSupportsDeconfliction(e)&&mb(t));e.setVisibilityFlag(3,i,0)}updateViewState(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this.updateSlicePlane())}updateSlicePlane(){const t=this.view?this.view.slicePlane:null;p(t)&&zo(t,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=p(t)}slicePlaneChanged(){ft(this._contexts,((t,e)=>e.symbolCreationContext.slicePlaneEnabled))&&this.setDirty()}addGraphicsOwner(t){let e=this._contexts.get(t);return null==e&&(e=new Map,this._contexts.set(t,e),this.setDirty()),{addGraphic:i=>this.addGraphic(t,e,i),removeGraphic:t=>this.removeGraphic(e,t),labelingInfoChange:()=>this._labels.enabledChanged(t,e),featureReductionChange:()=>this.enabledChanged(t,e),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(t,e),clear:()=>e.forEach((t=>this.removeGraphic(e,t.graphics3DGraphic)))}}removeGraphicsOwner(t){const e=this._contexts.get(t);e&&(e.forEach((t=>this.removeGraphic(e,t.graphics3DGraphic))),this._contexts.delete(t),this.setDirty())}addGraphic(t,e,i){const s=i.graphic.uid,n=new rb(i,t.symbolCreationContext.slicePlaneEnabled);e.set(s,n),mb(t)&&this.addToActiveGraphics(n),t.labelsEnabled&&this._labels.addToActiveGraphics(n)}removeGraphic(t,e){const i=e.graphic.uid,s=t.get(i);s&&(this.removeFromActiveGraphics(s),this._labels.removeFromActiveGraphics(s),t.delete(i),this.setDirty())}enabledChanged(t,e){const i=mb(t);i||function(t){const e=t.graphics3DGraphics;e&&e.forEach((t=>t.clearVisibilityFlag(3)))}(t),this.modifyGraphics(e,i)}_slicePlaneEnabledChanged(t,e){const i=t.symbolCreationContext.slicePlaneEnabled;e.forEach((t=>t.slicePlaneEnabled=i)),this.setDirty()}getGraphicsLayers(t){return t.graphics}_graphicSupportsDeconfliction(t){if(t.isDraped)return!1;const e=t.graphics;if(!e||!e.length)return!1;for(const t of e)if(this.layerSupportsDeconfliction(t))return!0;return!1}};function mb(t){const e=t.layer;return!(!e||!e.featureReduction||"selection"!==e.featureReduction.type)}function vb(t){return t instanceof Al?t.graphics3DSymbol:t instanceof _l?t:null}gb=r([a("esri.views.3d.layers.graphics.GraphicsDeconflictor")],gb);const yb=y.getLogger("esri.views.3d.layers.graphics.labelPlacement");function wb(t){const e=function(t){const e=t.labelClass.labelPlacement,{labelSymbol:i,graphics3DGraphic:s}=t,n=vb(s.graphics3DSymbol),r=p(n)?n.symbol:null,o=Pb[e]||Cb(t);return"point-3d"===r.type&&r.supportsCallout()&&r.hasVisibleVerticalOffset()&&!s.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:Sb(r.verticalOffset),anchor:null,normalizedOffset:null}:!i||!i.hasVisibleVerticalOffset()||"point-3d"===r.type&&r.supportsCallout()&&r.verticalOffset&&!s.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:function(t){return"above-center"===t}(o.placement)?{placement:"above-center",verticalOffset:Sb(i.verticalOffset),anchor:"bottom",normalizedOffset:[0,o.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(yb.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+e+" placement)"),null)}(t);if(w(e))return null;const i=function(t,e){if(e.anchor)return e;const i=t.labelClass.labelPlacement,s=Pb[i],n=s||Cb(t);return i&&!s&&yb.warnOncePerTick(`the requested label placement '${i}' is not currently supported in SceneView`),function(t,e){const i=e.graphics3DGraphic.graphic.geometry;if(w(i))return null;if(p(e.disablePlacement))return e.labelClass.labelPlacement?(yb.warnOncePerTick(bb(t.placement,e.disablePlacement.logEntityDescription)),Cb(e)):t;const s=i.type;switch(s){case"polyline":case"polygon":case"extent":case"multipoint":if(e.labelClass.labelPlacement)return yb.warnOncePerTick(bb(t.placement,`'${s}' geometries`)),Cb(e);break;case"point":case"mesh":return t}return t}(n,t)}(t,e);if(w(i))return null;const s=!!e.hasLabelVerticalOffset;return function(t,e,i){const s=i.graphics3DGraphic.graphic.geometry;if(w(s))return null;switch(s.type){case"point":!function(t,e,i){const s=xb(i);if(w(s))return;const n=i.graphics3DGraphic.graphics[0];switch(p(n)?n.getCenterObjectSpace(t.translation):ds(t.translation,0,0,0),s.type){case"icon":case"text":!function(t,e,i,s){const{graphics3DGraphic:n}=i,r=p(s)?s.getScreenSize():null;if(!n.isDraped&&p(r)){const s=function(t,e=_b){const{graphics3DGraphic:i}=t,s=i.graphics[0],n=p(s)?s.stageObject.geometryRecords[0].material:null;if(n&&n instanceof cr){const t=n.parameters.anchorPos;e[0]=2*(t[0]-.5),e[1]=2*(t[1]-.5)}else e[0]=0,e[1]=0;return e}(i);Ab[0]=r[0]/2*(e.normalizedOffset[0]-s[0]),Ab[1]=r[1]/2*(e.normalizedOffset[1]-s[1]),t.screenOffset[0]=Ab[0],t.hasLabelVerticalOffset?(t.centerOffset[1]=Ab[1],t.centerOffsetUnits="screen"):t.screenOffset[1]=Ab[1]}else t.hasLabelVerticalOffset||"center"===t.anchor||(Pb[i.labelClass.labelPlacement]&&yb.warnOncePerTick(`the requested placement '${e.placement}' is currently unsupported for draped graphics`),t.anchor="center")}(t,e,i,n);break;case"object":Mb(t,e,n)}}(t,e,i);break;case"polygon":!function(t,e,i){const s=xb(i);if(!w(s))switch(s.type){case"extrude":{const s=i.graphics3DGraphic.graphics[0];p(s)?(s.getBoundingBoxObjectSpace(Db),wn(Db,t.translation),t.translation[2]=Tn(Db)/2):ds(t.translation,0,0,0),Mb(t,e,s);break}}}(t,e,i);break;case"mesh":Mb(t,e,i.graphics3DGraphic.graphics[0])}return t}({anchor:i.anchor,verticalOffset:e.verticalOffset,screenOffset:Sa(),centerOffset:na(0,0,0,-1),centerOffsetUnits:"world",translation:js(),elevationOffset:0,hasLabelVerticalOffset:s},i,t)}function xb(t){const e=vb(t.graphics3DGraphic.graphics3DSymbol);return p(e)?e.symbol.symbolLayers.getItemAt(0):null}function bb(t,e){return`the requested label placement '${t}' is currently unsupported for ${e} in SceneView`}function Cb(t){const e=t.graphics3DGraphic.graphic.geometry;if(w(e))return null;switch(e.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const e=xb(t);return p(e)&&"extrude"===e.type?Pb["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return Pb["above-center"];default:return}}function Mb(t,e,i){const s=p(i)?i.getBoundingBoxObjectSpace(Db):Db,n=Ns(s[3]-s[0],s[4]-s[1],s[5]-s[2]),r=Math.sqrt(n[0]*n[0]+n[1]*n[1]);t.centerOffset[0]=r/2*e.normalizedOffset[0];const o=t.translation[2],a=n[2]/2*e.normalizedOffset[1];t.translation[2]=0,t.elevationOffset=o+a;const h=Xi(n);t.centerOffset[2]=h/2*e.normalizedOffset[2]}function Sb(t){const{screenLength:e,minWorldLength:i,maxWorldLength:s}=t;return{screenLength:e,minWorldLength:i,maxWorldLength:s}}const Pb={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},Tb={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const t in Tb){const e=Pb[t];Tb[t].forEach((t=>{Pb[t]=e}))}Object.freeze&&(Object.freeze(Pb),Object.keys(Pb).forEach((function(t){Object.freeze(Pb[t]),Object.freeze(Pb[t].normalizedOffset)})));const Ab=[0,0],_b=[0,0],Db=Sn();class Ob{constructor(t){this._stage=t,this._materials=new Map}get(t){return this._materials.get(t)}add(t,e){this._materials.set(t,e),this._stage.add(e)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}}var Rb;let Fb=Rb=class extends T{constructor(t){super(t),this.type=4,this.id=gt(),this.events=new G,this._glTexture=null,this.needsClear=!1,this.elementsToAddOrUpdate=new Map,this.elementsToRemove=new Map,this.elementsToRender=new Map,this.elements=new Map,this.stageObjects=new Map,this.updating=!1}initialize(){this.stage=this.view._stage,this.canvas=this.create2DCanvas(),this.ctx=this.canvas.getContext("2d"),this.stage.add(this);const t=this.computeAtlasResolution(this.view.width,this.view.height);this.createAtlasRegion(t),this.update2DCanvasSize(),this.resetAtlasCursor()}unload(){this._glTexture=Q(this._glTexture),this.updating=!1,this.events.emit("unloaded")}get width(){return this.atlas.size.width}get height(){return this.atlas.size.height}get requiresFrameUpdates(){return!1}createDescriptor(t){return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,flipped:!0,samplingMode:9987,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:t.parameters.maxMaxAnisotropy}}get glTexture(){return this._glTexture}load(t){return p(this._glTexture)||(this._glTexture=new ml(t,this.createDescriptor(t),this.canvas),this.frameWorker=this.view.resourceController.scheduler.registerTask(po.TEXT_TEXTURE_ATLAS,this),this.setDirty()),this._glTexture}dispose(){this.elements=null,this.elementsToAddOrUpdate=null,this.elementsToRemove=null,this.elementsToRender=null,this.frameWorker=J(this.frameWorker),this._glTexture&&(this.stage.remove(this),this._glTexture=Q(this._glTexture)),this.canvas.width=0,this.canvas.height=0,this.canvas=null,this.ctx=null}create2DCanvas(){const t=document.createElement("canvas");return t.setAttribute("id","canvas2d"),t.setAttribute("style","display:none"),t.setAttribute("width",512..toString()),t.setAttribute("height",512..toString()),t}update2DCanvasSize(){this.canvas.setAttribute("width",this.atlas.size.width.toString()),this.canvas.setAttribute("height",this.atlas.size.height.toString())}createAtlasRegion(t=512){this.atlas={size:{width:t,height:t},cursor:{x:0,y:0},lineHeight:0}}computeAtlasResolution(t,e){let i=Math.max(t,e);return i+=256,i=Ms(i),i=Math.min(i,4096),i}resizeAtlas(t,e){e=e||t;const i=this.atlas;i.size.width=t,i.size.height=e,p(this._glTexture)&&this._glTexture.resize(t,e),this.update2DCanvasSize()}resetAtlasCursor(){const t=this.atlas;t.cursor.x=zb,t.cursor.y=zb+Lb,t.lineHeight=0,this.needsClear=!0}getAtlasUsage(){const t=this.atlas;return(t.cursor.x+t.cursor.y*t.size.width)/(t.size.width*t.size.height)}getExpectedAtlasUsage(){const t=this.elementsToRemove.size,e=this.elementsToAddOrUpdate.size,i=this.elements.size;return this.getAtlasUsage()/i*(i+e-t)}addAtlasElement(t,e,i,s){const n=this.atlas,{renderedWidth:r,renderedHeight:o,displayWidth:a,displayHeight:h}=t.textRenderer;t.placement.offset.x=n.cursor.x,t.placement.offset.y=n.cursor.y,t.placement.size.width=r,t.placement.size.height=o,t.placement.size.displayWidth=a,t.placement.size.displayHeight=h,t.placement.uvMinMax=[t.placement.offset.x/n.size.width,1-(t.placement.offset.y+o)/n.size.height,(t.placement.offset.x+r)/n.size.width,1-t.placement.offset.y/n.size.height],n.cursor.x+=i,n.lineHeight=Math.max(n.lineHeight,s),this.elements.set(e,t)}removeAtlasElement(t){if(t&&this.elements.has(t.textId)){const e=t.placement.offset,i=t.placement.size;this.ctx.clearRect(e.x,e.y,i.width,i.height),this.elements.delete(t.textId)}}ensureStageObjects(t){const e=this.stageObjects.get(t);if(e)return e;const i=new Set;return this.stageObjects.set(t,i),i}addStageObject(t,e){this.ensureStageObjects(t).add(e)}removeStageObject(t,e){const i=this.stageObjects.get(t);i&&i.delete(e)&&(e.geometries[0].vertexAttributes.get("size").data=[0,0],e.geometryVertexAttrsUpdated(e.geometryRecords[0]))}_processAddition(t,e){const i=this.atlas,s=t.textId,n=t.textRenderer.renderedWidth+zb,r=t.textRenderer.renderedHeight+zb+Lb;if(i.cursor.x+n<i.size.width&&i.cursor.y+r<i.size.height)this.addAtlasElement(t,s,n,r),this.elementsToRender.set(s,t),this.elementsToAddOrUpdate.delete(s);else{if(!(i.cursor.y+r+i.lineHeight<i.size.height)){const t=this.getExpectedAtlasUsage(),s=t>.85&&i.size.width<4096;return s&&this.resizeAtlas(2*i.size.width,2*i.size.height),!e||!s&&t>.95&&4096===i.size.width?(this.processRemovals(),0):(this.repack(),1)}i.cursor.x=zb,i.cursor.y+=i.lineHeight,i.lineHeight=0,this.addAtlasElement(t,s,n,r),this.elementsToRender.set(s,t),this.elementsToAddOrUpdate.delete(s)}return 0}processRemovals(){this.elementsToRemove.forEach(((t,e)=>{const i=this.stageObjects.get(e);i&&0!==i.size||this.removeAtlasElement(t),i&&0===i.size&&this.stageObjects.delete(e)})),this.elementsToRemove.clear()}repack(){this.processRemovals(),this.elements.forEach(((t,e)=>{t.rendered=!1,this.elementsToAddOrUpdate.set(e,t)})),this.elements.clear(),this.resetAtlasCursor(),this.elementsToRender.clear()}processRenderingRequest(t){this.ctx.clearRect(t.placement.offset.x,t.placement.offset.y,t.placement.size.width,t.placement.size.height),t.textRenderer.render(this.ctx,t.placement.offset.x,t.placement.offset.y);const e=this.stageObjects.get(t.textId);e&&e.forEach((e=>{e.geometries[0].vertexAttributes.get("uv0").data=new Float32Array(t.placement.uvMinMax),e.geometries[0].vertexAttributes.get("size").data=[t.placement.size.displayWidth,t.placement.size.displayHeight],e.geometryVertexAttrsUpdated(e.geometryRecords[0])})),t.rendered=!0}get running(){return this.updating}runTask(t,e=!0){if(!this._glTexture)return;let i=!1;if(ft(this.elementsToAddOrUpdate,((t,s)=>{const n=this.elements.get(s);if(n&&n.rendered){const t=this.stageObjects.get(s);return t&&t.forEach((t=>{const e=t.geometries[0].vertexAttributes,i=this.elements.get(s);e.get("uv0").data=new Float32Array(i.placement.uvMinMax),e.get("size").data=new Float32Array([i.placement.size.displayWidth,i.placement.size.displayHeight]),t.geometryVertexAttrsUpdated(t.geometryRecords[0])})),this.elementsToAddOrUpdate.delete(s),!1}return 1===this._processAddition(this.elementsToAddOrUpdate.get(s),e)&&(i=!0,!0)})),i)return void this.runTask(fo,!1);let s=!1;this.elementsToRender.size>0&&this.needsClear&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.needsClear=!1),ft(this.elementsToRender,((e,i)=>(this.processRenderingRequest(e),this.elementsToRender.delete(i),s=!0,t.madeProgress(),t.done))),s&&p(this._glTexture)&&this._glTexture.setData(this.canvas),this.updating=this.elementsToRender.size>0,!this.updating&&Rb.test.orderedRepackingEnabled&&this.repackOrdered()}addTextTexture(t,e){const i=t.key;this.elementsToAddOrUpdate.has(i)||this.elementsToAddOrUpdate.set(i,{textId:i,placement:{offset:{x:0,y:0},size:{width:0,height:0,displayWidth:0,displayHeight:0},uvMinMax:[]},textRenderer:t,rendered:!1}),this.addStageObject(i,e),this.elementsToRemove.delete(i),this.setDirty()}removeTextTexture(t,e){const i=t.key;this.elementsToRemove.set(i,this.elements.get(i)),this.removeStageObject(i,e)}setDirty(){this._glTexture&&(this.updating=!0)}repackOrdered(){if(0===this.elements.size)return;const t=[];this.elements.forEach(((e,i)=>t.push({element:e,key:i})));let e=!0;for(let i=0;i<t.length-1;i++)if(t[i].key.localeCompare(t[i+1].key)>0){e=!1;break}if(!e||this.elementsToRemove.size){t.sort(((t,e)=>t.key.localeCompare(e.key))),this.elements.clear();for(const{element:e,key:i}of t)this.elements.set(i,e);this.repack(),this.setDirty()}}get test(){const{elements:t,stageObjects:e,elementsToRemove:i,atlas:s}=this,n=this;return{elements:t,stageObjects:e,elementsToRemove:i,atlas:s,resizeAtlas:(t,e)=>n.resizeAtlas(t,e),run:(t,e)=>n.runTask(t,e)}}};Fb.test={orderedRepackingEnabled:!1},r([o({constructOnly:!0})],Fb.prototype,"view",void 0),r([o({type:Boolean})],Fb.prototype,"updating",void 0),Fb=Rb=r([a("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],Fb);const zb=2,Lb=2,Eb=Fb,Ib=y.getLogger("esri.views.3d.layers.graphics.Labeler");let Vb=class extends T{constructor(){super(...arguments),this._dirty=!1,this._labels=new Map,this._labelsToAdd=new Map,this._labelsToRemove=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this._handles=new E,this._handles.add([this.view.watch("state.camera",(()=>this.setDirty())),this.view.watch("pixelRatio",(()=>this._resetAllLabels())),this.view.resourceController.scheduler.registerTask(po.LABELER,this)]),this._textTextureAtlas=new Eb({view:this.view}),this._hudMaterialCollection=new Ob(this.view._stage),this._calloutMaterialCollection=new Ob(this.view._stage)}dispose(){this._handles=Y(this._handles),this._textTextureAtlas=Q(this._textTextureAtlas),this._hudMaterialCollection=Q(this._hudMaterialCollection),this._calloutMaterialCollection=Q(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear()}_activateLabelingContext(t){t.labels.forEach(((t,e)=>{this._labels.set(e,t),t.graphics3DGraphic.setVisibilityFlag(0,!0,1)})),t.active=!0}_deactivateLabelingContext(t){t.labels.forEach(((t,e)=>{t.graphics3DGraphic.setVisibilityFlag(0,!1,1),this.setLabelGraphicVisibility(t.graphics3DGraphic,!1),this._labels.delete(e)})),t.active=!1}_addLabelTextureToAtlas(t){for(const e of t.graphics3DGraphic.labelGraphics){if(!e._labelClass)continue;const i=t.textRenderers[e._labelIndex];i&&this._textTextureAtlas.addTextTexture(i,e.stageObject)}t.rendered=!0}_removeLabelTextureFromAtlas(t){for(const e of t.graphics3DGraphic.labelGraphics){if(!e._labelClass)continue;const i=t.textRenderers[e._labelIndex];i&&this._textTextureAtlas.removeTextTexture(i,e.stageObject)}t.rendered=!1}get running(){var t;return!!this.view.ready&&(this._dirty||(null==(t=this._textTextureAtlas)?void 0:t.updating)||this.deconflictor.running)}runTask(t){this._updateLabels(t),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(t)}_updateLabels(t){if(this._dirty){this._dirty=!1;for(const e of this._labelingContexts)if(jb(e)){if(!kb(e)){if(Bb(e)){this._deactivateLabelingContext(e);continue}if(this._createLabelClassContext(e),Nb(e)){this._dirty=!0;continue}if(!kb(e))continue}ft(e.labelsToInitialize,((i,s)=>(this._ensureGraphics3DResources(i)&&(this._labels.set(s,i),this.deconflictor.setDirty(),t.madeProgress()),(i.visible&&i.hasTextTextureResources||!i.visible&&i.hasGraphics3DResources)&&(e.labelsToInitialize.delete(s),t.madeProgress()),t.done)))&&(this._dirty=!0)}this._labelsToRemove.forEach((t=>this._removeLabelTextureFromAtlas(t))),this._labelsToAdd.forEach((t=>this._addLabelTextureToAtlas(t))),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(t){const e=t.labelClassAbortController.signal;await t.layer.when(),mt(e),t.scaleVisibility&&t.scaleVisibility.updateScaleRangeActive();const i=t.graphics3DCore,s=i.layer,n=s.labelingInfo&&s.labelingInfo.filter((t=>!!t.symbol));if(!n||0===n.length)return;const r=new Array(n.length);let o=!1;await Qi(n,(async(s,n)=>{const a=s.symbol,h=vb(i.getOrCreateGraphics3DSymbol(a));if(w(h))return void Ib.error("Failed to create Graphics3DSymbol for label");await h.load(),mt(e);let l=null;Gi(a)&&a.hasVisibleCallout()&&(l=Fl(a,i.symbolCreationContext),await l.load(),mt(e));const c=await Zi(hc(s,t.layer.fieldsIndex,this.view.spatialReference));mt(e),!0===c.ok?r[n]={labelClass:s,labelFunction:c.value,graphics3DSymbol:h,graphics3DCalloutSymbolLayer:l,calloutSymbolLayerIndex:0,textRenderParameters:this._createTextRenderParameters(h.symbol)}:(Ib.error(`Label expression failed to evaluate: ${c.error}`),o=!0)})),mt(e),o||(t.labelClassContexts=r)}async _createLabelClassContext(t){return t.labelClassPromise||(t.labelClassPromise=this._createLabelClassContextAsync(t).catch((e=>{if(F(e))throw e;t.labelClassContexts=null})).then((()=>{t.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),t.labelClassPromise}_createTextRenderParameters(t){const e=t.symbolLayers.getItemAt(0);return e&&"text"===e.type?Dl.fromSymbol(e,this.view.pixelRatio):null}_destroyLabelClassContext(t){for(const e of t.labelClassContexts)--e.graphics3DSymbol.referenced,e.graphics3DSymbol=null;const e=t.labelClassAbortController;t.labelClassAbortController=new AbortController,e&&e.abort(),t.labelClassContexts=[],t.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(t,e,i,s,n){const r={text:t.text,centerOffset:i.centerOffset,translation:i.translation,elevationOffset:i.elevationOffset,screenOffset:i.screenOffset,anchor:i.anchor,centerOffsetUnits:i.centerOffsetUnits,verticalOffset:i.verticalOffset,debugDrawBorder:lr.LABELS_SHOW_BORDER,displayWidth:t.displayWidth,displayHeight:t.displayHeight};return Gb.graphic=e,Gb.renderingInfo=null,Gb.layer=s,n.createLabel(Gb,r,this._hudMaterialCollection,this._textTextureAtlas)}_createLineCalloutGraphic(t,e,i,s,n){const r={symbol:e,translation:s.translation,elevationOffset:s.elevationOffset,screenOffset:s.screenOffset,centerOffset:s.centerOffset,centerOffsetUnits:s.centerOffsetUnits,materialCollection:this._calloutMaterialCollection};return Gb.graphic=t,Gb.renderingInfo=r,Gb.layer=n,i.createGraphics3DGraphic(Gb)}_ensureGraphics3DResources(t){if(t.hasGraphics3DResources)return!1;const e=t.graphics3DGraphic;if(e.destroyed)return!1;this._ensureTextTextureResources(t);const i=t.labelingContext,s=i.labelClassContexts;if(!s||0===s.length||!i.emptySymbolLabelSupported&&0===e.graphics.length)return!1;let n=!1;const r=e.graphic,o=i.layer,a=ii(i.layer),h=this.view._stage;for(let l=0;l<s.length;l++){const c=t.textRenderers[l];if(!c)continue;const u=s[l],d=u.graphics3DSymbol;let p=null;d.symbol&&"label-3d"===d.symbol.type&&(p=d.symbol);const f=d.symbolLayers[0];if(!f)continue;const g=u.labelClass,m=wb({graphics3DGraphic:e,labelSymbol:p,labelClass:g,disablePlacement:i.disablePlacement});if(w(m))continue;f.setElevationInfoOverride(i.elevationInfoOverride);const v=this._createTextSymbolGraphic(c,r,m,o,f);if(!v)return!1;v._labelClass=g,v._labelIndex=l,e.addLabelGraphic(v,h,i.stageLayer),e.setVisibilityFlag(0,a,1),e.clearVisibilityFlag(1,1),e.setVisibilityFlag(3,!1,1),n=!0;const y=u.graphics3DCalloutSymbolLayer;if(y&&m.hasLabelVerticalOffset){y.setElevationInfoOverride(i.elevationInfoOverride);const t=this._createLineCalloutGraphic(r,p,y,m,o);t&&(u.calloutSymbolLayerIndex=e.labelGraphics.length,e.addLabelGraphic(t,h,i.stageLayer))}break}return i.scaleVisibility&&n&&i.scaleVisibility.updateGraphicLabelScaleVisibility(e),t.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(t){const e=t.labelingContext.labelClassContexts;for(const i of t.graphics3DGraphic.labelGraphics){if(null==i._labelClass)continue;const t=e[i._labelIndex].graphics3DSymbol.symbolLayers[0];null!=t&&t.onRemoveGraphic(i)}t.graphics3DGraphic.clearLabelGraphics(),t.hasGraphics3DResources=!1}_ensureTextTextureResources(t){if(t.hasTextTextureResources)return;const e=t.labelingContext,i=e.labelClassContexts;if(!i||0===i.length)return;const s=t.graphics3DGraphic.graphic;for(let n=0;n<i.length;n++){const r=i[n];if(t.textRenderers[n]=null,!r.textRenderParameters)continue;const o=r.labelFunction;let a;if("arcade"===o.type)try{const t=o.needsHydrationToEvaluate()?ur(s,e.layer):s;a=o.evaluate(t)}catch(t){a=null}else a=o.evaluate(s);w(a)||""===a||/^\s+$/.test(a)||(t.textRenderers[n]=new Ol(a,r.textRenderParameters))}t.hasTextTextureResources=!0}_destroyTextTextureResources(t){t.textRenderers=[],t.hasTextTextureResources=!1}_addGraphic(t,e){const i={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:t,graphics3DGraphic:e,textRenderers:[]},s=e.graphic.uid;t.labels.set(s,i),t.labelsToInitialize.set(s,i),this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(t,e){const i=e.graphic.uid,s=t.labels.get(i);s&&(this._destroyGraphic(s,i),t.labels.delete(i),t.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(t,e){this._labels.has(e)&&(this._labels.delete(e),this._labelsToAdd.delete(e),this._labelsToRemove.delete(e)),t.hasTextTextureResources&&(this._removeLabelTextureFromAtlas(t),this._destroyTextTextureResources(t)),t.hasGraphics3DResources&&this._destroyGraphics3DResources(t)}async _labelingInfoChange(t,e){if(!e)return this._visibilityInfoChange(t),this._resetLabels(t),this._createLabelClassContext(t);for(const i of e){const e=t.labels.get(i);e&&(this._removeGraphic(t,e.graphics3DGraphic),this._addGraphic(t,e.graphics3DGraphic))}}_globalPropertyChanged(t,e){for(const i of e.labelClassContexts){const s=new Map;e.labels.forEach((t=>{const e=t.graphics3DGraphic;s.set(e.graphic.uid,e)}));const n=t=>t.labelGraphics[0];P(i.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(t,s,n),i.graphics3DCalloutSymbolLayer&&i.graphics3DCalloutSymbolLayer.globalPropertyChanged(t,s,(t=>t.labelGraphics[i.calloutSymbolLayerIndex]))}}_visibilityInfoChange(t){const e=t.layer.labelsVisible;e&&!t.active&&this._activateLabelingContext(t),!e&&t.active&&this._deactivateLabelingContext(t),this.setDirty()}_resetAllLabels(){for(const t of this._labelingContexts)this._resetLabels(t)}_resetLabels(t){t.labels.forEach(((e,i)=>{this._destroyGraphic(e,i),e.visible=!1,e.rendered=!1,t.labelsToInitialize.set(i,e)})),this._destroyLabelClassContext(t),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(t){for(const e of this._labelingContexts)if(e.graphics3DCore===t)return e;return null}addGraphicsOwner(t,e,i){const s=i&&i.emptySymbolLabelSupported||!1,n=i&&i.elevationInfoOverride||null,r=i&&i.disablePlacement||null;if(this._findLabelingContext(t))return;const o=t.layer,a={graphics3DCore:t,layer:o,scaleVisibility:e,emptySymbolLabelSupported:s,elevationInfoOverride:n,disablePlacement:r,active:o.labelsVisible,labelClassPromise:null,labelClassAbortController:new AbortController,labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new dr({isPickable:!0},o.uid)};return this.view._stage.add(a.stageLayer),this._labelingContexts.push(a),this.setDirty(),{addGraphic:t=>this._addGraphic(a,t),removeGraphic:t=>this._removeGraphic(a,t),featureReductionChange:()=>{},layerLabelsEnabled:()=>ii(a.layer),labelingInfoChange:t=>this._labelingInfoChange(a,t),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",a),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",a),visibilityInfoChange:()=>this._visibilityInfoChange(a),reset:()=>this._resetLabels(a),clear:()=>{}}}removeGraphicsOwner(t){const e=this._findLabelingContext(t);if(!e)return;const i=this._labelingContexts.indexOf(e);this._labelingContexts.splice(i,1),e.labels.forEach((t=>this._removeGraphic(e,t.graphics3DGraphic))),this.view._stage.remove(e.stageLayer),e.stageLayer=null,this.setDirty()}setLabelGraphicVisibility(t,e){const i=t.graphic.uid,s=this._labels.get(i);s&&s.visible!==e&&(e&&!s.rendered?(this._labelsToAdd.set(i,s),this._labelsToRemove.delete(i),s.hasTextTextureResources||s.labelingContext.labelsToInitialize.set(i,s)):!e&&s.rendered&&(this._labelsToRemove.set(i,s),this._labelsToAdd.delete(i)),s.visible=e,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){var t;return this._dirty||(null==(t=this._textTextureAtlas)?void 0:t.updating)||this.deconflictor.updating||this._labelingContexts.some((t=>Nb(t)))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const t=this._labelingContexts.length>0?this._labelingContexts.reduce(((t,e)=>t+(Nb(e)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*t+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function jb(t){return t.active&&ii(t.layer)}function Nb(t){return t.labelClassPromise&&!!t.labelClassAbortController}function kb(t){return t.labelClassContexts&&t.labelClassContexts.length}function Bb(t){return null===t.labelClassContexts}r([o({constructOnly:!0})],Vb.prototype,"view",void 0),r([o({constructOnly:!0})],Vb.prototype,"deconflictor",void 0),r([o()],Vb.prototype,"_textTextureAtlas",void 0),r([o({type:Boolean,readOnly:!0})],Vb.prototype,"updating",null),Vb=r([a("esri.views.3d.layers.graphics.Labeler")],Vb);const Gb=new Rl(null,null,null);class qb{constructor(){this.gltfCache=new Map,this.wosrCache=new Map,this.evictHandles=new E}loadGLTF(t,e,i){return this.fromCache(this.gltfCache,i?`gltfPBR:${t}`:`gltf:${t}`,(e=>lc(new cc(e.streamDataRequester),t,e,i)),e)}loadWOSR(t,e){return this.fromCache(this.wosrCache,`wosr:${t}:${e.disableTextures}`,(e=>Oa(t,e)),e)}destroy(){this.evictHandles.destroy(),this.gltfCache.clear(),this.wosrCache.clear()}get size(){return this.wosrCache.size+this.gltfCache.size}fromCache(t,e,i,s){return new Promise(((n,r)=>{if(vt(s))return void r(ut());const o=yt(s,(()=>{this.remove(t,e),r(ut())})),a=t.get(e);if(a)return this.evictHandles.remove(e),a.refCount++,void a.item.then(n,r);const h=new AbortController,l={...s,signal:h.signal},c={refCount:1,abortController:h,item:i(l).then((i=>(c.abortController=null,i.remove=()=>this.remove(t,e),i)))};t.set(e,c),c.item.then((t=>{p(o)&&o.remove(),n(t)}),(t=>{p(o)&&o.remove(),r(t)}))}))}remove(t,e){const i=t.get(e);i&&(i.refCount--,0===i.refCount&&this.evictHandles.add(wt((()=>{t.delete(e),p(i.abortController)&&i.abortController.abort()}),Wb),e))}}let Wb=1e4;class Ub{constructor(t,e,i,s=null){this.lij=[0,0,0],this.extent=Ln(),this.resolution=0,this.loadPriority=0,this.measures={visibility:2,screenRect:Ln(),distance:0,shouldSplit:!1},this.used=!1,s&&this.acquire(t,e,i,s)}acquire(t,e,i,s){this.tilingScheme=s,this.id=Ub.id(t,e,i),this.lij[0]=t,this.lij[1]=e,this.lij[2]=i,s.getExtent(t,e,i,this.extent),this.resolution=s.resolutionAtLevel(t)}release(){this.tilingScheme=null}getChildren(t){const e=this.lij[0]+1,i=2*this.lij[1],s=2*this.lij[2];return t?(t[0].acquire(e,i,s,this.tilingScheme),t[1].acquire(e,i+1,s,this.tilingScheme),t[2].acquire(e,i,s+1,this.tilingScheme),t[3].acquire(e,i+1,s+1,this.tilingScheme),t):[new Ub(e,i,s,this.tilingScheme),new Ub(e,i+1,s,this.tilingScheme),new Ub(e,i,s+1,this.tilingScheme),new Ub(e,i+1,s+1,this.tilingScheme)]}copyMeasurementsFrom(t){this.measures.visibility=t.measures.visibility,this.measures.shouldSplit=t.measures.shouldSplit,this.measures.distance=t.measures.distance,Gn(t.measures.screenRect,this.measures.screenRect)}static id(t,e,i){return`${t}/${e}/${i}`}}class Hb{constructor(t){this.renderCoordsHelper=t,this.frustum=pr(),this._points=fr(),this.lines=new Array(12),this._origin=js(),this._direction=js(),this._altitude=null;for(let t=0;t<12;t++)this.lines[t]={origin:null,direction:js(),endpoint:null}}get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}update(t){gr(t.viewMatrix,t.projectionMatrix,this.frustum,this._points),$i(this._origin,t.eye),$i(this._direction,t.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this.updateLines()}updatePoints(t){for(let e=0;e<this._points.length;e++)$i(this._points[e],t[e]);mr(this.frustum,this._points),this.updateLines()}get altitude(){return this._altitude}intersectsSphere(t){return vr(this.frustum,t)}intersectsRay(t){return yr(this.frustum,t)}intersectsLineSegment(t,e){return wr(this.frustum,t,e)}intersectsPoint(t){return er(this.frustum,t)}updateLines(){const t=this._points;for(let e=0;e<4;e++){const i=e+4;Zb(this.lines[e],t[e],t[i]),Zb(this.lines[e+4],t[e],3===e?t[0]:t[e+1]),Zb(this.lines[e+8],t[i],3===e?t[4]:t[i+1])}}}function Zb(t,e,i){t.origin=e,t.endpoint=i,xs(t.direction,e,i)}Hb.planePointIndices=xr,Hb.nearFarLineIndices=[[0,4],[1,5],[2,6],[3,7]];class Qb{constructor(t){this.renderCoordsHelper=t,this.surfaceElevation=0,this.cache=new Map,this.frustum=new Hb(t),this.extendedFrustum=new Hb(t),this.intersector=new zl({renderCoordsHelper:t}),this.renderCoordsHelper=t}begin(t,e){this.surfaceElevation=e,this.aboveGround=this.renderCoordsHelper.getAltitude(t.eye)>e,this.frustum.update(t),this.shortenFrustumFarPlane(this.frustum),this.updateExtendedFrustum(t)}end(){this.cache.clear()}calculate(t){if(this.allTilesInvisible)return 0;const e=1===this.renderCoordsHelper.viewingMode&&t.lij[0]>=Yb&&t.lij[0]<Xb,i=this.getOrCalculateSingleTileVisibility(t,!e);return 0!==i&&e?this.calculateAggregatedChildrenVisibility(t):i}shortenFrustumFarPlane(t){const e=Hb.nearFarLineIndices,i=t.mutablePoints;for(const t of e){const[e,s]=t,n=i[e];ts(tC,i[s],n),Yi(tC,tC,$b),Ki(i[s],n,tC)}t.updatePoints(i)}calculateAggregatedChildrenVisibility(t){let e=0;const i=this.cache.get(t.id);if(null!=i)return i;const s=sC.acquire();t.getChildren(s);for(const t of s){const i=this.calculate(t);if(0!==i&&(e=i,2===i))break}return sC.release(s),this.cache.set(t.id,e),e}getOrCalculateSingleTileVisibility(t,e){const i=this.cache.get(t.id);if(null!=i)return i;const s=this.calculateSingleTileVisibility(t);return e&&this.cache.set(t.id,s),s}calculateSingleTileVisibility(t){return!this.aboveGround&&1===this.renderCoordsHelper.viewingMode&&t.lij[0]<Kb?0===this.calculateSingleTileVisibilitySided(t,!1)?this.calculateSingleTileVisibilitySided(t,!0):void 0:this.calculateSingleTileVisibilitySided(t,this.aboveGround)}calculateSingleTileVisibilitySided(t,e){this.intersector.update(t.extent,t.tilingScheme.spatialReference,this.surfaceElevation,e);const i=Qr(t.tilingScheme.spatialReference).radius;return this.intersector.isVisibleInFrustum(this.extendedFrustum,i)?this.intersector.isVisibleInFrustum(this.frustum,i,!0)?2:1:0}updateExtendedFrustum(t){this.extendedFrustum.update(t),this.shortenFrustumFarPlane(this.extendedFrustum);const e=this.renderCoordsHelper.worldUpAtPosition(t.eye,tC);this.aboveGround||ls(e,e);const i=rs(-es(e,t.viewForward));if(this.allTilesInvisible=i>(Math.PI+t.fovY)/2,this.allTilesInvisible)return;if(this.hasExtendedFrustum=i>t.fovY/2,!this.hasExtendedFrustum)return;const s=this.extendedFrustumParameters(),n=this.extendedFrustum.mutablePoints;for(let t=0;t<4;t++){const e=s.pointIndices[t],i=n[e],r=this.renderCoordsHelper.getAltitude(i);if(s.needsAltitudeAdjustment(r)){switch(this.renderCoordsHelper.worldUpAtPosition(i,tC),e){case 4:case 7:case 0:case 3:Zl(this.extendedFrustum.planes[0],tC,tC);break;case 5:case 6:case 1:case 2:Zl(this.extendedFrustum.planes[1],tC,tC)}Yi(tC,tC,s.direction),this.renderCoordsHelper.intersectInfiniteManifold(No(i,tC),s.zWithMargin,i)}}if(this.extendedFrustum.updatePoints(n),Ql(n[0],n[1],n[2],eC),Ql(n[1],n[2],n[3],iC),es(Wl(eC),Wl(iC))<0){const t=this.extendedFrustum.mutablePoints;this.aboveGround?[t[0],t[1]]=[t[1],t[0]]:[t[3],t[2]]=[t[2],t[3]],this.extendedFrustum.updatePoints(t)}}extendedFrustumParameters(){return this.aboveGround?this.extendedFrustumParametersAboveSurface():this.extendedFrustumParametersBelowSurface()}extendedFrustumParametersAboveSurface(){const t=this.surfaceElevation-Jb;return{zWithMargin:t,pointIndices:Hb.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:e=>e>t}}extendedFrustumParametersBelowSurface(){const t=this.surfaceElevation+Jb;return{zWithMargin:t,pointIndices:Hb.planePointIndices.top,direction:1,needsAltitudeAdjustment:e=>e<t}}}const Yb=2,Xb=6,Kb=12,$b=.95,Jb=1,tC=js(),eC=Gl(),iC=Gl(),sC=new xt(Array,(t=>{4!==t.length&&(t[0]=new Ub,t[1]=new Ub,t[2]=new Ub,t[3]=new Ub)}),(t=>{t[0].release(),t[1].release(),t[2].release(),t[3].release()}));class nC{constructor(t){this.camera=new hr,this.focusOnMap=[0,0],this.screenRect=Ln(),this.tileSize=t.tileSize,this.renderCoordsHelper=t.renderCoordsHelper,this.tilingScheme=t.tilingScheme,this.visibility=new Qb(t.renderCoordsHelper)}begin(t,e,i){this.camera.copyFrom(t),this.surfaceElevation=i,this.focusOnMap[0]=e.x,this.focusOnMap[1]=e.y,qn(0,0,t.fullWidth,t.fullHeight,this.screenRect),this.visibility.begin(this.camera,i)}end(){this.visibility.end()}updateTile(t){t.measures.visibility=this.visibility.calculate(t),t.measures.distance=Wn(t.extent,this.focusOnMap),0!==t.measures.visibility&&this.updateScreenMeasure(t)}updateScreenMeasure(t){const e=oC,i=1<<e,s=t.measures.screenRect;In(s);let n=0;const r=t.lij[0]+e,o=t.lij[1]<<e,a=t.lij[2]<<e,h=this.tileSizeWithBias(t),l=h*h;for(let e=0;e<i;e++)for(let h=0;h<i;h++)if(n+=this.computeScreenArea(t,r,o+e,a+h,s),n>l)return void(t.measures.shouldSplit=!0);t.measures.shouldSplit=!1}tileSizeWithBias(t){return 1===t.measures.visibility?this.tileSize*aC:this.tileSize}computeScreenArea(t,e,i,s,n){this.projectToScreen(e,i,s,1===t.measures.visibility,hC),In(rC);for(let t=0;t<4;t++)Un(rC,hC[t]);return jn(n,rC,n),uc(hC[0],hC[1],hC[2])+uc(hC[0],hC[2],hC[3])}projectToScreen(t,e,i,s,n){this.tilingScheme.ensureMaxLod(t),this.tilingScheme.getExtent(t,e,i,lC),this.toRenderCoords(lC,0,3,uC[0]),this.toRenderCoords(lC,2,3,uC[1]),this.toRenderCoords(lC,2,1,uC[2]),this.toRenderCoords(lC,0,1,uC[3]),s&&(this.projectToPlane(uC,this.camera.frustum[4]),this.projectToPlane(uC,this.camera.frustum[3]),this.projectToPlane(uC,this.camera.frustum[2]));for(let t=0;t<4;t++)this.camera.projectToRenderScreen(uC[t],pC),this.camera.renderToScreen(pC,n[t])}projectToPlane(t,e){for(let i=0;i<4;i++)dC[i]=Yl(e,t[i]);const i=Math.max(dC[0],dC[1],dC[2],dC[3]);if(i>0){const s=Yi(cC,Wl(e),-i);for(let e=0;e<4;e++)Ki(t[e],t[e],s)}}toRenderCoords(t,e,i,s){return cC[0]=t[e],cC[1]=t[i],cC[2]=this.surfaceElevation,this.renderCoordsHelper.toRenderCoords(cC,this.tilingScheme.spatialReference,s),s}}const rC=Ln(),oC=2,aC=5,hC=[Co(),Co(),Co(),Co()],lC=Ln(),cC=js(),uC=[js(),js(),js(),js()],dC=[0,0,0,0],pC=So(),fC=y.getLogger("esri.views.3d.layers.support.FeatureTileTree3D");let gC=class extends T{constructor(t){super(t),this.tiles=new _,this.tileSize=512,this._idToTile=new Map,this._handles=new E,this._clients=new Set,this._dirty=!1,this._newTiles=new pt}get tilingScheme(){const t=this.tilingSchemeOwner.tilingScheme;return t?t.clone():null}set filterExtent(t){if(p(t)&&!t.spatialReference.equals(this.viewState.spatialReference))return void fC.error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const e=this._get("filterExtent");if(e===t||p(e)&&t&&e.equals(t))return;const i=p(t)?t.clone():null;this._set("filterExtent",i),this._setDirty()}get filterExtentRect(){if(w(this.filterExtent)||!this.tilingScheme)return null;const t=Ln();return Ll(this.filterExtent,t,this.tilingScheme.spatialReference),t}get rootTileIds(){return this.filterExtentRect?this.tilingScheme.rootTilesInExtent(this.filterExtentRect):[[0,0,0]]}set suspended(t){t!==this._get("suspended")&&(this._set("suspended",t),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}initialize(){this._handles.add(this.watch(["tilingScheme","tileSize"],(()=>this._reset()),!0)),this._handles.add(tt(this,["tileSize","cameraOnSurface.location","tilingScheme","viewState.contentCamera","focus.location"],(()=>this._setDirty()),!0)),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(po.FEATURE_TILE_TREE,this))}destroy(){this._frameWorker=J(this._frameWorker),this._handles=Y(this._handles)}addClient(){const t=mC++;return this._clients.add(t),1===this._clients.size&&this._setDirty(),{remove:()=>this._removeClient(t)}}_removeClient(t){this._clients.delete(t),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(fo))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}get running(){return this.updating}runTask(t){this._dirty=!1,this._pendingTiles||(this._startUpdate(),p(this._frameWorker)&&(this._frameWorker.priority=po.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(t),!this._pendingTiles&&p(this._frameWorker)&&(this._frameWorker.priority=po.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){this.suspended||(this.tilingScheme?(this._tileMeasurements||(this._tileMeasurements=new nC({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize})),this._tileMeasurements.begin(this.viewState.contentCamera,this.focus.location,this.cameraOnSurface.location.z),this._pendingTiles=this._getRootTiles()):this._clear())}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){return this.rootTileIds.map((t=>new Ub(t[0],t[1],t[2],this.tilingScheme)))}_purgeHorizonTiles(t){t.sort(((t,e)=>{const i=t.measures.screenRect,s=e.measures.screenRect;return i[1]+i[3]-(s[1]+s[3])})),In(vC);for(let e=0;e<t.length;e++)if(jn(vC,t.data[e].measures.screenRect,vC),Bn(vC)>yC)return t.data.slice(e,t.length);return[]}_subdivideTilesForView(t){if(this._pendingTiles){for(;this._pendingTiles.length>0&&!t.done;){const e=this._pendingTiles.pop();t.madeProgress(),this.filterExtentRect&&!Nn(this.filterExtentRect,e.extent)||(this._tileMeasurements.updateTile(e),0!==e.measures.visibility&&(e.measures.shouldSplit?(this.tilingScheme.ensureMaxLod(e.lij[0]+1),this._pendingTiles.push(...e.getChildren())):this._newTiles.push(e)))}0===this._pendingTiles.length&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}}_updateTiles(t){for(const t of this.tiles.items)t.used=!1;const e=t.filter((t=>{const e=this._idToTile.get(t.id);return e?(e.copyMeasurementsFrom(t),e.used=!0):this._idToTile.set(t.id,t),!e})),i=this.tiles.items.filter((t=>!t.used&&(this._idToTile.delete(t.id),!0)));this.tiles.removeMany(i),this.tiles.addMany(e),this.sortTiles()}sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort(((t,e)=>t.measures.visibility!==e.measures.visibility?2===t.measures.visibility?-1:1:t.measures.distance-e.measures.distance)),this.tiles.forEach(((t,e)=>t.loadPriority=e))}};r([o({constructOnly:!0})],gC.prototype,"scheduler",void 0),r([o({constructOnly:!0})],gC.prototype,"renderCoordsHelper",void 0),r([o({constructOnly:!0})],gC.prototype,"tilingSchemeOwner",void 0),r([o({constructOnly:!0})],gC.prototype,"cameraOnSurface",void 0),r([o({constructOnly:!0})],gC.prototype,"focus",void 0),r([o({constructOnly:!0})],gC.prototype,"viewState",void 0),r([o({constructOnly:!0})],gC.prototype,"terrain",void 0),r([o()],gC.prototype,"tiles",void 0),r([o()],gC.prototype,"tileSize",void 0),r([o({readOnly:!0})],gC.prototype,"tilingScheme",null),r([o()],gC.prototype,"filterExtent",null),r([o({readOnly:!0})],gC.prototype,"filterExtentRect",null),r([o({readOnly:!0})],gC.prototype,"rootTileIds",null),r([o({value:!1})],gC.prototype,"suspended",null),r([o({readOnly:!0})],gC.prototype,"updating",null),gC=r([a("esri.views.3d.layers.support.FeatureTileTree3D")],gC);let mC=0;const vC=Ln(),yC=10,wC=gC;let xC=class extends T{constructor(){super(...arguments),this._propertiesPool=new El({camera:hr},this),this._lastSeenCameraProjectionValues=new hr,this.events=new G,this.viewingMode=1,this._cameraChanged=!1,this.updateQueue=new Array,this.processingUpdates=!1}init(t,e){this._set("viewingMode",t),this._set("spatialReference",e),this._set("constraints",new Tf({mode:this.viewingMode}))}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new El({camera:hr},this)}createInitialCamera(){if(1===this.viewingMode){const t=Qr(this.spatialReference).radius;this.camera=new hr(Ns(4*t,0,0),Ns(t,0,0),Ns(0,0,1))}else this.camera=new hr(Ns(0,0,100),Ns(0,0,0),Ns(0,1,0))}get animation(){return this.cameraController instanceof Ry&&p(this.cameraController.viewAnimation)?this.cameraController.viewAnimation:null}get camera(){return this._get("camera")}set camera(t){t!==CC&&CC.copyFrom(t),CC.computeUp(this.viewingMode),MC.camera=CC,this.events.emit("before-camera-change",MC);const e=this._get("camera");if(this.cameraProjectionChanged(this._lastSeenCameraProjectionValues,CC)&&(this._lastSeenCameraProjectionValues.copyFrom(CC),SC.camera=this._lastSeenCameraProjectionValues,this.events.emit("camera-projection-changed",SC)),(!e||!e.equals(CC))&&(this._set("camera",this._propertiesPool.get("camera").copyFrom(CC)),this._cameraChanged=!e||!e.almostEquals(CC),this._cameraChanged)){const t=bt((()=>{this._cameraChanged=!1,t.remove()}))}}get contentCamera(){return p(this._contentCamera)?this._contentCamera:this.camera}set contentCamera(t){this._contentCamera=p(t)?t.clone():null}get fixedContentCamera(){return!!p(this._contentCamera)}get isGlobal(){return 1===this.viewingMode}get isLocal(){return 2===this.viewingMode}get navigating(){return!(!this.cameraController||!this.cameraController.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(t){this.stopActiveCameraController()?(t&&(t.watch("state",(e=>{e!==Dy.Finished&&e!==Dy.Stopped||(this._set("cameraController",null),this.updateCamera((e=>t.onControllerEnd(e))))}),!0),t.onControllerStart(this.camera)),this._set("cameraController",t)):t&&(t.state=Dy.Rejected)}switchCameraController(t){return this.cameraController=t,t.state!==Dy.Rejected}stopActiveCameraController(){return!(this.cameraController&&!this.cameraController.stopController())}updateCamera(t){this.updateQueue.push(t),this.processUpdateQueue()}processUpdateQueue(){if(0===this.updateQueue.length||this.processingUpdates)return;this.processingUpdates=!0;const t=this.updateQueue.shift();CC.copyFrom(this._get("camera")),t(CC),this.camera=CC,this.processingUpdates=!1,this.processUpdateQueue()}cameraProjectionChanged(t,e){return t.fov!==e.fov||t.fullViewport[0]!==e.fullViewport[0]||t.fullViewport[1]!==e.fullViewport[1]||t.fullViewport[2]!==e.fullViewport[2]||t.fullViewport[3]!==e.fullViewport[3]||t.padding[0]!==e.padding[0]||t.padding[1]!==e.padding[1]||t.padding[2]!==e.padding[2]||t.padding[3]!==e.padding[3]}};r([o({readOnly:!0,type:ie})],xC.prototype,"animation",null),r([o({type:hr})],xC.prototype,"camera",null),r([o({})],xC.prototype,"_contentCamera",void 0),r([o({type:hr})],xC.prototype,"contentCamera",null),r([o({readOnly:!0})],xC.prototype,"fixedContentCamera",null),r([o({readOnly:!0})],xC.prototype,"constraints",void 0),r([o({readOnly:!0})],xC.prototype,"events",void 0),r([o({readOnly:!0})],xC.prototype,"isGlobal",null),r([o({readOnly:!0})],xC.prototype,"isLocal",null),r([o({readOnly:!0})],xC.prototype,"viewingMode",void 0),r([o({readOnly:!0})],xC.prototype,"spatialReference",void 0),r([o({readOnly:!0})],xC.prototype,"navigating",null),r([o({readOnly:!0})],xC.prototype,"stationary",null),r([o()],xC.prototype,"_cameraChanged",void 0),r([o()],xC.prototype,"cameraController",null),xC=r([a("esri.views.3d.state.ViewState")],xC);const bC=xC,CC=new hr,MC={camera:null},SC={camera:null};class PC{constructor(t,e){this.elevationProvider=t,this._referenceEllipsoid=Qr(e),this.unitInMeters=Xr(e,this._referenceEllipsoid.metersPerDegree)}compute(t,e,i,s,n){n||(n={near:0,far:0});let r=t[2]*this.unitInMeters;const o=r-s,a=this.elevationProvider?this.elevationProvider.elevationBounds:null;a&&(r=o>=0?r-this.unitInMeters*a.min:this.unitInMeters*a.max-r);const h={x:(i=p(i)?i:new g({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-i.xmin,y:i.ymax-i.ymin,z:4*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},l=Math.max(h.x,h.y,h.z);ts(zC,e,t),FC[0]=zC[0]>0?i.xmax:i.xmin,FC[1]=zC[1]>0?i.ymax:i.ymin,FC[2]=zC[2]>0?l/2:-l/2,ts(FC,FC,t),is(zC,zC);const c=1.1*es(FC,zC)*this.unitInMeters,u=Math.sqrt(r*(r+2*this._referenceEllipsoid.radius)),d=Math.max(i.xmax-i.xmin,i.ymax-i.ymin),f=d*RC*this.unitInMeters;let m=fs((r-f)/(d*OC*this.unitInMeters-f),0,1);m*=m*m;let v=ys(u,c,m);return v*=Math.max(Math.log(Math.abs(o)),1),v=Math.min(v,Math.max(34064e4,l)),v/=this.unitInMeters,AC(v,_C,this.unitInMeters,n)}}class TC{constructor(t){this._referenceEllipsoid=Qr(t)}compute(t,e,i,s,n){n||(n={near:0,far:0});const r=Xi(t)-this._referenceEllipsoid.radius,o=this._referenceEllipsoid.radius+Math.min(0,s),a=Math.abs(r-s),h=Math.max(a,Math.abs(r));return AC(1.2*Math.sqrt(h*(h+2*o)),fs(2e4-(Math.log(h)-7.983)/9.011*19e3,1e3,2e4),1,n)}}function AC(t,e,i,s){const n=DC/i;return t/e>n?(s.far=t,s.near=s.far/e):(s.near=n,s.far=s.near*e),s}const _C=2e4,DC=2,OC=.001,RC=1e-4,FC=js(),zC=js();let LC=class extends T{constructor(t){super(t),this.handles=new E}initialize(){this.handles.add(this.view.basemapTerrain.on("elevation-change",(t=>this.handleElevationChangeEvent(t))))}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}handleElevationChangeEvent(t){this.view.state.cameraController||Fu(this.view,this.view.state.camera,t.extent,t.spatialReference)&&this.applyToCurrentCamera()}applyToCurrentCamera(){this.view.state.updateCamera((t=>{ev(this.view,t,1)}))}};r([o({constructOnly:!0})],LC.prototype,"view",void 0),LC=r([a("esri.views.3d.state.ElevationCollisionConstraint")],LC);const EC=LC;let IC=class extends T{constructor(t){super(t),this._handles=new E,this.nearFarHeuristic=function(t,e,i){return 1===t?new TC(i):new PC(e,i)}(t.view.state.viewingMode,t.view.basemapTerrain,t.view.renderCoordsHelper.spatialReference)}initialize(){this._handles.add([this.view.watch(["constraints.clipDistance.near","constraints.clipDistance.far"],(()=>this._clipDistanceNearFarChanged())),this.view.watch("constraints.clipDistance.mode",(()=>this._updateNearFar())),this.view.state.events.on("before-camera-change",(t=>this._updateCameraNearFar(t.camera))),this.view.watch("renderDataExtent",(()=>this._updateNearFar()),!0),this.view.watch(["constraints.altitude.min","constraints.altitude.max"],(()=>this._updateAltitude()),!0),this.view.watch("constraints.tilt.max",(()=>this._updateTiltMax()),!0),this.view.watch("constraints.tilt.mode",(()=>this._updateTilt()),!0),this.view.watch("state.camera",(()=>this._updateTiltAutoMax()),!0),this.view.watch(["map.ground.navigationConstraint.type","constraints.collision.enabled"],(()=>this._updateCollision()),!0)]),this.view.state.isLocal&&this._handles.add(tt(this.view,"renderDataExtent",(t=>this._updateLocalSurfaceDistance(t)))),this._updateNearFar(),2!==this.view.state.viewingMode&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new EC({view:this.view}))}destroy(){this._handles=Y(this._handles),this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){var t;const e=null==(t=this.view.constraints)?void 0:t.clipDistance;e&&"auto"!==e.mode&&this.view.state.updateCamera((t=>(this._updateCameraNearFarManual(t,e),!0)))}_updateNearFar(){this.view.state.updateCamera((t=>(this._updateCameraNearFar(t),!0)))}_updateCameraNearFar(t){const e=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(e?e.mode:"auto")?this._updateCameraNearFarManual(t,e):this._updateCameraNearFarAuto(t,e)}_updateCameraNearFarAuto(t,e){this.nearFarHeuristic.compute(t.eye,t.center,this.view.renderDataExtent,zu(this.view,t.eye),t),e&&e.autoUpdate(t.near,t.far)}_updateCameraNearFarManual(t,e){e&&(t.near=e.near,t.far=e.far)}_updateCollision(){var t,e,i;const s=null==(t=this.view.map)||null==(e=t.ground)||null==(i=e.navigationConstraint)?void 0:i.type,n=!s||"stay-above"===s,r=this.view.state.constraints.collision;if(n!==r.enabled){r.enabled=n,n&&this._reapplyConstraints(8);const t=this.view.constraints&&this.view.constraints.tilt;t&&"auto"!==t.mode||this._updateTiltAuto()}}_updateAltitude(){const t=this.view.constraints&&this.view.constraints.altitude;this.view.state.constraints.altitude=t&&2!==this.view.state.viewingMode?{min:t.min,max:t.max}:null,this._reapplyConstraints()}_updateTiltMax(){const t=this.view.constraints&&this.view.constraints.tilt;t&&"auto"!==t.mode&&(this._updateTiltManual(t),this._reapplyConstraints())}_updateTilt(){const t=this.view.constraints&&this.view.constraints.tilt;"manual"===(t?t.mode:"auto")?this._updateTiltManual(t):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(t){const e=this.view.state.constraints;e.tilt=e.createConstantMaxTilt(as(t.max))}_updateTiltAuto(){const t=this.view.state.constraints;t.tilt=t.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const t=this.view.constraints&&this.view.constraints.tilt;if(!t||"auto"!==t.mode)return;const e=this.view.state.constraints;if(e.tilt){const i=e.tilt(this.view.state.camera.distance).max;t.autoUpdate(ns(i))}}_updateLocalSurfaceDistance(t){if(w(t))return;let e=Math.max(t.width,t.height);if(e<=0)return;t.hasZ&&(e=Math.max(e,t.zmax-t.zmin));const i=this.view.state,s=3*e/Math.atan(i.camera.fov/2);s!==i.constraints.distance&&(i.constraints.distance=s)}_reapplyConstraints(t=15){this.view.state.updateCamera((e=>Qv(this.view,e,{selection:t,interactionType:0,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:0})))}};r([o({constructOnly:!0})],IC.prototype,"view",void 0),r([o({readOnly:!0})],IC.prototype,"surfaceCollisionConstraint",void 0),IC=r([a("esri.views.3d.state.ConstraintsManager")],IC);const VC=IC;let jC=class extends Oy{constructor(t){super(t),this.handles=new E}set desiredCamera(t){this._set("desiredCamera",t.clone())}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=Dy.Running,this.handles.add(this.view.basemapTerrain.on("elevation-change",(t=>this.handleElevationChangeEvent(t)))),this.applyCorrection()}onControllerEnd(){this.handles.removeAll()}stepController(){}handleElevationChangeEvent(t){Fu(this.view,this.desiredCamera,t.extent,t.spatialReference)&&this.applyCorrection()}applyCorrection(){this.view.state.updateCamera((t=>{t.copyViewFrom(this.desiredCamera),ev(this.view,t,1)||this.constraintEnabled||(this.state=Dy.Stopped)}))}};r([o({constructOnly:!0})],jC.prototype,"view",void 0),r([o({constructOnly:!0})],jC.prototype,"desiredCamera",null),jC=r([a("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],jC);class NC{constructor(t,e,i){this.target=t,this.options=e,this.view=i,this.state="pending",this.abortController=null,this.animationController=null,this.promise=new Promise(((t,e)=>{this.resolveCallback=t,this.rejectCallback=e;const i=new AbortController;p(this.options.signal)&&yt(this.options.signal,(()=>{this.abort()})),this.abortController=i,this.waitForReady()}))}then(t,e){return this.promise.then(t,e)}catch(t){return this.promise.catch(t)}resolve(t){return this.state="finished",this.resolveCallback(t)}reject(t){return this.state="finished",this.rejectCallback(t)}abort(t=!1){switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":this.reject(ut());break;case"wait-for-animation-finish":!t&&p(this.animationController)&&this.view.state.cameraController===this.animationController&&this.animationController.active&&this.animationController.stopController(),this.reject(ut())}}waitForReady(){this.state="wait-for-ready",this.view.ready?this.createViewPoint():Ct(this.view,"ready",this.abortController.signal).then((()=>{this.createViewPoint()}),(t=>{this.reject(t)}))}createViewPoint(){"finished"!==this.state&&(this.state="wait-for-viewpoint",this.animationController=this.options.animate?this.getAnimationController():null,Wd(this.view,this.target,this.abortController.signal).then((t=>{if("finished"===this.state)return;const e=this.getCameraFromViewpoint(t);if(!w(e))if(this.options.animate){if(w(this.animationController))return;this.startAnimation(e,this.animationController)}else this.view.stateManager.setStateCamera(e.camera,{applyConstraints:!e.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve()}),(t=>{this.reject(t)})))}getCameraFromViewpoint(t){const e=!!(this.target instanceof Se&&this.target.camera||this.target instanceof Pe),i=t.camera;if(w(i))return null;if(!this.view.stateManager.isCompatible(i)){const t=i.position,e=t&&t.spatialReference;return this.reject(new n("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${e?e.wkid:"none"}, view: ${this.view.spatialReference.wkid})`,{camera:i})),null}const s=bd(this.view,i);return w(s)?(this.reject(new n("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:t,camera:s,isFullySpecified:e}}startAnimation(t,e){this.state="wait-for-animation-finish";const i=e.viewAnimation;if(w(i))return void this.reject(new n("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(i.update(t.viewpoint,"running"),!e.active||w(e.viewAnimation)||e.viewAnimation.target!==t.viewpoint||this.view.state.cameraController!==e)return this.abort();let s;t.isFullySpecified?(s=new jC({view:this.view,desiredCamera:t.camera}),ev(this.view,t.camera,1)):Qv(this.view,t.camera),e.begin(t.camera,this.options);const r=t=>{if(!w(this.view.state))switch(e.state){case Dy.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.resolve()}break;case Dy.Ready:case Dy.Rejected:case Dy.Running:case Dy.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.reject(t)}}};i.when((()=>{const i=this.view.state.cameraController;s&&(i&&i.active?i instanceof Fy&&p(i.viewAnimation)&&i.viewAnimation.target===t.viewpoint&&(this.view.state.cameraController=s):p(e.viewAnimation)&&e.viewAnimation.target===t.viewpoint&&"finished"===e.state&&(this.view.state.cameraController=s))}),(t=>r(t))),e.asyncResult={resolve:()=>r(),reject:t=>r(t)}}getAnimationController(){let t,e=null;const i=this.view.state.cameraController;return i instanceof Fy&&(i.updateStateFromViewAnimation(),i.active&&(t=i,e=t.viewAnimation)),null!=t||(t=new Fy({view:this.view,mode:"animation"}),e=t.viewAnimation,this.view.state.switchCameraController(t))?t:(p(e)&&e.stop(),this.reject(new n("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}}const kC=y.getLogger("esri.views.3d.state.ViewStateManager");let BC=class extends T{constructor(t){super(t),this.propertiesPool=new El({frustum:Hb},this),this.handles=new E,this.cameraSetByUser=!1,this.gotoOperation=null,this.ready=!1,this.updateDevicePixelRatio=null,this.test={contentCameraResetState:new Map}}get camera(){const t=this._get("camera");if(!this.ready)return t;const e=Md(this.view,this.view.state.camera);return e&&t&&e.equals(t)?t:e}set camera(t){this.updatePropertyBeforeReady("camera",t)||(this.view.elevationProvider.enableElevationCache(!0),this.setStateCamera(bd(this.view,t),{applyConstraints:!1})||kC.error("#camera=","Invalid camera",t),this.view.elevationProvider.enableElevationCache(!1))}get contentCamera(){const t=this._get("contentCamera");if(!this.ready)return t;const e=Md(this.view,this.view.state.contentCamera);return e&&t&&e.equals(t)?t:e}set contentCamera(t){if(this.updatePropertyBeforeReady("contentCamera",t))return;const e=bd(this.view,t);w(e)?this.view.state.contentCamera=null:(this.updateElevation(e),this.view.state.contentCamera=e)}installContentCameraReset(t){if(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const e=this.zoom,i=this.view.state.camera.distance**2,s=Gs(this.view.state.camera.center),n=t.sticky?this.contentCamera.clone():null;return this.handles.add([this.watch("contentCamera",(()=>{t.sticky||(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear())})),this.watch("zoom",(t=>{this.test.contentCameraResetState.set("view.zoom",Math.abs(t-e)/2),Math.abs(t-e)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n)})),this.view.state.watch("camera",(t=>{const e=Ji(s,t.center);this.test.contentCameraResetState.set("camera.center",e/i),e>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n)}))],"contentCameraReset"),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(t){this.updatePropertyBeforeReady("center",t)||(t?this.isCompatible(t)?this.setStateCamera(this.centerToCamera(t),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():kC.error("#center=","Invalid center",t):kC.error("#center=","Center has an incompatible spatial reference (center: "+(t.spatialReference?t.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",t):kC.error("#center=","Center may not be null or undefined"))}get extent(){if(!this.ready)return this._get("extent");const t=this.view,e=function(t,e,i){const s=Ve(i,t.renderSpatialReference,wd(t));if(w(s))return null;const n=Math.tan(e.fovX/2),r=Math.tan(e.fovY/2),o=us(e.eye,i),a=2*o*n*1,h=2*o*r*1;return"global"===t.viewingMode?cd(t,s,a,h):Ku(t,s,a,h)}(t,t.state.camera,t.pointsOfInterest.centerOnContent.renderLocation);return p(e)?e:this._get("extent")}set extent(t){this.updatePropertyBeforeReady("extent",t)||(t?this.isCompatible(t)?this.setStateCamera(this.extentToCamera(t),{applyConstraints:!0})||kC.error("#extent=","Invalid extent",t):kC.error("#extent=","Extent has an incompatible spatial reference (extent: "+(t.spatialReference?t.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",t):kC.error("#extent=","Extent may not be null or undefined"))}get frustum(){const t=this.propertiesPool.get("frustum");return t.renderCoordsHelper=this.view.renderCoordsHelper,t.update(this.view.state.camera),t}get hasInitialView(){return!!this.view.get("map.initialViewProperties.viewpoint")}get scale(){if(this.ready){const t=this.view.pointsOfInterest.centerOnContent;return Pd(this.view,t.distance,t.location.latitude)}return this._get("scale")}set scale(t){this.updatePropertyBeforeReady("scale",t)||this.setStateCamera(this.scaleToCamera(t),{applyConstraints:!0})||kC.error("#scale=","Invalid scale",t)}get padding(){if(!this.ready)return this._get("padding");const t=this.view.state.camera,e=t.padding,i=t.pixelRatio,s=this._get("padding"),n=Math.round(e[0]/i),r=Math.round(e[1]/i),o=Math.round(e[2]/i),a=Math.round(e[3]/i);return null!=s&&s.top===n&&s.right===r&&s.bottom===o&&s.left===a?s:{top:n,right:r,bottom:o,left:a}}set padding(t){this.updatePropertyBeforeReady("padding",t)||(this.paddingToArray(t,this.view.state.camera.pixelRatio,QC),this.view.state.updateCamera((t=>t.padding=QC)))}paddingToArray(t,e,i){t?ms(i,t.top||0,t.right||0,t.bottom||0,t.left||0):ms(i,0,0,0,0);for(let t=0;t<4;t++)i[t]=Math.round(i[t]*e)}get screenCenter(){const t=this.padding;return Po((this.view.width-(t.left+t.right))/2+t.left,(this.view.height-(t.top+t.bottom))/2+t.top)}get viewpoint(){return this.ready?function(t,e,i=null){return w(i)&&(i=new Se),Zd(t,null,e.clone(),i)}(this.view,this.camera):this._get("viewpoint")}set viewpoint(t){if(!this.updatePropertyBeforeReady("viewpoint",t))if(t)if(this.isCompatible(t))this.setStateCamera(this.viewpointToCamera(t),{applyConstraints:!t.camera})||kC.error("#viewpoint=","Invalid viewpoint",t);else{const e=p(t.camera)?t.camera.position:t.targetGeometry,i=p(e)&&e.spatialReference;kC.error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",t)}else kC.error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?Ed(this.view,this.scale):this._get("zoom")}set zoom(t){this.updatePropertyBeforeReady("zoom",t)||this.setStateCamera(this.zoomToCamera(t),{applyConstraints:!0})||kC.error("#zoom=","Invalid zoom",t)}initialize(){this.handles.add([X(this.view,"state.events","before-camera-change",(t=>this.updateElevation(t.camera)))]),Mt(this.view.state,"camera",(t=>this.updateElevation(t)),!0),this.handles.add(St({prepare:()=>this.prepareFrame()})),this.handles.add(this.view.state.watch("cameraController",(()=>{this.cameraSetByUser=!0,this.handles.remove(YC)}))),this.handles.add(X(this.view,"state.events","camera-projection-changed",(()=>this.notifyChange("scale"))))}destroy(){this.deinit(),this.handles&&(this.handles.destroy(),this.handles=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null)}init(){this.constraintsManager=new VC({view:this.view}),this.prepareFrame();const t=this.getInitialProperties();this.cameraSetByUser=!1,this._set("ready",!0);for(const e of t)this.set(e.name,e.value);if(!this.cameraSetByUser){const t=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;t&&this.isCompatible(t)?this.setInitialView(t):2===this.view.state.viewingMode&&this.handles.add(Ct(this.view.basemapTerrain,"ready",(()=>{this.handles.remove(YC),this.setInitialView(this.view.dataExtent)})),YC)}}deinit(){this.cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this.cameraSetByUser=!1,this.handles.remove(YC),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null))}async goTo(t,e){const i={animate:!0,...e};return p(this.gotoOperation)&&this.gotoOperation.abort(i.animate),this.gotoOperation=new NC(t,i,this.view),this.view.resourceController.scheduler.stopFrame(),this.gotoOperation}debugSetCameraOnContent(){this.setStateCamera(Lu(this.view),{applyConstraints:!1})}step(t){const e=this.view.state,i=e&&this.view.state.cameraController;i&&(e.updateCamera((e=>{i.stepController(t,e)})),i.steppingFinished&&i.finishController())}cancelGoToOperation(){p(this.gotoOperation)&&(this.gotoOperation.abort(),this.gotoOperation=null)}getInitialProperties(){const t=new Set,e=[];for(const{propertyName:i,overrides:s}of WC){const n=t.has(i),r=this._isOverridden(i);!n&&r&&e.push({name:i,value:this._get(i)}),this._clearOverride(i),(n||r)&&s.forEach((e=>t.add(e)))}return e}setInitialView(t){if(w(t)||this.cameraSetByUser)return;if(t instanceof Pe)return void this.setStateCamera(bd(this.view,t),{applyConstraints:!1});if(t instanceof Se){if(t.targetGeometry instanceof g){const e=Rd(this.view,t.targetGeometry,0,.5,0);return void(p(e)&&this.setStateCamera(bd(this.view,e),{applyConstraints:!0}))}const e={applyConstraints:!t.camera},i=this.viewpointToCamera(t);return void this.setStateCamera(i,e)}const e=Rd(this.view,t,0,.5,0);p(e)&&this.setStateCamera(bd(this.view,e),{applyConstraints:!0})}updatePropertyBeforeReady(t,e){return!this.ready&&(this._override(t,e),e&&-1!==qC.indexOf(t)&&this._override("hasInitialView",!0),!0)}isCompatible(t){return!w(t)&&(t instanceof Se?this.isCompatible(t.camera?t.camera:t.targetGeometry):t instanceof Pe?this.isCompatible(t.position):t.spatialReference&&C(t.spatialReference,this.view.spatialReference))}getPreservingHeadingTilt(t=UC){return this.cameraSetByUser?(t.heading=this.camera.heading,t.tilt=this.camera.tilt):(t.heading=0,t.tilt=.5),t}centerPointAtDistanceToCamera(t,e,i=ZC){const{heading:s,tilt:n}=this.getPreservingHeadingTilt(),r=Dd(this.view,s,n,t,e,1);return w(r)?null:(i.copyFrom(this.view.state.camera),i.eye=r.eye,i.center=r.center,i.up=r.up,i)}centerToCamera(t){const e=this.view.pointsOfInterest.centerOnContent;return e.runTask(),this.centerPointAtDistanceToCamera(t,e.distance)}extentToCamera(t){const{heading:e,tilt:i}=this.getPreservingHeadingTilt(),s=Rd(this.view,t,e,i,1,HC);return p(s)?bd(this.view,s):null}scaleToCamera(t){if(null==t)return null;const e=this.view.pointsOfInterest.centerOnContent;e.runTask();const i=e.renderLocation,s=Sd(this.view,t,e.location.latitude);return this.centerPointAtDistanceToCamera(i,s)}zoomToCamera(t){return this.scaleToCamera(Id(this.view,t))}viewpointToCamera(t){return bd(this.view,qd(this.view,t))}setStateCamera(t,e){return!(w(t)||!this.view.state.stopActiveCameraController()||(this.cameraSetByUser=!0,e.doNotCancelGoToOperation||this.cancelGoToOperation(),this.view.state.updateCamera((i=>{e.positionAndOrientationOnly?(i.eye=t.eye,i.center=t.center,i.up=t.up):i.copyFrom(t),e.applyConstraints&&Qv(this.view,i)})),e.applyConstraints||(this.view.state.cameraController=new jC({view:this.view,desiredCamera:t})),0))}prepareFrame(){const{container:t,canvas:e}=this.view;if(!t||!e)return;p(this.updateDevicePixelRatio)&&this.updateDevicePixelRatio();const i=this.view.pixelRatio,s=Math.round(t.clientWidth*i),n=Math.round(t.clientHeight*i);if(0!==s&&0!==n&&(e.width===s&&e.height===n||(e.width=s,e.height=n),this.view.state)){const t=this.view.state.camera;t.fullWidth===s&&t.fullHeight===n&&t.pixelRatio===i||(ZC.copyFrom(t),ZC.pixelRatio!==i&&(this.paddingToArray(this.padding,i,QC),ZC.padding=QC),ZC.fullWidth=s,ZC.fullHeight=n,ZC.pixelRatio=i,this.view.state.camera=ZC)}}updateElevation(t){const e=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=this.view.renderCoordsHelper.getAltitude(t.eye),s=e?zu(this.view,t.eye):0;t.relativeElevation=i-s,t.distanceFromSurface=this.view.pointsOfInterest?this.view.pointsOfInterest.centerOnSurfaceFrequent.distance:-1}};r([o({type:Pe,dependsOn:["view.state.camera","ready"]})],BC.prototype,"camera",null),r([o({type:Pe,dependsOn:["view.state.contentCamera","ready"]})],BC.prototype,"contentCamera",null),r([o({type:m})],BC.prototype,"center",null),r([o({type:g})],BC.prototype,"extent",null),r([o({readOnly:!0})],BC.prototype,"frustum",null),r([o({readOnly:!0})],BC.prototype,"hasInitialView",null),r([o({readOnly:!0,type:Boolean})],BC.prototype,"ready",void 0),r([o({type:Number})],BC.prototype,"scale",null),r([o()],BC.prototype,"padding",null),r([o({readOnly:!0})],BC.prototype,"screenCenter",null),r([o({constructOnly:!0})],BC.prototype,"view",void 0),r([o({type:Se})],BC.prototype,"viewpoint",null),r([o({type:Number})],BC.prototype,"zoom",null),r([o({constructOnly:!0})],BC.prototype,"updateDevicePixelRatio",void 0),BC=r([a("esri.views.3d.state.ViewStateManager")],BC);const GC=BC,qC=["camera","viewpoint","extent","scale","center","zoom"],WC=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],UC={heading:0,tilt:0},HC=new Pe,ZC=new hr,QC=sa(),YC="pending-initial-view";class XC{constructor(t,e,i){this.viewingMode=t,this._forEachLayer=e,this.view=i,this.externalIntersectionHandlers=new pt,this.tolerance=Jn.DEFAULT_TOLERANCE,this.tmpRay=Wo(),this.validateHUDIntersector=new Jn(this.viewingMode),this.validateHUDIntersector.options.hud=!1}intersectScreen(t,e){return this.intersectRay(this._getPickRay(t,this.tmpRay),$C(this.viewingMode),e)}intersectScreenFreePointFallback(t,e){return this.intersectRayFreePointFallback(this._getPickRay(t,this.tmpRay),e)}intersectRayFreePointFallback(t,e){return this.intersectRay(t,$C(this.viewingMode),e)||this._intersectRayFreePointLocal(t,e)}intersectRay(t,e,i,s){return e.options.selectionMode=!1,e.options.store=0,this.computeIntersection(t,e,s),!!e.results.min&&e.results.min.getIntersectionPoint(i)}getCenterRayWithSubpixelOffset(t,e,i=.5,s=.5){return t.getRenderCenter(iM,i,s),iM[0]+=.0466,iM[1]-=.0123,$l(t,iM,e)}intersectIntersectorScreen(t,e,i){this.computeIntersection(this._getPickRay(t,this.tmpRay),e,i)}intersectToolIntersectorScreen(t,e,i){const s=this._getPickRay(t,this.tmpRay);this.intersectToolIntersectorRay(s,e,i)}intersectToolIntersectorRay(t,e,i){e.options.selectionMode=!0,this.computeIntersection(t,e,i);const s=e.results.min;this.view.basemapTerrain&&this.view.basemapTerrain.opaque||s.hasIntersectionPoint&&"TerrainRenderer"!==s.intersector||(e.options.selectionMode=!1,this.computeIntersection(t,e,i))}setTolerance(t=Jn.DEFAULT_TOLERANCE){this.tolerance=t}addIntersectionHandler(t){this.externalIntersectionHandlers.push(t),this.externalIntersectionHandlers.sort(((t,e)=>"Terrain"===t.type?1:"Terrain"===e.type?-1:0))}removeIntersectionHandler(t){this.externalIntersectionHandlers.removeUnordered(t),this.externalIntersectionHandlers.sort(((t,e)=>"Terrain"===t.type?1:"Terrain"===e.type?-1:0))}_getPickRay(t,e){return Kl(this.view.state.camera,t,e)}_intersectRayFreePointLocal(t,e){if(2!==this.viewingMode||w(t))return!1;const i=this.view.renderDataExtent;if(w(i))return Ki(e,t.origin,is(nl.get(),t.direction)),!0;const s={x:i.xmax-i.xmin,y:i.ymax-i.ymin,z:8*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},n=Math.max(s.x,s.y,s.z);if(0===n)return Ki(e,t.origin,is(nl.get(),t.direction)),!0;const r=this.view.state.camera,o=Math.max(0,i.xmin-r.eye[0],r.eye[0]-i.xmax),a=Math.max(0,i.ymin-r.eye[1],r.eye[1]-i.ymax),h=Math.sqrt(o*o+a*a),l=Math.abs(r.relativeElevation)+Number.MIN_VALUE,c=Math.max(0,Math.log(n/l))**2;let u=n/Math.max(1,c);u=Math.max(u,Math.min(h,n));const d=Yi(nl.get(),t.direction,u/Xi(t.direction));return Ki(e,t.origin,d),!0}intersectElevationFromScreen(t,e,i=0,s=null){return this.intersectElevation(this._getPickRay(t,this.tmpRay),e,i,s)}intersectElevation(t,e,i=0,s=null){if(w(t))return null;const n=p(e)?e.mode:"absolute-height",r=p(e)?f(e.offset,0):0,o="on-the-ground"!==n?r+i:0,a=o/this.view.renderCoordsHelper.unitInMeters;if("absolute-height"===n){if(this.view.renderCoordsHelper.intersectInfiniteManifold(t,o,eM)){const t=this.view.computeMapPointFromVec3d(eM);return t.z-=r,t}return null}const h=this.view.state.camera,l=To(nl.get());h.projectToRenderScreen(t.origin,l);const c=new JC(null,this._forEachLayer),u=this.view.slicePlane,d=p(u)?pc(u):null,g=new Jn(this.viewingMode);g.options.store=0,g.options.verticalOffset=a;const m=t.origin,v=Ki(nl.get(),m,t.direction);g.reset(m,v),g.point=l,g.camera=h,g.filterPredicate=null;const y=p(s)?"type"in s&&"graphics"===s.type?t=>t.metadata.layerUid!==s.uid:t=>t.metadata.graphicUid!==s.uid:null;switch(n){case"relative-to-scene":g.intersect(c.layers,l,h,this.tolerance,null,(t=>(w(y)||y(t))&&t.metadata&&t.metadata.isElevationSource)),this.externalIntersectionHandlers.forAll((t=>{"I3S"!==t.type&&"Terrain"!==t.type||t.intersect(g,t.slicePlane?d:null,g.rayBeginPoint,g.rayEndPoint,l)}));break;case"on-the-ground":case"relative-to-ground":this.externalIntersectionHandlers.forAll((t=>{t.isGround&&t.intersect(g,t.slicePlane?d:null,g.rayBeginPoint,g.rayEndPoint,l)}))}if(g.results.min.getIntersectionPoint(eM)){const t=this.view.computeMapPointFromVec3d(eM);return t.z=i,t}return null}computeIntersection(t,e,i){if(w(t))return;const s=this.view.state.camera,n=To(nl.get());s.projectToRenderScreen(t.origin,n);const r=new JC(i,this._forEachLayer);e.options.selectOpaqueTerrainOnly=!i||!("include"in i||"exclude"in i);const o=t.origin,a=Ki(nl.get(),t.origin,t.direction);e.reset(o,a),e.intersect(r.layers,n,s,this.tolerance);const h=this.view.slicePlane,l=p(h)?pc(h):null;e.intersect(r.sliceableLayers,n,s,this.tolerance,l);const c=i&&(i.requiresGroundFeedback||i.enableDraped);this.externalIntersectionHandlers.forAll((t=>{e.options.isFiltered=!r.filterLayerUid(t.intersectionHandlerId),(t.isGround&&c||!e.options.isFiltered)&&t.intersect(e,t.slicePlane?l:null,o,a,n)}));const u=nl.get();if(i&&i.enableDraped&&e.results.ground.getIntersectionPoint(u)){const t=this.view.basemapTerrain.overlayManager.renderer,i=this.view.renderCoordsHelper.spatialReference,s=nl.get();this.view.renderCoordsHelper.fromRenderCoords(u,s,this.view.spatialReference),s[2]=f(this.view.elevationProvider.getElevation(u[0],u[1],u[2],i,"ground"),0),t.intersect(e,s,(t=>r.filterRenderGeometry(t)))}e.sortResults();const d=e.results.hud;if(d.hasIntersectionPoint){const t=To(nl.get()),i=nl.get(),n=nl.get();this.unprojectHUDResultRay(d.center,t,i,n);const o=cs(d.center,i)/cs(i,n)*.99;this.validateHUDIntersector.reset(i,n),this.validateHUDIntersector.intersect(r.layers,t,s,this.tolerance),this.validateHUDIntersector.intersect(r.sliceableLayers,t,s,this.tolerance,l),this.externalIntersectionHandlers.forAll((e=>{r.filterLayerUid(e.intersectionHandlerId)&&e.intersect(this.validateHUDIntersector,e.slicePlane?l:null,i,n,t)}));const a=this.validateHUDIntersector.results.min;(null==a.dist||o<=a.dist)&&(e.results.min.copyFrom(d),e.results.all.splice(0,0,d))}}unprojectHUDResultRay(t,e,i,s){const n=this.view.state.camera;n.projectToRenderScreen(t,e);const r=To(nl.get());r[0]=e[0],r[1]=e[1],r[2]=0,n.unprojectFromRenderScreen(r,i),r[2]=1,n.unprojectFromRenderScreen(r,s)}}let KC;function $C(t){return KC||(KC=new Jn(t)),KC.viewingMode=t,KC}class JC{constructor(t,e){this.layers=new Array,this.sliceableLayers=new Array,this.include=null==t?void 0:t.include,this.exclude=null==t?void 0:t.exclude,e((t=>{t.isPickable&&this.filterLayerUid(t.apiLayerUid)&&(t.isSliceable?this.sliceableLayers:this.layers).push(t)}))}filterLayerUid(t){const{include:e,exclude:i}=this;return w(t)?null==e&&null==i:(null==e||e.has(t))&&(null==i||!i.has(t))}filterRenderGeometry(t){return this.filterLayerUid(t.layerUid)}}function tM(t){return"object"==typeof t&&"intersect"in t}const eM=js(),iM=So();let sM=class extends(G.EventedMixin(T)){constructor(t){super(t),this.im=new Array,this.ground=new Array,this.scene=new Array,this.handles=new Map,this.lastElevationQuery=null,this.elevationCacheEnabled=!1}destroy(){this._elevationQuery=Y(this._elevationQuery)}get elevationQuery(){return w(this._elevationQuery)&&(this._elevationQuery=new Il(this.view.resourceController.scheduler,this.view.spatialReference,(()=>this.view.map&&this.view.map.ground),{maximumAutoTileRequests:4})),this._elevationQuery}enableElevationCache(t){t||(this.lastElevationQuery=null),this.elevationCacheEnabled=t}getElevation(t,e,i,s,n){if(this.elevationCacheEnabled&&null!=this.lastElevationQuery){const r=this.lastElevationQuery;if(t===r.x&&e===r.y&&i===r.z&&s.equals(r.spatialReference)&&n===r.queryContext)return r.result}let r=null;return r=nM(r,this.im,t,e,i,s,n),w(r)&&(r=nM(r,this.ground,t,e,i,s,n)),"scene"===n&&(r=nM(r,this.scene,t,e,i,s,n)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:t,y:e,z:i,spatialReference:s,queryContext:n,result:r}),r}queryElevation(t,e,i,s,n,r=null,o=0){const a=x();return this.elevationQuery.queryElevation(t,e,r,o).then((r=>{"scene"===n&&(r=nM(r,this.scene,t,e,i,s,n)),a.resolve(r)})).catch((r=>{F(r)?a.reject(r):a.resolve(this.getElevation(t,e,i,s,n))})),a.promise}register(t,e){this.handles.set(e,e.on("elevation-change",(t=>this.emit("elevation-change",t)))),this[t].push(e)}unregister(t){this.handles.has(t)&&(this.handles.get(t).remove(),this.handles.delete(t));for(const e of[this.im,this.ground,this.scene]){const i=e.indexOf(t);i>-1&&e.splice(i,1)}}};function nM(t,e,i,s,n,r,o){for(const a of e){const e=a.getElevation(i,s,n,r,o);p(e)&&(t=p(t)?Math.max(e,t):e)}return t}r([o({constructOnly:!0})],sM.prototype,"view",void 0),r([o({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],sM.prototype,"spatialReference",void 0),sM=r([a("esri.views.3d.support.CombinedElevationProvider")],sM);class rM{static isValidProfile(t){return t in rM.profiles}static getDefaultProfile(){return dt("trident")||dt("esri-iPhone")?"low":"medium"}static apply(t,e){const i=rM.profiles[t];e.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,e.graphics3D.maxTotalNumberOfPrimitives=i.graphics3D.maxTotalNumberOfPrimitives,e.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,e.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor,e.graphics3D.snapshotAvailable=i.graphics3D.snapshotAvailable;{const t=e.sceneService["3dObject"],s=i.sceneService["3dObject"];t.lodFactor=s.lodFactor,t.lodCrossfadeinDuration=s.lodCrossfadeinDuration,t.lodCrossfadeoutDuration=s.lodCrossfadeoutDuration,t.lodCrossfadeUncoveredDuration=s.lodCrossfadeUncoveredDuration}e.sceneService.point.lodFactor=i.sceneService.point.lodFactor,e.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,e.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,e.sceneService.uncompressedTextureDownsamplingEnabled=i.sceneService.uncompressedTextureDownsamplingEnabled,e.tiledSurface.lodBias=i.tiledSurface.lodBias,e.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,e.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,e.tiledSurface.textureFadeDuration=i.tiledSurface.textureFadeDuration,e.antialiasingEnabled=i.antialiasingEnabled,e.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,e.highQualityTransparency=i.highQualityTransparency,e.memoryLimit=i.memoryLimit,e.additionalCacheMemory=i.additionalCacheMemory,e.frameRate=i.frameRate,e.maximumRenderResolution=i.maximumRenderResolution,e.maximumPixelRatio=i.maximumPixelRatio}}function oM(){const t=!!dt("esri-mobile"),e=!!dt("ios");return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxTotalNumberOfPrimitives:85e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1},sceneService:{"3dObject":{lodFactor:.2,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:0},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,reduceTileLevelDifferences:!1,textureFadeDuration:0},antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,memoryLimit:200,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:t?.8:1,polylineLodFactor:t?1.2:1.5,snapshotAvailable:!e},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:t},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!dt("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:t?600:750,additionalCacheMemory:t?0:150,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:t?1.2:2,polylineLodFactor:t?1.2:2,snapshotAvailable:!e},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!dt("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:t?900:1500,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:t?null:4096,maximumPixelRatio:t?1:null}}}rM.debug={reset(){const t=oM();for(const e in t)rM.profiles[e]=t[e]}},(rM||(rM={})).profiles=oM();const aM=rM;let hM=class extends T{constructor(){super(...arguments),this.color=new Ni([0,255,255]),this.haloColor=null,this.haloOpacity=1,this.fillOpacity=.25,this.shadowOpacity=.4,this.shadowColor=new Ni([0,0,0]),this.shadowDifference=.2}static toEngineOptions(t){const e=Ni.toUnitRGBA(t.color),i=p(t.haloColor)?Ni.toUnitRGBA(t.haloColor):e,s=Ni.toUnitRGBA(t.shadowColor);return{color:vc(e[0],e[1],e[2],e[3]),haloColor:vc(i[0],i[1],i[2],i[3]),haloOpacity:t.haloOpacity,haloOpacityOccluded:.25*t.haloOpacity,fillOpacity:t.fillOpacity,fillOpacityOccluded:.25*t.fillOpacity,shadowOpacity:t.shadowOpacity,shadowColor:vc(s[0],s[1],s[2],s[3]),occludedShadowOpacity:t.shadowOpacity*(1-t.shadowDifference)}}};r([o({type:Ni})],hM.prototype,"color",void 0),r([o({type:Ni})],hM.prototype,"haloColor",void 0),r([o()],hM.prototype,"haloOpacity",void 0),r([o()],hM.prototype,"fillOpacity",void 0),r([o()],hM.prototype,"shadowOpacity",void 0),r([o({type:Ni})],hM.prototype,"shadowColor",void 0),r([o()],hM.prototype,"shadowDifference",void 0),hM=r([a("esri.views.3d.support.HighlightOptions")],hM);const lM=hM;class cM{constructor(t,e){this.spatialReference=e,this.unitInMeters=Xr(this.spatialReference,Qr(this.spatialReference).metersPerDegree),this._geometryServiceURLPromise=wc(t&&t.get("portalItem")).catch((()=>{throw new n("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")}))}async toGeographic(t){const e=await this._geometryServiceURLPromise;let i,s=!0;Array.isArray(t[0])&&"number"!=typeof t[0]?i=t:(i=[t],s=!1);const n=i.map((t=>t instanceof m?t:new m(t,this.spatialReference))),r=new xc({geometries:n,outSpatialReference:d.WGS84}),o=(await bc(e,r)).map((t=>"point"===t.type?[t.x,t.y]:void 0));return s?o:o[0]}}let uM=class extends T{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxTotalNumberOfPrimitives=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1}};r([o()],uM.prototype,"minTotalNumberOfFeatures",void 0),r([o()],uM.prototype,"maxTotalNumberOfFeatures",void 0),r([o()],uM.prototype,"maxTotalNumberOfPrimitives",void 0),r([o()],uM.prototype,"snapshotAvailable",void 0),r([o()],uM.prototype,"polygonLodFactor",void 0),r([o()],uM.prototype,"polylineLodFactor",void 0),uM=r([a("esri.views.3d.support.QualitySettings.Graphics3DSettings")],uM);let dM=class extends T{constructor(){super(...arguments),this.lodFactor=1}};r([o()],dM.prototype,"lodFactor",void 0),dM=r([a("esri.views.3d.support.QualitySettings.LoDFactorSettings")],dM);let pM=class extends dM{constructor(){super(...arguments),this.lodCrossfadeinDuration=0,this.lodCrossfadeoutDuration=0,this.lodCrossfadeUncoveredDuration=0}};pM=r([a("esri.views.3d.support.QualitySettings.LoDFactor3DObjectSettings")],pM);let fM=class extends T{constructor(){super(...arguments),this["3dObject"]=new pM,this.point=new dM,this.integratedMesh=new dM,this.pointCloud=new dM,this.uncompressedTextureDownsamplingEnabled=!1}};r([o({type:pM})],fM.prototype,"3dObject",void 0),r([o({type:dM})],fM.prototype,"point",void 0),r([o({type:dM})],fM.prototype,"integratedMesh",void 0),r([o({type:dM})],fM.prototype,"pointCloud",void 0),r([o()],fM.prototype,"uncompressedTextureDownsamplingEnabled",void 0),fM=r([a("esri.views.3d.support.QualitySettings.SceneServiceSettings")],fM);let gM=class extends T{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.reduceTileLevelDifferences=!0,this.textureFadeDuration=500}};r([o()],gM.prototype,"lodBias",void 0),r([o()],gM.prototype,"angledSplitBias",void 0),r([o()],gM.prototype,"reduceTileLevelDifferences",void 0),r([o()],gM.prototype,"textureFadeDuration",void 0),gM=r([a("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],gM);let mM=class extends T{constructor(){super(...arguments),this.graphics3D=new uM,this.sceneService=new fM,this.tiledSurface=new gM,this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0}};r([o({type:uM})],mM.prototype,"graphics3D",void 0),r([o({type:fM})],mM.prototype,"sceneService",void 0),r([o({type:gM})],mM.prototype,"tiledSurface",void 0),r([o()],mM.prototype,"antialiasingEnabled",void 0),r([o()],mM.prototype,"physicallyBasedRenderingEnabled",void 0),r([o()],mM.prototype,"highQualityTransparency",void 0),r([o()],mM.prototype,"memoryLimit",void 0),r([o()],mM.prototype,"additionalCacheMemory",void 0),r([o()],mM.prototype,"frameRate",void 0),r([o()],mM.prototype,"maximumRenderResolution",void 0),r([o()],mM.prototype,"maximumPixelRatio",void 0),mM=r([a("esri.views.3d.support.QualitySettings.QualitySettings")],mM);const vM=mM;class yM{constructor(t,e,i,s){this.viewingMode=t,this.spatialReference=e,this.unitInMeters=i,this.coordinateSystem=s,this._coordinateSystem=function(t){const{value:e,operations:i}=t;return{operations:i,value:i.create(e)}}(s)}set extent(t){t&&function(t,e,i){t.operations.setExtent(t.value,e,i.value)}(this.coordinateSystem,t,this.coordinateSystem)}getAltitude(t){return function(t,e){return t.operations.altitudeAt(t.value,e)}(this.coordinateSystem,t)}setAltitude(t,e,i=t){return rf(this.coordinateSystem,i,e,t)}setAltitudeOfTransformation(t,e){!function(t,e,i,s){e!==s&&io(s,e),ds(af,s[12],s[13],s[14]),rf(t,af,i,af),s[12]=af[0],s[13]=af[1],s[14]=af[2]}(this.coordinateSystem,e,t,e)}worldUpAtPosition(t,e){return function(t,e,i){return t.operations.axisAt(t.value,e,2,i)}(this.coordinateSystem,t,e)}worldBasisAtPosition(t,e,i){return function(t,e,i,s){return t.operations.axisAt(t.value,e,i,s)}(this.coordinateSystem,t,e,i)}basisMatrixAtPosition(t,e){const i=this.worldBasisAtPosition(t,0,nl.get()),s=this.worldBasisAtPosition(t,1,nl.get()),n=this.worldBasisAtPosition(t,2,nl.get());return lo(e,i[0],i[1],i[2],0,s[0],s[1],s[2],0,n[0],n[1],n[2],0,0,0,0,1),e}intersectManifoldClosestSilhouette(t,e,i){return of(this.coordinateSystem,e,this._coordinateSystem),function(t,e,i){t.operations.intersectRayClosestSilhouette(t.value,e,i)}(this._coordinateSystem,t,i),i}intersectManifold(t,e,i){of(this.coordinateSystem,e,this._coordinateSystem);const s=nl.get();return function(t,e,i){return t.operations.intersectRay(t.value,e,i)}(this._coordinateSystem,t,s)?$i(i,s):null}intersectInfiniteManifold(t,e,i){if(1===this.viewingMode)return this.intersectManifold(t,e,i);of(this.coordinateSystem,e,this._coordinateSystem);const s=this._coordinateSystem.value,n=nl.get();return Bl(s.plane,t,n)?$i(i,n):null}toRenderCoords(t,e,i){return br(t)?Ee(t,e,this.spatialReference):Ie(t,e,i,this.spatialReference)}fromRenderCoords(t,e,i=null){return br(e)?(p(i)&&(e.spatialReference=i),We(t,this.spatialReference,e)):e instanceof d?Ve(t,this.spatialReference,e):Ie(t,this.spatialReference,e,i)?e:null}static create(t,e){switch(t){case 2:return new yM(2,e,Xr(e),sf(Do,_o([0,0,0],[nf,0,0],[0,nf,0])));case 1:return new yM(1,e,1,function(t){return sf(Vo,Io(0,0,0,Qr(t).radius))}(e))}}}const wM=(()=>{const t=new Array;return t[0]=10,t[1]=10,t[2]=10,t[3]=10,t[4]=5,t})(),xM=30;function bM(t){return"function"==typeof t.getUsedMemory}const CM=y.getLogger("esri.views.3d.support.MemoryController");class MM{constructor(t){this._view=t,this.events=new G,this.minQuality=.1,this._maxMemory=500,this._additionalCacheMemory=100,this._quality=1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryUsed=0,this._memoryPredicted=0,this._cacheStorage=new Cc,this._numQualityChanges=0,this._updating=!1}destroy(){this.events=null,this._cacheStorage.destroy()}newCache(t,e){return new Mc(t,this._cacheStorage,e)}set maxMemory(t){null!=t&&t>0&&(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<t&&this._updateQuality(1),this._maxMemory=t)}get maxMemory(){return this._maxMemory}set additionalCacheMemory(t){null!=t&&t>=0&&(this._additionalCacheMemory=t)}disableMemCache(){this._additionalCacheMemory=-4096}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._memoryUsed}resetStableQuality(){this._stableQuality=0}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let t=this._layersUpdating();this._memoryPredicted<.6&&this._canFastRecover?(this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1)):t?(this._memoryPredicted>1.1||this._memoryUsed>1)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1)):(this._downscaleMemoryUsed=0,this._memoryUsed>1?(this._stableQuality=0,this._canFastRecover=!1,t=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted):this._stableQuality!==this._quality&&(this._memoryUsed<.75&&this._quality<1?(this._stableQuality=this._quality,t=this._updateQuality(this._quality+.05)):this._quality<1&&(this._canFastRecover=!0))),this.updating!==t&&(this._updating=t,this.events.emit("updating-changed",this.updating))}_updateQuality(t){return(t=Math.min(Math.max(t,this.minQuality),1))!==this._quality&&(this._quality=t,this.events.emit("quality-changed",this._quality),++this._numQualityChanges,!0)}_layersUpdating(){return this._view.allLayerViews.some((t=>!!t.updating))}_updateMemory(){let t=0,e=0;this._view.basemapTerrain&&this._view.basemapTerrain.getUsedMemory&&(t+=this._view.basemapTerrain.getUsedMemory());const i=this._view._stage&&this._view._stage.renderView&&this._view._stage.renderView.edgeView;p(i)&&(t+=i.usedMemory),this._view.allLayerViews&&this._view.allLayerViews.forEach((i=>{if(bM(i)){const s=i.ignoresMemoryFactor()?this._quality:1;t+=i.getUsedMemory()*s,e+=i.getUnloadedMemory()*s}}));const s=null==this._warnMemoryUsage||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),n=1048576*this._maxMemory;if(t>n&&s){this._warnMemoryUsage=t;const i=t=>(t/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",s=Math.round(100*this._quality);CM.warn(`Memory Limit exceeded! Limit: ${i(n)} Current: ${i(t)} Projected: ${i(t+e)} Quality: ${s}%`)}this._memoryUsed=t/n,this._memoryPredicted=(t+e)/n,this._cacheStorage.maxSize=Math.max(0,n-t+1048576*this._additionalCacheMemory),this.events.emit("memory-used",this._memoryUsed)}get test(){const t=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const e=t._numQualityChanges;return t._numQualityChanges=0,e}}}}let SM=class extends T{constructor(){super(...arguments),this.updating=!1}};var PM;r([o({readOnly:!0})],SM.prototype,"updating",void 0),SM=r([a("esri.views.3d.support.ResourceController")],SM),function(t){let e=class extends SM{constructor(){super(...arguments),this._scheduler=null,this._memoryController=null,this._streamDataLoader=null,this._cameraChangeTime=0,this._handles=new E,this._frameTask=null,this._scheduleTask=go,this._state=2}initialize(){this._cameraChangeTime=this.now(),this._scheduler=mo(this.now),this._memoryController=function(t){return new MM(t)}(this.view),this._streamDataLoader=new si,this._streamDataLoader.setup(30,wM,this._scheduler),this._handles.add([this.view.watch("state.camera",((t,e)=>this._cameraChangedHandler(t,e)),!0),this.view.watch("stationary",(()=>this._stationaryChangedHandler())),this._memoryController.events.on("updating-changed",(()=>this.notifyChange("updating")))]),this._frameTask=St({update:t=>this.frame(t)}),this._scheduleTask=this._scheduler.registerTask(po.RESOURCE_CONTROLLER)}destroy(){this._handles=Y(this._handles),this._scheduleTask.remove(),this._frameTask=J(this._frameTask),this._streamDataLoader=Y(this._streamDataLoader),this._memoryController=Y(this._memoryController),this._scheduler=Y(this._scheduler)}get updating(){var t,e;return!!(null!=(t=this._memoryController)&&t.updating||null!=(e=this._streamDataLoader)&&e.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}schedule(t,e,i){return this._scheduleTask.schedule(t,e,i)}createStreamDataRequester(t){const e=this._streamDataLoader;return{request:(i,s,n)=>e.request(i,s,t,n),get busy(){return!e.hasDownloadSlots(t)}}}frame(t){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(Pt(t.deltaTime)),!this._scheduler)||(this._updateState(),this._scheduler.state=this._state,this._scheduler.updateBudget(t)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())}_cameraChangedHandler(t,e){t&&e&&t.almostEquals(e)||(this._cameraChangeTime=this._scheduler.now,this._updateState(),this._scheduler.state=this._state)}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}_updateState(){this.view.animation?this._state=0:this.view.interacting?this._state=1:(0===this._state&&(this._cameraChangeTime=0),this._state=this._scheduler.now-this._cameraChangeTime<=i?1:2)}get test(){return{getQueueStats:t=>this._streamDataLoader.test.loadQueue.getStatsForType(t),state:this._state}}};r([o({constructOnly:!0})],e.prototype,"view",void 0),r([o({constructOnly:!0})],e.prototype,"now",void 0),r([o()],e.prototype,"_scheduler",void 0),r([o()],e.prototype,"_memoryController",void 0),r([o()],e.prototype,"_streamDataLoader",void 0),r([o({readOnly:!0})],e.prototype,"updating",null),e=r([a("esri.views.3d.support.ResourceController")],e),t.ResourceController=e;const i=300}(PM||(PM={}));class TM{constructor(t,e){if(this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=t.layer,this.memory=ni(t)?e.basemapTerrain.getUsedMemoryForLayerView(t):t.getUsedMemory(),function(t){return"performanceInfo"in t}(t)){const e=t.performanceInfo;this.displayedNumberOfFeatures=e.displayedNumberOfFeatures,this.maximumNumberOfFeatures=e.maximumNumberOfFeatures,this.totalNumberOfFeatures=e.totalNumberOfFeatures}}}class AM{constructor(t){this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array;const e=t.resourceController.memoryController;this.totalMemory=1048576*e.maxMemory,this.usedMemory=Math.round(e.usedMemory*this.totalMemory),this.quality=e.memoryFactor,this.load=t.resourceController.scheduler.load,this.terrainMemory=t.basemapTerrain?t.basemapTerrain.getUsedMemory():0;const i=t._stage&&t._stage.renderView&&t._stage.renderView.edgeView;this.edgesMemory=p(i)?i.usedMemory:0,t.allLayerViews.items.forEach((e=>{(bM(e)||ni(e))&&this.layerPerformanceInfos.push(new TM(e,t))})),this.layerPerformanceInfos.sort(((t,e)=>e.memory-t.memory))}}class _M extends ge{constructor(t,e,i,s){super(e,s),this._streamDataRequester=t,this._parameters=i}async fromUrl(t,e,i){mt(i);const s=p(i)&&i.signal,n=this.makeUid(t,e);let r=this._textureRequests.get(n);if(!r){const i=new AbortController,s=this._streamDataRequester.request(t,"image",{uid:n,signal:i.signal});r={referenceCount:0,texture:null,textureAsync:null,abortController:i},this._textureRequests.set(n,r),r.textureAsync=s.then((async i=>{const s=this._createTexture(t,i,e);return r.texture=s,r.abortController=null,this._stage.add(s),await this._stage.load(s),{uid:n,texture:s,release:()=>this._release(n)}}),(t=>{throw r.abortController=null,t}))}return r.referenceCount++,new Promise(((t,e)=>{yt(s,(()=>{e(ut())})),r.textureAsync.then(t,e)})).catch((t=>{throw this._release(n),t}))}_createTexture(t,e,i){const s={...this._parameters,powerOfTwoResizeMode:2};if(Tt(t)){if(i||0===e.width&&0===e.height){const t=e.width?e.height/e.width:1;i=i||64,t>1?(e.width=Math.round(i/t),e.height=i):(e.width=i,e.height=Math.round(i*t))}this._stage.renderView&&this._stage.renderView.renderingContext.driverTest.svgAlwaysPremultipliesAlpha&&(s.preMultiplyAlpha=!1)}return s.width=e.width,s.height=e.height,new ah(e,s)}}class DM{constructor(t){this.textures=null,this.streamDataRequester=null,this.graphicsOwners=[],this.screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this.viewState=t.viewState,this.view=t.view,this.pointsOfInterest=t.pointsOfInterest,this.objectResourceCache=t.objectResourceCache,this.streamDataRequester=t.resourceController.createStreamDataRequester(4),this.textures=new _M(this.streamDataRequester,t.view._stage,{preMultiplyAlpha:!0,wrap:{s:33071,t:33071}},t.resourceController.scheduler);const e=Qr(this.view.spatialReference).radius;this.screenSizePerspectiveSettings=hh(t.viewingMode,e),this.screenSizePerspectiveSettingsLabels=lh(t.viewingMode,e)}destroy(){this.textures.destroy(),this.textures=null,this.streamDataRequester=null}addGraphicsOwner(t){if(!t)return{remove(){}};this.graphicsOwners.push(t);const e="layer"in t?t.watch("layer.screenSizePerspectiveEnabled",(()=>this.updateScreenSizePerspectiveEnabled())):null;return this.updateScreenSizePerspectiveEnabled(),{remove:()=>{e&&(e.remove(),At(this.graphicsOwners,t),this.updateScreenSizePerspectiveEnabled())}}}updateScreenSizePerspectiveEnabled(){const t=this.graphicsOwners.some((t=>!0===t.get("layer.screenSizePerspectiveEnabled")));if(t&&!this.screenSizePerspectiveHandles){this.screenSizePerspectiveHandles=new E;const t=()=>this.updateScreenSizePerspectiveSettings();this.screenSizePerspectiveHandles.add([this.pointsOfInterest.centerOnSurfaceInfrequent.watch("distance",t,!0),this.viewState.events.on("camera-projection-changed",t)]),this.updateScreenSizePerspectiveSettings()}else!t&&this.screenSizePerspectiveHandles&&(this.screenSizePerspectiveHandles.destroy(),this.screenSizePerspectiveHandles=null)}updateScreenSizePerspectiveSettings(){OM.distance=this.pointsOfInterest.centerOnSurfaceInfrequent.distance,OM.fovY=this.viewState.camera.fovY,this.screenSizePerspectiveSettings.update(OM),this.screenSizePerspectiveSettingsLabels.update(OM),this.view._stage.renderView.requestRender()}}const OM={distance:0,fovY:0};class RM{constructor(t,e,i=""){this.graphics=t,this._symbol=new qi({symbolLayers:[new Wi({material:{color:e},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new Ui({text:i,halo:{color:"white",size:1/.75},material:{color:e},size:12})]})}show(t,e){if(w(e))return;this.hide();const i=new m({x:t[0],y:t[1],z:t[2],spatialReference:e});this._graphic=new on({geometry:i,symbol:this._symbol}),this.graphics.add(this._graphic)}hide(){p(this._graphic)&&(this.graphics.remove(this._graphic),this._graphic=null)}}let FM=class extends T{constructor(t){super(t),this.handles=new E}destroy(){this.handles.destroy()}};r([o({constructOnly:!0})],FM.prototype,"renderCoordsHelper",void 0),r([o({constructOnly:!0})],FM.prototype,"surface",void 0),r([o({constructOnly:!0})],FM.prototype,"state",void 0),FM=r([a("esri.views.3d.support.PointOfInterest")],FM);const zM=Array;let LM=class extends FM{constructor(t){super(t),this._dirty=!1,this._propertiesPool=new El({location:m,renderLocation:zM},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.cameraName="camera",this.renderLocation=js(),this.tmpPoint=new m}initialize(){if(this.scheduler&&this.handles.add(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const t=()=>this._setDirty();this.handles.add(X(this.map,"ground.layers","change",t,t,t))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool.destroy(),this._propertiesPool=null}get _camera(){return this.state[this.cameraName]}get location(){const t=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,t,this.state.spatialReference),t}get scale(){const t=this._camera,e=cs(t.eye,this.renderLocation);return Pd({renderCoordsHelper:this.renderCoordsHelper,state:{camera:t}},e,0)}get updating(){return this._dirty||null!=this._pendingElevationQueryController}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const t=this._pendingElevationQueryController;t&&(this._pendingElevationQueryController=null,t.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map||!this.map.ground)return void this._updateSurfaceAltitude(0);this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this.tmpPoint,this.state.spatialReference);let t=new AbortController;this.map.ground.queryElevation(this.tmpPoint,{signal:t.signal,cache:this.cache}).then((t=>this._updateSurfaceAltitude(t.geometry.z))).catch((t=>{F(t)||this._updateSurfaceAltitude(0)})).catch((()=>{})).then((()=>{this._pendingElevationQueryController===t&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),t=null})),this._pendingElevationQueryController=t}_updateSurfaceAltitude(t){this._estimatedSurfaceAltitude!==t&&(this._estimatedSurfaceAltitude=t,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(EM,this._estimatedSurfaceAltitude,this._camera.eye),Ss(this._get("renderLocation"),EM)||this._set("renderLocation",$i(this._propertiesPool.get("renderLocation"),EM))}};r([o({constructOnly:!0})],LM.prototype,"scheduler",void 0),r([o({constructOnly:!0})],LM.prototype,"cache",void 0),r([o({constructOnly:!0})],LM.prototype,"task",void 0),r([o({constructOnly:!0})],LM.prototype,"cameraName",void 0),r([o({readOnly:!0})],LM.prototype,"location",null),r([o({constructOnly:!0})],LM.prototype,"map",void 0),r([o({readOnly:!0})],LM.prototype,"renderLocation",void 0),r([o({readOnly:!0})],LM.prototype,"scale",null),r([o({readOnly:!0})],LM.prototype,"updating",null),LM=r([a("esri.views.3d.support.CameraOnSurface")],LM);const EM=js(),IM=LM,VM=Array;let jM=class extends FM{constructor(t){super(t),this._propertiesPool=new El({location:m,renderLocation:VM},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.cameraName="camera",this.distance=0,this.renderLocation=js(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker&&(this._frameWorker.remove(),this._frameWorker=null),this._propertiesPool.destroy(),this._propertiesPool=null}get _camera(){return this.state[this.cameraName]}get location(){const t=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,t,this.state.spatialReference),t}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1}_updateRenderLocation(){const t=kM;let e=this.calculateSurfaceIntersection(this._currentSurfaceAltitude,t);!e&&this._currentSurfaceAltitude!==this._latestSurfaceAltitude&&(e=this.calculateSurfaceIntersection(this._latestSurfaceAltitude,t),e&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const i=BM;e&&this.latestSurfaceAltitudeChangesDistanceSignificantly(t,i)&&($i(t,i),this._currentSurfaceAltitude=this._latestSurfaceAltitude),e?this.distance=cs(this._camera.eye,t):(Yi(t,this._camera.viewForward,this._get("distance")),Ki(t,t,this._camera.eye)),Ss(this._get("renderLocation"),t)||this._set("renderLocation",$i(this._propertiesPool.get("renderLocation"),t))}calculateSurfaceIntersection(t,e){const i=this._camera;if(!this.renderCoordsHelper.intersectManifold(i.ray,t,e))return!1;if(this.state.isGlobal){const s=Qr(this.renderCoordsHelper.spatialReference).radius,n=s+t,r=vs(i.eye),o=r<n*n,a=cs(i.eye,e);if(o&&a>s/4){const t=n-Math.sqrt(r);return Yi(e,i.viewForward,t),Ki(e,e,i.eye),!0}}else{const t=this.surface.ready?this.surface.extent:null;p(t)&&Ue(t,this.surface.spatialReference,GM,this.renderCoordsHelper.spatialReference)&&(e[0]=fs(e[0],GM[0],GM[2]),e[1]=fs(e[1],GM[1],GM[3]))}return!0}latestSurfaceAltitudeChangesDistanceSignificantly(t,e){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==t)return!1;if(this.calculateSurfaceIntersection(this._latestSurfaceAltitude,e)){if(lr.TESTS_DISABLE_OPTIMIZATIONS)return!0;const i=this._camera.eye,s=cs(i,t),n=cs(i,e);if(Math.abs(n-s)/s>NM)return!0}return!1}};r([o({constructOnly:!0})],jM.prototype,"scheduler",void 0),r([o({constructOnly:!0})],jM.prototype,"task",void 0),r([o({constructOnly:!0})],jM.prototype,"cameraName",void 0),r([o()],jM.prototype,"distance",void 0),r([o({constructOnly:!0})],jM.prototype,"estimateSurfaceAltitudeAtCenter",void 0),r([o({readOnly:!0})],jM.prototype,"location",null),r([o({readOnly:!0})],jM.prototype,"renderLocation",void 0),r([o()],jM.prototype,"updating",void 0),jM=r([a("esri.views.3d.support.CenterOnSurface")],jM);const NM=.05,kM=js(),BM=js(),GM=Ln(),qM=jM;class WM{constructor(t){this.handles=new E,this.events=new G,this.contentLayerViews=t.contentLayerViews,this.handles.add(this.contentLayerViews.on("change",(t=>this.layerViewsChanged(t)))),this.layerViewsChanged({added:this.contentLayerViews.toArray(),removed:[],moved:[],target:this.contentLayerViews})}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}layerViewsChanged(t){t.added.forEach((t=>{"esri.views.3d.layers.SceneLayerView3D"===t.declaredClass&&this.handles.add(t.on("visible-geometry-changed",(()=>this.contentChanged())),t.uid)})),t.removed.forEach((t=>this.handles.remove(t.uid)))}contentChanged(){this.events.emit("request-update",UM)}}const UM={},HM=Array;let ZM=class extends FM{constructor(t){super(t),this._propertiesPool=new El({location:m,renderLocation:HM},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.handles.add([this.centerOnSurface.watch("renderLocation",(()=>this.updateRenderLocation())),this.state.watch("contentCamera",(()=>this.updateRenderLocation()))]),this.scheduler&&this.handles.add(this.scheduler.registerTask(po.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool.destroy(),this._propertiesPool=null}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const t=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,t,this.state.spatialReference),t}get running(){return this._dirty}runTask(){const t=this._get("renderLocation"),e=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,s=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(e,QM);const n=Math.max(0,(Math.acos(es(QM,s.viewForward))-.5*Math.PI)*(s.aboveGround?1:-1));if(Number.isNaN(n)){if(!t||!gs(t,e)){const t=this._propertiesPool.get("renderLocation");$i(t,e),this._set("renderLocation",t)}return}const r=1-fs(n/(.5*Math.PI),0,1),o=r*r*r;this._calculateScreenHorizontalEdgeOnSurface(XM);const a=this._propertiesPool.get("renderLocation");ws(a,e,XM,o),t&&gs(t,a)||this._set("renderLocation",a)}_calculateScreenHorizontalEdgeOnSurface(t){const e=this.state.contentCamera,i=e.getRenderCenter(So());if(i[1]=e.aboveGround?e.padding[2]:e.fullHeight-e.padding[0],this.estimateSurfaceIntersectionAtRenderPoint(i,t))return t;const s=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(e.unprojectFromRenderScreen(i,YM)){ts(YM,YM,e.eye);const i=is(YM,YM);if(this.renderCoordsHelper.intersectManifold(No(e.eye,i),s,t))return t}return this.renderCoordsHelper.setAltitude(t,s,e.eye)}updateRenderLocation(){this._dirty=!0}};r([o()],ZM.prototype,"_dirty",void 0),r([o({constructOnly:!0})],ZM.prototype,"scheduler",void 0),r([o({constructOnly:!0})],ZM.prototype,"centerOnSurface",void 0),r([o({constructOnly:!0})],ZM.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),r([o({readOnly:!0})],ZM.prototype,"updating",null),r([o({readOnly:!0})],ZM.prototype,"location",null),r([o({readOnly:!0})],ZM.prototype,"renderLocation",void 0),ZM=r([a("esri.views.3d.support.CenterOnSurface")],ZM);const QM=js(),YM=js(),XM=js(),KM=ZM;let $M=class extends T{constructor(t){super(t),this.location=null,this._updateController=null,this._handles=new E}get renderLocation(){if(!this.location)return null;const t=js();return this.view.renderCoordsHelper.toRenderCoords(this.location,t),t}initialize(){this.view.state.isLocal&&(this._handles.add([this.watch(["surfaceView.spatialReference","surfaceView.extent"],(()=>this._update())),X(this,"surface.layers","change",(()=>this._update()))]),this._update())}destroy(){this._handles.destroy()}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),!this.surfaceView||w(this.surfaceView.extent)||!this.surfaceView.spatialReference)return void this._set("location",null);const t=Hn(this.surfaceView.extent),e=new m({x:t[0],y:t[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(e,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then((t=>{this._updateController=null,this._set("location",t.geometry)})).catch((t=>{F(t)||t&&"elevation-query:invalid-layer"===t.name||console.error("StableSurfaceCenter failed to update: ",t)}))):this._set("location",e)}};r([o({constructOnly:!0})],$M.prototype,"view",void 0),r([o({constructOnly:!0})],$M.prototype,"cache",void 0),r([o({readOnly:!0,aliasOf:"view.map.ground"})],$M.prototype,"surface",void 0),r([o({readOnly:!0,aliasOf:"view.basemapTerrain"})],$M.prototype,"surfaceView",void 0),r([o({readOnly:!0})],$M.prototype,"location",void 0),r([o({readOnly:!0})],$M.prototype,"renderLocation",null),$M=r([a("esri.views.3d.terrain.StableSurfaceCenter")],$M);let JM=class extends T{constructor(){super(...arguments),this.handles=new E,this._tileGeometryUpdateExtent=In(),this._tileGeometryUpdateSpatialReference=null,this.events=new G,this.updating=!1}initialize(){this.handles.add([this.surface.on("elevation-change",(t=>this._tileGeometryChanged(t))),this.scheduler.registerTask(po.SURFACE_GEOMETRY_UPDATES,this)])}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}get running(){return this.updating}runTask(){this.updating&&(this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",tS),In(this._tileGeometryUpdateExtent),this._set("updating",!1))}_tileGeometryChanged(t){this._tileGeometryUpdateSpatialReference=t.spatialReference,jn(this._tileGeometryUpdateExtent,t.tile.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let t=this.centerOnSurfaces[0];for(let e=1;e<this.centerOnSurfaces.length;e++){const i=this.centerOnSurfaces[e];i.distance>t.distance&&(t=i)}return t}_centerIntersectsExtent(t,e){const i=this.state.camera.eye,s=sS,n=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,eS,e),this.renderCoordsHelper.fromRenderCoords(n.renderLocation,iS,e),eS[0]<iS[0]?(s[0]=eS[0],s[2]=iS[0]):(s[0]=iS[0],s[2]=eS[0]),eS[1]<iS[1]?(s[1]=eS[1],s[3]=iS[1]):(s[1]=iS[1],s[3]=eS[1]),Nn(s,t)}};r([o({constructOnly:!0})],JM.prototype,"state",void 0),r([o({constructOnly:!0})],JM.prototype,"centerOnSurfaces",void 0),r([o({constructOnly:!0})],JM.prototype,"renderCoordsHelper",void 0),r([o({constructOnly:!0})],JM.prototype,"scheduler",void 0),r([o({constructOnly:!0})],JM.prototype,"surface",void 0),r([o({readOnly:!0})],JM.prototype,"updating",void 0),JM=r([a("esri.views.3d.support.SurfaceGeometryUpdates")],JM);const tS={},eS=js(),iS=js(),sS=In();let nS=class extends T{constructor(t){super(t),this._handles=new E,this._tmpRay=Wo(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new El({renderPointOfView:rS},this),this.renderPointOfView=js(),this._pois=new Array,this._debugCenters=new Map}initialize(){var t;const{state:e,basemapTerrain:i,renderCoordsHelper:s,map:n}=this.view;this._surfaceIntersector=new Jn(e.viewingMode),this._surfaceIntersector.options.backfacesTerrain=!e.isGlobal,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=0,this._contentIntersector=new Jn(e.viewingMode);const r=()=>this._estimateSurfaceAltitudeAtCenter(),o=this.view.resourceController.scheduler,a=P(null==(t=this.view.basemapTerrain)?void 0:t.elevationQueryCache),h={state:e,scheduler:o,surface:i,renderCoordsHelper:s};this._set("centerOnSurfaceInfrequent",new qM({...h,task:po.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:r})),this._set("centerOnSurfaceFrequent",new qM({...h,task:po.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:r})),this._set("contentCenterOnSurface",new qM({...h,task:po.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:r,cameraName:"contentCamera"})),this._set("centerOnContent",new qM({...h,task:po.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new IM({...h,cache:a,task:po.POINT_OF_INTEREST_INFREQUENT,map:n})),this._set("contentCameraOnSurface",new IM({...h,cache:a,task:po.POINT_OF_INTEREST_INFREQUENT,map:n,cameraName:"contentCamera"})),this._set("surfaceGeometryUpdates",new JM({...h,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new WM({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:s})),this._set("surfaceOrigin",new $M({cache:a,view:this.view})),this._set("focus",new KM({state:e,scheduler:o,surface:i,renderCoordsHelper:s,centerOnSurface:this.contentCenterOnSurface,estimateSurfaceIntersectionAtRenderPoint:(t,e)=>this._estimateSurfaceIntersectionAtRenderPoint(t,this.view.state.contentCamera,e)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.contentCenterOnSurface,this.cameraOnSurface,this.contentCameraOnSurface,this.focus);const l=this.view.graphics;this._debugCenters.set(this.centerOnContent,new RM(l,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new RM(l,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new RM(l,"red","CenterOnSurface")),this._debugCenters.set(this.contentCenterOnSurface,new RM(l,"red","ContentCenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new RM(l,"blue","CameraOnSurface")),this._debugCenters.set(this.contentCameraOnSurface,new RM(l,"blue","ContentCameraOnSurface")),this._debugCenters.set(this.focus,new RM(l,"green","Focus")),this._handles.add([e.watch("camera",(t=>this._cameraChanged(t)),!0),i.watch("extent",(()=>this._updateCenterPointsOfInterest())),_t(i,"updating",(()=>this._updateCenterPointsOfInterest()),!0),this.surfaceGeometryUpdates.events.on("request-update",(()=>this._updateCenterPointsOfInterest())),this.contentGeometryUpdates.events.on("request-update",(()=>this._updateCenterOnContent())),tt(lr,"SHOW_POI",(t=>this._setDebug(t)))]),this._cameraChanged(this.view.state.camera);for(const t of this._pois)t.runTask()}destroy(){this._setDebug(!1),this._handles.destroy(),this._propertiesPool.destroy();for(const t of this._pois)t.destroy();this.surfaceOrigin.destroy()}get updating(){var t;return!!(null!=(t=this.surfaceGeometryUpdates)&&t.updating||this._pois.some((t=>t.updating)))}get centerRay(){return this._centerRayDirty&&(this._centerRay=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.camera,this._tmpRay),this._centerRayDirty=!1),this._centerRay}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const t=this.centerRay;return w(t)||(this._contentAltitudeAtCenter=this.view.sceneIntersectionHelper.intersectRay(t,this._contentIntersector,oS,hS)?this.view.renderCoordsHelper.getAltitude(oS):this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const t=this.centerRay;if(w(t))return this._surfaceAltitudeAtCenter;const e=t.origin,i=Ki(oS,t.origin,t.direction);return this._surfaceIntersector.resetWithRay(t),this._surfaceIntersector.camera=this.view.state.camera,this.view.basemapTerrain.intersect(this._surfaceIntersector,null,e,i),this._surfaceIntersector.results.min.getIntersectionPoint(oS)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(oS)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(t,e,i){const s=$l(e,t,aS);if(w(s))return null;const n=s.origin,r=Ki(oS,s.origin,s.direction);return this._surfaceIntersector.resetWithRay(s),this._surfaceIntersector.camera=e,this.view.basemapTerrain.intersect(this._surfaceIntersector,null,n,r),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(t){this._updateCenterPointsOfInterest();const e=t.eye;Ss(this.renderPointOfView,e)||this._set("renderPointOfView",$i(this._propertiesPool.get("renderPointOfView"),e))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const t of this._pois)t.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(t){if(!t)return this._debugCenters.forEach((t=>t.hide())),void this._handles.remove("debug");for(const t of this._pois)this._handles.add(tt(t,"renderLocation",(e=>this._debugCenters.get(t).show(e,t.renderCoordsHelper.spatialReference))),"debug")}get test(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const t of this._pois)t.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};r([o({readOnly:!0})],nS.prototype,"centerOnContent",void 0),r([o({readOnly:!0})],nS.prototype,"centerOnSurfaceFrequent",void 0),r([o({readOnly:!0})],nS.prototype,"centerOnSurfaceInfrequent",void 0),r([o({readOnly:!0})],nS.prototype,"contentCenterOnSurface",void 0),r([o({readOnly:!0})],nS.prototype,"cameraOnSurface",void 0),r([o({readOnly:!0})],nS.prototype,"contentCameraOnSurface",void 0),r([o({readOnly:!0})],nS.prototype,"focus",void 0),r([o({readOnly:!0})],nS.prototype,"renderPointOfView",void 0),r([o({readOnly:!0})],nS.prototype,"surfaceOrigin",void 0),r([o({readOnly:!0})],nS.prototype,"contentGeometryUpdates",void 0),r([o({readOnly:!0})],nS.prototype,"surfaceGeometryUpdates",void 0),r([o({constructOnly:!0})],nS.prototype,"view",void 0),r([o({readOnly:!0})],nS.prototype,"updating",null),nS=r([a("esri.views.3d.support.PointsOfInterest")],nS);const rS=Array,oS=js(),aS=Wo(),hS={exclude:new Set([ch])},lS=nS;class cS{constructor(t){this.store=t}destroy(){this.store.destroy()}get(t){return this.store.get(t)}put(t,e){this.store.put(t,e,e.values.byteLength+256)}}const uS={value:.5,readOnly:!0},dS={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}},pS=t=>{let e=class extends t{get imageFormatIsOpaque(){return!1}get isOpaque(){return this.fullOpacity>=1&&this.imageFormatIsOpaque}get dataLevelRange(){const t=this.tileInfo.lods;return this.levelRangeFromScaleRange(t[0].scale,t[t.length-1].scale)}get displayLevelRange(){const t=this.tileInfo.lods,e=this.levelRangeFromScaleRange(this.layer.minScale||t[0].scale,this.layer.maxScale||t[t.length-1].scale);return this.layer.maxScale&&e.maxLevel++,e}getTileUrl(t,e,i){return this.layer.getTileUrl(t,e,i)}_addTilingSchemeMatchPromise(){if(w(this.layer.fullExtent))return this.addResolvingPromise(Promise.reject(new n("tilingscheme:extent-not-defined","This layer doesn't define a fullExtent.")));const t=this._getTileInfoSupportError(this.tileInfo,this.layer.fullExtent);if(t)return this.addResolvingPromise(Promise.reject(t));const e=Dt(this.view,"basemapTerrain.tilingSchemeLocked").then((()=>{const t=this._getTileInfoCompatibilityError(this.tileInfo,this.view.basemapTerrain.tilingScheme);if(t)throw t}));this.addResolvingPromise(e)}_getTileInfoSupportError(t,e){const i=ri(t,e,this.view.spatialReference,this.view.state.viewingMode);if(i){const t={layer:this.layer,error:i};let e;switch(i.name){case"tilingscheme:spatial-reference-mismatch":case"tilingscheme:global-unsupported-spatial-reference":case"tilingscheme:local-unsupported-spatial-reference":e=new n("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",t);break;default:e=new n("layerview:tiling-scheme-unsupported","The tiling scheme of this layer is not supported by SceneView",t)}return e}return null}_getTileInfoCompatibilityError(t,e){return e.compatibleWith(t)?null:new n("layerview:tiling-scheme-incompatible","The tiling scheme of this layer is incompatible with the tiling scheme of the surface")}levelRangeFromScaleRange(t,e){const i={minLevel:0,maxLevel:1/0},s=this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.tilingScheme;if(!s)return i;const n=s.levels[0],r=t=>{const e=Math.log(n.scale/t)/Math.LN2;return.5-Math.abs(.5-e%1)<1e-9?Math.round(e):Math.ceil(e)};return null!=t&&t>0&&(i.minLevel=Math.max(0,r(t))),null!=e&&e>0&&(i.maxLevel=Math.max(0,r(e))),i}isUpdating(){return!!(this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.updating)}};return r([o({readOnly:!0})],e.prototype,"imageFormatIsOpaque",null),r([o({readOnly:!0})],e.prototype,"updating",void 0),r([o(dS)],e.prototype,"updatingProgress",void 0),r([o(uS)],e.prototype,"updatingProgressValue",void 0),r([o({readOnly:!0})],e.prototype,"fullExtent",void 0),r([o({readOnly:!0})],e.prototype,"isOpaque",null),r([o({readOnly:!0})],e.prototype,"dataLevelRange",null),r([o({readOnly:!0})],e.prototype,"displayLevelRange",null),r([o()],e.prototype,"layer",void 0),r([o({readOnly:!0})],e.prototype,"tileInfo",void 0),e=r([a("esri.views.3d.layers.TiledLayerView3D")],e),e};let fS=class extends(pS(Vl(Dc))){constructor(){super(...arguments),this.type="elevation-3d"}initialize(){const t=this.get("view.map.allLayers"),e=t&&t.includes(this.layer),i=this.get("view.map.ground.layers"),s=i&&i.includes(this.layer);if(e&&!s){const t=new n("layerview:elevation-layer-only","3D elevation layer '"+this.layer.id+"' can only be added in the map ground");this.addResolvingPromise(Promise.reject(t))}this._addTilingSchemeMatchPromise()}};r([o({readOnly:!0,aliasOf:"layer.fullExtent"})],fS.prototype,"fullExtent",void 0),r([o()],fS.prototype,"layer",void 0),r([o({readOnly:!0,aliasOf:"layer.tileInfo"})],fS.prototype,"tileInfo",void 0),fS=r([a("esri.views.3d.layers.ElevationLayerView3D")],fS);const gS=fS,mS=Object.freeze({__proto__:null,default:gS});class vS{constructor(t=0,e=0){this.min=t,this.max=e,this.level=0,this.hasNoDataValues=!1}copyFrom(t){this.min=t.min,this.max=t.max,this.level=t.level,this.hasNoDataValues=t.hasNoDataValues}}class yS{constructor(t,e,i){this.type="elevation",this.samplerData=null,this.level=t[0],this.i=t[1],this.j=t[2],this.extent=e;const s=i.noDataValue,n=i.values;let r=1/0,o=-1/0,a=!0,h=!1;for(let t=0;t<n.length;t++){const e=n[t];e!==s?(r=e<r?e:r,o=e>o?e:o,a=!1):h=!0}a&&(r=0,o=0),o=o>-3e38?o:0,this.samplerData={pixelData:i.values,width:i.width,height:i.height,noDataValue:s,safeWidth:.99999999*(i.width-1),dx:(i.width-1)/(e[2]-e[0]),dy:(i.width-1)/(e[3]-e[1]),x0:e[0],y1:e[3]},this.bounds=[r,o],this.hasNoDataValues=h}release(){this.samplerData=null,this.bounds=null}computeMinMaxValue(t,e,i,s){s.min=1/0,s.max=-1/0,s.hasNoDataValues=!1;const n=t-this.level;if(n<=0)return s;const r=2**n;if(Math.floor(e/r)!==this.i||Math.floor(i/r)!==this.j)return s;let o=1/0,a=-1/0;const h=this.samplerData.width,l=this.samplerData.pixelData,c=.5*ei;let u=(h-1)/r,d=(i-this.j*r)*u,p=(e-this.i*r)*u;if(u<1){const t=Math.floor(d),e=Math.floor(p),i=t+e*h,n=l[i],r=l[i+1],o=l[i+h],a=l[i+h+1];if(n+r+o+a<c){const i=d-t,h=p-e,l=nn(n,r,o,a,i,h),c=nn(n,r,o,a,i+u,h),f=nn(n,r,o,a,i,h+u),g=nn(n,r,o,a,i+u,h+u);return s.min=Math.min(l,c,f,g),s.max=Math.max(l,c,f,g),s}d=t,p=e,u=1}else d=Math.floor(d),p=Math.floor(p),u=Math.ceil(u);for(let t=d;t<=d+u;t++)for(let e=p;e<=p+u;e++){const i=l[t+e*h];i<c?(o=Math.min(o,i),a=Math.max(a,i)):s.hasNoDataValues=!0}return s.min=o,s.max=a,s}static sample(t,e,i){for(const s of i){if(!s)continue;const i=s.safeWidth,n=s.width,r=s.pixelData;let o=fs(s.dy*(s.y1-e),0,i),a=fs(s.dx*(t-s.x0),0,i);const h=Math.floor(o),l=Math.floor(a),c=h*n+l,u=c+n,d=r[c],p=r[u],f=r[c+1],g=r[u+1];if(d+p+f+g<.5*ei){o-=h,a-=l;const t=d+(f-d)*a;return t+(p+(g-p)*a-t)*o}}return null}}let wS=class extends T{constructor(t){super(t),this._handles=new E}initialize(){this._handles.add([this.layerViews.on("change",(()=>this.notifyChange("stencilEnabledExtents")))])}destroy(){this._handles.destroy(),this._handles=null}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const t=[];return this.layerViews.forEach((e=>{const i=e.layer;if("IntegratedMeshLayer"===i.operationalLayerType&&null!=this.viewSpatialReference){const e=CS(i.fullExtent,this.viewSpatialReference);p(e)&&t.push(Zn(e))}})),t}};r([o({readOnly:!0})],wS.prototype,"layerViewsExtent",null),r([o({readOnly:!0})],wS.prototype,"tiledLayersExtent",null),r([o({readOnly:!0})],wS.prototype,"stencilEnabledExtents",null),r([o()],wS.prototype,"viewSpatialReference",void 0),r([o()],wS.prototype,"tilingScheme",void 0),r([o()],wS.prototype,"defaultTiledLayersExtent",void 0),r([o({constructOnly:!0})],wS.prototype,"layers",void 0),r([o({constructOnly:!0})],wS.prototype,"layerViews",void 0),wS=r([a("esri.views.3d.terrain.ExtentHelper")],wS);let xS=class extends wS{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?oi:ai}};xS=r([a("esri.views.3d.terrain.ExtentHelperGlobal")],xS);let bS=class extends wS{_computeLayerViewsExtent(){const t=In(),e=this.viewSpatialReference;this.layerViews.forEach((i=>{const s=i.layer;if(i.isResolved()&&("graphics"!==s.type||!s.internal)){const s=CS("fullExtentInLocalViewSpatialReference"in i&&i.fullExtentInLocalViewSpatialReference||i.layer.fullExtent,e);jn(t,s,t)}}));const i=Yn(t)?t:null,s=this._get("layerViewsExtent");return Qn(i,s)?s:i}_computeTiledLayersExtent(){const t=this.tilingScheme;if(!t)return null;const e=this.viewSpatialReference,i=In();this.layers.forEach((s=>{if(s.loaded&&hi(s)){const{tileInfo:n,fullExtent:r}=li(s,e,2);(p(n)&&ci(s)&&p(r)||p(n)&&t.compatibleWith(n)&&p(r)&&r.spatialReference.equals(t.spatialReference))&&jn(i,r,i)}})),jn(i,this.defaultTiledLayersExtent,i);const s=Yn(i)?i:null,n=this._get("tiledLayersExtent");return Qn(s,n)?n:s}};function CS(t,e){return p(t)&&!t.spatialReference.equals(e)?He(t,t.spatialReference,e):t}bS=r([a("esri.views.3d.terrain.ExtentHelperLocal")],bS);const MS=ht(40),SS=ht(50);function PS(){var t;const e=null==(t=Ot.require)?void 0:t.modules;if(e){const t=Object.keys(e);for(const i of t)-1!==i.search(".glsl")&&delete e[i]}}const TS=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let AS,_S=class extends T{constructor(t){super(t),this._handles=new E,this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Map,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._layerViewsDirty=!0,this._hasUnusedRenderTargets=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=dt("esri-mobile")?2048:4096,this._animationTimeLast=0}get running(){return(this._placementDirty||this._layerViewsDirty)&&(this._drapeSources.size>0||this.view.graphics.length>0||lr.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get _worldToPCSRatio(){return p(this._spatialReference)&&this._spatialReference.isGeographic&&!this.view.state.isLocal?Qr(this._spatialReference).metersPerDegree:1}get view(){return this.surface.view}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get hasHighlights(){return this.renderer.hasHighlights}get rendersOccluded(){return this.renderer.rendersOccluded}initialize(){const t=this.view;this.renderer=new Cr({view:t,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),this._groundIntersector=new Jn(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this._handles.add([this.renderer.events.on("has-highlights",(()=>{this._setDrawTexturesDirty(),this.notifyChange("hasHighlights")})),this.renderer.events.on("has-water",(e=>{var i;return null==(i=t._stage)?void 0:i.renderView.setRenderParameters({hasOverlayWater:e})})),this.renderer.events.on("renders-occluded",(()=>{this._setDrawTexturesDirty(),this.notifyChange("rendersOccluded")})),this.renderer.events.on("content-changed",(()=>this._setDrawTexturesDirty())),this.renderer.events.on("textures-disposed",(()=>this.updateDrapeTargets())),t.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],(()=>this.setPlacementDirty())),this.surface.on("elevation-change",(()=>this.setPlacementDirty())),t.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0)),t.watch("graphicsView",(()=>this._layerViewsDirty=!0)),t.on("resize",(()=>this.setPlacementDirty())),St({preRender:t=>{this._contentUpdated=!1,this.renderer.processSyncLayers(),this._updateLayerViews(),this.renderer.hasOverlays&&(this._dispatchRendererUpdate(t),this._drawOverlayTextures(this.renderer.overlays,1)),this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()}}),t.resourceController.scheduler.registerTask(po.OVERLAY,this),t._stage.renderView.events.on("force-camera-for-screenshot",(t=>{this._updateOverlays(t,0),this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays,0,t)}))]),this._updateLayerViews()}destroy(){this._drapeSources.forEach(((t,e)=>this.unregisterDrapeSource(e))),this._drapeTargets.forEach((t=>this._unregisterDrapeTarget(t))),this.renderer.dispose(),this._handles&&(this._handles.destroy(),this._handles=null),p(AS)&&(AS.hide(),AS=null)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(t){this._spatialReference=t,this.renderer.spatialReference=t,this._longitudeCyclical=null;const e=this.view.renderSpatialReference;p(t)&&p(e)?(this._renderSR=e,this._overlaySREqualsRenderSR=t.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=t.isWebMercator?new Xs(-20037508.342787,20037508.342787):new Xs(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}get gpuMemoryUsage(){return this.renderer.gpuMemoryUsage}_updateLayerViews(){if(!this._layerViewsDirty)return;const t=new Set;for(const e of this.view.allLayerViews.items)t.add(e.uid),"drapeSourceType"in e&&!this._drapeSources.has(e)&&this._registerDrapeSource(e,0),"drapeTargetType"in e&&!this._drapeTargets.has(e)&&this._registerDrapeTarget(e);const e=this.view.graphicsView;p(e)&&!this._drapeSources.has(e)&&(this._registerDrapeSource(e,0),t.add(e.uid)),this._drapeSources.forEach(((e,i)=>{0!==e||t.has(i.uid)||this.unregisterDrapeSource(i)})),this._drapeTargets.forEach((e=>{t.has(e.uid)||this._unregisterDrapeTarget(e)})),this.renderer.updateLayerOrder(),this._setDrawTexturesDirty(),this._layerViewsDirty=!1}registerDrapeSource(t){this._registerDrapeSource(t,1)}_registerDrapeSource(t,e){this._drapeSources.set(t,e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources),this._updateDrapeSourceExtent(t),this._setContentDirty(),this.notifyChange("running")}_updateDrapeSourceExtent(t){2===this.renderer.overlays.length&&p(t.setDrapingExtent)&&p(this._spatialReference)&&t.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(t){this._drapeSources.has(t)&&(this._drapeSources.delete(t),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}_registerDrapeTarget(t){this._drapeTargets.add(t),this._updateDrapeTarget(t),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}updateDrapeTargets(){this._drapeTargets.forEach((t=>this._updateDrapeTarget(t)))}_updateDrapeTarget(t){t.setDrapingTextures(this.renderer.overlays)}_unregisterDrapeTarget(t){this._drapeTargets.delete(t),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this._setDrawTexturesDirty()}setPlacementDirty(){this._placementDirty=!0}runTask(){this._updateOverlays(this.view.state.camera,1)}_updateOverlays(t,e){if(!this._spatialReference)return;this._updateLayerViews();const i=Sr(t.fullWidth,t.fullHeight,this._maxResolution);this._computeOverlayExtents(t,i,RS);const s=kn(RS.inner)/kn(RS.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const n=this._updateOverlay(0,RS.inner,i,1*RS.pixelRatioAdjustment,RS.mapUnitsPerPixel),r=this._updateOverlay(1,RS.outer,i,s*RS.pixelRatioAdjustment,RS.mapUnitsPerPixel);1!==n&&1!==r||(this._drapeSources.forEach(((t,e)=>this._updateDrapeSourceExtent(e))),this.surface.updateTileOverlayParams(e)),0===n&&0===r||this._setDrawTexturesDirty(),this._placementDirty=!1}_updateOverlay(t,e,i,s,n){if(0===this.renderer.overlays.length)return 0;const r=this.renderer.overlays[t],o=r.mapUnitsPerPixel;if(r.mapUnitsPerPixel=n,r.pixelRatio=s,!function(t,e){const i=lr.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(t[2]-t[0],t[3]-t[1],e[2]-e[0],e[3]-e[1]);for(let s=0;s<4;s++)if(Math.abs(e[s]-t[s])>i)return!0;return!1}(e,r.extent)&&i===r.resolution)return o===n?0:2;Gn(r.extent,e),r.resolution=i;const a=Hn(r.extent);return r.renderLocalOrigin=Mr(a[0],a[1],0,"OV_"+this._latestOriginId++),1}setTileParameters(t){const e=t.renderData.overlay;if(this.renderer.overlays.length>0){const i=this.renderer.overlays[0],s=this.renderer.overlays[1],n=Xn(t.extent,this.surface.extent,FS);this._rectInsideRect(i.extent,n)||this._rectanglesOverlap(n,i.extent)||this._rectanglesOverlap(n,s.extent)?(this._setTileOverlayData(n,0,e),this._setTileOverlayData(n,1,e)):(this._clearTileOverlayData(0,e),this._clearTileOverlayData(1,e))}else this._clearTileOverlayData(0,e),this._clearTileOverlayData(1,e)}overlayPixelSizeInMapUnits(t){if(0===this.renderer.overlays.length)return 0;const e=this.renderer.overlays[0],i=this.renderer.overlays[1],s=this._pointIsInExtent(t,e.extent)?e:i;return(s.extent[2]-s.extent[0])/s.resolution}_setTileOverlayData(t,e,i){if(0===this.renderer.overlays.length)return;const s=this.renderer.overlays[e].extent,n=kn(s),r=Bn(s);let o=t[0];if(this._longitudeCyclical){o=this._longitudeCyclical.minimalMonotonic(s[0],o);const e=this._longitudeCyclical.minimalMonotonic(s[0],t[2]);o>e&&(o=e-(t[2]-t[0]))}i.setScale(e,kn(t)/n,Bn(t)/r),i.setOffset(e,(o-s[0])/n,(t[1]-s[1])/r)}_clearTileOverlayData(t,e){e.setScale(t,-1,-1),e.setOffset(t,-1,-1)}async reloadShaders(){PS(),await this.renderer.reloadShaders(),this.runTask()}_dispatchRendererUpdate(t){const e=ht(t.time-this._animationTimeLast);e<SS&&w(this.forcedAnimationTime)||(this._animationTimeLast=t.time,this.renderer.updateLogic({dt:e,forcedTime:this.forcedAnimationTime,camera:this.view.state.camera})&&(this._drawTexturesAnimateDirty=!0))}_setDrawTexturesDirty(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0):this.setPlacementDirty()}_intersectGroundFromView(t,e,i,s){const n=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(t,LS,e,i);if(w(n))return!1;const r=n.origin,o=Ki(OS,n.origin,n.direction);return this._groundIntersector.reset(r,o),this._groundIntersector.intersect([],null,t),this.view.basemapTerrain.intersect(this._groundIntersector,null,r,o),this._groundIntersector.results.min.getIntersectionPoint(s)}_findHorizonBasedPointOfInterest(t,e){let i=.5;const s=.55,n=this.view.renderCoordsHelper.getAltitude(t.eye),r=this.view.pointsOfInterest.centerOnSurfaceFrequent,o=1e-5,a=fs(r.estimatedSurfaceAltitude,t.aboveGround?-1/0:n+o,t.aboveGround?n-o:1/0),h=t.aboveGround;if("global"===this.view.viewingMode){const e=OS;Go(qo(Qr(this.view.spatialReference).radius+a),No(t.eye,t.viewForward),e),ts(e,e,t.eye);const n=sn.normalize(Qo(t.viewForward,e,t.viewRight))/t.fovY+.5,r=n<=0||n>=1?.5:s;i=h?r*n:n+r*(1-n)}else{const e=.5*Math.PI-Math.acos(-t.viewForward[2]),n=Math.tan(e),r=na(0,n,1,0),o=bs(r,r,t.projectionMatrix)[1],a=fs(.5+.5*o,0,1);i=1===a||0===a?.5:h?a*s:1-(1-a)*s}return!!this._intersectGroundFromView(t,.5,i,e)&&Ps(e,t.eye)<r.distance*r.distance}_computeOverlayExtents(t,e,i){const s=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,n=js();this._findHorizonBasedPointOfInterest(t,n)||$i(n,s);const r=cs(t.eye,n),o=nv(this.view.renderCoordsHelper,s,t.eye),a=Math.PI/2-Math.abs(o-Math.PI/2);lr.OVERLAY_SHOW_CENTER?(w(AS)&&(AS=new RM(this.view.graphics,"red")),AS.show(n,this._renderSR)):p(AS)&&AS.hide(),this._overlaySREqualsRenderSR||Ie(n,this._renderSR,n,this._spatialReference);const h=this.surface.extent,l=!this._isSpherical&&p(this._spatialReference)&&this._spatialReference.isGeographic,c=l&&p(this._spatialReference)?1/Qr(this._spatialReference).metersPerDegree:1,u=t.perRenderPixelRatio*r*c;i.mapUnitsPerPixel=u/this._worldToPCSRatio;let d=e*u/2,f=!1,g=l?90:1/0;this._isSpherical&&p(h)&&p(this._spatialReference)&&(this._spatialReference.isWebMercator?(d/=Math.cos(Rt(n[1])),g=h[3]):(f=!0,d/=Qr(this._spatialReference).metersPerDegree,g=90),d>=g&&(d=g,n[1]=0,this._spatialReference.isWebMercator&&(n[0]=0)));let m=1;f&&(m=1/Math.max(.2,Math.cos(Math.abs(as(n[1])))),d*m>180&&(m=180/d),i.mapUnitsPerPixel*=m);const v=Math.log(2)/12;d=Math.exp(Math.round(Math.log(d)/v)*v);const y=d*m,x=.5*e/(32*y),b=.5*e/(32*d);n[0]=Math.round(n[0]*x)/x,n[1]=Math.round(n[1]*b)/b;const C=i.inner;C[0]=n[0]-y,C[1]=n[1]-d,C[2]=n[0]+y,C[3]=n[1]+d,this._isSpherical&&this._shiftExtentToFitBounds(C,1/0,g);const M=i.outer;if(6*y>kn(h))Gn(M,P(h));else if(a<=.25*Math.PI)M[0]=C[0]-y,M[1]=C[1]-d,M[2]=C[2]+y,M[3]=C[3]+d;else{Ie(t.eye,this._renderSR,OS,this._spatialReference),ma(DS,n,OS);let e=-Math.atan2(DS[1],DS[0])+.125*Math.PI;e<0&&(e+=2*Math.PI);const i=Math.floor(e/(.25*Math.PI));Cs(DS,TS[i],2*d),DS[0]*=m,DS[2]*=m,Ts(M,C,DS)}if(this._isSpherical)M[0]=this._longitudeCyclical.clamp(M[0]),M[2]=this._longitudeCyclical.clamp(M[2]),M[1]=Math.max(M[1],-g),M[3]=Math.min(M[3],g);else{const t=Xn(C,h,FS),e=Xn(M,h,zS);Kn(t,e)&&(M[2]=M[0],M[3]=M[1])}const S=Math.abs(C[2]-C[0])/e;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,S),i.pixelRatioAdjustment=i.mapUnitsPerPixel/S}_drawOverlayTextures(t,e,i=this.view.state.camera){if(0===t.length||!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return;const s=this._drawTexturesDirty;this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1;const n=this._drawOverlay(t[0],i),r=this._drawOverlay(t[1],i);0!==n&&0!==r||this.surface.updateTileOverlayParams(1),this._collectUnusedRenderTargetMemory(),this.updateDrapeTargets(),s?(this.surface.requestRender(e),1===e&&this.surface.requestUpdate()):this.surface.requestRender(0)}_drawOverlay(t,e){return this._longitudeCyclical?t.setupGeometryViewsCyclical(this._longitudeCyclical):t.setupGeometryViewsDirect(),t.draw(this.renderer,e.pixelRatio)}_collectUnusedRenderTargetMemory(){if(this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays){const t=performance.now();this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory(t)}}_rectanglesOverlap(t,e){return!w(t)&&(this._longitudeCyclical?(this._longitudeCyclical.contains(e[0],e[2],t[0])||this._longitudeCyclical.contains(e[0],e[2],t[2])||this._longitudeCyclical.contains(t[0],t[2],e[0]))&&!(t[1]>e[3]||t[3]<e[1]):Nn(t,e))}_rectInsideRect(t,e){return!w(e)&&(this._longitudeCyclical?this._longitudeCyclical.contains(t[0],t[2],e[0])&&this._longitudeCyclical.contains(t[0],t[2],e[2])&&e[1]>t[1]&&e[3]<t[3]:Kn(t,e))}_pointIsInExtent(t,e){if(this._longitudeCyclical)return this._longitudeCyclical.contains(e[0],e[2],t.x)&&t.y>=e[1]&&t.y<=e[3];const i=t.x,s=t.y;return i>e[0]&&i<e[2]&&s>e[1]&&s<e[3]}_shiftExtentToFitBounds(t,e,i){let s=0,n=0;t[0]<-e?s=t[0]+e:t[2]>e&&(s=e-t[2]),t[1]<-i?n=t[1]+i:t[3]>i&&(n=i-t[3]),Vn(t,s,n)}get test(){return{renderer:this.renderer,update:()=>this.runTask()}}};r([o()],_S.prototype,"_spatialReference",void 0),r([o({readOnly:!0})],_S.prototype,"running",null),r([o()],_S.prototype,"_placementDirty",void 0),r([o()],_S.prototype,"_contentUpdated",void 0),r([o()],_S.prototype,"_layerViewsDirty",void 0),r([o()],_S.prototype,"_isSpherical",null),r([o()],_S.prototype,"_worldToPCSRatio",null),r([o()],_S.prototype,"renderer",void 0),r([o({constructOnly:!0})],_S.prototype,"surface",void 0),r([o({readOnly:!0,aliasOf:"surface.suspended"})],_S.prototype,"suspended",void 0),r([o({readOnly:!0})],_S.prototype,"updating",null),r([o({type:Boolean})],_S.prototype,"hasHighlights",null),r([o({type:Boolean})],_S.prototype,"rendersOccluded",null),_S=r([a("esri.views.3d.terrain.OverlayManager")],_S);const DS=sa(),OS=js(),RS={inner:Ln(),outer:Ln(),mapUnitsPerPixel:0,pixelRatioAdjustment:1},FS=Ln(),zS=Ln(),LS=Wo();class ES{constructor(t,e){this._factoryCallback=t,this._lengthCallback=e,this._pool=new Map}acquire(t){if(!ES.test.disabled){const e=this._pool.get(t);if(e&&0!==e.length)return e.pop()}try{return this._factoryCallback(t)}catch(e){const i=window.performance&&window.performance.memory;let s="";throw i&&(s=`\n  totalJSHeapSize: ${i.totalJSHeapSize}, usedJSHeapSize: ${i.usedJSHeapSize}, jsHeapSizeLimit: ${i.jsHeapSizeLimit}`),console.log("Array allocation of size "+t+" failed: "+e+s),e}}release(t){if(ES.test.disabled)return;const e=this._lengthCallback(t);let i=this._pool.get(e);i||(i=new pt({shrink:!0}),this._pool.set(e,i)),i.push(t)}clear(){this._pool.clear()}get test(){return{size:this._pool.size}}}ES.test={disabled:!1};const IS=yl().vec3f("position").vec2f("uv0"),VS=new ES((t=>IS.createBuffer(t)),(t=>t.count));class jS{constructor(){this.indices=null,this.vertexAttributes=null,this.boundingBox=yn(),this.numSurfaceIndices=0,this.numSkirtIndices=0,this.numWithoutSkirtIndices=0,this.numVertsPerRow=0,this.skirtLength=0,this.uvOffsetAndScale=sa()}}class NS{constructor(t,e,i){this.values=t,this.numSurfaceIndices=e,this.numSkirtIndices=i}}const kS=new Map;function BS(t,e,i,s){const n=(2&i)>0,r=e+(s?1024:0)+(n?2048:0);let o=kS.get(r);o||(o=function(t,e,i){const s=t-1,n=t-1,r=t*t,o=2*s+2*n;let a=s*n*2*3,h=6*o,l=6*(2*s+n-1);i&&(a*=2,h*=2,l*=2);const c=r+o>65536?new Uint32Array(a+h):new Uint16Array(a+h);let u,d,p,f,g=0,m=0,v=a,y=0;for(let t=0;t<=n;t++){e&&(y=0===t?l:t===n?-l:0),v+=y;for(let e=0;e<=s;e++){const o=WS(e,t,s,n);if(o>-1){const a=US(e,t,s,n);0!==a&&(u=g,d=r+o,p=r+(0===e&&1===t?0:o+1),f=g+a,i?(c[v+0]=u,c[v+1]=d,c[v+2]=d,c[v+3]=p,c[v+4]=p,c[v+5]=u,c[v+6]=p,c[v+7]=f,c[v+8]=f,c[v+9]=u,c[v+10]=u,c[v+11]=p,v+=12):(c[v+0]=u,c[v+1]=d,c[v+2]=p,c[v+3]=p,c[v+4]=f,c[v+5]=u,v+=6))}++g,e<s&&t<n&&(u=t*(s+1)+e,d=u+1,p=d+(s+1),f=p-1,i?(c[m+0]=u,c[m+1]=d,c[m+2]=d,c[m+3]=p,c[m+4]=p,c[m+5]=u,c[m+6]=p,c[m+7]=f,c[m+8]=f,c[m+9]=u,c[m+10]=u,c[m+11]=p,m+=12):(c[m+0]=u,c[m+1]=d,c[m+2]=p,c[m+3]=p,c[m+4]=f,c[m+5]=u,m+=6))}v-=y}return new NS(c,a,h)}(e,n,s),kS.set(r,o)),t.indices=o.values,t.numSurfaceIndices=o.numSurfaceIndices,t.numSkirtIndices=o.numSkirtIndices,t.numWithoutSkirtIndices=t.numSurfaceIndices+(i?6*(e-1)*(s?2:1):0)}function GS(t,e,i,s){t<s[0]&&(s[0]=t),t>s[3]&&(s[3]=t),e<s[1]&&(s[1]=e),e>s[4]&&(s[4]=e),i<s[2]&&(s[2]=i),i>s[5]&&(s[5]=i)}function qS(t,e){const i=e>t?1:0;return 2+4*i+(1-2*i)*(t+e)}function WS(t,e,i,s){return 0===e?t:t===i?i+e:e===s?i+s+(i-t):0===t&&e>0?2*i+s+(s-e):-1}function US(t,e,i,s){return 0===e&&t!==i?1:t===i&&e!==s?i+1:e===s&&0!==t?-1:0===t&&0!==e?-(i+1):0}const HS=new Array(ui+1),ZS=new Array(ui+1),QS=new Array(ui+1),YS=new Array(ui+1),XS=js();class KS{constructor(){this._queue=new pt,this._last=null,this.remove=()=>{}}get done(){return 0===this._queue.length&&(!this._last||this._last.isLeaf)}resetOne(t){this._queue.clear(),this._queue.push(t),this._last=null}reset(t=null){this._queue.clear(),p(t)&&this._queue.pushArray(t),this._last=null}skipSubtree(){this._last=null}next(){return this._last&&!this._last.isLeaf&&this._queue.pushArray(this._last.children),this._last=this._queue.pop(),this._last}}class $S{constructor(){this.q=new pt}get done(){return 0===this.q.length}reset(t){if(this.q.clear(),!w(t)){this.q.pushArray(t);for(let t=0;t<this.q.length;++t){const e=this.q.data[t];e.isLeaf||this.q.pushArray(e.children)}}}next(){return this.q.pop()}}function JS(t,e,i){if(w(e)||w(e.fullExtent))return!1;const s=e.fullExtent,n=t.extent;if(i){if(n[0]<s.xmin||n[1]<s.ymin||n[2]>s.xmax||n[3]>s.ymax)return!1}else if(s.xmin>n[2]||s.ymin>n[3]||s.xmax<n[0]||s.ymax<n[1])return!1;const r=t.surface.tilingScheme.levels[t.lij[0]].scale;return!(e.minScale>0&&r>1.00000001*e.minScale||e.maxScale>0&&r<.99999999*e.maxScale)}function tP(t,e){e.sort(((e,i)=>eP(e,i,t)))}function eP(t,e,i){const s=t.screenDepth,n=e.screenDepth;return s<n?-i:s>n?i:0}function iP(t,e){if(!t||!e||t[0]===e[0])return!1;const i=t[0]<e[0],s=i?t:e,n=i?e:t,r=1<<n[0]-s[0];return Math.floor(n[1]/r)===s[1]&&Math.floor(n[2]/r)===s[2]}class sP{get updating(){return!!this._tileRequested}init(t,e,i,s){this.tile=t,this._layerIdx=e,this._layerClass=i,this._suspended=s,this._tileLayerInfo=t.getLayerInfo(e,i),this._tileRequested=null;const n=this._findAncestorWithData();this._setUpsampleTile(n)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(t){t!==this._suspended&&(this._suspended=t,t?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const t=this._findAncestorWithData();return this._setUpsampleTile(t),this._requestNext()}dataArrived(t){this._setUpsampleTile(t),this._tileRequested=null,t===this.tile?this.tile.updateRenderData(this._layerClass,0):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const t=this._findNextDownload();if(this._tileRequested){if(t===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return p(t)?t.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=t):this._agentDone(),!!this._tileRequested}_findNextDownload(){const t=this._layerIdx,e=this._layerClass,i=this.tile.surface.layerViewByIndex(t,e),s=pi(i),{minLevel:n,maxLevel:r}=i.dataLevelRange,o=this._desiredMinLevelDelta,a=this._progressiveLevelModulo+o,h=this._scaleRangeEnabled?JS:()=>!0;let l=this.tile;const c=l.level;let u;const d=this._tileLayerInfo.upsampleInfo,f=d?d.tile.level:-1,g=Ft(s,"tilemapCache");for(;l&&h(l,s,!1)&&l.level>=n;){const i=l.level,s=c-i,h=l.layerInfo[e][t];if(h.data&&s>=o){i>f&&this._setUpsampleTile(l),h.dataInvalidated&&(u=l);break}if((w(g)||"unavailable"!==g.getAvailability(l.lij[0],l.lij[1],l.lij[2]))&&i<=r&&!h.data&&!h.dataMissing&&((w(u)||l.level===n||i%fi==0||c-u.level<o)&&(u=l),s>=a))break;l=l.parent}return p(u)&&c-u.level<o&&this._tileLayerInfo.upsampleInfo&&(u=null),u}_findAncestorWithData(){const t=this.tile.vlevel,e=this._desiredMinLevelDelta;let i;for(let s=this.tile;s;s=s.parent)if(s.hasLayerData(this._layerIdx,this._layerClass)){if(t-s.level>=e)return s;i=s}return i}_setUpsampleTile(t){this._tileLayerInfo.setUpsampleInfo(this.tile,t),this.tile.updateRenderData(this._layerClass,0)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}const nP=new Error("Abstract method called on TileAgent"),rP=new class extends sP{get _desiredMinLevelDelta(){throw nP}get _progressiveLevelModulo(){throw nP}dispose(){}};class oP extends sP{constructor(){super(...arguments),this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return gi-(this.tile.vlevel-this.tile.level)}get _progressiveLevelModulo(){return 0}}class aP extends sP{constructor(){super(),this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return fi}}const hP={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class lP{constructor(t,e,i=null,s=null){this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.scale=1,this.offset=[0,0],this.opacity=1,this.lij=t,this.source=e,this.width=i||e.width,this.height=s||e.height}get source(){return this._source}set source(t){this._source=t,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._memoryUsed=null)}get symbolizerParameters(){return this.isRendereredSource?{...hP,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||hP}set symbolizerParameters(t){this._symbolizerParameters=t}get bandIds(){return this._bandIds}set bandIds(t){p(t)&&t.length>0?this._bandIds&&t.every(((t,e)=>!!this._bandIds[e]&&t===this._bandIds[e]))||(this._bandIds=t,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(t){if(this._interpolation=t,this._rasterTexture){const e=this._getRasterTextureInterpolation(t);this._rasterTexture.setSamplingMode("bilinear"===e?9729:9728)}}get transformGrid(){return this._transformGrid}set transformGrid(t){this._transformGrid=t,this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null,this._memoryUsed=null)}bind(t){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&(this._rasterTexture&&!this._dirty||this._updateRasterTexture(t,this.bandIds),this._rasterTexture&&(this._updateColormapTexture(t),this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=Oc(t,this.transformGrid))),!0)}getUniforms(){const t=Vc(this.scale,this.offset),{symbolizerParameters:e,transformGrid:i,width:s,height:n,opacity:r}=this;return{basic:t,common:Rc(i,[s,n],[this.source.width,this.source.height],r),colormap:e.colormap?Fc(e.colormap,e.colormapOffset):null,stretch:"stretch"===this.symbolizerParameters.type?zc(this.symbolizerParameters):null,hillshade:"hillshade"===this.symbolizerParameters.type?Lc(this.symbolizerParameters):null}}getTextures(){const t=new Array,e=[];return this._rasterTexture&&(e.push(this._rasterTexture),t.push("u_image"),this._transformGridTexture&&(e.push(this._transformGridTexture),t.push("u_transformGrid")),this._colormapTexture&&(e.push(this._colormapTexture),t.push("u_colormap"))),{names:t,textures:e}}get memoryUsage(){if(w(this._memoryUsed)){const t=this.getTextures();if(null==t)return 0;this._memoryUsed=t.textures.map((t=>t.descriptor.width*t.descriptor.height*4)).reduce(((t,e)=>t+e),0)}return this._memoryUsed}release(){return this._rasterTexture=Q(this._rasterTexture),this._transformGridTexture=Q(this._transformGridTexture),this._colormapTexture=Q(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(t,e){const i=this.source?this.source.extractBands(e):null;if(!(i&&i.pixels&&i.pixels.length>0))return void(this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null));const s=w(e)&&w(this.bandIds)||p(e)&&p(this.bandIds)&&e.join("")===this.bandIds.join("");if(this._rasterTexture){if(s)return;this._rasterTexture.dispose(),this._rasterTexture=null}const n=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=Ec(t,i,n,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&"none"===this.symbolizerParameters.stretchType&&!this.symbolizerParameters.useGamma&&"u8"===this.source.pixelType}_getRasterTextureInterpolation(t){return"lut"===this.symbolizerParameters.type||"nearest"===t||"majority"===t?"nearest":"bilinear"}_updateColormapTexture(t){const e=this._colormap,i=this.symbolizerParameters.colormap;return i?e?i.length!==e.length||i.some(((t,i)=>t!==e[i]))?(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=Ic(t,i),void(this._colormap=i)):void 0:(this._colormapTexture=Ic(t,i),void(this._colormap=i)):(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),void(this._colormap=null))}}class cP{constructor(){this.waitingAgents=new pt,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}static acquire(t){const e=uP.acquire();return e._init(t),e}release(){this.dispose(),dP.delete(this),uP.release(this)}dispose(){this.loadingAgent=Q(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=mi(this._data)}static prune(){uP.prune(0)}_init(t){this.waitingAgents.clear(),this._data=mi(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=t,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=K(this.requestAbort),this.requestPromise=null}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){this._upsampleInfo&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(t,e){if(t===e||w(e))this._unsetUpsampleInfo();else{if(null==this._upsampleInfo)this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===e)return;this._upsampleInfo.tile.unrefMapData()}e.refMapData(),function(t,e,i){let s=1,n=0,r=0;for(;t!==e;)if(s*=.5,n*=.5,r*=.5,1&t.lij[2]&&(n+=.5),0==(1&t.lij[1])&&(r+=.5),null==(t=t.parent))throw new Error("tile was not a descendant of upsampleTile");i.init(e,n,r,s)}(t,e,this._upsampleInfo)}}get data(){return this._data}set data(t){mi(this._data),this._data=t}}const uP=new xt(cP,null,(()=>{})),dP=new Map;class pP{constructor(t){this._texture=t,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){--this._refCount,0===this._refCount&&this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}}const fP=js(),gP=js(),mP=js();class vP{constructor(){this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}}class yP{constructor(){this.lij=[0,0,0],this._children=[null,null,null,null],this._dirty=!0,this._previouslyRendered=!1,this.extent=Ln(),this._elevationBounds=Sa(),this.layerInfo=[[],[]],this.extentInRadians=Ln(),this.centerAtSeaLevel=js(),this._center=[js(),Uo(),js()],this.up=qs(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=SP,this._mapTileMemory=0,this._mapDataRefCount=0,this._screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0}static prune(){bP.prune(0),CP.prune(0),cP.prune()}get usedMemory(){return this._usedMemory===SP&&this._updateMemoryUsed(),this._usedMemory+(this.isCached?0:this.mapTileMemory)}get cachedMemory(){return this.isCached?this.mapTileMemory:0}get mapTileMemory(){this._usedMemory===SP&&this._updateMemoryUsed();let t=this._mapTileMemory;for(const{data:e}of this.layerInfo[1])e instanceof Ac&&(t+=e.memoryUsage);return t}get isCached(){return!this.shouldLoad&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBounds(){return this._elevationBounds}get level(){return this.lij[0]}get key(){return`${this.lij[0]}/${this.lij[1]}/${this.lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[1][3]}get screenDepth(){return this._screenDepth}get visible(){return this._dirty&&this.updateVisibilityNow(),this._visible}updateVisibilityNow(){this._dirty=!1;const t=this._intersectsClippingArea&&this._isVisible(this.surface.frustum);return t!==this._visible&&(this._visible=t,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setNeedsRender(),this.updateAgentSuspension()),this._visible}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const t=!!this.renderData;return t!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=t,this._surface.renderer.setNeedsRender()),t}get shouldLoad(){if(!this.loadable)return!1;if(1===this._surface.lodSnapping){const t=this.level-this._surface.snapLevel;if(0===t)return!0;if(1===t)return!1}return this.isLeaf}init(t,e,i){this.lij[0]=t[0],this.lij[1]=t[1],this.lij[2]=t[2],this.ellipsoid=Qr(i.tilingScheme.spatialReference),i.tilingScheme.getExtent(t[0],t[1],t[2],this.extent),i.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,i.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[1][3]=0,this.vlevel=t?t[0]:0,e&&e.elevationBounds?ga(this._elevationBounds,e.elevationBounds):pa(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this._screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=e,this.unsetChildren(),this._surface=i,this.updateVisibility();for(const t of vi){const e=i.numLayers(t),s=this.layerInfo[t];for(const t of s)t.release();s.length=e;for(let i=0;i<e;i++)s[i]=cP.acquire(this._surface.upsampleInfoPool),0===t&&this.findElevationBoundsForLayer(i,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(i.tilingScheme.pixelSize,ui)}release(){yi(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);for(const t of vi){for(const e of this.layerInfo[t])e.release();this.layerInfo[t].length=0}this._parent=null,this._surface=null,this._usedMemory=SP}refMapData(){++this._mapDataRefCount,this.isCached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){if(--this._mapDataRefCount,this.isCached){const t=this.cachedMemory;t>0&&(this._surface.upsampleMapCache.put(this.key,this,t),this.setMemoryDirty())}}setMemoryDirty(){this._usedMemory=SP}get cpuImageMemorySize(){const t=this._surface.tilingScheme.pixelSize;return t*t*4}_updateMemoryUsed(){this._usedMemory=0,this._mapTileMemory=0;const t=this.cpuImageMemorySize;for(const{data:e}of this.layerInfo[1])e instanceof pP?this._mapTileMemory+=fl(e.texture):e instanceof HTMLImageElement||e instanceof wi?this._mapTileMemory+=t:e instanceof lP&&(this._mapTileMemory+=e.memoryUsage);for(const e of this.layerInfo[0])this._usedMemory+=e.data?t:0;this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemory+=fl(this.renderData.textureDescriptor)),this.isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this.cachedMemory)}getUsedMemoryForLayer(t,e){const i=this.layerInfo[t][e];if(!i||!i.data)return 0;if(1!==t||this.isCached){if(0===t)return this.cpuImageMemorySize}else{const t=i.data;if(t instanceof pP)return fl(t.texture);if(t instanceof HTMLImageElement||t instanceof wi)return this.cpuImageMemorySize;if(t instanceof Ac||t instanceof lP)return t.memoryUsage}return 0}updateScreenDepth(t){const e=this._center[1],i=e[0],s=e[1],n=e[2],r=t[2]*i+t[6]*s+t[10]*n+t[14];this._screenDepth=r<0?0:r/(t[3]*i+t[7]*s+t[11]*n+t[15])}shouldSplit(t,e,i){if(p(t.frustum)&&(!this._intersectsClippingArea||!this._isVisible(t.frustum)))return 0;const s=this.level;ts(fP,this._center[1],e);let n=vs(fP),r=1;ts(gP,this._center[0],e);const o=vs(gP);o<n&&(n=o,r=0),ts(gP,this._center[2],e);const a=vs(gP);if(a<n&&(n=a,r=2),this._edgeLen2>n&&s<t.maxLod)return 2;const h=Math.sqrt(n),l=this._edgeLen/(t.fovX*h*2),c=()=>{const e=s+Math.ceil(-Math.log2(t.relativeWidthLimit/l));return e!==this.vlevel?(this.vlevel=e,4):1};if(1===i&&1==this._surface.snapLevel-s)return s>=t.maxLod?c():2;const u=es(this.up,fP),d=this._elevationBounds[1]-this._elevationBounds[0],f=d/this.edgeLen;if(t.aboveGround&&u>0&&f<.001&&u/h-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-f>0)return 0;if(l<t.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,4):0;if(s>=t.maxLod)return c();if(s>6){ts(gP,this._center[r],e),Yi(mP,this.up,u),ts(mP,mP,gP);const i=vs(mP);if(i>this.radius*this.radius&&(Yi(mP,mP,this.radius/Math.sqrt(i)),Ki(mP,mP,this._center[r]),ts(mP,e,mP),Math.min(1,(Math.abs(es(mP,this.up))+.5*d+this._curvatureHeight)/Xi(mP))*(this._edgeLen/(t.fovY*h*2))<.1/t.angledSplitBias*t.relativeHeightLimit))return 0}return 2}setChildren(t,e,i,s){yi(!!(t&&e&&i&&s),"Null child passed"),this._children[0]=t,this._children[1]=e,this._children[2]=i,this._children[3]=s}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}load(t){this.refMapData();for(const t of vi)this._createOrUpdateAgents(0,t);t.loadTile(this)}unload(t){t.unloadTile(this);for(const t of vi){const e=this.layerInfo[t];for(const t of e)t.loadingAgent&&t.loadingAgent!==rP&&(xP(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0}this.resetPendingUpdate(32),this.resetPendingUpdate(64),this.resetPendingUpdate(128),this.unrefMapData()}unloadMapData(){const t=this.layerInfo[1];for(const e of t)e.loadingAgent&&e.loadingAgent!==rP&&(xP(e.loadingAgent),e.loadingAgent=null),e.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(t){if(Qn(t,this._clippingArea))return!1;const e=this._intersectsClippingArea,i=this._isWithinClippingArea;return p(t)?(this._intersectsClippingArea=this.intersectsExtent(t),this._isWithinClippingArea=this._isWithinExtent(t)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=t,this.updateVisibility(),!this.renderData||i&&this._isWithinClippingArea||!(i||e||this._isWithinClippingArea||this._intersectsClippingArea)||this.setPendingUpdate(32),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(t,e){return this.layerInfo[e][t]}hasLayerData(t,e){const i=this.layerInfo[e][t];return!(!i||!i.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const t of vi){const e=this.layerInfo[t];for(const t of e)if(t.loadingAgent&&t.loadingAgent!==rP&&t.loadingAgent.updating)return!0}return!1}isSuspended(t){return!!this.hasPendingUpdate(2)||0!==t&&!this.loadable}get hasPendingUpdates(){return 0!==this._pendingUpdates}hasPendingUpdate(t){return(this._pendingUpdates&t)===t}setPendingUpdate(t){this._pendingUpdates|=t,2===t||8===t?this._surface.setTileTreeDirty():this._surface.requestUpdate()}resetPendingUpdate(t){return!!this.hasPendingUpdate(t)&&(this._pendingUpdates&=~t,!0)}requestLayerData(t,e,i){const s=this.layerInfo[e][t];if(s.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),e,t),!0;if(s.waitingAgents.push(i),s.data&&!s.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),e,t),i.dataArrived(this),!0;if(s.requestPromise)return!0;K(s.requestAbort),s.requestAbort=new AbortController;const n=this._surface.requestTileData(this,t,e,s.requestAbort);if(!n)return s.requestAbort=null,!1;const r=()=>{s.requestPromise===n&&(s.requestPromise=null,s.requestAbort=null)};return s.requestPromise=n,n.then(r,r),!0}get isLeaf(){return null==this._children[0]}hasLij(t){return this.lij[0]===t[0]&&this.lij[1]===t[1]&&this.lij[2]===t[2]}findByLij(t){return this.hasLij(t)?this:this.isLeaf?null:this._children[0].findByLij(t)||this._children[1].findByLij(t)||this._children[2].findByLij(t)||this._children[3].findByLij(t)||null}distanceToSquared(t){return vs(ts(mP,this._center[1],t))}containsPoint(t){const e=this.extent;return t[0]>=e[0]&&t[1]>=e[1]&&t[0]<=e[2]&&t[1]<=e[3]}unrequestLayerData(t,e,i){const s=this.layerInfo[e][t],n=s.waitingAgents,r=null!=n.removeUnordered(i);yi(r,"agent has not requested this piece of map data"),n.length<1&&(s.abortRequest(),this._updateMemoryUsed())}dataArrived(t,e,i){const s=this.layerInfo[e][t];s.data=i,s.dataInvalidated=!1,s.waitingAgents.forAll((t=>t.dataArrived(this))),s.waitingAgents.clear(),this._updateMemoryUsed()}dataMissing(t,e,i){i.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${e}/${t} error ${i}`);const s=this.layerInfo[e][t];s.dataMissing=!0,s.waitingAgents.forAll((t=>t.dataMissing())),s.waitingAgents.clear(),this._updateMemoryUsed()}updateRenderData(t,e){switch(t){case 1:return this.updateTexture(e);case 0:return this.updateGeometry()}}updateTexture(t){this.renderData&&(this.resetPendingUpdate(0===t?64:128),this.setPendingUpdate(0===t?128:64))}updateGeometry(){this.setPendingUpdate(32);for(const t of this.layerInfo[0])t.pendingUpdates|=32}invalidateLayerData(t,e){this.layerInfo[e][t].invalidateSourceData(),this.restartAgents(e)}computeElevationBounds(){pa(this._elevationBounds,Number.MAX_VALUE,-Number.MAX_VALUE);const t=this.layerInfo[0];let e=!0;for(const i of t)p(i.elevationBounds)&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],i.elevationBounds.min),this._elevationBounds[1]=Math.max(this._elevationBounds[1],i.elevationBounds.max),i.elevationBounds.hasNoDataValues||(e=!1));e&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],0),this._elevationBounds[1]=Math.max(this._elevationBounds[1],0)),this.updateRadiusAndCenter(),this._surface.setTileTreeDirty()}_updateCenter(){Yi(mP,this.up,.5*(this._elevationBounds[0]+this._elevationBounds[1])),Ki(this._center[1],this.centerAtSeaLevel,mP),Yi(mP,this.up,this._elevationBounds[0]),Ki(this._center[0],this.centerAtSeaLevel,mP),Yi(mP,this.up,this._elevationBounds[1]),Ki(this._center[2],this.centerAtSeaLevel,mP)}findElevationBoundsForLayer(t,e){const i=this.layerInfo[0][t];if(p(i.elevationBounds)&&i.elevationBounds.level>=e)return;const s=this._surface.layerViewByIndex(t,0);if(!JS(this,pi(s),!1))return;const n=MP;let r=!1;if(i.data){const t=i.data;n.min=t.bounds[0],n.max=t.bounds[1],n.hasNoDataValues=t.hasNoDataValues,n.level=this.lij[0],r=!0}else{let e,i,s=0;for(let n=this._parent;n&&(!i||s<gi)&&(s=this.vlevel-n.level,e=i||e,i=n.layerInfo[0][t].data,!(!i&&e&&s>=gi));n=n.parent);i=i||e,i&&(i.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],n),n.min!==1/0&&(n.level=i.level,r=!0))}r&&(w(i.elevationBounds)&&(i.elevationBounds=new vS),i.elevationBounds.copyFrom(n))}modifyLayers(t,e,i){const s=this.layerInfo[i];for(const t of s)t.loadingAgent&&t.loadingAgent!==rP&&(xP(t.loadingAgent),t.loadingAgent=null),t.waitingAgents.clear();for(let e=0;e<s.length;++e)void 0===t[e]&&s[e].release();const n=new Array(...s),r=e.length;s.length=r;for(let t=0;t<r;t++){const i=e[t];s[t]=i>-1?n[i]:cP.acquire(this._surface.upsampleInfoPool)}this._updateMemoryUsed()}restartAgents(t){this.renderData&&(this._createOrUpdateAgents(0,t),this.updateRenderData(t,0))}updateAgents(t){if(this.renderData){const e=this.layerInfo[t];for(const t of e)t.loadingAgent===rP&&(t.loadingAgent=null);this._createOrUpdateAgents(0,t)}}updateAgentSuspension(){for(const t of vi){const e=this.isSuspended(t);for(const i of this.layerInfo[t])i.loadingAgent&&i.loadingAgent!==rP&&(i.loadingAgent.setSuspension(e),i.loadingAgent===rP&&this.updateRenderData(t,0))}}removeLayerAgent(t,e){const i=this.layerInfo[e][t];i.loadingAgent&&i.loadingAgent!==rP&&i.loadingAgent.dispose(),i.loadingAgent=null}agentDone(t,e){const i=this.layerInfo[e][t];i.loadingAgent=rP,i.data||i.upsampleInfo||this._createOrUpdateAgents(t+1,e)}_createOrUpdateAgents(t,e){const i=this.isSuspended(e),s=this.layerInfo[e];for(let n=t;n<s.length;++n){const t=s[n];let r=!1;const o=this._surface.layerViewByIndex(n,e),a=pi(o);if(t.loadingAgent?JS(this,a,!1)?(t.loadingAgent!==rP&&t.loadingAgent.setSuspension(i),t.loadingAgent!==rP&&(r=t.loadingAgent.update())):t.dispose():JS(this,a,!1)&&(t.loadingAgent=wP(this,n,e,i),r=t.loadingAgent.startLoading(),r?t.loadingAgent===rP&&this.setPendingUpdate(32):(xP(t.loadingAgent),t.loadingAgent=rP)),t.loadingAgent===rP&&this.updateRenderData(e,0),r&&o.isOpaque)return}}_isWithinExtent(t){const e=this.extent;return e[0]>=t[0]&&t[2]>=e[2]&&e[1]>=t[1]&&t[3]>=e[3]}intersectsExtent(t){const e=this.extent;return e[2]>=t[0]&&t[2]>=e[0]&&e[3]>=t[1]&&t[3]>=e[1]}getElevationBasedVerticesPerRow(t){const e=Math.max(this.level-t,gi-(this.vlevel-this.level));return fs(1+(this.maxTesselation>>e),2,this.maxTesselation+1)}get test(){return{cachedMemory:this.cachedMemory}}}function wP(t,e,i,s){const n=0===i?CP.acquire():bP.acquire();return n.init(t,e,i,s),n}function xP(t){t.dispose(),t instanceof oP?CP.release(t):t instanceof aP&&bP.release(t)}const bP=new xt(aP),CP=new xt(oP),MP=new vS,SP=-1;class PP extends yP{constructor(t,e,i){super(),this.horizontalScaleFactor=1,void 0!==t&&this.init(t,e,i)}init(t,e,i){super.init(t,e,i);const s=i.view.renderSpatialReference,n=p(s)&&zt(s)&&i.spatialReference.isGeographic;this.horizontalScaleFactor=n?this.ellipsoid.radius*Math.PI/180:1,this._edgeLen=(this.extent[2]-this.extent[0])*this.horizontalScaleFactor,this._edgeLen2=this._edgeLen*this._edgeLen,this.centerAtSeaLevel[0]=ys(this.extent[0],this.extent[2],.5)*this.horizontalScaleFactor,this.centerAtSeaLevel[1]=ys(this.extent[1],this.extent[3],.5)*this.horizontalScaleFactor,this.centerAtSeaLevel[2]=0,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const t=(this.extent[2]-this.extent[0])*Math.SQRT1_2,e=.5*(this.elevationBounds[0]-this.elevationBounds[1]);this._center[1][3]=Math.sqrt(t*t+e*e)}_isVisible(t){return Pr(t,this._aabb())}_aabb(){return _n(this.extent[0]*this.horizontalScaleFactor,this.extent[1]*this.horizontalScaleFactor,this.elevationBounds[0],this.extent[2]*this.horizontalScaleFactor,this.extent[3]*this.horizontalScaleFactor,this.elevationBounds[1])}intersectsRay(t,e,i,s,n){TP[0]=1/e[0],TP[1]=1/e[1],TP[2]=1/e[2];const r=n*(this.extent[2]-this.extent[0])*this.horizontalScaleFactor*.1;return dh(this._aabb(),t,TP,i+r,s)}createGeometry(t,e){(function(t,e,i,s,n){const r=e[0],o=e[1],a=e[2]-r,h=e[3]-o,l=t.clippingArea,c=p(l)?Math.max(0,(l[0]-e[0])/a):0,u=p(l)?Math.max(0,(l[1]-e[1])/h):0,d=p(l)?Math.min(1,(l[2]-e[0])/a):1,f=p(l)?Math.min(1,(l[3]-e[1])/h):1,g=d>c?1/(d-c):1,m=f>u?1/(f-u):1,v=-c*g,y=-u*m,w=a*s*.1,x=t.numVertsPerRow-1,b=t.numVertsPerRow-1,C=t.numVertsPerRow*t.numVertsPerRow,M=VS.acquire(C+(2*x+2*b)),S=M.position.typedBuffer,P=M.uv0.typedBuffer,T=n.geometryInfo.boundingBox;yn(T);let A=0;for(let e=0;e<=b;e++){const n=e/b;let c=y+n*m,u=o+n*h;p(l)&&(u<l[1]?(u=l[1],c=0):u>l[3]&&(u=l[3],c=1));for(let n=0;n<=x;n++){const o=n/x;let h=v+o*g,d=r+o*a;p(l)&&(d<l[0]?(d=l[0],h=0):d>l[2]&&(d=l[2],h=1));const f=t.samplerData&&yS.sample(d,u,t.samplerData)||0,m=d*s-i[0],y=u*s-i[1],b=f-i[2];GS(m,y,b,T);const M=di*A;S[M+0]=m,S[M+1]=y,S[M+2]=b,P[M+0]=h,P[M+1]=c;const _=WS(n,e,x,x);if(_>-1){const t=di*(C+_);S[t+0]=m,S[t+1]=y,S[t+2]=b,P[t+0]=qS(h,c),P[t+1]=w}++A}}n.geometryInfo.numVertsPerRow=t.numVertsPerRow,n.geometryInfo.vertexAttributes=M,n.geometryInfo.skirtLength=w,ms(n.geometryInfo.uvOffsetAndScale,c,u,d-c,f-u),BS(n.geometryInfo,t.numVertsPerRow,0,t.wireframe),n.intersectionData=null,n.skirtIntersectionData=null})(t,this.extent,e,this.horizontalScaleFactor,this.renderData),this.setMemoryDirty()}getDefaultVerticesPerRowOnLevel(){return this.level<8?3:2}}const TP=js();class AP extends yP{constructor(t,e,i){super(),this.obb=new Array(8),this.isWebMercator=!1;for(let t=0;t<8;t++)this.obb[t]=js();void 0!==t&&this.init(t,e,i)}init(t,e,i){super.init(t,e,i),this.isWebMercator=i.tilingScheme.spatialReference.isWebMercator;const s=this.ellipsoid.radius,n=this.extentInRadians[0],r=this.extentInRadians[1],o=this.extentInRadians[2],a=this.extentInRadians[3],h=t[0],l=ys(r,a,.5),c=ys(n,o,.5),u=0===h?0:Math.min(Math.abs(r),Math.abs(a));this._edgeLen=(o-n)*Math.cos(u)*s,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=s-Math.sqrt(s*s-this._edgeLen2/4),Ze(this.centerAtSeaLevel,c,l,this.ellipsoid.radius,0);const d=Gs(this.centerAtSeaLevel);is(d,d),this.up=d,this._updateOBB(),this.updateRadiusAndCenter()}updateRadiusAndCenter(){if(0===this.lij[0])ds(this._center[1],0,0,0),ds(this._center[0],0,0,0),ds(this._center[2],0,0,0),this.ellipsoid||(this.ellipsoid=Qr(this.surface.spatialReference)),this._center[1][3]=this.ellipsoid.radius+this.elevationBounds[1];else{this._updateCenter();const t=Math.max(Ji(this._center[1],this.obb[0]),Ji(this._center[1],this.obb[1]));this._center[1][3]=Math.sqrt(t)}}_isVisible(t){if(!vr(t,this._center[1]))return!1;if(this.lij[0]<10)return!0;const e=this.obb;for(let i=0;i<6;i++){const s=4===i,n=t[i];s&&(DP[0]=n[0],DP[1]=n[1],DP[2]=n[2],DP[3]=n[3]-this.surface.view.state.camera.near);const r=s?DP:n;let o;for(o=0;o<8;o++){const t=e[o];if(r[0]*t[0]+r[1]*t[1]+r[2]*t[2]+r[3]<0)break}if(8===o)return!1}return!0}computeElevationBounds(){super.computeElevationBounds(),this._updateOBB()}createGeometry(t,e){const i=this._isPole(this.lij[1],this.lij[0]);(function(t,e,i,s,n,r,o,a){const h=n[0],l=n[1],c=n[2],u=n[3],d=.1*o.radius*(u-l),p=t.numVertsPerRow-1,f=t.numVertsPerRow-1,g=t.numVertsPerRow*t.numVertsPerRow,m=VS.acquire(g+(2*p+2*f)),v=m.position.typedBuffer,y=m.uv0.typedBuffer,w=s.geometryInfo.boundingBox;yn(w);const x=e[2]-e[0],b=e[3]-e[1],C=c-h,M=i[0],S=i[1],P=i[2];for(let t=0;t<=p;t++){const i=t/p,s=h+i*C;HS[t]=Math.sin(s),ZS[t]=Math.cos(s),QS[t]=i,YS[t]=e[0]+i*x}const T=r&&!!(1&a),A=r&&!!(2&a);let _=0;for(let i=0;i<=f;i++){let s=i/f;const n=ys(l,u,s),a=Math.cos(n),h=Math.sin(n);let c;r?(c=o.halfSemiMajorAxis*Math.log((1+h)/(1-h)),s=(c-e[1])/b):c=180*n/Math.PI;for(let e=0;e<=p;e++){const n=QS[e],r=HS[e],l=ZS[e];let u=o.radius;t.samplerData&&(u+=yS.sample(YS[e],c,t.samplerData)||0);const m=l*a*u-M,x=r*a*u-S,b=h*u-P;GS(m,x,b,w);const C=di*_;v[C+0]=m,v[C+1]=x,v[C+2]=b,y[C+0]=n,y[C+1]=s;const D=WS(e,i,p,f);if(D>-1){const t=di*(g+D),e=T&&0===i?-1:A&&i===f?1:0,r=0===e?m:-M,a=0===e?x:-S,h=0===e?b:o.radius*e-P;v[t+0]=r,v[t+1]=a,v[t+2]=h,y[t+0]=0===e?qS(n,s):n,y[t+1]=0===e?d:s,0!==e&&GS(r,a,h,w)}++_}}s.geometryInfo.numVertsPerRow=t.numVertsPerRow,s.geometryInfo.vertexAttributes=m,s.geometryInfo.skirtLength=d,ms(s.geometryInfo.uvOffsetAndScale,0,0,1,1),BS(s.geometryInfo,t.numVertsPerRow,r?a:0,t.wireframe),s.intersectionData=null,s.skirtIntersectionData=null})(t,this.extent,e,this.renderData,this.extentInRadians,this.isWebMercator,this.ellipsoid,i),this.setMemoryDirty()}_updateOBB(){const t=this.extentInRadians,e=this.obb;for(let i=0;i<2;i++){const s=this.elevationBounds[i];let n=4*i;Ze(e[n++],t[0],t[1],this.ellipsoid.radius,s),Ze(e[n++],t[0],t[3],this.ellipsoid.radius,s),Ze(e[n++],t[2],t[3],this.ellipsoid.radius,s),Ze(e[n++],t[2],t[1],this.ellipsoid.radius,s)}if(this.isWebMercator){const t=this._isPole(this.lij[1],this.lij[0]);2===t?(ds(e[1],0,0,this.ellipsoid.radius),ds(e[2],0,0,this.ellipsoid.radius),ds(e[5],0,0,this.ellipsoid.radius),ds(e[6],0,0,this.ellipsoid.radius)):1===t&&(ds(e[0],0,0,-this.ellipsoid.radius),ds(e[3],0,0,-this.ellipsoid.radius),ds(e[4],0,0,-this.ellipsoid.radius),ds(e[7],0,0,-this.ellipsoid.radius))}}_isPole(t,e){let i=0;return t===(1<<e)-1&&(i+=1),0===t&&(i+=2),i}intersectsRay(t,e,i,s,n){const r=this._center[1],o=r[3]+i+.2*this.ellipsoid.radius*Math.abs(n*(this.extentInRadians[3]-this.extentInRadians[1])),a=r[0]-t[0],h=r[1]-t[1],l=r[2]-t[2],c=(a*e[0]+h*e[1]+l*e[2])/(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),u=e[0]*c-a,d=e[1]*c-h,p=e[2]*c-l;return u*u+d*d+p*p<o*o}getDefaultVerticesPerRowOnLevel(){return this.level<_P.length?_P[this.level]+1:2}}const _P=[128,64,32,16,16,8,8,4],DP=Gl();class OP{constructor(t){this._getFadeDuration=t,this._fadeStart=0,this._delayedTime=0}clear(){this._current=Y(this._current),this._next=Y(this._next),this._waiting=Y(this._waiting),this._delayed=Y(this._delayed)}get current(){if(w(this._current))return null;if(!this._isFadingEnabled){const t=this._delayed||this._waiting||this._next||this._current;t!==this._current&&(this._current=null,this.clear(),this._current=t)}let t=OP.test.fadeMoment;if(p(this._delayed)&&(t=t||performance.now(),t>=this._delayedTime&&(this._push(this._delayed,0),this._delayed=null)),p(this._next)){t=t||performance.now();const e=this._fadeDuration,i=p(this._current)&&this._next.texture===this._current.texture,s=0!==this._next.type,n=t-this._fadeStart>=e;(i||s||n)&&(Y(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(t))}return this._current}get next(){return this._next}get fadeFactor(){if(w(this._next))return 1;const t=OP.test.fadeMoment||performance.now(),e=Math.max(0,t-this._fadeStart),i=this._fadeDuration;return e>i?0:1-e/i}get isFading(){return p(this._next)||p(this._delayed)}push(t,e=0){this._delayed=Y(this._delayed),this._push(t,e)}_push(t,e){if(this._isFadingEnabled||this.clear(),w(this._current))return void(this._current=t);const i=OP.test.fadeMoment||performance.now();return 0!==e?(this._delayed=t,void(this._delayedTime=i+e)):w(this._next)?(this._next=t,void(this._fadeStart=this._alignFadeStart(i))):void(w(t)||(Y(this._waiting),this._waiting=t))}get _fadeDuration(){return w(this._waiting)?this._getFadeDuration():.5*this._getFadeDuration()}_alignFadeStart(t){const e=this._getFadeDuration();return t+e-t%e}get _isFadingEnabled(){return this._getFadeDuration()>0}}OP.test={fadeMoment:0};class RP{constructor(){this._scales=[-1,-1,-1,-1],this._offsets=[-1,-1,-1,-1]}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(t,e,i){this._scales[2*t]=e,this._scales[2*t+1]=i}setOffset(t,e,i){this._offsets[2*t]=e,this._offsets[2*t+1]=i}get scales(){return this._scales}get offsets(){return this._offsets}}class FP{constructor(){this.geometryInfo=new jS,this.intersectionData=null,this.skirtIntersectionData=null,this._textureRef=new OP((()=>this.tile.surface.textureFadeDuration)),this.overlay=new RP}init(t){this.tile=t,this.clear();const e=this.geometryInfo;e.indices=null,e.vertexAttributes=null,yn(e.boundingBox),e.numSurfaceIndices=0,e.numSkirtIndices=0,e.numWithoutSkirtIndices=0,e.numVertsPerRow=0,this.intersectionData=null,this.skirtIntersectionData=null,this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},this.localOrigin=null,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear()}updateGeometry(t,e){return!!this._updateGeometryState(e)&&(this._releaseGeometry(),this._createGeometry(t),!0)}releaseGeometry(){return!!this._releaseGeometry()&&(this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},!0)}ensureTexture(t,e){return p(this._texture)&&this._texture.descriptor.width!==t&&this.releaseTexture(),w(this._texture)&&(this._texture=e(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){p(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}_updateGeometryState(t){const e=this._getElevationInfo(),i=e.samplerData?this.tile.getElevationBasedVerticesPerRow(e.maxTileLevel):this.tile.getDefaultVerticesPerRowOnLevel();let s=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(s=null);const n=this.geometryState;let r=!1;return n.numVertsPerRow!==i&&(n.numVertsPerRow=i,r=!0),e.changed&&(n.samplerData=e.samplerData,r=!0),Lt(n.clippingArea,s)||(n.clippingArea=s,r=!0),n.wireframe!==t&&(n.wireframe=t,r=!0),r}_createGeometry(t){this.tile.createGeometry(this.geometryState,this.localOrigin);const e=this.geometryInfo.vertexAttributes,i=this.geometryInfo.indices,s=t.gl;this._vao=new dl(t,Ka,{geometry:vl(e.layout)},{geometry:pl.createVertex(t,s.STATIC_DRAW,e.buffer)},pl.createIndex(t,s.STATIC_DRAW,i))}_releaseGeometry(){return!!this._vao&&(this._vao.dispose(),this._vao=null,function(t){VS.release(t.vertexAttributes),t.vertexAttributes=null,t.indices=null}(this.geometryInfo),!0)}get vao(){return this._vao}setTextureReference(t,e=0){p(t)&&t.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(t,e)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const t=this.geometryState.samplerData,e=this.tile.layerInfo[0],i=e.length;let s=new Array(i),n=0,r=0,o=!1;for(let a=0;a<i;a++){const i=e[a];if(i.upsampleInfo){const e=i.upsampleInfo.tile,h=e.layerInfo[0][a].data,l=h&&h.samplerData;t&&t[n]===l||(o=!0),s[n++]=l,r=Math.max(r,e.lij[0])}else if(i.data){const e=this.tile.surface.layerViewByIndex(a,0);if(JS(this.tile,e.layer,!1)){const e=i.data;t&&t[n]===e.samplerData||(o=!0),s[n++]=e.samplerData,r=this.tile.lij[0]}}}return t&&t.length!==n&&(o=!0),n>0?s.length=n:s=null,{changed:o,samplerData:s,maxTileLevel:r}}get estimatedGeometryMemoryUsage(){const t=ot(this.intersectionData,0,(t=>t.estimatedMemoryUsage))+ot(this.skirtIntersectionData,0,(t=>t.estimatedMemoryUsage+t.vertexPositionBuffer.byteLength));return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength+t}get textureDescriptor(){return p(this._texture)?this._texture.descriptor:null}get test(){return{hasTexture:null!=this._texture}}}class zP{constructor(){this.extent=sa(),this.minLevel=0,this.maxLevel=0,this.callback=null}}class LP{constructor(){this._queries=new pt({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new pt({initialSize:30}),this._queryPool=new xt(zP)}queryVisibleLevelRange(t,e,i,s){const n=this._queryPool.acquire();As(n.extent,t),n.minLevel=e||-Number.MAX_VALUE,n.maxLevel=null!=i?i:Number.MAX_VALUE,n.callback=s,this._queryQueue.push(n)}hasPendingQueries(){return 0!==this._queryQueue.length}prepareQueries(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const t=this._queryQueue.pop();this._queries.push(t)}this._queriesInvPtr=this._queries.length}processQueries(){for(let t=0;t<this._queries.length;t++){const e=this._queries.data[t];this._queryPool.release(e),e.callback(t>=this._queriesInvPtr),e.callback=null}this._queries.clear()}scaleQueriesForTile(t){const e=t.lij[0];let i=0;for(;i<this._queriesInvPtr;){const s=this._queries.data[i],n=s.extent;e>=s.minLevel&&e<=s.maxLevel&&n[0]<=t.extent[2]&&n[2]>=t.extent[0]&&n[1]<=t.extent[3]&&n[3]>=t.extent[1]?(this._queries.swapElements(i,this._queriesInvPtr-1),this._queriesInvPtr--):i++}}}class EP{constructor(){this._renderParams={context:null,drawPhase:1,state:rc(new me({viewpoint:new Se({targetGeometry:new m(0,0),scale:1,rotation:0}),size:[256,256]})),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1}}dispose(){this._renderParams=null}render(t,e,i,s,n,r,o,a,h,l){const c=r.adjustLevel(e[0]),u=this._renderParams;u.context=t,u.painter=s,u.glyphMosaic=s.glyphMosaic,u.spriteMosaic=s.spriteMosaic,u.pixelRatio=l,u.displayLevel=c,u.requiredLevel=c;const d=r.getScale(e[0]),[p,f]=r.getShift(e,o*d),g=.125*o*d/h,m=i.transforms.dvs;m[0]=g,m[4]=-g,m[6]=-1-p-a[0]*o*2,m[7]=1+f+(1-a[1])*o*2-2,u.state.size[0]=h,u.state.size[1]=h,i.stage||i.attachWithContext(t),i.triangleCount=0,s.drawTile(u,i,n)}}function IP(){const t=new Wa;return t.attributes.add("position","vec2"),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("scale","float"),t.vertex.uniforms.add("offset","vec2"),t.varyings.add("uv","vec2"),t.vertex.code.add(Ua`void main(void) {
gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
}`),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(Ua`void main() {
vec4 color = texture2D(tex, uv);
gl_FragColor = vec4(color.xyz, 1.0) * color.a * opacity;
}`),t}const VP=Object.freeze({__proto__:null,build:IP});class jP extends Ya{initializeProgram(t){const e=jP.shader.get().build();return new Xa(t.rctx,e,Ka)}initializePipeline(){const t=2===this.configuration.mode?Uh(1,771):1===this.configuration.mode?Uh(0,770):null;return Gh({blending:t,colorWrite:Wh})}}jP.shader=new $a(VP,(()=>import("./p-1049f3c5.js")));class NP extends Qa{constructor(){super(...arguments),this.mode=0}}function kP(t){t.attributes.add("position","vec2"),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("u_scale","float"),t.vertex.uniforms.add("u_offset","vec2"),t.varyings.add("v_texcoord","vec2"),t.vertex.code.add(Ua`void main(void) {
v_texcoord = uv0 * u_scale + u_offset;
gl_Position = vec4(position, 0.0, 1.0);
}`)}function BP(t){t.fragment.uniforms.add("u_colormap","sampler2D"),t.fragment.uniforms.add("u_colormapOffset","float"),t.fragment.uniforms.add("u_colormapMaxIndex","float"),t.fragment.code.add(Ua`vec4 colormap(vec4 currentPixel, bool isFloat) {
float clrIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || clrIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 clrPosition = vec2((clrIndex + 0.5) / (u_colormapMaxIndex + 1.0), 0.0);
vec4 color = texture2D(u_colormap, clrPosition);
result = vec4(color.rgb, 1.0) * color.a * u_opacity;
}
return result;
}`)}function GP(t){t.fragment.uniforms.add("u_transformGrid","sampler2D"),t.fragment.uniforms.add("u_transformSpacing","vec2"),t.fragment.uniforms.add("u_transformGridSize","vec2"),t.fragment.uniforms.add("u_targetImageSize","vec2"),t.fragment.code.add(Ua`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(0.25 / u_transformGridSize.s, 1.0 / u_transformGridSize.t);
vec2 index_transform = floor(index_image / u_transformSpacing) / u_transformGridSize;
vec2 pos = fract((index_image + vec2(0.5, 0.5)) / u_transformSpacing);
vec2 srcLocation;
vec2 transform_location = index_transform + oneTransformPixel * 0.5;
if (pos.s <= pos.t) {
vec4 ll_abc = texture2D(u_transformGrid, vec2(transform_location.s, transform_location.t));
vec4 ll_def = texture2D(u_transformGrid, vec2(transform_location.s + oneTransformPixel.s, transform_location.t));
srcLocation.s = dot(ll_abc.rgb, vec3(pos, 1.0));
srcLocation.t = dot(ll_def.rgb, vec3(pos, 1.0));
} else {
vec4 ur_abc = texture2D(u_transformGrid, vec2(transform_location.s + 2.0 * oneTransformPixel.s, transform_location.t));
vec4 ur_def = texture2D(u_transformGrid, vec2(transform_location.s + 3.0 * oneTransformPixel.s, transform_location.t));
srcLocation.s = dot(ur_abc.rgb, vec3(pos, 1.0));
srcLocation.t = dot(ur_def.rgb, vec3(pos, 1.0));
}
return srcLocation;;
}`)}function qP(t){t.include(GP),t.fragment.uniforms.add("u_image","sampler2D"),t.fragment.uniforms.add("u_isFloatTexture","bool"),t.fragment.uniforms.add("u_flipY","bool"),t.fragment.uniforms.add("u_applyTransform","bool"),t.fragment.uniforms.add("u_opacity","float"),t.fragment.code.add(Ua`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}
vec4 getPixel(vec2 pixelLocation) {
return texture2D(u_image, pixelLocation);
}`)}function WP(t){const e=new Wa;return e.include(kP),e.include(qP),e.include(BP),0===t.output?function(t,e){t.fragment.uniforms.add("u_bandCount","int"),t.fragment.uniforms.add("u_minCutOff","float",3),t.fragment.uniforms.add("u_maxCutOff","float",3),t.fragment.uniforms.add("u_factor","float",3),t.fragment.uniforms.add("u_minOutput","float"),t.fragment.uniforms.add("u_maxOutput","float"),t.fragment.uniforms.add("u_useGamma","bool"),t.fragment.uniforms.add("u_gamma","float",3),t.fragment.uniforms.add("u_gammaCorrection","float",3),t.fragment.code.add(Ua`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const i=e.applyColormap?Ua`gl_FragColor = colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma);`:Ua`gl_FragColor = vec4(grayVal, grayVal, grayVal, 1.0) * currentPixel.a * u_opacity;`;t.fragment.code.add(Ua`
      void main() {
        vec2 pixelLocation = getPixelLocation(v_texcoord);
        if (isOutside(pixelLocation)) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        ${0===e.stretchType?Ua`
        gl_FragColor = vec4(currentPixel.rgb, 1.0) * currentPixel.a * u_opacity;`:Ua`
        if (currentPixel.a == 0.0) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }
        if (u_bandCount == 1) {
          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          ${i}
        } else {
          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
          gl_FragColor = vec4(redVal, greenVal, blueVal, 1.0) * currentPixel.a * u_opacity;
        }`}
      }`)}(e,t):1===t.output?function(t){t.fragment.code.add(Ua`void main() {
vec2 pixelLocation = getPixelLocation(v_texcoord);
if (isOutside(pixelLocation)) {
gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
return;
}
vec4 currentPixel = getPixel(pixelLocation);
gl_FragColor = colormap(currentPixel, true);
}`)}(e):2===t.output&&function(t,e){t.fragment.uniforms.add("u_hillshadeType","int"),t.fragment.uniforms.add("u_sinZcosAs","float",6),t.fragment.uniforms.add("u_sinZsinAs","float",6),t.fragment.uniforms.add("u_cosZs","float",6),t.fragment.uniforms.add("u_weights","float",6),t.fragment.uniforms.add("u_factor","vec2"),t.fragment.uniforms.add("u_applyColormap","bool"),t.fragment.uniforms.add("u_minValue","float"),t.fragment.uniforms.add("u_maxValue","float"),t.fragment.uniforms.add("u_srcImageSize","vec2"),t.fragment.include(ih),t.fragment.code.add(Ua`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 rgb = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(rgb.xyz);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv) * alpha, alpha);
}`),t.fragment.code.add(Ua`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const i=e.applyColormap?Ua`gl_FragColor = overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha);`:Ua`hillshade *= alpha;
gl_FragColor = vec4(hillshade, hillshade, hillshade, alpha);`;t.fragment.code.add(Ua`
    void main() {
      vec2 pixelLocation = getPixelLocation(v_texcoord);
      if (isOutside(pixelLocation)) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture2D(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture2D(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture2D(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture2D(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture2D(u_image, pixelLocation);
      vec4 vf = texture2D(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture2D(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture2D(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture2D(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${i}
    }
  `)}(e,t),e}r([Za({count:3})],NP.prototype,"mode",void 0);const UP=Object.freeze({__proto__:null,build:WP});class HP extends Ya{get uniformLocationInfos(){return this._uniformLocationInfos||(this._uniformLocationInfos=jc(this._context,this.program)),this._uniformLocationInfos}initializeProgram(t){const e=HP.shader.get(),i=this.configuration,s=e.build({output:i.colorizerType,applyColormap:i.applyColormap,stretchType:i.stretchType});return this._context=t.rctx,new Xa(t.rctx,s,Ka)}initializePipeline(){const t=2===this.configuration.mode?Uh(1,771):1===this.configuration.mode?Uh(0,770):null;return Gh({blending:t,colorWrite:Wh})}bindPass(t){Nc(this.program,this.uniformLocationInfos,t.basic),Nc(this.program,this.uniformLocationInfos,t.common),p(t.colormap)&&Nc(this.program,this.uniformLocationInfos,t.colormap),0===this.configuration.colorizerType&&p(t.stretch)?Nc(this.program,this.uniformLocationInfos,t.stretch):2===this.configuration.colorizerType&&p(t.hillshade)&&Nc(this.program,this.uniformLocationInfos,t.hillshade)}}HP.shader=new $a(UP,(()=>import("./p-609eaf43.js")));class ZP extends Qa{constructor(){super(...arguments),this.mode=2,this.colorizerType=0,this.stretchType=0,this.applyColormap=!0}}r([Za({count:3})],ZP.prototype,"mode",void 0),r([Za({count:3})],ZP.prototype,"colorizerType",void 0),r([Za({count:2})],ZP.prototype,"stretchType",void 0),r([Za()],ZP.prototype,"applyColormap",void 0);class QP{constructor(t,e,i,s,n,r,o){this.texture=t,this.type=e,t.retain(),this.offsetAndScale=na(i.offset[0],i.offset[1],i.scale,i.scale),this.opacities=Ns(s,o?r:0,n)}destroy(){this.texture.release()}}class YP{constructor(t){this._rctx=t,this._pools=new Map}acquire(t){return this.getPool(t).acquire()}release(t){this.getPool(t.width).release(t)}clear(){this._pools.forEach((t=>t.destroy())),this._pools.clear()}getPool(t){let e=this._pools.get(t);if(!e){const i=cl.bind(cl,this._rctx,{colorTarget:0,depthStencilTarget:1,width:t,height:t});e=new xt(i),this._pools.set(t,e)}return e}}class XP{constructor(t,e,i){this._rctx=t,this.tileSize=e,this._techniqueRepository=i,this._backgroundIsGrid=!1,this._backgroundTexture=null,this._backgroundColor=null,this._blackTex=null,this._vectorTileHelper=new EP,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._vaoQuad=Ja(this._rctx,th),this._blackTex=new pP(ph(this._rctx,[0,0,0,1])),this._fboPool=new YP(this._rctx)}dispose(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad=Q(this._vaoQuad),this._backgroundTexture=Z(this._backgroundTexture),this._blackTex=Z(this._blackTex),this._blendLayersTechnique=Q(this._blendLayersTechnique),this._applyOpacityTechnique=Q(this._applyOpacityTechnique),this._vectorTileHelper=Q(this._vectorTileHelper)}get blendLayersTechnique(){if(w(this._blendLayersTechnique)){const t=new NP;t.mode=2,this._blendLayersTechnique=this._techniqueRepository.acquire(jP,t)}return this._blendLayersTechnique}get applyOpacityTechnique(){if(w(this._applyOpacityTechnique)){const t=new NP;t.mode=1,this._applyOpacityTechnique=this._techniqueRepository.acquire(jP,t)}return this._applyOpacityTechnique}get backgroundIsGrid(){return this._backgroundIsGrid}get backgroundColor(){return this._backgroundColor}updateTileTexture(t,e){const i=t.layerInfo[1];for(const t of i)t.pendingUpdates&=-1;if(!t.renderData)return;const s=t.surface,n=s.baseOpacity;let r=0,o=0,a=this.tileSize,h=!1;const l=s.view.pixelRatio;let c=i.length,u=0;for(;u<i.length&&!h;u++){const e=s.layerViewByIndex(u,1),d=e.fullOpacity;if($P[u]=d,xi(e.layer)&&c>=i.length&&(c=u),0===d)continue;++o;const p=KP(t,u,JP);p&&(bi(e)?a=Math.max(a,this.tileSize*l):1===n&&1===d&&(e.isOpaque||this._dataToTexture(p)&&p.sourceLayerInfo.data.descriptor.isOpaque)&&(h=!0),++r)}this._cleanupFBOPool(l,i.length),a=function(t){const e=Ms(t),i=e*e,s=t*t;if(i===s)return t;const n=e/2;return i-s<s-n*n?e:n}(a);const d=a/this.tileSize,f=u-1;0!==r?1===r&&(h||this._backgroundIsGrid||p(this._backgroundColor))&&this._useLayerTexture(t,f,c,$P[f])||this._composeMapLayers(t,e,f,c,h,$P,a,d):this._useBackgroundTexture(t,o)}_useBackgroundTexture(t,e){let i=0;(t.surface.view.layerViewManager.updating||e>0)&&(i=5e3),this._backgroundTexture&&w(t.renderData.textureReference)&&(i=0),t.renderData.setTextureReference(p(this._backgroundTexture)?new QP(this._backgroundTexture,0,tT,t.surface.baseOpacity,1,1,!1):null,i)}_useLayerTexture(t,e,i,s){const n=e<i,r=n?1:t.surface.baseOpacity,o=n?t.surface.baseOpacity:1,a=KP(t,e,JP);return!!this._dataToTexture(a)&&(t.renderData.setTextureReference(new QP(a.sourceLayerInfo.data,0,a,r,s,o,!0)),!0)}_composeMapLayers(t,e,i,s,n,r,o,a){const h=this._rctx,l=this._fboPool.acquire(o);h.bindFramebuffer(l),h.setViewport(0,0,o,o),h.setClearColor(0,0,0,0),h.setClearDepth(1),h.clearSafe(16640);let c=!1;!n&&p(this._backgroundTexture)&&this._drawRasterData(this.blendLayersTechnique,this._backgroundTexture.texture,1,Ta);const u=t.surface.baseOpacity;let d=!1,f=9987;for(let e=i;e>=0;e--){const i=KP(t,e,JP);i&&(e<s&&u<1&&!d&&(this._drawRasterData(this.applyOpacityTechnique,this._blackTex.texture,1,Ta,u),d=!0),0!==r[e]&&(Ci(i)?c=this._drawVectorData(this.blendLayersTechnique,i,a,r[e],o,l,c):Mi(i)?(this._drawImageryTileData(i,r[e]),this.hasNearestInterpolation(i)&&(f=9728)):this._dataToTexture(i)&&this._drawRasterData(this.blendLayersTechnique,i.sourceLayerInfo.data.texture,i.scale,i.offset,r[e])))}const g=t.renderData.ensureTexture(o,(()=>this._buildTexture(o,f))),m=h.bindTexture(g.texture,ml.TEXTURE_UNIT_FOR_UPDATES),v=g.descriptor;h.gl.copyTexImage2D(h.gl.TEXTURE_2D,0,v.pixelFormat,0,0,v.width,v.height,0),g.generateMipmap(),h.bindTexture(m,ml.TEXTURE_UNIT_FOR_UPDATES),h.bindFramebuffer(null),this._fboPool.release(l),t.renderData.setTextureReference(new QP(g,e,tT,d?1:u,1,1,!1))}_drawQuad(t){this._rctx.bindVAO(this._vaoQuad),t.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(5,0,ul(this._vaoQuad,"geometry"))}_drawRasterData(t,e,i,s,n=1){if(w(e))return;const r=this._rctx,o=t.program;t.bindPipelineState(r),r.useProgram(o),o.bindTexture(e,"tex"),o.setUniform1f("scale",i),o.setUniform2f("offset",s[0],s[1]),o.setUniform1f("opacity",n),this._drawQuad(o)}hasNearestInterpolation(t){const e=t.sourceLayerInfo.data;return!!e.source&&"nearest"===e.interpolation}_drawImageryTileData(t,e=1){const i=t.sourceLayerInfo.data;if(!i.source)return;t.tile.surface.layerViewByIndex(t.layerIndex,1).ensureSymbolizerParameters(i);const s=this._getRasterColorizerTechnique(i),n=this._rctx,r=s.program;if(s.bindPipelineState(n),n.useProgram(r),!i.bind(n))return;i.opacity=e,i.scale=t.scale,i.offset=t.offset;const{names:o,textures:a}=i.getTextures();o.forEach(((t,e)=>r.bindTexture(a[e],t))),s.bindPass(i.getUniforms()),this._drawQuad(r),n.bindVAO()}_getRasterColorizerTechnique(t){const e=t.symbolizerParameters,i=["stretch","lut","hillshade"].indexOf(e.type);return w(this._rasterColorizerConfig)&&(this._rasterColorizerConfig=new ZP,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.colorizerType=i,this._rasterColorizerConfig.applyColormap=!!e.colormap,this._rasterColorizerConfig.stretchType=t.hasStretchTypeNone()?0:1,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(HP,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}_drawVectorData(t,e,i,s,n,r,o){const a=this._rctx,h=e.sourceLayerInfo.data,l=e.tile.surface.layerViewByIndex(e.layerIndex,1);let c;return t.bindPipelineState(a),s<1?(c=this._fboPool.acquire(n),a.bindFramebuffer(c),a.setClearColor(1,1,1,0),a.clearSafe(16640)):o&&a.clearSafe(256),this._vectorTileHelper.render(a,e.sourceLod,h,l.painter,l.layer.styleRepository,l.schemaHelper,Math.round(1/e.scale),e.offset,this.tileSize,i),!p(c)||(a.bindFramebuffer(r),this._drawRasterData(t,c.colorTexture,1,[0,0],s),this._fboPool.release(c),o)}_dataToTexture(t){return Si(t)&&this._rasterDataToTexture(t),Pi(t)}_rasterDataToTexture(t){const e=t.sourceLayerInfo;e.data=this._buildTexture(e.data),t.tile.setMemoryDirty()}setBackground(t,e){Z(this._backgroundTexture),this._backgroundIsGrid=e,t instanceof HTMLImageElement?(this._backgroundTexture=this._buildTexture(t),this._backgroundColor=null):(this._backgroundTexture=new pP(ph(this._rctx,na(t[0]||0,t[1]||0,t[2]||0,1))),this._backgroundColor=Ns(t[0]||0,t[1]||0,t[2]||0))}_buildTexture(t,e=9987){if(w(t))return null;const i={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:e,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},s=this._rctx;let n;if("number"==typeof t)i.width=i.height=t,n=new pP(new ml(s,i));else if(t instanceof wi)i.isOpaque=t.isOpaque,n=new pP(new ml(s,i,t.image)),t.release();else try{n=new pP(new ml(s,i,t))}catch(t){n=new pP(fh(s)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const r=s.bindTexture(n.texture,ml.TEXTURE_UNIT_FOR_UPDATES);return n.generateMipmap(),s.bindTexture(r,ml.TEXTURE_UNIT_FOR_UPDATES),n}_cleanupFBOPool(t,e){t===this._lastPixelRatio&&e===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=t,this._lastNumLayers=e)}get test(){return{backgroundTexture:this._backgroundTexture}}}function KP(t,e,i){i.layerIndex=e;const s=t.layerInfo[1][e];if(s.data)return pa(i.offset,0,0),i.tile=t,i.scale=1,i.sourceLod=t.lij,i.sourceLayerInfo=s,i;const n=s.upsampleInfo;if(n){const t=n.tile.layerInfo[1][e];return i.tile=n.tile,ga(i.offset,n.offset),i.scale=n.scale,i.sourceLod=n.tile.lij,i.sourceLayerInfo=t,i}return null}const $P=new Array,JP={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},tT={offset:[0,0],scale:1},eT=1e-6;class iT{constructor(t,e,i,s,n){this.aabb=t,this.axis=e,this.d=i,this.midStartIndex=s,this.rightStartIndex=n}}class sT{constructor(t,e,i,s){this.globalTriangleVertexIndices=t,this.firstTriangleIndex=e,this.positionAttribute=s,this.rayDirection=js(),this.bspNodeTree=new Array,this.vertexPositionBuffer=s.data,this.vertexPositionStride=s.stride;const n=i-e,r=n<=aT?new Uint16Array(n):new Uint32Array(n);this.indices=r;for(let t=0;t<n;++t)r[t]=t;{const o=function(t,e,i,s,n){const r=i-e,o=new Float32Array(6*r);for(let i=0;i<r;++i){const r=3*(i+e),a=t[r+0]*n,h=t[r+1]*n,l=t[r+2]*n;for(let t=0;t<3;++t){const e=s[a+t],n=s[h+t],r=s[l+t];o[6*i+t]=Math.min(e,n,r),o[6*i+3+t]=Math.max(e,n,r)}}return o}(t,e,i,s.data,s.stride),a=(t,e,i)=>{const s=function(t,e,i,s){if(s<=i)return Dn(NaN,NaN,NaN,NaN,NaN,NaN);{const s=6*t[i];for(let t=0;t<3;++t)rT[t]=e[s+0+t],oT[t]=e[s+3+t]}for(let n=i+1;n<s;++n){const i=6*t[n];for(let t=0;t<3;++t)rT[t]=Math.min(rT[t],e[i+0+t]),oT[t]=Math.max(oT[t],e[i+3+t])}return Dn(rT[0],rT[1],rT[2],oT[0],oT[1],oT[2])}(r,o,t,e),n=e-t;if(n<=20){const i=new iT(s,void 0,0,t,e);return this.bspNodeTree.push(i),i}const{axis:h,midValue:l}=function(t){const e=t[3]-t[0],i=t[4]-t[1],s=t[5]-t[2],n=e>i?e>s?0:i>s?1:2:i>s?1:s>e?2:0;return{axis:n,midValue:(t[n]+t[n+3])/2}}(s),c=function(t,e,i,s,n,r){let o=i,a=s;for(;o<a;){const i=t[o];e[6*i+n+3]<=r?++o:(--a,t[o]=t[a],t[a]=i)}let h=o;for(a=s;h<a;){const i=t[a-1];e[6*i+n]>=r?--a:(t[a-1]=t[h],t[h]=i,++h)}return{next:o,mid:h}}(r,o,t,e,h,l),u=(t,e)=>{if(i>15)return;const s=e-t;return s<20||s>=.8*n?void 0:a(t,e,i+1)},d=new iT(s,h,l,c.next,c.mid);return this.bspNodeTree.push(d),d.leftNode=u(t,c.next),d.rightNode=u(c.mid,e),d};a(0,n,0),this.triangleVertexIndices=function(t,e,i,s){const n=s-i;let r=0;for(let t=i;t<s;++t)for(let i=0;i<3;++i)r=Math.max(e[3*t+i],r);const o=r<=aT?new Uint16Array(3*n):new Uint32Array(3*n);for(let s=0;s<n;++s){const n=3*(t[s]+i);for(let t=0;t<3;++t)o[3*s+t]=e[n+t]}return o}(r,t,e,i)}}intersectRayTriangleRange(t,e){{if(t>=e)return;const i=this.triangleVertexIndices,s=this.positionAttribute.data,n=this.positionAttribute.stride,r=this.rayOrigin,o=r[0],a=r[1],h=r[2],l=this.rayDirection,c=l[0],u=l[1],d=l[2];for(let r=t,l=3*t;r<e;++r){const t=i[l]*n,e=s[t],p=s[t+1],f=s[t+2],g=i[l+1]*n,m=i[l+2]*n;l+=3;const v=s[g]-e,y=s[g+1]-p,w=s[g+2]-f,x=s[m]-e,b=s[m+1]-p,C=s[m+2]-f,M=u*C-b*d,S=d*x-C*c,P=c*b-x*u,T=v*M+y*S+w*P;if(Math.abs(T)<=Number.EPSILON)continue;const A=o-e,_=a-p,D=h-f,O=A*M+_*S+D*P;if(T>0){if(O<0||O>T)continue}else if(O>0||O<T)continue;const R=_*w-y*D,F=D*v-w*A,z=A*y-v*_,L=c*R+u*F+d*z;if(T>0){if(L<0||O+L>T)continue}else if(L>0||O+L<T)continue;const E=(x*R+b*F+C*z)/T;if(E>=0){const t=this.indices[r]+this.firstTriangleIndex,e=uh(v,y,w,x,b,C,nT);this.callback(E,e,t)}}}sT.numFacesTested+=e-t}intersectRay(t,e){sT.numFacesTested=0;const i=Ns(t.r0[0],t.r0[1],t.r0[2]),s=Ns(t.r1[0],t.r1[1],t.r1[2]),n=s[0]-i[0],r=s[1]-i[1],o=s[2]-i[2];if(n*n+r*r+o*o<eT)return;this.rayOrigin=i;const a=this.rayDirection;a[0]=n,a[1]=r,a[2]=o;const h=this.triangleVertexIndices.length/3;this.callback=e,this.intersectRayBSP(this.bspNodeTree[0],0,h)}intersectRayBSP(t,e,i){const s=this.rayOrigin,n=this.rayDirection;if(!function(t,e,i){const s=e,n=i;let r=0,o=1/0;for(let e=0;e<3;++e){{const i=t[e];if(s[e]<i){if(n[e]<=eT)return!1;r=Math.max(r,(i-s[e])/n[e])}else n[e]<=-eT&&(o=Math.min(o,(i-s[e])/n[e]));if(r>o)return!1}{const i=t[e+3];if(s[e]>i){if(n[e]>=-eT)return!1;r=Math.max(r,(i-s[e])/n[e])}else n[e]>=eT&&(o=Math.min(o,(i-s[e])/n[e]));if(r>o)return!1}}return!0}(t.aabb,s,n))return;const r=t.axis,o=t.d;if(s[r]<o||n[r]<0){const i=e,s=t.midStartIndex;if(i<s){const e=t.leftNode;void 0!==e?this.intersectRayBSP(e,i,s):this.intersectRayTriangleRange(i,s)}}if(this.intersectRayTriangleRange(t.midStartIndex,t.rightStartIndex),s[r]>o||n[r]>0){const e=t.rightStartIndex,s=i;if(e<s){const i=t.rightNode;void 0!==i?this.intersectRayBSP(i,e,s):this.intersectRayTriangleRange(e,s)}}}get estimatedMemoryUsage(){return this.triangleVertexIndices.byteLength+this.indices.byteLength}}sT.numFacesTested=0;const nT=js(),rT=[1/0,1/0,1/0],oT=[-1/0,-1/0,-1/0],aT=65535;function hT(t,e){t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.vertex.code.add(1===e.viewingMode?Ua`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`:Ua`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),t.fragment.code.add(Ua`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}function lT(t,e){t.extensions.add("GL_OES_standard_derivatives"),3!==e.pbrMode&&4!==e.pbrMode||t.include(Tr,e),t.vertex.uniforms.add("overlayTexOffset","vec4"),t.vertex.uniforms.add("overlayTexScale","vec4"),t.varyings.add("vtcOverlay","vec4"),t.vertex.code.add(Ua`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),t.fragment.uniforms.add("ovColorTex","sampler2D"),t.fragment.uniforms.add("overlayOpacity","float"),t.fragment.code.add(Ua`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture2D(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture2D(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),t.fragment.code.add(Ua`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),3!==e.pbrMode&&4!==e.pbrMode||(t.include(_a),t.fragment.code.add(Ua`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, lightingMainDirection, colorInput.rgb, lightingMainIntensity, localUp, 1.0 - shadow, maskInput.w, position);
return vec4(final, colorInput.w);
}`))}function cT(t){t.vertex.code.add(Ua`vec3 applySkirts(inout vec2 uv, vec3 vpos, vec3 vnormal, float skirtScale) {
float skirtLength = 0.0;
if (uv.x >= 2.0) {
skirtLength = uv.y * skirtScale;
vec2 x = vec2(uv.x) - vec2(3.5, 4.5);
uv = clamp(vec2(1.5) - abs(x), vec2(0.0), vec2(1.0));
}
return vpos - vnormal * skirtLength;
}`)}function uT(t,e){t.varyings.add("vtc","vec2"),t.vertex.uniforms.add("texOffsetAndScale","vec4"),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("textureOpacities","vec3"),e.textureFadingEnabled&&(t.vertex.uniforms.add("nextTexOffsetAndScale","vec4"),t.varyings.add("nvtc","vec2"),t.fragment.uniforms.add("texNext","sampler2D"),t.fragment.uniforms.add("nextTexOpacities","vec3"),t.fragment.uniforms.add("fadeFactor","float")),t.vertex.code.add(Ua`
  void forwardTextureCoordinates(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${e.textureFadingEnabled?Ua`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:Ua``}
  }`),e.useGrid?(t.fragment.code.add(Ua`float lineFactorAtPosition(float value) {
float pos = value * 129.0;
if(pos < 0.5 || pos > 128.5) {
return 1.0;
}
pos = pos + 0.5;
float modulo = mod(pos, 16.0);
return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
}
float lineFactorAtUV(vec2 uv) {
return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
}
float lineFactor(vec2 uv) {
vec2 offset = fwidth(uv) * 0.25;
return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
}
vec4 gridColor(vec2 uv) {
float line = lineFactor(uv) * 0.1 + 0.9;
float backgroundOpacity = textureOpacities.y;
return vec4(1.0, 0.972, 0.918, 1.0) * line * backgroundOpacity;
}`),t.fragment.code.add(Ua`vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
if (opacities.y <= 0.0) {
return color * opacities.z * opacities.x;
}
vec4 grid = gridColor(uv);
float alpha = opacities.z * color.a;
return mix(grid, color, alpha) * opacities.x;
}`)):e.hasBackgroundColor?(t.fragment.uniforms.add("backgroundColor","vec3"),t.fragment.code.add(Ua`vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
if (opacities.y <= 0.0) {
return color * opacities.z * opacities.x;
}
float alpha = opacities.z * color.a;
float backgroundOpacity = opacities.y;
return mix(vec4(backgroundColor, 1.0) * backgroundOpacity, color, alpha) * opacities.x;
}`)):t.fragment.code.add(Ua`vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
return color;
}`),t.fragment.code.add(e.textureFadingEnabled?Ua`vec4 getTileColor() {
vec4 color = getColor(texture2D(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture2D(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`:Ua`vec4 getTileColor() {
return getColor(texture2D(tex, vtc), vtc, textureOpacities);
}`)}function dT(t){const e=new Wa;if(e.include(Ra,{name:"Terrain Shader",output:t.output}),e.include(cT),e.attributes.add("position","vec3"),e.attributes.add("uv0","vec2"),e.vertex.uniforms.add("proj","mat4").add("view","mat4").add("origin","vec3").add("skirtScale","float"),0===t.output){e.include(nh,{linearDepth:!1}),e.include(Ar,t),e.include(uT,t);const i=0!==t.overlayMode,s=2===t.overlayMode;i&&e.include(lT,{pbrMode:3,useCustomDTRExponentForWater:!1,ssrEnabled:t.ssrEnabled,highStepCount:t.highStepCount}),s&&e.include(hT,t),e.varyings.add("vnormal","vec3"),e.varyings.add("vpos","vec3"),e.vertex.uniforms.add("viewNormal","mat4"),t.receiveShadows&&e.varyings.add("linearDepth","float"),t.tileBorders&&e.varyings.add("vuv","vec2"),t.atmosphere&&(e.vertex.uniforms.add("lightingMainDirection","vec3"),e.varyings.add("wnormal","vec3"),e.varyings.add("wlight","vec3")),t.screenSizePerspective&&(e.vertex.uniforms.add("screenSizePerspective","vec4"),e.varyings.add("screenSizeDistanceToCamera","float"),e.varyings.add("screenSizeCosAngle","float")),e.vertex.code.add(Ua`
      void main(void) {
        vpos = position;
        vnormal = getLocalUp(vpos, origin);

        vec2 uv = uv0;
        vpos = applySkirts(uv, vpos, vnormal, skirtScale);
        ${t.atmosphere?Ua`
        wnormal = normalize((viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz);
        wlight = normalize((view  * vec4(lightingMainDirection, 1.0)).xyz);`:""}
        ${t.tileBorders?Ua`vuv = uv;`:""}
        ${t.screenSizePerspective?Ua`
        vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
        screenSizeDistanceToCamera = length(viewPos);
        vec3 viewSpaceNormal = (viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz;
        screenSizeCosAngle = abs(viewSpaceNormal.z);`:""}
        gl_Position = transformPosition(proj, view, vpos);
        ${t.receiveShadows?Ua`linearDepth = gl_Position.w;`:""}
        forwardTextureCoordinates(uv);
        ${i?Ua`setOverlayVTC(uv);`:""}
        ${s?Ua`forwardVertexTangent(vnormal);`:Ua``}
      }
    `),e.extensions.add("GL_OES_standard_derivatives"),e.extensions.add("GL_EXT_shader_texture_lod"),e.include(gh,t),e.include(Fa,t),e.fragment.uniforms.add("camPos","vec3").add("viewDirection","vec3").add("ssaoTex","sampler2D").add("viewportPixelSz","vec4"),t.screenSizePerspective&&e.fragment.uniforms.add("screenSizePerspective","vec4"),s&&(e.fragment.uniforms.add("ovWaterTex","sampler2D"),e.fragment.uniforms.add("view","mat4")),e.fragment.code.add(Ua`const float sliceOpacity = 0.2;
float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),e.fragment.code.add(Ua`
      void main() {
        ${t.receiveShadows?Ua`float shadow = readShadowMap(vpos, linearDepth);`:Ua`float shadow = 0.0;`}
        float vndl = dot(normalize(vnormal), lightingMainDirection);

        float ssao = viewportPixelSz.w < .0 ? 1.0 : texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
        vec4 tileColor = getTileColor();
        ${i?Ua`
            vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
            vec4 overlayColor = overlayOpacity * overlayColorOpaque;
            vec4 groundColor = tileColor;
            tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`:""}
        if (rejectBySlice(vpos)) {
          tileColor *= sliceOpacity;
        }
        ${t.atmosphere?Ua`
            float ndotl = clamp(vndl, 0.0, 1.0);
            vec3 atm = vec3(max(0.0, dot(wlight, wnormal)) + clamp(1.0 - dot(-viewDirection, wnormal), 0.0, 1.0));
            atm *= clamp(1.0 - lum(tileColor.rgb) * 1.5, 0.0, 1.0); //avoid atmosphere on bright base maps
            atm *= clamp(ndotl * 2.0, 0.0, 1.0); // avoid atmosphere on dark side of the globe
            atm *= tileColor.a; // premultiply with tile alpha`:""}

        vec3 albedo = ${t.atmosphere?Ua`atm + tileColor.rgb;`:Ua`tileColor.rgb;`}
        vec3 normal = normalize(vnormal);

        // heuristic shading function used in the old terrain, now used to add ambient lighting
        float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

        gl_FragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);
        ${s?Ua`
            vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
            float waterNormalLength = length(overlayWaterMask);
            if (waterNormalLength > 0.95) {
              mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
              vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
              vec4 viewPosition = view*vec4(vpos, 1.0);
              vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - camPos), shadow, vnormal, tbnMatrix, viewPosition.xyz);
              vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
              // un-gamma the ground color to mix in linear space
              gl_FragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w);
            }`:""}
        ${t.screenSizePerspective?Ua`
          float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, screenSizePerspective);
          if (perspectiveScale <= 0.25) {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
          }
          else if (perspectiveScale <= 0.5) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
          }
          else if (perspectiveScale >= 0.99) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
          }
          else {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
          }`:""}
        ${t.tileBorders?Ua`
            vec2 dVuv = fwidth(vuv);
            vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv, 1.0 - vuv));
            float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`:""}
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
      }
    `)}return 1!==t.output&&3!==t.output||(e.include(nh,{linearDepth:!0}),e.include(mh,{output:t.output}),e.include(Ar,t),e.varyings.add("linearDepth","float"),e.vertex.uniforms.add("nearFar","vec2"),e.vertex.code.add(Ua`void main(void) {
vec3 normal = getLocalUp(position, origin);
vec2 uv = uv0;
vec3 vpos = applySkirts(uv, position, normal.xyz, skirtScale);
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);
}`),e.fragment.code.add(Ua`void main() {
outputDepth(linearDepth);
}`)),2===t.output&&(e.include(nh,{linearDepth:!1}),e.include(Ar,t),e.varyings.add("vnormal","vec3"),e.varyings.add("vpos","vec3"),e.vertex.uniforms.add("viewNormal","mat4"),e.vertex.code.add(Ua`void main(void) {
vec3 normal = getLocalUp(position, origin);
vec2 uv = uv0;
vpos = applySkirts(uv, position, normal, skirtScale);
gl_Position = transformPosition(proj, view, vpos);
vnormal = normalize((viewNormal * vec4(normal, 1.0)).xyz);
}`),e.fragment.code.add(Ua`void main() {
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) {
normal = -normal;
}
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 0.0);
}`)),4===t.output&&(e.include(nh,{linearDepth:!1}),e.include(Ar,t),e.include(lT,{pbrMode:0}),e.vertex.code.add(Ua`void main() {
vec3 vnormal = getLocalUp(position, origin);
vec2 uv = uv0;
vec3 vpos = applySkirts(uv, position, vnormal, skirtScale);
setOverlayVTC(uv);
gl_Position = transformPosition(proj, view, vpos);
}`),e.include(vh),e.fragment.code.add(Ua`void main() {
vec4 overlayColor = getCombinedOverlayColor();
if (overlayColor.a == 0.0) {
gl_FragColor = vec4(0.0);
return;
}
outputHighlight();
}`)),e}const pT=Object.freeze({__proto__:null,build:dT});class fT extends Ya{constructor(){super(...arguments),this.useStencil=!1}initializeProgram(t){const e=fT.shader.get(),i=this.configuration,s=e.build({overlayMode:i.overlayMode,output:i.output,viewingMode:t.viewingMode,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,textureFadingEnabled:i.textureFadingEnabled&&!i.renderOccluded,hasBackgroundColor:i.hasBackgroundColor,useGrid:i.useGrid,receiveShadows:i.receiveShadows&&!i.renderOccluded,receiveAmbientOcclusion:!1,atmosphere:i.atmosphere,tileBorders:i.tileBorders,screenSizePerspective:i.screenSizePerspective,pbrMode:0,ssrEnabled:i.ssrEnabled,highStepCount:!1});return new Xa(t.rctx,s,Ka)}initializePipeline(){return this._stencilPipelineState=this.createPipeline(!0),this.createPipeline(!1)}createPipeline(t){const e=this.configuration,i=e.backfaceCullingEnabled&&!e.renderOccluded;return Gh({blending:e.renderOccluded?Uh(1,771):null,culling:i&&Hh,depthTest:!e.renderOccluded&&{func:513},depthWrite:!e.renderOccluded&&Qh,colorWrite:Wh,stencilTest:t?yh(1):null})}getPipelineState(t,e){return this.useStencil?this._stencilPipelineState:super.getPipelineState(t,e)}}fT.shader=new $a(pT,(()=>import("./p-4db08bfb.js")));class gT extends Qa{constructor(){super(...arguments),this.output=0,this.overlayMode=0,this.atmosphere=!1,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.backfaceCullingEnabled=!1,this.stencilEnabled=!1,this.textureFadingEnabled=!1,this.hasBackgroundColor=!1,this.useGrid=!1,this.renderOccluded=!1,this.ssrEnabled=!1,this.tileBorders=!1,this.screenSizePerspective=!1}}r([Za({count:8})],gT.prototype,"output",void 0),r([Za({count:3})],gT.prototype,"overlayMode",void 0),r([Za()],gT.prototype,"atmosphere",void 0),r([Za()],gT.prototype,"receiveShadows",void 0),r([Za()],gT.prototype,"slicePlaneEnabled",void 0),r([Za()],gT.prototype,"backfaceCullingEnabled",void 0),r([Za()],gT.prototype,"stencilEnabled",void 0),r([Za()],gT.prototype,"textureFadingEnabled",void 0),r([Za()],gT.prototype,"hasBackgroundColor",void 0),r([Za()],gT.prototype,"useGrid",void 0),r([Za()],gT.prototype,"renderOccluded",void 0),r([Za()],gT.prototype,"ssrEnabled",void 0),r([Za()],gT.prototype,"tileBorders",void 0),r([Za()],gT.prototype,"screenSizePerspective",void 0);const mT=Sn(),vT=sa();let yT=class extends T{constructor(t){super(t),this.type="Terrain",this.isGround=!0,this.tileSize=256,this.rctx=null,this._isTransparent=!1,this._scaleRangeQueries=new LP,this.renderDataPool=new xt(FP),this._patchGroups=new pt({allocator:t=>t||{root:null,origin:null,patches:new pt},deallocator:t=>(t.root=null,t.origin=null,t.patches.clear(),t)}),this.patchGroupsDirty=!0,this.patchGroupsMap=new Map,this.tileIterator=new KS,this.highestVisibleLODTile=null,this.visible=!0,this._opaque=!0,this._skirtScale=1,this._velvetOverground=!0,this.castShadows=!0,this._ssrEnabled=!1,this.emptyTex=null,this.tileRenderer=null,this.tileBackgroundInitialized=!1,this.tileBackgroundUpdating=!1,this.stencilEnabledLayerExtents=[],this.numTrianglesRendered=0,this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this.overlayOpacity=1,this.needsHighlight=!1,this.renderOccludedFlags=1}get isGlobal(){return 1===this.stage.viewingMode}initialize(){this.stage.addRenderPlugin([1,6,8],this)}destroy(){this.stage.removeRenderPlugin(this),VS.clear(),kS.clear()}get updating(){return!this.tileBackgroundInitialized||this.tileBackgroundUpdating}get canRender(){return this.visible&&!!this._rootTiles&&this.tileBackgroundInitialized&&!this.renderingDisabled}set renderingDisabled(t){this._set("renderingDisabled",!!t),this.setNeedsRender()}set opaque(t){this._opaque!==t&&(this._opaque=t,this.setNeedsRender())}get needsLinearDepth(){return this.overlayRenderer.hasWater}get opaque(){return this._opaque&&!this.shaderTechniqueConfig.slicePlaneEnabled}set isTransparent(t){this._isTransparent!==t&&(this._isTransparent=t,this.setNeedsRender())}get isTransparent(){return this._isTransparent}set skirtScale(t){t!==this._skirtScale&&(this._skirtScale=t,this.setNeedsRender())}get skirtScale(){return this._skirtScale}get renderPatchBorders(){return!!this.shaderTechniqueConfig.tileBorders}set renderPatchBorders(t){this.shaderTechniqueConfig.tileBorders!==t&&(this.shaderTechniqueConfig.tileBorders=t,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get cullBackFaces(){return this.shaderTechniqueConfig.backfaceCullingEnabled}set cullBackFaces(t){this.shaderTechniqueConfig.backfaceCullingEnabled!==t&&(this.shaderTechniqueConfig.backfaceCullingEnabled=t,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(t){this._set("renderOrder",t),this.setNeedsRender()}set velvetOverground(t){this._velvetOverground!==t&&(this._velvetOverground=t,this.setNeedsRender())}get intersectionHandlerId(){return ch}get slicePlane(){return this.shaderTechniqueConfig.slicePlaneEnabled}set slicePlane(t){this.shaderTechniqueConfig.slicePlaneEnabled!==t&&(this.shaderTechniqueConfig.slicePlaneEnabled=t,this.setNeedsRender())}set textureFadingEnabled(t){this.shaderTechniqueConfig.textureFadingEnabled!==t&&(this.shaderTechniqueConfig.textureFadingEnabled=t,this.setNeedsRender())}setDebugScreenSizePerspective(t){this.shaderTechniqueConfig.screenSizePerspective!==t&&(this.shaderTechniqueConfig.screenSizePerspective=t,this.setNeedsRender())}setRootTiles(t){this._rootTiles=t,this.setNeedsRender()}setNeedsHighlight(t){this.needsHighlight=t,this.setNeedsRender()}setRenderOccludedOverlay(t){this.renderOccludedFlags=t?_r:1,this.setNeedsRender()}setStencilEnabledLayerExtents(t){this.stencilEnabledLayerExtents=t,this.setNeedsRender()}setTileSize(t){this.tileSize=t,this.tileRenderer&&(this.tileRenderer.tileSize=t),this.setNeedsRender()}loadTile(t){t.renderData||(t.renderData=this.renderDataPool.acquire(),t.renderData.init(t),t.renderData.localOrigin=this._getLocalOriginOfTile(t)),this.updateTileGeometry(t),this.updateTileTexture(t,128)}queryVisibleLevelRange(t,e,i,s){this._scaleRangeQueries.queryVisibleLevelRange(t,e,i,s),this.setNeedsRender()}updateTileTexture(t,e){this.tileRenderer&&this.tileBackgroundInitialized&&(this.tileRenderer.updateTileTexture(t,128===e?0:2),this.setNeedsRender(),t.resetPendingUpdate(e))}updateTileGeometry(t){for(const e of t.layerInfo[0])e.pendingUpdates&=-33;t.resetPendingUpdate(32),t.renderData.updateGeometry(this.rctx,this.wireframe)&&this.setNeedsRender()}unloadTile(t){t.renderData&&(t.renderData.releaseGeometry()&&this.setNeedsRender(),this.renderDataPool.release(t.renderData),t.renderData.clear(),t.renderData=null,t.setMemoryDirty(),this.setNeedsRender())}_getLocalOriginOfTile(t){const e=Math.max(0,7*Math.floor((t.lij[0]-3)/7));if(this.isGlobal&&0===e)return Bs;for(;t.parent&&t.lij[0]>e;)t=t.parent;return t.centerAtSeaLevel}setVisibility(t){this.visible=t,this.setNeedsRender()}getStats(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numTrianglesRendered:this.numTrianglesRendered,numOriginsRendered:this.numOriginsRendered}}set wireframe(t){this._get("wireframe")!==t&&(this._set("wireframe",t),this.allTiles.forAll((e=>{var i;return null==(i=e.renderData)?void 0:i.updateGeometry(this.rctx,t)})),this.setNeedsRender())}setNeedsRender(t=1){this.patchGroupsDirty=!0,this.context.requestRender(t)}setTileBackground(t){this.tileBackground=t,this._updateTileBackground()}initializeRenderContext(t){this.context=t,this.rctx=t.renderContext.rctx,this.shaderTechniques=t.shaderTechniqueRep,this.shaderTechniqueConfig=new gT,this.tileRenderer=new XP(this.rctx,this.tileSize,this.shaderTechniques),this.tileBackground&&this._updateTileBackground(),this.emptyTex=fh(this.rctx)}uninitializeRenderContext(){null!=this.emptyTex&&(this.emptyTex.dispose(),this.emptyTex=null),this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null)}intersect(t,e,i,s){if(!this._rootTiles||t.options.selectOpaqueTerrainOnly&&t.options.selectionMode&&!this._opaque)return;const n=MT,r=ST;ts(n,s,i),ds(r,1/n[0],1/n[1],1/n[2]);const o=t.results.min,a=t.results.max,h=t.results.ground,l=0===t.options.store,c=!!t.results.ground.target;let u;const d=wh(t.verticalOffset),f=this._skirtScale,g=t.tolerance;let m=l&&null!=o.dist?o.dist:1/0;const v=c=>{const v=c.renderData;if(null==v)return;const y=v.geometryInfo;On(mT,y.boundingBox);const x=v.localOrigin;p(d)&&(d.localOrigin=x,d.applyToAabb(mT));const b=-f*y.skirtLength;if(0!==b){const t=c.up;Rn(mT,b*t[0],b*t[1],b*t[2])}const C=mT;if(PT[0]=i[0]-x[0],PT[1]=i[1]-x[1],PT[2]=i[2]-x[2],!dh(C,PT,r,g,m))return;const M=(t,e,i)=>{t.set(void 0,c.key,e,i,vn,void 0),t.intersector=AT,t.target={type:"external",metadata:{tile:c}},m=l&&null!=o.dist?o.dist:1/0},S=(r,l)=>{if(r>=0&&(t.options.backfacesTerrain||es(l,n)<0)&&(t.options.invisibleTerrain||!t.options.selectionMode||null==e||e(i,s,r))){if((null==h.dist||r<h.dist)&&M(h,r,l),t.options.isFiltered)return;2===t.options.store&&(w(u)?(u=new fc(t.ray),M(u,r,l),t.results.all.push(u)):r<u.dist&&M(u,r,l)),(null==o.dist||r<o.dist)&&M(o,r,l),0!==t.options.store&&(null==a.dist||r>a.dist)&&M(a,r,l)}},P=TT;ts(P,s,x);const T=y.indices,A=y.vertexAttributes,_={data:A.getField("position",kc).typedBuffer,size:3,stride:A.stride/4},D=y.numWithoutSkirtIndices/3;if(!p(d)&&D>40){const t=c.renderData;p(t.intersectionData)||(t.intersectionData=new sT(T,0,D,_)),t.intersectionData.intersectRay({r0:PT,r1:P},S)}else Ch(PT,P,0,D,T,_,null,d,S);if(0!==b){const t=T.length/3;if(this.isGlobal){const e=t-D;if(!p(d)&&e>40){const i=c.renderData;if(!p(i.skirtIntersectionData)){const s=function(t,e,i,s,n,r){const o=s.position,a=s.uv0,h=new Map,l=3*e,c=3*i-l,u=new Uint32Array(c);let d=0;for(let e=0;e<c;++e){const i=t[e+l];if(h.has(i))u[e]=h.get(i);else{const t=d++;h.set(i,t),u[e]=t}}const p=new Float64Array(3*d);return h.forEach(((t,e)=>{let i=o.get(e,0),s=o.get(e,1),h=o.get(e,2);if(a.get(e,0)>=2){const t=i+r[0],e=s+r[1],o=h+r[2],a=n/Math.sqrt(t*t+e*e+o*o);i+=t*a,s+=e*a,h+=o*a}p[3*t+0]=i,p[3*t+1]=s,p[3*t+2]=h})),{vertices:p,indices:u}}(T,D,t,A,b,x);i.skirtIntersectionData=new sT(s.indices,0,e,{data:s.vertices,stride:3})}i.skirtIntersectionData.intersectRay({r0:PT,r1:P},S)}else!function(t,e,i,s,n,r,o,a,h,l){const c=r.position,u=r.uv0,d=PT[0],f=PT[1],g=PT[2],m=e[0]-d,v=e[1]-f,y=e[2]-g;s*=3;for(let t=i*=3;t<s;t+=3){const e=n[t],i=n[t+1],s=n[t+2];let r=c.get(e,0),w=c.get(e,1),x=c.get(e,2),b=c.get(i,0),C=c.get(i,1),M=c.get(i,2),S=c.get(s,0),P=c.get(s,1),T=c.get(s,2);if(u.get(e,0)>=2){const t=r+a[0],e=w+a[1],i=x+a[2],s=o/Math.sqrt(t*t+e*e+i*i);r+=t*s,w+=e*s,x+=i*s}if(u.get(i,0)>=2){const t=b+a[0],e=C+a[1],i=M+a[2],s=o/Math.sqrt(t*t+e*e+i*i);b+=t*s,C+=e*s,M+=i*s}if(u.get(s,0)>=2){const t=S+a[0],e=P+a[1],i=T+a[2],s=o/Math.sqrt(t*t+e*e+i*i);S+=t*s,P+=e*s,T+=i*s}p(h)&&([r,w,x]=h.applyToVertex(r,w,x),[b,C,M]=h.applyToVertex(b,C,M),[S,P,T]=h.applyToVertex(S,P,T));const A=b-r,_=C-w,D=M-x,O=S-r,R=P-w,F=T-x,z=v*F-R*y,L=y*O-F*m,E=m*R-O*v,I=A*z+_*L+D*E;if(Math.abs(I)<=Number.EPSILON)continue;const V=d-r,j=f-w,N=g-x,k=V*z+j*L+N*E;if(I>0){if(k<0||k>I)continue}else if(k>0||k<I)continue;const B=j*D-_*N,G=N*A-D*V,q=V*_-A*j,W=m*B+v*G+y*q;if(I>0){if(W<0||k+W>I)continue}else if(W>0||k+W<I)continue;const U=(O*B+R*G+F*q)/I;U>=0&&l(U,uh(A,_,D,O,R,F,XS))}}(0,P,D,t,T,A,b,x,d,S)}else!function(t,e,i,s,n,r,o,a,h){const l=r.position,c=r.uv0,u=PT[0],d=PT[1],f=PT[2],g=e[0]-u,m=e[1]-d,v=e[2]-f;s*=3;for(let t=i*=3;t<s;t+=3){const e=n[t],i=n[t+1],s=n[t+2];let r=l.get(e,0),y=l.get(e,1),w=l.get(e,2),x=l.get(i,0),b=l.get(i,1),C=l.get(i,2),M=l.get(s,0),S=l.get(s,1),P=l.get(s,2);c.get(e,0)>=2&&(w+=o),c.get(i,0)>=2&&(C+=o),c.get(s,0)>=2&&(P+=o),p(a)&&([r,y,w]=a.applyToVertex(r,y,w),[x,b,C]=a.applyToVertex(x,b,C),[M,S,P]=a.applyToVertex(M,S,P));const T=x-r,A=b-y,_=C-w,D=M-r,O=S-y,R=P-w,F=m*R-O*v,z=v*D-R*g,L=g*O-D*m,E=T*F+A*z+_*L;if(Math.abs(E)<=Number.EPSILON)continue;const I=u-r,V=d-y,j=f-w,N=I*F+V*z+j*L;if(E>0){if(N<0||N>E)continue}else if(N>0||N<E)continue;const k=V*_-A*j,B=j*T-_*I,G=I*A-T*V,q=g*k+m*B+v*G;if(E>0){if(q<0||N+q>E)continue}else if(q>0||N+q<E)continue;const W=(D*k+O*B+R*G)/E;W>=0&&h(W,uh(T,A,_,D,O,R,XS))}}(0,P,D,t,T,A,b,d,S)}},y=this._rootTiles;p(y)&&(()=>{const e=this.tileIterator;e.reset(y);const s=t.options.invisibleTerrain;for(;!e.done;){const t=e.next();!(t.visible||s&&t.intersectsClippingArea)||!p(d)&&!t.intersectsRay(i,n,g,m,f)||c&&this._useStencilForTile(t)?e.skipSubtree():v(t)}})()}render(t){if(8===t.slot){if(0==(t.renderOccludedMask&_r))return!1}else if(t.slot!==(this.opaque?1:6))return!1;const e=t.pass,i=1===t.scenelightingData.globalFactor,s=this._updatePatchGroups();let n=!1;switch(e){case 0:{const e=t.shadowMap&&t.shadowMap.enabled;this.shaderTechniqueConfig.receiveShadows!==e&&(this.shaderTechniqueConfig.receiveShadows=e);const i=this.overlayRenderer.isEmpty()?0:this.overlayRenderer.hasWater?2:1;this.shaderTechniqueConfig.overlayMode!==i&&(this.shaderTechniqueConfig.overlayMode=i),this._renderMaterialPass(t,0,s,8===t.slot?3:1),n=!0;break}case 4:case 6:this.castShadows&&i&&(this._renderAuxiliaryPass(t,3,s,0),n=!0);break;case 2:this.isTransparent&&this.overlayRenderer.isEmpty()||(this._renderAuxiliaryPass(t,1,s,0),n=!0);break;case 3:this._renderAuxiliaryPass(t,2,s,0),n=!0;break;case 5:this.needsHighlight&&(this._renderAuxiliaryPass(t,4,s,2),t.rctx.clearSafe(256),n=!0)}return this._scaleRangeQueries.hasPendingQueries()&&this.setNeedsRender(),n}_renderMaterialPass(t,e,i,s){const{rctx:n,camera:r}=t;this._ssrEnabled=t.ssrParams.ssrEnabled,this._setTerrainTechnique(e,3===s);const o=this._shaderTechnique.program;n.useProgram(o),0!==this.shaderTechniqueConfig.overlayMode&&1===s&&t.ssrParams&&Dr(o,t.ssrParams),t.shadowMap.bind(o),t.ssaoHelper.bind(o,t.camera),this._bindOverlayData(o,s),o.setUniformMatrix4fv("viewNormal",r.viewInverseTransposeMatrix),rh(o,r.projectionMatrix),t.scenelightingData.setUniforms(o,!0);const a=r.viewMatrix;ds(CT,a[12],a[13],a[14]),is(CT,CT),o.setUniform3fv("viewDirection",CT),this.numTilesRendered=0,this.numTilesCulled=0,this.numTrianglesRendered=0,this.numOriginsRendered=0,this._scaleRangeQueries.prepareQueries(),this.opaque?this._renderPatchGroups(t,o,i,s):t.offscreenRenderingHelper.renderToTargets((()=>this._renderPatchGroups(t,o,i,s)),t.offscreenRenderingHelper.tmpColor,t.offscreenRenderingHelper.mainDepth,[0,0,0,0]),this._scaleRangeQueries.processQueries()}_renderAuxiliaryPass(t,e,i,s){this._setTerrainTechnique(e,3===s);const n=this._shaderTechnique.program;if(t.rctx.useProgram(n),5===t.pass){const e=t.offscreenRenderingHelper;n.bindTexture(e.depthTexture,"depthTex"),n.setUniform4f("highlightViewportPixelSz",0,0,1/e.width,1/e.height)}else n.setUniformMatrix4fv("viewNormal",t.camera.viewInverseTransposeMatrix),2!==t.pass&&4!==t.pass&&6!==t.pass||n.setUniform2fv("nearFar",t.camera.nearFar);this._renderPatchGroupsAuxiliary(t,n,i,s)}_updateTileBackground(){if(!this.tileRenderer)return;this.tileBackgroundUpdating=!0;const t=()=>{this.tileBackgroundInitialized=!0,this.tileBackgroundUpdating=!1,this.shaderTechniqueConfig.useGrid=this.tileRenderer.backgroundIsGrid,this.shaderTechniqueConfig.hasBackgroundColor=!this.tileRenderer.backgroundIsGrid&&!!p(this.tileRenderer.backgroundColor),this.allTiles.forAll((t=>this.tileRenderer.updateTileTexture(t,0))),this.setNeedsRender()};if("string"==typeof this.tileBackground){const e=this.tileBackground;Zh(e).then((i=>{e===this.tileBackground&&this.tileRenderer&&(this.tileRenderer.setBackground(i,this.tileBackground===Ti),t())}))}else{const e=this.tileBackground?Ni.toUnitRGBA(this.tileBackground):[0,0,0,0];this.tileRenderer.setBackground(e,!1),t()}}_updatePatchGroups(){const t=this._patchGroups;if(!this.patchGroupsDirty)return t;if(this.highestVisibleLODTile=null,this._renderCollectOrigins(t),0!==this.renderOrder){for(let e=0;e<t.length;e++)tP(this.renderOrder,t.data[e].patches);t.sort(((t,e)=>function(t,e,i){return 0===t.patches.length?-i:0===e.patches.length?i:eP(t.patches.data[0],e.patches.data[0],i)}(t,e,this.renderOrder)))}return this.patchGroupsDirty=!1,t}_renderCollectOrigins(t){const e=this._rootTiles;if(w(e))return;const i=this.isGlobal;t.clear();for(const s of e){const e=t.pushNew();e.root=s,e.origin=i?Bs:s.centerAtSeaLevel,e.patches.clear(),this._renderCollectOriginsForRoot(t,e)}t.filterInPlace((t=>t.patches.length>0))}_renderCollectOriginsForRoot(t,e){const i=this.tileIterator;i.resetOne(e.root);const s=this.patchGroupsMap;for(s.clear(),s.set(e.origin,e);!i.done;){const e=i.next(),n=e.renderData;if(!n||e.visible){if(e.lij[0]%7==0){const i=t.pushNew();i.root=e,i.origin=e.centerAtSeaLevel,s.set(e.centerAtSeaLevel,i),i.patches.clear()}if(e.rendered){if(n){const t=s.get(n.localOrigin);t&&t.patches.push(e),(!this.highestVisibleLODTile||e.vlevel>this.highestVisibleLODTile.vlevel)&&(this.highestVisibleLODTile=e),i.skipSubtree()}}else this.numTilesCulled++}else this.numTilesCulled++,i.skipSubtree()}}_useStencilForTile(t){for(const e of this.stencilEnabledLayerExtents)if(t.intersectsExtent(e))return!0;return!1}_renderPatchGroupsAuxiliary(t,e,i,s){const n=t.rctx;this._shaderTechnique.useStencil=!1,this._shaderTechnique.bindPipelineState(n,t.slot);const r=this.stencilEnabledLayerExtents.length>0;e.setUniformMatrix4fv("proj",t.camera.projectionMatrix),e.setUniform1f("skirtScale",this._skirtScale),0!==s&&this._bindOverlayData(e,s);for(let n=0;n<i.length;n++){const o=i.data[n];this._bindPatchGroupData(e,o,t.camera.eye,t.camera.viewMatrix);for(let i=0;i<o.patches.length;i++)this._renderPatch(t,e,o.patches.data[i],4,r,s)}t.rctx.bindVAO(null)}_renderPatchGroups(t,e,i,s){const n=t.rctx,r=t.camera,o=r.viewMatrix;if(this._shaderTechnique.useStencil=!1,this._shaderTechnique.bindPipelineState(n,t.slot),this.shaderTechniqueConfig.screenSizePerspective&&this.pointsOfInterest){const t=hh(this.stage.viewingMode,this.ellipsoidRadius);t.update({distance:this.pointsOfInterest.centerOnSurfaceFrequent.distance,fovY:r.fovY}),xh(t,e,"screenSizePerspective")}const a=this.stencilEnabledLayerExtents.length>0,h=3===s;h&&(e.bindTexture(this.emptyTex,"tex"),e.setUniform1f("blend",1),e.setUniform4fv("texOffsetAndScale",oa));const l=p(this.tileRenderer.backgroundColor)?this.tileRenderer.backgroundColor:Bs;this.shaderTechniqueConfig.hasBackgroundColor&&e.setUniform3fv("backgroundColor",l),e.setUniform1f("skirtScale",h?0:this._skirtScale);const c=this.wireframe?1:4;this.shaderTechniqueConfig.textureFadingEnabled&&e.bindTexture(this.emptyTex,"texNext");for(let n=0;n<i.length;n++){const l=i.data[n],u=l.patches;this._bindPatchGroupData(e,l,r.eye,o),bh(e,this._shaderTechnique.configuration,t.sliceHelper&&t.sliceHelper.plane,l.origin),t.shadowMap&&t.shadowMap.bindView(e,l.origin),this.numOriginsRendered++;for(let i=0;i<u.length;i++){const n=u.data[i],r=n.renderData.textureReference;if(w(r))continue;if(!h){this._scaleRangeQueries.scaleQueriesForTile(n),xT(n.renderData.geometryInfo.uvOffsetAndScale,r.offsetAndScale,vT),e.setUniform4fv("texOffsetAndScale",vT),e.bindTexture(r.texture.texture,"tex");const t=n.renderData.textureFadeFactor,i=t<1?n.renderData.nextTextureReference:null;this.shaderTechniqueConfig.textureFadingEnabled&&p(i)&&t<1?(xT(n.renderData.geometryInfo.uvOffsetAndScale,i.offsetAndScale,vT),e.setUniform1f("fadeFactor",t),e.setUniform4fv("nextTexOffsetAndScale",vT),e.setUniform3fv("nextTexOpacities",i.opacities),e.bindTexture(i.texture.texture,"texNext")):e.setUniform1f("fadeFactor",1),n.renderData.textureIsFading&&this.setNeedsRender(),e.setUniform3fv("textureOpacities",r.opacities)}const o=this._renderPatch(t,e,n,c,a,s);n.renderOrder=this.numTilesRendered,this.numTilesRendered++,this.numTrianglesRendered+=o/3}}n.bindVAO(null)}_renderPatch(t,e,i,s,n,r){if(w(i.renderData.vao.indexBuffer))return 0;0!==r&&this._bindOverlayPatchData(e,i.renderData.overlay),n&&(this._shaderTechnique.useStencil=this._useStencilForTile(i),this._shaderTechnique.bindPipelineState(t.rctx,t.slot));const o=0===this._skirtScale?i.renderData.geometryInfo.numWithoutSkirtIndices:i.renderData.vao.indexBuffer.size;return t.rctx.bindVAO(i.renderData.vao),e.assertCompatibleVertexAttributeLocations(i.renderData.vao),t.rctx.drawElements(s,o,i.renderData.vao.indexBuffer.indexType,0),o}_bindPatchGroupData(t,e,i,s){t.setUniform3fv("origin",e.origin),ho(bT,s,e.origin),t.setUniformMatrix4fv("view",bT),t.setUniform3f("camPos",i[0]-e.origin[0],i[1]-e.origin[1],i[2]-e.origin[2])}_bindOverlayData(t,e){if(0===this.shaderTechniqueConfig.overlayMode)return;t.setUniform1f("overlayOpacity",this.overlayOpacity);const i=this.overlayRenderer.overlays;if(i.length>0){const s=i[0],n=s.getColorTexture(e);if(t.bindTexture(p(n)?n:this.emptyTex,"ovColorTex"),2===this.shaderTechniqueConfig.overlayMode){const i=s.getNormalTexture(e);t.bindTexture(p(i)?i:this.emptyTex,"ovWaterTex")}}}_bindOverlayPatchData(t,e){t.setUniform4fv("overlayTexOffset",e.offsets),t.setUniform4fv("overlayTexScale",e.scales)}_setTerrainTechnique(t,e){this.shaderTechniqueConfig.output=t,0===t&&(this.shaderTechniqueConfig.atmosphere=this.isGlobal&&this._velvetOverground,this.shaderTechniqueConfig.ssrEnabled=this._ssrEnabled),this.shaderTechniqueConfig.renderOccluded=e,this.shaderTechniqueConfig.stencilEnabled=!1,this._shaderTechnique=this.shaderTechniques.releaseAndAcquire(fT,this.shaderTechniqueConfig,this._shaderTechnique)}get test(){return{tileRenderer:this.tileRenderer}}};r([o()],yT.prototype,"tileBackgroundInitialized",void 0),r([o()],yT.prototype,"tileBackgroundUpdating",void 0),r([o({constructOnly:!0})],yT.prototype,"overlayRenderer",void 0),r([o({constructOnly:!0})],yT.prototype,"stage",void 0),r([o({readOnly:!0})],yT.prototype,"isGlobal",null),r([o({constructOnly:!0})],yT.prototype,"allTiles",void 0),r([o({constructOnly:!0})],yT.prototype,"ellipsoidRadius",void 0),r([o({readOnly:!0})],yT.prototype,"updating",null),r([o({value:!1})],yT.prototype,"renderingDisabled",null),r([o()],yT.prototype,"renderPatchBorders",null),r([o()],yT.prototype,"cullBackFaces",null),r([o({value:1})],yT.prototype,"renderOrder",null),r([o()],yT.prototype,"wireframe",null),yT=r([a("esri.views.3d.terrain.TerrainRenderer")],yT);const wT=yT;function xT(t,e,i){ms(i,t[0]*e[2]+e[0],t[1]*e[3]+e[1],t[2]*e[2],t[3]*e[3])}const bT=gn(),CT=js(),MT=js(),ST=js(),PT=js(),TT=js(),AT="TerrainRenderer";class _T{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}}let DT=class extends T{constructor(t){super(t),this._handles=new E}initialize(){this._handles.add(this.layers.on("change",(()=>this._update()))),this._handles.add(this.extentHelper.watch("layerViewsExtent",(()=>this._setAdHocTilingScheme()))),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._handles=Y(this._handles),this._waitTask=null}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let t;if(this._set("tilingSchemeDone",!1),this.layers.some((e=>!(!hi(e)||e.isRejected()||e.isFulfilled()&&!function(t,e,i){return!!li(t,e,i).tileInfo}(e,this.viewSpatialReference,this.viewingMode)||(t=e,Ai(e)||ci(e))))),t)if(t.isResolved()){const e=t,{tileInfo:i}=li(e,this.viewSpatialReference,this.viewingMode),s=new _i(i);this._set("tilingSchemeDone",!0),this._lockTilingScheme(s)}else this._updateWhen(t);else this._set("tilingSchemeDone",!0)}_updateWhen(t){const e=t.when().catch((()=>{})).then((()=>{e!==this._waitTask||this.destroyed||this._update()}));this._waitTask=e}_lockTilingScheme(t){if(1===this.viewingMode){const e=t.levels.length-1;t.spatialReference.isWebMercator?t=_i.makeWebMercatorAuxiliarySphere(e):Ge(t.spatialReference)&&(t=_i.makeGCSWithTileSize(t.spatialReference,t.pixelSize,e))}this.tilingSchemeLocked=!0,this.tilingScheme=t,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._handles.removeAll(),this._handles.add(this.extentHelper.watch("tiledLayersExtent",(()=>this._updateTiledLayerExtent())))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(1===this.viewingMode){const t=this.extentHelper.viewSpatialReference,e=Ge(t)||$(t)||rt(t);t.isWebMercator?this.tilingScheme=_i.WebMercatorAuxiliarySphere:e&&(this.tilingScheme=_i.makeGCSWithTileSize(t,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const t=this.extentHelper.layerViewsExtent;p(t)&&!Qn(t,this.extent)&&(this.tilingScheme=_i.fromExtent(t,this.extentHelper.viewSpatialReference),this._set("extent",t))}}get test(){return{lockTilingScheme:t=>this._lockTilingScheme(t),done:!this._waitTask}}};r([o()],DT.prototype,"tilingScheme",void 0),r([o({readOnly:!0})],DT.prototype,"extent",void 0),r([o({value:!1})],DT.prototype,"tilingSchemeLocked",void 0),r([o({readOnly:!0,value:!1})],DT.prototype,"tilingSchemeDone",void 0),r([o({constructOnly:!0})],DT.prototype,"viewSpatialReference",void 0),r([o({constructOnly:!0})],DT.prototype,"layers",void 0),r([o({constructOnly:!0})],DT.prototype,"extentHelper",void 0),r([o({constructOnly:!0})],DT.prototype,"viewingMode",void 0),DT=r([a("esri.views.3d.terrain.TilingSchemeLogic")],DT);class OT{constructor(){this.offset=Sa(),this.scale=0,this.tile=null}init(t,e,i,s){this.tile=t,this.offset[0]=e,this.offset[1]=i,this.scale=s}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}}const RT=y.getLogger("esri.views.3d.terrain.TerrainSurface");let FT=class extends(G.EventedMixin(T)){constructor(t){super(t),this._elevationBounds=new vS,this._iteratorPool=new xt(KS,(t=>t.remove=()=>this._iteratorPool.release(t))),this._postorderIterator=new $S,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._visible=!1,this._usedMemory=IT,this._performanceInfo=new _T,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=js(),this._eyePosSurfaceSR=js(),this._splitLimits=new vP,this._snapLevel=1/0,this._frustum=pr(),this._viewProjectionMatrix=gn(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._handles=new E,this._watchUpdatingTracking=new Pl,this._frameTask=go,this._allTiles=new pt,this._upsampleInfoPool=new xt(OT),this._rootTilesExtent=Ln(),this._maxNumUpdating=1,this.maxTextureScale=1.2,this.backgroundImage=Ti,this.backgroundColor=null,this._layerViewsDirty=!1}initialize(){this._lercDecoder=Tc(this.view.resourceController),this._tilePool=new xt(this.view.state.isLocal?PP:AP);const t=this.view.resourceController.memoryController;this._upsampleMapCache=t.newCache("esri.views.3d.terrain.upsample",(t=>t.unloadMapData())),this._elevationQueryCache=new cS(t.newCache("elevation-query")),this._set("overlayManager",new _S({surface:this})),this._handles.add([this.watch("overlayManager.hasHighlights",(t=>this._renderer.setNeedsHighlight(t))),this.watch("overlayManager.rendersOccluded",(t=>this._renderer.setRenderOccludedOverlay(t)))],"overlayManager"),this._renderer=new wT({overlayRenderer:this.overlayManager.renderer,ellipsoidRadius:Qr(this.view.spatialReference).radius,stage:this.view._stage,allTiles:this._allTiles}),this._handles.add([tt(this,"baseOpacity",(t=>{this._handleLayerViewChanges(),this._updateBaseOpacity(t)}),!0),tt(this,"_background",(()=>{this._handleLayerViewChanges(),this._renderer.setTileBackground(this._background)}),!0),this.view.watch("pointsOfInterest",(t=>{this._renderer.pointsOfInterest=t,this._watchUpdatingTracking.removeAll(),t&&this._watchUpdatingTracking.add(t.focus,"renderLocation",(()=>()=>this._allTilesSorted=!1))})),tt(lr,"TERRAIN_TILE_TREE_SHOW_TILES",(t=>{t&&!this._treeDebugger?import("./p-a2f2a478.js").then((({TerrainTileTree3DDebugger:t})=>{!this._treeDebugger&&lr.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new t({view:this.view}))})):t||(this._treeDebugger=Y(this._treeDebugger))}))]),this._extentHelper=function(t,e){return 1===t?new xS(e):new bS(e)}(this.viewingMode,{layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,viewSpatialReference:this.view.spatialReference});const e=this.view.defaultsFromMap?new Sc({getCollections:()=>{var t,e,i;return null==(t=this.view)||null==(e=t.defaultsFromMap)||null==(i=e.mapCollectionPaths)?void 0:i.map((t=>this.view.map.get(t)))},getChildrenFunction:t=>t&&"layers"in t?t.layers:null}):this.view.map.allLayers,i=new DT({layers:e,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",i),this._updateTilingScheme(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(0),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(1),this._frameTask=this.view.resourceController.scheduler.registerTask(po.TERRAIN_SURFACE,this),this.view.resourceController.memoryController.events.on("quality-changed",(()=>this._viewChangeUpdate())),this._handles.add([tt(this._extentHelper,"stencilEnabledExtents",(t=>this._renderer.setStencilEnabledLayerExtents(t))),this.tilingSchemeLogic.watch("tilingScheme",(()=>this._updateTilingScheme()),!0),this.tilingSchemeLogic.watch("extent",(()=>this._updateClippingExtent()),!0),tt(this,"extent",(()=>this._updateRootTiles())),this.view.on("resize",(()=>this._viewChangeUpdate())),this.view.watch("state.camera",(()=>this._viewChangeUpdate()),!0),this.view.watch("state.contentCamera",(()=>this.view.state.fixedContentCamera&&this._viewChangeUpdate()),!0),this.view.watch("qualitySettings.tiledSurface.lodBias",(()=>this._viewChangeUpdate())),tt(this.view,"qualitySettings.tiledSurface.textureFadeDuration",(t=>this._renderer.textureFadingEnabled=t>0)),this.view.watch("lodSnapping",(()=>this._viewChangeUpdate())),this.view.watch("clippingArea",(()=>this._updateClippingExtent()))]),this._handles.add(this.view.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0))),this._layerViewsDirty=!0,this._handleLayerViewChanges()}destroy(){this._frameTask.remove(),this._handles.destroy(),this._watchUpdatingTracking.destroy(),this._lercDecoder=Z(this._lercDecoder),this._removeAllTiles(),this._upsampleMapCache=Y(this._upsampleMapCache),this._elevationQueryCache=Y(this._elevationQueryCache),this._set("tilingSchemeLogic",Y(this.tilingSchemeLogic)),this._extentHelper=Y(this._extentHelper),this._basemapLayerViewHandles.forEach(((t,e)=>this._unregisterTiledLayerView(e))),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",Y(this.overlayManager)),this._tilePool=Y(this._tilePool),yP.prune(),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this._renderer=Y(this._renderer),this._iteratorPool=Y(this._iteratorPool),this._set("view",null),this._upsampleInfoPool=Y(this._upsampleInfoPool),_c(),dP.size>0&&(console.log(`${dP.size} live TilePerLayerInfo allocations:`),dP.forEach((t=>console.log(t,"\n"))))}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){var t,e;const i=null==(t=this.view.pointsOfInterest)||null==(e=t.contentCameraOnSurface)?void 0:e.scale;if(i){const t=this.view.state.contentCamera;let e=_d(this.view,t.eye,t.viewForward,t.up).tilt;e>90&&(e=180-e);const s=2*(e/90)**2,n=Ed(this.view,i)-s;Math.abs(this._snapLevel-n)>.25&&(Math.round(n)!==Math.round(this._snapLevel)&&(this._viewChanged=!0),this._snapLevel=n)}return Math.round(this._snapLevel)}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?1:0}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get mapTileRequester(){return this._mapDataRequester}get extent(){const t=Xn(this.groundExtent,this._userClippingExtent,Ln()),e=this._get("extent");return Qn(t,e)?e:t}get groundExtent(){return f(this._tilingSchemeExtent,this._rootTilesExtent)}get _tilingSchemeExtent(){var t;return null==(t=this.tilingSchemeLogic)?void 0:t.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this._watchUpdatingTracking.updating||this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||this._asyncWorkItems>0||!this._allTilesSorted||this._renderer.updating||this._layerViewsDirty)&&this.ready&&!this.suspended||this.overlayManager.updating||this._frameTask.updating)}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get viewingMode(){return this.view.state.viewingMode}get ready(){return p(this.rootTiles)}set renderOrder(t){this._renderer.renderOrder=t,this._set("renderOrder",t)}set skirtScale(t){this._renderer.skirtScale=t}get skirtScale(){return this._renderer.skirtScale}get spatialReference(){var t,e;return null!=(t=null==(e=this.tilingScheme)?void 0:e.spatialReference)?t:null}get _background(){return null!=this.backgroundColor?this.backgroundColor:this.backgroundImage}set slicePlaneEnabled(t){var e,i;this._renderer.slicePlane=t,this._set("slicePlaneEnabled",t),null==(e=this.view)||null==(i=e._stage)||i.renderView.setRenderParameters({opaqueTerrain:this.opaque})}set velvetOverground(t){t!==this.velvetOverground&&(this._renderer.velvetOverground=t),this._set("velvetOverground",t)}set visible(t){t!==this._visible&&(this._visible=t,this._renderer.setVisibility(t),this.suspended=!t)}get opaque(){return this._renderer.opaque}set suspended(t){this._set("suspended",t),this._viewChangeUpdate()}intersect(t,e,i,s){this._renderer.intersect(t,e,i,s)}getElevation(t,e,i,s){const n=VT,r=this.getTileWithElevation(t,e,i,s,n);return w(r)?null:yS.sample(n[0],n[1],r.renderData.geometryState.samplerData)}getTileWithElevation(t,e,i,s,n=VT){var r;const o=this.rootTiles;if(w(o)||!o.length)return null;if(0===o[0].layerInfo[0].length)return null;if(n[0]=t,n[1]=e,n[2]=i,!Ie(n,s,n,null==(r=this.tilingScheme)?void 0:r.spatialReference))return RT.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(let t of o){if(!t.containsPoint(n))continue;for(;t&&!t.rendered&&!t.isLeaf;){let e=0;n[0]>.5*(t.extent[0]+t.extent[2])&&(e+=1),n[1]<.5*(t.extent[1]+t.extent[3])&&(e+=2),t=t.children[e]}const e=t.renderData;return e&&e.geometryState&&e.geometryState.samplerData?t:null}return null}get elevationBounds(){return this._elevationBounds}getScale(t){if(this.tilingScheme){if(!Ee(t,VT,this.spatialReference))return RT.error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const e=this.rootTiles;if(p(e))for(let t of e)if(t.containsPoint(VT)){for(;null!=t.children[0];){let e=0;VT[0]>t.children[0].extent[2]&&(e+=1),VT[1]<t.children[0].extent[1]&&(e+=2),t=t.children[e]}return this._getLodBiasCorrectedScale(t.level)}}return 1e100}getSphereScale(t,e){if(!this.tilingScheme)return null;if(!Ee(t,VT,this.spatialReference))return RT.error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;VT[3]=e;let i=null;const s=t=>{if(t&&$n(t.extent,VT))if(null!=t.children[0])for(const e of t.children)s(e);else{const e=this._getLodBiasCorrectedScale(t.level);i=null==i?e:Math.min(i,e)}},n=this.rootTiles;if(p(n))for(const t of n)s(t);return i}queryVisibleScaleRange(t,e,i,s){const n=e?this.tilingScheme.levelAtScale(e):0,r=i?this.tilingScheme.levelAtScale(i):1/0,o=this.lodBias;this._renderer.queryVisibleLevelRange(t,n+o,r+o,s)}_updateBaseOpacity(t){const e=this._renderer.opaque;this._renderer.opaque=t>=1,this._renderer.isTransparent=this._allTransparentSurfaceLayers();const i=e===this._renderer.opaque?2:1;var s,n;1===i&&(null==(s=this.view)||null==(n=s._stage)||n.renderView.setRenderParameters({opaqueTerrain:this.opaque})),this._updateTileTextures(i)}_updateTilingScheme(){const t=this.tilingSchemeLogic.tilingScheme;t!==this.tilingScheme&&(yi(!!t,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",t),this._updateClippingExtent(),t&&(this._updateTiledLayers(),this._renderer.setTileSize(t.pixelSize),this.overlayManager.setSpatialReference(t.spatialReference),this._updateRootTiles()))}_acquireTile(t,e,i,s){const n=this._tilePool.acquire();return NT[0]=t,NT[1]=e,NT[2]=i,n.init(NT,s,this),n}_updateRootTiles(){const{extent:t,tilingScheme:e}=this;if(!e)return;const i=jT;let s=e.rootTilesInExtent(t,i,5*Di);if(p(this.rootTiles)){if(s.length>Di)return void RT.warn(Oi);const t=this.rootTiles.map((t=>t.lij)),e=Et(t,s,LT);if(e.removed.length>0||e.added.length>0){const t=this.rootTiles.filter((t=>!(e.removed.findIndex((e=>LT(e,t.lij)))>-1&&(this._purgeTile(t),1))));e.added.forEach((e=>t.push(this._newRootTile(e)))),this._setRootTiles(t)}}else s.length>Di&&(RT.warn(Ri),s=e.rootTilesInExtent(t,i,Di)),this._setRootTiles(s.map((t=>this._newRootTile(t))));Qn(i,this._rootTilesExtent)||(this._rootTilesExtent=Ln(i)),this.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready")}_newRootTile(t){const e=this._acquireTile(0,t[1],t[2],null);return 2===e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&e.setPendingUpdate(2),this._loadTile(e),e}_setRootTiles(t){if(this._set("rootTiles",t),this._allTiles.clear(),p(t)){const e=this._iteratorPool.acquire();for(e.reset(t);!e.done;)this._allTiles.push(e.next());e.remove()}this._renderer.setRootTiles(this.rootTiles),this._updateTilesVisibility(t)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this._visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateSkirts(),this._updateTilesVisibility(this.rootTiles)))}_updateClippingStatus(t){t.updateClippingStatus(this.extent)&&t.resetPendingUpdate(32)&&this._updateTileGeometry(t)}_updateTilesVisibility(t){if(w(t))return;const e=function(t){for(let e=0;e<t.length;e++){const i=t[e],s=i.parent;if(s)for(let t=0;t<4;t++){const e=s.children[t];if(e&&e!==i&&e.loadable)return!0}}return!1}(t);let i=e?this._elevationBounds.min:1/0,s=e?this._elevationBounds.max:-1/0;const n=this.view.state.fixedContentCamera,r=this.extent,o=this._viewProjectionMatrix;this.setTileTreeDirty();const a=this._iteratorPool.acquire();for(a.reset(t);!a.done;){const t=a.next();t.updateClippingStatus(r)&&t.resetPendingUpdate(32)&&this._updateTileGeometry(t),t.setPendingUpdate(16);const e=t.updateVisibilityNow();n||e?(t.updateScreenDepth(o),t.renderData&&(i=Math.min(t.elevationBounds[0],i),s=Math.max(t.elevationBounds[1],s))):a.skipSubtree()}a.remove(),this._viewChanged=!0,this._allTilesDirty=!0,isFinite(i)&&isFinite(s)&&(this._elevationBounds.min===i&&this._elevationBounds.max===s||(this._elevationBounds.min=i,this._elevationBounds.max=s,this.emit("elevation-bounds-change",null)))}_updateViewDependentParameters(){const t=this.view.state.camera,e=this.view.state.contentCamera,i=Math.tan(.5*e.fovX),s=Math.tan(.5*e.fovY),n=this.tilingScheme.pixelSize,r=2**-this.lodBias*t.pixelRatio;this._splitLimits.aboveGround=t.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=s,this._splitLimits.relativeWidthLimit=n/t.width*this.maxTextureScale*r,this._splitLimits.relativeHeightLimit=n/t.height*this.maxTextureScale*r,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?(w(this._splitLimits.frustum)&&(this._splitLimits.frustum=pr()),Or(e.frustum,this._splitLimits.frustum)):this._splitLimits.frustum=null,Or(t.frustum,this._frustum),oo(this._viewProjectionMatrix,e.projectionMatrix,e.viewMatrix),$i(this._eyePosRenderSR,e.eye),Ie(t.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateSkirts(){this.skirtScale=Fi(this,this._eyePosSurfaceSR,this.view.state.constraints.collision.enabled?0:1.11*this.view.state.camera.near)}_updateRenderData(t){t.rendered&&!t.shouldLoad&&(ET(t)?this._loadChildren(t):function(t){return t.isLeaf&&t.parent&&t.parent.shouldLoad}(t)&&this._loadParent(t))}_updateTileGeometry(t){t.updateVisibility(),this._renderer.updateTileGeometry(t),this._elevationUpdate(t),this._usedMemory=IT}_updateTileTexture(t,e){const i=t.resetPendingUpdate(128)?128:!!t.resetPendingUpdate(64)&&64;i&&(this._renderer.updateTileTexture(t,i),this._usedMemory=IT,e.madeProgress())}_elevationUpdate(t){BT.spatialReference=this.spatialReference,BT.tile=t,BT.extent=t.extent,this.emit("elevation-change",BT),Fn(t.extent,this._eyePosSurfaceSR)&&this._updateSkirts()}get running(){return this.updating&&this.ready&&!this.suspended}runTask(t){this._handleLayerViewChanges(t),this._frameTask.processQueue(t),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateTileStatus(t),this._sortTiles(t);const e=!this.view.state.fixedContentCamera;this._mergeAndSplit(t,e),t.run((()=>this._updateElevation(t))),t.run((()=>this._updateTextures(t))),e||this._mergeAndSplit(t,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),t.done&&this.requestUpdate(),this.notifyChange("updatingProgressValue")}_updateTileStatus(t){if(!this._viewChanged||!this.rootTiles||t.done)return;this._viewChanged=!1;const e=this._iteratorPool.acquire();for(e.reset(this.rootTiles);!e.done;){const t=e.next();if(t.loadable){const i=t.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping);if(2===i){t.resetPendingUpdate(8),t.isLeaf&&(t.setPendingUpdate(2),e.skipSubtree());continue}t.resetPendingUpdate(2)&&t.updateAgentSuspension(),4===i&&t.updateAgents(0)}if(e.skipSubtree(),!t.isLeaf){t.setPendingUpdate(8),t.resetPendingUpdate(2);const e=this._iteratorPool.acquire();e.resetOne(t);for(let t=e.next();!e.done;t=e.next())this._updateClippingStatus(t),t.updateVisibility(),t.loadable&&t.updateScreenDepth(this._viewProjectionMatrix);e.remove()}}e.remove(),this.requestUpdate(),t.madeProgress()}_sortTiles(t){t.done||this._allTilesSorted||(function(t,e){const i=new Map;t.forAll((t=>i.set(t,t.distanceToSquared(e)))),t.sort(((t,e)=>i.get(t)-i.get(e)))}(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),t.madeProgress())}_mergeAndSplit(t,e){if(this.suspended||t.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=0;for(;!t.done;){let s=!1;i=0;const n=!this._allTiles.some((n=>{if(i+=n.usedMemory,n.resetPendingUpdate(8)){if(!e)return n.setPendingUpdate(8),t.done;this._mergeTile(n),s=!0,t.madeProgress()}else n.resetPendingUpdate(2)&&(this._splitTile(n),s=!0,t.madeProgress());return n.resetPendingUpdate(16)&&(this._updateRenderData(n),t.madeProgress()),t.done}));if(s&&(this._allTilesSorted=!1,this._allTilesDirty=!0),n){if(this._usedMemory=i,!s)break}else this._allTilesDirty=!0}0===i&&(this._allTilesDirty=!0),this._sortTiles(t)}_updateElevation(t){return this._allTiles.some((e=>(e.resetPendingUpdate(32)&&(this._updateTileGeometry(e),this._updateTileTexture(e,t),t.madeProgress()),t.done))),t.hasProgressed}_updateTextures(t){return this._allTiles.some((e=>(this._updateTileTexture(e,t),t.done))),t.hasProgressed}_updateClippingExtent(){if(!this.spatialReference)return;let t;p(this.view.clippingArea)&&(t=Ln(),Ll(this.view.clippingArea,t,this.spatialReference)||(t=null)),Qn(t,this._userClippingExtent)||(this._userClippingExtent=t,this.updateTileOverlayParams(1),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get lodBias(){return this.view.qualitySettings.tiledSurface.lodBias-(1-this.view.resourceController.memoryController.memoryFactor)*zi}_getLodBiasCorrectedScale(t){const e=this.tilingScheme.levels,i=fs(t-this.lodBias,0,e.length-1),s=i-Math.floor(i);return e[Math.floor(i)].scale*(1-s)+e[Math.ceil(i)].scale*s}_removeAllTiles(){p(this.rootTiles)&&(this.rootTiles.forEach((t=>this._purgeTile(t))),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.visible=!1}_purgeChildTiles(t){if(t.isLeaf)return!1;let e=this._purgeTile(t.children[0]);return e=this._purgeTile(t.children[1])||e,e=this._purgeTile(t.children[2])||e,e=this._purgeTile(t.children[3])||e,t.unsetChildren(),e}_purgeTile(t){const e=this._purgeChildTiles(t)||t.rendered;return this._allTiles.removeUnordered(t),t.unload(this._renderer),this._tilePool.release(t),e}_splitTile(t){yi(t.isLeaf,"tile that is already split should not be split again!");const e=t.level+1,i=2*t.lij[1],s=2*t.lij[2];t.setChildren(this._createTile(e,i,s,t),this._createTile(e,i,s+1,t),this._createTile(e,i+1,s,t),this._createTile(e,i+1,s+1,t)),t.setPendingUpdate(16),t.updateAgentSuspension(),this._allTiles.pushArray(t.children),this._allTilesDirty=!0,this._emitTileScaleChange(t,e),++this._performanceInfo.numSplit}_emitTileScaleChange(t,e=t.level){GT.spatialReference=this.spatialReference,GT.extent=t.extent,GT.scale=this._getLodBiasCorrectedScale(e),this.emit("scale-change",GT)}_createTile(t,e,i,s){yi(!!s,"_createTile sanity check");const n=this._acquireTile(t,e,i,s);return n.updateClippingStatus(this.extent),n.loadable&&(n.updateScreenDepth(this._viewProjectionMatrix),2===n.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&n.setPendingUpdate(2)),n}_mergeTile(t){yi(!t.hasPendingUpdate(2),"_mergeTile sanity check"),this._purgeChildTiles(t)&&(yi(!t.renderData,"_mergeTile sanity check"),this._loadTile(t)),this._allTilesDirty=!0,++this._performanceInfo.numMerged,this._emitTileScaleChange(t)}_loadChildren(t){yi(t.rendered,"parent should be rendered"),t.unload(this._renderer),this._loadTile(t.children[0]),this._loadTile(t.children[1]),this._loadTile(t.children[2]),this._loadTile(t.children[3])}_loadParent(t){const e=t.parent;this._unloadChildren(e),this._loadTile(e)}_unloadChildren(t){t.isLeaf||(this._unloadChildren(t.children[0]),t.children[0].unload(this._renderer),this._unloadChildren(t.children[1]),t.children[1].unload(this._renderer),this._unloadChildren(t.children[2]),t.children[2].unload(this._renderer),this._unloadChildren(t.children[3]),t.children[3].unload(this._renderer))}_loadTile(t){t.load(this._renderer),t.setPendingUpdate(16),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(t),this._elevationUpdate(t)}_elevationDataArrived(t,e,i){const s=new yS(t.lij,t.extent,i);t.dataArrived(e,0,s);const n=[t],r=t.level,o=this._iteratorPool.acquire();for(o.reset(n);!o.done;){const t=o.next();t.findElevationBoundsForLayer(e,r),t.computeElevationBounds()}o.remove(),this._updateTilesVisibility(n)}_handleLayerViewChanges(t=fo){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let e=!1;const i=new Set;let s=-1;for(const t of this.view.allLayerViews.items)if(i.add(t.uid),ni(t))if(this._basemapLayerViewHandles.has(t.uid)){const i=this.layerClassFromLayerView(t),n=this._layerIndexByUid[i].get(t.uid);n<s&&(e=!0),s=n}else this._registerTiledLayerView(t),t.layer.loaded&&(e=!0);this._basemapLayerViewHandles.forEach(((t,s)=>{i.has(s)||(this._unregisterTiledLayerView(s),e=!0)})),e&&this._updateTiledLayers(),this._renderer.isTransparent=this._allTransparentSurfaceLayers(),t.madeProgress()}_allTransparentSurfaceLayers(){let t=0===this.view.map.ground.opacity;for(const e of this.view.allLayerViews.items)if(ni(e)&&!Li(e)&&!xi(e.layer)&&0!==e.fullOpacity)return t=!1,t;return t}layerClassFromLayerView(t){return Li(t)?0:1}_registerTiledLayerView(t){const e=[],i=this.layerClassFromLayerView(t);e.push(t.watch("suspended",(()=>this._updateTiledLayers()))),e.push(t.watch("fullOpacity",(()=>this._updateTileTextures(2)))),e.push(t.layer.watch("scaleRangeId",(()=>this._restartAllAgents(i)))),t.on("data-changed",(()=>{const e=this._layerIndexByUid[i].get(t.uid);null!=e&&this._invalidateLayerData(e,i)})),this._basemapLayerViewHandles.set(t.uid,e)}_unregisterTiledLayerView(t){const e=this._basemapLayerViewHandles.get(t);if(e){for(let t=0;t<e.length;t++)e[t].remove();this._basemapLayerViewHandles.delete(t)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const t=this.view.allLayerViews,e=[[],[]];let i=null;const s=In();t.forEach((t=>{const n=t.layer;if(!n||t.suspended||!ni(t))return;const r=t.fullExtent;if(!r)return void RT.warn("Terrain: Map or elevation layer does not have fullExtent: "+n.id);if(!this.tilingScheme.compatibleWith(t.tileInfo))return void RT.warn("Terrain: tiling scheme of layer "+n.id+" is incompatible with other tiled layers, will not be drawn");jn(s,r,s);const o=this.layerClassFromLayerView(t);if(1===o){const e=t.displayLevelRange;e.maxLevel!==1/0&&(null===i||e.maxLevel>i)&&(i=e.maxLevel)}e[o].push(t)}));for(const t of vi){const i=this._layerViews[t],s=e[t];s.reverse();const n=s.length;let r=i.length!==n;const o=new Array(n),a=new Array(i.length);this._layerIndexByUid[t].clear();for(let e=0;e<n;e++){this._layerIndexByUid[t].set(s[e].uid,e);const n=i.indexOf(s[e]);o[e]=n,e!==n&&(r=!0),n>-1&&(a[n]=e)}if(r){const e=this._postorderIterator;for(e.reset(this.rootTiles);!e.done;)e.next().modifyLayers(a,o,t);this._layerViews[t]=s,this._restartAllAgents(t),this._updateTilesVisibility(this.rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()}_restartAllAgents(t){const e=this._postorderIterator;for(e.reset(this.rootTiles);!e.done;){const i=e.next();i.restartAgents(t),0===t&&i.computeElevationBounds()}}layerViewByIndex(t,e){return this._layerViews[e][t]}numLayers(t){return this._layerViews[t].length}_updateTileTextures(t){this._allTiles.forAll((e=>{e.updateAgents(1),1===t?this.renderer.updateTileTexture(e,64):e.updateRenderData(1,t)})),this._renderer.isTransparent=this._allTransparentSurfaceLayers()}_invalidateLayerData(t,e){this._allTiles.forAll((i=>i.removeLayerAgent(t,e))),this._allTiles.forAll((i=>i.invalidateLayerData(t,e)))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(t=1){this.renderer.setNeedsRender(t)}requestUpdate(){1==++this._pendingUpdates&&(this._hasPendingUpdates=!0)}requestTileData(t,e,i,s){const n=this.layerViewByIndex(e,i),r=n.layer;return!r.tilemapCache||bi(n)?this._requestTileData(t,i,n,s):(++this._asyncWorkItems,r.tilemapCache.fetchAvailability(t.lij[0],t.lij[1],t.lij[2],{...s,timeout:6e3}).then((()=>--this._asyncWorkItems)).catch((e=>{throw--this._asyncWorkItems,F(e)||this._dataMissing(t,i,n,{notInTilemap:!0}),e})).then((()=>this._frameTask.schedule((()=>this._requestTileData(t,i,n,s)),s.signal))))}_requestTileData(t,e,i,s){return 0===e?this._requestElevationTileData(t,i,s):this._requestMapTileData(t,i,s)}_requestElevationTileData(t,e,i){if(!Li(e))return void yi(!1,"_requestElevationTileData can only be called for elevation layer views");const s=s=>{if(--this._asyncWorkItems,vt(i))return;const n=this._layerIndexByUid[0].get(e.uid);null!=n?(this._usedMemory=IT,this.requestUpdate(),this._elevationDataArrived(t,n,s)):RT.warn("TerrainSurface: received data from unknown layer %d %s",0,t.lij.toString())},n=i=>{--this._asyncWorkItems,F(i)||(this._dataMissing(t,0,e,i),this.requestUpdate())};if(++this._asyncWorkItems,Ei(e.layer))return e.layer.fetchTile(t.lij[0],t.lij[1],t.lij[2],{noDataValue:ei,signal:i.signal}).then((t=>{if(vt(i))return RT.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void n(ut());this._frameTask.schedule((()=>s(t)),i.signal,n)}),n);const r=e.getTileUrl(t.lij[0],t.lij[1],t.lij[2]);return this._elevationDataRequester.request(r,"binary",i).then((t=>this._lercDecoder.decode(t,{noDataValue:ei},i.signal))).then((t=>{s({values:t.pixelData,width:t.width,height:t.height,noDataValue:t.noDataValue,minValue:t.minValue,maxValue:t.maxValue})}),n)}_requestMapTileData(t,e,i){if(e instanceof gS)return Promise.reject();++this._asyncWorkItems;const s=(s,n)=>{--this._asyncWorkItems,mi(n),vt(i)||(this._dataMissing(t,1,e,s),this.requestUpdate())},n=t=>e=>s(e,t),r=s=>this._frameTask.schedule((()=>{--this._asyncWorkItems,this.requestUpdate(),vt(i)?mi(s):this._mapTileDataArrived(t,e,s)}),i.signal,n(s)).catch(n(s)),o=(t,e=null)=>this._frameTask.schedule((()=>s(t,e)));if(bi(e)){const s=e.schemaHelper.getLevelRowColumn(t.lij);return e.fetchTile(s[0],s[1],s[2],i).then(r,o)}if(Ii(e))return e.fetchTile(t.lij[0],t.lij[1],t.lij[2],i).then(r,o);if(Vi(e)&&Ei(e.layer))return e.layer.fetchTile(t.lij[0],t.lij[1],t.lij[2],i).then((t=>{if(vt(i))return RT.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void o(ut());r(t)}),o);let a=e.getTileUrl(t.lij[0],t.lij[1],t.lij[2]);return Pc(e.layer)&&e.layer.refreshTimestamp&&(a+=`${a.includes("?")?"&":"?"}_ts=${e.layer.refreshTimestamp}`),this._mapDataRequester.request(a,e.hasMixedImageFormats?"image+type":"image",i).then(r,o)}_mapTileDataArrived(t,e,i){const s=this._layerIndexByUid[1].get(e.uid);null!=s?t.dataArrived(s,1,i):(mi(i),RT.warn("TerrainSurface: received data from unknown layer"))}_dataMissing(t,e,i,s){const n=this._layerIndexByUid[e].get(i.uid);null!=n?t.dataMissing(n,e,s):RT.warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(t){this.rootTiles&&this.overlayManager&&(this._allTiles.forAll((t=>{t.renderData&&this.overlayManager.setTileParameters(t)})),this._renderer.setNeedsRender(t))}get performanceInfo(){const t=this._performanceInfo;return t.numNodes=this._allTiles.length,t.numLeaves=t.numVisible=t.numRendered=t.numLoadedPerLevel.length=t.numRenderedPerLevel.length=0,this._allTiles.forAll((e=>{e.isLeaf&&t.numLeaves++;const i=e.level;e.renderData&&(t.numLoadedPerLevel[i]=(t.numLoadedPerLevel[i]||0)+1),e.visible&&(t.numVisible++,e.rendered&&(t.numRenderedPerLevel[i]=(t.numRenderedPerLevel[i]||0)+1,t.numRendered++))})),t}getUsedMemory(){return this.tilingScheme?(this._usedMemory===IT&&(this._usedMemory=0,this._allTiles.forAll((t=>this._usedMemory+=t.usedMemory))),this._usedMemory):0}getUsedMemoryForLayerView(t){let e=0;const i=this.layerClassFromLayerView(t),s=this._layerIndexByUid[i].get(t.uid);return this._allTiles.forAll((t=>e+=t.getUsedMemoryForLayer(i,s))),e}getTile(t){if(w(t)||w(this.rootTiles))return null;const e=t.split("/").map((t=>+t));if(0===e[0])return this.rootTiles.find((t=>t.lij[1]===e[1]&&t.lij[2]===e[2]));const i=2**e[0],s=Math.floor(e[1]/i),n=Math.floor(e[2]/i);let r;if(this.rootTiles.some((t=>t.lij[1]===s&&t.lij[2]===n&&(r=t,!0))),r){let t=1<<e[0]-1;for(;r.lij[0]<e[0];){let i=e[1]&t?2:0;if((e[2]&t)>0&&i++,!r.children[i])return null;r=r.children[i],t>>=1}return yi(r.lij[0]===e[0]&&r.lij[1]===e[1]&&r.lij[2]===e[2],"not the right tile?"),r}return null}get test(){const t=this;return{renderer:t._renderer,lercDecoder:t._lercDecoder,forceReload:()=>{p(t.rootTiles)&&(t._mergeTile(t.rootTiles[0]),t._viewChangeUpdate())},getTiles:()=>t._allTiles.toArray(),getRenderedTiles:()=>(kT.clear(),t._allTiles.forAll((t=>{t.visible&&t.rendered&&kT.push(t)})),tP(t.renderOrder,kT),kT.toArray()),lockTilingScheme(e,i){t._extentHelper.defaultTiledLayersExtent=i,t.tilingSchemeLogic.test.lockTilingScheme(e)}}}};r([o()],FT.prototype,"_renderer",void 0),r([o()],FT.prototype,"_hasPendingUpdates",void 0),r([o()],FT.prototype,"_asyncWorkItems",void 0),r([o()],FT.prototype,"_allTilesDirty",void 0),r([o()],FT.prototype,"_allTilesSorted",void 0),r([o()],FT.prototype,"_viewChanged",void 0),r([o({readOnly:!0})],FT.prototype,"_watchUpdatingTracking",void 0),r([o()],FT.prototype,"_frameTask",void 0),r([o({readOnly:!0})],FT.prototype,"snapLevel",null),r([o({readOnly:!0})],FT.prototype,"lodSnapping",null),r([o({constructOnly:!0})],FT.prototype,"view",void 0),r([o()],FT.prototype,"_userClippingExtent",void 0),r([o()],FT.prototype,"_rootTilesExtent",void 0),r([o({readOnly:!0})],FT.prototype,"extent",null),r([o({readOnly:!0})],FT.prototype,"groundExtent",null),r([o({readOnly:!0})],FT.prototype,"_tilingSchemeExtent",null),r([o({readOnly:!0})],FT.prototype,"updating",null),r([o(dS)],FT.prototype,"updatingProgress",void 0),r([o({readOnly:!0})],FT.prototype,"updatingProgressValue",null),r([o()],FT.prototype,"_maxNumUpdating",void 0),r([o({aliasOf:"view.map.ground.opacity"})],FT.prototype,"baseOpacity",void 0),r([o({readOnly:!0})],FT.prototype,"overlayManager",void 0),r([o({readOnly:!0})],FT.prototype,"viewingMode",null),r([o()],FT.prototype,"maxTextureScale",void 0),r([o({readOnly:!0})],FT.prototype,"ready",null),r([o({value:1})],FT.prototype,"renderOrder",null),r([o({readOnly:!0})],FT.prototype,"rootTiles",void 0),r([o({readOnly:!0})],FT.prototype,"spatialReference",null),r([o()],FT.prototype,"backgroundImage",void 0),r([o({type:Ni,aliasOf:"view.map.ground.surfaceColor"})],FT.prototype,"backgroundColor",void 0),r([o()],FT.prototype,"_background",null),r([o({value:!1})],FT.prototype,"slicePlaneEnabled",null),r([o({readOnly:!0})],FT.prototype,"tilingScheme",void 0),r([o({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],FT.prototype,"tilingSchemeLocked",void 0),r([o({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],FT.prototype,"tilingSchemeDone",void 0),r([o({readOnly:!0})],FT.prototype,"tilingSchemeLogic",void 0),r([o({value:!0})],FT.prototype,"velvetOverground",null),r([It("_renderer.wireframe")],FT.prototype,"wireframe",void 0),r([o({value:!1})],FT.prototype,"suspended",null),r([o({readOnly:!0,aliasOf:"view.qualitySettings.tiledSurface.textureFadeDuration"})],FT.prototype,"textureFadeDuration",void 0),r([o()],FT.prototype,"_layerViewsDirty",void 0),r([It("_renderer.renderPatchBorders")],FT.prototype,"renderPatchBorders",void 0),r([It("_renderer.renderingDisabled")],FT.prototype,"renderingDisabled",void 0),FT=r([a("esri.views.3d.terrain.TerrainSurface")],FT);const zT=FT;function LT(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function ET(t){return!t.isLeaf&&(t.children[0].shouldLoad||t.children[1].shouldLoad||t.children[2].shouldLoad||t.children[3].shouldLoad||ET(t.children[0])||ET(t.children[1])||ET(t.children[2])||ET(t.children[3]))}const IT=-1,VT=sa(),jT=Ln(),NT=[0,0,0],kT=new pt,BT={spatialReference:null,tile:null,extent:null,context:"ground"},GT={spatialReference:null,extent:null,scale:0};let qT=class extends T{constructor(t){super(t),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commit(t){this.dirty=!1,this._dirtyGeomRecords.forEach(((e,i)=>this.commitLayer(i,t)))}commitLayer(t,e){const i=this._dirtyGeomRecords.get(t);i&&(i.forEach(((i,s)=>{const n=this._ensureGeomRecord(t,s);i.forEach(((t,i)=>{const r=t[0],o=t[1],a=t[2];let h=!1;if(2&o){const t=n.get(i);if(t){const i=t[1];if(4&a){const t=this.model.getObject(s);this.model.updateRenderGeometryTransformation(t,r,i)&&(h=!0)}h||e.updates.push({renderGeometry:i,updateType:a})}else xl(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(4&o||h){const t=n.get(i);t?(e.removes.push(t[1]),n.delete(i),t[0].disposed&&gc.pool.release(t[0])):4===o&&xl(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(1&o||h){const t=this.model.getObject(s);if(p(t)){const s=this.model.getRenderGeometry(t,r),o=[r,s];e.adds.push(s),n.set(i,o)}}})),0===n.size&&this._residentGeomRecords.get(t).delete(s)})),0===this._residentGeomRecords.get(t).size&&this._residentGeomRecords.delete(t),this._dirtyGeomRecords.delete(t))}getResidentRenderGeometries(t,e){const i=this._residentGeomRecords.get(t);i&&i.forEach((t=>t.forEach((t=>e.push(t[1])))))}_objectStateChanged(t,e){for(const i of e.geometryRecords)this._updateOrCreateDirtyRecord(e,i,null,2,0,0,2,5,t)}visibilityChanged(t){this._objectStateChanged(1,t)}highlightChanged(t){this._objectStateChanged(8,t)}occlusionChanged(t){this._objectStateChanged(16,t)}vertexAttrsUpdated(t){this._updateOrCreateDirtyRecord(t.object,t.record,null,2,0,0,2,5,2)}layerAdded(t){t.objects.forAll((e=>this._layerObjectAdded(t,e)))}layerRemoved(t){t.objects.forAll((e=>this._layerObjectRemoved(t,e)))}layerObjectAdded(t){this._layerObjectAdded(t.layer,t.object)}_layerObjectAdded(t,e){const i=t.id;for(const t of e.geometryRecords)this._objectGeometryAdded(e,t,i)}layerObjectRemoved(t){this._layerObjectRemoved(t.layer,t.object)}layerObjectsAdded(t){for(const e of t.objects)this._layerObjectAdded(t.layer,e)}layerObjectsRemoved(t){for(const e of t.objects)this._layerObjectRemoved(t.layer,e)}_layerObjectRemoved(t,e){const i=t.id;for(const t of e.geometryRecords)this._objectGeometryRemoved(e,t,i)}shaderTransformationChanged(t){const e=this._residentGeomRecords.get(t.id);e&&e.forEach(((t,e)=>{const i=this.model.getObject(e);i&&i.hasVolativeTransformation()&&t.forEach((t=>{t[1].shaderTransformationChanged()}))}))}objectTransformation(t){const e=this._getParentLayerId(t);this._ensureGeomRecord(e,t.id).forEach((i=>{this._updateOrCreateDirtyRecord(t,i[0],e,2,0,0,2,5,4)}))}objectGeometryAdded(t){this._objectGeometryAdded(t.object,t.record)}_objectGeometryAdded(t,e,i=null){this._updateOrCreateDirtyRecord(t,e,i,1,4,0,0,0)}objectGeometryRemoved(t){this._objectGeometryRemoved(t.object,t.record)}_objectGeometryRemoved(t,e,i=null){this._updateOrCreateDirtyRecord(t,e,i,4,1,2,0,0)}_updateOrCreateDirtyRecord(t,e,i,s,n,r,o,a,h){i=f(i,this._getParentLayerId(t));const l=e.id,c=this._ensureDirtyRecord(i,t.id),u=c.get(l);if(u){const t=u[1];t&n?(c.delete(l),u[0].disposed&&gc.pool.release(u[0])):t&r?(u[1]=s,u[2]=h):t&o?u[2]|=h:t&a||xl(!1,"ModelDirtySet.objectGeometryAdded: inconsistent state")}else c.set(l,[e,s,h]);this.dirty=this._hasDirtyGeometryRecords}_ensureGeomRecord(t,e){let i=this._residentGeomRecords.get(t);i||(i=new Map,this._residentGeomRecords.set(t,i));let s=i.get(e);return s||(s=new Map,i.set(e,s)),s}get _hasDirtyGeometryRecords(){return ft(this._dirtyGeomRecords,(t=>ft(t,(t=>t&&t.size>0))))}_ensureDirtyRecord(t,e){let i=this._dirtyGeomRecords.get(t);i||(i=new Map,this._dirtyGeomRecords.set(t,i));let s=i.get(e);return s||(s=new Map,i.set(e,s)),s}_getParentLayerId(t){return p(t.parentLayer)?t.parentLayer.id:Vt}formatDebugInfo(){const t=["ADD","UPD",void 0,"REM"];let e="";return this._dirtyGeomRecords.forEach(((i,s)=>{i.forEach(((i,n)=>{e.length>0&&(e+="\n"),e+=s+"."+n;const r=[];i.forEach((t=>{const e=t[1];r[e]||(r[e]=[]),r[e].push(t[0].geometry.id)}));for(let i=0;i<r.length;i++)if(r[i]){e+=" "+t[i-1]+": ";for(let t=0;t<r[i].length;t++)e+=r[i][t]+", "}}))})),e}get test(){const t=this;return{get residentLayerCount(){return t._residentGeomRecords.size},get residentObjectCount(){return Array.from(t._residentGeomRecords.values()).reduce(((t,e)=>t+e.size),0)}}}};r([o({constructOnly:!0})],qT.prototype,"model",void 0),r([o()],qT.prototype,"dirty",void 0),qT=r([a("esri.views.3d.webgl-engine.lib.ModelDirtySet")],qT);const WT=qT;let UT=class extends T{constructor(){super(...arguments),this.dirtySet=new WT({model:this}),this._content=new Map,this._originFactory=new Rr(null,75e4)}getObject(t){return this._content.get(t)}add(t){const e=t.id;xl(!this._content.has(e),"Model/Stage already contains object to be added"),this._content.set(e,t),Fr(t)&&this.dirtySet.layerAdded(t)}remove(t){xl(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id),t.unload(),Fr(t)&&this.dirtySet.layerRemoved(t)}addMany(t){for(const e of t)p(e)&&(xl(!this._content.has(e.id),"Model/Stage already contains object to be added"),this._content.set(e.id,e))}removeMany(t){for(const e of t)xl(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id),e.unload()}forEachOfType(t,e){this._content.forEach((i=>{i.type===t&&e(i)}))}getRenderGeometry(t,e){const{geometry:i,material:s,id:n,shaderTransformation:r,origin:o,instanceParameters:a}=e,h=new zr(i,s,null,null,n,i.boundingInfo,r,t.castShadow);return h.updateTransformation((i=>t.getCombinedStaticTransformation(e,i))),h.origin=o||this._originFactory.getOrigin(h.boundingSphere),h.instanceParameters=a,h}updateRenderGeometryTransformation(t,e,i){if(w(t))return!1;i.updateTransformation((i=>t.getCombinedStaticTransformation(e,i)));const s=this._originFactory.getOrigin(i.boundingSphere);return i.origin!==s}getStats(){const t={},e=Array.from(this._content.values());for(let i=0;i<5;++i)t[i]=e.filter((t=>t.type===i)).length;return{contentTypes:t,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){return{content:Array.from(this._content.values())}}};r([o({constructOnly:!0})],UT.prototype,"dirtySet",void 0),UT=r([a("esri.views.3d.webgl-engine.parts.Model")],UT);const HT=1e-6,ZT=[0,0,0],QT=[0,0,0];const YT=[0,0,0],XT=[0,0,0],KT=[0,0,0],$T=[0,0,0],JT=[0,0,0],tA=[0,0,0],eA=[0,0,0],iA=[0,0,0],sA=[0,0,0],nA=[0,0],rA=[0,0,0],oA=[0,0,0],aA=[0,0,0],hA=[0,0,0],lA=[0,0,0],cA=[0,0,0];function uA(t,e,i,s,n,r){if(EA(e)<HT)return;zA(rA,i,e),zA(oA,s,e),zA(aA,n,e),pA(t,e,nA),lA[1]=nA[0],hA[1]=nA[1],cA[1]=hA[1]-lA[1];const o=[i,s,n],a=[rA,oA,aA];for(let i=0;i<3;++i){pA(t,o[i],nA),lA[0]=nA[0],hA[0]=nA[1],pA(t,a[i],nA),lA[2]=nA[0],hA[2]=nA[1],cA[0]=hA[0]-lA[0],cA[2]=hA[2]-lA[2];const s=_A(cA);s<r.quality&&(FA(r.b0,o[i]),FA(r.b1,e),FA(r.b2,a[i]),r.quality=s)}}const dA=[0,0,0];function pA(t,e,i){const{data:s,size:n}=t;i[0]=Number.POSITIVE_INFINITY,i[1]=Number.NEGATIVE_INFINITY;for(let t=0;t<s.length;t+=n){const n=s[t]*e[0]+s[t+1]*e[1]+s[t+2]*e[2];i[0]=Math.min(i[0],n),i[1]=Math.max(i[1],n)}}function fA(t,e,i){FA(i.center,t),RA(i.halfSize,e,.5),i.quaternion[0]=0,i.quaternion[1]=0,i.quaternion[2]=0,i.quaternion[3]=1}const gA=[0,0,0],mA=[0,0,0],vA=[0,0,0],yA=[0,0,0],wA=[0,0,0],xA=[0,0,0];function bA(t,e,i,s,n,r){pA(t,e,nA),n[0]=nA[0],r[0]=nA[1],pA(t,i,nA),n[1]=nA[0],r[1]=nA[1],pA(t,s,nA),n[2]=nA[0],r[2]=nA[1]}const CA=[0,0,0],MA=[1,0,0,0,1,0,0,0,1],SA=[0,0,0];function PA(t,e,i,s,n,r,o){MA[0]=t[0],MA[1]=t[1],MA[2]=t[2],MA[3]=e[0],MA[4]=e[1],MA[5]=e[2],MA[6]=i[0],MA[7]=i[1],MA[8]=i[2],function(t,e){const i=e[0]+e[4]+e[8];if(i>0){let s=Math.sqrt(i+1);t[3]=.5*s,s=.5/s,t[0]=(e[5]-e[7])*s,t[1]=(e[6]-e[2])*s,t[2]=(e[1]-e[3])*s}else{let i=0;e[4]>e[0]&&(i=1),e[8]>e[3*i+i]&&(i=2);const s=(i+1)%3,n=(i+2)%3;let r=Math.sqrt(e[3*i+i]-e[3*s+s]-e[3*n+n]+1);t[i]=.5*r,r=.5/r,t[3]=(e[3*s+n]-e[3*n+s])*r,t[s]=(e[3*s+i]+e[3*i+s])*r,t[n]=(e[3*n+i]+e[3*i+n])*r}}(o.quaternion,MA),DA(SA,s,n),RA(SA,SA,.5),RA(o.center,t,SA[0]),RA(CA,e,SA[1]),DA(o.center,o.center,CA),RA(CA,i,SA[2]),DA(o.center,o.center,CA),RA(o.halfSize,r,.5)}class TA{constructor(t){this.minVert=new Array(7),this.maxVert=new Array(7),this.buffer=new ArrayBuffer(448);let e=0;this.minProj=new Float64Array(this.buffer,e,7),e+=56,this.maxProj=new Float64Array(this.buffer,e,7),e+=56;for(let t=0;t<7;++t)this.minVert[t]=new Float64Array(this.buffer,e,3),e+=24;for(let t=0;t<7;++t)this.maxVert[t]=new Float64Array(this.buffer,e,3),e+=24;for(let t=0;t<7;++t)this.minProj[t]=Number.POSITIVE_INFINITY,this.maxProj[t]=Number.NEGATIVE_INFINITY;const i=new Array(7),s=new Array(7),{data:n,size:r}=t;for(let t=0;t<n.length;t+=r){let e=n[t];e<this.minProj[0]&&(this.minProj[0]=e,i[0]=t),e>this.maxProj[0]&&(this.maxProj[0]=e,s[0]=t),e=n[t+1],e<this.minProj[1]&&(this.minProj[1]=e,i[1]=t),e>this.maxProj[1]&&(this.maxProj[1]=e,s[1]=t),e=n[t+2],e<this.minProj[2]&&(this.minProj[2]=e,i[2]=t),e>this.maxProj[2]&&(this.maxProj[2]=e,s[2]=t),e=n[t]+n[t+1]+n[t+2],e<this.minProj[3]&&(this.minProj[3]=e,i[3]=t),e>this.maxProj[3]&&(this.maxProj[3]=e,s[3]=t),e=n[t]+n[t+1]-n[t+2],e<this.minProj[4]&&(this.minProj[4]=e,i[4]=t),e>this.maxProj[4]&&(this.maxProj[4]=e,s[4]=t),e=n[t]-n[t+1]+n[t+2],e<this.minProj[5]&&(this.minProj[5]=e,i[5]=t),e>this.maxProj[5]&&(this.maxProj[5]=e,s[5]=t),e=n[t]-n[t+1]-n[t+2],e<this.minProj[6]&&(this.minProj[6]=e,i[6]=t),e>this.maxProj[6]&&(this.maxProj[6]=e,s[6]=t)}for(let t=0;t<7;++t){let e=i[t];FA(this.minVert[t],n,e),e=s[t],FA(this.maxVert[t],n,e)}}}class AA{constructor(){this.b0=[1,0,0],this.b1=[0,1,0],this.b2=[0,0,1],this.quality=0}}function _A(t){return t[0]*t[1]+t[0]*t[2]+t[1]*t[2]}function DA(t,e,i){t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2]}function OA(t,e,i){t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2]}function RA(t,e,i){t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i}function FA(t,e,i=0){t[0]=e[i+0],t[1]=e[i+1],t[2]=e[i+2]}function zA(t,e,i){const s=e[0],n=e[1],r=e[2],o=i[0],a=i[1],h=i[2];t[0]=n*h-r*a,t[1]=r*o-s*h,t[2]=s*a-n*o}function LA(t,e){const i=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];if(i>0){const s=1/Math.sqrt(i);t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s}}function EA(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]}function IA(t,e){const i=e[0]-t[0],s=e[1]-t[1],n=e[2]-t[2];return i*i+s*s+n*n}function VA(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}const jA=fn(),NA=js(),kA=js(),BA=pn();class GA{constructor(t){this.buffer=new ArrayBuffer(56*t),this.obbs=new Array(t);for(let e=0;e<t;e++)this.obbs[e]={center:Ws(this.buffer,56*e+0),halfSize:hl(this.buffer,56*e+24),quaternion:qc(this.buffer,56*e+36)}}}function qA(t=[0,0,0],e=[-1,-1,-1],i=[0,0,0,1]){return{center:ks(t),halfSize:al(e),quaternion:Gc(i)}}function WA(t){return qA(t.center,t.halfSize,t.quaternion)}function UA(t,e){$i(e.center,t.center),$i(e.halfSize,t.halfSize),el(e.quaternion,t.quaternion)}function HA(t,e){return function(t,e){const{data:i,size:s}=t,n=i.length/s;if(n<=0)return;const r=new TA(t);DA(ZT,r.minProj,r.maxProj),RA(ZT,ZT,.5),OA(QT,r.maxProj,r.minProj);const o=_A(QT),a=new AA;a.quality=o,n<14&&(t={data:new Float64Array(r.buffer,112,42),size:3});const h=[0,0,0],l=[0,0,0],c=[0,0,0],u=[0,0,0],d=[0,0,0],p=[0,0,0],f=[0,0,0];switch(function(t,e,i,s,n,r,o,a,h,l){return function(t,e,i){let s=IA(t.maxVert[0],t.minVert[0]),n=0;for(let e=1;e<7;++e){const i=IA(t.maxVert[e],t.minVert[e]);i>s&&(s=i,n=e)}FA(e,t.minVert[n]),FA(i,t.maxVert[n])}(t,s,n),IA(s,n)<HT?1:(OA(o,s,n),LA(o,o),function(t,e,i,s){const{data:n,size:r}=t;let o=Number.NEGATIVE_INFINITY,a=0;for(let t=0;t<n.length;t+=r){sA[0]=n[t]-e[0],sA[1]=n[t+1]-e[1],sA[2]=n[t+2]-e[2];const s=i[0]*sA[0]+i[1]*sA[1]+i[2]*sA[2],r=sA[0]*sA[0]+sA[1]*sA[1]+sA[2]*sA[2]-s*s/(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);r>o&&(o=r,a=t)}return FA(s,n,a),o}(e,s,o,r)<HT?2:(OA(a,n,r),LA(a,a),OA(h,r,s),LA(h,h),zA(i,a,o),LA(i,i),uA(e,i,o,a,h,l),0))}(r,t,f,h,l,c,u,d,p,a)){case 1:return void fA(ZT,QT,e);case 2:return void function(t,e,i){FA(gA,e),Math.abs(e[0])>Math.abs(e[1])&&Math.abs(e[0])>Math.abs(e[2])?gA[0]=0:Math.abs(e[1])>Math.abs(e[2])?gA[1]=0:gA[2]=0,EA(gA)<HT&&(gA[0]=gA[1]=gA[2]=1),zA(mA,e,gA),LA(mA,mA),zA(vA,e,mA),LA(vA,vA),bA(t,e,mA,vA,yA,wA),OA(xA,wA,yA),PA(e,mA,vA,yA,wA,xA,i)}(t,u,e)}(function(t,e,i,s,n,r,o,a,h){(function(t,e,i,s,n){!function(t,e,i,s,n){const{data:r,size:o}=t;FA(s,r),FA(n,s),i[0]=VA(dA,e),i[1]=i[0];for(let t=o;t<r.length;t+=o){const o=r[t]*e[0]+r[t+1]*e[1]+r[t+2]*e[2];o<i[0]&&(i[0]=o,FA(s,r,t)),o>i[1]&&(i[1]=o,FA(n,r,t))}}(t,e,nA,n,s);const r=VA(i,e);nA[1]-HT<=r&&(s[0]=void 0),nA[0]+HT>=r&&(n[0]=void 0)})(t,e,i,YT,XT),void 0!==YT[0]&&(OA(KT,YT,i),LA(KT,KT),OA($T,YT,s),LA($T,$T),OA(JT,YT,n),LA(JT,JT),zA(tA,$T,r),LA(tA,tA),zA(eA,JT,o),LA(eA,eA),zA(iA,KT,a),LA(iA,iA),uA(t,tA,r,$T,KT,h),uA(t,eA,o,JT,$T,h),uA(t,iA,a,KT,JT,h)),void 0!==XT[0]&&(OA(KT,XT,i),LA(KT,KT),OA($T,XT,s),LA($T,$T),OA(JT,XT,n),LA(JT,JT),zA(tA,$T,r),LA(tA,tA),zA(eA,JT,o),LA(eA,eA),zA(iA,KT,a),LA(iA,iA),uA(t,tA,r,$T,KT,h),uA(t,eA,o,JT,$T,h),uA(t,iA,a,KT,JT,h))})(t,f,h,l,c,u,d,p,a),bA(t,a.b0,a.b1,a.b2,yA,wA);const g=[0,0,0];OA(g,wA,yA),a.quality=_A(g),a.quality<o?PA(a.b0,a.b1,a.b2,yA,wA,g,e):fA(ZT,QT,e)}(t,e=e||qA()),e}function ZA(t,e){const i=Yl(e,t.center),s=JA(t,Wl(e));return i>s?1:i<-s?-1:0}function QA(t,e){e||(e=Sn());const i=ln(BA,t.quaternion),s=t.halfSize[0]*Math.abs(i[0])+t.halfSize[1]*Math.abs(i[3])+t.halfSize[2]*Math.abs(i[6]),n=t.halfSize[0]*Math.abs(i[1])+t.halfSize[1]*Math.abs(i[4])+t.halfSize[2]*Math.abs(i[7]),r=t.halfSize[0]*Math.abs(i[2])+t.halfSize[1]*Math.abs(i[5])+t.halfSize[2]*Math.abs(i[8]);return e[0]=t.center[0]-s,e[1]=t.center[1]-n,e[2]=t.center[2]-r,e[3]=t.center[0]+s,e[4]=t.center[1]+n,e[5]=t.center[2]+r,e}function YA(t,e){return Yl(e,t.center)-JA(t,Wl(e))}function XA(t,e){return Yl(e,t.center)+JA(t,Wl(e))}function KA(t,e){return ZA(t,e[0])<=0&&ZA(t,e[1])<=0&&ZA(t,e[2])<=0&&ZA(t,e[3])<=0&&ZA(t,e[4])<=0&&ZA(t,e[5])<=0}function $A(t,e,i,s=0){tl(jA,t.quaternion),ts(NA,e,t.center);const n=Ds(NA,NA,jA),r=Ds(kA,i,jA);let o=-1/0,a=1/0;for(let e=0;e<3;e++)if(Math.abs(r[e])>1e-6){const i=(s+t.halfSize[e]-n[e])/r[e],h=(-s-t.halfSize[e]-n[e])/r[e];o=Math.max(o,Math.min(i,h)),a=Math.min(a,Math.max(i,h))}else if(n[e]>t.halfSize[e]+s||n[e]<-t.halfSize[e]-s)return!1;return o<=a}function JA(t,e){tl(jA,t.quaternion),Ds(NA,e,jA);const i=t.halfSize;return Math.abs(NA[0]*i[0])+Math.abs(NA[1]*i[1])+Math.abs(NA[2]*i[2])}function t_(t,e){for(let i=0;i<8;++i){const s=e[i];s[0]=1&i?-t.halfSize[0]:t.halfSize[0],s[1]=2&i?-t.halfSize[1]:t.halfSize[1],s[2]=4&i?-t.halfSize[2]:t.halfSize[2],Ds(s,s,t.quaternion),Ki(s,s,t.center)}}function e_(t){return _s(t.halfSize)}(()=>{const t=new Int8Array(162);let e=0;const i=i=>{for(let s=0;s<i.length;s++)t[e+s]=i[s];e+=6};i([6,2,3,1,5,4]),i([0,2,3,1,5,4]),i([0,2,3,7,5,4]),i([0,1,3,2,6,4]),i([0,1,3,2,0,0]),i([0,1,5,7,3,2]),i([0,1,3,7,6,4]),i([0,1,3,7,6,2]),i([0,1,5,7,6,2]),i([0,1,5,4,6,2]),i([0,1,5,4,0,0]),i([0,1,3,7,5,4]),i([0,2,6,4,0,0]),i([0,0,0,0,0,0]),i([1,3,7,5,0,0]),i([2,3,7,6,4,0]),i([2,3,7,6,0,0]),i([2,3,1,5,7,6]),i([0,1,5,7,6,2]),i([0,1,5,7,6,4]),i([0,1,3,7,6,4]),i([4,5,7,6,2,0]),i([4,5,7,6,0,0]),i([4,5,1,3,7,6]),i([0,2,3,7,5,4]),i([6,2,3,7,5,4]),i([6,2,3,1,5,4])})();class i_{constructor(t){this._totalCount=t,this._indexRanges=[0,t]}componentCount(){const t=this._indexRanges;let e=0;for(let i=0;i<t.length;i+=2)e+=t[i+1];return e}reset(t){this._indexRanges="all"===t||t.length===this._totalCount?[0,this._totalCount]:function(t){const e=new Array;if(0===t.length)return e;let i=t[0],s=1;for(let n=1;n<t.length;n++){const r=t[n];i+s===r?s+=1:(e.push(i),e.push(s),i=r,s=1)}return e.push(i),e.push(s),e}(t)}forEachComponent(t){const e=this._indexRanges;for(let i=0;i<e.length;i+=2){const s=e[i],n=s+e[i+1];for(let e=s;e<n;e++)if(!t(e))return!1}return!0}forEachComponentRange(t){const e=this._indexRanges;for(let i=0;i<e.length;i+=2){const s=e[i];if(!t(s,s+e[i+1]))return!1}return!0}computeOffsetRanges(t){const e=new Array(this._indexRanges.length),i=this._indexRanges;for(let s=0;s<i.length;s+=2){const n=i[s],r=t[n],o=t[n+i[s+1]];e[s]=r,e[s+1]=o-r}return e}}class s_ extends Lr{constructor(t,e){super(),this.pickability=null,this.highlightCounts=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null,this.offsets=jt(e);const i=this.count;this.visibility=new i_(i),this.materialDataBuffer=t.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let t=0;t<i;t++)this.materialDataIndices[t]=this.materialDataBuffer.acquireIndex()}dispose(){super.dispose();for(let t=0;t<this.count;t++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[t])}get count(){return this.offsets.length-1}get geometryRanges(){return w(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return w(this.highlightCounts)?null:(this.updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return w(this.highlightCounts)?this.geometryRanges:(this.updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty()}updateCachedHighlightRanges(){if((w(this.cachedHighlightRanges)||w(this.cachedDefaultRanges))&&p(this.highlightCounts)){const{highlightRanges:t,defaultRanges:e}=function(t,e,i){const s=[],n=[];let r=i.length,o=i.length;return e.forEachComponent((e=>(t[e]>0?(r!==e-1&&(s.length&&s.push(i[r+1]-s[s.length-1]),s.push(i[e])),r=e):(o!==e-1&&(n.length&&n.push(i[o+1]-n[n.length-1]),n.push(i[e])),o=e),!0))),s.length&&s.push(i[r+1]-s[s.length-1]),n.length&&n.push(i[o+1]-n[n.length-1]),{highlightRanges:s,defaultRanges:n}}(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=t,this.cachedDefaultRanges=e}}}class n_ extends Lr{constructor(){super(...arguments),this.visible=0}}function r_(t,e,i,s){if(i>=e)return t;null==t&&(t=function(t=!0){return{isVisibleBit:!t,data:new Uint32Array(0)}}());const n=t.isVisibleBit;let r=t.data;const o=a_(r),a=i/o|0,h=i-o*a,l=(e-1)/o|0,c=r,u=s===n;if(!(i<c.length*o)&&u){const t=a+1,e=Math.ceil(1.5*c.length),i=l+1;let s=Math.max(t,e);s=Math.min(s,i),r=new Uint32Array(s),r.set(c)}return a<r.length&&(r[a]=function(t,e,i){return t&~(1<<e)|(i?1:0)<<e}(r[a],h,u)),t.data=r,t}function o_(t,e){if(null==t)return!0;const{isVisibleBit:i,data:s}=t,n=a_(s);return e<s.length*n?function(t,e,i,s){const n=i/s|0;return function(t,e){return 0!=(t&1<<e)}(e[n],i-n*s)===t}(i,s,e,n):!t.isVisibleBit}function a_(t){return 8*t.BYTES_PER_ELEMENT}r([Er()],n_.prototype,"renderable",void 0),r([Er()],n_.prototype,"components",void 0);class h_{constructor(t,e){this._indices=p(t.indices)?t.indices:dc(t.positions.length/3),this._positions=new kc(t.positions),this._components=e,this._componentIntersectionData=new Array(e.count)}getComponentAabb(t,e){if(p(this._perComponentAabbs)){for(let i=0;i<6;i++)e[i]=this._perComponentAabbs[6*t+i];return e}return this._computePerComponentAabbs(),this.getComponentAabb(t,e)}getComponentPositions(t,e){e.indices=this._indices,e.data=this._positions.typedBuffer,e.stride=this._positions.typedBufferStride,e.startIndex=this._components.offsets[t],e.endIndex=this._components.offsets[t+1]}intersect(t,e,i,s,n,r){const o={data:this._positions.typedBuffer,stride:this._positions.typedBufferStride,size:3},a=this._indices,h=this._components.offsets,l=Mh(t,e,l_);this._components.visibility.forEachComponent((c=>{if(!o_(this._components.pickability,c))return!0;const u=this.getComponentAabb(c,c_);if(p(n)&&n.applyToAabb(u),!Sh(u,t,l,i))return!0;const d=h[c]/3,f=h[c+1]/3,g=(t,e,i)=>{r(c,t,ps(e,e,s),i)},m=f-d;return w(n)&&m>40?(null==this._componentIntersectionData[c]&&(this._componentIntersectionData[c]=new sT(this._indices,d,f,o)),this._componentIntersectionData[c].intersectRay({r0:t,r1:e},g)):Ch(t,e,d,f,a,o,void 0,n,g),!0}))}_computePerComponentAabbs(){const t=this._components.count;this._perComponentAabbs=new Float32Array(6*t);for(let e=0;e<t;e++)this._computeAABB(e)}_computeAABB(t){const e=this._indices,i=this._positions,s=this._components.offsets,n=s[t+1],r=[0,0,0],o=[1/0,1/0,1/0],a=[-1/0,-1/0,-1/0];for(let h=s[t];h<n;h++)i.getVec(e[h],r),Os(o,o,r),Rs(a,a,r);let h=6*t;this._perComponentAabbs[h++]=o[0],this._perComponentAabbs[h++]=o[1],this._perComponentAabbs[h++]=o[2],this._perComponentAabbs[h++]=a[0],this._perComponentAabbs[h++]=a[1],this._perComponentAabbs[h]=a[2]}get positions(){return this._positions}get indices(){return this._indices}}const l_=js(),c_=Sn();class u_{constructor(t,e,i,s){this.material=t,this.drawParameters=e,this.geometry=i,this.meta=s}dispose(){this.material.dispose(),this.geometry.dispose()}}class d_ extends Lr{constructor(t,e,i,s){super(),this.primitiveType=e,this.parameters=i,this.indexed=s,this.vao=t}}function p_(t){return t?f_(t,1/0,-1/0):{near:1/0,far:-1/0}}function f_(t,e,i){return t.near=e,t.far=i,t}function g_(t,e,i=t){return i.near=Math.min(t.near,e.near),i.far=Math.max(t.far,e.far),i}function m_(t,e){return t.near<=e&&e<=t.far}r([Er()],d_.prototype,"vao",void 0);const v_={near:0,far:0};const y_=new pt({allocator:t=>t||{near:1/0,far:-1/0,mask:0,object:null},deallocator:t=>(t.object=null,t)}),w_=p_(),x_=js(),b_=js(),C_=new pt({deallocator:null}),M_=new pt({deallocator:null});function S_(t,e,i){i.length=0;const s=e.length-3;P_(x_,e,s);const n=Yl(t,x_);n<=0&&(i.push(x_[0]),i.push(x_[1]),i.push(x_[2]));let r=0,o=n;for(;r<s;r+=3){P_(b_,e,r);const s=Yl(t,b_);o*s<0&&(ws(x_,b_,x_,s/(s-o)),T_(i,x_)),s<=0&&T_(i,b_),o=s,$i(x_,b_)}o*n<0&&(P_(b_,e,s),ws(x_,b_,x_,n/(n-o)),T_(i,x_))}function P_(t,e,i){return ds(t,e.data[i+0],e.data[i+1],e.data[i+2])}function T_(t,e){t.push(e[0]),t.push(e[1]),t.push(e[2])}function A_(t,e,i,s){tl(R_,t.quaternion),Fs(F_,e,t.center),Ds(F_,F_,R_);const n=8*((F_[0]<-t.halfSize[0]?-1:F_[0]>t.halfSize[0]?1:0)+3*(F_[1]<-t.halfSize[1]?-1:F_[1]>t.halfSize[1]?1:0)+9*(F_[2]<-t.halfSize[2]?-1:F_[2]>t.halfSize[2]?1:0)+13),r=__[n];if(0===r)return r;ln(O_,t.quaternion),cn(O_,O_,t.halfSize);const o=(e,i)=>{const s=__[n+i+1];return ds(e,((1&s)<<1)-1,(2&s)-1,((4&s)>>1)-1),ps(e,e,O_),Ki(e,t.center,e)};return i.length=0,T_(i,o(z_,0)),T_(i,o(L_,1)),T_(i,o(F_,2)),T_(i,o(E_,3)),s(i),1===r||(i.length=0,T_(i,z_),T_(i,E_),T_(i,o(F_,4)),T_(i,o(I_,5)),s(i),2===r||(i.length=0,T_(i,z_),T_(i,I_),T_(i,o(F_,6)),T_(i,L_),s(i))),r}const __=(()=>{const t=new Int8Array(216);let e=0;const i=i=>{for(let s=0;s<i.length;s++)t[e+s]=i[s];e+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),t})(),D_=4,O_=pn(),R_=fn(),F_=js(),z_=js(),L_=js(),E_=js(),I_=js();class V_{constructor(t){this._objects=t}submit(t,e){this._objects.preSubmit(e),this._objects.visibleObjects.forAll((e=>e.renderable.material.submit(t,e)))}queryShadowCasterDepthRange(t){return this._objects.visibleObjects.length?function(t,e){const i=p_(),{eye:s,frustum:n,viewForward:r}=t;e.forAll((t=>{const e=t.obb,o=es(Fs(F_,e.center,s),r),a=JA(e,r);if(m_(i,o-a)&&m_(i,o+a))return;const h=function(t,e){let i=0;for(let s=0;s<D_;s++){const n=ZA(t,e[s]);if(n>0)return-1;0===n&&(i|=1<<s)}return i}(e,n);if(-1===h)return;if(0===h)return w_.far=o+a,w_.near=o-a,void g_(i,w_);const l=y_.pushNew();l.near=o-a,l.far=o+a,l.mask=h,l.object=t}));for(let t=0;t<y_.length;t++){const e=y_.data[t];m_(i,e.near)&&m_(i,e.far)||(w_.far=e.far,w_.near=1/0,0===A_(e.object.obb,s,C_,(t=>{let i=M_;for(let s=0;s<D_&&t.length>0;s++){if(0==(e.mask&1<<s))continue;S_(n[s],t,i);const r=t;t=i,i=r}for(let e=0;e<t.length;e+=3){ds(x_,t.data[e+0],t.data[e+1],t.data[e+2]);const i=es(Fs(x_,x_,s),r);w_.near=Math.min(w_.near,i)}}))&&(w_.near=0),g_(i,w_))}return y_.length=0,i}(t,this._objects.visibleObjects):null}}function j_(t){const e=yl().vec3f("position");return t.normals&&e.vec2i16("normalCompressed",{glNormalized:!0}),1===t.textureCoordinates?e.vec2f("uv0"):2===t.textureCoordinates&&(e.vec2f("uv0"),e.vec4u16("uvRegion",{glNormalized:!0})),t.colors&&e.vec4u8("color",{glNormalized:!0}),e.alignTo(4)}function N_(t,e){1===e.componentData&&(t.vertex.uniforms.add("uComponentColorTex","sampler2D"),t.vertex.uniforms.add("uComponentColorTexInvDim","vec2"),t.attributes.add("componentIndex","float"),t.varyings.add("vExternalColorMixMode","mediump float"),t.varyings.add("vExternalColor","vec4"),t.include(za),t.vertex.code.add(Ua`vec4 _readComponentColor() {
float normalizedIndex = (componentIndex + 0.5) * uComponentColorTexInvDim.x;
vec2 indexCoord = vec2(
mod(normalizedIndex, 1.0),
(floor(normalizedIndex) + 0.5) * uComponentColorTexInvDim.y
);
return texture2D(uComponentColorTex, indexCoord);
}
vec4 forwardExternalColor(out bool castShadows) {
vec4 componentColor = _readComponentColor() * 255.0;
float shadowFlag = mod(componentColor.b * 255.0, 2.0);
componentColor.b -= shadowFlag;
castShadows = shadowFlag >= 1.0;
int decodedColorMixMode;
vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451;
vExternalColorMixMode = float(decodedColorMixMode) + 0.5;
return vExternalColor;
}`),t.fragment.code.add(Ua`void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
externalColor = vExternalColor;
externalColorMixMode = int(vExternalColorMixMode);
}`)),0===e.componentData&&(t.vertex.uniforms.add("uExternalColor","vec4"),t.fragment.uniforms.add("uExternalColorMixMode","int"),t.varyings.add("vExternalColor","vec4"),t.vertex.code.add(Ua`vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = uExternalColor;
castShadows = true;
return uExternalColor;
}`),t.fragment.code.add(Ua`void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
externalColor = vExternalColor;
externalColorMixMode = uExternalColorMixMode;
}`))}function k_(t,e){const i=t.vertex;switch(i.code.add(Ua`#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)`),e.vertexDiscardMode){case 0:i.code.add(Ua`#define vertexDiscardByOpacity(_opacity_) {}`);break;case 2:i.code.add(Ua`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case 1:i.code.add(Ua`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`)}}function B_(t,e){t.include(Ph,e),t.fragment.include(La);const i=t.fragment;i.uniforms.add("uBaseColor","vec4"),i.uniforms.add("uObjectOpacity","float"),i.code.add(e.attributeColor?Ua`vec3 _baseColor() {
return uBaseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return uBaseColor.a * vColor.a;
}`:Ua`vec3 _baseColor() {
return uBaseColor.rgb;
}
float _baseOpacity() {
return uBaseColor.a;
}`),i.code.add(Ua`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = uObjectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function G_(t,e){const i=t.fragment;0===e.doubleSidedMode?i.code.add(Ua`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`):1===e.doubleSidedMode?(t.include(Ea,e),i.uniforms.add("uTransform_ViewFromCameraLocal_T","vec3"),i.code.add(Ua`vec3 _adjustDoublesided(vec3 normal) {
vec3 viewDir = vPositionWorldCameraRelative + uTransform_ViewFromCameraLocal_T;
return dot(normal, viewDir) > 0.0 ? -normal : normal;
}`)):2===e.doubleSidedMode&&i.code.add(Ua`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`),0===e.normalType||1===e.normalType?(t.include(Ia,e),i.code.add(Ua`vec3 shadingNormalWorld() {
return _adjustDoublesided(normalize(vNormalWorld));
}
vec3 shadingNormal_view() {
vec3 normal = normalize(vNormalView);
return gl_FrontFacing ? normal : -normal;
}`)):3===e.normalType?(t.extensions.add("GL_OES_standard_derivatives"),t.include(Ea,e),i.code.add(Ua`vec3 shadingNormalWorld() {
return normalize(cross(
dFdx(vPositionWorldCameraRelative),
dFdy(vPositionWorldCameraRelative)
));
}
vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));
}`)):2===e.normalType&&(1===e.viewingMode?(t.include(Ea,e),i.code.add(Ua`vec3 shadingNormalWorld() {
return normalize(positionWorld());
}`)):2===e.viewingMode&&i.code.add(Ua`vec3 shadingNormalWorld() {
return vec3(0.0, 0.0, 1.0);
}`),t.extensions.add("GL_OES_standard_derivatives"),i.code.add(Ua`vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;
}`))}function q_(t,e){const i=t.fragment;e.baseColorTexture?(t.include(Va,e),i.uniforms.add("uBaseColorTexture","sampler2D"),i.uniforms.add("uBaseColorTextureSize","vec2"),2===e.attributeTextureCoordinates?(t.include(ja),i.code.add(Ua`vec4 readBaseColorTexture() {
return textureAtlasLookup(
uBaseColorTexture,
uBaseColorTextureSize,
vuv0,
vuvRegion
);
}`)):i.code.add(Ua`vec4 readBaseColorTexture() {
return texture2D(uBaseColorTexture, vuv0);
}`)):i.code.add(Ua`vec4 readBaseColorTexture() { return vec4(1.0); }`)}const W_=new Map([["position",0],["normal",1],["normalCompressed",1],["color",2],["uv0",3],["uvRegion",4],["componentIndex",5]]);function U_(t){const e=new Wa;e.include(Ea,t),e.include(Ia,t),e.include(Ph,t),e.include(Aa,t),e.include(Th,t),e.include(N_,t),e.include(Ah,t),e.include(gh,t),e.include(q_,t),e.include(k_,t),e.fragment.uniforms.add("view","mat4"),1!==t.pbrMode&&2!==t.pbrMode||(e.include(Na,t),t.hasNormalTexture&&e.include(ka,t)),e.vertex.code.add(3===t.output&&1===t.componentData?Ua`#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`:Ua`#define discardShadows(castShadows) {}`);const i=t.overlayEnabled&&0===t.output&&4===t.pbrMode;return t.overlayEnabled&&(e.include(lT,t),e.vertex.code.add(1===t.viewingMode?Ua`
      const float invEllipsoidRadius = ${Ua.float(1/(1===t.ellipsoidMode?U.radius:2===t.ellipsoidMode?Nt.radius:kt.radius))};
      vec2 projectOverlay(vec3 pos) {
        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);
      }
      `:Ua`vec2 projectOverlay(vec3 pos) { return pos.xy; }`)),i&&(e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),e.varyings.add("groundNormal","vec3"),e.varyings.add("positionView","vec3")),e.vertex.code.add(Ua`
    void main() {
      bool castShadows;
      vec4 externalColor = forwardExternalColor(castShadows);
      discardShadows(castShadows);

      vertexDiscardByOpacity(externalColor.a);

      if (externalColor.a < ${Ua.float(_h)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
      forwardPosition();
      forwardNormal();
      ${i?Ua`
        positionView = position_view();
        ${1===t.viewingMode?Ua`
        groundNormal = normalize(positionWorld());
        tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
        tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:Ua`
        groundNormal = vec3(0.0, 0.0, 1.0);
        tbnTangent = vec3(1.0, 0.0, 0.0);
        tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`}
        `:""}

      ${t.overlayEnabled?Ua`setOverlayVTC(projectOverlay(position));`:""}
      forwardTextureCoordinates();
      forwardVertexColor();
      forwardLinearDepth(); // depends on forwardPosition()
    }
  `),7===t.output&&(e.fragment.include(Ha),t.multipassTerrainEnabled&&e.include(Dh,t),e.include(B_,t),e.fragment.code.add(Ua`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${t.multipassTerrainEnabled?Ua`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${t.overlayEnabled?Ua`
        vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
        vec4 overlayColor = overlayOpacity * overlayColorOpaque;
        materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        gl_FragColor = vec4(materialColor.a);
      }
    `)),0===t.output&&(e.fragment.include(Ha),t.multipassTerrainEnabled&&e.include(Dh,t),e.include(B_,t),e.include(G_,t),e.include(Fa,t),i&&e.fragment.uniforms.add("ovNormalTex","sampler2D"),t.receiveShadows?(e.include(Oh,t),e.fragment.code.add(Ua`float evaluateShadow() {
return readShadowMap(vPositionWorldCameraRelative, linearDepth);
}`)):e.fragment.code.add(Ua`float evaluateShadow() { return 0.0; }`),e.fragment.code.add(Ua`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${t.multipassTerrainEnabled?Ua`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${t.overlayEnabled?Ua`
        vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
        vec4 overlayColor = overlayOpacity * overlayColorOpaque;
        materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}
    `),1===t.pbrMode||2===t.pbrMode?(e.fragment.code.add(Ua`
        ${1===t.pbrMode?Ua`
        applyPBRFactors();
        if (int(externalColorMixMode) == 3) {
          mrr = vec3(0.0, 0.6, 0.2);
        }`:""}
        vec3 normalVertex = shadingNormalWorld();
        float additionalIrradiance = 0.02 * lightingMainIntensity[2];
      `),e.fragment.code.add(t.hasNormalTexture?Ua`mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);
vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`:Ua`vec3 shadingNormal = normalVertex;`),e.fragment.code.add(Ua`${1===t.viewingMode?Ua`vec3 normalGround = normalize(positionWorld());`:Ua`vec3 normalGround = vec3(0.0, 0.0, 1.0);`}
      `),e.fragment.code.add(Ua`vec3 viewDir = normalize(vPositionWorldCameraRelative);
float ssao = 1.0 - occlusion * (1.0 - evaluateAmbientOcclusion());
vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);`)):(e.fragment.code.add(t.receiveShadows?Ua`float shadow = evaluateShadow();`:1===t.viewingMode?Ua`float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());
float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);`:Ua`float shadow = 0.0;`),e.fragment.code.add(Ua`
      float ambientOcclusion = evaluateAmbientOcclusion();
      // At global scale we create some additional ambient light based on the main light to simulate global illumination
      vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());
      vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);
      ${i?Ua`
          vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
          float waterNormalLength = length(overlayWaterMask);
          if (waterNormalLength > 0.95) {
            mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
            vec4 waterOverlayColor = vec4(overlayColorOpaque.xyz, overlayColor.w);
            vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, positionView);
            vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
            // un-gamma the ground color to mix in linear space
            shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
          }`:""}
      `)),e.fragment.code.add(Ua`
        gl_FragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);
        ${t.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),1!==t.output&&3!==t.output||(e.include(mh,t),e.fragment.code.add(Ua`void main() {
discardBySlice(vPositionWorldCameraRelative);
vec4 textureColor = readBaseColorTexture();
discardOrAdjustAlpha(textureColor);
outputDepth(linearDepth);
}`)),2===t.output&&(e.include(G_,t),e.fragment.code.add(Ua`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        // note: the alpha component needs to be 1.0 in order for this material
        // to influence ambient occlusion, see the ssao fragment shader
        float alpha = ${2===t.normalType?"0.0":"1.0"};
        gl_FragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);
      }
    `)),4===t.output&&(e.include(vh),e.fragment.code.add(Ua`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${t.overlayEnabled?Ua`
        vec4 overlayColor = getCombinedOverlayColor();

        if (overlayColor.a == 0.0) {
          gl_FragColor = vec4(0.0);
          return;
        }`:""}

        outputHighlight();
      }
    `)),e}const H_=Object.freeze({__proto__:null,attributeLocations:W_,build:U_});class Z_ extends Ya{bindPass(t){const e=this.program;Ea.bindViewProjTransform(e,t.viewTransform),bh(this.program,this.configuration,t.slicePlane),0===t.identifier&&(void 0!==t.ssrParams&&Dr(this.program,t.ssrParams),e.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",t.transformNormal_ViewFromGlobal),2===t.subPass&&e.setUniform2fv("cameraNearFar",t.cameraNearFar),0===t.subPass&&t.lighting.setUniforms(this.program,t.integratedMesh)),1===t.identifier&&this.program.setUniform2fv("cameraNearFar",t.cameraNearFar)}bindMaterial(t,e){this._material=t;const i=this.program;i.setUniform4fv("uBaseColor",t.baseColor),i.setUniform1f("uObjectOpacity",t.objectOpacity),i.setUniform1f("textureAlphaCutoff",t.alphaCutoff),1===t.componentParameters.type?t.componentParameters.texture.bind(i,"uComponentColorTex","uComponentColorTexInvDim"):(i.setUniform4fv("uExternalColor",t.componentParameters.externalColor),i.setUniform1i("uExternalColorMixMode",t.componentParameters.externalColorMixMode)),p(t.baseColorTexture)&&t.baseColorTexture.bind(i,"uBaseColorTexture","uBaseColorTextureSize"),0!==this.configuration.output&&7!==this.configuration.output||(Ba(this.program,t,this.configuration.isSchematic),p(t.metallicRoughnessTexture)&&t.metallicRoughnessTexture.bind(i,"texMetallicRoughness","texMetallicRoughnessSize"),p(t.emissionTexture)&&t.emissionTexture.bind(i,"texEmission","texEmissionSize"),p(t.occlusionTexture)&&t.occlusionTexture.bind(i,"texOcclusion","texOcclusionSize"),p(t.normalTexture)&&t.normalTexture.bind(i,"normalTexture","normalTextureSize")),t.isIntegratedMesh&&(0===e.identifier&&0===e.subPass?(i.bindTexture(t.overlayColor,"ovColorTex"),i.bindTexture(t.overlayNormal,"ovNormalTex")):2===e.identifier&&i.bindTexture(t.overlayHighlight,"ovColorTex"),i.setUniform1f("overlayOpacity",1)),2===e.identifier&&Rh(this.program,e),0===e.identifier&&0===e.subPass&&(e.ambientOcclusionEnabled&&e.bindAmbientOcclusion(i),e.shadowsEnabled&&e.bindShadowMap(i)),0!==e.identifier||0!==e.subPass&&1!==e.subPass||!e.multipassTerrainParams.multipassTerrainEnabled||(this.program.setUniform2fv("cameraNearFar",e.cameraNearFar),i.setUniform2fv("inverseViewport",e.inverseViewport),e.multipassTerrainParams.terrainLinearDepthTexture&&i.bindTexture(e.multipassTerrainParams.terrainLinearDepthTexture,"terrainDepthTexture"))}bindDraw(t){if(Ea.bindModelTransform(this.program,t),this.program.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",t.transformNormal_GlobalFromModel),this.program.rebindTextures(),p(this._material)&&this._material.isIntegratedMesh){const e=this._material.overlayTexScale,i=this._material.overlayTexOffset;this.program.setUniform4fv("overlayTexOffset",[t.toMapSpace[0]*e[0]+i[0],t.toMapSpace[1]*e[1]+i[1],t.toMapSpace[0]*e[2]+i[2],t.toMapSpace[1]*e[3]+i[3]]),this.program.setUniform4fv("overlayTexScale",[t.toMapSpace[2]*e[0],t.toMapSpace[3]*e[1],t.toMapSpace[2]*e[2],t.toMapSpace[3]*e[3]])}}initializeProgram(t){const e=Z_.shader.get(),i=this.configuration,s=e.build({multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround,OITEnabled:0===i.transparencyPassType,output:i.output,normalType:0===i.integratedMeshMode?i.hasNormals?1:3:2,attributeColor:i.hasVertexColors,attributeTextureCoordinates:i.vertexTextureCoordinates,componentData:i.componentData,alphaDiscardMode:i.alphaDiscardMode,baseColorTexture:i.baseColorTexture,doubleSidedMode:i.doubleSidedMode,receiveAmbientOcclusion:i.receiveAmbientOcclusion,receiveShadows:i.receiveShadows,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,viewingMode:t.viewingMode,vertexDiscardMode:i.vertexDiscardMode,pbrMode:3===i.integratedMeshMode?4:i.usePBR?i.isSchematic?2:1:0,hasMetalnessAndRoughnessTexture:i.hasMetalnessAndRoughnessTexture,hasEmissionTexture:i.hasEmissionTexture,hasOcclusionTexture:i.hasOcclusionTexture,hasNormalTexture:i.hasNormalTexture,vertexTangents:!1,supportsTextureAtlas:!0,doublePrecisionRequiresObfuscation:Ga(t.rctx),overlayEnabled:2===i.integratedMeshMode||3===i.integratedMeshMode,ssrEnabled:i.ssrEnabled,highStepCount:!1,ellipsoidMode:i.ellipsoidMode});return new Xa(t.rctx,s,e.attributeLocations)}setPipelineState(t){const e=this.configuration,i=0!==e.integratedMeshMode,s=3===t,n=2===t;return Gh({blending:0!==e.output&&7!==e.output||!e.blendingEnabled?null:s?Yh:Xh(t),culling:Kh(e.cullFace),depthTest:{func:$h(t)},depthWrite:s||n?Qh:null,colorWrite:Wh,stencilWrite:i||e.sceneHasOcludees?Fh:null,stencilTest:i?zh(1):e.sceneHasOcludees?Lh:null,polygonOffset:s||n?e.polygonOffsetEnabled?{factor:2,units:2}:null:Jh})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}Z_.shader=new $a(H_,(()=>import("./p-934d3113.js")));class Q_ extends Ea.ModelTransform{constructor(){super(...arguments),this.transformNormal_GlobalFromModel=pn(),this.toMapSpace=sa()}}class Y_ extends Qa{constructor(){super(...arguments),this.output=0,this.hasVertexColors=!1,this.hasNormals=!1,this.vertexTextureCoordinates=0,this.componentData=0,this.slicePlaneEnabled=!1,this.cullFace=2,this.baseColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.vertexDiscardMode=0,this.doubleSidedMode=2,this.blendingEnabled=!0,this.alphaDiscardMode=1,this.integratedMeshMode=0,this.ssrEnabled=!1,this.polygonOffsetEnabled=!1,this.usePBR=!1,this.isSchematic=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.ellipsoidMode=1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}r([Za({count:8})],Y_.prototype,"output",void 0),r([Za()],Y_.prototype,"hasVertexColors",void 0),r([Za()],Y_.prototype,"hasNormals",void 0),r([Za({count:3})],Y_.prototype,"vertexTextureCoordinates",void 0),r([Za({count:2})],Y_.prototype,"componentData",void 0),r([Za()],Y_.prototype,"slicePlaneEnabled",void 0),r([Za({count:3})],Y_.prototype,"cullFace",void 0),r([Za()],Y_.prototype,"baseColorTexture",void 0),r([Za()],Y_.prototype,"receiveAmbientOcclusion",void 0),r([Za()],Y_.prototype,"receiveShadows",void 0),r([Za({count:3})],Y_.prototype,"vertexDiscardMode",void 0),r([Za({count:3})],Y_.prototype,"doubleSidedMode",void 0),r([Za()],Y_.prototype,"blendingEnabled",void 0),r([Za({count:4})],Y_.prototype,"alphaDiscardMode",void 0),r([Za({count:4})],Y_.prototype,"integratedMeshMode",void 0),r([Za()],Y_.prototype,"ssrEnabled",void 0),r([Za()],Y_.prototype,"polygonOffsetEnabled",void 0),r([Za()],Y_.prototype,"usePBR",void 0),r([Za()],Y_.prototype,"isSchematic",void 0),r([Za()],Y_.prototype,"hasMetalnessAndRoughnessTexture",void 0),r([Za()],Y_.prototype,"hasEmissionTexture",void 0),r([Za()],Y_.prototype,"hasOcclusionTexture",void 0),r([Za()],Y_.prototype,"hasNormalTexture",void 0),r([Za()],Y_.prototype,"sceneHasOcludees",void 0),r([Za({count:4})],Y_.prototype,"transparencyPassType",void 0),r([Za({count:4})],Y_.prototype,"ellipsoidMode",void 0),r([Za()],Y_.prototype,"multipassTerrainEnabled",void 0),r([Za()],Y_.prototype,"cullAboveGround",void 0);class X_{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}}function K_(t={}){return(e,i)=>{var s;const n=null!=(s=e._parameterCount)?s:0;if(e._parameterCount=n+1,t.vectorOps){const s=t.vectorOps;Object.defineProperty(e,i,{get(){return this[n]},set(t){const e=this[n];if(null==e)this[n]=t;else{if(s.equals(e,t))return;s.copy(e,t)}this._setDirty()}})}else Object.defineProperty(e,i,{get(){return this[n]},set(e){this[n]!==e&&(t.dispose&&this[n]&&this[n].dispose(),this[n]=e,this._setDirty())}})}}function $_(){return(t,e)=>{var i;const s=null!=(i=t._parameterCount)?i:0;t._parameterCount=s+1,t._parameterBlocks=t._parameterBlocks||[],t._parameterBlocks.push(s),Object.defineProperty(t,e,{get(){return this[s]},set(t){this[s]!==t&&(this[s]=t,this._setDirty())}})}}class J_ extends class{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,null!=this._parameterBlocks)for(const t of this._parameterBlocks)this[t]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(null==this._parameterBlocks)return!1;for(const t of this._parameterBlocks)if(this[t].dirty)return!0;return!1}}{constructor(){super(...arguments),this.baseColor=vc(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=ol(1,1,.5),this.emissiveFactor=ol(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.overlayTexOffset=na(-1,-1,-1,-1),this.overlayTexScale=na(0,0,0,0),this.overlayColor=null,this.overlayHighlight=null,this.overlayNormal=null,this.objectOpacity=1,this.commonMaterialParameters=new tD,this.componentParameters=new eD,this.alphaCutoff=Eh,this.alphaDiscardMode=1,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=1,this.sceneHasOcludees=!1,this._techniqueConfig=new Y_}dispose(){this._technique=Z(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}getTechnique(t,e,i){const s=this._techniqueConfig;if(s.hasVertexColors=i.colors,s.hasNormals=i.normals,s.vertexTextureCoordinates=i.textureCoordinates,s.usePBR=this.usePBR,s.hasMetalnessAndRoughnessTexture=p(this.metallicRoughnessTexture),s.hasEmissionTexture=p(this.emissionTexture),s.hasOcclusionTexture=p(this.occlusionTexture),s.hasNormalTexture=p(this.normalTexture),s.transparencyPassType=0===e.identifier&&null!=e.transparencyPassType?e.transparencyPassType:3,s.multipassTerrainEnabled=0===e.identifier&&null!=e.multipassTerrainParams&&e.multipassTerrainParams.multipassTerrainEnabled,s.cullAboveGround=0===e.identifier&&null!=e.multipassTerrainParams&&e.multipassTerrainParams.cullAboveGround,s.ellipsoidMode=this.ellipsoidMode,this.dirty){s.componentData=this.componentParameters.type,s.cullFace=this.commonMaterialParameters.cullFace,s.doubleSidedMode=this.commonMaterialParameters.doubleSided?1:0,s.baseColorTexture=p(this.baseColorTexture),s.isSchematic=this.hasParametersFromSource&&!p(this.baseColorTexture);const t=this._computeWhichMaterialPass();s.blendingEnabled=1===t||2===t,s.alphaDiscardMode=this.alphaDiscardMode,s.integratedMeshMode=this.isIntegratedMesh?this.overlayColor?this.overlayNormal?3:2:1:0,s.polygonOffsetEnabled=this.polygonOffsetEnabled,this._setClean()}return s.slicePlaneEnabled=e.slicePlaneEnabled&&this.commonMaterialParameters.slicePlaneEnabled,1===e.identifier?(s.output=3,s.vertexDiscardMode=0):2===e.identifier?(s.output=4,s.vertexDiscardMode=0):(s.vertexDiscardMode=2===this._computeWhichMaterialPass()?e.transparent?2:1:0,s.output=function(t){switch(t){case 0:return 0;case 1:return 7;case 2:return 1;case 3:return 2}}(e.subPass),1===e.subPass&&(s.sceneHasOcludees=e.sceneHasOcludees),0===e.subPass?(s.receiveAmbientOcclusion=e.ambientOcclusionEnabled,s.sceneHasOcludees=e.sceneHasOcludees,s.receiveShadows=e.shadowsEnabled,s.ssrEnabled=e.ssrParams.ssrEnabled):(s.receiveAmbientOcclusion=!1,s.receiveShadows=!1)),this._technique=t.releaseAndAcquire(Z_,s,this._technique),this._technique}submit(t,e){if(0===this.objectOpacity)return;const i=e.renderable.geometry,s=e.components,n=e.renderable.drawParameters,r=e.renderable.meta.cameraDepthSquared,o=s.geometryRanges,a=s.highlightRanges,h=s.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case 0:t.materialOpaque.submitDraw(this,i,o,n,r);break;case 1:t.materialTransparent.submitDraw(this,i,o,n,r);break;case 2:t.materialOpaque.submitDraw(this,i,o,n,r),t.materialTransparent.submitDraw(this,i,o,n,r);break;case 3:t.materialIntegratedMesh.submitDraw(this,i,o,n,r),this.overlayHighlight&&t.highlightIntegratedMesh.submitDraw(this,i,o,n,r)}const l=2!==this.componentParameters.castShadows;l&&t.shadowMap.submitDraw(this,i,o,n,r),p(a)&&(t.highlight.submitDraw(this,i,a,n,r),l&&t.highlightShadowMap.submitDraw(this,i,a,n,r)),l&&p(h)&&t.defaultShadowMap.submitDraw(this,i,h,n,r)}get attributeLocations(){return W_}_computeWhichMaterialPass(){return this.isIntegratedMesh?3:this.objectOpacity<1?1:0===this.componentParameters.opaqueOverride?0:this.baseColor[3]<1||0===this.alphaDiscardMode||3===this.alphaDiscardMode?1:2===this.componentParameters.transparent?0:0===this.componentParameters.transparent?1:2}}r([K_({vectorOps:Es})],J_.prototype,"baseColor",void 0),r([K_()],J_.prototype,"usePBR",void 0),r([K_()],J_.prototype,"hasParametersFromSource",void 0),r([K_({vectorOps:zs})],J_.prototype,"mrrFactors",void 0),r([K_({vectorOps:zs})],J_.prototype,"emissiveFactor",void 0),r([K_({dispose:!0})],J_.prototype,"baseColorTexture",void 0),r([K_({dispose:!0})],J_.prototype,"metallicRoughnessTexture",void 0),r([K_({dispose:!0})],J_.prototype,"emissionTexture",void 0),r([K_({dispose:!0})],J_.prototype,"occlusionTexture",void 0),r([K_({dispose:!0})],J_.prototype,"normalTexture",void 0),r([K_({vectorOps:{equals:Ls,copy:As}})],J_.prototype,"overlayTexOffset",void 0),r([K_({vectorOps:{equals:Ls,copy:As}})],J_.prototype,"overlayTexScale",void 0),r([K_()],J_.prototype,"overlayColor",void 0),r([K_()],J_.prototype,"overlayHighlight",void 0),r([K_()],J_.prototype,"overlayNormal",void 0),r([K_()],J_.prototype,"objectOpacity",void 0),r([$_()],J_.prototype,"commonMaterialParameters",void 0),r([$_()],J_.prototype,"componentParameters",void 0),r([K_()],J_.prototype,"alphaCutoff",void 0),r([K_()],J_.prototype,"alphaDiscardMode",void 0),r([K_()],J_.prototype,"isIntegratedMesh",void 0),r([K_()],J_.prototype,"polygonOffsetEnabled",void 0),r([K_()],J_.prototype,"ellipsoidMode",void 0),r([K_()],J_.prototype,"sceneHasOcludees",void 0);class tD extends X_{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=2,this.slicePlaneEnabled=!0}}r([K_()],tD.prototype,"doubleSided",void 0),r([K_()],tD.prototype,"cullFace",void 0),r([K_()],tD.prototype,"slicePlaneEnabled",void 0);class eD extends X_{constructor(){super(...arguments),this.externalColor=vc(1,1,1,1),this.externalColorMixMode=1,this.castShadows=0}get transparent(){return this.externalColor[3]<1?0:2}get opaqueOverride(){return 3===this.externalColorMixMode&&1===this.externalColor[3]?0:2}get visible(){return this.externalColor[3]>0?0:2}get type(){return 0}}r([K_({vectorOps:Es})],eD.prototype,"externalColor",void 0),r([K_()],eD.prototype,"externalColorMixMode",void 0),r([K_()],eD.prototype,"castShadows",void 0);class iD extends X_{constructor(){super(...arguments),this.texture=null,this.transparent=2,this.opaqueOverride=2,this.castShadows=2}get type(){return 1}}r([K_()],iD.prototype,"texture",void 0),r([K_()],iD.prototype,"transparent",void 0),r([K_()],iD.prototype,"opaqueOverride",void 0),r([K_()],iD.prototype,"castShadows",void 0);class sD{constructor(t){this._low=ll(),this._high=ll(),t&&this.set(t)}get low(){return this._low}get high(){return this._high}set(t){const e=this._low,i=this._high;$i(e,t),Fs(i,t,e)}setElements(t,e,i){ds(nD,t,e,i),this.set(nD)}get(t){return Ki(t,this._low,this._high)}getLowScaled(t){return Yi(t,this._low,1)}}const nD=js();class rD{constructor(t){this.maxCount=t,this._nextIndex=0,this.recycledIndices=[]}get activeCount(){return this._nextIndex-this.recycledIndices.length}get availableCount(){return this.recycledIndices.length+this.maxCount-this._nextIndex}acquire(){return this.recycledIndices.length>0?this.recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(t){this.recycledIndices.push(t)}}class oD{constructor(t,e=1){this.rctx=t,this.fieldCount=e,this.textureWidth=4096,this.dirty=!0,this.texture=new ml(this.rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:this.textureWidth,height:1,flipped:!1}),this.data=new Bc(new ArrayBuffer(4*this.textureWidth))}dispose(){this.texture.dispose(),this.texture=void 0,this.data=void 0}setData(t,e,i,s,n,r){const o=t*this.fieldCount+e;this.dirty=!0,this.data.set(o,0,i),this.data.set(o,1,s),this.data.set(o,2,n),this.data.set(o,3,r)}setDataElement(t,e,i,s){const n=t*this.fieldCount+e;this.dirty=!0,this.data.set(n,i,s)}resizeToFit(t){const e=t*this.fieldCount;if(e>=this.data.count){const t=Math.ceil((e+1)/this.textureWidth)*this.textureWidth,i=new Bc(new ArrayBuffer(4*t));i.typedBuffer.set(this.data.typedBuffer),this.data=i}}updateTexture(){if(!this.dirty)return;const t=this.texture.descriptor.width;this.data.count>t*this.texture.descriptor.height&&this.texture.resize(t,this.data.count/t),this.texture.setData(this.data.typedBuffer),this.dirty=!1}bind(t,e,i){t.bindTexture(this.texture,e),t.setUniform2f(i,1/this.texture.descriptor.width,1/this.texture.descriptor.height)}}class aD{constructor(t,e=1){this.textureBuffer=new oD(t,e),this.indexManager=new rD(65536)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this.indexManager.availableCount}get activeCount(){return this.indexManager.activeCount}acquireIndex(){const t=this.indexManager.acquire();return this.textureBuffer.resizeToFit(t),t}releaseIndex(t){this.indexManager.release(t)}}class hD{constructor(t,e=1){this.rctx=t,this.fieldCount=e,this.buffers=[]}garbageCollect(){this.buffers=this.buffers.filter((t=>0!==t.activeCount||(t.dispose(),!1)))}destroy(){this.buffers.forEach((t=>t.dispose())),this.buffers=[]}getBuffer(t){for(const e of this.buffers)if(e.availableCount>=t)return e;if(t>65536)return null;const e=new aD(this.rctx,this.fieldCount);return this.buffers.push(e),e}updateTextures(){for(const t of this.buffers)t.textureBuffer.updateTexture()}}const lD=y.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class cD{constructor(t){this._renderManager=t,this._objects=[new pt,new pt],this._renderSubmit=new V_(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new hD(t.rctx)}dispose(){xl(0===this._objects[0].length&&0===this._objects[1].length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy()}createObject(t){const e=new n_;return e.toMapSpace=t.toMapSpace.slice(),e.transform=t.transform,e.obb=WA(t.obb),e.components=new s_(this._componentBufferManager,t.geometry.componentOffsets),e.renderable=this._createRenderable(t,e.components),e.intersectionGeometry=new h_(t.geometry.positionData,e.components),this._objects[e.visible].push(e),e}destroyObject(t){const e=t;this._objects[e.visible].removeUnordered(e),e.dispose(),this._notifyDirty()}setObjectVisibility(t,e){const i=t;e!==i.visible&&(this._objects[i.visible].removeUnordered(i),this._objects[e].push(i),i.visible=e,this._notifyDirty())}preSubmit(t){const e=t.camera.eye;this.visibleObjects.forAll((t=>{const i=Ji(e,t.obb.center);t.renderable.meta.cameraDepthSquared=i}))}getMaterial(t){return t.renderable.material}updateMaterial(t,e){const i=t.renderable.material;e(i),i.dirty&&this._notifyDirty()}setAllComponentVisibilities(t,e){const i=t;i.components.visibility.reset(e),i.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(t,e){return t.components.visibility.forEachComponent(e)}getComponentCount(t){const e=t,i=e.components.visibility.componentCount();return{visible:i,invisible:e.components.count-i}}setComponentData(t,e){const i=t,s=i.renderable.material;if(function(t){return"function"==typeof t}(e)){const t=i.components,n=t.materialDataBuffer,r=t.materialDataIndices,o={castShadows:!0,pickable:!0,externalColor:yc(),externalColorMixMode:1},a=n.textureBuffer,h=new Uint8Array(4),l=new Uint32Array(h.buffer);let c=0,u=0,d=0,p=!1,f=0;for(let i=0;i<t.count;i++)e(i,o),c+=+(o.externalColor[3]<1),u+=+(3===o.externalColorMixMode&&1===o.externalColor[3]),d+=+o.castShadows,jl(o.externalColor,o.externalColorMixMode,h),h[2]=254&h[2]|+o.castShadows,a.setData(r[i],0,h[0],h[1],h[2],h[3]),p=p||i>0&&f!==l[0],f=l[0],o.pickable!==o_(t.pickability,i)&&(t.pickability=r_(t.pickability,t.count,i,o.pickable));p?(s.componentParameters=new iD,s.componentParameters.castShadows=dD(d,t.count),s.componentParameters.transparent=dD(c,t.count),s.componentParameters.opaqueOverride=dD(u,t.count),s.componentParameters.texture=a,a.updateTexture()):(s.componentParameters=new eD,s.componentParameters.castShadows=o.castShadows?0:2,s.componentParameters.externalColor=o.externalColor,s.componentParameters.externalColorMixMode=o.externalColorMixMode)}else s.componentParameters=new eD,s.componentParameters.castShadows=e.castShadows?0:2,s.componentParameters.externalColor=e.externalColor,s.componentParameters.externalColorMixMode=e.externalColorMixMode;this._notifyDirty()}getComponentAabb(t,e,i){return t.intersectionGeometry.getComponentAabb(e,i)}getComponentObb(t){return t.obb}getObjectTransform(t){return t.transform}getComponentPositions(t,e,i){return t.intersectionGeometry.getComponentPositions(e,i)}intersect(t,e,i,s,n,r){const o=t;p(n)&&(n.localOrigin=o.transform.position);const a=un(pD,o.transform.rotationScale);Fs(fD,e,o.transform.position),Fs(gD,i,o.transform.position),ps(fD,fD,a),ps(gD,gD,a);const h=hn(pD,a);return o.intersectionGeometry.intersect(fD,gD,s,h,n,r)}addEdges(t,e,i,s){const n=t,{indices:r,positions:o}=n.intersectionGeometry,a=n.components.offsets;return e.addComponentObject(t,n.transform,{center:n.obb.center,radius:e_(n.obb)},o,r,a,i,s)}addComponentHighlight(t,e){const i=t.components;w(i.highlightCounts)&&(i.highlightCounts=new Uint32Array(i.count+1)),0==i.highlightCounts[e]++&&(i.highlightsDirty(),this._notifyDirty()),i.highlightCounts[i.count]++}removeComponentHighlight(t,e){const i=t.components;if(w(i.highlightCounts))return void lD.warn("Removing non-existing highlight.");const s=i.highlightCounts[e],n=i.highlightCounts[i.count];if(0!==s){if(s>1)return i.highlightCounts[e]=s-1,void(i.highlightCounts[i.count]=n-1);i.highlightCounts[e]=0,i.highlightsDirty(),this._notifyDirty(),1===n?i.highlightCounts=null:i.highlightCounts[i.count]=n-1}else lD.warn("Removing non-existing highlight.")}clearHighlights(t){const e=t.components;p(e.highlightCounts)&&(e.highlightCounts=null,e.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(t){return t.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._objects[1]}_createRenderable(t,e){const i=this._renderManager.rctx,s=t.geometry,n=s.vertices.layoutParameters,r=pl.createVertex(i,35044,s.vertices.data),o=nt(s.indices,(t=>pl.createIndex(i,35044,t))),a=vl(j_(n)),h=new Uint16Array(s.vertices.count);for(let t=0;t<e.count;t++){const i=e.offsets[t],n=e.offsets[t+1],r=e.materialDataIndices[t];if(p(s.indices))for(let t=i;t<n;t++)h[s.indices[t]]=r;else for(let t=i;t<n;t++)h[t]=r}const l=pl.createVertex(i,35044,h.buffer),c=new sD(t.transform.position),u=ye(t.transform.rotationScale);un(u,u),hn(u,u);const d=new Q_;$i(d.worldFromModel_TL,c.low),$i(d.worldFromModel_TH,c.high),dn(d.worldFromModel_RS,t.transform.rotationScale),dn(d.transformNormal_GlobalFromModel,u),As(d.toMapSpace,t.toMapSpace);const f=new J_,g=new dl(i,f.attributeLocations,{data:a,componentIndices:uD},{data:r,componentIndices:l},P(o)),m=new d_(g,4,n,p(o)),v={cameraDepthSquared:.5,gpuMemoryEstimate:r.byteSize+l.byteSize+(p(o)?o.byteSize:0)};return new u_(f,d,m,v)}_notifyDirty(){this._renderManager.notifyDirty()}}const uD=vl(yl().u16("componentIndex"));function dD(t,e){return t===e?0:0===t?2:1}const pD=ve(),fD=js(),gD=js();function mD(t){const e=new Wa;return e.include(Ir),e.fragment.uniforms.add("tex","sampler2D"),0===t.function&&(t.hasOpacityFactor?(e.fragment.uniforms.add("opacity","float"),e.fragment.code.add(Ua`void main() {
gl_FragColor = texture2D(tex, uv) * opacity;
}`)):e.fragment.code.add(Ua`void main() {
gl_FragColor = texture2D(tex, uv);
}`)),3===t.function&&(e.fragment.uniforms.add("overlayIdx","int"),t.hasOpacityFactor&&e.fragment.uniforms.add("opacity","float"),e.fragment.code.add(Ua`
      void main() {
        vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5+ 0.5, uv.y);
        gl_FragColor = texture2D(tex, overlayUV) ${t.hasOpacityFactor?"* opacity":""};
      }`)),1===t.function&&e.fragment.code.add(Ua`void main() {
gl_FragColor = vec4(1.0 - texture2D(tex, uv).a);
}`),2===t.function&&(e.fragment.uniforms.add("colorTexture","sampler2D"),e.fragment.uniforms.add("alphaTexture","sampler2D"),e.fragment.uniforms.add("frontFaceTexture","sampler2D"),e.fragment.code.add(Ua`void main() {
vec4 srcColor = texture2D(colorTexture, uv);
float srcAlpha = texture2D(alphaTexture, uv).r;
vec4 frontFace = texture2D(frontFaceTexture, uv);
if(srcColor.a <= 1e-5){
discard;
}
gl_FragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
}`)),e}const vD=Object.freeze({__proto__:null,build:mD});class yD extends Ya{initializeProgram(t){const e=yD.shader.get().build(this.configuration);return new Xa(t.rctx,e,Ka)}initializePipeline(){if(1===this.configuration.function)return Gh({colorWrite:{r:!1,g:!0,b:!1,a:!1}});switch(this.configuration.alphaMode){case 0:return Gh({colorWrite:Wh});case 1:return Gh({blending:qh(770,1,771,771),colorWrite:Wh});default:return Gh({blending:Uh(1,771),colorWrite:Wh})}}}yD.shader=new $a(vD,(()=>import("./p-4c3e469f.js")));class wD extends Qa{constructor(){super(...arguments),this.function=0,this.alphaMode=0,this.hasOpacityFactor=!1}}r([Za({count:4})],wD.prototype,"function",void 0),r([Za({count:3})],wD.prototype,"alphaMode",void 0),r([Za()],wD.prototype,"hasOpacityFactor",void 0);class xD{constructor(t,e){this._rctx=t,this._techniqueRepository=e}dispose(){this._vao=Q(this._vao)}compositeTransparent(t,e,i,s=1){const n=this._rctx;bD.alphaMode=1,bD.function=2,bD.hasOpacityFactor=1!==s;const r=this._techniqueRepository.acquire(yD,bD);n.useProgram(r.program),r.bindPipelineState(n),r.program.bindTexture(t,"colorTexture"),r.program.bindTexture(e,"alphaTexture"),r.program.bindTexture(i,"frontFaceTexture");const o=this.ensureVAO();n.bindVAO(o),n.drawArrays(5,0,ul(o,"geometry")),r.release()}composite(t,e=0,i=1,s=0,n=0){const r=this._rctx;bD.alphaMode=e,bD.function=s,bD.hasOpacityFactor=1!==i;const o=this._techniqueRepository.acquire(yD,bD);r.useProgram(o.program),o.bindPipelineState(r),o.program.bindTexture(t,"tex"),bD.hasOpacityFactor&&o.program.setUniform1f("opacity",i),3===s&&o.program.setUniform1i("overlayIdx",n);const a=this.ensureVAO();r.bindVAO(a),r.drawArrays(5,0,ul(a,"geometry")),o.release()}ensureVAO(){return w(this._vao)&&(this._vao=Ja(this._rctx)),this._vao}}const bD=new wD;function CD(t,e,i){return Wc(e,t)*(i[1]-i[0])+i[0]}function MD(t,e,i){if(!i.isVisible)return;if(!vr(e.frustum,i.boundingVolumeWorldSpace.bounds))return;const s=i.transformation,n=_D;i.geometryRecords.forEach((i=>{oo(n,s,i.getShaderTransformation());const r=rn(n);SD(t,e,i.geometry.boundingInfo,n,r)}))}function SD(t,e,i,s,n){if(w(i))return;const r=e.eye,o=e.viewForward;os(AD,i.center,s);const a=o[0]*(AD[0]-r[0])+o[1]*(AD[1]-r[1])+o[2]*(AD[2]-r[2]);if(AD[3]=i.radius*n,!(a-AD[3]>t.near&&a+AD[3]<t.far)&&vr(e.frustum,AD))if(i.radius>100&&i.getChildren()){const r=i.getChildren();for(let i=0;i<8;++i)r[i]&&SD(t,e,r[i],s,n)}else FD.unionDepthRangeWithAABB(t,e.viewProjectionMatrix,s,i.bbMin,i.bbMax)}function PD(t,e,i){const s=e.eye,n=e.viewForward,r=(i[0]-s[0])*n[0]+(i[1]-s[1])*n[1]+(i[2]-s[2])*n[2];t.near=Math.min(t.near,r-i[3]),t.far=Math.max(t.far,r+i[3])}const TD=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],AD=Uo(),_D=gn(),DD=p_(),OD=new class{constructor(){this._items=new pt({allocator:t=>t||{obj:null,distance:0,near:0,far:0},deallocator:t=>(t.obj=null,t.distance=0,t.near=0,t.far=0,t)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(t){this._items.pushNew().obj=t}sort(t){const e=t.eye,i=t.viewForward;this._items.forAll((t=>{const s=t.obj.boundingVolumeWorldSpace.bounds,n=(s[0]-e[0])*i[0]+(s[1]-e[1])*i[1]+(s[2]-e[2])*i[2];t.distance=n,t.near=n-s[3],t.far=n+s[3]})),this._items.sort(((t,e)=>t.distance-e.distance))}forEachInDepthRange(t,e,i){if(1===e)for(let e=0;e<this._items.length;++e){const s=this._items.data[e];s.far<t.near||s.near>t.far||i(s.obj,s.near,s.far)}else for(let e=this._items.length-1;e>=0;--e){const s=this._items.data[e];s.far<t.near||s.near>t.far||i(s.obj,s.near,s.far)}}},RD=new class{constructor(){this.view=gn(),this.viewProj=gn(),this.frustum=pr(),this.geometries=[],this.near=[],this.far=[],this.nearCandidates=[],this.farCandidates=[],this.range={near:0,far:0},this.looseRange={near:0,far:0}}compute(t,e){this.reset(),io(this.view,t.viewMatrix),oo(this.viewProj,t.projectionMatrix,this.view),Or(t.frustum,this.frustum);const i=this.view,s=i[2],n=i[6],r=i[10],o=i[14],a=this.range;let h=0;if(e.forEach((t=>{if(!t.instanceParameters.visible)return;if(!t.castShadow)return;let e;t.hasShaderTransformation?(t.computeBoundingSphere(t.getShaderTransformation(),AD,1),e=AD):e=t.boundingSphere;const i=s*e[0]+n*e[1]+r*e[2]+o,a=i-e[3],l=i+e[3];this.geometries[h]=t,this.near[h]=-l,this.far[h]=-a,++h})),0===this.geometries.length)return a;for(let t=0;t<this.geometries.length;++t)this.near[t]>a.far&&(a.far=this.near[t]),this.near[t]>2&&this.far[t]<a.near&&(a.near=this.far[t]);const l=this.looseRange;l.near=Math.max(.5*a.near,2),l.far=2*a.far;let c=0,u=0;for(let t=0;t<this.geometries.length;++t)this.near[t]<a.near&&(this.near[t]>=l.near?a.near=this.near[t]:this.nearCandidates[c++]=t),this.far[t]>a.far&&(this.far[t]<=l.far?a.far=this.far[t]:this.farCandidates[u++]=t);if(0===this.nearCandidates.length&&0===this.farCandidates.length)return a;this.nearCandidates.sort(((t,e)=>this.near[t]<this.near[e]?-1:this.near[t]>this.near[e]?1:0)),this.farCandidates.sort(((t,e)=>this.far[t]<this.far[e]?1:this.far[t]>this.far[e]?-1:0));for(let t=0;t<this.nearCandidates.length;++t){const e=this.nearCandidates[t];if(this.near[e]<a.near){const t=this.geometries[e];this.includeNearBoundingInfoRec(t.boundingInfo,t.getShaderTransformation())}}for(let t=0;t<this.farCandidates.length;++t){const e=this.farCandidates[t];if(this.far[e]>a.far){const t=this.geometries[e];this.includeFarBoundingInfoRec(t.boundingInfo,t.getShaderTransformation())}}return a}reset(){this.geometries.length=0,this.near.length=0,this.far.length=0,this.nearCandidates.length=0,this.farCandidates.length=0,this.range.near=Number.MAX_VALUE,this.range.far=-Number.MAX_VALUE}includeNearBoundingInfoRec(t,e){if(w(t))return;const i=t.getCenter();os(AD,i,e);const s=rn(e),n=AD[0],r=AD[1],o=AD[2],a=t.getBSRadius()*s,h=this.frustum;if(h[0][0]*n+h[0][1]*r+h[0][2]*o+h[0][3]>a||h[1][0]*n+h[1][1]*r+h[1][2]*o+h[1][3]>a||h[2][0]*n+h[2][1]*r+h[2][2]*o+h[2][3]>a||h[3][0]*n+h[3][1]*r+h[3][2]*o+h[3][3]>a)return;const l=this.view[2]*n+this.view[6]*r+this.view[10]*o+this.view[14],c=l+a;if(!(-(l-a)<2||-c>=this.range.near))if(-c>this.looseRange.near)this.range.near=-c;else{if(a>100){const i=t.getChildren();if(void 0!==i){for(let t=0;t<8;++t)void 0!==i[t]&&this.includeNearBoundingInfoRec(i[t],e);return}}FD.unionDepthRangeWithAABB(this.range,this.viewProj,e,t.getBBMin(),t.getBBMax())}}includeFarBoundingInfoRec(t,e){if(w(t))return;let i=t.getBSRadius();const s=t.getCenter();os(AD,s,e);const n=rn(e),r=AD[0],o=AD[1],a=AD[2];i*=n;const h=this.frustum;if(h[0][0]*r+h[0][1]*o+h[0][2]*a+h[0][3]>i||h[1][0]*r+h[1][1]*o+h[1][2]*a+h[1][3]>i||h[2][0]*r+h[2][1]*o+h[2][2]*a+h[2][3]>i||h[3][0]*r+h[3][1]*o+h[3][2]*a+h[3][3]>i)return;const l=this.view[2]*r+this.view[6]*o+this.view[10]*a+this.view[14]-i;if(!(-l<=this.range.far))if(-l<this.looseRange.far)this.range.far=-l;else{if(i>100){const i=t.getChildren();if(void 0!==i){for(let t=0;t<8;++t)void 0!==i[t]&&this.includeFarBoundingInfoRec(i[t],e);return}}FD.unionDepthRangeWithAABB(this.range,this.viewProj,e,t.getBBMin(),t.getBBMax())}}},FD=new class{constructor(){this.modelViewProj=gn(),this.clipPosition=[sa(),sa(),sa(),sa(),sa(),sa(),sa(),sa()]}unionDepthRangeWithAABB(t,e,i,s,n){const r=this.modelViewProj;oo(r,e,i);let o=!1;for(let t=0;t<8;++t){const e=this.clipPosition[t],i=0===t||3===t||4===t||7===t?s[0]:n[0],o=0===t||1===t||4===t||5===t?s[1]:n[1],a=t<4?s[2]:n[2];e[0]=r[0]*i+r[4]*o+r[8]*a+r[12],e[1]=r[1]*i+r[5]*o+r[9]*a+r[13],e[2]=r[2]*i+r[6]*o+r[10]*a+r[14],e[3]=r[3]*i+r[7]*o+r[11]*a+r[15]}for(let e=0;e<12;++e){const i=this.clipTriangle(this.clipPosition[TD[e][0]],this.clipPosition[TD[e][1]],this.clipPosition[TD[e][2]]);let s=!0;for(let t=0;t<i.length;++t)if(i[t][3]>=2){s=!1;break}if(!s){o=!0;for(let e=0;e<i.length;++e){const s=i[e][3];s<t.near&&(t.near=s),s>t.far&&(t.far=s)}}}return o}inside(t,e){return 0===e?t[0]>=-t[3]:1===e?t[1]>=-t[3]:2===e?t[0]<=t[3]:3===e?t[1]<=t[3]:void xl(!1)}intersect(t,e,i){let s=0;return 0===i?s=(-t[3]-t[0])/(e[0]-t[0]+e[3]-t[3]):1===i?s=(-t[3]-t[1])/(e[1]-t[1]+e[3]-t[3]):2===i?s=(t[3]-t[0])/(e[0]-t[0]-e[3]+t[3]):3===i&&(s=(t[3]-t[1])/(e[1]-t[1]-e[3]+t[3])),Is(sa(),t,e,s)}clipTriangle(t,e,i){let s=[t,e,i];for(let t=0;t<4;++t){const e=s;s=[];for(let i=0;i<e.length;++i){const n=e[i],r=e[(i+1)%e.length];this.inside(r,t)?(this.inside(n,t)||s.push(this.intersect(n,r,t)),s.push(r)):this.inside(n,t)&&s.push(this.intersect(n,r,t))}}return s}};let zD=class extends T{constructor(){super(...arguments),this._handles=new E,this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this.events=new G,this.attributeLocations=new Map([["position",0]]),this.tmpScreenPoint=Co(),this.tmpRenderPoint=Ao()}get updating(){return w(this._imageSources)&&p(this._imageLoadTask)&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(t){if(t===this._magnifier)return;this._handles.removeAll(),this._magnifier=t;const e=()=>{this.updateResourceLoading(),this.events.emit("request-render")};p(this._magnifier)&&this._handles.add(this._magnifier.watch("version",e)),e()}get enabled(){return p(this._validMagnifier)}get _validMagnifier(){return p(this._magnifier)&&this._magnifier.visible&&p(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}get factor(){return p(this._magnifier)&&this._magnifier.factor||1}dispose(){this._magnifier=null,this._handles.destroy(),p(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this.disposeResources()}render(t,e){const i=this._validMagnifier;if(w(i))return;const s=e.camera.pixelRatio,n=Math.ceil(s*i.size);if(this.updateResources(t,n),w(this._resources))return;const r=this._resources.program;t.useProgram(r);const o=this._resources.textures,a=Math.ceil(1/this.factor*n);o.input.resize(a,a);const h=e.camera.fullWidth,l=e.camera.fullHeight;Mo(i.position,this.tmpScreenPoint);const c=e.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint),u=.5*a,d=.5*a;c[0]=fs(c[0],u,h-u-1),c[1]=fs(c[1],d,l-d-1);const p=Math.floor(c[0]-u),f=Math.floor(c[1]-d);r.bindTexture(o.input,"textureInput"),t.gl.copyTexImage2D(o.input.descriptor.target,0,o.input.descriptor.pixelFormat,p,f,a,a,0);const g=(c[0]+i.offset.x*s)/h*2-1,m=(c[1]-i.offset.y*s)/l*2-1,v=n/h*2,y=n/l*2;t.bindVAO(this._resources.vao),r.bindTexture(o.overlay,"textureOverlay"),r.bindTexture(o.mask,"textureMask"),r.setUniform4f("drawPosition",g,m,v,y),r.setUniform1i("maskEnabled",i.maskEnabled?1:0),r.setUniform1i("overlayEnabled",i.overlayEnabled?1:0),t.setPipelineState(this._resources.pipelineState),t.drawArrays(5,0,4)}updateResourceLoading(){const t=this._validMagnifier;if(w(t))return;const e=t.maskUrl,i=t.overlayUrl;!p(this._imageLoadTask)||this._imageLoadTask.maskUrl===e&&this._imageLoadTask.overlayUrl===i||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),p(this._imageSources)||p(this._imageLoadTask)||(this._imageLoadTask={maskUrl:e,overlayUrl:i,task:et((async t=>{const s=w(e)||w(i)?oc(t):null,n=p(e)?Zh(e,{signal:t}):s.then((t=>t.mask)),r=p(i)?Zh(i,{signal:t}):s.then((t=>t.overlay));this._imageSources={mask:await n,overlay:await r},this.disposeResources(),this.events.emit("request-render")}))},this._imageLoadTask.task.promise.then((()=>this.notifyChange("updating")),(()=>this.notifyChange("updating"))))}updateResources(t,e){if(!this.enabled)return void this.disposeResources();if(p(this._resources)){if(this._resources.textures.size!==e){const i=this.createTextureResources(t,e);if(w(i))return void this.disposeResources();this.disposeTextureResources(this._resources.textures),this._resources.textures=i}return}const i=this.createTextureResources(t,e);w(i)||(this._resources={textures:i,program:this.createProgram(t),vao:Ja(t,Ih,this.attributeLocations,0,1),pipelineState:Gh({blending:Uh(1,771),depthTest:null,depthWrite:null,colorWrite:Wh})})}disposeResources(){w(this._resources)||(this.disposeTextureResources(this._resources.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}disposeTextureResources(t){t.mask.dispose(),t.overlay.dispose(),t.input.dispose()}createTextureResources(t,e){if(w(this._imageSources))return null;this._imageSources.overlay.width=e,this._imageSources.overlay.height=e,this._imageSources.mask.width=e,this._imageSources.mask.height=e;const i=new ml(t,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0,preMultiplyAlpha:!Tt(this._imageSources.overlay.src)||!t.driverTest.svgAlwaysPremultipliesAlpha},this._imageSources.overlay),s=new ml(t,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},this._imageSources.mask);return{input:new ml(t,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1}),mask:s,overlay:i,size:e}}createProgram(t){const e=function(){const t=new Wa;return t.attributes.add("position","vec2"),t.vertex.uniforms.add("proj","mat4"),t.vertex.uniforms.add("drawPosition","vec4"),t.varyings.add("vUV","vec2"),t.vertex.code.add(Ua`void main(void) {
vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);
}`),t.fragment.uniforms.add("textureInput","sampler2D"),t.fragment.uniforms.add("textureMask","sampler2D"),t.fragment.uniforms.add("textureOverlay","sampler2D"),t.fragment.uniforms.add("maskEnabled","bool"),t.fragment.uniforms.add("overlayEnabled","bool"),t.fragment.code.add(Ua`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}
void main() {
float mask = maskEnabled ? texture2D(textureMask, vUV).a : 1.0;
vec4 inputColor = texture2D(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture2D(textureOverlay, vUV) : vec4(0);
gl_FragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;
}`),t}();return new Xa(t,e,this.attributeLocations)}};r([o()],zD.prototype,"_imageSources",void 0),r([o()],zD.prototype,"_imageLoadTask",void 0),r([o({readOnly:!0})],zD.prototype,"updating",null),zD=r([a("esri/views/3d/webgl-engine/lib/MagnifierHelper")],zD);class LD{constructor(){this.viewTransform=new Ea.ViewProjectionTransform,this.slicePlane=Ro()}}class ED extends LD{constructor(){super(...arguments),this.identifier=0,this.slicePlaneEnabled=!0,this.transparent=!1,this.integratedMesh=!1,this.transformNormal_ViewFromGlobal=pn(),this.cameraNearFar=Sa(),this.inverseViewport=Sa(),this.ambientOcclusionEnabled=!0,this.shadowsEnabled=!0,this.sceneHasOcludees=!1,this.transparencyPassType=3}}class ID extends LD{constructor(){super(...arguments),this.identifier=1,this.cameraNearFar=Sa()}}class VD extends LD{constructor(){super(...arguments),this.identifier=2,this.inverseViewport=Sa(),this.viewport=sa()}}class jD{constructor(t,e,i=0){this._rctx=t,this._techniqueRepository=e,this._sorting=i,this._draws=new pt({initialSize:32,allocator:t=>t||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._passBoundTechniques=new Set,this._previouslyBoundMaterials=new Map,this._previouslyBoundDraw=new Map}submitDraw(t,e,i,s,n){const r=this._draws.pushNew();r.geometry=e,r.geometryRanges=i,r.material=t,r.bindDrawParams=s,r.depthSquaredHint=n,r.indexType=e.indexed?P(e.vao.indexBuffer).indexType:0}dispatch(t){const e=this._rctx;this._passBoundTechniques.clear(),this._previouslyBoundMaterials.clear(),this._previouslyBoundDraw.clear();let i=null;const s=this._draws.length;for(let n=0;n<s;n++){const s=this._draws.data[n],r=s.geometry,o=s.material.getTechnique(this._techniqueRepository,t,r.parameters);o===i&&3===o.configuration.transparencyPassType||(e.useProgram(o.program),o.bindPipelineState(e,t.slot),i=o),this._passBoundTechniques.has(o)||(o.bindPass(t),this._passBoundTechniques.add(o)),e.bindVAO(r.vao),this._previouslyBoundMaterials.get(o)!==s.material&&(o.bindMaterial(s.material,t),this._previouslyBoundMaterials.set(o,s.material)),this._previouslyBoundDraw.get(o)!==s.bindDrawParams&&(o.bindDraw(s.bindDrawParams),this._previouslyBoundDraw.set(o,s.bindDrawParams));const a=s.geometryRanges,h=a.length;if(0!==s.indexType){const t=ND.get(s.indexType);for(let i=0;i<h;i+=2)e.drawElements(r.primitiveType,a[i+1],s.indexType,a[i]*t)}else for(let t=0;t<h;t+=2)e.drawArrays(r.primitiveType,a[t],a[t+1])}return s>0}prepareSubmit(){this._draws.clear()}finishSubmit(){const t=0===this._sorting?1:-1;this._draws.sort(((e,i)=>{const s=t*(e.depthSquaredHint-i.depthSquaredHint);return 0!==s?s:e.geometry.vao.size-i.geometry.vao.size}))}get count(){return this._draws.length}}const ND=new Map;ND.set(5121,1),ND.set(5123,2),ND.set(5125,4);class kD{constructor(t,e){this.rctx=t,this.shaderTechniqueRepository=e,this.canRender=!0,this._materialPassParams=new ED,this._shadowPassParams=new ID,this._highlightPassParams=new VD,this._systems=new Set,this._passes={materialOpaque:new jD(t,this.shaderTechniqueRepository),materialTransparent:new jD(t,this.shaderTechniqueRepository,1),materialIntegratedMesh:new jD(t,this.shaderTechniqueRepository),shadowMap:new jD(t,this.shaderTechniqueRepository),highlight:new jD(t,this.shaderTechniqueRepository),highlightIntegratedMesh:new jD(t,this.shaderTechniqueRepository),highlightShadowMap:new jD(t,this.shaderTechniqueRepository),defaultShadowMap:new jD(t,this.shaderTechniqueRepository)}}register(t){this._systems.add(t)}prepareRender(t){if(0!==this._systems.size){for(const t of Object.values(this._passes))t.prepareSubmit();this._systems.forEach((e=>e.submit(this._passes,{camera:t})));for(const t of Object.values(this._passes))t.finishSubmit();this.shaderTechniqueRepository.frameUpdate()}}render(t){if(0===this._systems.size)return!1;switch(this._configure(t),t.slot){case 3:switch(t.pass){case 0:return this._materialPassParams.subPass=0,this._configureMaterialColorPass(t),this._passes.materialOpaque.dispatch(this._materialPassParams);case 2:return this._materialPassParams.subPass=2,this._passes.materialOpaque.dispatch(this._materialPassParams);case 3:return this._materialPassParams.subPass=3,this._passes.materialOpaque.dispatch(this._materialPassParams);case 5:return this._passes.highlight.dispatch(this._highlightPassParams);case 4:return this._passes.shadowMap.dispatch(this._shadowPassParams);case 7:return this._passes.highlightShadowMap.dispatch(this._shadowPassParams);case 6:return this._passes.defaultShadowMap.dispatch(this._shadowPassParams)}return!1;case 5:switch(t.pass){case 0:return this._materialPassParams.subPass=0,this._configureMaterialColorPass(t),this._passes.materialTransparent.dispatch(this._materialPassParams);case 1:return this._materialPassParams.subPass=1,this._configureMaterialColorPass(t),this._passes.materialTransparent.dispatch(this._materialPassParams);case 2:return this._materialPassParams.subPass=2,this._passes.materialTransparent.dispatch(this._materialPassParams);case 3:return this._materialPassParams.subPass=3,this._passes.materialTransparent.dispatch(this._materialPassParams)}return!1;case 0:switch(t.pass){case 0:return this._materialPassParams.subPass=0,this._configureMaterialColorPass(t),this._materialPassParams.ssrParams=t.ssrParams,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);case 2:return this._materialPassParams.subPass=2,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);case 3:return this._materialPassParams.subPass=3,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);case 5:return this._passes.highlightIntegratedMesh.dispatch(this._highlightPassParams)}return!1}return!1}notifyDirty(){this._context.requestRender()}slots(){return[3,5,0]}initializeRenderContext(t){this._context=t}uninitializeRenderContext(){}queryDepthRange(t){const e={near:1/0,far:-1/0};return this._systems.forEach((i=>{const s=i.queryShadowCasterDepthRange(t);p(s)&&g_(e,s,e)})),e}get shadowCastingEnabled(){return this._materialPassParams.shadowsEnabled}set shadowCastingEnabled(t){this._materialPassParams.shadowsEnabled=t}get screenSpaceReflectionsEnabled(){return p(this._materialPassParams.ssrParams.ssrEnabled)}set screenSpaceReflectionsEnabled(t){this._materialPassParams.ssrParams.ssrEnabled=!!t}_configureMaterialColorPass(t){this._materialPassParams.bindShadowMap=e=>{t.shadowMap.bind(e);const i=this._materialPassParams.viewTransform;Ki(BD,i.worldFromView_TL,i.worldFromView_TH),t.shadowMap.bindView(e,BD)},this._materialPassParams.bindAmbientOcclusion=e=>t.ssaoHelper.bind(e,t.camera),this._materialPassParams.ambientOcclusionEnabled=!!t.ssaoHelper&&t.ssaoHelper.ready,this._materialPassParams.sceneHasOcludees=t.hasOccludees}_configure(t){this._updateParameters(t,4===t.pass||7===t.pass||6===t.pass?this._shadowPassParams:5===t.pass?this._highlightPassParams:this._materialPassParams)}_updateParameters(t,e){const i=t.camera,s=i.viewInverseTransposeMatrix;ds(BD,s[3],s[7],s[11]),qD.set(BD),$i(e.viewTransform.worldFromView_TH,qD.high),$i(e.viewTransform.worldFromView_TL,qD.low),an(e.viewTransform.viewFromCameraRelative_RS,i.viewMatrix),io(e.viewTransform.projFromView,i.projectionMatrix),0===e.identifier?(this._materialPassParams.transparent=5===t.slot,this._materialPassParams.integratedMesh=0===t.slot,this._materialPassParams.lighting=t.scenelightingData,hn(GD,e.viewTransform.viewFromCameraRelative_RS),un(e.transformNormal_ViewFromGlobal,GD),pa(e.cameraNearFar,i.near,i.far)):1===e.identifier?pa(e.cameraNearFar,i.near,i.far):2===e.identifier&&(e.highlightDepthTexture=t.highlightDepthTexture,As(e.viewport,i.fullViewport)),0!==e.identifier&&2!==e.identifier||(e.inverseViewport[0]=1/i.fullViewport[2],e.inverseViewport[1]=1/i.fullViewport[3]),Lo(t.sliceHelper.plane,e.slicePlane),ts(e.slicePlane.origin,e.slicePlane.origin,BD),e.slicePlaneEnabled=t.sliceHelper.isEnabled,this._materialPassParams.slot=t.slot,this._materialPassParams.transparencyPassType=t.transparencyPassType,this._materialPassParams.multipassTerrainParams=t.multipassTerrainParams}get needsHighlight(){return this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0}}const BD=js(),GD=pn(),qD=new sD;function WD(t){const e=new Wa,i=e.vertex.code,s=e.fragment.code;return e.attributes.add("position","vec2"),2===t.highlightStage&&(i.add(Ua`void main() {
gl_Position = vec4(vec2(1.0) - position * 2.0, 0.0, 1.0);
}`),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("invFramebufferDim","vec2"),s.add(Ua`void main() {
vec2 coord = gl_FragCoord.xy * invFramebufferDim;
vec4 value = texture2D(tex, coord);
float mx = floor(max(value.g, value.b));
gl_FragColor = vec4(ceil(value.r), mx, mx, 1.0);
}`)),0===t.highlightStage&&(e.attributes.add("uv0","vec2"),t.gridOptimization?(e.vertex.uniforms.add("coverageTex","sampler2D"),e.fragment.uniforms.add("blurSize","vec2"),e.varyings.add("blurCoordinate","vec3")):(e.vertex.uniforms.add("blurSize","vec2"),e.varyings.add("blurCoordinates[5]","vec2")),i.add(Ua`
    void main() {
      gl_Position = vec4(position, 0.0, 1.0);
      ${t.gridOptimization?Ua`
      vec4 cov = texture2D(coverageTex, uv0);
      if (cov.r == 0.0) {
        gl_Position = vec4(0.0);
      }
      blurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), max(cov.g, cov.b));
      `:Ua`
      vec2 uv = position.xy * 0.5 + vec2(0.5);
      blurCoordinates[0] = uv;
      blurCoordinates[1] = uv + blurSize * 1.407333;
      blurCoordinates[2] = uv - blurSize * 1.407333;
      blurCoordinates[3] = uv + blurSize * 3.294215;
      blurCoordinates[4] = uv - blurSize * 3.294215;
          `}
    }`),e.fragment.uniforms.add("tex","sampler2D"),s.add(Ua`
    void main() {
      ${t.gridOptimization?Ua`
          vec2 uv = blurCoordinate.xy;
          vec4 center = texture2D(tex, uv);

          // do not blur if no pixel or all pixels in neighborhood are set
          if (blurCoordinate.z == 1.0) {
            gl_FragColor = center;
          } else {
            vec4 sum = vec4(0.0);
            sum += center * 0.204164;
            sum += texture2D(tex, uv + blurSize * 1.407333) * 0.304005;
            sum += texture2D(tex, uv - blurSize * 1.407333) * 0.304005;
            sum += texture2D(tex, uv + blurSize * 3.294215) * 0.093913;
            sum += texture2D(tex, uv - blurSize * 3.294215) * 0.093913;
            gl_FragColor = sum;
          }`:Ua`
          vec4 sum = vec4(0.0);
          sum += texture2D(tex, blurCoordinates[0]) * 0.204164;
          sum += texture2D(tex, blurCoordinates[1]) * 0.304005;
          sum += texture2D(tex, blurCoordinates[2]) * 0.304005;
          sum += texture2D(tex, blurCoordinates[3]) * 0.093913;
          sum += texture2D(tex, blurCoordinates[4]) * 0.093913;
          gl_FragColor = sum;`}
    }`)),1===t.highlightStage&&(e.varyings.add("uv","vec2"),t.gridOptimization&&(e.attributes.add("uv0","vec2"),e.vertex.uniforms.add("coverageTex","sampler2D")),i.add(Ua`
      void main() {
        ${t.gridOptimization?Ua`
            vec4 cov = texture2D(coverageTex, uv0);
            // if no highlight pixel set in this block, hide block
            if (cov.r == 0.0) {
              gl_Position = vec4(0.0);
              return;
            }`:""}
        gl_Position = vec4(position, 0.0, 1.0);
        uv = position.xy * 0.5 + vec2(0.5);
      }`),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("origin","sampler2D"),e.fragment.uniforms.add("color","vec4"),e.fragment.uniforms.add("haloColor","vec4"),e.fragment.uniforms.add("outlineSize","float"),e.fragment.uniforms.add("blurSize","float"),e.fragment.uniforms.add("opacities","vec4"),s.add(Ua`void main() {
vec4 blurredHighlightValue = texture2D(tex, uv);
float highlightIntensity = blurredHighlightValue.a;
if (highlightIntensity == 0.0) {
discard;
}
vec4 origin_color = texture2D(origin, uv);
float outlineIntensity;
float fillIntensity;
if (blurredHighlightValue.g > blurredHighlightValue.b) {
outlineIntensity = haloColor.w * opacities[1];
fillIntensity = color.w * opacities[3];
}
else {
outlineIntensity = haloColor.w * opacities[0];
fillIntensity = color.w * opacities[2];
}
float inner = 1.0 - outlineSize / 9.0;
float outer = 1.0 - (outlineSize + blurSize) / 9.0;
float outlineFactor = smoothstep(outer, inner, highlightIntensity);
float fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;
float intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;
gl_FragColor = vec4(mix(haloColor.rgb, color.rgb, fillFactor), intensity);
}`)),e}const UD=Object.freeze({__proto__:null,build:WD});class HD extends Ya{initializeProgram(t){const e=HD.shader.get().build(this.configuration);return new Xa(t.rctx,e,Ka)}bindApplyPass(t){this.program.setUniform4fv("color",t.color),this.program.setUniform4fv("haloColor",t.haloColor),this.program.setUniform1f("outlineSize",8.6),this.program.setUniform1f("blurSize",.4),this.program.setUniform4f("opacities",t.haloOpacity,t.haloOpacityOccluded,t.fillOpacity,t.fillOpacityOccluded)}initializePipeline(){return Gh(1===this.configuration.highlightStage?{blending:qh(770,1,771,771),colorWrite:Wh}:{colorWrite:Wh})}get primitiveType(){return this.configuration.gridOptimization?4:5}}HD.shader=new $a(UD,(()=>import("./p-52d63d29.js")));class ZD extends Qa{constructor(){super(...arguments),this.highlightStage=0,this.gridOptimization=!1}}r([Za({count:3})],ZD.prototype,"highlightStage",void 0),r([Za()],ZD.prototype,"gridOptimization",void 0);class QD{constructor(t,e){this._techniqueRep=t,this._rctx=e,this.viewportToRestore=sa(),this.defaultOptions={color:vc(1,0,1,1),haloColor:vc(1,0,1,1),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05,shadowColor:vc(1,0,1,1),shadowOpacity:.15,occludedShadowOpacity:.075},this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0}}assertResources(){if(this.quadVAO)return;this.quadVAO=Ja(this._rctx);const t={colorTarget:0,depthStencilTarget:0,width:0,height:0},e={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this.blur0Fbo=new cl(this._rctx,t,e),this.blur1Fbo=new cl(this._rctx,t,e);const i=new ZD;i.highlightStage=0,i.gridOptimization=!1,this.blurTechnique=this._techniqueRep.acquire(HD,i),i.highlightStage=0,i.gridOptimization=!0,this.blurGridTechnique=this._techniqueRep.acquire(HD,i),i.highlightStage=1,i.gridOptimization=!1,this.applyTechnique=this._techniqueRep.acquire(HD,i),i.highlightStage=1,i.gridOptimization=!0,this.applyGridTechnique=this._techniqueRep.acquire(HD,i),i.highlightStage=2,i.gridOptimization=!1,this.downsampleTechnique=this._techniqueRep.acquire(HD,i)}dispose(){if(this._grid.coverageMipmap)for(let t=1;t<this._grid.coverageMipmap.length;t++)this._grid.coverageMipmap[t].dispose();this._grid.vao&&this._grid.vao.dispose(!0),this.quadVAO&&(this.quadVAO.dispose(!0),this.quadVAO=null),this.blur0Fbo=Q(this.blur0Fbo),this.blur1Fbo=Q(this.blur1Fbo)}get profilingCallback(){return lr.HIGHLIGHTS_PROFILE_TO_CONSOLE?t=>console.log(t):null}setDefaultOptions(t){this.defaultOptions=t}render(t,e,i){const s=t.pixelRatio,n=lr.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED,r=this._rctx;this.assertResources(),As(this.viewportToRestore,t.fullViewport);const o=t.fullHeight,a=Math.ceil(t.fullWidth/s),h=Math.ceil(o/s);this.blur0Fbo.resize(a,h),this.blur1Fbo.resize(a,h),r.bindVAO(this.quadVAO);let l=null;const c=n?this.blurGridTechnique:this.blurTechnique;c.bindPipelineState(r),r.useProgram(c.program),n?(this._gridUpdateResources(e,32),this._gridComputeMipmap(),l=this._grid.vao,c.program.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,"coverageTex")):l=this.quadVAO,r.bindVAO(l),r.bindFramebuffer(this.blur0Fbo),r.setViewport(0,0,a,h),r.setClearColor(0,0,0,0),r.clear(16384),c.program.bindTexture(e.colorTexture,"tex"),c.program.setUniform2f("blurSize",1/a,0),r.drawArrays(c.primitiveType,0,ul(l,"geometry")),r.bindFramebuffer(this.blur1Fbo),r.clear(16384),c.program.bindTexture(this.blur0Fbo.colorTexture,"tex"),c.program.setUniform2f("blurSize",0,1/h),r.drawArrays(c.primitiveType,0,ul(l,"geometry"));const u=n?this.applyGridTechnique:this.applyTechnique;r.bindFramebuffer(i),u.bindPipelineState(r),r.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]),r.useProgram(u.program),u.program.bindTexture(this.blur1Fbo.colorTexture,"tex"),u.program.bindTexture(e.colorTexture,"origin"),n&&u.program.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,"coverageTex"),u.bindApplyPass(this.defaultOptions),r.drawArrays(u.primitiveType,0,ul(l,"geometry")),r.bindVAO(null)}_gridUpdateResources(t,e){const i=this._rctx,s=this._grid;let n=!1;if(null===s.coverageMipmap&&(s.coverageMipmap=[t],n=!0),s.viewportWidth===t.width&&s.viewportHeight===t.height||(n=!0,s.viewportWidth=t.width,s.viewportHeight=t.height),s.coverageMipmap[0]=t,s.cellPixelSize!==e&&(s.cellPixelSize=e,n=!0),n){for(let t=1;t<s.coverageMipmap.length;t++)s.coverageMipmap[t].dispose();s.mipmapLevels=Math.ceil(Math.log(s.cellPixelSize)*Math.LOG2E),s.coverageMipmap.length=s.mipmapLevels+1;for(let t=0;t<s.mipmapLevels;t++){const e=s.coverageMipmap[t],n={target:3553,pixelFormat:6407,dataType:33635,samplingMode:9729,wrapMode:33071,width:Math.ceil(e.width/2),height:Math.ceil(e.height/2)},r={colorTarget:0,depthStencilTarget:0,width:Math.ceil(e.width/2),height:Math.ceil(e.height/2)};s.coverageMipmap[t+1]=new cl(i,r,n)}}const r=Math.ceil(t.height/s.cellPixelSize),o=Math.ceil(t.width/s.cellPixelSize);if(!s.vao||s.verticalCellCount!==r||s.horizontalCellCount!==o){s.verticalCellCount=r,s.horizontalCellCount=o;const t=r+1,e=o+1,n=1/r,a=1/o,h=6,l=4,c=new Float32Array(h*l*t*e);let u=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++)c[u+0]=(t-.5)*a*2-1,c[u+1]=(i-.5)*n*2-1,c[u+2]=t*a,c[u+3]=i*n,c[u+4]=(t+.5)*a*2-1,c[u+5]=(i-.5)*n*2-1,c[u+6]=t*a,c[u+7]=i*n,c[u+8]=(t-.5)*a*2-1,c[u+9]=(i+.5)*n*2-1,c[u+10]=t*a,c[u+11]=i*n,c[u+12]=(t-.5)*a*2-1,c[u+13]=(i+.5)*n*2-1,c[u+14]=t*a,c[u+15]=i*n,c[u+16]=(t+.5)*a*2-1,c[u+17]=(i-.5)*n*2-1,c[u+18]=t*a,c[u+19]=i*n,c[u+20]=(t+.5)*a*2-1,c[u+21]=(i+.5)*n*2-1,c[u+22]=t*a,c[u+23]=i*n,u+=h*l;s.vao&&s.vao.dispose(!0),s.vao=new dl(i,Ka,{geometry:th},{geometry:pl.createVertex(i,35044,c)})}}_gridComputeMipmap(){const t=this._rctx,e=this._grid,i=this.downsampleTechnique.program;this.downsampleTechnique.bindPipelineState(t),t.bindVAO(this.quadVAO),t.useProgram(i);for(let s=0;s<e.mipmapLevels;s++){t.bindFramebuffer(e.coverageMipmap[s+1]),i.bindTexture(e.coverageMipmap[s].colorTexture,"tex");const n=e.coverageMipmap[s+1].width,r=e.coverageMipmap[s+1].height;i.setUniform2f("invFramebufferDim",1/n,1/r),t.setViewport(0,0,n,r),t.drawArrays(5,0,ul(this.quadVAO,"geometry"))}}get gpuMemoryUsage(){let t=(p(this.blur0Fbo)?this.blur0Fbo.gpuMemoryUsage:0)+(p(this.blur1Fbo)?this.blur1Fbo.gpuMemoryUsage:0);if(this._grid.coverageMipmap)for(const e of this._grid.coverageMipmap)t+=e.gpuMemoryUsage;return t}get test(){return{coverage:this._grid.coverageMipmap,blur:[this.blur0Fbo,this.blur1Fbo]}}}const YD={dataType:5121,internalFormat:6408},XD={};class KD{constructor(t){this.rctx=t,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this.depthTextureSupported=t.capabilities.depthTexture}dispose(){this._depthBuffers.forEach((t=>t.dispose())),this._depthBuffers.clear(),this._depthTextures.forEach((t=>t.dispose())),this._depthTextures.clear(),this._colorTextures.forEach((t=>t.dispose())),this._colorTextures.clear(),this._framebuffers.forEach((t=>t.dispose())),this._framebuffers.clear()}disposeTargetResource(t){const e=t.id;this._activeTargets.has(e)&&(this._activeTargets.delete(e),this.disposeWithFramebuffers(this._depthTextures,e),this.disposeWithFramebuffers(this._depthBuffers,e),this.disposeWithFramebuffers(this._colorTextures,e))}disposeWithFramebuffers(t,e){const i=t.get(e);i&&(this._framebuffers.forEach(((t,e)=>{t.colorAttachment!==i&&t.depthStencilAttachment!==i||(t.detachAll(),t.dispose(),this._framebuffers.delete(e))})),i.dispose(),t.delete(e))}getDepthTexture(t,e){if(!this.depthTextureSupported)return null;let i=this._depthTextures.get(t.id);return!i||i.descriptor.width===e.width&&i.descriptor.height===e.height||(i.dispose(),i=null),i||(i=new ml(this.rctx,{target:3553,pixelFormat:34041,dataType:34042,samplingMode:9728,wrapMode:33071,width:e.width,height:e.height}),this._depthTextures.set(t.id,i),this._activeTargets.add(t.id)),i}getAllocatedDepthTexture(t){return this._depthTextures.get(t.id)}getDepthBuffer(t,e){if(this.depthTextureSupported)return null;let i=this._depthBuffers.get(t.id);return i?i.descriptor.width===e.width&&i.descriptor.height===e.height||i.resize(e.width,e.height):(i=new gl(this.rctx,{internalFormat:34041,...e}),this._depthBuffers.set(t.id,i),this._activeTargets.add(t.id)),i}getColorTexture(t,e){let i=this._colorTextures.get(t.id);return i&&(i.descriptor.width===e.width&&i.descriptor.height===e.height||(i.dispose(),i=null)),i||(i=new ml(this.rctx,{target:3553,pixelFormat:6408,internalFormat:t.internalFormat,dataType:t.dataType,samplingMode:null!=t.samplingMode?t.samplingMode:9729,wrapMode:33071,width:e.width,height:e.height}),this._colorTextures.set(t.id,i),this._activeTargets.add(t.id)),i}getAllocatedColorTexture(t){return this._colorTextures.get(t.id)}registerDepthTarget(t={}){return{id:gt(),...XD,...t}}registerColorTarget(t={}){return{id:gt(),...YD,...t}}getFramebuffer(t,e,i){const s=this.getKey(e,i);let n=this._framebuffers.get(s);const r=this.getColorTexture(e,t);if(this.depthTextureSupported){const e=i?this.getDepthTexture(i,t):void 0;return n?((n.width!==t.width||n.height!==t.height||n.colorTexture!==r||n.depthStencilTexture!==e)&&(n.detachAll(),n.resize(t.width,t.height),n.attachColorTexture(r),n.attachDepthStencilTexture(e)),n):(n=p(i)?new cl(this.rctx,{colorTarget:0,depthStencilTarget:4},r,e):new cl(this.rctx,{colorTarget:0,depthStencilTarget:0},r),this._framebuffers.set(s,n),n)}const o=i?this.getDepthBuffer(i,t):void 0;return n?((n.width!==t.width||n.height!==t.height||n.colorTexture!==r)&&(n.detachAll(),n.resize(t.width,t.height),n.attachColorTexture(r),n.attachDepthStencilBuffer(o)),n):(n=new cl(this.rctx,{colorTarget:0,depthStencilTarget:i?3:0},r,o),this._framebuffers.set(s,n),n)}getKey(t,e){return`${t.id}_${e?e.id:"X"}_${t.name}${e?"_"+e.name:""}`}get gpuMemoryUsage(){let t=0;const e=new Set,i=i=>{e.has(i)||(e.add(i),t+=fl(i))};return this._depthTextures.forEach(i),this._colorTextures.forEach(i),this._depthBuffers.forEach(i),t}}class $D{constructor(t,e){this._rctx=t,this._compositingHelper=e,this._mainColorTarget=0,this._dimensions={width:4,height:4},this._needLastFrameColorTexture=!1,this._background={type:"color",color:[0,0,0,1]};const i="webgl2"===t.webglVersion;this._renderTargetHelper=new KD(t);const s=this._renderTargetHelper;this.mainColorTargets=[s.registerColorTarget({name:"mainColorTarget0"}),s.registerColorTarget({name:"mainColorTarget1"})],this.frontFaceTarget=s.registerColorTarget({name:"frontFaceTarget"});const n=t=>s.registerColorTarget({name:t,dataType:5126,internalFormat:i?34836:6408,samplingMode:9728});this.colorFloatTarget=n("colorFloatTarget"),this.alphaFloatTarget=n("alphaFloatTarget"),this.mainDepth=s.registerDepthTarget({name:"mainDepth"}),this.linearDepth=s.registerColorTarget({name:"linearDepth",samplingMode:9728}),this.terrainLinearDepth=s.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=s.registerColorTarget({name:"geometryLinearDepth"}),this.normal=s.registerColorTarget({name:"normal"}),this.highlight=s.registerColorTarget({name:"highlight",internalFormat:i?32854:6408,dataType:32819}),this.hudVisibility=s.registerColorTarget({name:"hudVisibility",internalFormat:i?32854:6408,dataType:32819}),this.tmpColor=s.registerColorTarget({name:"tmpColor"}),this.tmpDepth=s.registerDepthTarget({name:"tmpDepth"}),this.hudColor=s.registerColorTarget({name:"hudColor"})}dispose(){this._renderTargetHelper.dispose()}get width(){return this._dimensions.width}get height(){return this._dimensions.height}set background(t){this._background=t}get background(){return this._background}get currentColorTarget(){return this.mainColorTargets[this._mainColorTarget]}get previousColorTarget(){return this.mainColorTargets[1-this._mainColorTarget]}get framebuffer(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}getFramebuffer(t,e){return this._renderTargetHelper.getFramebuffer(this._dimensions,t,e)}get colorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}get depthTexture(){return this._renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}get linearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}get terrainLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}get geometryLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}get lastFrameColorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}get normalTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.normal)}get highlightTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.highlight)}get hudVisibilityTexture(){return this.getColorTexture(this.hudVisibility)}get tmpColorTexture(){return this.getColorTexture(this.tmpColor)}get hudColorTexture(){return this.getColorTexture(this.hudColor)}get mainColorTexture(){return this.getColorTexture(this.currentColorTarget)}advanceCurrentRenderTarget(){this._mainColorTarget=0===this._mainColorTarget&&this._needLastFrameColorTexture?1:0}initializeFrame(t){const e=this._rctx;this._dimensions.width=t.fullWidth,this._dimensions.height=t.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),e.setClearStencil(0);const i=this._background.color;e.setClearColor(i[0]*i[3],i[1]*i[3],i[2]*i[3],i[3]),e.clearSafe(17664)}composite(){p(this.colorTexture)&&this._compositingHelper.composite(this.colorTexture,0)}renderTmpAndCompositeToMain(t,e,i=!1){this.renderToTargets(t,this.tmpColor,i?this.tmpDepth:this.mainDepth,JD),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),e)}renderHUDVisibility(t,e=!1){this.renderToTargets(t,this.hudVisibility,e?this.tmpDepth:this.mainDepth,tO)}compositeTransparentTerrainOntoHUDVisibility(){this.renderToTargets((()=>this._compositingHelper.composite(this.getColorTexture(this.tmpColor),0,1,1)),this.hudVisibility,this.tmpDepth)}renderOITPass(t,e,i){let s,n;switch(e){case 0:s=this.colorFloatTarget,n=[0,0,0,0];break;case 1:s=this.alphaFloatTarget,n=[1,1,1,1];break;case 2:s=this.frontFaceTarget,n=[0,0,0,0]}i?this.renderToTargets(t,s,this.tmpDepth,n,!0,!0):this.renderToTargets(t,s,this.mainDepth,n,!1)}compositeTransparentTerrainOntoMain(){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2)}compositeOccludedOntoMain(t){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2,t)}compositeTransparentOntoOpaque(t){t?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(16384)):this.bindFramebuffer(),this._compositingHelper.compositeTransparent(this.getColorTexture(this.colorFloatTarget),this.getColorTexture(this.alphaFloatTarget),this.getColorTexture(this.frontFaceTarget))}bindFramebuffer(){this._rctx.bindFramebuffer(this.framebuffer)}renderDepthDetached(t){this.bindTarget(this.currentColorTarget),t(),this.bindTarget(this.currentColorTarget,this.mainDepth)}disposeTarget(t){this._renderTargetHelper.disposeTargetResource(t)}set needLastFrameColorTexture(t){!t&&this._needLastFrameColorTexture&&(this._mainColorTarget=0,this.disposeTarget(this.mainColorTargets[1])),this._needLastFrameColorTexture=t}get needLastFrameColorTexture(){return this._needLastFrameColorTexture}renderToTargets(t,e,i,s,n=!1,r=!1){const o=this._rctx,a=this.bindTarget(e,i);let h=0;if(s){const t=Math.max(1e-13,s[3]);o.setClearColor(s[0],s[1],s[2],t),h|=16384}return n&&(h|=256),!1===r?r=0:(!0===r&&(r=255),h|=1024),h&&o.clearSafe(h,r),t(),o.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth),a}bindTarget(t,e){const i=this._renderTargetHelper.getFramebuffer(this._dimensions,t,e);return this._rctx.bindFramebuffer(i),i}getColorTexture(t){return this._renderTargetHelper.getColorTexture(t,this._dimensions)}get gpuMemoryUsage(){let t=0;return this._renderTargetHelper&&(t+=this._renderTargetHelper.gpuMemoryUsage),t}}const JD=[0,0,0,0],tO=[0,1,0,1];class eO{constructor(t){this.context=t,this.renderPlugins=new Array,this.slots=[];for(let t=0;t<22;++t)this.slots[t]=[]}add(t,e,i){const s=()=>{this.renderPlugins.push(e);for(const i of t)this.slots[i].push(e);this.context.requestRender()},n=e.initializeRenderContext(this.context,i);if(Bt(n))return n.then(s);s()}remove(t){const e=this.renderPlugins.length;this.renderPlugins=this.renderPlugins.filter((e=>e!==t)),xl(this.renderPlugins.length<e,"Removing non-added render plugin");for(let e=0;e<this.slots.length;++e)this.slots[e]=this.slots[e].filter((e=>e!==t));t.uninitializeRenderContext(),this.context.requestRender()}prepareRender(t,e){for(const i of this.renderPlugins)i.prepareRender&&i.prepareRender(t,e)}render(){const t=this.slots[this.context.renderContext.slot];let e=!1;for(const i of t)i.canRender&&i.render(this.context.renderContext)&&(e=!0);return e}queryDepthRange(t){const e=iO;e.near=1/0,e.far=-1/0;for(const i of this.renderPlugins)if(i.queryDepthRange){const s=i.queryDepthRange(t);s&&g_(e,s,e)}return e}get needsHighlight(){return this.renderPlugins.some((t=>t.needsHighlight))}get needsLinearDepth(){return this.renderPlugins.some((t=>t.needsLinearDepth))}get needsLaserlineWithContrastControl(){const t=this.slots[15];return!!t&&t.length>0}get renderOccludedFlags(){let t=0;return this.renderPlugins.forEach((e=>{e.renderOccludedFlags&&(t|=e.renderOccludedFlags)})),t}}const iO={near:0,far:0},sO=255;function nO(t){const e=new Wa;e.fragment.include(sh),e.fragment.include(Ha),e.include(Jl),e.include(Ir);const{pass:i}=t;if(1===i){const{visualization:i,bandsEnabled:s}=t;e.fragment.constants.add("inverseSampleValue","float",255),e.fragment.uniforms.add("shadowCastMap","sampler2D"),e.fragment.uniforms.add("sampleScale","float"),e.fragment.uniforms.add("opacityFromElevation","float");const n=0===i,r=1===i;e.fragment.uniforms.add("color","vec4"),n?s&&e.fragment.uniforms.add("bandSize","float"):r&&e.fragment.uniforms.add("threshold","float"),e.fragment.code.add(Ua`
      void main(void) {
        vec4 record = texture2D(shadowCastMap, uv);
        float pixelSamples = record.r * inverseSampleValue;

        if (pixelSamples < 1.0) {
          discard;
        }

        float strength = pixelSamples * sampleScale;

        ${r?Ua`
            if (strength <= threshold) {
              discard;
            }`:""}

        ${n&&s?Ua`strength = ceil(strength / bandSize) * bandSize;`:""}

        gl_FragColor = vec4(color.xyz, color.a * opacityFromElevation ${n?Ua`* strength`:""});
      }
    `)}else 0!==i&&2!==i||(e.include(Oh),e.fragment.uniforms.add("depthMap","sampler2D"),e.fragment.uniforms.add("inverseView","mat4"),e.fragment.uniforms.add("nearFar","vec2"),0===i?e.fragment.constants.add("sampleValue","float",.00392156862745098):e.fragment.constants.add("shadowColor","vec4",[0,0,0,.8]),e.fragment.code.add(Ua`
      void main(void) {

        float depth = rgba2float(texture2D(depthMap, uv));
        // 0.0 is the clear value of depthMap, which means nothing has been drawn there and we should discard
        if (depth == 0.0) {
          discard;
        }

        float currentPixelDepth = linearDepthFromFloat(depth, nearFar);

        if (-currentPixelDepth > nearFar.y || -currentPixelDepth < nearFar.x) {
          discard;
        }

        vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
        vec4 worldSpacePos = inverseView * currentPixelPos;

        mat4 shadowMatrix;
        float linearDepth = -currentPixelDepth;
        int i = chooseCascade(linearDepth, shadowMatrix);

        if (i >= uShadowMapNum) {
          discard;
        }

        vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);

        // vertex completely outside? -> no shadow
        if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
          discard;
        }

        vec2 uvShadow = cascadeCoordinates(i, lvpos);

        float depthShadow = readShadowMapDepth(uvShadow, uShadowMapTex);
        bool shadow = depthShadow < lvpos.z;

        if (!shadow) {
          discard;
        }

        gl_FragColor = ${0===i?Ua`vec4(sampleValue)`:Ua`shadowColor`};
      }
    `));return e}const rO=Object.freeze({__proto__:null,shadowCastMaxSamples:255,build:nO});class oO extends Ya{initializeProgram(t){const e=oO.shader.get().build(this.configuration);return new Xa(t.rctx,e,Ka)}initializePipeline(t){switch(this.configuration.pass){case 0:return Gh({blending:qh(1,1,1,1),colorWrite:Wh,depthTest:null,depthWrite:null});case 1:case 2:return Gh({blending:Yh,colorWrite:Wh,depthTest:null,depthWrite:null})}return Gh({})}bindPass(t){if(0===this.configuration.pass||2===this.configuration.pass){const e=t;this.program.bindTexture(e.linearDepthTexture,"depthMap"),e.shadowMap.bind(this.program),e.shadowMap.bindView(this.program,e.camera.center),this.program.setUniform2fv("nearFar",e.camera.nearFar),this.program.setUniformMatrix4fv("inverseView",e.inverseView),this.program.setUniform4fv("projInfo",e.projInfo),this.program.setUniform2fv("zScale",e.zScale)}else if(1===this.configuration.pass){const e=t;this.program.bindTexture(e.shadowCastMap,"shadowCastMap"),this.program.setUniform1f("sampleScale",e.sampleScale),this.program.setUniform1f("opacityFromElevation",e.opacityFromElevation),this.program.setUniform4fv("color",e.color),0===this.configuration.visualization&&this.configuration.bandsEnabled?this.program.setUniform1f("bandSize",t.bandSize):1===this.configuration.visualization&&this.program.setUniform1f("threshold",t.threshold)}}get primitiveType(){return 5}}oO.shader=new $a(rO,(()=>import("./p-40826f69.js")));class aO extends Qa{constructor(){super(...arguments),this.pass=0,this.visualization=0,this.bandsEnabled=!1}}r([Za({count:3})],aO.prototype,"pass",void 0),r([Za()],aO.prototype,"visualization",void 0),r([Za()],aO.prototype,"bandsEnabled",void 0);const hO=na(.01,0,.25,1);let lO=class extends T{constructor(t,e,i,s){super({}),this._techniqueRepository=t,this._rctx=e,this._shadowAccumulator=i,this._requestRender=s,this._visualizationParams={shadowCastMap:this._shadowCastTexture,sampleScale:0,color:hO,threshold:.5,bandSize:.1,opacityFromElevation:1},this._techniqueConfig=new aO,this._enabled=!1,this._vao=Ja(e),this._techniqueConfig.pass=1,this._techniqueConfig.visualization=0}normalizeCtorArgs(){return{}}dispose(){this._stop(),this._vao=Q(this._vao),this._techniqueRepository.release(this._technique),this._technique=null,this._shadowAccumulator=null}get visualizeShadowCastTechnique(){return this._technique=this._techniqueRepository.releaseAndAcquire(oO,this._techniqueConfig,this._technique),this._technique}render(){if(!this._isRenderingVisualization)return;this._sampleScale=1/this._computedSamples,this._rctx.bindVAO(this._vao);const t=this.visualizeShadowCastTechnique;this._rctx.useProgram(t.program),t.bindPipelineState(this._rctx),t.bindPass(this._visualizationParams),this._rctx.drawArrays(t.primitiveType,0,ul(this._vao,"geometry"))}setOptions(t){void 0!==t.enabled&&this._setEnabled(t.enabled),void 0!==t.color&&this._setColor(t.color),void 0!==t.threshold&&(this._threshold=t.threshold),void 0!==t.visualization&&(this._visualization=t.visualization),void 0!==t.bandSize&&(this._bandSize=t.bandSize),void 0!==t.bandsEnabled&&(this._bandsEnabled=t.bandsEnabled)}get opacityFromElevation(){return this._visualizationParams.opacityFromElevation}set opacityFromElevation(t){this._visualizationParams.opacityFromElevation!==t&&(this._visualizationParams.opacityFromElevation=t,this.notifyChange("opacityFromElevation"))}get _isRenderingVisualization(){return this._enabled&&this._computedSamples>0&&this.opacityFromElevation>.001953125}get _computedSamples(){return this._shadowAccumulator.computedSamples}get _shadowCastTexture(){return this._shadowAccumulator.shadowCastTexture}get _sampleScale(){return this._visualizationParams.sampleScale}set _sampleScale(t){this._visualizationParams.sampleScale=t}get _threshold(){return this._visualizationParams.threshold}set _threshold(t){this._threshold!==t&&(this._visualizationParams.threshold=t,this._requestRenderIfRunning())}get _visualization(){return this._techniqueConfig.visualization}set _visualization(t){t!==this._visualization&&(this._techniqueConfig.visualization=t,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}get _bandSize(){return this._visualizationParams.bandSize}set _bandSize(t){t!==this._bandSize&&(this._visualizationParams.bandSize=t,this._requestRenderIfRunning())}get _bandsEnabled(){return this._techniqueConfig.bandsEnabled}set _bandsEnabled(t){t!==this._bandsEnabled&&(this._techniqueConfig.bandsEnabled=t,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}_setColor(t){Ls(t,this._visualizationParams.color)||(As(this._visualizationParams.color,t),this._requestRenderIfRunning())}_setEnabled(t){t!==this._enabled&&(t?this._start():this._stop())}_requestRenderIfRunning(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};r([o()],lO.prototype,"opacityFromElevation",null),lO=r([a("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],lO);class cO{constructor(){this.camera=new hr,this.lightMat=gn()}}class uO{constructor(t,e,i=0){this.rctx=t,this.viewingMode=e,this._enabled=!1,this._snapshots=new Array,this.textureSize=0,this.maxTextureSize=0,this.numCascades=1,this.maxNumCascades=4,this.splitSchemeLambda=0,this.warp=!0,this.cascadeDistances=[0,0,0,0,0],this.cascades=[],this.maxTextureSize=this.rctx.parameters.maxTextureSize;for(let t=0;t<4;++t)this.cascades.push(new cO);this.snapshotCount=i}dispose(){this.discardDepthTexture(),this.discardAllSnapshots()}set maxCascades(t){this.maxNumCascades=fs(Math.floor(t),1,4)}get maxCascades(){return this.maxNumCascades}set enabled(t){this._enabled=t,t||(this.discardDepthTexture(),this.discardAllSnapshots())}get enabled(){return this._enabled}get snapshotCount(){return this._snapshots.length}set snapshotCount(t){const e=this._snapshots.length;if(t>e){const i=t-e;this._snapshots.length=t;for(let t=0;t<i;++t)this._snapshots[e+t]=null}else if(t<this.snapshotCount){const i=e-t;for(let e=0;e<i;++e)this.discardSnapshot(t+e);this._snapshots.length=t}}getSnapshot(t){return this.enabled?this._snapshots[t]:null}getCascades(){for(let t=0;t<this.numCascades;++t)TO[t]=this.cascades[t];return TO.length=this.numCascades,TO}start(t,e,i){xl(this.enabled),this.textureSize=this.computeTextureSize(t.fullWidth,t.fullHeight),this.ensureDepthTexture();const{near:s,far:n}=this.clampNearFar(i);this.computeCascadeDistances(n,s),this.setupMatrices(t,e);const r=t.viewMatrix,o=t.projectionMatrix;for(let t=0;t<this.numCascades;++t)this.constructCascade(t,o,r,e);this.lastOrigin=null,this.clear()}finish(t){xl(this.enabled),this.rctx.bindFramebuffer(t)}bind(t){this.enabled?(this._depthTextureUnit=t.bindTexture(this._depthTexture,"uShadowMapTex"),t.setUniform1f("uDepthHalfPixelSz",.5/this.textureSize),t.setUniform1i("uShadowMapNum",this.numCascades),t.setUniform4f("uShadowMapDistance",this.cascadeDistances[0],this.numCascades>1?this.cascadeDistances[1]:1/0,this.numCascades>2?this.cascadeDistances[2]:1/0,this.numCascades>3?this.cascadeDistances[3]:1/0)):t.setUniform1f("uDepthHalfPixelSz",-1)}bindView(t,e){if(!this.enabled)return;const i=this.lastOrigin;if(!i||i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]){this.lastOrigin=this.lastOrigin||js(),$i(this.lastOrigin,e);for(let t=0;t<this.numCascades;++t){ho(AO,this.cascades[t].lightMat,e);for(let e=0;e<16;++e)_O[16*t+e]=AO[e]}}t.setUniformMatrix4fv("uShadowMapMatrix",_O)}takeCascadeSnapshotTo(t,e){xl(this.enabled),this.ensureSnapshot(e),this._bindFbo();const i=this.rctx,s=i.bindTexture(this._snapshots[e],ml.TEXTURE_UNIT_FOR_UPDATES);i.gl.copyTexSubImage2D(3553,0,t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[2],t.camera.viewport[3]),i.bindTexture(s,ml.TEXTURE_UNIT_FOR_UPDATES)}clear(){const t=this.rctx;this._bindFbo(),t.setClearColor(1,1,1,1),t.clearSafe(16640)}computeTextureSize(t,e){const i=.5*Math.log(t*t+e*e)*Math.LOG2E,s=2**Math.round(i+.35);return Math.min(this.maxTextureSize,2*s)}ensureDepthTexture(){null!=this._depthTexture&&this._depthTexture.descriptor.width===this.textureSize||(this.discardDepthTexture(),this._depthTexture=new ml(this.rctx,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize}),this.fbo=new cl(this.rctx,{colorTarget:0,depthStencilTarget:1,width:this.textureSize,height:this.textureSize},this._depthTexture))}ensureSnapshot(t){const e=this._snapshots[t];p(e)&&e.descriptor.width===this.textureSize||(this.discardSnapshot(t),this._snapshots[t]=new ml(this.rctx,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize}))}discardDepthTexture(){this.fbo=Q(this.fbo),this._depthTexture=Q(this._depthTexture)}discardSnapshot(t){this._snapshots[t]=Q(this._snapshots[t])}discardAllSnapshots(){for(let t=0;t<this.snapshotCount;++t)this.discardSnapshot(t)}_bindFbo(){const t=this.rctx;p(this._depthTextureUnit)&&(t.bindTexture(null,this._depthTextureUnit),this._depthTextureUnit=null),t.bindFramebuffer(this.fbo)}constructCascade(t,e,i,s){const n=this.cascades[t],r=-this.cascadeDistances[t],o=-this.cascadeDistances[t+1],a=(e[10]*r+e[14])/Math.abs(e[11]*r+e[15]),h=(e[10]*o+e[14])/Math.abs(e[11]*o+e[15]);xl(a<h);for(let t=0;t<8;++t){ms(gO,t%4==0||t%4==3?-1:1,t%4==0||t%4==1?-1:1,t<4?a:h,1),bs(mO[t],gO,fO);for(let e=0;e<3;++e)mO[t][e]/=mO[t][3]}ls(PO,mO[0]),ho(dO,SO,PO),n.camera.viewMatrix=dO;for(let t=0;t<8;++t)os(mO[t],mO[t],n.camera.viewMatrix);$i(vO,mO[0]),$i(yO,mO[0]);for(let t=1;t<8;++t)for(let e=0;e<3;++e)vO[e]=Math.min(vO[e],mO[t][e]),yO[e]=Math.max(yO[e],mO[t][e]);vO[2]-=200,yO[2]+=200,n.camera.near=-yO[2],n.camera.far=-vO[2],this.warp?this.constructTrapezoidalProjection(i,s,n):this.constructOrthogonalProjection(n),oo(n.lightMat,n.camera.projectionMatrix,n.camera.viewMatrix);const l=this.textureSize/2;n.camera.viewport[0]=t%2==0?0:l,n.camera.viewport[1]=0===Math.floor(t/2)?0:l,n.camera.viewport[2]=l,n.camera.viewport[3]=l}constructOrthogonalProjection(t){co(t.camera.projectionMatrix,vO[0],yO[0],vO[1],yO[1],t.camera.near,t.camera.far)}constructTrapezoidalProjection(t,e,i){const s=1/mO[0][3],n=1/mO[4][3];xl(s<n);let r=s+Math.sqrt(s*n);const o=Math.sin(rs(t[2]*e[0]+t[6]*e[1]+t[10]*e[2]));r/=o,function(t,e,i,s,n,r,o,a){pa(DO,0,0);for(let e=0;e<4;++e)va(DO,DO,t[e]);ya(DO,DO,.25),pa(OO,0,0);for(let e=4;e<8;++e)va(OO,OO,t[e]);ya(OO,OO,.25),wa(RO[0],t[4],t[5],.5),wa(RO[1],t[5],t[6],.5),wa(RO[2],t[6],t[7],.5),wa(RO[3],t[7],t[4],.5);let h=0,l=Ma(RO[0],DO);for(let t=1;t<4;++t){const e=Ma(RO[t],DO);e<l&&(l=e,h=t)}ma(FO,RO[h],t[h+4]);const c=FO[0];let u,d;FO[0]=-FO[1],FO[1]=c,ma(zO,OO,DO),xa(zO,FO)<0&&ba(FO,FO),wa(FO,FO,zO,i),Ca(FO,FO),u=d=xa(ma(LO,t[0],DO),FO);for(let e=1;e<8;++e){const i=xa(ma(LO,t[e],DO),FO);i<u?u=i:i>d&&(d=i)}ga(s,DO),ya(LO,FO,u-e),va(s,s,LO);let p=-1,f=1,g=0,m=0;for(let e=0;e<8;++e){ma(EO,t[e],s),Ca(EO,EO);const i=FO[0]*EO[1]-FO[1]*EO[0];i>0?i>p&&(p=i,g=e):i<f&&(f=i,m=e)}Cl(p>0,"leftArea"),Cl(f<0,"rightArea"),ya(IO,FO,u),va(IO,IO,DO),ya(VO,FO,d),va(VO,VO,DO),jO[0]=-FO[1],jO[1]=FO[0];const v=Ml(s,t[m],VO,va(LO,VO,jO),1,n),y=Ml(s,t[g],VO,LO,1,r),w=Ml(s,t[g],IO,va(LO,IO,jO),1,o),x=Ml(s,t[m],IO,LO,1,a);Cl(v,"rayRay"),Cl(y,"rayRay"),Cl(w,"rayRay"),Cl(x,"rayRay")}(mO,r,o,wO,xO,bO,CO,MO),function(t,e,i,s,n){ma(GO,i,s),ya(GO,GO,.5),qO[0]=GO[0],qO[1]=GO[1],qO[2]=0,qO[3]=GO[1],qO[4]=-GO[0],qO[5]=0,qO[6]=GO[0]*GO[0]+GO[1]*GO[1],qO[7]=GO[0]*GO[1]-GO[1]*GO[0],qO[8]=1,qO[NO(0,2)]=-xa(BO(qO,0),t),qO[NO(1,2)]=-xa(BO(qO,1),t);let r=xa(BO(qO,0),i)+qO[NO(0,2)],o=xa(BO(qO,1),i)+qO[NO(1,2)],a=xa(BO(qO,0),s)+qO[NO(0,2)],h=xa(BO(qO,1),s)+qO[NO(1,2)];r=-(r+a)/(o+h),qO[NO(0,0)]+=qO[NO(1,0)]*r,qO[NO(0,1)]+=qO[NO(1,1)]*r,qO[NO(0,2)]+=qO[NO(1,2)]*r,r=1/(xa(BO(qO,0),i)+qO[NO(0,2)]),o=1/(xa(BO(qO,1),i)+qO[NO(1,2)]),qO[NO(0,0)]*=r,qO[NO(0,1)]*=r,qO[NO(0,2)]*=r,qO[NO(1,0)]*=o,qO[NO(1,1)]*=o,qO[NO(1,2)]*=o,qO[NO(2,0)]=qO[NO(1,0)],qO[NO(2,1)]=qO[NO(1,1)],qO[NO(2,2)]=qO[NO(1,2)],qO[NO(1,2)]+=1,r=xa(BO(qO,1),e)+qO[NO(1,2)],o=xa(BO(qO,2),e)+qO[NO(2,2)],a=xa(BO(qO,1),i)+qO[NO(1,2)],h=xa(BO(qO,2),i)+qO[NO(2,2)],r=-.5*(r/o+a/h),qO[NO(1,0)]+=qO[NO(2,0)]*r,qO[NO(1,1)]+=qO[NO(2,1)]*r,qO[NO(1,2)]+=qO[NO(2,2)]*r,r=xa(BO(qO,1),e)+qO[NO(1,2)],o=xa(BO(qO,2),e)+qO[NO(2,2)],a=-o/r,qO[NO(1,0)]*=a,qO[NO(1,1)]*=a,qO[NO(1,2)]*=a,n[0]=qO[0],n[1]=qO[1],n[2]=0,n[3]=qO[2],n[4]=qO[3],n[5]=qO[4],n[6]=0,n[7]=qO[5],n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=qO[6],n[13]=qO[7],n[14]=0,n[15]=qO[8]}(wO,xO,CO,MO,i.camera.projectionMatrix),i.camera.projectionMatrix[10]=2/(vO[2]-yO[2]),i.camera.projectionMatrix[14]=-(vO[2]+yO[2])/(vO[2]-yO[2])}setupMatrices(t,e){oo(pO,t.projectionMatrix,t.viewMatrix),so(fO,pO);const i=1===this.viewingMode?t.eye:ds(PO,0,0,1);ro(SO,[0,0,0],[-e[0],-e[1],-e[2]],i)}clampNearFar(t){let{near:e,far:i}=t;return e<2&&(e=2),i<2&&(i=2),e>=i&&(e=2,i=4),{near:e,far:i}}computeCascadeDistances(t,e){this.numCascades=Math.min(1+Math.floor(bl(t/e,4)),this.maxNumCascades);const i=(t-e)/this.numCascades,s=(t/e)**(1/this.numCascades);let n=e,r=e;for(let t=0;t<this.numCascades+1;++t)this.cascadeDistances[t]=ys(n,r,this.splitSchemeLambda),n*=s,r+=i}get gpuMemoryUsage(){var t,e;return this._snapshots.reduce(((t,e)=>t+fl(e)),null!=(t=null==(e=this.fbo)?void 0:e.gpuMemoryUsage)?t:0)}get test(){const t=this;return{maxNumCascades:this.maxNumCascades,cascades:this.cascades,textureSize:this.textureSize,depthTexture:this._depthTexture,set splitSchemeLambda(e){t.splitSchemeLambda=e},get splitSchemeLambda(){return t.splitSchemeLambda},set warp(e){t.warp=e},get warp(){return t.warp}}}}const dO=gn(),pO=gn(),fO=gn(),gO=sa(),mO=[];for(let t=0;t<8;++t)mO.push(sa());const vO=js(),yO=js(),wO=Sa(),xO=Sa(),bO=Sa(),CO=Sa(),MO=Sa(),SO=gn(),PO=js(),TO=[],AO=gn(),_O=new Float32Array(64),DO=Sa(),OO=Sa(),RO=[Sa(),Sa(),Sa(),Sa()],FO=Sa(),zO=Sa(),LO=Sa(),EO=Sa(),IO=Sa(),VO=Sa(),jO=Sa();function NO(t,e){return 3*e+t}const kO=Sa();function BO(t,e){return pa(kO,t[e],t[e+3]),kO}const GO=Sa(),qO=pn();var WO;let UO=WO=class extends T{constructor(t,e,i,s,n,r){super({}),this._rctx=t,this._stage=i,this._prepareForShadowMapPass=s,this._renderToShadowMap=n,this._requestRender=r,this._progress=0,this._sampleCount=0,this._cachedCamera=new hr,this._contentCamera=new hr,this._enabled=!1,this._cachedLightDirections=[],this._depthRange=v_,this._previewing=!1,this._handles=new E,this._cameraForcedForScreenshot=!1,this._shadowMap=new uO(t,i.viewingMode),this._shadowMap.enabled=!0,this._vao=Ja(t),this._fbo=new cl(t,{colorTarget:0,depthStencilTarget:0,width:0,height:0},{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0}),this._accumulationParams={camera:this._cachedCamera,linearDepthTexture:null,shadowMap:this._shadowMap,inverseView:gn(),projInfo:sa(),zScale:Sa()},this._accumulationRenderer=new lO(e,t,this,r),this._handles.add(this._stage.resourceController.scheduler.registerTask(po.SHADOW_ACCUMULATOR,this)),this._handles.add(ha((()=>i.renderView),(t=>{this._handles.remove(WO.renderViewHandleKey),w(t)||this._handles.add(t.events.on("force-camera-for-screenshot",(()=>this._cameraForcedForScreenshot=!0)),WO.renderViewHandleKey)}),la))}normalizeCtorArgs(){return{}}get computedSamples(){return this._progress}get shadowCastTexture(){return this._fbo.colorTexture}get isAccumulating(){return this._isPreviewing||this._isRefining}get accumulationTechnique(){if(w(this._accumulationTechnique)){const t={rctx:this._rctx,viewingMode:this._stage.viewingMode},e=new aO;e.pass=0,this._accumulationTechnique=new oO(t,e)}return this._accumulationTechnique}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return this._enabled&&this._sampleCount>0}get _canAccumulate(){return null!==this._accumulationParams.linearDepthTexture&&this._depthRange!==v_&&this._opacityFromElevation>.001953125}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(t){const e=this._cachedLightDirections;if(Lt(e,t,gs))return;const i=t.length;e.length=i,this._sampleCount=Math.min(255,i);for(let s=0;s<i;++s){const i=t[s],n=e[s]||js();$i(n,i),e[s]=n}this._invalidate()}get _projInfo(){return this._accumulationParams.projInfo}get _zScale(){return this._accumulationParams.zScale}get _inverseView(){return this._accumulationParams.inverseView}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(t){this._accumulationRenderer.opacityFromElevation=t}get running(){return this._isRefining&&this._canAccumulate}runTask(t){for(this._prepareForShadowMapPass(this._cachedCamera,this._contentCamera);!t.done&&!this._isDoneAccumulating;)this._accumulateShadow(),t.madeProgress();this._requestRender()}accumulateFixedSamples(){if(!this.isAccumulating||!this._canAccumulate)return;(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();const t=this._cameraForcedForScreenshot?this._sampleCount:Math.min(WO.previewSamples,this._sampleCount-this._progress);for(let e=0;e<t;++e)this._accumulateShadow();this._cameraForcedForScreenshot=!1}render(){this._accumulationRenderer.render()}dispose(){this._stop(),this._handles.destroy(),this._accumulationRenderer=Q(this._accumulationRenderer),this._shadowMap=Q(this._shadowMap),this._fbo=Q(this._fbo),this._vao=Q(this._vao),this._accumulationTechnique=Q(this._accumulationTechnique),this._cachedLightDirections.length=0,this._sampleCount=0}setOptions(t){void 0!==t.enabled&&this._setEnabled(t.enabled),void 0!==t.previewing&&this.setPreviewing(t.previewing),void 0!==t.lightDirections&&this.setLightDirections(t.lightDirections),this._accumulationRenderer.setOptions(t)}setPreviewing(t){this._previewing!==t&&(this._previewing=t,this._requestRenderIfEnabled())}setLightDirections(t){this._lightDirections=t}setAccumulationDependencies(t,e,i,s){this._accumulationParams.linearDepthTexture=t,this._depthRange=e,this._updateCamera(i),this._contentCamera=s,this.notifyChange("_canAccumulate")}readAccumulatedShadow(t,e){if(!this._isActive||this._progress<1||t<0||t>this._fbo.width||e<0||e>this._fbo.height)return 0;const i=HO;return this._fbo.readPixels(t,e,1,1,6408,5121,i),i[0]/this._progress}_start(){this._progress=0,this._enabled=!0}_stop(){this._enabled=!1}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(16384),this._progress=0}_accumulateShadow(){this._renderToShadowMap(this._shadowMap,this._lightDirections[this._progress],this._cachedCamera,this._depthRange),this._rctx.bindFramebuffer(this._fbo);const t=this.accumulationTechnique;this._rctx.useProgram(t.program),t.bindPipelineState(this._rctx),t.bindPass(this._accumulationParams),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(t.primitiveType,0,ul(this._vao,"geometry")),this._progress++}_updateCamera(t){if(t.equals(this._cachedCamera))return;const{fullWidth:e,fullHeight:i,projectionMatrix:s,viewMatrix:n,center:r}=t;this._cachedCamera.copyFrom(t),this._fbo.resize(e,i),Sl(s,e,i,this._projInfo,this._zScale),ho(this._inverseView,n,r),so(this._inverseView,this._inverseView),this._opacityFromElevation=1-Vs(4e4,5e4,t.relativeElevation)}_setEnabled(t){t!==this._enabled&&(t?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}get test(){return{lightDirections:this._lightDirections,isDone:()=>this._isDoneAccumulating,isActive:()=>this._isActive}}};UO.previewSamples=6,UO.renderViewHandleKey="renderView",r([o()],UO.prototype,"_progress",void 0),r([o()],UO.prototype,"_sampleCount",void 0),r([o()],UO.prototype,"_enabled",void 0),r([o()],UO.prototype,"_depthRange",void 0),r([o()],UO.prototype,"_previewing",void 0),r([o()],UO.prototype,"_accumulationRenderer",void 0),r([o()],UO.prototype,"_isRefining",null),r([o()],UO.prototype,"_isActive",null),r([o()],UO.prototype,"_canAccumulate",null),r([o()],UO.prototype,"_isDoneAccumulating",null),r([o()],UO.prototype,"_opacityFromElevation",null),r([o()],UO.prototype,"running",null),UO=WO=r([a("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],UO);const HO=new Uint8Array(4);function ZO(t){const e=new Wa;return e.include(Oh),e.fragment.include(sh),e.fragment.include(Ha),e.include(Jl),e.include(Ir),e.fragment.uniforms.add("defaultDepthTex","sampler2D").add("highlightDepthTex","sampler2D").add("depthMap","sampler2D").add("highlightMap","sampler2D").add("color","vec4").add("nearFar","vec2").add("opacity","float").add("occludedOpacity","float").add("terminationFactor","float").add("inverseView","mat4").add("lightingMainDirectionView","vec3").add("texelSize","vec2"),e.fragment.constants.add("unoccludedHighlightFlag","vec4",Vh).add("highlightedThreshold","float",t.highlightedThreshold).add("selfShadowThreshold","float",t.selfShadowThreshold),e.fragment.code.add(Ua`vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, vec2 uv, vec2 texelSize, sampler2D depthMap, vec2 nearFar) {
float leftPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(-1.0, 0.0) * texelSize, nearFar);
float rightPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(1.0, 0.0) * texelSize, nearFar);
float bottomPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, -1.0) * texelSize, nearFar);
float topPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, 1.0) * texelSize, nearFar);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`),e.fragment.code.add(Ua`void main(void) {
vec4 highlightInfo = texture2D(highlightMap, uv);
float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;
if (visiblyHighlighted > highlightedThreshold) {
discard;
}
float depth = rgba2float(texture2D(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseView * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= uShadowMapNum) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
bool shadowHighlight = depthHighlight < lvpos.z;
if (!shadowHighlight) {
discard;
}
float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
bool shadowDefault = depthDefault < lvpos.z;
vec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, uv, texelSize, depthMap, nearFar);
bool shaded = dot(normal, lightingMainDirectionView) < selfShadowThreshold;
float differenceOpacity = opacity;
float bothOpacity = occludedOpacity;
float fragOpacity = (shadowDefault || shaded) ? bothOpacity : differenceOpacity;
gl_FragColor = vec4(color.rgb, color.a * fragOpacity * terminationFactor);
}`),e}const QO=Object.freeze({__proto__:null,build:ZO});class YO extends Ya{initializeProgram(t){const e=YO.shader.get().build({highlightedThreshold:.99999,selfShadowThreshold:.025});return new Xa(t.rctx,e,Ka)}initializePipeline(t){return Gh({blending:qh(770,1,771,771),colorWrite:Wh,depthTest:null,depthWrite:null})}bindPass(t,e){if(w(e.linearDepthTexture))return;this.program.bindTexture(e.linearDepthTexture,"depthMap"),this.program.bindTexture(e.highlightColorTexture,"highlightMap"),os(XO,e.lighting.lightingMainDirection,e.camera.viewInverseTransposeMatrix),is(XO,XO),Sl(e.camera.projectionMatrix,e.camera.fullWidth,e.camera.fullHeight,$O,KO),ho(JO,e.camera.viewMatrix,e.camera.center),so(JO,JO),this.program.setUniform4fv("color",t.shadowColor),this.program.setUniform1f("opacity",t.shadowOpacity),this.program.setUniform1f("occludedOpacity",t.occludedShadowOpacity),this.program.setUniform1f("terminationFactor",t.opacityElevation*t.dayNightTerminator),this.program.setUniform2fv("nearFar",e.camera.nearFar),this.program.setUniformMatrix4fv("inverseView",JO),this.program.setUniform4fv("projInfo",$O),this.program.setUniform2fv("zScale",KO),this.program.setUniform3fv("lightingMainDirectionView",XO),this.program.setUniform2f("texelSize",1/e.linearDepthTexture.descriptor.width,1/e.linearDepthTexture.descriptor.height),e.shadowMap.bind(this.program),e.shadowMap.bindView(this.program,e.camera.center);let i=e.shadowMap.getSnapshot(0);p(i)&&this.program.bindTexture(i,"highlightDepthTex"),i=e.shadowMap.getSnapshot(1),p(i)&&this.program.bindTexture(i,"defaultDepthTex")}get primitiveType(){return 5}}YO.shader=new $a(QO,(()=>import("./p-f92c4571.js")));const XO=js(),KO=Sa(),$O=sa(),JO=gn();class tR{constructor(t,e){this._rctx=t,this._viewingMode=e,this._maxOpacity=1,this._parameters={shadowColor:vc(1,0,1,1),shadowOpacity:.2,occludedShadowOpacity:.1,opacityElevation:1,dayNightTerminator:1},this._vao=Ja(this._rctx)}get technique(){return w(this._technique)&&(this._technique=new YO({rctx:this._rctx,viewingMode:this._viewingMode},null)),this._technique}render(t,e){if(this._updateParameters(t),!t.shadowMap.enabled||!t.linearDepthTexture||!this.isVisible)return;const i=this.technique;this._rctx.bindFramebuffer(e),this._rctx.useProgram(i.program),i.bindPipelineState(this._rctx),i.bindPass(this._parameters,t),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(i.primitiveType,0,ul(this._vao,"geometry"))}get gpuMemoryUsage(){var t,e;return null!=(t=null==(e=this._vao)?void 0:e.size)?t:0}setDefaultOptions(t){this._parameters={...this._parameters,...t},this._updateMaxOpacity()}_updateParameters(t){this._parameters.opacityElevation=1-Vs(4e4,5e4,t.camera.relativeElevation);const e=1===this._viewingMode?is(eR,t.camera.center):ds(eR,0,0,1),i=es(e,t.lighting.lightingMainDirection);this._parameters.dayNightTerminator=Vs(0,1,fs(30*i,0,1))}dispose(){this._vao=Q(this._vao),this._technique=Q(this._technique)}get isVisible(){return this._maxOpacity*this._parameters.opacityElevation*this._parameters.dayNightTerminator>=.001953125}_updateMaxOpacity(){const t=this._parameters,e=t.shadowColor,i=Math.max(t.shadowOpacity,t.occludedShadowOpacity);this._maxOpacity=i*e[3]}}const eR=js(),iR=Ro();class sR{constructor(){this._worldPlane=iR}get isEnabled(){return this.plane!==iR}get plane(){return this._worldPlane}set plane(t){this._worldPlane=t||iR}}function nR(t){const e=new Wa;return 0===t.output&&(e.attributes.add("position","vec2"),e.vertex.uniforms.add("uResolution","vec4"),e.varyings.add("fTexCoord","vec2"),e.varyings.add("fOffset[3]","vec4"),e.vertex.code.add(Ua`void SMAAEdgeDetectionVS( vec2 texcoord ) {
fOffset[0] = texcoord.xyxy + uResolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 );
fOffset[1] = texcoord.xyxy + uResolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 );
fOffset[2] = texcoord.xyxy + uResolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 );
}
void main() {
fTexCoord = (position + 1.0 ) * 0.5;
gl_Position = vec4(position, 0, 1);
SMAAEdgeDetectionVS( fTexCoord );
}`),e.fragment.uniforms.add("tColor","sampler2D"),e.fragment.code.add(Ua`
      vec4 SMAAColorEdgeDetectionPS( vec2 texcoord, vec4 offset[3], sampler2D colorTex ) {
        vec2 threshold = vec2( ${Ua.float(t.threshold)} );

        // Calculate color deltas:
        vec4 delta;
        vec3 C = texture2D( colorTex, texcoord ).rgb;

        vec3 Cleft = texture2D( colorTex, offset[0].xy ).rgb;
        vec3 t = abs( C - Cleft );
        delta.x = max( max( t.r, t.g ), t.b );

        vec3 Ctop = texture2D( colorTex, offset[0].zw ).rgb;
        t = abs( C - Ctop );
        delta.y = max( max( t.r, t.g ), t.b );

        // We do the usual threshold:
        vec2 edges = step( threshold, delta.xy );

        // Then discard if there is no edge:
        if ( dot( edges, vec2( 1.0, 1.0 ) ) == 0.0 )
            discard;

        // Calculate right and bottom deltas:
        vec3 Cright = texture2D( colorTex, offset[1].xy ).rgb;
        t = abs( C - Cright );
        delta.z = max( max( t.r, t.g ), t.b );

        vec3 Cbottom  = texture2D( colorTex, offset[1].zw ).rgb;
        t = abs( C - Cbottom );
        delta.w = max( max( t.r, t.g ), t.b );

        // Calculate the maximum delta in the direct neighborhood:
        float maxDelta = max( max( max( delta.x, delta.y ), delta.z ), delta.w );

        // Calculate left-left and top-top deltas:
        vec3 Cleftleft  = texture2D( colorTex, offset[2].xy ).rgb;
        t = abs( C - Cleftleft );
        delta.z = max( max( t.r, t.g ), t.b );

        vec3 Ctoptop = texture2D( colorTex, offset[2].zw ).rgb;
        t = abs( C - Ctoptop );
        delta.w = max( max( t.r, t.g ), t.b );

        // Calculate the final maximum delta:
        maxDelta = max( max( maxDelta, delta.z ), delta.w );

        // Local contrast adaptation in action:
        edges.xy *= step( maxDelta, float(${Ua.float(t.localConstrastAdaption)}) * delta.xy );

        return vec4( edges, 0.0, 0.0 );
      }

      void main() {
        gl_FragColor = SMAAColorEdgeDetectionPS( fTexCoord, fOffset, tColor );
      }
    `)),1===t.output&&(e.attributes.add("position","vec2"),e.vertex.uniforms.add("uResolution","vec4"),e.varyings.add("fTexCoord","vec2"),e.varyings.add("fOffset[3]","vec4"),e.varyings.add("fPixCoord","vec2"),e.vertex.code.add(Ua`
      void SMAABlendingWeightCalculationVS( vec2 texcoord ) {
        fPixCoord = texcoord * uResolution.zw;
        fOffset[0] = texcoord.xyxy + uResolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );
        fOffset[1] = texcoord.xyxy + uResolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );
        fOffset[2] = vec4( fOffset[0].xz, fOffset[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * uResolution.xxyy * float( ${Ua.int(t.maxSearchSteps)} );
      }

      void main() {
        fTexCoord = (position + 1.0 ) * 0.5;
        gl_Position = vec4(position, 0, 1);
        SMAABlendingWeightCalculationVS( fTexCoord );
      }
    `),e.fragment.uniforms.add("tEdges","sampler2D").add("tArea","sampler2D").add("tSearch","sampler2D").add("tColor","sampler2D").add("uResolution","vec4"),e.fragment.code.add(Ua`
      #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )
      #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )

      vec4 SMAASampleLevelZeroOffset(sampler2D tex, vec2 coord, vec2 offset) {
        return texture2D( tex, coord + offset.x * uResolution.xy, 0.0 );
      }

      vec2 round( vec2 x ) {
        return sign( x ) * floor( abs( x ) + 0.5 );
      }

      float SMAASearchLength( sampler2D searchTex, vec2 e, float bias, float scale ) {
        e.r = bias + e.r * scale;
        return 255.0 * texture2D( searchTex, e, 0.0 ).r;
      }

      float SMAASearchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${Ua.int(t.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 2.0, 0.0 ) * uResolution.xy;
          if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x += 0.25 * uResolution.x;
        texcoord.x += uResolution.x;
        texcoord.x += 2.0 * uResolution.x;
        texcoord.x -= uResolution.x * SMAASearchLength(searchTex, e, 0.0, 0.5);
        return texcoord.x;
      }

      float SMAASearchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${Ua.int(t.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 2.0, 0.0 ) * uResolution.xy;
          if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x -= 0.25 * uResolution.x;
        texcoord.x -= uResolution.x;
        texcoord.x -= 2.0 * uResolution.x;
        texcoord.x += uResolution.x * SMAASearchLength( searchTex, e, 0.5, 0.5 );
        return texcoord.x;
      }

      float SMAASearchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${Ua.int(t.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 0.0, 2.0 ) * uResolution.xy;
          if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y -= 0.25 * uResolution.y;
        texcoord.y -= uResolution.y;
        texcoord.y -= 2.0 * uResolution.y;
        texcoord.y += uResolution.y * SMAASearchLength( searchTex, e.gr, 0.0, 0.5 );
        return texcoord.y;
      }

      float SMAASearchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${Ua.int(t.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 0.0, 2.0 ) * uResolution.xy;
          if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y += 0.25 * uResolution.y;
        texcoord.y += uResolution.y;
        texcoord.y += 2.0 * uResolution.y;
        texcoord.y -= uResolution.y * SMAASearchLength( searchTex, e.gr, 0.5, 0.5 );
        return texcoord.y;
      }

      vec2 SMAAArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {
        vec2 texcoord = float( ${Ua.int(t.maxDistanceAreaTex)} ) * round( 4.0 * vec2( e1, e2 ) ) + dist;
        texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );
        texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;
        return texture2D( areaTex, texcoord, 0.0 ).rg;
      }

      vec4 SMAABlendingWeightCalculationPS( vec2 texcoord, vec2 pixcoord, vec4 offset[ 3 ], sampler2D edgesTex, sampler2D areaTex, sampler2D searchTex, ivec4 subsampleIndices ) {
        vec4 weights = vec4( 0.0, 0.0, 0.0, 0.0 );
        vec2 e = texture2D( edgesTex, texcoord ).rg;
        if ( e.g > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.x = SMAASearchXLeft( edgesTex, searchTex, offset[ 0 ].xy, offset[ 2 ].x );
          coords.y = offset[ 1 ].y;
          d.x = coords.x;
          float e1 = texture2D( edgesTex, coords, 0.0 ).r;
          coords.x = SMAASearchXRight( edgesTex, searchTex, offset[ 0 ].zw, offset[ 2 ].y );
          d.y = coords.x;
          d = d * uResolution.z - pixcoord.x;
          vec2 sqrt_d = sqrt( abs( d ) );
          coords.y -= 1.0 * uResolution.y;
          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 1.0, 0.0 ) ).r;
          weights.rg = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.y ) );
        }

        if ( e.r > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.y = SMAASearchYUp( edgesTex, searchTex, offset[ 1 ].xy, offset[ 2 ].z );
          coords.x = offset[ 0 ].x;
          d.x = coords.y;
          float e1 = texture2D( edgesTex, coords, 0.0 ).g;
          coords.y = SMAASearchYDown( edgesTex, searchTex, offset[ 1 ].zw, offset[ 2 ].w );
          d.y = coords.y;
          d = d * uResolution.w - pixcoord.y;
          vec2 sqrt_d = sqrt( abs( d ) );
          coords.y -= 1.0 * uResolution.y;
          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 0.0, 1.0 ) ).g;
          weights.ba = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.x ) );

          // for some reason the following lines are necessary to prevent
          // texture lookup precision issues on some Intel integrated graphics chips
          vec4 dbg = (offset[ 0 ]+offset[ 1 ]+offset[ 2 ] + coords.xyyx);
          weights.r += 0.00000001 * dot(vec4(0,1,0,1),dbg);
        }
        return weights;
      }

      void main() {
        gl_FragColor = SMAABlendingWeightCalculationPS( fTexCoord, fPixCoord, fOffset, tEdges, tArea, tSearch, ivec4( 0.0 ) );
      }
    `)),2===t.output&&(e.attributes.add("position","vec2"),e.vertex.uniforms.add("uResolution","vec4"),e.varyings.add("fTexCoord","vec2"),e.varyings.add("fOffset[2]","vec4"),e.vertex.code.add(Ua`void SMAANeighborhoodBlendingVS( vec2 texcoord ) {
fOffset[0] = texcoord.xyxy + uResolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 );
fOffset[1] = texcoord.xyxy + uResolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 );
}
void main() {
fTexCoord = (position + 1.0 ) * 0.5;
gl_Position = vec4(position, 0, 1);
SMAANeighborhoodBlendingVS(fTexCoord);
}`),e.fragment.uniforms.add("tBlendWeights","sampler2D"),e.fragment.uniforms.add("tColor","sampler2D"),e.fragment.uniforms.add("uResolution","vec4"),e.fragment.code.add(Ua`vec4 SMAANeighborhoodBlendingPS( vec2 texcoord, vec4 offset[ 2 ], sampler2D colorTex, sampler2D blendTex ) {
vec4 a;
a.xz = texture2D( blendTex, texcoord ).xz;
a.y = texture2D( blendTex, offset[ 1 ].zw ).g;
a.w = texture2D( blendTex, offset[ 1 ].xy ).a;
if ( dot(a, vec4( 1.0, 1.0, 1.0, 1.0 )) < 1e-5 ) {
return texture2D( colorTex, texcoord, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture2D( colorTex, texcoord, 0.0 );
texcoord += sign( offset ) * uResolution.xy;
vec4 Cop = texture2D( colorTex, texcoord, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
vec4 mixed = mix(C, Cop, s);
return mixed;
}
}
void main() {
gl_FragColor = SMAANeighborhoodBlendingPS( fTexCoord, fOffset, tColor, tBlendWeights );
}`)),e}const rR=Object.freeze({__proto__:null,build:nR});class oR extends Ya{initializeProgram(t){const e=oR.shader.get().build({output:this.configuration.output,threshold:.05,localConstrastAdaption:2,maxSearchSteps:8,maxDistanceAreaTex:16});return new Xa(t.rctx,e,Ka)}initializePipeline(){return Gh({colorWrite:Wh})}}oR.shader=new $a(rR,(()=>import("./p-f622c418.js")));class aR extends Qa{constructor(){super(...arguments),this.output=0}}r([Za({count:3})],aR.prototype,"output",void 0);let hR=class extends T{constructor(t,e){super({}),this.rctx=t,this._techniqueRep=e,this._isEnabled=!1}normalizeCtorArgs(){return{}}dispose(){this._abortController=K(this._abortController),this.disable()}_loadResources(t){if(p(this._abortController))return!1;if(p(this._searchTexture))return!0;this._abortController=new AbortController;const e=this._abortController.signal;return import("./p-4c437148.js").then((t=>this._loadTextures(t,e))).then((()=>t())).finally((()=>this._abortController=null)),!1}_loadTextures(t,e){return mt(e),Promise.all([this.loadTextureFromBase64(t.areaTexture,9729,6407),this.loadTextureFromBase64(t.searchTexure,9728,6409)]).then((([t,i])=>{vt(e)?(t.dispose(),i.dispose(),mt(e)):(this._areaTexture=t,this._searchTexture=i)}))}get updating(){return p(this._abortController)}enable(t){if(this._isEnabled)return!0;if(!this._edgeDetectTechnique||!this._blendWeights||!this._blur){const t=new aR,e=(t,e)=>this._techniqueRep.releaseAndAcquire(oR,t,e);t.output=0,this._edgeDetectTechnique=e(t,this._edgeDetectTechnique),t.output=1,this._blendWeights=e(t,this._blendWeights),t.output=2,this._blur=e(t,this._blur)}return!!this._loadResources(t)&&(this._vao=jh(this.rctx),this._edges=new cl(this.rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6407,dataType:5121,samplingMode:9729,wrapMode:33071,width:4,height:4}),this._blend=new cl(this.rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:4,height:4}),this._isEnabled=!0,!0)}disable(){this._isEnabled&&(this._vao=Q(this._vao),this._areaTexture=Q(this._areaTexture),this._searchTexture=Q(this._searchTexture),this._blend=Q(this._blend),this._edges=Q(this._edges),this._isEnabled=!1)}render(t){if(!this._isEnabled)return;const e=this.rctx,i=e.getBoundFramebufferObject(),s={x:0,y:0,width:t.descriptor.width,height:t.descriptor.height};e.bindVAO(this._vao),this._edgeDetectTechnique.bindPipelineState(e),e.setViewport(s.x,s.y,s.width,s.height),this._edges.resize(s.width,s.height),e.bindFramebuffer(this._edges),e.setClearColor(0,0,0,1),e.clear(16384),e.useProgram(this._edgeDetectTechnique.program),this._edgeDetectTechnique.program.bindTexture(t,"tColor"),this._edgeDetectTechnique.program.setUniform4f("uResolution",1/s.width,1/s.height,s.width,s.height),e.drawArrays(4,0,3),this._blend.resize(s.width,s.height),e.bindFramebuffer(this._blend),e.setClearColor(0,0,1,1),e.clear(16384),e.useProgram(this._blendWeights.program),this._blendWeights.program.setUniform4f("uResolution",1/s.width,1/s.height,s.width,s.height),this._blendWeights.program.bindTexture(this._searchTexture,"tSearch"),this._blendWeights.program.bindTexture(this._areaTexture,"tArea"),this._blendWeights.program.bindTexture(this._edges.colorTexture,"tEdges"),e.drawArrays(4,0,3),e.bindFramebuffer(i),e.setClearColor(0,1,0,1),e.clear(16384),e.useProgram(this._blur.program),this._blur.program.setUniform4f("uResolution",1/s.width,1/s.height,s.width,s.height),this._blur.program.bindTexture(t,"tColor"),this._blur.program.bindTexture(this._blend.colorTexture,"tBlendWeights"),e.drawArrays(4,0,3)}loadTextureFromBase64(t,e,i){const s=new ml(this.rctx,{pixelFormat:i,dataType:5121,wrapMode:33071,samplingMode:e},null);return Zh(t).then((t=>(s.resize(t.width,t.height),s.setData(t),s)))}};function lR(t){const e=new Wa;return e.include(Ir),1===t.output&&(e.fragment.include(Ha),e.fragment.uniforms.add("normalMap","sampler2D").add("depthMap","sampler2D").add("tex","sampler2D").add("blurSize","vec2").add("projScale","float").add("nearFar","vec2"),e.fragment.code.add(Ua`
      void blurFunction(vec2 uv, float r, float center_d, float sharpness, inout float wTotal, inout float bTotal) {
        float c = texture2D(tex, uv).r;
        float d = linearDepthFromTexture(depthMap, uv, nearFar);

        float ddiff = d - center_d;

        float w = exp(-r * r * ${Ua.float(t.blurFalloff)} - ddiff * ddiff * sharpness);
        wTotal += w;
        bTotal += w * c;
      }
    `),e.fragment.code.add(Ua`
      void main(void) {
        float b = 0.0;
        float w_total = 0.0;

        float center_d = linearDepthFromTexture(depthMap, uv, nearFar);

        float sharpness = -0.05 * projScale/center_d;
        for (int r = -${Ua.int(t.filterRadius)}; r <= ${Ua.int(t.filterRadius)}; ++r) {
          float rf = float(r);
          vec2 uvOffset = uv + rf * blurSize;
          blurFunction(uvOffset, rf, center_d, sharpness, w_total, b);
        }

        gl_FragColor = vec4(b / w_total);
      }
    `)),0===t.output&&(e.fragment.include(Ha),e.include(Jl),e.fragment.uniforms.add("normalMap","sampler2D").add("depthMap","sampler2D").add("intensity","float").add("projScale","float").add("radius","float").add("nearFar","vec2").add("screenDimensions","vec2").add("rnmScale","vec2").add("rnm","sampler2D"),e.fragment.code.add(Ua`vec3 sphere[16];
void fillSphere() {
sphere[0] = vec3(0.186937, 0.0, 0.0);
sphere[1] = vec3(0.700542, 0.0, 0.0);
sphere[2] = vec3(-0.864858, -0.481795, -0.111713);
sphere[3] = vec3(-0.624773, 0.102853, -0.730153);
sphere[4] = vec3(-0.387172, 0.260319, 0.007229);
sphere[5] = vec3(-0.222367, -0.642631, -0.707697);
sphere[6] = vec3(-0.01336, -0.014956, 0.169662);
sphere[7] = vec3(0.122575, 0.1544, -0.456944);
sphere[8] = vec3(-0.177141, 0.85997, -0.42346);
sphere[9] = vec3(-0.131631, 0.814545, 0.524355);
sphere[10] = vec3(-0.779469, 0.007991, 0.624833);
sphere[11] = vec3(0.308092, 0.209288,0.35969);
sphere[12] = vec3(0.359331, -0.184533, -0.377458);
sphere[13] = vec3(0.192633, -0.482999, -0.065284);
sphere[14] = vec3(0.233538, 0.293706, -0.055139);
sphere[15] = vec3(0.417709, -0.386701, 0.442449);
}
float fallOffFunction(float vv, float vn, float bias) {
float f = max(radius * radius - vv, 0.0);
return f * f * f * max(vn-bias, 0.0);
}`),e.fragment.code.add(Ua`float aoValueFromPositionsAndNormal(vec3 C, vec3 n_C, vec3 Q) {
vec3 v = Q - C;
float vv = dot(v, v);
float vn = dot(normalize(v), n_C);
return fallOffFunction(vv, vn, 0.1);
}`),e.fragment.code.add(Ua`
      void main(void) {
        fillSphere();
        vec3 fres = normalize((texture2D(rnm, uv * rnmScale).xyz * 2.0) - vec3(1.0));
        float currentPixelDepth = linearDepthFromTexture(depthMap, uv, nearFar);

        if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
          gl_FragColor = vec4(0.0);
          return;
        }

        vec3 currentPixelPos = reconstructPosition(gl_FragCoord.xy,currentPixelDepth);

        // get the normal of current fragment
        vec4 norm4 = texture2D(normalMap, uv);
        vec3 norm = vec3(-1.0) + 2.0 * norm4.xyz;
        bool isTerrain = norm4.w<0.5;

        float sum = .0;
        vec3 tapPixelPos;

        // note: the factor 2.0 should not be necessary, but makes ssao much nicer.
        // bug or deviation from CE somewhere else?
        float ps = projScale/(2.0 * currentPixelPos.z * zScale.x + zScale.y);

        for(int i = 0; i < ${Ua.int(t.samples)}; ++i) {
          vec2 unitOffset = reflect(sphere[i], fres).xy;
          vec2 offset = vec2(-unitOffset * radius * ps);

          //don't use current or very nearby samples
          if ( abs(offset.x)<2.0 || abs(offset.y)<2.0) continue;

          vec2 tc = vec2(gl_FragCoord.xy + offset);
          if (tc.x < 0.0 || tc.y < 0.0 || tc.x > screenDimensions.x || tc.y > screenDimensions.y) continue;
          vec2 tcTap = tc/screenDimensions;
          float occluderFragmentDepth = linearDepthFromTexture(depthMap, tcTap, nearFar);

          if (isTerrain) {
            bool isTerrainTap = texture2D(normalMap, tcTap).w<0.5;
            if (isTerrainTap) {
              continue;
            }
          }

          tapPixelPos = reconstructPosition(tc, occluderFragmentDepth);

          sum+= aoValueFromPositionsAndNormal(currentPixelPos, norm, tapPixelPos);
        }

        // output the result
        float A = max(1.0-sum*intensity/float(${Ua.int(t.samples)}),0.0);

        // Anti-tone map to reduce contrast and drag dark region farther: (x^0.2 + 1.2 * x^4)/2.2
        A = (pow(A, 0.2) + 1.2 * A*A*A*A) / 2.2;
        gl_FragColor = vec4(A);
      }
    `)),e}r([o()],hR.prototype,"_abortController",void 0),r([o({readOnly:!0})],hR.prototype,"updating",null),hR=r([a("esri.views.3d.webgl-engine.lib.SmaaRenderPass")],hR);const cR=Object.freeze({__proto__:null,build:lR});class uR extends Ya{initializeProgram(t){const e=uR.shader.get(),i=(uR.filterRadius+1)/2,s=e.build({output:this.configuration.output,samples:uR.samples,filterRadius:uR.filterRadius,blurFalloff:1/(2*i*i)});return new Xa(t.rctx,s,Ka)}initializePipeline(){return Gh({colorWrite:Wh})}}uR.shader=new $a(cR,(()=>import("./p-11d755f9.js"))),uR.samples=16,uR.filterRadius=4;class dR extends Qa{constructor(){super(...arguments),this.output=0}}r([Za({count:2})],dR.prototype,"output",void 0);class pR{constructor(t,e,i){this._techniqueRep=t,this._rctx=e,this._requestRender=i,this._enabled=!1,this._ssaoTechniqueConfig=new dR,this.quadVAO=null,this._blurSizePx=2,this._attenuation=.5}dispose(){this.quadVAO=Q(this.quadVAO)}set enabled(t){t?this._enable():this._disable()}get enabled(){return this._enabled}get ready(){return this.enabled&&p(this._noiseTexture)&&p(this._ssaoFBO)&&p(this._blur0FBO)&&p(this._blur1FBO)}computeSSAO(t,e,i){if(!this.enabled||w(e)||w(i)||w(this._noiseTexture)||w(this._ssaoFBO)||w(this._blur0FBO)||w(this._blur1FBO))return;const s=this._rctx,n=t.fullViewport,r=n[2],o=n[3],a=r/this._blurSizePx,h=o/this._blurSizePx;this._ssaoFBO.resize(r,o),this._blur0FBO.resize(a,h),this._blur1FBO.resize(a,h);const l=1*r,c=1*o;s.bindFramebuffer(this._ssaoFBO),s.setViewport(0,0,r,o);const u=this._ssaoTechnique.program;s.useProgram(u),this._ssaoTechnique.bindPipelineState(s),u.setUniform2f("rnmScale",r/this._noiseTexture.descriptor.width,o/this._noiseTexture.descriptor.height),Sl(t.projectionMatrix,t.fullWidth,t.fullHeight,gR,fR),u.setUniform4fv("projInfo",gR),u.setUniform2fv("zScale",fR),u.setUniform2f("nearFar",t.near,t.far);let d=1/t.computeRenderPixelSizeAtDist(1);u.setUniform1f("projScale",1*d),u.setUniform2f("screenDimensions",l,c);const p=cs(t.eye,t.center);let f=20*t.computeRenderPixelSizeAtDist(p);f=Math.max(.1,f),u.setUniform1f("radius",f),u.setUniform1f("intensity",4*this._attenuation/f**6),u.bindTexture(this._noiseTexture,"rnm"),u.bindTexture(i,"normalMap"),u.bindTexture(e,"depthMap"),w(this.quadVAO)&&(this.quadVAO=Ja(this._rctx)),s.bindVAO(this.quadVAO),s.drawArrays(5,0,ul(this.quadVAO,"geometry"));const g=this._blurTechnique.program;s.useProgram(g),g.bindTexture(this._ssaoFBO.colorTexture,"tex"),g.bindTexture(i,"normalMap"),g.bindTexture(e,"depthMap"),s.setViewport(0,0,l/this._blurSizePx,c/this._blurSizePx),s.bindFramebuffer(this._blur0FBO),g.setUniform2f("screenDimensions",l,c),g.setUniform2f("blurSize",0,1*this._blurSizePx/c),g.setUniform2f("nearFar",t.near,t.far),p>5e4&&(d=Math.max(0,d-(p-5e4))),g.setUniform1f("projScale",d),s.drawArrays(5,0,ul(this.quadVAO,"geometry")),g.setUniform2f("blurSize",1*this._blurSizePx/l,0),s.bindFramebuffer(this._blur1FBO),g.bindTexture(this._blur0FBO.colorTexture,"tex"),s.drawArrays(5,0,ul(this.quadVAO,"geometry")),s.setViewport(n[0],n[1],n[2],n[3])}bind(t,e){this.enabled&&p(this._blur1FBO)&&p(this._ssaoFBO)?(t.bindTexture(this._blur1FBO.colorTexture,"ssaoTex"),t.setUniform4f("viewportPixelSz",e.fullViewport[0],e.fullViewport[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height)):t.setUniform4f("viewportPixelSz",-1,-1,-1,-1)}_selectPrograms(){this._ssaoTechniqueConfig.output=0,this._ssaoTechnique=this._techniqueRep.releaseAndAcquire(uR,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=1,this._blurTechnique=this._techniqueRep.releaseAndAcquire(uR,this._ssaoTechniqueConfig,this._blurTechnique)}_enable(){this.enabled||(this._enabled=!0,this._loadResources((()=>{this._enabled&&this._initialize()})))}_loadResources(t){this._data?t():import("./p-3ac98773.js").then((e=>{this._data=e,t()}))}_initialize(){const t={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},e={colorTarget:0,depthStencilTarget:0};Zh(this._data.noiseTexture).then((i=>{this._enabled&&(this._ssaoFBO=new cl(this._rctx,e,t),this._blur0FBO=new cl(this._rctx,e,t),this._blur1FBO=new cl(this._rctx,e,t),this._noiseTexture=new ml(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,hasMipmap:!0,width:i.width,height:i.height},i),this._requestRender())})),this._selectPrograms()}_disable(){this._enabled=!1,this._noiseTexture=Q(this._noiseTexture),this._blur1FBO=Q(this._blur1FBO),this._blur0FBO=Q(this._blur0FBO),this._ssaoFBO=Q(this._ssaoFBO)}get gpuMemoryUsage(){return(p(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(p(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(p(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}get test(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}const fR=Sa(),gR=sa();class mR{constructor(t){this.factory=t,this.originData=new Map}acquire(t){return this.register(this.factory.getOrigin(t))}register(t){const e=this.originData.get(t.id);return e?(e.refCount++,e.origin):(this.originData.set(t.id,{refCount:1,viewMatrix:gn(),origin:t}),t)}release(t){const e=this.originData.get(t.id);e&&(e.refCount--,0===e.refCount&&this.originData.delete(t.id))}updateViewMatrices(t){this.originData.forEach((e=>{io(e.viewMatrix,t),function(t,e){const i=e,s=t[0],n=t[1],r=t[2];i[12]+=s*i[0]+n*i[4]+r*i[8],i[13]+=s*i[1]+n*i[5]+r*i[9],i[14]+=s*i[2]+n*i[6]+r*i[10],i[14]+=s*i[3]+n*i[7]+r*i[11]}(e.origin.vec3,e.viewMatrix)}))}getViewMatrix(t){return this.originData.get(t.id).viewMatrix}}function vR(t){const e=Ua`bool isNaN( float val )
{
return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;
}`;t.code.add(e)}function yR(t,e){t.vertex.include(vR),t.include(Ea,e);const i=t.vertex;i.uniforms.add("uDepthBias","vec2"),i.uniforms.add("uViewportDimInv","vec2"),e.legacy?(i.uniforms.add("uView","mat4"),i.uniforms.add("uProj","mat4")):i.uniforms.add("uTransformNormal_ViewFromGlobal","mat3"),i.code.add(e.legacy?Ua`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = uDepthBias.x;
float offsetZ  = uDepthBias.y;
vec4 projNormal = uProj * uView * vec4(globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * uViewportDimInv * normalize(projNormal.xyz).xy;
}`:Ua`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = uDepthBias.x;
float offsetZ  = uDepthBias.y;
vec4 projNormal = uTransform_ProjFromView * vec4(uTransformNormal_ViewFromGlobal * globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * uViewportDimInv * normalize(projNormal.xyz).xy;
}`),i.code.add(Ua`float _calculateProjectedBiasZ(vec4 projPos) {
float offsetZ = uDepthBias.y;
return sqrt(projPos.z) * offsetZ;
}
vec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {
vec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);
if (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {
projPos.xy += offsetXY;
}
projPos.z += _calculateProjectedBiasZ(projPos);
return projPos;
}`)}function wR(t,e){const i=t.fragment;i.constants.add("coverageTestThreshold","float",.01),i.code.add(e.antialiasing?Ua`#define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }`:Ua`#define discardByCoverage(radius, coverage) { float coverageLimit = radius <= 0.5 ? coverageTestThreshold : 0.75; if (coverage < coverageLimit) discard; }`)}function xR(t,e){const i=t.vertex;e.silhouette?(i.code.add(Ua`bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {
float faceAVisible = dot(viewDir, normalA);
float faceBVisible = dot(viewDir, normalB);
return faceAVisible * faceBVisible < 0.0;
}`),i.code.add(e.legacy?Ua`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 viewNormalA = _modelToViewNormal(normalA);
vec3 viewNormalB = _modelToViewNormal(normalB);
vec3 viewDir = -viewPos;
if (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`:Ua`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 worldNormalA = _modelToWorldNormal(normalA);
vec3 worldNormalB = _modelToWorldNormal(normalB);
vec3 viewDir = -worldPos;
if (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`)):i.code.add(Ua`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
return false;
}`)}function bR(t,e){const i=t.vertex;switch(e.mode){case 1:i.code.add(Ua`#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}`);break;case 2:i.code.add(Ua`#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (unpackedAttributes.type <= 0.0 && lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}`);break;case 0:i.code.add(Ua`#define discardShortEdges(unpackedAttributes, lineLengthPixels) {}`)}}function CR(t,e){const i=t.vertex;i.uniforms.add("uDistanceFalloffFactor","float"),i.code.add(Ua`float distanceBasedPerspectiveFactor(float distance) {
return clamp(sqrt(uDistanceFalloffFactor / distance), 0.0, 1.0);
}`),i.uniforms.add("uComponentDataTex","sampler2D"),i.uniforms.add("uComponentDataTexInvDim","vec2"),t.attributes.add("componentIndex","float"),i.constants.add("componentColorFieldOffset","float",0),i.constants.add("componentOtherFieldOffset","float",1),i.constants.add("componentFieldCount","float",2),i.constants.add("lineWidthFractionFactor","float",8),i.constants.add("extensionLengthOffset","float",128),i.constants.add("componentTexWidth","float",4096),i.code.add(Ua`vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {
float fieldIndex = componentFieldCount * componentIndex + fieldOffset;
float rowIndex = floor(fieldIndex / componentTexWidth);
float colIndex = mod(fieldIndex, componentTexWidth);
vec2 linearIndex = vec2(
(colIndex + 0.5) / componentTexWidth,
(rowIndex + 0.5) * uComponentDataTexInvDim.y
);
return linearIndex;
}
struct ComponentData {
vec4 color;
float lineWidth;
float extensionLength;
float type;
};
ComponentData readComponentData() {
vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);
vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);
vec4 colorValue = texture2D(uComponentDataTex, colorIndex);
vec4 otherValue = texture2D(uComponentDataTex, otherIndex);
return ComponentData(
vec4(colorValue.rgb, colorValue.a * otherValue.w),
otherValue.x * (255.0 / lineWidthFractionFactor),
otherValue.y * 255.0 - extensionLengthOffset,
-(otherValue.z * 255.0) + 0.5
);
}`),e.legacy?i.code.add(Ua`vec3 _modelToWorldNormal(vec3 normal) {
return (uModel * vec4(normal, 0.0)).xyz;
}
vec3 _modelToViewNormal(vec3 normal) {
return (uView * uModel * vec4(normal, 0.0)).xyz;
}`):(i.uniforms.add("uTransformNormal_GlobalFromModel ","mat3"),i.code.add(Ua`vec3 _modelToWorldNormal(vec3 normal) {
return uTransformNormal_GlobalFromModel * normal;
}`)),e.silhouette?(t.attributes.add("normalA","vec3"),t.attributes.add("normalB","vec3"),i.code.add(Ua`vec3 worldNormal() {
return _modelToWorldNormal(normalize(normalA + normalB));
}`)):(t.attributes.add("normal","vec3"),i.code.add(Ua`vec3 worldNormal() {
return _modelToWorldNormal(normal);
}`)),e.legacy?i.code.add(Ua`vec3 worldFromModelPosition(vec3 position) {
return (uModel * vec4(position, 1.0)).xyz;
}
vec3 viewFromModelPosition(vec3 position) {
return (uView * vec4(worldFromModelPosition(position), 1.0)).xyz;
}
vec4 projFromViewPosition(vec3 position) {
return uProj * vec4(position, 1.0);
}`):(t.vertex.include(qa,e),i.code.add(Ua`vec3 worldFromModelPosition(vec3 position) {
vec3 rotatedModelPosition = uTransform_WorldFromModel_RS * position;
vec3 transform_CameraRelativeFromModel = dpAdd(
uTransform_WorldFromModel_TL,
uTransform_WorldFromModel_TH,
-uTransform_WorldFromView_TL,
-uTransform_WorldFromView_TH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}
vec3 viewFromModelPosition(vec3 position) {
return uTransform_ViewFromCameraRelative_RS * worldFromModelPosition(position);
}
vec4 projFromViewPosition(vec3 position) {
return uTransform_ProjFromView * vec4(position, 1.0);
}`)),i.code.add(Ua`float calculateExtensionLength(float extensionLength, float lineLength) {
return extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);
}`)}function MR(t,e){const i=t.vertex;switch(t.include(CR,e),t.attributes.add("sideness","vec2"),i.code.add(2===e.mode?Ua`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
float type;
};`:Ua`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
};`),e.mode){case 2:i.code.add(Ua`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float fType = component.type;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
if (fType <= 0.0) {
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
}
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);
}`);break;case 1:i.code.add(Ua`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case 0:i.code.add(Ua`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`)}}function SR(t,e){const i=t.vertex;switch(t.include(MR,e),CR.usesSketchLogic(e)&&i.uniforms.add("uStrokesAmplitude","float"),e.mode){case 0:i.code.add(Ua`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return 0.0;
}`);break;case 1:i.code.add(Ua`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return uStrokesAmplitude;
}`);break;case 2:i.code.add(Ua`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
float type = unpackedAttributes.type;
if (type <= 0.0) {
return uStrokesAmplitude;
}
else {
return 0.0;
}
}`)}}function PR(t,e){const i=t.vertex;t.include(MR,e);const s=t.fragment;switch(CR.usesSketchLogic(e)&&(i.uniforms.add("uStrokesTextureScale","vec2"),i.uniforms.add("uStrokesLog2Resolution","float"),i.uniforms.add("uStrokeVariants","float"),t.varyings.add("vStrokeUV","vec2"),s.uniforms.add("uStrokesTexture","sampler2D"),s.uniforms.add("uStrokesNormalizationScale","float"),i.code.add(Ua`void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
float lineIndex = clamp(ceil(log2(lineLength)), 0.0, uStrokesLog2Resolution);
vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * uStrokeVariants + variantStroke + 0.5) * uStrokesTextureScale;
vStrokeUV.x += variantOffset;
}`),t.fragment.include(sh),s.code.add(Ua`float calculateLineOffsetSketch() {
float offsetNorm = rgba2float(texture2D(uStrokesTexture, vStrokeUV));
return (offsetNorm - 0.5) * uStrokesNormalizationScale;
}
float calculateLinePressureSketch() {
return rgba2float(texture2D(uStrokesTexture, vStrokeUV + vec2(0.0, 0.5)));
}`)),e.mode){case 0:i.code.add(Ua`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}`),s.code.add(Ua`float calculateLineOffset() {
return 0.0;
}
float calculateLinePressure() {
return 1.0;
}`);break;case 1:i.code.add(Ua`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}`),s.code.add(Ua`float calculateLineOffset() {
return calculateLineOffsetSketch();
}
float calculateLinePressure() {
return calculateLinePressureSketch();
}`);break;case 2:t.varyings.add("vType","float"),i.code.add(Ua`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
vType = unpackedAttributes.type;
if (unpackedAttributes.type <= 0.0) {
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}
}`),s.code.add(Ua`float calculateLineOffset() {
if (vType <= 0.0) {
return calculateLineOffsetSketch();
}
else {
return 0.0;
}
}
float calculateLinePressure() {
if (vType <= 0.0) {
return calculateLinePressureSketch();
}
else {
return 1.0;
}
}`)}}function TR(t){const e=new Wa,i=e.vertex,s=e.fragment;return t.legacy&&i.uniforms.add("uModel","mat4"),t.antialiasing&&(i.code.add(Ua`#define ANTIALIASING 1`),s.code.add(Ua`#define ANTIALIASING 1`)),e.include(yR,t),e.include(SR,t),e.include(CR,t),e.include(MR,t),e.include(PR,t),e.include(gh,t),e.include(xR,t),e.include(wR,t),e.include(bR,t),e.varyings.add("vColor","vec4"),e.varyings.add("vRadius","float"),e.varyings.add("vPosition","vec3"),e.varyings.add("vWorldPosition","vec3"),e.varyings.add("vViewPos","vec3"),e.varyings.add("vLineLengthPixels","float"),e.varyings.add("vSizeFalloffFactor","float"),i.uniforms.add("uPixelToNDC","vec2"),i.uniforms.add("uNDCToPixel","vec2"),i.uniforms.add("uPixelRatio","float"),e.attributes.add("position0","vec3"),e.attributes.add("position1","vec3"),e.attributes.add("variantOffset","float"),e.attributes.add("variantStroke","float"),e.attributes.add("variantExtension","float"),i.code.add(Ua`const float opaqueCutoff = 1.0 / 255.0;
void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {
vec2 sideness = unpackedAttributes.sideness;
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;
vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);
vViewPos = viewPos;
vec4 projPosV0 = projFromViewPosition(viewPosV0);
vec4 projPosV1 = projFromViewPosition(viewPosV1);
vec4 projPos = projFromViewPosition(viewPos);
vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);
vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * uNDCToPixel;
float lineLengthPixels = length(screenSpaceLinePixels);
float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;
vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;
vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;
float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * uPixelRatio;
float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;
float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;
float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * uPixelRatio;
vSizeFalloffFactor = falloffFactor;
float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;
float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;
#ifdef ANTIALIASING
const float aaPaddingPixels = 1.0;
float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;
float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;
#else
float halfAAPaddedLineWidthAndAmplitudePixels = max(lineWidthAndAmplitudePixels, 1.0) * 0.5;
float aaPaddedRoundedCapSizePixels = max(lineWidthPixels, 1.0) * 0.5;
#endif
vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * uPixelToNDC;
vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * uPixelToNDC;
vec2 extensionLengthNDC = extensionLengthPixels * uPixelToNDC;
vec2 ndcOffset = (
screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)
+ perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC
);
projPos.xy += ndcOffset * projPos.w;
projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;
projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));
float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;
float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;
vPosition = vec3(
halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,
pixelPositionAlongLine,
pixelPositionAlongLine / extendedLineLengthPixels
);
vRadius = lineWidthPixels * 0.5;
vLineLengthPixels = extendedLineLengthPixels;
discardShortEdges(unpackedAttributes, lineLengthPixels);
gl_Position = projPos;
}
void main() {
ComponentData component = readComponentData();
UnpackedAttributes unpackedAttributes = unpackAttributes(component);
vec3 worldPosV0 = worldFromModelPosition(position0);
vec3 worldPosV1 = worldFromModelPosition(position1);
vec3 viewPosV0 = viewFromModelPosition(position0);
vec3 viewPosV1 = viewFromModelPosition(position1);
vColor = component.color;
if (vColor.a < opaqueCutoff) {
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return;
}
if (discardNonSilhouetteEdges(viewPosV0, worldPosV0)) {
return;
}
calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(), unpackedAttributes);
calculateStyleOutputs(unpackedAttributes);
}`),t.multipassTerrainEnabled&&(e.fragment.include(Ha),e.include(Dh,t)),e.fragment.code.add(Ua`
    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {
      float lineOffset = calculateLineOffset();
      float positionX = position.x - lineOffset;

      if (radius < 1.0) {
        // Handle this specifically for subpixel sizes:
        // 1. Compute correct coverage (note coverage is computed by
        //    0.5 - dist, so we make sure that that will lead to correct
        //    subpixel coverage
        // 2. Ignore rounded caps
        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);
        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);

        float coverage = min(coverageX, coverageY);

        return vec2(0.5 - coverage, 0.0);
      }
      else {
        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius
        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);

        vec2 lineToPosition = vec2(positionX, positionOnCap);
        return vec2(length(lineToPosition) - radius, positionOnCap / radius);
      }
    }

    void main() {
      ${t.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, vViewPos.z);":""}
      float radius = vRadius * calculateLinePressure();

      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);
      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);

      discardByCoverage(radius, coverage);
      discardBySlice(vWorldPosition);

      float alpha = vColor.a * coverage;

      gl_FragColor = vec4(vColor.rgb, alpha);

    }
  `),e}!function(t){t.usesSketchLogic=function(t){return 1===t.mode||2===t.mode},t.usesSolidLogic=function(t){return 0===t.mode||2===t.mode}}(CR||(CR={}));const AR=Object.freeze({__proto__:null,build:TR});class _R extends Ya{bindPass(t){const e=this.program,{edgeRenderParameters:i,bindParameters:s}=t;Ea.bindViewProjTransform(e,i.viewProjectionTransform),e.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",i.transformNormal_ViewFromGlobal),e.setUniformMatrix4fv("uProj",s.camera.projectionMatrix),e.setUniform2f("uDepthBias",.5,-4e-4),e.setUniform2f("uPixelToNDC",2/s.camera.fullViewport[2],2/s.camera.fullViewport[3]),e.setUniform2f("uNDCToPixel",s.camera.fullViewport[2]/2,s.camera.fullViewport[3]/2),e.setUniform1f("uDistanceFalloffFactor",i.distanceFalloffFactor),e.setUniform2f("uViewportDimInv",1/s.camera.fullViewport[2],1/s.camera.fullViewport[3]),e.setUniform1f("uPixelRatio",s.camera.pixelRatio||1)}initializeProgram(t){const e=_R.shader.get(),i=this.configuration,s=e.build({slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,silhouette:i.silhouette,legacy:i.legacy,antialiasing:i.antialiasing,mode:i.mode,doublePrecisionRequiresObfuscation:i.doublePrecisionRequiresObfuscation,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new Xa(t.rctx,s,Zc)}initializePipeline(t){const e=t.rctx.capabilities.blendMinMax;return Gh(e?{blending:qh(1,1,0,1,32774,e.MAX),depthTest:{func:515},colorWrite:Wh}:{depthTest:{func:515},depthWrite:Qh,colorWrite:Wh})}}_R.shader=new $a(AR,(()=>import("./p-48448912.js"))),function(t){class e extends Qa{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.silhouette=!1,this.legacy=!1,this.antialiasing=!1,this.mode=0,this.doublePrecisionRequiresObfuscation=!1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}r([Za()],e.prototype,"slicePlaneEnabled",void 0),r([Za()],e.prototype,"silhouette",void 0),r([Za()],e.prototype,"legacy",void 0),r([Za()],e.prototype,"antialiasing",void 0),r([Za({count:3})],e.prototype,"mode",void 0),r([Za()],e.prototype,"doublePrecisionRequiresObfuscation",void 0),r([Za()],e.prototype,"multipassTerrainEnabled",void 0),r([Za()],e.prototype,"cullAboveGround",void 0),t.Configuration=e}(_R||(_R={}));const DR={type:"uber",slicePlaneEnabled:!1,sliceHighlightDisabled:!1,strokesTexture:null,legacy:!0};class OR{constructor(){this._value=0}get value(){return this._value}increment(){this._value++}decrement(){this._value--}}const RR={solid:0,sketch:1,uber:2};class FR{constructor(t,e,i){this.rctx=t,this.shaderTechniqueRepository=e,this.config=new _R.Configuration,this.technique=null,this.refCount=new OR,this.renderables=new Set,this.sortedRenderables={1:{1:new pt,2:new pt},2:{1:new pt,2:new pt}},this.renderablesDirty=!1,this.settings={...DR,...i},this.key=FR.getKey(this.settings.type,this.settings.slicePlaneEnabled,this.settings.legacy),this.writerSettings={variants:this.settings.strokesTexture.variants,reducedPrecision:lr.TESTS_DISABLE_OPTIMIZATIONS},this.config.legacy=this.settings.legacy,this.config.mode=RR[this.settings.type],this.config.silhouette=!1,this.config.antialiasing=!!this.rctx.capabilities.blendMinMax,this.config.slicePlaneEnabled=this.settings.slicePlaneEnabled,this.config.doublePrecisionRequiresObfuscation=Ga(t)}dispose(){this.technique=Z(this.technique)}addRenderable(t){this.renderables.add(t),this.renderablesDirty=!0}removeRenderable(t){this.renderables.delete(t),this.renderablesDirty=!0}setRenderablesDirty(){this.renderablesDirty=!0}forEachRenderable(t,e){this.renderablesDirty&&this.sortRenderables(),this.sortedRenderables[e][1].forAll(t),this.sortedRenderables[e][2].forAll(t)}setMultipassParameters(t){this.config.multipassTerrainEnabled=!!t.multipassTerrainEnabled&&t.multipassTerrainEnabled,this.config.cullAboveGround=!!t.cullAboveGround&&t.cullAboveGround}bindRegularEdges(t,e){this.setMultipassParameters(t),this.config.silhouette=!1,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(_R,this.config,this.technique),this.technique.bindPass({bindParameters:t,edgeRenderParameters:e}),this.technique.bindPipelineState(this.rctx,t.slot),this.rctx.useProgram(this.technique.program)}bindSilhouetteEdges(t,e){this.setMultipassParameters(t),this.config.silhouette=!0,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(_R,this.config,this.technique),this.technique.bindPass({bindParameters:t,edgeRenderParameters:e}),this.technique.bindPipelineState(this.rctx,t.slot),this.rctx.useProgram(this.technique.program)}renderRegularEdges(t,e,i){this.render(t,t.regular.vao,e,i)}renderSilhouetteEdges(t,e,i){this.render(t,t.silhouette.vao,e,i)}render(t,e,i,s){this.setUniforms(t,i),this.rctx.bindVAO(e),this.rctx.capabilities.instancing.drawArraysInstanced(6,0,4,s)}setUniforms(t,e){const i=this.technique.program;if(t.components.buffer.textureBuffer.bind(i,zR,LR),e.multipassTerrainEnabled&&(i.setUniform2fv("cameraNearFar",e.camera.nearFar),i.setUniform2fv("inverseViewport",e.inverseViewport),Nh(i,e)),"origin"in t.transform)i.setUniformMatrix4fv("uView",e.localViewMatrixForEdges),i.setUniformMatrix4fv("uModel",t.transform.modelMatrix),bh(i,this.settings,e.slicePlane,t.transform.origin.vec3);else{const s=new sD(t.transform.position),n=hn(ER,un(ER,t.transform.rotationScale)),r=new Q_;$i(r.worldFromModel_TL,s.low),$i(r.worldFromModel_TH,s.high),dn(r.worldFromModel_RS,t.transform.rotationScale),dn(r.transformNormal_GlobalFromModel,n),Ea.bindModelTransform(i,r),i.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",r.transformNormal_GlobalFromModel);const o=e.camera.viewInverseTransposeMatrix,a=ds(IR,o[3],o[7],o[11]);bh(i,this.settings,e.slicePlane,a)}"uber"!==this.settings.type&&"sketch"!==this.settings.type||this.setSketchUniforms(i),i.setUniform1f("uWorldLineRadiusPerDistance",Math.tan(e.camera.fovY/2)/(e.camera.fullViewport[3]/2))}setSketchUniforms(t){const e=this.settings.strokesTexture,i=e.texture;w(i)||(t.bindTexture(i,"uStrokesTexture"),t.setUniform2f("uStrokesTextureScale",1/i.descriptor.width,1/i.descriptor.height),t.setUniform1f("uStrokesLog2Resolution",Math.log2(e.resolution)),t.setUniform1f("uStrokesNormalizationScale",e.normalizationScale),t.setUniform1f("uStrokesAmplitude",e.amplitude),t.setUniform1f("uStrokeVariants",e.variants))}sortRenderables(){this.renderablesDirty=!1,this.sortedRenderables[1][1].clear(),this.sortedRenderables[1][2].clear(),this.sortedRenderables[2][1].clear(),this.sortedRenderables[2][2].clear(),this.renderables.forEach((t=>{0!==t.objectTransparency&&0!==t.edgeTransparency&&this.sortedRenderables[t.objectTransparency][t.edgeTransparency].push(t)}));const t=(t,e)=>"origin"in t.transform&&"origin"in e.transform?t.transform.origin.id<e.transform.origin.id?-1:t.transform.origin.id>e.transform.origin.id?1:0:0;this.sortedRenderables[1][1].sort(t),this.sortedRenderables[1][2].sort(t),this.sortedRenderables[2][1].sort(t),this.sortedRenderables[2][2].sort(t)}static getKey(t,e,i){return`edges-t:${t}:${e}:${i}`}}const zR="uComponentDataTex",LR="uComponentDataTexInvDim",ER=ve(),IR=js();class VR extends eu{constructor(t){super("EdgeProcessingWorker","wrappedWork",t)}async process(t,e,i){if(i)return Qc(t);const s=this._packInput(t),n=await this.invoke(s,e);return this._unpackOutput(n)}getTransferList(t){return[t.dataBuffer]}_packInput(t){return{dataBuffer:t.data.buffer,writerSettings:t.writerSettings,skipDeduplicate:t.skipDeduplicate,indicesBuffer:t.indices.buffer,indicesType:Gt(t.indices)?"Uint32Array":"Uint16Array",indicesLength:t.indicesLength}}_unpackOutput(t){return{regular:{instancesData:Yc(t.regular.instancesData),lodInfo:{lengths:new Float32Array(t.regular.lodInfo.lengths)}},silhouette:{instancesData:Yc(t.silhouette.instancesData),lodInfo:{lengths:new Float32Array(t.silhouette.lodInfo.lengths)}},averageEdgeLength:t.averageEdgeLength}}}function jR(t,e){if(!t)return null;const i=t.length/2,s=NR*i,n=new Array(i);let r=0;const o=1===e;for(let e=0;e<t.length;e+=2){const i=(t[e]+t[e+1])/2;n[r++]=o?Math.min(s,1-(1-i)*kR):Math.min(s,i*kR)}return n}const NR=.1,kR=.5;class BR{constructor(t,e,i,s,n){this.resolution=t,this.normalizationScale=e,this.amplitude=i,this.variants=s,this.texture=n}dispose(){this.texture=Q(this.texture)}}const GR=8,qR=256,WR=[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}];function UR(t){let e=null;for(const i of t){const t=i.type;if(QR(i))if(w(e))e=t;else if(e!==t)return"uber"}return p(e)?e:"solid"}function HR(t){let e=0;for(const{material:i}of t)if(QR(i)){if(i.color[3]*i.opacity<1)return 1;e=2}return e}function ZR(t){let e=0;for(const{material:i}of t)if(QR(i)){switch(i.objectTransparency){case 1:case 0:return 1;case 2:if(i.opacity<1)return 1}e=2}return e}function QR(t){return t.size*t.color[3]*t.opacity>0}function YR(t,e,i){return t.length-function(t,e){const i=qt(t,e,!0);return-1===i?e<t[0]?0:t.length:i}(t,e*i.minimumEdgeLength)}function XR(t,e,i,s){for(let n=0;n<t.length;n++){const r=t[n].index,o=e[n],a=e[n+1];if(s)for(let t=o;t<a;t++)i.set(s[t],r);else for(let t=o;t<a;t++)i.set(t,r)}}const KR=y.getLogger("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView");let $R=class extends T{constructor(t){super(t),this.updatingHandles=new Pl,this.perObjectData=new Map,this.perObjectDataEvictionCache=new Set,this.renderers=new Map,this.numberOfRenderedEdges=0,this.gpuMemoryUsage=0,this.workerAbort=new AbortController,this.tmpModelPosition=js(),this.localOrigins=new mR(new Rr(t.renderSR))}initialize(){this.worker=new VR(this.schedule),this.componentColorManager=new hD(this.rctx,2);const t=Xc.createBuffer(4);for(let e=0;e<4;e++)t.sideness.set(e,0,0===e||3===e?0:1),t.sideness.set(e,1,0===e||1===e?0:1);this.verticesBufferObject=pl.createVertex(this.rctx,35044,t.buffer)}destroy(){this.destroyed||(this.perObjectData.forEach((t=>this._discardObjectEntry(t))),this.perObjectData.clear(),this.strokesTexture=Q(this.strokesTexture),this.componentColorManager=Y(this.componentColorManager),this.workerAbort.abort(),this.worker.destroy(),this.verticesBufferObject=Q(this.verticesBufferObject),this.renderers.clear(),this.updatingHandles.destroy())}get updating(){return this.updatingHandles.updating}get usedMemory(){return this.gpuMemoryUsage}get numberOfRenderedPrimitives(){return this.numberOfRenderedEdges}shouldRender(){return this.renderers.size>0}async addComponentObject(t,e,i,s,n,r,o,a){if(this.hasObject(t))return;let h;const l=new JR(new Promise((t=>h=t)),i.center,i.radius);this.perObjectData.set(t,l),await this.updatingHandles.addPromise(this.addComponentGeometry(e,l,s,n,r,o,a)),this.setNeedsRender(),h()}async addOrUpdateObject3D(t,e,i,s){if(this.destroyed)return void KR.warn("Attempt to add an object to a destroyed instance");const n=this.perObjectData.get(t);let r;(null==n?void 0:n.renderables.length)>0&&this.perObjectDataEvictionCache.add(n);const o=t.boundingVolumeWorldSpace.bounds,a=new JR(new Promise((t=>r=t)),Zo(o),Yo(o));this.perObjectData.set(t,a);const h=new Array;if(i.mergeGeometries&&t.geometries.length>1&&function(t){let e=null,i=null;for(let n=0;n<t.geometries.length;n++){var s;const r=t.geometryRecords[n];if(r.material.supportsEdges){if(e){if(!Lt(e,r.transformation))return!1}else e=r.transformation;if(!i&&p(r.origin))i=r;else if(p(null==(s=i)?void 0:s.origin)&&p(r.origin)&&i.origin.id!==r.origin.id)return!1}}return!0}(t))h.push(this.addObjectMergedGeometries(t,a,e,i,s));else for(let n=0;n<t.geometries.length;n++){const r=t.geometryRecords[n];r.material.supportsEdges&&h.push(this.addGeometry(t,a,t.geometries[n],r,e[0],i,s))}await this.updatingHandles.addPromise(Promise.all(h)),this.perObjectDataEvictionCache.delete(a),this._discardObjectEntry(n),this.setNeedsRender(),r()}_discardObjectEntry(t){t&&(t.renderables.length&&(t.renderables.forEach((t=>this.removeRenderable(t))),this.setNeedsRender()),t.loaded=null)}hasObject(t){return this.perObjectData.has(t)}async updateAllComponentOpacities(t,e){const i=e instanceof Array?t=>e[t]:()=>e;(await this.updatingHandles.addPromise(this.getObjectEntry(t))).renderables.forEach((t=>{const e=t.components.meta.length;for(let s=0;s<e;s++){const e=i(s),n=t.components.meta[s],r=n.index;n.material.opacity=e,t.components.buffer.textureBuffer.setDataElement(r,1,3,255*e)}this.updateTransparency(t)})),this.setNeedsRender()}async updateAllComponentMaterials(t,e,i,s){const n=t instanceof mc,r=!!i.slicePlaneEnabled,o=UR(e),a=FR.getKey(o,r,n);(await this.updatingHandles.addPromise(this.getObjectEntry(t))).renderables.forEach((t=>{if(a!==t.rendererKey){const e=this.renderers.get(t.rendererKey),i=this.acquireRenderer(o,r,n);e.removeRenderable(t),e.refCount.decrement(),t.rendererKey=a,i.addRenderable(t)}for(let i=0;i<e.length;i++)t.components.meta[i].material=e[i];s&&this.updateComponentBuffer(t.components),this.updateTransparency(t)})),this.setNeedsRender()}async updateObjectVisibility(t,e){(await this.updatingHandles.addPromise(this.getObjectEntry(t))).renderables.forEach((t=>t.visible=e)),this.setNeedsRender()}removeObject(t){const e=this.perObjectData.get(t);e&&(this.perObjectData.delete(t),this._discardObjectEntry(e))}async getObjectEntry(t){const e=this.perObjectData.get(t);if(!e)throw"no object";return await e.loaded,e}removeAll(){this.perObjectData.forEach(((t,e)=>this.removeObject(e)))}render(t,e){if(w(this.componentColorManager))return;this.localOrigins.updateViewMatrices(t.camera.viewMatrix);const i=t.camera.viewInverseTransposeMatrix,s=js(),n=new sD,r=new Ea.ViewProjectionTransform,o=pn();ds(s,i[3],i[7],i[11]),n.set(s),$i(r.worldFromView_TH,n.high),$i(r.worldFromView_TL,n.low),an(r.viewFromCameraRelative_RS,t.camera.viewMatrix),io(r.projFromView,t.camera.projectionMatrix);const a=pn();hn(a,r.viewFromCameraRelative_RS),un(o,a);let h=0,l=0;if(this.renderers.forEach((t=>{0===t.refCount.value?(this.renderers.delete(t.key),t.dispose()):t.forEachRenderable((t=>{h+=t.statistics.averageEdgeLength,l++}),e)})),this.componentColorManager.garbageCollect(),this.componentColorManager.updateTextures(),0===l)return;const c={distanceFalloffFactor:40*h/l,minimumEdgeLength:t.camera.perScreenPixelRatio,transparency:e,viewProjectionTransform:r,transformNormal_ViewFromGlobal:o};this.updateObjectCameraDistances(t),this.numberOfRenderedEdges=0,this.renderers.forEach((e=>{this.renderRegularEdges(e,t,c),this.renderSilhouetteEdges(e,t,c)}))}updateTransparency(t){const e=HR(t.components.meta),i=ZR(t.components.meta);e===t.edgeTransparency&&i===t.objectTransparency||(t.edgeTransparency=e,t.objectTransparency=i,this.renderers.get(t.rendererKey).setRenderablesDirty())}computeModelTransformWithLocalOrigin(t,e,i){if(t.getCombinedStaticTransformation(e,i),p(e.origin))this.localOrigins.register(e.origin);else{const t=ds(this.tmpModelPosition,i[12],i[13],i[14]);e.origin=this.localOrigins.acquire(t)}return function(t,e){const i=e,s=-t[0],n=-t[1],r=-t[2],o=i[3],a=i[7],h=i[11],l=i[15];i[0]+=o*s,i[1]+=o*n,i[2]+=o*r,i[4]+=a*s,i[5]+=a*n,i[6]+=a*r,i[8]+=h*s,i[9]+=h*n,i[10]+=h*r,i[12]+=l*s,i[13]+=l*n,i[14]+=l*r}(e.origin.vec3,i),e.origin}updateComponentBuffer(t){const{meta:e,buffer:i}=t;for(let t=0;t<e.length;t++){const s=e[t].material,n=e[t].index,r=fs(Math.round(8*s.size),0,255),o=fs(s.extensionLength,-128,127)+128,a="solid"===s.type?0:1,h=255*s.opacity,l=s.color;i.textureBuffer.setData(n,0,255*l[0],255*l[1],255*l[2],255*l[3]),i.textureBuffer.setData(n,1,r,o,a,h)}}createComponentBuffers(t){if(w(this.componentColorManager))return null;const e=new Array,i=this.componentColorManager.getBuffer(t.length);for(let s=0;s<t.length;s++){const n=t[s],r=i.acquireIndex();e.push({index:r,material:n})}const s={meta:e,buffer:i};return this.updateComponentBuffer(s),s}extractEdges(t,e,i,s,n,r=n.length){return this.worker.process({data:e,indices:n,indicesLength:r,writerSettings:t,skipDeduplicate:i},this.workerAbort.signal,s)}createEdgeResources(t){const e={};if(w(this.verticesBufferObject))return e;if(t.regular.lodInfo.lengths.length>0){const i=new dl(this.rctx,Zc,{vertices:Kc,instances:$c.glLayout},{vertices:this.verticesBufferObject,instances:pl.createVertex(this.rctx,35044,t.regular.instancesData.buffer)});e.regular={vao:i,lod:t.regular.lodInfo}}if(t.silhouette.lodInfo.lengths.length>0){const i=new dl(this.rctx,Zc,{vertices:Kc,instances:Jc.glLayout},{vertices:this.verticesBufferObject,instances:pl.createVertex(this.rctx,35044,t.silhouette.instancesData.buffer)});e.silhouette={vao:i,lod:t.silhouette.lodInfo}}return e}async addGeometry(t,e,i,s,n,r,o){const a=i.vertexAttributes.get("position"),h=i.indices.get("position"),l=gn(),c={position:a,indices:h,modelTransform:l,origin:this.computeModelTransformWithLocalOrigin(t,s,l)};return this.addPositionData(e,c,i.edgeIndicesLength,n,r,o)}async addPositionData(t,e,i,s,n,r=!1){if(null==t.loaded)return;const o=this.createComponentBuffers([s]);if(w(o)||i<=0)return;const a=this.acquireRenderer(s.type,!!n.slicePlaneEnabled),{modelTransform:h,origin:l}=e,c=e.indices,u=e.position,d=u.data.length/u.size,p=tu.createBuffer(d);for(let t=0;t<d;t++)p.position.set(t,0,u.data[t*u.size+0]),p.position.set(t,1,u.data[t*u.size+1]),p.position.set(t,2,u.data[t*u.size+2]);XR(o.meta,[0,p.componentIndex.count],p.componentIndex);const f=await this.updatingHandles.addPromise(this.extractEdges(a.writerSettings,p,!1,r,c,i));if(null==t.loaded)return;const{regular:g,silhouette:m}=this.createEdgeResources(f),v=(g?g.vao.size:0)+(m?m.vao.size:0),y={regular:g,silhouette:m,transform:{modelMatrix:h,origin:l},statistics:{gpuMemoryUsage:v,averageEdgeLength:f.averageEdgeLength},components:o,visible:!0,edgeTransparency:HR(o.meta),objectTransparency:ZR(o.meta),distanceToCamera:0,rendererKey:a.key};t.renderables.push(y),a.addRenderable(y),this.gpuMemoryUsage+=v}async addComponentGeometry(t,e,i,s,n,r,o){if(null==e.loaded)return;const a=this.createComponentBuffers(r);if(w(a))return;const h=UR(r),l=this.acquireRenderer(h,o.slicePlaneEnabled||!1,!1),c=tu.createBuffer(i.count);Hc(c.position,i),XR(a.meta,n,c.componentIndex,s);const u=l.writerSettings,d=await this.updatingHandles.addPromise(this.extractEdges(u,c,!0,!1,s));if(null==e.loaded)return;const{regular:p,silhouette:f}=this.createEdgeResources(d),g=(p?p.vao.size:0)+(f?f.vao.size:0),m={regular:p,silhouette:f,transform:t,statistics:{gpuMemoryUsage:g,averageEdgeLength:d.averageEdgeLength},components:a,visible:!0,edgeTransparency:HR(a.meta),objectTransparency:ZR(a.meta),distanceToCamera:0,rendererKey:l.key};e.renderables.push(m),l.addRenderable(m),this.gpuMemoryUsage+=g}async addObjectMergedGeometries(t,e,i,s,n){const r=new Map;let o=0,a=null,h=0;for(let e=0;e<t.geometries.length;e++){const i=t.geometries[e],s=t.geometryRecords[e];if(!s.material.supportsEdges)continue;!a&&s.origin&&(a=s);const n=i.vertexAttributes.get("position");h+=n.data.length/n.size,o+=i.edgeIndicesLength}const l=h>=65536?Uint32Array:Uint16Array,c=o?new l(o):null,u=[];let d=0;for(let e=0;e<t.geometries.length;e++){const i=t.geometries[e];if(!t.geometryRecords[e].material.supportsEdges)continue;const s=i.vertexAttributes.get("position"),n=i.indices.get("position");let o=r.get(s.data);if(null==o){o=u.length/3;for(let t=0;t<s.data.length;t+=s.size)u.push(s.data[t+0]),u.push(s.data[t+1]),u.push(s.data[t+2]);r.set(s.data,o)}if(n)for(let t=0;t<i.edgeIndicesLength;t++)c[d++]=o+n[t]}const p=a||t.geometryRecords[0],f=gn(),g=this.computeModelTransformWithLocalOrigin(t,p,f);for(let e=0;e<t.geometryRecords.length;e++)t.geometryRecords[e].origin=g;const m={position:{data:u,size:3},indices:c,modelTransform:f,origin:g};await this.updatingHandles.addPromise(this.addPositionData(e,m,c.length,i[0],s,n))}acquireRenderer(t,e,i=!0){const s=FR.getKey(t,e,i);let n=this.renderers.get(s);return w(this.strokesTexture)&&(this.strokesTexture=function(t){const e=qR,i=e/2,s=new Uint8Array(4*e*e),n=4*e*i,r=GR,o=2*r,a=4*e,h=Math.log2(e)+1,l=WR.length;let c=(h-1)*l*a;for(const{distance:t,pressure:e}of WR){let i=t,r=e,u=c;for(let t=0;t<h;t++){0!==t&&(i=jR(i,0),r=jR(r,1));for(let t=0;t<qR;t++){const e=r?r[t%r.length]:1;Uc(.5+(i?i[t%i.length]/o:0),s,u),Uc(e,s,u+n),u+=4}u-=a*(l+1)}c+=a}const u=new ml(t,{pixelFormat:6408,dataType:5121,hasMipmap:!1,samplingMode:9729,width:e,height:e,wrapMode:10497},s);return new BR(e,o,r,l,u)}(this.rctx)),n||(n=new FR(this.rctx,this.techniqueRepository,{type:t,slicePlaneEnabled:e,strokesTexture:this.strokesTexture,legacy:i}),this.renderers.set(s,n)),n.refCount.increment(),n}removeRenderable(t){!function(t){t.regular&&(t.regular.vao.vertexBuffers.instances.dispose(),t.regular.vao.dispose(!1),t.regular.vao=null),t.silhouette&&(t.silhouette.vao.vertexBuffers.instances.dispose(),t.silhouette.vao.dispose(!1),t.silhouette.vao=null)}(t);const e=this.renderers.get(t.rendererKey);if(e){e.removeRenderable(t),e.refCount.decrement(),"origin"in t.transform&&this.localOrigins.release(t.transform.origin),this.gpuMemoryUsage-=t.statistics.gpuMemoryUsage;for(const e of t.components.meta)t.components.buffer.releaseIndex(e.index)}}updateObjectCameraDistances(t){const e=t.camera.eye,i=t.camera.viewForward,s=js(),n=t=>{const{center:n,radius:r}=t;Fs(s,n,e);const o=es(s,i),a=o<-r?1/0:o<r?0:o-r;t.renderables.forEach((t=>t.distanceToCamera=a))};this.perObjectData.forEach(n),this.perObjectDataEvictionCache.forEach(n)}renderRegularEdges(t,e,i){t.bindRegularEdges(e,i),t.forEachRenderable((s=>{if(!s.visible||!s.regular)return;const n=YR(s.regular.lod.lengths,s.distanceToCamera,i);"origin"in s.transform&&(e.localViewMatrixForEdges=this.localOrigins.getViewMatrix(s.transform.origin)),t.renderRegularEdges(s,e,n),this.numberOfRenderedEdges+=n}),i.transparency)}renderSilhouetteEdges(t,e,i){t.bindSilhouetteEdges(e,i),t.forEachRenderable((s=>{if(!s.visible||!s.silhouette)return;const n=YR(s.silhouette.lod.lengths,s.distanceToCamera,i);"origin"in s.transform&&(e.localViewMatrixForEdges=this.localOrigins.getViewMatrix(s.transform.origin)),t.renderSilhouetteEdges(s,e,n),this.numberOfRenderedEdges+=n}),i.transparency)}};r([o({constructOnly:!0})],$R.prototype,"rctx",void 0),r([o({constructOnly:!0})],$R.prototype,"renderSR",void 0),r([o({constructOnly:!0})],$R.prototype,"techniqueRepository",void 0),r([o({constructOnly:!0})],$R.prototype,"setNeedsRender",void 0),r([o({constructOnly:!0})],$R.prototype,"schedule",void 0),r([o({readOnly:!0})],$R.prototype,"updatingHandles",void 0),r([o({readOnly:!0})],$R.prototype,"updating",null),$R=r([a("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],$R);class JR{constructor(t,e,i){this.center=e,this.radius=i,this.renderables=new Array,this.loaded=t,this.loaded.then((()=>{null!=this.loaded&&(this.loaded=!0)}))}}function tF(t){const e=t.capabilities.disjointTimerQuery;return w(e)?null:e.timestampBits()>0?new eF(e):sF?null:new iF(e)}class eF{constructor(t){this.timer=t,this.start=t.createQuery(),t.createTimestamp(this.start)}stop(t,e=50){this.end=this.timer.createQuery(),this.timer.createTimestamp(this.end),this.checkQueryResult(t,e)}checkQueryResult(t,e){if(!this.timer.resultAvailable(this.end))return void setTimeout((()=>this.checkQueryResult(t,e)),e);if(this.timer.disjoint())return void t(null);const i=this.timer.getResult(this.start),s=this.timer.getResult(this.end);t((s-i)/1e6)}}class iF{constructor(t){this.timer=t,this.query=t.createQuery(),sF=!0,this.timer.beginTimeElapsed(this.query)}stop(t,e=50){this.timer.endTimeElapsed(),sF=!1,this.checkQueryResult(t,e)}checkQueryResult(t,e){const i=this.timer.resultAvailable(this.query),s=this.timer.disjoint();if(!i||s)s?t(null):setTimeout((()=>this.checkQueryResult(t,e)),e);else{const e=this.timer.getResult(this.query);t(e/1e6)}}}let sF=!1;const nF=["prepare","shadowmap","lineardepth","normals","ssao","opaque","opaque edges","transparent","transparent edges","hudvisibility","transparent terrain","atmosphere","laserline","occluded","antialiasing","highlights","hudOccluded","hudNotoccluded"];class rF extends Wt{constructor(){super("total"),this.total=0,this.frameCount=0}}class oF{constructor(){this._startTime=0,this._lastSample=0,this._enableGPUTimer=0,this.totalTime=new rF,this.gpuTime=new Wt("gpu",9),this.renderPassTimings=nF.map((t=>new Wt(t)))}enableGPUTimer(){return++this._enableGPUTimer,{remove:Ut((()=>--this._enableGPUTimer))}}prerender(t){this._startTime=this._lastSample=performance.now(),this._enableGPUTimer&&(this._gpuTimer=tF(t))}advance(t){const e=performance.now();this.renderPassTimings[t].record(e-this._lastSample),this._lastSample=e}postrender(){p(this._gpuTimer)&&(this._gpuTimer.stop((t=>p(t)&&this.gpuTime.record(t)),16),this._gpuTimer=null);const t=performance.now()-this._startTime;this.totalTime.record(t),this.totalTime.total+=t,this.totalTime.frameCount++}}let aF=class extends T{constructor(t,e,i,s,n,r,o,a,h){super({}),this._materialRepository=t,this._shaderTechniqueRepository=i,this._rctx=s,this._compositingHelper=n,this._magnifierHelper=r,this._requestRender=o,this._stage=h,this._materialRenderers=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._hasWater=!1,this._hasOverlayWater=!1,this._content=new Map,this._isRendering=!1,this._fallbackDepthStencilTexture=null,this.performanceInfo=new oF,this._antialiasing=1,this._oitEnabled=!1,this._multipassTerrain=!0,this._opaqueTerrain=!0,this._lighting=new Vr,this._enableNewAtmosphere=!1,this._handles=new E,this.renderHiddenTransparentEdges=()=>{},this._smaaPass=new hR(this._rctx,i),this._oitEnabled=this._hasOITSupport,this._enableNewAtmosphere=ca(),this._requestRender(),this._offscreenRendering=new $D(this._rctx,this._compositingHelper),this._sliceHelper=new sR,this._shadowMap=new uO(this._rctx,h.viewingMode,2),this._ssaoHelper=new pR(i,this._rctx,(()=>this._requestRender())),this._highlightHelper=new QD(i,this._rctx),this._shadowHighlightHelper=new tR(this._rctx,h.viewingMode),this._shadowAccumulator=new UO(this._rctx,i,h,((t,e)=>{this.renderPassManager.shadowCastingEnabled=!0,this._renderPlugins.prepareRender(t,e),this.renderPassManager.shadowCastingEnabled=this._shadowMap.enabled}),((t,e,i,s)=>{t.start(i,e,s),this.renderShadowCascades(4,t),i.setGLViewport(this._rctx),this.ensureCameraBindParameters(i)}),(()=>this._requestRender())),this._bindParameters={slot:null,camera:null,inverseViewport:Sa(),shadowMap:this._shadowMap,shadowMappingEnabled:this._shadowMap.enabled,ssaoHelper:this._ssaoHelper,ssaoEnabled:this._ssaoHelper.enabled,origin:null,screenToWorldRatio:null,screenToPCSRatio:null,slicePlane:this._sliceHelper.plane,highlightDepthTexture:null,hasOccludees:!1,linearDepthTexture:null,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,multipassGeometryEnabled:!1,cullAboveGround:!1,lastFrameColorTexture:null,reprojectionMatrix:vn,ssrEnabled:!1,lighting:this._lighting,highlightColorTexture:null},this._renderContext=new jr(this._rctx,this._offscreenRendering,this._lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderContext.multipassTerrainParams={camera:null,multipassTerrainEnabled:!1,cullAboveGround:!1,terrainLinearDepthTexture:null},this._renderContext.multipassGeometryParams={multipassGeometryEnabled:!1,geometryLinearDepthTexture:null},this._renderContext.ssrParams={camera:null,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:vn,ssrEnabled:!1},this._renderPlugins=new eO({renderContext:this._renderContext,shaderTechniqueRep:i,textureRep:e,materialRep:this._materialRepository,requestRender:this._requestRender,schedule:a}),this.renderPassManager=new kD(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._handles.add([tt(lr,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",(t=>{this.renderHiddenTransparentEdges=t?()=>this.renderEdges(1):()=>{},this._requestRender()})),tt(this._stage,"camera",(()=>this._requestRender()),!0)])}get hasWater(){return this._hasWater||this._hasOverlayWater}get hasWaterReflection(){return this.hasWater&&this._waterReflectionEnabled}normalizeCtorArgs(){return{}}dispose(){this._handles.destroy(),this._smaaPass.dispose(),this._materialRenderers.forEach((t=>t.dispose())),this._materialRenderers.clear(),this._edgeView=Y(this._edgeView),this._offscreenRendering.dispose(),this._fallbackDepthStencilTexture=Q(this._fallbackDepthStencilTexture),this._shadowMap.enabled=!1,this._shadowMap.dispose(),this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose(),this._highlightHelper.dispose(),this._shadowHighlightHelper.dispose(),this._shadowAccumulator.dispose(),kh.prune(),this._content.clear()}get updating(){return 1===this._antialiasing&&this._smaaPass.updating||p(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}ensureEdgeView(){return w(this._edgeView)&&(this._edgeView=new $R({rctx:this._rctx,renderSR:this._stage.renderSR,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:t=>this._stage.resourceController.schedule(t)}),this._handles.add(this._edgeView.watch("updating",(()=>this._requestRender()),!0)),this._requestRender()),this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return null===this._bindParameters.reprojectionMatrix||uo(this._bindParameters.reprojectionMatrix,vn)}set _reprojectionMatrix(t){uo(this._bindParameters.reprojectionMatrix,t)||(this._bindParameters.reprojectionMatrix=t,this.notifyChange("isCameraFinal"))}get hasShadowsEnabled(){var t;return!(null==(t=this._shadowMap)||!t.enabled)}setRenderParameters(t){const{renderPassManager:e,_shadowMap:i,_ssaoHelper:s}=this;void 0!==t.screenSpaceReflectionsEnabled&&e.screenSpaceReflectionsEnabled!==t.screenSpaceReflectionsEnabled&&(e.screenSpaceReflectionsEnabled=t.screenSpaceReflectionsEnabled,this._requestRender()),void 0===t.shadowMap||i.enabled===t.shadowMap&&e.shadowCastingEnabled===t.shadowMap||(i.enabled=t.shadowMap,e.shadowCastingEnabled=t.shadowMap,this._requestRender()),void 0!==t.shadowMapMaxCascades&&i.maxCascades!==t.shadowMapMaxCascades&&(i.maxCascades=t.shadowMapMaxCascades,this._requestRender()),void 0!==t.ssao&&s.enabled!==t.ssao&&(s.enabled=t.ssao,this._requestRender()),t.background&&this._offscreenRendering.background!==t.background&&(this._offscreenRendering.background=t.background,this._requestRender());const n=t.antialiasingEnabled?1:0;void 0!==t.antialiasingEnabled&&this._antialiasing!==n&&(this._antialiasing=n,this._requestRender()),void 0!==t.highQualityTransparency&&this._multipassTerrain!==t.highQualityTransparency&&(this._multipassTerrain=t.highQualityTransparency,this._oitEnabled=t.highQualityTransparency&&this._hasOITSupport,this._requestRender()),void 0!==t.defaultHighlightOptions&&(this._highlightHelper.setDefaultOptions(t.defaultHighlightOptions),this._shadowHighlightHelper.setDefaultOptions(t.defaultHighlightOptions),this._requestRender()),void 0!==t.slicePlane&&this._sliceHelper.plane!==t.slicePlane&&(this._sliceHelper.plane=P(t.slicePlane),this._requestRender()),void 0!==t.waterReflectionEnabled&&this._waterReflectionEnabled!==t.waterReflectionEnabled&&(this._waterReflectionEnabled=t.waterReflectionEnabled,this._requestRender()),void 0!==t.opaqueTerrain&&this._opaqueTerrain!==t.opaqueTerrain&&(this._opaqueTerrain=t.opaqueTerrain,this._requestRender()),void 0!==t.hasOverlayWater&&this._hasOverlayWater!==t.hasOverlayWater&&(this._hasOverlayWater=t.hasOverlayWater,this._requestRender()),void 0!==t.shadowCastOptions&&this._shadowAccumulator.setOptions(t.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlendWorking}modify(t){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:e,removes:i,updates:s}=t;if(0===e.length&&0===i.length&&0===s.length)return;i.forAll((({id:t})=>this._content.delete(t))),e.forAll((t=>this._content.set(t.id,t)));const n=Nr(t);let r=!1;n.forEach(((t,e)=>{let i=this._materialRenderers.get(e);if(!i){if(!(t.adds.length>0))return;i=new kr(this._rctx,this._materialRepository,e),this._materialRenderers.set(e,i)}i.modify(t),i.isEmpty&&(r=!0)})),r&&this._materialRenderers.forEach(((t,e)=>{t.isEmpty&&(this._materialRenderers.delete(e),t.dispose())})),this._hasHighlights=ft(this._materialRenderers,(t=>t.hasHighlights)),this._hasOccludees=ft(this._materialRenderers,(t=>t.hasOccludees)),this._hasWater=ft(this._materialRenderers,(t=>t.hasWater)),this._requestRender()}updateLogic(t){let e=!1;return this._materialRenderers.forEach((i=>e=i.updateLogic(t)||e)),e}updateLightSources(t,e,i){this._lighting.groundLightingFactor=e,this._lighting.globalFactor=i,this._lighting.set(t)}render(t,e,i,s){this._isRendering=!0,this.performanceInfo.prerender(this._rctx),this._bindParameters.lighting=this._lighting,this._renderContext.hasOccludees=this._hasOccludees,this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=3;const n=this._offscreenRendering;n.needLastFrameColorTexture=this.hasWaterReflection,n.advanceCurrentRenderTarget();const r=this._sliceHelper.plane;0===s&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(t),e.setGLViewport(this._rctx),this.needsShadowCast&&(this.renderPassManager.shadowCastingEnabled=!0),this._renderPlugins.prepareRender(e,i),this.performanceInfo.advance(0);const o=this.computeDepthRange(e);this.renderShadowMap(t,e,this._lighting.lightingMainDirection,o),this.performanceInfo.advance(1),n.initializeFrame(e),this.ensureBindParameters(e),this.renderLinearDepth(),this.performanceInfo.advance(2),this.accumulateShadows(o,e,i),this.renderNormal(),this.performanceInfo.advance(3),this.ensureBindParametersSSR(),this._ssaoHelper.computeSSAO(e,n.linearDepthTexture,n.normalTexture),this.performanceInfo.advance(4),this._renderContext.pass=0,n.bindFramebuffer(),this.renderOpaqueGeometry(),this.performanceInfo.advance(5);const a=this._multipassTerrain&&!this._opaqueTerrain;this.renderTerrainLinearDepth(a),this.setMultipassFlags(a),this.setTerrainCulling(a),this.renderEdges(2),this.performanceInfo.advance(6),this.renderHiddenTransparentEdges(),this._oitEnabled?this.renderOrderIndependentTransparency((()=>this.renderTransparentGeometry()),!1):this.renderTransparentGeometry(),this.performanceInfo.advance(7),this.renderGeometryLinearDepth(a);const h={hudVisibility:!1,transparentTerrain:!1};h.hudVisibility=this.renderHUDVisibility(),a||this.renderInternalSlot(18),this.performanceInfo.advance(9),this.renderEdges(1,a),this.performanceInfo.advance(8),h.transparentTerrain=this.renderTransparentTerrain(),h.transparentTerrain&&h.hudVisibility&&(a?this.renderLineCallouts(0):n.compositeTransparentTerrainOntoHUDVisibility(),this.renderHUD(0,n.framebuffer),this.performanceInfo.advance(16)),this.performanceInfo.advance(10),this.setTerrainCulling(!1),h.transparentTerrain&&(n.compositeTransparentTerrainOntoMain(),a&&(this.renderEdges(2),this.performanceInfo.advance(6),this._oitEnabled?this.renderOrderIndependentTransparency((()=>this.renderTransparentGeometry()),!1):this.renderTransparentGeometry(),this.performanceInfo.advance(7),this.renderEdges(1),this.performanceInfo.advance(8))),a&&this.renderLineCallouts(1),this.setMultipassFlags(!1),this._shadowAccumulator.render(),n.renderToTargets((()=>{this.renderInternalSlot(7),this.renderSlot(13),this.renderSlot(14)}),n.currentColorTarget,n.mainDepth),this.performanceInfo.advance(11),this._renderPlugins.needsLaserlineWithContrastControl&&n.renderTmpAndCompositeToMain((()=>this.renderSlot(15)),2),this.performanceInfo.advance(12),this.renderOccluded(),this.performanceInfo.advance(13);const l=1===s&&this._magnifierHelper.enabled,c=l&&w(t)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):t;this._rctx.bindFramebuffer(c);const u=this._offscreenRendering.colorTexture;!this.renderAntiAliasing(this._antialiasing,u)&&p(u)&&this._compositingHelper.composite(u,0),this.performanceInfo.advance(14),this.renderHUD(1,c),this.performanceInfo.advance(17),this.renderHighlights(c,this._bindParameters),this.performanceInfo.advance(15),l&&this._magnifierHelper.render(this._rctx,this._bindParameters),c!==t&&(this._rctx.bindFramebuffer(t),this._compositingHelper.composite(this._offscreenRendering.tmpColorTexture,0)),this._renderContext.lastFrameCamera.copyFrom(this._renderContext.camera),this._sliceHelper.plane=r,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.postrender()}readDepthPixels(t,e,i,s,n,r){const o=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);this._needsLinearDepth||(this.ensureBindParameters(t),this._renderContext.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(17664),this.renderGeometryAndTransparentTerrainPass(2)),o.readPixels(e,i,s,n,6408,5121,r)}readAccumulatedShadow(t,e){return this._shadowAccumulator.readAccumulatedShadow(t,e)}setMultipassFlags(t){this._renderContext.multipassTerrainParams.multipassTerrainEnabled=this._bindParameters.multipassTerrainEnabled=t,this._renderContext.multipassGeometryParams.multipassGeometryEnabled=this._bindParameters.multipassGeometryEnabled=t}setTerrainCulling(t){this._renderContext.multipassTerrainParams.cullAboveGround=this._bindParameters.cullAboveGround=t}renderSlot(t){return this._renderContext.slot=t,this._renderPlugins.render()}renderEdges(t,e=!1){const i=this._edgeView;p(i)&&i.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain((()=>i.render(this._bindParameters,t)),1,e)}renderShadowMap(t,e,i,s){const n=this._shadowMap;n.enabled&&(n.start(e,i,s),this.needsShadowHighlight?(this.renderShadowCascades(7,this._shadowMap,(t=>n.takeCascadeSnapshotTo(t,0))),n.clear(),this.renderShadowCascades(6,this._shadowMap,(t=>{n.takeCascadeSnapshotTo(t,1),this.renderGeometryAndTransparentTerrainPass(7)}))):this.renderShadowCascades(4),n.finish(t),e.setGLViewport(this._rctx))}renderShadowCascades(t,e=this._shadowMap,i=(()=>{})){for(const s of e.getCascades())s.camera.setGLViewport(this._rctx),this.ensureCameraBindParameters(s.camera),this.renderGeometryAndTransparentTerrainPass(t),i(s)}get _needsLinearDepth(){return this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled||this.needsShadowHighlight||this.needsShadowCast||this._enableNewAtmosphere}renderLinearDepth(){this._needsLinearDepth?this._offscreenRendering.renderToTargets((()=>this.renderGeometryAndTransparentTerrainPass(2)),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth),this._renderContext.ssrParams.linearDepthTexture=this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture}renderTerrainLinearDepth(t){if(t){const t=this._renderContext.pass;this._renderContext.pass=2,this._offscreenRendering.renderToTargets((()=>this.renderTransparentTerrain()),this._offscreenRendering.terrainLinearDepth,this._offscreenRendering.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.pass=t}else this._offscreenRendering.disposeTarget(this._offscreenRendering.terrainLinearDepth);this._renderContext.multipassTerrainParams.terrainLinearDepthTexture=this._bindParameters.terrainLinearDepthTexture=this._offscreenRendering.terrainLinearDepthTexture}renderGeometryLinearDepth(t){if(t){const t=this._renderContext.pass;this._offscreenRendering.renderToTargets((()=>this.renderGeometryPass(2)),this._offscreenRendering.geometryLinearDepth,this._offscreenRendering.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.pass=t}else this._offscreenRendering.disposeTarget(this._offscreenRendering.geometryLinearDepth);this._renderContext.multipassGeometryParams.geometryLinearDepthTexture=this._bindParameters.geometryLinearDepthTexture=this._offscreenRendering.geometryLinearDepthTexture}get needsNormal(){return this._ssaoHelper.enabled}renderNormal(){this.needsNormal?this._offscreenRendering.renderToTargets((()=>{this.renderGeometryAndTransparentTerrainPass(3)}),this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)}get needsDepthRange(){return this._shadowMap.enabled||this.needsShadowCast}computeDepthRange(t){if(!this.needsDepthRange)return v_;const e=function(t,e,i){if(e.size<1e4)return RD.compute(t,e);const s=p_();return i.forAll((e=>{e.isVisible&&g_(s,function(t,e){if(!e.isVisible)return;const i=p_(),s=e.getSpatialQueryAccelerator();return p(s)?function(t,e,i){const s=e.eye,n=e.viewForward,r=e.frustum,o=t=>t.isVisible,a=i.objectCount;if(a<500)f_(DD,e.near,Math.min(t.near,e.far)),i.forEachInDepthRange(s,n,1,DD,((i,s)=>{MD(t,e,i),DD.far=t.near,s.setRange(DD)}),r,o),f_(DD,Math.max(t.far,e.near),e.far),i.forEachInDepthRange(s,n,-1,DD,((i,s)=>{MD(t,e,i),DD.near=t.far,s.setRange(DD)}),r,o);else{const s=Math.max(Math.min(a,500),Math.ceil(.1*a)),h=i.findClosest(n,1,r,o,s),l=i.findClosest(n,-1,r,o,s);h&&l&&(PD(t,e,h.boundingVolumeWorldSpace.bounds),PD(t,e,l.boundingVolumeWorldSpace.bounds))}}(i,t,s):function(t,e,i){OD.clear(),i.forAll((t=>{t.isVisible&&0!==t.geometryRecords.length&&OD.add(t)})),OD.empty||(OD.sort(e),f_(DD,e.near,Math.min(t.near,e.far)),OD.forEachInDepthRange(DD,1,((i,s)=>{s<t.near&&MD(t,e,i)})),f_(DD,Math.max(t.far,e.near),e.far),OD.forEachInDepthRange(DD,-1,((e,i,s)=>{t.far=Math.max(t.far,s)})))}(i,t,e.objects),i}(t,e))})),s}(t,this._content,this._stage.layers);return g_(e,this.renderPlugins.queryDepthRange(t)),e.near=Math.max(t.near,e.near),e.far=Math.min(t.far,e.far),e}renderGeometryAndTransparentTerrainPass(t){this._renderContext.pass=t,this.renderGeometryPass(t),this.renderTransparentTerrain()}renderGeometryPass(t){this._renderContext.pass=t,this.renderOpaqueGeometry(),this.renderTransparentGeometry()}renderOpaqueGeometry(){this.renderSlot(0),this.renderSlot(1),this.renderInternalSlot(2),this.renderSlot(3),this.renderSlot(12)}renderTransparentGeometry(){this.renderInternalSlot(4),this.renderSlot(5)}renderTransparentTerrain(){return this.renderSlot(6)}renderHUDVisibility(){let t=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility((()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper?this._renderContext.offscreenRenderingHelper.hudVisibilityTexture:null,t=this.renderInternalSlot(11)}),this._multipassTerrain&&!this._opaqueTerrain),t}renderLineCallouts(t){this._bindParameters.renderTransparentlyOccludedHUD=t,0===t?this._offscreenRendering.renderToTargets((()=>this.renderInternalSlot(18)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderInternalSlot(18)}renderHUD(t,e){this._oitEnabled?(this.renderOrderIndependentTransparency((()=>this.renderHUDElements(t)),!0),this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._offscreenRendering.hudColorTexture,2)):0===t?this._offscreenRendering.renderToTargets((()=>this.renderHUDElements(0)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderHUDElements(t)}renderHUDElements(t){this._bindParameters.renderTransparentlyOccludedHUD=t,this.renderInternalSlot(19),this.renderInternalSlot(16),this.renderInternalSlot(17)}get needsHighlight(){return this._hasHighlights||this._renderPlugins.needsHighlight}get needsShadowHighlight(){return this._shadowMap.enabled&&this._shadowHighlightHelper.isVisible&&this.needsHighlight}renderHighlights(t,e){if(!this.needsHighlight)return void this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight);const i=this._highlightHelper,s=i.profilingCallback&&tF(this._renderContext.rctx);this._renderContext.highlightDepthTexture=e.highlightDepthTexture;const n=this._offscreenRendering.renderToTargets((()=>{this.renderGeometryAndTransparentTerrainPass(5),this._rctx.clearSafe(256),this.renderHUDElements(2)}),this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=n.colorTexture,this.needsShadowHighlight&&this._shadowHighlightHelper.render(e,t),i.render(this._renderContext.camera,n,t),p(s)&&i.profilingCallback&&s.stop((t=>{i.profilingCallback&&i.profilingCallback(t)}))}get needsShadowCast(){return this._shadowAccumulator.isAccumulating}accumulateShadows(t,e,i){this.needsShadowCast&&(this._shadowAccumulator.setAccumulationDependencies(this._offscreenRendering.linearDepthTexture,t,e,i),this._shadowAccumulator.accumulateFixedSamples(),this.renderPassManager.shadowCastingEnabled=this._shadowMap.enabled)}renderOrderIndependentTransparency(t,e){const i=i=>{this._renderContext.transparencyPassType=i,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._offscreenRendering.renderOITPass((()=>t()),i,e)},s=this._renderContext.pass;this._renderContext.pass=1,i(1),this._renderContext.pass=0,i(0),i(2),this._offscreenRendering.compositeTransparentOntoOpaque(e),this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._renderContext.pass=s}renderOccluded(){let t=0;this._materialRenderers.forEach(((e,i)=>{i&&i.isVisible()&&8===i.renderOccluded&&(t|=i.renderOccluded,lF.push(i))}));const e=this._offscreenRendering,i=(i,s,n,r,o)=>{0!=(t&s)&&(e.renderToTargets(n,e.tmpColor,e.mainDepth,[0,0,0,0],r,o),e.compositeOccludedOntoMain(i))};0!==lF.length&&(this.renderInternalSlot(9,lF),i(.5,8,(()=>this.renderInternalSlot(10,lF)),!1,!1),lF.length=0),this._materialRenderers.forEach(((e,i)=>{i&&i.isVisible()&&(4===i.renderOccluded||2===i.renderOccluded||16===i.renderOccluded)&&(t|=i.renderOccluded,hF.push(i))}));const s=this._renderPlugins.renderOccludedFlags;if(t|=s,!t)return;const n=t=>{this._renderContext.renderOccludedMask=t,s>1&&this.renderSlot(8),this.renderInternalSlot(2,hF),this.renderInternalSlot(4,hF),this.renderInternalSlot(7,hF),this._renderContext.resetRenderOccludedMask()};this._renderContext.pass=0,i(.5,4,(()=>n(4)),!0,2),i(.5,2,(()=>n(2)),!0,2),i(1,16,(()=>n(16)),!0,2),hF.length=0}renderAntiAliasing(t,e){if(1===t){if(this._smaaPass.enable((()=>this._requestRender()))&&p(e))return this._smaaPass.render(e),!0}else this._smaaPass.disable();return!1}ensureCameraBindParameters(t){this._renderContext.camera=t,this._bindParameters.camera=this._renderContext.camera,this._bindParameters.inverseViewport[0]=1/this._renderContext.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/this._renderContext.camera.fullViewport[3]}ensureBindParameters(t){var e;this.ensureCameraBindParameters(t);const i=this._renderContext.offscreenRenderingHelper;this._bindParameters.shadowMap=this._renderContext.shadowMap,this._bindParameters.shadowMappingEnabled=this._renderContext.shadowMap.enabled,this._bindParameters.ssaoHelper=this._renderContext.ssaoHelper,this._bindParameters.ssaoEnabled=this._renderContext.ssaoHelper.enabled,this._bindParameters.slicePlane=this._renderContext.sliceHelper.plane,this._bindParameters.hasOccludees=this._renderContext.hasOccludees,this._renderContext.multipassTerrainParams.camera=this._renderContext.camera,this._bindParameters.hudVisibilityTexture=i.hudVisibilityTexture,this._bindParameters.highlightDepthTexture=null!=(e=i.depthTexture)?e:this.getFallbackDepthTexture()}ensureBindParametersSSR(){this.hasWaterReflection?(this._renderContext.lastFrameCamera.equals(this._renderContext.camera)?this._renderContext.ssrParams.reprojectionMatrix=this._reprojectionMatrix=vn:(ho(cF,this._renderContext.lastFrameCamera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),ho(dF,this._renderContext.camera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),so(dF,dF),so(uF,this._renderContext.camera.projectionMatrix),oo(pF,dF,uF),oo(pF,cF,pF),oo(pF,this._renderContext.lastFrameCamera.projectionMatrix,pF),this._renderContext.ssrParams.reprojectionMatrix=this._reprojectionMatrix=pF),this._renderContext.ssrParams.camera=this._renderContext.camera,this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=null,this._renderContext.ssrParams.ssrEnabled=this._bindParameters.ssrEnabled=this.hasWaterReflection}renderInternalSlot(t,e){let i=!1;return this._bindParameters.slot=t,p(e)?e.forEach((e=>{if(!e.shouldRender(this._renderContext))return;const s=this._materialRenderers.get(e);p(s)&&(i=s.render(t,this._renderContext.pass,this._bindParameters)||i)})):this._materialRenderers.forEach(((e,s)=>{s.shouldRender(this._renderContext)&&(i=e.render(t,this._renderContext.pass,this._bindParameters)||i)})),i}getFallbackDepthTexture(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=Bh(this._rctx)),this._fallbackDepthStencilTexture}get gpuMemoryUsage(){var t,e,i,s,n,r,o,a,h,l;return{offscreen:null!=(t=null==(e=this._offscreenRendering)?void 0:e.gpuMemoryUsage)?t:0,highlights:(null!=(i=null==(s=this._highlightHelper)?void 0:s.gpuMemoryUsage)?i:0)+(null!=(n=null==(r=this._shadowHighlightHelper)?void 0:r.gpuMemoryUsage)?n:0),shadows:null!=(o=null==(a=this._shadowMap)?void 0:a.gpuMemoryUsage)?o:0,ssao:null!=(h=null==(l=this._ssaoHelper)?void 0:l.gpuMemoryUsage)?h:0}}get test(){const t=this;return{offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlightHelper,lighting:this._lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,enableNewAtmosphere:t=>{this._enableNewAtmosphere=t},getFramebufferTexture:e=>{var i;switch(e){case 0:return t._offscreenRendering.colorTexture;case 1:return t._offscreenRendering.linearDepthTexture;case 2:return t._offscreenRendering.normalTexture;case 3:return null==(i=t._shadowMap)?void 0:i.test.depthTexture;case 4:return t._offscreenRendering.hudVisibilityTexture;case 5:return t._offscreenRendering.highlightTexture}}}}};r([o()],aF.prototype,"_shadowAccumulator",void 0),r([o()],aF.prototype,"_smaaPass",void 0),r([o()],aF.prototype,"_antialiasing",void 0),r([o()],aF.prototype,"_edgeView",void 0),r([o()],aF.prototype,"updating",null),r([o()],aF.prototype,"isCameraFinal",null),aF=r([a("esri.views.3d.webgl-engine.lib.Renderer")],aF);const hF=[],lF=[],cF=gn(),uF=gn(),dF=gn(),pF=gn();class fF extends ac{constructor(t,e,i){super(t,e),this.newCache=i}}const gF=y.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository");let mF=class extends T{constructor(t,e,i){super({}),this._stage=t,this._techniqueRepository=e,this._rctx=i,this._idToRefCountedTexture=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new G,this._frameTask=t.resourceController.scheduler.registerTask(po.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}dispose(){this._frameTask.remove(),this._stage.forEachOfType(4,(t=>t.unload()))}get updating(){return this._loadingCount>0||this._frameTask.updating}get textureTechnique(){return w(this._textureTechnique)&&(this._textureTechnique=this._techniqueRepository.acquire(Br,new Gr)),this._textureTechnique}acquire(t){const e=this._idToRefCountedTexture.get(t);return e?(e.ref(),Promise.resolve(e)):this._createNewRef(t)}update(){let t=!1;this._frameUpdates.forEach((e=>{const i=e.texture.frameUpdate(this._rctx,this.textureTechnique,e.previousToken);i>=0&&i!==e.previousToken&&(e.previousToken=i,t=!0)})),t&&this.events.emit("changed",0)}async _createNewRef(t){const e=this._stage.getObject(t);if(w(e))return xl(void 0!==e),null;const i=e.events.on("unloaded",(()=>{i.remove(),this._onTextureUnloaded(t)})),s=new vF(t,(()=>{this._frameTask.schedule((()=>{s.isUnreferenced&&e.unload()}))}));return this._idToRefCountedTexture.set(t,s),s.ref(),p(e.glTexture)?(this._updateGLTexture(s,e.glTexture),e.requiresFrameUpdates&&this._frameUpdates.set(t,{texture:e,previousToken:-1})):(this._loadingCount++,await this._stage.schedule((()=>{const i=e.load(this._rctx,(()=>this.textureTechnique)),n=i=>(this._loadingCount--,this._updateGLTexture(s,i),e.requiresFrameUpdates&&this._frameUpdates.set(t,{texture:e,previousToken:-1}),s);return Ht(i)?i.then(n,(t=>{this._loadingCount--,F(t)||gF.error(t)})):n(i)}))),s}_updateGLTexture(t,e){t.glTexture=e,this.events.emit("changed",1)}_onTextureUnloaded(t){this._idToRefCountedTexture.delete(t),this._frameUpdates.delete(t)}};r([o()],mF.prototype,"_loadingCount",void 0),r([o()],mF.prototype,"_frameTask",void 0),r([o()],mF.prototype,"updating",null),mF=r([a("esri.views.3d.webgl-engine.lib.TextureRepository")],mF);class vF{constructor(t,e){this.id=t,this._release=e,this._refCount=0}get isUnreferenced(){return 0===this._refCount}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(0!==this._refCount?(gF.error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}}const yF=y.getLogger("esri.views.3d.webgl-engine.materials.internal.waterMaterialUtils");let wF=class extends T{constructor(){super(...arguments),this._data=new Array,this.loadingState=0}dispose(){this.loadingState=0,this._data.forEach((t=>t.dispose())),this._data.length=0}get updating(){return 1===this.loadingState}get ready(){return 2===this.loadingState}loadTextures(t){const e=[Zt("esri/images/materials/water/normals.jpg"),Zt("esri/images/materials/water/perturbation.jpg")];this.loadingState=1,Promise.all(e.map((t=>Zh(t)))).then((e=>{e.forEach((e=>this._data.push(new ml(t,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:10497,samplingMode:9987,hasMipmap:!0,maxAnisotropy:8,width:e.width,height:e.height},e)))),this.loadingState=2})).catch((t=>{yF.error("Failed to load textures for water material.",t),this.loadingState=0}))}bind(t){this.ready&&(t.bindTexture(this._data[0],"texWaveNormal"),t.bindTexture(this._data[1],"texWavePerturbation"))}};r([o()],wF.prototype,"loadingState",void 0),r([o({type:Boolean,readOnly:!0})],wF.prototype,"updating",null),wF=r([a("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],wF);class xF extends Lr{constructor(t,e,i,s=null,n,r=!0){super(),this._rctx=t,this._renderScene=e,this._requestRenderScene=i,this._renderOverlay=s,this.forceCameraHook=n,this.supersample=r,this._screenshotQueue=new Array}dispose(){this._rctx=null}takeScreenshot(t){this._requestRenderScene(0);const e=x();return this._screenshotQueue.push({settings:t,resolver:e}),e.promise}update(t){for(const e of this._screenshotQueue){if(this.isDisposed){e.resolver.reject();continue}const i={...e.settings,pixelRatio:e.settings.pixelRatio*t.viewCamera.pixelRatio},s=this._ensureScreenshotEncodeCanvas(),n=this._renderScreenshot(t,i),r=iu(n,i,s,{flipY:!0,premultipliedAlpha:!0});e.resolver(r)}this._screenshotQueue.length=0}_renderScreenshotOverlay(t,e,i){if(w(this._renderOverlay))return e;t.width=e.width,t.height=e.height;const s=t.getContext("2d"),n=i.pixelRatio;return s.save(),s.translate(0,e.height),s.scale(1,-1),i.region&&s.translate(-i.region.x,-i.region.y),s.scale(n,n),e=this._renderOverlay(t,e),s.restore(),e}_readbackScreenshot(t){return t.resample?this._readbackScreenshotResampled(t):this._readbackScreenshotImmediate(t)}_readbackScreenshotResampled(t){const{framebufferWidth:e,framebufferHeight:i,region:s,resample:n}=t,r=this._ensureScreenshotEncodeCanvas();let o=su(e,i,r);this._rctx.gl.readPixels(0,0,e,i,6408,5121,new Uint8Array(o.data.buffer)),o=this._renderScreenshotOverlay(r,o,{...t,region:null});const a=su(s.width,s.height,r);return nu(o,a,!0,n.region.x,i-(n.region.y+n.region.height),n.region.width,n.region.height)}_readbackScreenshotImmediate(t){const{framebufferHeight:e,region:i}=t,s=this._ensureScreenshotEncodeCanvas(),n=su(i.width,i.height,s);return this._rctx.gl.readPixels(i.x,e-(i.y+i.height),i.width,i.height,6408,5121,new Uint8Array(n.data.buffer)),this._renderScreenshotOverlay(s,n,t)}_renderScreenshot(t,e){let i=null;const s=t.viewCamera,{framebufferWidth:n,framebufferHeight:r}=e;let o=!1;const a=n!==s.fullWidth||r!==s.fullHeight||e.disableDecorations&&t.frameHasDecorations||e.ignorePadding&&s.pixelRatio!==e.pixelRatio;if(a){const t=s.clone();if(e.ignorePadding){const i=aa(t.padding);for(let s=0;s<4;s++)i[s]=Math.round(i[s]/t.pixelRatio*e.pixelRatio);t.padding=i}t.fullWidth=n,t.fullHeight=r,t.pixelRatio=e.pixelRatio;const a=s.fovX-t.fovX,h=s.fovY-t.fovY;a<0&&a<h?t.fovX=s.fovX:h<0&&h<a&&(t.fovY=s.fovY),this.forceCameraHook(t),o=!0,i=new cl(this._rctx,{width:t.fullWidth,height:t.fullHeight,colorTarget:0,depthStencilTarget:3}),this._renderScene(i,t,e.disableDecorations?0:1)}const h=this._readbackScreenshot(e);if(a&&!this._rctx.contextAttributes.alpha)for(let t=3;t<h.data.length;t+=4)h.data[t]=255;return i&&i.dispose(),this._rctx.bindFramebuffer(null),o&&this.forceCameraHook(s),h}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}const bF=y.getLogger("esri.views.3d.webgl-engine.parts.View");let CF=class extends(qr(T)){constructor(t){super({}),this.events=new G,this.waterTextureRepository=new wF,this._magnifierHelper=new zD,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._logicUpdateLast=0,this._container=t.container,this._initializeContext(t),tt(this.waterTextureRepository,"loadingState",(()=>this.requestRender())),this._magnifierHelper.events.on("request-render",(()=>this.requestRender())),this._stippleTextureRepository=new Wr(this._rctx),this._shaderTechniqueRepository=new Ur({rctx:this._rctx,viewingMode:t.viewingMode,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),this._textureRepository=new mF(t,this._shaderTechniqueRepository,this._rctx),this._textureRepository.events.on("changed",(t=>this.requestRender(t))),this._materialRepository=new Hr(this._textureRepository,this._shaderTechniqueRepository,(()=>this.requestRender()),(()=>this.requestRender())),this._compositingHelper=new xD(this._rctx,this._shaderTechniqueRepository),this._renderer=new aF(this._materialRepository,this._textureRepository,this._shaderTechniqueRepository,this._rctx,this._compositingHelper,this._magnifierHelper,(t=>this.requestRender(t)),((e,i)=>t.schedule(e,i)),t),this._screenshotManager=new xF(this._rctx,((t,e,i)=>this._renderer.render(t,e,e,i)),(t=>this.requestRender(t)),t.options.screenshot.renderOverlay,(t=>this.events.emit("force-camera-for-screenshot",t))),this._registerFrameTask(t)}normalizeCtorArgs(){return{}}dispose(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=J(this._frameTask),this._shaderTechniqueRepository=Q(this._shaderTechniqueRepository),super.dispose(),this._tmpDepthBuffer=null,this._rctx=null}get performanceInfo(){const t=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:void 0!==t.getUsedTextureMemory?t.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==t.getUsedRenderbufferMemory?t.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==t.getUsedVBOMemory?t.getUsedVBOMemory():void 0}}requestRender(t=1){1===t?this._needsUpdate=!0:this._needsRender=!0}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this._renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}ensureEdgeView(){return this._renderer.ensureEdgeView()}get edgeView(){return this._renderer.edgeView}get textureRepository(){return this._textureRepository}get compositingHelper(){return this._compositingHelper}set magnifier(t){this._magnifierHelper.magnifier=t}updateLightSources(t,e,i){this._renderer.updateLightSources(t,e,i),this.requestRender()}setRenderParameters(t){void 0!==t.idleSuspend&&this._idleSuspend!==!!t.idleSuspend&&(this._idleSuspend=!!t.idleSuspend,this.requestRender()),this._renderer.setRenderParameters(t)}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}modify(t){this._renderer.modify(t),t.clear()}get canvas(){return this._canvas}takeScreenshot(t){return this._screenshotManager.takeScreenshot(t)}get hasShadowsEnabled(){return this._renderer.hasShadowsEnabled}readAccumulatedShadow(t){return this._renderer.readAccumulatedShadow(t[0],t[1])}getMinimalDepthForArea(t,e,i,s,n=s){const r=i.constrainWindowSize(t,e,s*i.pixelRatio,n*i.pixelRatio),o=this._ensureDepthBuffer(r);this._renderer.readDepthPixels(i,r[0],r[1],r[2],r[3],o);let a=Number.MAX_VALUE;for(let t=0;t<r[2]*r[3];t++){const e=CD(4*t,o,i.nearFar);a>e&&e!==i.nearFar[0]&&e!==i.nearFar[1]&&(a=e)}return a===Number.MAX_VALUE?void 0:a}_ensureDepthBuffer(t){const e=4*t[2]*t[3];return(w(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<e)&&(this._tmpDepthBuffer=new Uint8Array(e)),this._tmpDepthBuffer}get renderPlugins(){return this._renderer.renderPlugins}get test(){return{renderer:this._renderer}}get gpuMemoryUsage(){return this._renderer.gpuMemoryUsage}async reloadShaders(){PS(),await this._shaderTechniqueRepository.reloadAll(),this.requestRender()}_registerFrameTask(t){const e=t.state,i={viewCamera:e.camera,frameHasDecorations:!1};this._frameTask=St({preRender:i=>{t.processSyncLayers();const s=ht(i.time-this._logicUpdateLast);if(s>MS||p(this.forcedAnimationTime)){const t={camera:e.camera,dt:s,forcedTime:this.forcedAnimationTime};this._logicUpdateLast=i.time,this._renderer.updateLogic(t)&&this.requestRender(0)}},render:()=>{if((this._needsUpdate||this._needsRender||!this._idleSuspend||!this._renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&e.camera.fullWidth>0&&e.camera.fullHeight>0){const t=this._needsUpdate&&this._idleSuspend&&this._renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this._renderer.render(null,e.camera,e.contentCamera,1),t&&this._renderer.hasWaterReflection&&(this.requestRender(0),this._needsWaterReflectionUpdate=!0)}},update:()=>{i.viewCamera=e.camera,i.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled,this._textureRepository.update(),this._screenshotManager.update(i)}})}_initializeContext(t){const e=t.options;this._canvas=e.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const i={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==e.stencil||e.stencil,powerPreference:"high-performance"};let s;const n=dt("esri-force-webgl");1===n||2===n?s=au(this._canvas,n,i):(s=hu(this._canvas,2,i),w(s)&&(s=au(this._canvas,1,i))),w(s)?bF.error(n):(this._rctx=new fF(s,{disabledExtensions:e.deactivatedWebGLExtensions||{},debugWebGLExtensions:e.debugWebGLExtensions||{},maxAnisotropy:8},((e,i)=>t.resourceController.memoryController.newCache(e,i))),this._loadShaderOnlyExtensions(),!e.alpha&&this._rctx.contextAttributes.alpha&&bF.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&dt("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas))}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("standardDerivatives"),this._rctx.capabilities.enable("shaderTextureLOD"),this._rctx.capabilities.enable("textureFloat")}get componentObjectCollection(){return w(this._componentObjectCollection)&&(this._componentObjectCollection=new cD(this._renderer.renderPassManager)),this._componentObjectCollection}set componentObjectCollection(t){this._componentObjectCollection=t}};var MF;r([o({type:Boolean,readOnly:!0})],CF.prototype,"updating",null),r([Er()],CF.prototype,"_rctx",void 0),r([Er()],CF.prototype,"_container",void 0),r([Er()],CF.prototype,"_canvas",void 0),r([Er()],CF.prototype,"_stippleTextureRepository",void 0),r([Er(),o()],CF.prototype,"waterTextureRepository",void 0),r([Er(),o()],CF.prototype,"_magnifierHelper",void 0),r([Er(),o()],CF.prototype,"_textureRepository",void 0),r([Er()],CF.prototype,"_compositingHelper",void 0),r([Er()],CF.prototype,"_renderer",void 0),r([Er()],CF.prototype,"_screenshotManager",void 0),r([Er()],CF.prototype,"componentObjectCollection",null),r([Er()],CF.prototype,"_componentObjectCollection",void 0),r([o()],CF.prototype,"_needsUpdate",void 0),r([o()],CF.prototype,"_needsWaterReflectionUpdate",void 0),CF=r([a("esri.views.3d.webgl-engine.parts.RenderView")],CF);let SF=MF=class extends(qr(T)){constructor(t){super(t),this._handles=new E,this._model=new UT,this._layers=new pt,this._changeSet=new Zr,this._layerSyncSet=new Set}initialize(){this._set("renderView",new CF(this)),this._frameTask=this.resourceController.scheduler.registerTask(po.STAGE,this),this._handles.add(this._frameTask)}destroy(){gc.pool.prune(0),this._handles.destroy(),this.dispose()}get viewingMode(){return this.state.viewingMode}get updating(){return this._model.dirtySet.dirty||this.renderView.updating||this._frameTask.updating}add(t){this._model.add(t),Fr(t)&&(t.attachStage(this),this._addLayer(t)),this.renderView.requestRender()}remove(t){w(t)||(this.renderView.requestRender(),this._model.remove(t),Fr(t)&&(this._removeLayer(t),t.detachStage()))}addMany(t){p(t)&&(this._model.addMany(t),this.renderView.requestRender())}removeMany(t){p(t)&&(this._model.removeMany(t),this.renderView.requestRender())}async load(t){w(t)||(Array.isArray(t)||(t=[t]),await z(t.filter((t=>w(t.glTexture))).map((t=>this.schedule((()=>t.load(this.renderView.renderingContext,(()=>this.renderView.textureRepository.textureTechnique))))))))}loadSynchronous(t){return t.load(this.renderView.renderingContext,(()=>this.renderView.textureRepository.textureTechnique))}forEachOfType(t,e){this._model.forEachOfType(t,e)}handleEvent(t,e){this.destroyed||(this._model.dirtySet[t](e),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty}runTask(t){this._frameTask.processQueue(t),t.done||this._commit()}_commit(){const t=this._model.dirtySet;MF.DebugSettings.logDirtySet&&console.log("Dirty set: "+t.formatDebugInfo()),t.commit(this._changeSet),MF.DebugSettings.logDirtySet&&(console.log("RGs add: "+this._changeSet.adds.map((t=>t.id))),console.log("RGs remove: "+this._changeSet.removes.map((t=>t.id)))),this._layerSyncSet.clear(),this.renderView.modify(this._changeSet),this.renderView.requestRender()}schedule(t,e){return this._frameTask.schedule(t,e)}syncLayer(t){this._layerSyncSet.add(t),this.renderView.requestRender()}processSyncLayers(){const t=this._model.dirtySet;this._layers.forAll((e=>{(this._layerSyncSet.has(e.id)||1===e.updatePolicy)&&(t.commitLayer(e.id,this._changeSet),this._layerSyncSet.delete(e.id))}));for(const e of this._layerSyncSet)t.commitLayer(e,this._changeSet);this._layerSyncSet.clear(),this.renderView.modify(this._changeSet)}getObject(t){return this._model.getObject(t)}get layers(){return this._layers}_addLayer(t){this._layers.some((e=>e===t))||this._layers.push(t)}_removeLayer(t){this._commit(),null!=this._layers.removeUnordered(t)&&(this._model.dirtySet.getResidentRenderGeometries(t.id,this._changeSet.removes),this.renderView.modify(this._changeSet))}addRenderPlugin(t,e,i){const s=this.renderView.renderPlugins.add(t,e,i),n=()=>{tM(e)&&this.sceneIntersectionHelper.addIntersectionHandler(e)};if(Bt(s))return s.then(n);n()}removeRenderPlugin(t){tM(t)&&this.sceneIntersectionHelper.removeIntersectionHandler(t),this.renderView.renderPlugins.remove(t)}get performanceInfo(){return{renderView:this.renderView.performanceInfo,model:this._model.getStats()}}get test(){const t=this;return{getCount:e=>t._model.test.content.filter((t=>t.type===e)).length,model:t._model}}};function PF(t,e){var i;switch(null==(i=t.target)?void 0:i.type){case"stage":return _F(t.target.obj.metadata,e);case"external":switch(t.intersector){case"PointRenderer":return function(t,e){const i=t.metadata.layerUid;return null!=i?e.map.findLayerByUid(i):null}(t.target,e);case"I3S":case"IM":case"LodRenderer":case"OverlayRenderer":return _F(t.target.metadata,e);case"TerrainRenderer":return e.map&&e.map.ground}}return null}function TF(t,e){var i;switch(null==(i=t.target)?void 0:i.type){case"stage":return AF(t.target.obj.metadata,e);case"external":switch(t.intersector){case"PointRenderer":return function(t){return t.metadata.createGraphic()}(t.target);case"I3S":case"IM":case"LodRenderer":case"OverlayRenderer":return AF(t.target.metadata,e)}}return null}function AF(t,e){if(w(t))return null;const i=_F(t,e);if(w(i))return null;if(i===e.graphics)return p(e.graphicsView)?P(e.graphicsView.getGraphicFromGraphicUid(t.graphicUid)):null;const s=e.allLayerViews.find((t=>t.layer===i));return s?function(t,e){return!t||t.suspended?null:"getGraphicFromIntersectorMetadata"in t&&e?t.getGraphicFromIntersectorMetadata(e):"getGraphicFromGraphicUid"in t&&null!=e.graphicUid?t.getGraphicFromGraphicUid(e.graphicUid):null}(s,t):null}function _F(t,e){return w(t)||null==t.layerUid?null:p(e.graphicsView)&&t.layerUid===e.graphicsView.graphics3d.layer.id?e.graphics:e.map.findLayerByUid(t.layerUid)}SF.DebugSettings={endFrameContentValidation:!1,logDirtySet:!1},r([o({constructOnly:!0})],SF.prototype,"resourceController",void 0),r([o({constructOnly:!0})],SF.prototype,"options",void 0),r([o({constructOnly:!0})],SF.prototype,"state",void 0),r([o({constructOnly:!0})],SF.prototype,"sceneIntersectionHelper",void 0),r([o({readOnly:!0})],SF.prototype,"viewingMode",null),r([o({constructOnly:!0})],SF.prototype,"container",void 0),r([o({constructOnly:!0})],SF.prototype,"renderSR",void 0),r([o({constructOnly:!0})],SF.prototype,"_handles",void 0),r([o({readOnly:!0})],SF.prototype,"updating",null),r([o({constructOnly:!0})],SF.prototype,"_model",void 0),r([Er(),o()],SF.prototype,"renderView",void 0),SF=MF=r([a("esri.views.3d.webgl-engine.Stage")],SF);let DF=class extends we{constructor(t){super(t),this.components=["attribution","zoom","navigation-toggle","compass"]}};r([o()],DF.prototype,"components",void 0),DF=r([a("esri.views.ui.3d.DefaultUI3D")],DF);const OF=DF,RF=y.getLogger("esri.views.SceneView");let FF=class extends(xe(Jo(be(Me)))){constructor(t){super(t),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._defaults={},this._externallySet={environment:!1},this._createGraphicsViewController=null,this._resolveWhenReady=[],this.propertiesPool=new El({slicePlane:Eo},this),this._resourceController=function(t,e=(()=>performance.now())){return new PM.ResourceController({view:t,now:e})}(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new gb({view:this}),this.labeler=new Vb({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.basemapTerrain=null,this.elevationProvider=null,this.camera=null,this.canvas=null,this.center=null,this.constraints=new Ef,this.environmentManager=new Om,this.extent=null,this.floors=new _,this.windowDevicePixelRatio=1,this.fullOpacity=1,this.graphicsView=null,this.groundView=null,this.navigating=!1,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new bC,this.scale=null,this.spatialReference=null,this.isHeightModelInfoRequired=!0,this.alphaCompositingEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new OF,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.viewpoint=null,this.zoom=null,this.highlightOptions=new lM,bo(),t&&t.environment||(this._defaults.environment=new Uf,this.environment=this._defaults.environment);const e=t=>{p(t)&&4===t.type||(this.updatingChanged(),this.map&&this.map.allLayers.forEach((async t=>{try{await t.when()}catch{}this.updatingChanged()})))};this.handles.add([X(this,"map.allLayers","after-changes",e,e,e,!0),this.allLayerViews.on("after-changes",(t=>this._updateUpdatingMonitors(t))),this.watch("map",(t=>{t&&t.load&&t.load().catch((()=>{}))}))]),this.inputManager=new jx({view:this}),this.stateManager=new GC({view:this,updateDevicePixelRatio:()=>{const t=window.devicePixelRatio;t!==this.windowDevicePixelRatio&&(this.windowDevicePixelRatio=t,this.notifyChange("pixelRatio"))}})}initialize(){this.groundView=new gf({view:this}),this._updateUpdatingMonitors();const t=()=>this._updateDefaultToMapOptions();this.handles.add(X(this,"map.allLayers","after-changes",t,t,t)),this.updatingHandles.add(this.qualitySettings,"memoryLimit",(t=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=t)}),2),this.updatingHandles.add(this.qualitySettings,"additionalCacheMemory",(t=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=t)}),2),this.updatingHandles.add(this.qualitySettings,"frameRate",(t=>Qt(t>0?1e3/Math.ceil(t):0)),2),this.updatingHandles.add(lr,"SCENEVIEW_LOCKING_LOG",(t=>this.defaultsFromMap.logDebugInformation=t),2),this.updatingHandles.add(this,"map.ground",t,3),this.updatingHandles.add(this,"map.ground.opacity",(()=>this._updateDefaultHitTestOptions()),3),this.handles.add(this.watch("spatialReference",(()=>this.notifyChange("clippingArea")),!0))}destroy(){this.destroyed||(this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=Y(this.sharedSymbolResources),this.labeler.destroy(),this._set("labeler",null),this.deconflictor.destroy(),this._set("deconflictor",null),this._resourceController=Y(this._resourceController),this.stateManager.destroy(),this._set("stateManager",null),this.inputManager.destroy(),this._set("inputManager",null),this.propertiesPool.destroy(),this.handles.remove("updatingMonitors"),this.environmentManager.destroy(),this._set("environmentManager",null),this.groundView=Y(this.groundView))}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){return this.basemapTerrain&&this.basemapTerrain.spatialReference}installContentCameraReset(t={sticky:!1}){return this.stateManager.installContentCameraReset(t)}get clippingArea(){if("global"===this.viewingMode)return null;let t=this._userClippingArea||this.get("map.clippingArea");return!this._userClippingArea&&!this.get("map.clippingEnabled")||w(t)?(this._clippingArea=null,null):t instanceof g?this.spatialReference&&(t=LF(t,this.spatialReference),w(t))?(RF.error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(t=t.clone(),w(t.intersection(this.groundAndLayersExtent))&&(t.xmin=t.xmax,t.ymin=t.ymax),t.zmin=void 0,t.zmax=void 0,t.equals(this._clippingArea)||(this._clippingArea=t),this._clippingArea):(RF.error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(t){this.ready&&"global"===this.viewingMode&&p(t)?RF.error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=t}get renderDataExtent(){if(1===this.state.viewingMode)return null;const t=this.renderSpatialReference,e=this.dataExtent;return w(e)||w(t)||e.spatialReference.equals(t)?e:LF(e,t)}get dataExtent(){let t=this.groundAndLayersExtent;const e=LF(this.clippingArea,this.spatialReference||d.WGS84);p(e)&&(t=p(t)?t.intersection(e):e);const i=this._get("dataExtent");return p(t)&&t.equals(i)?i:t}get groundAndLayersExtent(){const t=this.spatialReference||d.WGS84;let e;const i=i=>{const s=LF(i,t);w(s)||(p(e)?e.union(s):e=s.clone())},s=this.basemapTerrain;if(null!=s&&s.spatialReference){const t=s.groundExtent;i(new g({xmin:t[0],ymin:t[1],zmin:0,xmax:t[2],ymax:t[3],zmax:0,spatialReference:s.spatialReference}))}if(this.map){const t=t=>{!p(t.fullExtent)||"graphics"===t.type&&t.internal||i(t.fullExtent)};this.map.allLayers.forEach((e=>t(e)))}if(w(e))return null;e.hasZ?(e.zmin=Math.min(0,e.zmin),e.zmax=Math.max(0,e.zmax)):(e.zmin=0,e.zmax=0);const n=this._get("groundAndLayersExtent");return e.equals(n)?n:e}set environment(t){t!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",t)}castEnvironment(t){return t?t instanceof Uf?t:t instanceof _u?null!=this.environment?this.environment.cloneWithWebsceneEnvironment(t):Uf.fromWebsceneEnvironment(t):O(Uf,t):new Uf}get pixelRatio(){return Math.min(this.windowDevicePixelRatio,this.maximumPixelRatio)}set pixelRatio(t){p(t)?this._override("pixelRatio",t):this._clearOverride("pixelRatio")}get maximumPixelRatio(){let t=1/0;const{maximumPixelRatio:e,maximumRenderResolution:i}=this.qualitySettings;if(null!=e&&(t=Math.min(t,e)),null!=i){const e=i/Math.max(this.width,this.height);t=Math.min(t,e)}return t}set maximumPixelRatio(t){p(t)?this._override("maximumPixelRatio",t):this._clearOverride("maximumPixelRatio")}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get interacting(){return this.navigating||p(this.activeTool)}get stationary(){return!this.animation&&!this.resizing&&(w(this.state)||this.state.stationary)}set qualityProfile(t){aM.isValidProfile(t)&&(aM.apply(t,this.qualitySettings),this._set("qualityProfile",t))}get qualityProfile(){return this._get("qualityProfile")||aM.getDefaultProfile()}set slicePlane(t){if(this._stage.renderView.setRenderParameters({slicePlane:t}),w(t))return void this._set("slicePlane",null);const e=this.propertiesPool.get("slicePlane");Fo(t,e),this._set("slicePlane",e)}get resolution(){return null!=this.spatialReference?Kr(this.scale,this.spatialReference):0}get heightModelInfo(){const t=this.getDefaultHeightModelInfo();return null!=t?Le.deriveUnitFromSR(t,this.spatialReference):null}get updating(){var t,e,i;if(this.destroyed)return!1;let s=0,n=this.layerViewManager.updating,r=n?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach((t=>{if(t.isFulfilled()){if(t.updating){if(n=!0,t.suspended||ni(t))return;++r,s+=t.updatingProgress}}else++r}));for(const t of[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this.featureTreeDebugger,this.toolViewManager])if(p(t)&&t.updating){const t=.1;r+=t,s+=.5*t}for(const t of[this.deconflictor,this.labeler,this.basemapTerrain])p(t)&&t.updating&&(++r,s+=t.updatingProgress);if(n=!!(n||r>0||this.updatingHandles.updating||!this.ready||!this.stationary||this._createGraphicsViewController||null!=(t=this.inputManager)&&t.hasPendingInputs||null!=(e=this.map)&&null!=(i=e.allLayers)&&i.some((t=>!t.isFulfilled()))),n?(this._numUpdating=Math.max(r,this._numUpdating),s+=this._numUpdating-r):this._numUpdating=0,this._numUpdating>0?s/=this._numUpdating:s=n?0:1,this._get("updatingProgress")!==s){const t=this._resourceController.scheduler.now;if(s<1){const e=Math.min((t-this._lastUpdateTime)/2e3,1);s=this.updatingProgress*(1-e)+s*e}this._set("updatingProgress",s),this._lastUpdateTime=n&&s<1?t:0}return n}get viewingMode(){const t=this.get("map.initialViewProperties.viewingMode");if(t)return t;const e=this.spatialReference;return!e||$e(e,"global")?"global":"local"}set viewingMode(t){this.ready?RF.error("#viewingMode","viewingMode cannot be set once view is ready"):["local","global"].indexOf(t)>=0?this._override("viewingMode",t):void 0===t&&this._clearOverride("viewingMode")}get resourceController(){return this._resourceController}get performanceInfo(){return new AM(this)}forceAnimationTime(t){this._stage.renderView.forcedAnimationTime=this.basemapTerrain.overlayManager.forcedAnimationTime=t}on(t,e,i,s){return this.viewEvents.on(t,e,i,s)||super.on(t,e)}hasEventListener(t){return super.hasEventListener(t)||this.viewEvents.hasHandler(t)}toMap(t,e){if(!this.ready)return RF.error("#toMap()","Scene view cannot be used before it is ready"),null;const i=e?this.externalToInternalIntersectOptions(e):this._defaultToMapOptions,s=p(i.graphics)&&(p(i.graphics.include)||p(i.graphics.exclude)),n=ta(t)?ea(this,t):t,r=Mo(n);i.enableDraped=i.include&&!i.include.has(ch)||i.exclude&&i.exclude.has(ch);const o=this.sceneIntersectionHelper,a=new Jn(this.state.viewingMode);if(a.options.selectionMode=!0,a.options.store=s?2:0,o.intersectIntersectorScreen(r,a,i),s){for(const t of a.results.all){const e=TF(t,this);if(w(e))return this._intersectResultToMapPoint(t);if(this._testGraphicUidFilter(i.graphics,e))return this._intersectResultToMapPoint(t)}return null}return this._intersectResultToMapPoint(a.results.min)}toScreen(t){if(!this.ready)return RF.error("#toScreen()","Scene view cannot be used before it is ready"),null;const e=f(null==t.z&&tr(this.elevationProvider,t),0);return Ee(t,EF,this.renderSpatialReference,e),this.state.camera.projectToScreen(EF,IF),Po(IF[0],IF[1])}pixelSizeAt(t){return this.ready?t?(Ee(t,EF,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(EF)):0:(RF.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(t){const e=this.basemapTerrain.overlayManager;return e?e.overlayPixelSizeInMapUnits(t):1}hitTest(t,e){if(!this.ready)return RF.error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=ta(t)?ea(this,t):t,s=Co(i.x,i.y),n=e?this.externalToInternalIntersectOptions(e):this._defaultHitTestOptions;n.requiresGroundFeedback=!0,n.enableDraped=!0;const r=new Jn(this.state.viewingMode);r.options.selectionMode=!0,r.options.store=2,this.sceneIntersectionHelper.intersectIntersectorScreen(s,r,n);const o=this._intersectResultsToHits(r.results.all,n.graphics),a=r.results.ground,h=PF(a,this),l=p(h)&&"type"in h&&"integrated-mesh"===h.type?h:null,c={screenPoint:i,results:o,ground:{mapPoint:this._intersectResultToMapPoint(a),distance:a.hasIntersectionPoint?a.distanceInRenderSpace:0,layer:l}};return lr.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(c.intersector=r),Promise.resolve(c)}popupHitTest(t){return lu(this,t).then((({results:e,ground:i})=>{let s=null;return!(0===e.length||Math.abs(e[0].distance-i.distance)<1e-5)||i.layer&&"integrated-mesh"===i.layer.type||(s=i.mapPoint),{results:e,screenPoint:t,mapPoint:s}}))}goTo(t,e){return this.updatingHandles.addPromise(this.stateManager.goTo(t,e))}async whenAnalysisView(t){if(w(t.parent))throw new n("view:no-analysisview-for-analysis","The analysis has not been added to an AnalysisLayer",{analysis:t});return(await this.whenLayerView(t.parent)).whenAnalysisView(t)}whenLayerView(t){return super.whenLayerView(t)}takeScreenshot(t){return this.whenReady().then((()=>{const e=ru(t,this);return e.pixelRatio/=this.pixelRatio,this._stage.renderView.takeScreenshot(ou(e,this.supersampleScreenshotsEnabled,this.padding))}))}addUpdatingPromise(t){return this.updatingHandles.addPromise(t)}importLayerView(t){return(t=>{const e=wf[t.type];if(!p(e))throw function(t){const e=t.declaredClass?t.declaredClass.slice(t.declaredClass.lastIndexOf(".")+1):"Unknown",i=e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new n(`${i}:view-not-supported`,`${e} is not supported in 3D`)}(t);return e(t)})(t)}hasLayerViewModule(t){return(t=>p(wf[t.type]))(t)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")||this.get("defaultsFromMap.isSpatialReferenceDone")&&this._initialDefaultSpatialReference||null}async validate(){let t=Ce();if(dt("safari")&&dt("safari")<9&&(t=new n("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:dt("safari")})),p(t))throw RF.warn("#validate()",t.message),t}isSpatialReferenceSupported(t,e,i){const s=t.isGeographic,n=t.isWebMercator,r=$e(t,"global"),o="local"===this.viewingMode,a=!(!this._isOverridden("viewingMode")&&!this.get("map.initialViewProperties.viewingMode"));if(a){if(o&&s&&!$e(t,"local"))return i?i(`Layer ${e.id} is ignored because its spatial reference is not supported in local viewing mode`):RF.warnOnce("Spatial reference defined on view not supported in local viewing mode."),!1;if(!o&&!r)return i?i(`Layer ${e.id} is ignored because its spatial reference is not supported in global viewing mode`):RF.warnOnce("Spatial reference defined on view not supported in global viewing mode."),!1}else if(s&&!r)return i?i(`Layer ${e.id} is ignored because its spatial reference is geographic but unsupported`):RF.warnOnce("Spatial reference is geographic but not supported."),!1;if(e)if(hi(e)){let s;if(a)s=null!=li(e,t,mf(this.viewingMode)).tileInfo;else{let i=li(e,t,1);null==i.tileInfo&&(i=li(e,t,2),null!=i.tileInfo&&n&&!this.ready&&(this.viewingMode="local")),s=null!=i.tileInfo}if(!s)return i&&i(`Layer ${e.id} is ignored because it is tiled but\n            its tiling scheme is not supported or compatible with the viewing mode`),!1}else if((t.isWGS84||n)&&!o)return null==this._initialDefaultSpatialReference&&(this._initialDefaultSpatialReference=t),a||this.ready||(this.viewingMode="global",i&&i(`Viewing mode locked to global due to reprojectable layer ${e.id}`)),i&&i(`Layer ${e.id} is ignored because it supports server-side reprojection`),!1;return!0}whenReady(){return new Promise((t=>{this.ready?t(this):this._resolveWhenReady.push(t)}))}computeMapPointFromVec3d(t,e){let i=this.spatialReference||d.WGS84;return Ie(t,this.renderSpatialReference,t,i)||(i=d.WGS84,Ie(t,this.renderSpatialReference,t,i)),e?(e.x=t[0],e.y=t[1],e.z=t[2],e.spatialReference=i):e=new m(t,i),e}trackGraphicState(t){if(!t.graphic)return RF.error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const e=this.getViewForGraphic(t.graphic);let i=null,s=!1;const n=e=>{!s&&p(e)&&"graphics3d"in e&&e.graphics3d&&e.graphics3d.graphicsCore&&(i=e.graphics3d.graphicsCore.trackGraphicState(t))};return p(e)?n(e):this.whenViewForGraphic(t.graphic,{waitForLayer:!0}).then((t=>n(t)),(()=>{})).catch((()=>{})),{remove:()=>{s=!0,p(i)&&(i.remove(),i=null)}}}highlight(t){if(Array.isArray(t))return Yt(t.map((t=>this.highlight(t))));if(_.isCollection(t))return Yt(t.toArray().map((t=>this.highlight(t))));const e=this.getViewForGraphic(t);return e&&"highlight"in e?e.highlight(t):Xt()}maskOccludee(t){if(!t)return RF.error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const e=this.getViewForGraphic(t);let i=null,s=!1;const n=e=>{!s&&p(e)&&"graphics3d"in e&&cu(e)&&(i=e.maskOccludee(t))};return p(e)?n(e):this.whenViewForGraphic(t,{waitForLayer:!0}).then((t=>n(t)),(()=>{})).catch((()=>{})),{remove:()=>{s=!0,p(i)&&(i.remove(),i=null)}}}getViewForGraphic(t){return t.layer===this.graphics?this.graphicsView:t.layer?this.allLayerViews.find((e=>e.layer===t.layer)):null}graphicChanged(t){p(this.graphicsView)&&this.graphicsView.graphicChanged(t)}async whenViewForGraphic(t,e){if(t.layer===this)return await Ct(this,"graphicsView"),this.graphicsView;if(!t.layer||!this.map)throw new n("no-view-for-graphic");return e&&e.waitForLayer&&!this.map.allLayers.includes(t.layer)?new Promise(((e,i)=>{const s=this.map.allLayers.on("change",(n=>{-1!==n.added.indexOf(t.layer)&&(s.remove(),this.whenLayerView(t.layer).then(e,i))}))})):this.whenLayerView(t.layer)}externalToInternalIntersectOptions(t){const e=this._externalToInternalRenderItems(t.include,0),i=this._externalToInternalRenderItems(t.exclude,1);return{include:e.layerUids,exclude:i.layerUids,graphics:{include:e.graphicUids,exclude:i.graphicUids}}}_intersectResultToMapPoint(t,e){return t.getIntersectionPoint(EF)?(e=this.computeMapPointFromVec3d(EF,e),"TerrainRenderer"===t.intersector&&this.basemapTerrain&&(e.z=f(tr(this.basemapTerrain,e),0)),e):null}_intersectResultsToHits(t,e){const i=new Array;let s=null;for(let n=0;n<t.length;n++){const r=t[n],o=PF(r,this);if(p(o)&&(o===this.map.ground||"type"in o&&"integrated-mesh"===o.type))break;const a=TF(r,this);if(!p(a))continue;if(w(s)&&n!==t.length-1&&(s=new Set),p(s)){const t=this._getGraphicFilterUid(a);if(s.has(t))continue;s.add(t)}if(!this._testGraphicUidFilter(e,a))continue;const h=this._intersectResultToMapPoint(r);i.push({graphic:a,mapPoint:h,distance:r.distanceInRenderSpace})}return i}_getGraphicFilterUid(t){if(t.layer&&"objectIdField"in t.layer){const e=t.attributes[t.layer.objectIdField];if(e)return`o-${t.layer.id}-${e}`}return`u-${t.uid}`}_testGraphicUidFilter(t,e){const i=this._getGraphicFilterUid(e);return w(t)||(w(t.include)||t.include.has(i))&&(w(t.exclude)||!t.exclude.has(i))}_externalToInternalRenderItems(t,e,i={layerUids:null,graphicUids:null}){return t?(t instanceof on?(function(t,e){t.graphicUids||(t.graphicUids=new Set),t.graphicUids.add(e)}(i,this._getGraphicFilterUid(t)),0===e&&(p(this.graphicsView)&&t.layer===this?zF(i,this.graphicsView.graphics3d.layer.id):t.layer&&zF(i,t.layer.uid))):"forEach"in t?t.forEach((t=>{Array.isArray(t)?this._externalToInternalRenderItems(t,e,i):_.isCollection(t)?t===this.graphics&&p(this.graphicsView)?zF(i,this.graphicsView.graphics3d.layer.id):this._externalToInternalRenderItems(t,e,i):t instanceof te?t===this.map.ground&&zF(i,ch):this._externalToInternalRenderItems(t,e,i)})):zF(i,t.uid),i):i}_initBasemapTerrain(){this._set("basemapTerrain",new zT({view:this})),this._set("elevationProvider",new sM({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new lS({view:this})),this._set("featureTiles",new wC({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.contentCameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const t=()=>{const t=this.basemapTerrain&&this.basemapTerrain.extent;if(this.clippingArea||t)if(t&&this.basemapTerrain.spatialReference){const t=p(this.basemapTerrain.extent)?je(En(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;this.featureTiles.filterExtent=p(this.clippingArea)?this.clippingArea.intersection(t):t}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.handles.add([this.updatingHandles.add(lr,"FEATURE_TILE_TREE_SHOW_TILES",(t=>{t&&this.featureTiles&&!this.featureTreeDebugger?this.updatingHandles.addPromise(import("./p-77906cf3.js")).then((({FeatureTileTree3DDebugger:t})=>{!this.featureTreeDebugger&&lr.FEATURE_TILE_TREE_SHOW_TILES&&(this.featureTreeDebugger=new t({view:this}))})):t||!this.featureTreeDebugger||lr.FEATURE_TILE_TREE_SHOW_TILES||(this.featureTreeDebugger.destroy(),this.featureTreeDebugger=null)}),3),this.updatingHandles.add(this,"clippingArea",t,3),this.updatingHandles.add(this,"basemapTerrain.extent",t,3)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.deinit(),this.handles.remove("render-coords-helper"),this.handles.remove("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const t=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(t)||this._set("mapCoordsHelper",new cM(this.map,t));const e=this.state.isGlobal,i=function(t,e){return t?Yr(e):e.isGeographic?d.PlateCarree:e}(e,t);i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",yM.create(this.state.viewingMode,i)),e||this.handles.add(this.watch("basemapTerrain.extent",(t=>{0===t[0]&&0===t[1]&&0===t[2]&&0===t[3]||!Ue(t,this.basemapTerrain.spatialReference,VF,this.renderCoordsHelper.spatialReference)||(this.renderCoordsHelper.extent=VF)}),!0),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(Jn.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.handles.remove("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(t=null){p(t)&&4===t.type||(this.handles.remove("updatingMonitors"),this.allLayerViews.forEach((t=>{t.destroyed||(this.handles.add([t.watch(["updating","updatingProgress"],(()=>this.updatingChanged()),!0)],"updatingMonitors"),t.when((()=>this.updatingChanged()),(()=>this.updatingChanged())))})),this.updatingChanged())}_renderScreenshotOverlay(t,e){if(!this.overlay||!this.overlay.hasVisibleItems)return e;const i=t.getContext("2d");return i.putImageData(e,0,0),this.overlay.renderCanvas(t),i.getImageData(0,0,e.width,e.height)}_initStage(){const t={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,canvas:this.renderCanvas,screenshot:{renderOverlay:(t,e)=>this._renderScreenshotOverlay(t,e)}},e=new XC(this.state.viewingMode,(t=>this._stage.layers.forAll(t)),this);this._set("sceneIntersectionHelper",e);const i=Kt(this.surface),{resourceController:s,state:r,renderSpatialReference:o}=this;this._stage=new SF({options:t,container:i,resourceController:s,state:r,sceneIntersectionHelper:e,renderSR:o}),this._lostWebGLContextHandle=$t(this._stage.renderView.canvas,"webglcontextlost",(()=>this.fatalError=new n("webgl-context-lost"))),this.handles.add([this.updatingHandles.add(this.qualitySettings,"antialiasingEnabled",(()=>{this._stage.renderView.setRenderParameters({antialiasingEnabled:this.qualitySettings.antialiasingEnabled})}),2),this.updatingHandles.add(this.qualitySettings,"highQualityTransparency",(()=>{this._stage.renderView.setRenderParameters({highQualityTransparency:this.qualitySettings.highQualityTransparency})}),2),tt(this,"magnifier",(t=>this._stage.renderView.magnifier=t),!0)],"stage");const a=()=>{this._stage.renderView.setRenderParameters({defaultHighlightOptions:lM.toEngineOptions(this.highlightOptions)})};for(const t of["highlightOptions","highlightOptions.color","highlightOptions.haloColor","highlightOptions.haloOpacity","highlightOptions.fillOpacity","highlightOptions.shadowOpacity","highlightOptions.shadowColor","highlightOptions.shadowDifference"])this.handles.add(this.updatingHandles.add(this,t,a),"stage");a(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(Jn.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage.destroy(),this._stage=null,this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null,this.handles.remove("stage"),this._set("canvas",null)}_initSurface(t){this._exitSurface(),this.state.init(t,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new DM({view:this,viewingMode:t,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state,objectResourceCache:new qb})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController)return;if(0===this.graphics.length)return;this.handles.remove("graphics-view"),this._createGraphicsViewController=new AbortController;const t=()=>{this._createGraphicsViewController=null,this.updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(t,t),this.updatingChanged()}async _createGraphicsViewAsync(t){const e=(await import("./p-39f7cd7d.js")).default;mt(t),await Dt(this.basemapTerrain,"ready",t),this._set("graphicsView",new e({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.handles.remove("graphics-view"),p(this.graphicsView)&&(this.handles.remove(this.graphicsView.graphics3d.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const t=mf(this.viewingMode);if(1===t&&(this._clippingArea=null),this._set("ready",!0),this._initSurface(t),this.handles.add(X(this,"graphics","after-changes",(()=>this._createGraphicsViewIfNeeded())),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){const t=this.get("map.initialViewProperties.environment");t&&(this.environment=t)}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const e=this._resolveWhenReady;this._resolveWhenReady=[],e.forEach((t=>t(this)))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.handles.remove("graphics-view"),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(ch);for(const t of this.map.allLayers.items)"integrated-mesh"===t.type&&this._defaultToMapOptions.include.add(t.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(ch);for(const t of this.map.allLayers.items)"integrated-mesh"===t.type&&t.opacity<1&&this._defaultToMapOptions.exclude.add(t.uid)}}};function zF(t,e){t.layerUids||(t.layerUids=new Set),t.layerUids.add(e)}function LF(t,e){return p(t)&&Be(t.spatialReference,e)?je(t,e):null}r([o()],FF.prototype,"_userClippingArea",void 0),r([o()],FF.prototype,"_resourceController",void 0),r([o()],FF.prototype,"_stage",void 0),r([o({readOnly:!0})],FF.prototype,"deconflictor",void 0),r([o({readOnly:!0})],FF.prototype,"labeler",void 0),r([o({type:ie,readOnly:!0,aliasOf:"state.animation"})],FF.prototype,"animation",void 0),r([o({readOnly:!0})],FF.prototype,"basemapTerrain",void 0),r([o({readOnly:!0})],FF.prototype,"elevationProvider",void 0),r([o({type:Pe,aliasOf:"stateManager.camera"})],FF.prototype,"camera",void 0),r([o({type:Pe,aliasOf:"stateManager.contentCamera"})],FF.prototype,"contentCamera",void 0),r([o({readOnly:!0})],FF.prototype,"canvas",void 0),r([o({type:m,aliasOf:"stateManager.center"})],FF.prototype,"center",void 0),r([o({type:g})],FF.prototype,"clippingArea",null),r([o({type:Ef})],FF.prototype,"constraints",void 0),r([o({type:g,readOnly:!0})],FF.prototype,"renderDataExtent",null),r([o({type:g,readOnly:!0})],FF.prototype,"dataExtent",null),r([o({type:g,readOnly:!0})],FF.prototype,"groundAndLayersExtent",null),r([o({value:null,type:Uf})],FF.prototype,"environment",null),r([D("environment")],FF.prototype,"castEnvironment",null),r([o({readOnly:!0})],FF.prototype,"environmentManager",void 0),r([o({type:g,aliasOf:"stateManager.extent"})],FF.prototype,"extent",void 0),r([o()],FF.prototype,"floors",void 0),r([o({readOnly:!0,aliasOf:"stateManager.screenCenter"})],FF.prototype,"screenCenter",void 0),r([o({type:Number})],FF.prototype,"pixelRatio",null),r([o({type:Number,dependsOn:["qualitySettings.maximumPixelRatio","qualitySettings.maximumRenderResolution","size"]})],FF.prototype,"maximumPixelRatio",null),r([o({aliasOf:"stateManager.frustum"})],FF.prototype,"frustum",void 0),r([o({type:Number,readOnly:!0})],FF.prototype,"fullOpacity",void 0),r([o({readOnly:!0})],FF.prototype,"graphicsView",void 0),r([o()],FF.prototype,"groundView",void 0),r([o({type:Boolean})],FF.prototype,"initialExtentRequired",null),r([o({type:Boolean,readOnly:!0})],FF.prototype,"interacting",null),r([o()],FF.prototype,"stationary",null),r([o({aliasOf:"state.navigating"})],FF.prototype,"navigating",void 0),r([o()],FF.prototype,"map",void 0),r([o({readOnly:!0})],FF.prototype,"mapCoordsHelper",void 0),r([o({aliasOf:"stateManager.padding"})],FF.prototype,"padding",void 0),r([o({type:lS,readOnly:!0})],FF.prototype,"pointsOfInterest",void 0),r([o({type:wC,readOnly:!0})],FF.prototype,"featureTiles",void 0),r([o()],FF.prototype,"featureTreeDebugger",void 0),r([o({type:Boolean})],FF.prototype,"screenSizePerspectiveEnabled",void 0),r([o({constructOnly:!0})],FF.prototype,"deactivatedWebGLExtensions",void 0),r([o({constructOnly:!0})],FF.prototype,"debugWebGLExtensions",void 0),r([o({constructOnly:!0})],FF.prototype,"renderCanvas",void 0),r([o({constructOnly:!0})],FF.prototype,"state",void 0),r([o({readOnly:!0})],FF.prototype,"inputManager",void 0),r([o({readOnly:!0})],FF.prototype,"stateManager",void 0),r([o({type:["low","medium","high"]})],FF.prototype,"qualityProfile",null),r([o({type:vM,get(){let t=this._get("qualitySettings");return t||(t=new vM,aM.apply(this.qualityProfile,t)),t}})],FF.prototype,"qualitySettings",void 0),r([o()],FF.prototype,"slicePlane",null),r([o({dependsOn:["viewingMode"]})],FF.prototype,"preconditionsReady",void 0),r([o({readOnly:!0})],FF.prototype,"renderCoordsHelper",void 0),r([o({readOnly:!0})],FF.prototype,"sceneIntersectionHelper",void 0),r([o({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],FF.prototype,"resolution",null),r([o({type:Number,aliasOf:"stateManager.scale"})],FF.prototype,"scale",void 0),r([o({dependsOn:[]})],FF.prototype,"heightModelInfo",null),r([o({dependsOn:["map.initialViewProperties?.spatialReference","defaultsFromMap.isSpatialReferenceDone"]})],FF.prototype,"spatialReference",void 0),r([o({type:Boolean,constructOnly:!0})],FF.prototype,"alphaCompositingEnabled",void 0),r([o({type:Boolean})],FF.prototype,"supersampleScreenshotsEnabled",void 0),r([o({readOnly:!0})],FF.prototype,"type",void 0),r([o({type:OF})],FF.prototype,"ui",void 0),r([o({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.hasPendingInputs","toolViewManager.updating"]})],FF.prototype,"updating",null),r([o({type:Number,readOnly:!0,dependsOn:["updating"]})],FF.prototype,"updatingProgress",void 0),r([o({type:["global","local"],dependsOn:["map.initialViewProperties?.viewingMode","spatialReference"]})],FF.prototype,"viewingMode",null),r([o({type:Se,aliasOf:"stateManager.viewpoint"})],FF.prototype,"viewpoint",void 0),r([o({type:Number,aliasOf:"stateManager.zoom"})],FF.prototype,"zoom",void 0),r([o({type:lM})],FF.prototype,"highlightOptions",void 0),FF=r([a("esri.views.SceneView")],FF);const EF=js(),IF=Co(),VF=Ln(),jF=FF;let NF=class{constructor(i){t(this,i),this.loaded=e(this,"loaded",7)}validateApiKey(t){Jt.apiKey=t}validateItemId(t,e){t&&t!==e&&this.loadMap()}componentWillLoad(){this.apiKey&&(Jt.apiKey=this.apiKey),this.itemId&&this.loadMap()}componentDidRender(){const t=this.el.querySelector(".esri-view-user-storage");if(t){const e=Array.from(t.children);for(let t of e)t.tagName.toLowerCase().includes("arcgis-")&&(t.view=this.view)}}loadMap(){const t={};this.itemId&&(t.portalItem={id:this.itemId});const e=new ef(t),i={};this.zoom&&(i.zoom=this.zoom),this.center&&(i.center="string"==typeof this.center?this.center.split(",").map((t=>Number(t))):this.center);const s=new jF(Object.assign({container:this.el,map:e},i));this.view=s,s.when((()=>this.loaded.emit(!0)))}render(){return i("div",{class:"scene-view"})}get el(){return s(this)}static get watchers(){return{apiKey:["validateApiKey"],itemId:["validateItemId"]}}};NF.style="@import url('https://js.arcgis.com/next/esri/themes/light/main.css');.scene-view{padding:0;margin:0}";export{TF as A,NF as B,GA as D,qA as E,WA as F,UA as G,HA as H,ZA as J,QA as K,YA as L,XA as N,KA as O,$A as P,W_ as S,t_ as V,dT as a,vg as b,Rg as c,lP as d,j_ as e,om as f,IP as g,WP as h,Ag as i,U_ as j,mD as k,ZO as l,iP as m,xM as n,Yf as o,pS as p,xg as q,kg as r,rg as s,dS as t,WD as u,nO as v,sO as w,nR as x,lR as y,TR as z}