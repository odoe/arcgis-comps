import{e as t,A as s,af as i,ct as e,cs as h,u as n,V as r,aW as a,a as o,dB as l,p as c,d as u,i as d,r as p,bN as g,cp as f,ai as m,dC as v,K as w,S as y,bo as b,aI as M,cR as x,aE as D}from"./p-e58503d5.js";import{p as S,g as P,l as A,h as O,j as C,r as z,k as E,c as k,t as R,f as j,n as T,o as V}from"./p-90239435.js";import{x as G}from"./p-a6c8fb32.js";import{h as I}from"./p-e273719b.js";import{o as L,c as _,M as F,r as W,I as N,q as H,a as U,_ as B,u as Q,f as Z,F as q,E as X,B as K,v as Y,e as J,t as $,y as tt,d as st,h as it,s as et,z as ht,S as nt,H as rt,i as at,m as ot,g as lt,a7 as ct,V as ut}from"./p-2f398ed1.js";import{n as dt,b as pt,r as gt,f as ft}from"./p-d3105731.js";import{r as mt,t as vt}from"./p-09dd2137.js";import{D as wt,aM as yt,aN as bt,aO as Mt,aP as xt,aQ as Dt,au as St,P as Pt,n as At,W as Ot,aR as Ct,aF as zt,a1 as Et,aS as kt,ax as Rt,u as jt,aw as Tt,av as Vt,aT as Gt,aI as It}from"./p-340cd100.js";import{v as Lt,h as _t,j as Ft,m as Wt,l as Nt}from"./p-1c99992b.js";import{P as Ht,j as Ut,d as Bt,p as Qt,b as Zt,h as qt}from"./p-95909347.js";import{t as Xt,c as Kt}from"./p-c96ccdbf.js";import{n as Yt}from"./p-746a9d8f.js";import{n as Jt,r as $t,e as ts}from"./p-4d38e149.js";import{p as ss,v as is,D as es,W as hs}from"./p-dcdb33cf.js";import{t as ns}from"./p-04a0cfca.js";import{A as rs}from"./p-a72732f2.js";import{c as as,x as os,r as ls,R as cs,e as us,f as ds,q as ps,b as gs,i as fs,m as ms}from"./p-ccdb8e80.js";import{e as vs,r as ws,a as ys}from"./p-2c84c65f.js";import{a as bs,t as Ms,n as xs,e as Ds,b as Ss,c as Ps,d as As,f as Os,o as Cs,aE as zs,aF as Es,i as ks,m as Rs}from"./p-eb48bb01.js";import{o as js,s as Ts}from"./p-70787875.js";import{g as Vs,t as Gs,r as Is}from"./p-bdf9e611.js";import{f as Ls,h as _s}from"./p-19bc1e3d.js";import{D as Fs}from"./p-7f47b970.js";import{i as Ws,d as Ns,l as Hs,x as Us}from"./p-fb38a9d0.js";import{v as Bs,o as Qs,l as Zs,r as qs,s as Xs,B as Ks,j as Ys,f as Js,M as $s}from"./p-e6fe5d89.js";import{b as ti,x as si,w as ii,o as ei}from"./p-c93d2280.js";import{M as hi,B as ni,a as ri,_ as ai}from"./p-f94762ac.js";import{c as oi,t as li,f as ci}from"./p-3c70d22f.js";import{T as ui}from"./p-728dcbb0.js";import{y as di}from"./p-e1aac252.js";import{r as pi,e as gi}from"./p-f5813fa9.js";import{y as fi,p as mi,q as vi}from"./p-81049b2d.js";import{v as wi}from"./p-3bcc4805.js";import{r as yi}from"./p-8747982c.js";import{g as bi}from"./p-37f005a2.js";import{q as Mi,Y as xi,d as Di,O as Si,j as Pi,v as Ai,y as Oi,i as Ci,s as zi,a as Ei,b as ki,o as Ri,c as ji,P as Ti,Z as Vi,W as Gi,Q as Ii,K as Li,t as _i}from"./p-4d748bd1.js";import{O as Fi,M as Wi,x as Ni,n as Hi,r as Ui,b as Bi,y as Qi,z as Zi,m as qi,a as Xi,p as Ki,D as Yi,q as Ji,d as $i,e as te,S as se,v as ie}from"./p-11bb7abb.js";import{a as ee,d as he}from"./p-7731c620.js";import{F as ne}from"./p-ea916a39.js";import"./p-b9aa4901.js";import"./p-8f986f60.js";import"./p-a3955219.js";import"./p-c2152437.js";import{v as re}from"./p-7ee74a78.js";import{l as ae,z as oe,e as le,t as ce,i as ue,a as de}from"./p-ab86fcff.js";import{m as pe}from"./p-b79fcce3.js";import{w as ge}from"./p-2ae44317.js";import{S as fe}from"./p-6ded4c02.js";import{i as me,m as ve}from"./p-5d962998.js";import{v as we,l as ye}from"./p-9bdf9304.js";import{H as be}from"./p-01e5a461.js";import{K as Me,G as xe,D as De}from"./p-ea0c022e.js";function Se(t,s){t.extensions.add("GL_OES_standard_derivatives"),t.fragment.include(bs),t.include(js),t.fragment.uniforms.add("glowColor","vec3"),t.fragment.uniforms.add("glowWidth","float"),t.fragment.uniforms.add("glowFalloff","float"),t.fragment.uniforms.add("innerColor","vec3"),t.fragment.uniforms.add("innerWidth","float"),t.fragment.uniforms.add("depthMap","sampler2D"),t.fragment.uniforms.add("nearFar","vec2"),t.fragment.uniforms.add("frameColor","sampler2D"),s.contrastControlEnabled&&t.fragment.uniforms.add("globalAlphaContrastBoost","float"),t.fragment.code.add(Ms`vec4 blendPremultiplied(vec4 source, vec4 dest) {
float oneMinusSourceAlpha = 1.0 - source.a;
return vec4(
source.rgb + dest.rgb * oneMinusSourceAlpha,
source.a + dest.a * oneMinusSourceAlpha
);
}`),t.fragment.code.add(Ms`vec4 premultipliedColor(vec3 rgb, float alpha) {
return vec4(rgb * alpha, alpha);
}`),t.fragment.code.add(Ms`vec4 laserlineProfile(float dist) {
if (dist > glowWidth) {
return vec4(0.0);
}
float innerAlpha = (1.0 - smoothstep(0.0, innerWidth, dist));
float glowAlpha = pow(max(0.0, 1.0 - dist / glowWidth), glowFalloff);
return blendPremultiplied(
premultipliedColor(innerColor, innerAlpha),
premultipliedColor(glowColor, glowAlpha)
);
}`),t.fragment.code.add(Ms`bool laserlineReconstructFromDepth(out vec3 pos, out vec3 normal, out float depthDiscontinuityAlpha) {
float depth = linearDepthFromTexture(depthMap, uv, nearFar);
if (-depth == nearFar[0]) {
return false;
}
pos = reconstructPosition(gl_FragCoord.xy, depth);
normal = normalize(cross(dFdx(pos), dFdy(pos)));
float ddepth = fwidth(depth);
depthDiscontinuityAlpha = 1.0 - smoothstep(0.0, 0.01, -ddepth / depth);
return true;
}`),t.fragment.code.add(s.contrastControlEnabled?Ms`float rgbToLuminance(vec3 color) {
return dot(vec3(0.2126, 0.7152, 0.0722), color);
}
vec4 laserlineOutput(vec4 color) {
float backgroundLuminance = rgbToLuminance(texture2D(frameColor, uv).rgb);
float alpha = clamp(globalAlpha * max(backgroundLuminance * globalAlphaContrastBoost, 1.0), 0.0, 1.0);
return color * alpha;
}`:Ms`vec4 laserlineOutput(vec4 color) {
return color * globalAlpha;
}`)}function Pe(t){const s=new xs;return s.include(Se,t),s.vertex.uniforms.add("uModelViewMatrix","mat4"),s.vertex.uniforms.add("uProjectionMatrix","mat4"),s.attributes.add("start","vec3"),s.attributes.add("end","vec3"),s.attributes.add("up","vec3"),s.attributes.add("extrude","vec2"),s.varyings.add("uv","vec2"),s.varyings.add("vViewStart","vec3"),s.varyings.add("vViewEnd","vec3"),s.varyings.add("vViewPlane","vec4"),s.vertex.uniforms.add("glowWidth","float"),s.vertex.uniforms.add("pixelToNDC","vec2"),s.vertex.code.add(Ms`void main() {
vec3 pos = mix(start, end, extrude.x);
vec4 viewPos = uModelViewMatrix * vec4(pos, 1);
vec4 projPos = uProjectionMatrix * viewPos;
vec2 ndcPos = projPos.xy / projPos.w;
vec3 viewUp = (uModelViewMatrix * vec4(extrude.y * up, 0)).xyz;
vec4 projPosUp = uProjectionMatrix * vec4(viewPos.xyz + viewUp, 1);
vec2 projExtrudeDir = normalize(projPosUp.xy / projPosUp.w - ndcPos);
vec2 lxy = abs(sign(projExtrudeDir) - ndcPos);
ndcPos += length(lxy) * projExtrudeDir;
vec3 worldPlaneNormal = normalize(cross(up, normalize(end - start)));
vec3 viewPlaneNormal = (uModelViewMatrix * vec4(worldPlaneNormal, 0)).xyz;
vViewStart = (uModelViewMatrix * vec4(start, 1)).xyz;
vViewEnd = (uModelViewMatrix * vec4(end, 1)).xyz;
vViewPlane = vec4(viewPlaneNormal, -dot(viewPlaneNormal, vViewStart));
float xPaddingPixels = sign(dot(viewPlaneNormal, viewPos.xyz)) * (extrude.x * 2.0 - 1.0) * glowWidth;
ndcPos.x += xPaddingPixels * pixelToNDC.x;
uv = ndcPos * 0.5 + 0.5;
gl_Position = vec4(ndcPos, 0, 1);
}`),s.fragment.uniforms.add("globalAlpha","float"),s.fragment.uniforms.add("perScreenPixelRatio","float"),s.fragment.code.add(Ms`float planeDistancePixels(vec4 plane, vec3 pos, vec3 start, vec3 end) {
vec3 origin = mix(start, end, 0.5);
vec3 basis = end - origin;
vec3 posAtOrigin = pos - origin;
float x = dot(normalize(basis), posAtOrigin);
float y = dot(plane.xyz, posAtOrigin);
float dx = max(abs(x) - length(basis), 0.0);
float dy = y;
float dist = length(vec2(dx, dy));
float width = fwidth(y);
float maxPixelDistance = length(pos) * perScreenPixelRatio * 2.0;
float pixelDist = dist / min(width, maxPixelDistance);
return abs(pixelDist);
}
void main() {
vec3 pos;
vec3 normal;
float depthDiscontinuityAlpha;
if (!laserlineReconstructFromDepth(pos, normal, depthDiscontinuityAlpha)) {
discard;
}
float distance = planeDistancePixels(vViewPlane, pos, vViewStart, vViewEnd);
vec4 color = laserlineProfile(distance);
float alpha = 1.0 - smoothstep(0.995, 0.999, abs(dot(normal, vViewPlane.xyz)));
gl_FragColor = laserlineOutput(color * alpha * depthDiscontinuityAlpha);
}`),s}const Ae=Object.freeze({__proto__:null,build:Pe});class Oe extends Ps{initializeProgram(t){const s=Oe.shader.get().build(this.configuration);return new As(t.rctx,s,Oe.attributeLocations)}bind(t,s,i){this.program.setUniform3fv("innerColor",t.innerColor),this.program.setUniform1f("innerWidth",t.innerWidth*i.pixelRatio),this.program.setUniform3fv("glowColor",t.glowColor),this.program.setUniform1f("glowWidth",t.glowWidth*i.pixelRatio),this.program.setUniform1f("glowFalloff",t.glowFalloff),this.program.setUniform1f("globalAlpha",t.globalAlpha),this.program.setUniform1f("perScreenPixelRatio",i.perScreenPixelRatio),this.program.setUniform2f("pixelToNDC",2/i.fullWidth,2/i.fullHeight),this.program.setUniformMatrix4fv("uProjectionMatrix",i.projectionMatrix),as(ze,i.viewMatrix,s),this.program.setUniformMatrix4fv("uModelViewMatrix",ze),this.configuration.contrastControlEnabled&&this.program.setUniform1f("globalAlphaContrastBoost",null!=t.globalAlphaContrastBoost?t.globalAlphaContrastBoost:1)}initializePipeline(){return Vs({blending:Gs(1,771),colorWrite:Is})}}Oe.shader=new Os(Ae,(()=>import("./p-139083c3.js"))),Oe.attributeLocations=new Map([["start",0],["end",1],["up",2],["extrude",3]]);class Ce extends Ss{constructor(){super(...arguments),this.contrastControlEnabled=!1}}t([Ds()],Ce.prototype,"contrastControlEnabled",void 0);const ze=vs();class Ee{constructor(t){this._renderCoordsHelper=t,this._buffers=null,this._origin=dt(),this._dirty=!1,this._count=0,this._vao=null}set vertices(t){const s=new Float64Array(3*t.length);let i=0;for(const e of t)s[i++]=e[0],s[i++]=e[1],s[i++]=e[2];this.buffers=[s]}set buffers(t){if(this._buffers=t,this._buffers.length>0){const t=this._buffers[0],s=3*Math.floor(t.length/3/2);L(this._origin,t[s+0],t[s+1],t[s+2])}else L(this._origin,0,0,0);this._dirty=!0}get origin(){return this._origin}draw(t){const i=this.ensureVAO(t);s(i)&&(t.bindVAO(i),t.drawArrays(4,0,this._count))}dispose(){s(this._vao)&&this._vao.dispose()}ensureVAO(t){return i(this._buffers)?null:(i(this._vao)&&(this._vao=this.createVAO(t,this._buffers)),this.ensureVertexData(this._vao,this._buffers),this._vao)}createVAO(t,s){const i=this.createDataBuffer(s);return this._dirty=!1,new Ls(t,Oe.attributeLocations,{data:ns(je)},{data:_s.createVertex(t,35044,i)})}ensureVertexData(t,s){if(!this._dirty)return;const i=this.createDataBuffer(s);t.vertexBuffers.data.setData(i),this._dirty=!1}numberOfRenderVertices(t){return 2*(t.length/3-1)*3}createDataBuffer(t){const s=t.reduce(((t,s)=>t+this.numberOfRenderVertices(s)),0);this._count=s;const i=je.createBuffer(s),e=this._origin;let h=0,n=0;for(const s of t){for(let t=0;t<s.length;t+=3){const r=L(Re,s[t+0],s[t+1],s[t+2]);0===t?n=this._renderCoordsHelper.getAltitude(r):this._renderCoordsHelper.setAltitude(r,n);const a=this._renderCoordsHelper.worldUpAtPosition(r,ke),o=h+2*t,l=_(Re,r,e);if(t<s.length-3){i.up.setVec(o,a),i.up.setVec(o+3,a),i.up.setVec(o+5,a);for(let t=0;t<6;t++)i.start.setVec(o+t,l);i.extrude.setValues(o+0,0,-1),i.extrude.setValues(o+1,1,-1),i.extrude.setValues(o+2,1,1),i.extrude.setValues(o+3,0,-1),i.extrude.setValues(o+4,1,1),i.extrude.setValues(o+5,0,1)}if(t>0){i.up.setVec(o-2,a),i.up.setVec(o-4,a),i.up.setVec(o-5,a);for(let t=-6;t<0;t++)i.end.setVec(o+t,l)}}h+=this.numberOfRenderVertices(s)}return i.buffer}}const ke=dt(),Re=dt(),je=rs().vec3f("start").vec3f("end").vec3f("up").vec2f("extrude"),Te=F(6);function Ve(t){const s=new xs;return s.extensions.add("GL_OES_standard_derivatives"),s.include(wt),s.include(Se,t),s.fragment.uniforms.add("angleCutoff","vec2"),s.fragment.uniforms.add("globalAlpha","float"),t.heightManifoldEnabled&&s.fragment.uniforms.add("heightPlane","vec4"),t.pointDistanceEnabled&&s.fragment.uniforms.add("pointDistanceSphere","vec4"),t.lineVerticalPlaneEnabled&&s.fragment.uniforms.add("lineVerticalPlane","vec4").add("lineVerticalStart","vec3").add("lineVerticalEnd","vec3"),(t.heightManifoldEnabled||t.pointDistanceEnabled||t.lineVerticalPlaneEnabled)&&s.fragment.uniforms.add("maxPixelDistance","float"),t.intersectsLineEnabled&&s.fragment.uniforms.add("intersectsLineStart","vec3").add("intersectsLineEnd","vec3").add("intersectsLineDirection","vec3").add("intersectsLineRadius","float").add("perScreenPixelRatio","float"),(t.lineVerticalPlaneEnabled||t.heightManifoldEnabled)&&s.fragment.code.add(Ms`float planeDistancePixels(vec4 plane, vec3 pos) {
float dist = dot(plane.xyz, pos) + plane.w;
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}`),t.pointDistanceEnabled&&s.fragment.code.add(Ms`float sphereDistancePixels(vec4 sphere, vec3 pos) {
float dist = distance(sphere.xyz, pos) - sphere.w;
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}`),t.intersectsLineEnabled&&s.fragment.code.add(Ms`float lineDistancePixels(vec3 start, vec3 dir, float radius, vec3 pos) {
float dist = length(cross(dir, pos - start)) / (length(pos) * perScreenPixelRatio);
return abs(dist) - radius;
}`),(t.lineVerticalPlaneEnabled||t.intersectsLineEnabled)&&s.fragment.code.add(Ms`bool pointIsWithinLine(vec3 pos, vec3 start, vec3 end) {
vec3 dir = end - start;
float t2 = dot(dir, pos - start);
float l2 = dot(dir, dir);
return t2 >= 0.0 && t2 <= l2;
}`),s.fragment.code.add(Ms`void main() {
vec3 pos;
vec3 normal;
float depthDiscontinuityAlpha;
if (!laserlineReconstructFromDepth(pos, normal, depthDiscontinuityAlpha)) {
discard;
}
vec4 color = vec4(0, 0, 0, 0);`),t.heightManifoldEnabled&&s.fragment.code.add(Ms`{
float heightManifoldAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, heightPlane.xyz)));
vec4 heightManifoldColor = laserlineProfile(planeDistancePixels(heightPlane, pos));
color = max(color, heightManifoldColor * heightManifoldAlpha);
}`),t.pointDistanceEnabled&&s.fragment.code.add(Ms`{
float pointDistanceSphereDistance = sphereDistancePixels(pointDistanceSphere, pos);
vec4 pointDistanceSphereColor = laserlineProfile(pointDistanceSphereDistance);
float pointDistanceSphereAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, normalize(pos - pointDistanceSphere.xyz))));
color = max(color, pointDistanceSphereColor * pointDistanceSphereAlpha);
}`),t.lineVerticalPlaneEnabled&&s.fragment.code.add(Ms`{
if (pointIsWithinLine(pos, lineVerticalStart, lineVerticalEnd)) {
float lineVerticalDistance = planeDistancePixels(lineVerticalPlane, pos);
vec4 lineVerticalColor = laserlineProfile(lineVerticalDistance);
float lineVerticalAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, lineVerticalPlane.xyz)));
color = max(color, lineVerticalColor * lineVerticalAlpha);
}
}`),t.intersectsLineEnabled&&s.fragment.code.add(Ms`{
if (pointIsWithinLine(pos, intersectsLineStart, intersectsLineEnd)) {
float intersectsLineDistance = lineDistancePixels(intersectsLineStart, intersectsLineDirection, intersectsLineRadius, pos);
vec4 intersectsLineColor = laserlineProfile(intersectsLineDistance);
float intersectsLineAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, 1.0 - abs(dot(normal, intersectsLineDirection)));
color = max(color, intersectsLineColor * intersectsLineAlpha);
}
}`),s.fragment.code.add(Ms`gl_FragColor = laserlineOutput(color * depthDiscontinuityAlpha);
}`),s}const Ge=Object.freeze({__proto__:null,defaultAngleCutoff:Te,build:Ve});class Ie extends Ps{initializeProgram(t){const s=Ie.shader.get().build(this.configuration);return new As(t.rctx,s,Cs)}bind(t,s){this.program.setUniform3fv("innerColor",t.innerColor),this.program.setUniform1f("innerWidth",t.innerWidth*s.pixelRatio),this.program.setUniform3fv("glowColor",t.glowColor),this.program.setUniform1f("glowWidth",t.glowWidth*s.pixelRatio),this.program.setUniform1f("glowFalloff",t.glowFalloff),this.program.setUniform1f("globalAlpha",t.globalAlpha),this.configuration.contrastControlEnabled&&this.program.setUniform1f("globalAlphaContrastBoost",null!=t.globalAlphaContrastBoost?t.globalAlphaContrastBoost:1);const i=null!=t.angleCutoff?t.angleCutoff:Te;this.program.setUniform2f("angleCutoff",Math.cos(i),Math.cos(Math.max(0,i-F(2)))),this.configuration.intersectsLineEnabled&&this.program.setUniform1f("perScreenPixelRatio",s.perScreenPixelRatio)}initializePipeline(){return Vs({blending:Gs(1,771),colorWrite:Is})}}Ie.shader=new Os(Ge,(()=>import("./p-655176b7.js")));class Le extends Ss{constructor(){super(...arguments),this.heightManifoldEnabled=!1,this.pointDistanceEnabled=!1,this.lineVerticalPlaneEnabled=!1,this.intersectsLineEnabled=!1,this.contrastControlEnabled=!1}}t([Ds()],Le.prototype,"heightManifoldEnabled",void 0),t([Ds()],Le.prototype,"pointDistanceEnabled",void 0),t([Ds()],Le.prototype,"lineVerticalPlaneEnabled",void 0),t([Ds()],Le.prototype,"intersectsLineEnabled",void 0),t([Ds()],Le.prototype,"contrastControlEnabled",void 0);const _e=dt(),Fe=Jt(),We={glowColor:[1,.5,0],glowWidth:8,glowFalloff:8,innerColor:[1,1,1],innerWidth:1,globalAlpha:.75,angleCutoff:F(6),globalAlphaContrastBoost:2};function Ne(t,s,i,e){const h=_e,n=Fe;N(h,s,e),W(n,i),n[3]=0,Z(n,n,e),is(h,n,t)}class He{constructor(t,s={},i={contrastControlEnabled:!1}){this._renderCoordsHelper=t,this._config=i,this._technique=null,this._projInfo=Jt(),this._zScale=Yt(),this._heightManifoldEnabled=!1,this._heightManifoldTarget=dt(),this._pointDistanceEnabled=!1,this._pointDistanceOrigin=dt(),this._pointDistanceTarget=dt(),this._lineVerticalPlaneEnabled=!1,this._lineVerticalPlaneSegment=Lt(),this._intersectsLineEnabled=!1,this._intersectsLineSegment=Lt(),this._intersectsLineRadius=3,this._intersectsLineInfinite=!1,this._pathVerticalPlaneEnabled=!1,this._pathVerticalPlaneData=null,this._pathTechnique=null,this.canRender=!0,this._tempNormal=dt(),this._tempDir=dt(),this._tempUp=dt(),this._tempVec3A=dt(),this._tempVec3B=dt(),this._tempVec4=Jt(),this._tempPlane=ss(),this._tempSphere=Ht(),this._params=zs(s,We)}get renderSlots(){return[this._config.contrastControlEnabled?15:14]}get needsLinearDepth(){return!0}get heightManifoldEnabled(){return this._heightManifoldEnabled}set heightManifoldEnabled(t){this._heightManifoldEnabled!==t&&(this._heightManifoldEnabled=t,this._requestRender())}get heightManifoldTarget(){return this._heightManifoldTarget}set heightManifoldTarget(t){W(this._heightManifoldTarget,t),this._requestRender()}get pointDistanceEnabled(){return this._pointDistanceEnabled}set pointDistanceEnabled(t){t!==this._pointDistanceEnabled&&(this._pointDistanceEnabled=t,this._requestRender())}get pointDistanceTarget(){return this._pointDistanceTarget}set pointDistanceTarget(t){W(this._pointDistanceTarget,t),this._requestRender()}get pointDistanceOrigin(){return this._pointDistanceOrigin}set pointDistanceOrigin(t){W(this._pointDistanceOrigin,t),this._requestRender()}get lineVerticalPlaneEnabled(){return this._lineVerticalPlaneEnabled}set lineVerticalPlaneEnabled(t){t!==this._lineVerticalPlaneEnabled&&(this._lineVerticalPlaneEnabled=t,this._requestRender())}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(t){_t(t,this._lineVerticalPlaneSegment),this._requestRender()}get intersectsLineEnabled(){return this._intersectsLineEnabled}set intersectsLineEnabled(t){t!==this._intersectsLineEnabled&&(this._intersectsLineEnabled=t,this._requestRender())}get intersectsLineSegment(){return this._intersectsLineSegment}set intersectsLineSegment(t){_t(t,this._intersectsLineSegment),this._requestRender()}get intersectsLineRadius(){return this._intersectsLineRadius}set intersectsLineRadius(t){t!==this._intersectsLineRadius&&(this._intersectsLineRadius=t,this._requestRender())}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(t){t!==this._intersectsLineInfinite&&(this._intersectsLineInfinite=t,this._requestRender())}get pathVerticalPlaneEnabled(){return this._pathVerticalPlaneEnabled}set pathVerticalPlaneEnabled(t){t!==this._pathVerticalPlaneEnabled&&(this._pathVerticalPlaneEnabled=t,s(this._pathVerticalPlaneData)&&this._requestRender())}set pathVerticalPlaneVertices(t){i(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new Ee(this._renderCoordsHelper)),this._pathVerticalPlaneData.vertices=t,this.pathVerticalPlaneEnabled&&this._requestRender()}set pathVerticalPlaneBuffers(t){i(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new Ee(this._renderCoordsHelper)),this._pathVerticalPlaneData.buffers=t,this.pathVerticalPlaneEnabled&&this._requestRender()}setParameters(t){Es(this._params,t)&&this._requestRender()}initializeRenderContext(t){this._context=t,this._quadVAO=ks(t.renderContext.rctx),this._techniqueRepository=t.shaderTechniqueRep,this._techniqueConfig=new Le;const s=new Ce;s.contrastControlEnabled=this._config.contrastControlEnabled,this._pathTechnique=this._techniqueRepository.acquire(Oe,s)}uninitializeRenderContext(){this._quadVAO=e(this._quadVAO),this._technique=h(this._technique),this._pathVerticalPlaneData=e(this._pathVerticalPlaneData),this._pathTechnique=h(this._pathTechnique)}render(t){const s=this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled,i=this.pathVerticalPlaneEnabled;if(!s&&!i)return!1;const e=t.camera;return Fs(e.projectionMatrix,e.fullWidth,e.fullHeight,this._projInfo,this._zScale),s&&this.renderUnified(t),i&&this.renderPath(t),!0}renderUnified(t){const s=t.rctx,i=this._selectTechnique(),e=i.program;s.useProgram(e),i.bindPipelineState(s),this._bindGlobalUniforms(t,e),this.bindHeightManifoldUniforms(t,e),this.bindPointDistanceUniforms(t,e),this.bindLineVerticalPlaneUniforms(t,e),this.bindIntersectsLineUniforms(t,e),i.bind(this._params,t.camera),s.bindVAO(this._quadVAO),s.drawArrays(5,0,4)}renderPath(t){if(i(this._pathVerticalPlaneData)||i(this._pathTechnique))return;const s=t.rctx,e=this._pathTechnique,h=e.program;s.useProgram(h),e.bindPipelineState(s),this._bindGlobalUniforms(t,h),e.bind(this._params,this._pathVerticalPlaneData.origin,t.camera),this._pathVerticalPlaneData.draw(t.rctx)}bindHeightManifoldUniforms(t,s){if(!this.heightManifoldEnabled)return;const i=this._tempVec3A,e=this._tempPlane;this._renderCoordsHelper.worldUpAtPosition(this._heightManifoldTarget,i),Ne(e,this._heightManifoldTarget,i,t.camera.viewMatrix),s.setUniform4fv("heightPlane",e)}bindPointDistanceUniforms(t,s){if(!this._pointDistanceEnabled)return;const i=t.camera,e=this._tempSphere;W(e,this._pointDistanceOrigin),N(e,e,i.viewMatrix),e[3]=H(this._pointDistanceOrigin,this._pointDistanceTarget),s.setUniform4f("pointDistanceSphere",e[0],e[1],e[2],e[3])}bindLineVerticalPlaneUniforms(t,s){if(!this._lineVerticalPlaneEnabled)return;const i=this._renderCoordsHelper,e=t.camera,h=this._tempPlane,n=this._tempVec3A,r=this._tempUp,a=this._tempDir,o=this._tempNormal;Ft(this._lineVerticalPlaneSegment,.5,n),i.worldUpAtPosition(n,r),U(a,this._lineVerticalPlaneSegment.vector),B(o,r,a),U(o,o),Ne(h,this._lineVerticalPlaneSegment.origin,o,e.viewMatrix),s.setUniform4fv("lineVerticalPlane",h);const l=this._tempVec3A;W(l,this._lineVerticalPlaneSegment.origin),i.setAltitude(l,0),N(l,l,e.viewMatrix),s.setUniform3fv("lineVerticalStart",l);const c=this._tempVec3B;Q(c,this._lineVerticalPlaneSegment.origin,this._lineVerticalPlaneSegment.vector),i.setAltitude(c,0),N(c,c,e.viewMatrix),s.setUniform3fv("lineVerticalEnd",c)}bindIntersectsLineUniforms(t,s){if(!this._intersectsLineEnabled)return;const i=Be,e=Qe;if(this._intersectsLineInfinite){const s=t.camera;if(yt(Ut(this._intersectsLineSegment.origin,this._intersectsLineSegment.vector),Ue),Ue.c0=-Number.MAX_VALUE,!bt(s.frustum,Ue))return;Mt(Ue,i),xt(Ue,e)}else W(i,this._intersectsLineSegment.origin),Q(e,this._intersectsLineSegment.origin,this._intersectsLineSegment.vector);const h=this._tempVec3A;N(h,i,t.camera.viewMatrix),s.setUniform3fv("intersectsLineStart",h);const n=this._tempVec4;W(n,this._intersectsLineSegment.vector),this._tempVec4[3]=0,Z(this._tempVec4,this._tempVec4,t.camera.viewMatrix),N(e,e,t.camera.viewMatrix),s.setUniform3fv("intersectsLineEnd",e),U(n,n),s.setUniform3f("intersectsLineDirection",n[0],n[1],n[2]),s.setUniform1f("intersectsLineRadius",this._intersectsLineRadius)}_bindGlobalUniforms(t,s){const i=t.camera;s.setUniform4fv("projInfo",this._projInfo),s.setUniform2fv("zScale",this._zScale),s.setUniform2f("nearFar",i.near,i.far),this._heightManifoldEnabled?s.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._heightManifoldTarget)):this._pointDistanceEnabled?s.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._pointDistanceTarget)):this._lineVerticalPlaneEnabled&&s.setUniform1f("maxPixelDistance",2*i.computeScreenPixelSizeAt(this._lineVerticalPlaneSegment.origin)),s.bindTexture(t.offscreenRenderingHelper.linearDepthTexture,"depthMap"),s.bindTexture(t.offscreenRenderingHelper.mainColorTexture,"frameColor")}_requestRender(){this._context&&this._context.requestRender()}_selectTechnique(){return this._techniqueConfig.heightManifoldEnabled=this.heightManifoldEnabled,this._techniqueConfig.lineVerticalPlaneEnabled=this.lineVerticalPlaneEnabled,this._techniqueConfig.pointDistanceEnabled=this.pointDistanceEnabled,this._techniqueConfig.intersectsLineEnabled=this.intersectsLineEnabled,this._techniqueConfig.contrastControlEnabled=this._config.contrastControlEnabled,this._technique=this._techniqueRepository.releaseAndAcquire(Ie,this._techniqueConfig,this._technique),this._technique}}const Ue=Dt(),Be=dt(),Qe=dt();class Ze extends Xt{constructor(t){super(t.view),this._angleCutoff=Te,this._style={},this._heightManifoldTarget=dt(),this._heightManifoldEnabled=!1,this._intersectsLine=Lt(),this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._lineVerticalPlaneSegment=null,this._pathVerticalPlaneBuffers=null,this._pointDistanceLine=null,this.applyProps(t)}get testData(){return this.renderer}createResources(){this.ensureRenderer()}destroyResources(){this.disposeRenderer()}updateVisibility(){this.syncHeightManifold(),this.syncIntersectsLine(),this.syncPathVerticalPlane(),this.syncLineVerticalPlane(),this.syncPointDistance()}get angleCutoff(){return this._angleCutoff}set angleCutoff(t){this._angleCutoff!==t&&(this._angleCutoff=t,this.syncAngleCutoff())}get style(){return this._style}set style(t){this._style=t,this.syncStyle()}get heightManifoldTarget(){return this._heightManifoldEnabled?this._heightManifoldTarget:null}set heightManifoldTarget(t){s(t)?(W(this._heightManifoldTarget,t),this._heightManifoldEnabled=!0):this._heightManifoldEnabled=!1,this.syncRenderer(),this.syncHeightManifold()}set intersectsWorldUpAtLocation(t){if(i(t))return void(this.intersectsLine=null);const s=this.view.renderCoordsHelper.worldUpAtPosition(t,qe);this.intersectsLine=Wt(t,s),this.intersectsLineInfinite=!0}get intersectsLine(){return this._intersectsLineEnabled?this._intersectsLine:null}set intersectsLine(t){s(t)?(_t(t,this._intersectsLine),this._intersectsLineEnabled=!0):this._intersectsLineEnabled=!1,this.syncIntersectsLine(),this.syncRenderer()}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(t){this._intersectsLineInfinite=t,this.syncIntersectsLineInfinite()}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(t){this._lineVerticalPlaneSegment=s(t)?_t(t):null,this.syncLineVerticalPlane(),this.syncRenderer()}get pathVerticalPlane(){return this._pathVerticalPlaneBuffers}set pathVerticalPlane(t){this._pathVerticalPlaneBuffers=t,this.syncPathVerticalPlane(),this.syncLineVerticalPlane(),this.syncPointDistance(),this.syncRenderer()}get pointDistanceLine(){return this._pointDistanceLine}set pointDistanceLine(t){this._pointDistanceLine=s(t)?{origin:pt(t.origin),target:pt(t.target)}:null,this.syncPointDistance(),this.syncRenderer()}syncRenderer(){this.attached&&(this._intersectsLineEnabled||this._heightManifoldEnabled||s(this._pointDistanceLine)||s(this._pathVerticalPlaneBuffers))?this.ensureRenderer():this.disposeRenderer()}ensureRenderer(){s(this.renderer)||(this.renderer=new He(this.view.renderCoordsHelper,void 0,{contrastControlEnabled:!0}),this.syncStyle(),this.syncHeightManifold(),this.syncIntersectsLine(),this.syncIntersectsLineInfinite(),this.syncPathVerticalPlane(),this.syncLineVerticalPlane(),this.syncPointDistance(),this.syncAngleCutoff(),this.view._stage&&this.view._stage.addRenderPlugin(this.renderer.renderSlots,this.renderer))}syncStyle(){i(this.renderer)||(this.renderer.setParameters(this._style),null!=this._style.intersectsLineRadius&&(this.renderer.intersectsLineRadius=this._style.intersectsLineRadius))}syncAngleCutoff(){i(this.renderer)||this.renderer.setParameters({angleCutoff:this._angleCutoff})}syncHeightManifold(){i(this.renderer)||(this.renderer.heightManifoldEnabled=this._heightManifoldEnabled&&this.visible,this._heightManifoldEnabled&&(this.renderer.heightManifoldTarget=this._heightManifoldTarget))}syncIntersectsLine(){i(this.renderer)||(this.renderer.intersectsLineEnabled=this._intersectsLineEnabled&&this.visible,this._intersectsLineEnabled&&(this.renderer.intersectsLineSegment=this._intersectsLine))}syncIntersectsLineInfinite(){i(this.renderer)||(this.renderer.intersectsLineInfinite=this._intersectsLineInfinite)}syncPathVerticalPlane(){i(this.renderer)||(this.renderer.pathVerticalPlaneEnabled=s(this._pathVerticalPlaneBuffers)&&this.visible,s(this._pathVerticalPlaneBuffers)&&(this.renderer.pathVerticalPlaneBuffers=this._pathVerticalPlaneBuffers))}syncLineVerticalPlane(){i(this.renderer)||(this.renderer.lineVerticalPlaneEnabled=s(this._lineVerticalPlaneSegment)&&this.visible,s(this._lineVerticalPlaneSegment)&&(this.renderer.lineVerticalPlaneSegment=this._lineVerticalPlaneSegment))}syncPointDistance(){i(this.renderer)||(this.renderer.pointDistanceEnabled=s(this._pointDistanceLine)&&this.visible,s(this._pointDistanceLine)&&(this.renderer.pointDistanceOrigin=this._pointDistanceLine.origin,this.renderer.pointDistanceTarget=this._pointDistanceLine.target))}disposeRenderer(){s(this.renderer)&&this.view._stage&&(this.view._stage.removeRenderPlugin(this.renderer),this.renderer=null)}}const qe=dt();class Xe extends Kt{constructor(t){super(t),this._ray=Bt(),this._externalResources=null,this._handles=new n,this._isWorldDown=!1,this._start=dt(),this._end=gt(1,0,0),this._width=1,this._color=mt(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=mt(1,1,1,1),this._stippleIntegerRepeats=!0,this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._extensionType=0,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=4,this._fadedExtensions=sh,this.applyProps(t)}createExternalResources(){const t=new St(this.materialParameters);this._handles.add(this.view.state.watch("camera",(()=>{this.updateGeometry()})));const s=new Ze({view:this.view,attached:this._laserlineEnabled});this._externalResources={material:t,laserline:s}}destroyExternalResources(){s(this._externalResources)&&this._externalResources.laserline.destroy(),this._externalResources=null,this._handles.removeAll()}forEachExternalMaterial(t){s(this._externalResources)&&t(this._externalResources.material)}createGeometries(t){const s=[dt(),dt()],i=3===this.extensionType;i&&s.push(dt(),dt());const e=i?new Float32Array([1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]):null,h=Pt.createPolylineGeometry(s,null,e);t.addGeometry(h,r(this._externalResources).material),this.updateVertices(t)}updateVisibility(t){super.updateVisibility(t),s(this._externalResources)&&(this._externalResources.laserline.visible=t)}setStartEndFromWorldDownAtLocation(t){this._isWorldDown=!0,W(this._start,t),this.view.renderCoordsHelper.worldUpAtPosition(t,this._end),_(this._end,t,this._end),Qt(this._start,this._end,this._ray),this.updateGeometry()}get start(){return this._start}set start(t){this._isWorldDown=!1,q(this._start,t)||(W(this._start,t),Qt(this._start,this._end,this._ray),this.updateGeometry())}get end(){return this._end}set end(t){this._isWorldDown=!1,q(this._end,t)||(W(this._end,t),Qt(this._start,this._end,this._ray),this.updateGeometry())}get width(){return this._width}set width(t){t!==this._width&&(this._width=t,this.updateMaterial())}get color(){return this._color}set color(t){X(t,this._color)||(K(this._color,t),this.updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(t){t!==this._polygonOffset&&(this._polygonOffset=t,this.updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(t){this._writeDepthEnabled!==t&&(this._writeDepthEnabled=t,this.updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(t){t!==this._innerWidth&&(this._innerWidth=t,this.updateMaterial())}get innerColor(){return this._innerColor}set innerColor(t){X(t,this._innerColor)||(K(this._innerColor,t),this.updateMaterial())}get stippleIntegerRepeats(){return this._stippleIntegerRepeats}set stippleIntegerRepeats(t){t!==this._stippleIntegerRepeats&&(this._stippleIntegerRepeats=t,this.updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(t){const i=s(t)!==s(this._stipplePattern);this._stipplePattern=t,i?this.recreate():this.updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(t){(i(t)||i(this._stippleOffColor)||!X(t,this._stippleOffColor))&&(this._stippleOffColor=s(t)?vt(t):null,this.updateMaterial())}get falloff(){return this._falloff}set falloff(t){t!==this._falloff&&(this._falloff=t,this.updateMaterial())}get extensionType(){return this._extensionType}set extensionType(t){t!==this._extensionType&&(this._extensionType=t,this.updateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&s(this._laserlineStyle)}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(t){this._laserlineStyle=t,s(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached,s(t)&&(this._externalResources.laserline.style=t))}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(t){this._laserlineEnabled!==t&&(this._laserlineEnabled=t,s(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached))}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this.updateMaterial())}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(t){this._fadedExtensions=a(t,sh),this.recreateGeometry()}updateMaterial(){i(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stippleIntegerRepeats:this._stippleIntegerRepeats,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,polygonOffset:this._polygonOffset,renderOccluded:this._renderOccluded,writeDepth:this._writeDepthEnabled}}updateGeometry(){s(this.object)&&this.updateVertices(this.object)}updateVertices(t){const i=3===this._extensionType?this.updateLineSegmentFinite($e):this.updateLineSegmentInfinite(this._extensionType,$e);this.updateVertexAttributes(t,i),s(this._externalResources)&&(this._externalResources.laserline.intersectsLine=i)}updateLineSegmentFinite(t){return Nt(this._start,this._end,t)}updateLineSegmentInfinite(t,s){const i=this.view.state.camera;switch(yt(this._ray,Ke),t){case 0:Ke.c0=-Number.MAX_VALUE;break;case 1:case 2:{const t=this._ray.origin,s=a(this.view.elevationProvider.getElevation(t[0],t[1],t[2],this.view.renderCoordsHelper.spatialReference,"ground"),0),i=this.view.renderCoordsHelper.getAltitude(t);this._isWorldDown&&i<s&&Y(Ke.ray.direction,Ke.ray.direction),2===this._extensionType&&null!=s&&(Ke.c1=Math.abs(i-s));break}}if(!bt(i.frustum,Ke))return Nt(this._start,this._end,s);const e=Mt(Ke,Ye),h=xt(Ke,Je);return Nt(e,h,s)}updateVertexAttributes(t,s){const i=t.geometries[0].getMutableAttribute("position").data;if(3===this.extensionType){const t=Ft(s,-this.fadedExtensions.start,Ye);i[0]=t[0],i[1]=t[1],i[2]=t[2];const e=Ft(s,0,Ye);i[3]=e[0],i[4]=e[1],i[5]=e[2];const h=Ft(s,1,Ye);i[6]=h[0],i[7]=h[1],i[8]=h[2];const n=Ft(s,1+this.fadedExtensions.end,Ye);i[9]=n[0],i[10]=n[1],i[11]=n[2]}else{const t=Ft(s,0,Ye);i[0]=t[0],i[1]=t[1],i[2]=t[2];const e=Ft(s,1,Ye);i[3]=e[0],i[4]=e[1],i[5]=e[2]}t.geometryVertexAttrsUpdated(t.geometryRecords[0])}}const Ke=Dt(),Ye=dt(),Je=dt(),$e=Lt(),th=1/3,sh={start:th,end:th};class ih extends Kt{constructor(t){super(t),this._handles=new n,this._location=dt(),this._direction=gt(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=mt(1,0,1,1),this._renderOccluded=4,this.applyProps(t)}get location(){return this._location}set location(t){q(this._location,t)||(W(this._location,t),this.updateGeometry())}get direction(){return this._direction}set direction(t){q(this._direction,t)||(W(this._direction,t),this.updateGeometry())}setDirectionFromPoints(t,s){U(this._direction,_(this._direction,s,t)),this.updateGeometry()}get width(){return this._width}set width(t){t!==this._width&&(this._width=t,this.updateMaterial())}get offset(){return this._offset}set offset(t){t!==this._offset&&(this._offset=t,this.updateGeometry())}get length(){return this._length}set length(t){t!==this._length&&(this._length=t,this.updateGeometry())}get color(){return this._color}set color(t){X(t,this._color)||(K(this._color,t),this.updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this.updateMaterial())}createExternalResources(){const t=new St(this.materialParameters);this._handles.add(this.view.state.watch("camera",(()=>{this.updateGeometry()}))),this._externalResources={material:t}}destroyExternalResources(){this._handles.removeAll(),this._externalResources=null}createGeometries(t){const s=Pt.createPolylineGeometry([dt(),dt()]),i=Pt.createPolylineGeometry([dt(),dt()]),e=r(this._externalResources).material;t.addGeometry(s,e),t.addGeometry(i,e),this.updateVertices(t)}forEachExternalMaterial(t){s(this._externalResources)&&t(this._externalResources.material)}updateMaterial(){i(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}updateGeometry(){const t=this.object;i(t)||this.updateVertices(t)}updateVertices(t){const s=this.view.state.camera;s.projectToScreen(this.location,hh),Q(eh,this.location,this.direction),s.projectToScreen(eh,nh),Bs(nh,Qs(nh,nh,hh)),this.updateVertexAttributes(s,t,0,hh,nh,1),this.updateVertexAttributes(s,t,1,hh,nh,-1)}updateVertexAttributes(t,s,i,e,h,n){const r=s.geometryRecords[i],a=r.geometry.getMutableAttribute("position").data,o=Zs(rh,qs(rh,h[1]*n,h[0]*-n),this.offset+this.width/2),l=Xs(ah,Xs(ah,Xs(ah,e,Zs(ah,h,this.length/2)),o),o),c=Xs(oh,l,Zs(oh,h,-this.length));t.unprojectFromScreen(l,eh),a[0]=eh[0],a[1]=eh[1],a[2]=eh[2],t.unprojectFromScreen(c,eh),a[3]=eh[0],a[4]=eh[1],a[5]=eh[2],s.geometryVertexAttrsUpdated(r)}}const eh=dt(),hh=Ws(),nh=Ws(),rh=Ws(),ah=Ws(),oh=Ws();class lh{constructor(t){this.resourceFactory=t,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return s(this._resources)?this._resources.object:null}get resources(){return s(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(t){t!==this._visible&&(this._visible=t,this._syncVisible())}get attached(){return this._attached}set attached(t){t!==this._attached&&(this._attached=t,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this.resourceFactory.recreateGeometry)return void this.recreate();const t=this.resourceFactory.view._stage;if(i(this._resources)||!t)return;const s=this._resources.object;this._resources.external.forEach((s=>{2===s.type&&t.remove(s)})),s.removeAllGeometries();const e=this.resourceFactory.recreateGeometry(this._resources.external,s,this._resources.layer);t.addMany(e)}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const t=this.resourceFactory.view._stage;if(!t)return;const s=new At({isPickable:!1,updatePolicy:1});t.add(s);const i=new ui({castShadow:!1}),e=this.resourceFactory.createResources(i,s);e.forEach((s=>t.add(s))),t.add(i),s.add(i),this._syncVisible();const h=this.resourceFactory.cameraChanged?o(this.resourceFactory.view.state,"camera",(t=>this.resourceFactory.cameraChanged(t))):null;this._resources={layer:s,object:i,external:e,cameraHandle:h}}_destroyResources(){if(i(this._resources))return;const t=this.resourceFactory.view._stage;null==t||t.remove(this._resources.object),null==t||t.remove(this._resources.layer),this._resources.external.forEach((s=>{null==t||t.remove(s),"dispose"in s&&s.dispose()})),this._resources.object.dispose(),this._resources.cameraHandle&&this._resources.cameraHandle.remove(),this._resources=null}_syncVisible(){i(this._resources)||this._resources.object.setVisible(this._visible)}}class ch{constructor(t){this.view=null,this._geometry=null,this._size=3,this._color=$t(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=$t(1,1,1,1),this._elevationInfo=null,this.resources=new lh({view:t.view,createResources:t=>this.createResources(t),recreateGeometry:(t,i)=>(t.geometry=this.recreateGeometry(i,t.material),s(t.geometry)?[t.geometry]:[])});let i=!0;for(const s in t)s in this?"attached"===s?i=t[s]:this[s]=t[s]:console.error("Cannot set unknown property",s);this.attached=i}destroy(){this.resources.destroy()}get visible(){return this.resources.visible}set visible(t){this.resources.visible=t}get attached(){return this.resources.attached}set attached(t){this.resources.attached=t}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this.resources.recreateGeometry()}get size(){return this._size}set size(t){if(t!==this._size){const i=this.preferredTextureSize;this._size=t,i<this.preferredTextureSize?s(this.resources)&&this.resources.recreate():this.updateSizeAttribute()}}get color(){return this._color}set color(t){X(t,this._color)||(K(this._color,t),this.updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(t){this._pixelSnappingEnabled!==t&&(this._pixelSnappingEnabled=t,this.updateMaterial())}get primitive(){return this._primitive}set primitive(t){this._primitive!==t&&(this._primitive=t,s(this.resources)&&this.resources.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(t){t!==this._outlineSize&&(this._outlineSize=t,this.updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(t){X(t,this._outlineColor)||(K(this._outlineColor,t),this.updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(t){this._elevationInfo=t,this.resources&&this.resources.recreateGeometry()}updateMaterial(){const t=this.resources.resources;i(t)||t.material.setParameters(this.materialParameters(t.texture.id))}updateSizeAttribute(){const t=this.resources.resources,s=this.resources.object;if(i(t)||i(s))return;const e=t.geometry;if(i(e))return;const h=e.getMutableAttribute("size").data,n=this.geometrySize;h[0]=n,h[1]=n,s.geometryVertexAttrsUpdated(s.geometryRecords[0])}materialParameters(t){return{color:this._color,textureIsSignedDistanceField:!0,distanceFieldBoundingBox:dh,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:t,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled}}get geometrySize(){return this._size/uh}recreateGeometry(t,i){const e=this.createRenderGeometry();return s(e)&&t.addGeometry(e,i),e}createResources(t){const i=this.createTexture(),e=new Ot(this.materialParameters(i.id)),h=this.recreateGeometry(t,e);return{material:e,texture:i,geometry:h,forEach(t){t(i),t(e),s(this.geometry)&&t(this.geometry)}}}get preferredTextureSize(){return J($(2*this.geometrySize),16,128)}createTexture(){const t=this.preferredTextureSize;return new Rs(Ct(this._primitive,t,t*uh),{mipmap:!1,wrap:{s:33071,t:33071},width:t,height:t,components:4,noUnpackFlip:!0})}calculateMapBounds(t){if(i(this.resources.resources)||i(this.resources.resources.geometry))return!1;const s=this.resources.resources.geometry.vertexAttributes.get("position");return ti(s.data,this.view.renderCoordsHelper.spatialReference,ph,this.view.spatialReference),hi(t,ph),!0}createRenderGeometry(){const t=this.geometry;if(i(t))return null;const{renderCoordsHelper:s,elevationProvider:e}=this.view,h=zt(t,e,Et.fromElevationInfo(this.elevationInfo),s),n=L(oi.get(),t.x,t.y,h),r=oi.get();ti(n,t.spatialReference,r,s.spatialReference);const a=this.geometrySize;return Pt.createPointGeometry(null,r,null,[a,a],[0,0,0,1])}}const uh=.5,dh=[uh/2,uh/2,1-uh/2,1-uh/2],ph=dt();class gh extends pi{visualizeIntersectionPoint(t,s){const{coordinateHelper:i,elevationInfo:e,view:h}=s;return l(new ch({view:h,primitive:"circle",geometry:i.vectorToPoint(t.intersectionPoint),elevationInfo:e,size:20,outlineSize:2,color:[0,0,0,0],outlineColor:I.toUnitRGBA(S.orange),pixelSnappingEnabled:!1}))}visualizePoint(t,s){const{coordinateHelper:i,elevationInfo:e,view:h}=s;return l(new ch({view:h,primitive:"circle",geometry:i.vectorToPoint(t.point),elevationInfo:e,size:20,outlineSize:2,color:[0,0,0,0],outlineColor:I.toUnitRGBA(S.orange),pixelSnappingEnabled:!1}))}visualizeLine(t,s){const{coordinateHelper:i,elevationInfo:e,view:h}=s;return l(this.createLineSegmentHintFromMap(t.type,t.lineStart,t.lineEnd,i,e,h,t.fadeLeft,t.fadeRight))}visualizeParallelSign(t,s){const{coordinateHelper:i,elevationInfo:e,view:h}=s,n=P(t.lineStart,i,e,s.view),r=P(t.lineEnd,i,e,s.view),a=tt(r,n,r,.5),o=new ih({view:h,attached:!1,offset:S.parallelLineHintOffset,length:S.parallelLineHintLength,width:S.parallelLineHintWidth,color:I.toUnitRGBA(S.orange),location:a,renderOccluded:16});return o.setDirectionFromPoints(n,a),o.attached=!0,l(o)}visualizeRightAngleQuad(t,s){const{coordinateHelper:i,elevationInfo:e,view:h}=s;return l(new di({view:h,attached:!0,color:I.toUnitRGBA(S.orange),renderOccluded:2,outlineRenderOccluded:16,outlineColor:I.toUnitRGBA(S.orange),outlineSize:S.rightAngleHintOutlineSize,size:S.rightAngleHintSize,geometry:{previous:P(t.previousVertex,i,e,h),center:P(t.centerVertex,i,e,h),next:P(t.nextVertex,i,e,h)}}))}createLineSegmentHintFromMap(t,s,i,e,h,n,r=!0,a=!0){const o=dt(),l=dt();return A(s,i,e,h,n,o,l),this.createLineSegmentHint(t,n,o,l,r,a)}createLineSegmentHint(t,s,i,e,h=!0,n=!0){const r=new Xe({view:s,extensionType:3,start:i,end:e,color:I.toUnitRGBA(S.orange),renderOccluded:16});switch(t){case 0:r.width=S.lineHintWidthTarget,r.fadedExtensions={start:0,end:S.lineHintFadedExtensions};break;case 2:r.width=S.lineHintWidthReference,r.fadedExtensions={start:0,end:0};break;case 1:r.width=S.lineHintWidthReference,r.fadedExtensions={start:h?S.lineHintFadedExtensions:0,end:n?S.lineHintFadedExtensions:0}}return r.attached=!0,r}}const fh={main:new I([255,127,0]),selected:new I([255,255,255]),staged:new I([12,207,255]),outline:new I([0,0,0,.5]),selectedOutline:new I([255,255,255])};function mh(t,s){const i=t.clone();return i.a*=s,i}function vh(t,s){const i=t.clone(),e=fi(i);e.s*=s;const h=mi(e);return i.r=h.r,i.g=h.g,i.b=h.b,i}function wh(t,s){if(s)for(const i in s)t[i]=s[i]}class yh{constructor(t){this.color=fh.main,this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=16,wh(this,t)}}class bh{constructor(t){this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=fh.main,this.outlineColor=fh.outline,this.renderOccluded=16,this.hoverOutlineColor=fh.selectedOutline,wh(this,t)}apply(t,s){const i=this[t];s.setParameters({color:Eh(i),transparent:"color"!==t||i.a<1,renderOccluded:this.renderOccluded})}}class Mh{constructor(t){this.size=40,this.height=.2,this.offset=.25,this.collisionPadding=2,this.color=mh(fh.main,.5),this.hoverColor=fh.main,this.renderOccluded=2,this.minSquaredEdgeLength=900,wh(this,t)}apply(t,s){const i=this[t];s.setParameters({color:Eh(i),transparent:i.a<1,renderOccluded:this.renderOccluded})}}class xh{constructor(t){this.vertex=new bh({color:fh.main,outlineColor:fh.outline}),this.edge=new bh({color:vh(mh(fh.main,2/3),.5),outlineColor:mh(fh.outline,.5),size:8,collisionPadding:8}),this.selected=new bh({color:fh.selected,outlineColor:fh.outline}),this.edgeOffset=new Mh,wh(this,t)}}class Dh{constructor(t){this.color=fh.selected,this.width=1.5,this.stipplePattern=kt(5),this.stippleOffColor=fh.outline,this.falloff=0,this.innerWidth=1.5,this.innerColor=fh.selected,this.renderOccluded=4,wh(this,t)}apply(t){t.color=Eh(this.color),t.width=this.width,t.stipplePattern=this.stipplePattern,t.stippleOffColor=Eh(this.stippleOffColor),t.falloff=this.falloff,t.innerWidth=this.innerWidth,t.innerColor=Eh(this.innerColor),t.renderOccluded=this.renderOccluded}}class Sh{constructor(t){this.color=fh.selected,this.size=4,this.outlineSize=1,this.outlineColor=fh.outline,this.shape="square",wh(this,t)}apply(t){t.color=Eh(this.color),t.size=this.size,t.outlineSize=this.outlineSize,t.outlineColor=Eh(this.outlineColor),t.primitive=this.shape}}class Ph{constructor(t){this.innerColor=fh.selected,this.innerWidth=1,this.glowColor=fh.main,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=.3,this.globalAlphaContrastBoost=1.5,this.radius=3,this.heightFillColor=fh.main,wh(this,t)}apply(t,s=1){const i={glowColor:I.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:I.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*s,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in t?t.style=i:t.laserlineStyle=i}}class Ah{constructor(t){this.outline=new Dh({color:fh.outline,renderOccluded:8,stippleOffColor:fh.selected,stipplePattern:kt(5),width:1.5,innerWidth:0}),this.staged=new Dh({color:fh.selected,renderOccluded:8,innerColor:fh.staged,stippleOffColor:fh.outline,stipplePattern:kt(5),width:1.5}),this.shadowStyle=new Ph({globalAlpha:.3,glowColor:fh.main,glowFalloff:8,glowWidth:8,innerColor:fh.selected,innerWidth:1}),wh(this,t)}}class Oh{constructor(t){this.outline=new Sh({color:fh.selected,outlineColor:fh.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new Ph({globalAlpha:.3,glowColor:fh.main,glowFalloff:1.5,glowWidth:6,innerColor:fh.selected,innerWidth:1,radius:2}),wh(this,t)}}class Ch extends Dh{constructor(t){super(),this.extensionType=2,wh(this,t)}}class zh{constructor(t){this.lineGraphics=new Ah,this.pointGraphics=new Oh,this.heightPlane=new Ph({globalAlpha:.3,glowColor:fh.main,glowFalloff:8,glowWidth:8,innerColor:fh.selected,innerWidth:1}),this.heightBox=new Ph({globalAlpha:.3,glowColor:fh.main,glowFalloff:8,glowWidth:8,innerColor:fh.selected,innerWidth:0,heightFillColor:fh.main}),this.zVerticalLine=new Ch({color:mh(fh.main,.5),falloff:2,innerColor:mh(fh.selected,0),renderOccluded:4,stipplePattern:null,width:5,extensionType:2}),this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,wh(this,t)}}function Eh(t){return ts(I.toUnitRGBA(t))}const kh=new class{constructor(t){this.visualElements=new zh,this.reshapeManipulators=new xh,this.zManipulator=new yh,wh(this,t)}colorToVec4(t){return Eh(t)}};class Rh{constructor(t){this.resourceFactory=t,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get resources(){return s(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(t){t!==this._visible&&(this._visible=t,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(t){t!==this._attached&&(this._attached=t,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){this.resourceFactory.recreateGeometry?i(this._resources)||(this.ensureRenderGeometriesRemoved(),this.resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}_createOrDestroyResources(){this._attached?i(this._resources)&&this._createResources():this._destroyResources()}_createResources(){var t;this._destroyResources();const s=this.resourceFactory.createResources();this._resources={layerView:new jh({view:this.resourceFactory.view}),external:s,geometriesAdded:!1},this._syncGeometriesToRenderer();const i=null==(t=this.resourceFactory.view.basemapTerrain)?void 0:t.overlayManager;i&&i.registerDrapeSource(this._resources.layerView)}_destroyResources(){var t;if(i(this._resources))return;this.ensureRenderGeometriesRemoved();const s=null==(t=this.resourceFactory.view.basemapTerrain)?void 0:t.overlayManager;s&&s.unregisterDrapeSource(this._resources.layerView),this._resources=null}_syncGeometriesToRenderer(){this._visible?this.ensureRenderGeometriesAdded():this.ensureRenderGeometriesRemoved()}ensureRenderGeometriesRemoved(){var t;!i(this._resources)&&null!=(t=this.resourceFactory.view)&&t.basemapTerrain&&this._resources.geometriesAdded&&(this.resourceFactory.view.basemapTerrain.overlayManager.renderer.removeGeometries(this._resources.external.geometries,this._resources.layerView,2),this._resources.geometriesAdded=!1)}ensureRenderGeometriesAdded(){i(this._resources)||this._resources.geometriesAdded||(this.resourceFactory.view.basemapTerrain.overlayManager.renderer.addGeometries(this._resources.external.geometries,this._resources.layerView,2),this._resources.geometriesAdded=!0)}}let jh=class extends(yi(c)){constructor(t){super(t),this.drapeSourceType=1,this.updatePolicy=1}};t([u({constructOnly:!0})],jh.prototype,"view",void 0),t([u({readOnly:!0})],jh.prototype,"drapeSourceType",void 0),jh=t([d("DrapedVisualElementLayerView")],jh);class Th{constructor(t){this.view=null,this._attachmentOrigin=wi(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new p,this._isDraped=!1,this._geometry=null,this._width=1,this._color=mt(1,0,1,1),this._innerWidth=0,this._innerColor=mt(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=8,this.resources=new lh({view:t.view,createResources:t=>this.createResources(t),recreateGeometry:(t,s)=>(t.geometries.length=0,this.recreateGeometry(s,t.material,t.geometries),t.geometries)}),this._attachmentOrigin.spatialReference=t.view.spatialReference,this.drapedResources=new Rh({view:t.view,createResources:()=>this.createDrapedResources(),recreateGeometry:t=>{t.geometries=this.createRenderGeometriesDraped(t.material),this.attachmentOriginChanged()}});let s=!0;this._laserline=new Ze({view:t.view});for(const i in t)i in this?"attached"===i?s=t[i]:this[i]=t[i]:console.error("Cannot set unknown property",i);this.attached=s}destroy(){this.resources.destroy(),this.drapedResources.destroy(),this._laserline.destroy()}get isDraped(){return this._isDraped}set isDraped(t){t!==this._isDraped&&(this._isDraped=t,this.updateAttached(this.attached),this._laserline.attached=this.laserlineAttached)}get laserlineAttached(){return this.attached&&this.visible&&s(this._laserlineStyle)&&!this.isDraped&&this.laserlineEnabled}get visible(){return this.resources.visible}set visible(t){this.resources.visible=t,this.drapedResources.visible=t,this._laserline.attached=this.laserlineAttached}get attached(){return this.resources.attached||this.drapedResources.attached}set attached(t){this.updateAttached(t)}updateAttached(t){this.resources.attached=!this.isDraped&&t,this.drapedResources.attached=this.isDraped&&t,this._laserline.attached=this.laserlineAttached,this.attached&&this.attachmentOriginChanged()}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this.resources.recreateGeometry(),this.drapedResources.recreateGeometry()}get width(){return this._width}set width(t){t!==this._width&&(this._width=t,this.updateMaterial())}get color(){return this._color}set color(t){X(t,this._color)||(K(this._color,t),this.updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(t){t!==this._innerWidth&&(this._innerWidth=t,this.updateMaterial())}get innerColor(){return this._innerColor}set innerColor(t){X(t,this._innerColor)||(K(this._innerColor,t),this.updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(t){const i=s(t)!==s(this._stipplePattern);this._stipplePattern=t,i?this.resources.recreate():this.updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(t){t&&this._stippleOffColor&&X(t,this._stippleOffColor)||(this._stippleOffColor=t?vt(t):null,this.updateMaterial())}get falloff(){return this._falloff}set falloff(t){t!==this._falloff&&(this._falloff=t,this.updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(t){this._elevationInfo=t,this.resources.recreateGeometry()}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(t){this._laserlineStyle=t,this._laserline.attached=this.laserlineAttached,s(t)&&(this._laserline.style=t)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(t){this._laserlineEnabled!==t&&(this._laserlineEnabled=t,this._laserline.attached=this.laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this.updateMaterial())}get attachmentOrigin(){if(!this._attachmentOriginDirty)return this._attachmentOrigin;const t=s(this.resources.resources)?this.resources.resources.geometries:null;if(!t||0===t.length)return null;L(Ih,0,0,0);let i=0;for(const s of t){const t=s.vertexAttributes.get("position"),e=s.indices.get("position"),h=r(this.resources.resources).material.isClosed(t.data,e);bi(t,e,h,Gh)&&(Q(Ih,Ih,Gh),i++)}return 0===i?null:(st(Ih,Ih,1/i),this.view.renderCoordsHelper.fromRenderCoords(Ih,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}updateMaterial(){s(this.resources.resources)&&this.resources.resources.material.setParameters(this.materialParameters),s(this.drapedResources.resources)&&this.drapedResources.resources.material.setParameters(this.materialParameters)}get isClosed(){return s(this.geometry)&&"polygon"===this.geometry.type}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,isClosed:this.isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",stippleIntegerRepeats:!0,polygonOffset:!0,renderOccluded:this.normalizedRenderOccluded}}get normalizedRenderOccluded(){return this.isDraped&&8===this._renderOccluded?4:this._renderOccluded}recreateGeometry(t,s,i){const e=this.createRenderGeometries();for(const h of e)t.addGeometry(h,s),i.push(h);this.attachmentOriginChanged()}attachmentOriginChanged(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}createResources(t){const s=new St(this.materialParameters),i=[];return this.recreateGeometry(t,s,i),{material:s,geometries:i,forEach:t=>{t(s),i.forEach(t)}}}createDrapedResources(){const t=new St(this.materialParameters);return{material:t,geometries:this.createRenderGeometriesDraped(t)}}createRenderGeometriesDraped(t){const s=this.geometry;if(i(s))return[];const e=Rt(s,this.view.basemapTerrain.spatialReference),h=[];for(const{position:s}of e.lines){const i=new jt(Tt({attributeData:{position:s},removeDuplicateStartEnd:this.isClosed?1:0}),t),e=ni(Vh);hi(e,s),it(i.boundingSphere,.5*(e[0]+e[3]),.5*(e[1]+e[4]),0,.5*Math.sqrt((e[3]-e[0])*(e[3]-e[0])+(e[4]-e[1])*(e[4]-e[1]))),h.push(i)}return h}calculateMapBounds(t){if(i(this.resources.resources))return!1;const s=this.view.renderCoordsHelper;for(const i of this.resources.resources.geometries){const e=i.vertexAttributes.get("position"),h=new Float64Array(e.data.length);si(e.data,s.spatialReference,0,h,this.view.spatialReference,0,e.data.length/3),hi(t,h)}return!0}createRenderGeometries(){var t;const s=this.geometry;if(i(s))return[];const e=Vt(s,this.view.elevationProvider,this.view.renderCoordsHelper,Et.fromElevationInfo(null!=(t=this.elevationInfo)?t:new G({mode:O(s,null)}))),h=[],n=[];for(const{position:t,mapPosition:s}of e.lines)h.push(Tt({attributeData:{position:t,mapPosition:s},removeDuplicateStartEnd:this.isClosed?1:0})),n.push(t);return this._laserline.pathVerticalPlane=n,h}}const Vh=ri(),Gh=dt(),Ih=dt();class Lh extends Kt{constructor(t){super(t),this.view=null,this._renderOccluded=4,this._vertices=null,this._spatialReference=null,this._color=kh.colorToVec4(kh.reshapeManipulators.vertex.color),this._size=kh.reshapeManipulators.vertex.size,this._outlineColor=kh.colorToVec4(kh.reshapeManipulators.vertex.outlineColor),this._outlineSize=kh.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(t)}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this.updateMaterial(),this.updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(t){this._vertices=t,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(t){this._spatialReference=t,this.recreateGeometry()}get color(){return this._color}set color(t){X(t,this._color)||(K(this._color,t),this.updateMaterial())}get size(){return this._size}set size(t){t!==this._size&&(this._size=t,this.updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(t){X(t,this._outlineColor)||(K(this._outlineColor,t),this.updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(t){t!==this._outlineSize&&(this._outlineSize=t,this.updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(t){this._elevationInfo=t,this.recreateGeometry()}get vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSize:this.size,renderOccluded:this._renderOccluded}}get vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSize:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}updateMaterial(){this.attached&&this.vertexMaterial.setParameters(this.vertexMaterialParameters)}updateOutlineMaterial(){this.attached&&this.vertexOutlineMaterial.setParameters(this.vertexOutlineMaterialParameters)}createRenderGeometries(){const t=this.vertices;if(i(t)||0===t.length)return[];const s=Gt(t,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,Et.fromElevationInfo(this.elevationInfo)),e=[],h=s.numVertices,n=s.position;for(let t=0;t<h;++t){const s=L(_h,n[3*t+0],n[3*t+1],n[3*t+2]),i=Fh(.5,s),h=Fh(.5,s);e.push({vertexGeometry:i,vertexOutlineGeometry:h})}return e}createGeometries(t){const s=this.createRenderGeometries();for(const{vertexGeometry:i,vertexOutlineGeometry:e}of s)t.addGeometry(i,this.vertexMaterial),t.addGeometry(e,this.vertexOutlineMaterial)}createExternalResources(){this.vertexMaterial=new Mi({...this.vertexMaterialParameters,writeDepth:!0,cullFace:2,screenSizeEnabled:!0}),this.vertexOutlineMaterial=new Mi({...this.vertexOutlineMaterialParameters,transparent:!0,writeDepth:!0,cullFace:1,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this.vertexMaterial=null,this.vertexOutlineMaterial=null}forEachExternalMaterial(t){t(this.vertexMaterial),t(this.vertexOutlineMaterial)}}const _h=dt();function Fh(t,s){return Pt.createSphereGeometry(t,16,16,{offset:s})}let Wh=class extends Fi{constructor(t){super(t),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this.geometryType=null,this.type="draw-3d"}initialize(){const{mode:t,offset:s}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new G({mode:t,offset:s})}normalizeCtorArgs(t){if(!t.elevationInfo){var s;const i=null==(s=t.hasZ)||s;return{...t,elevationInfo:{mode:i?"absolute-height":"on-the-ground",offset:0}}}return t}initializeGraphic(t){return this._createGraphicState=new C({graphic:t}),g([this.view.maskOccludee(t),this.view.trackGraphicState(this._createGraphicState),o(this._createGraphicState,"isDraped",(t=>{s(this._outlineVisualElement)&&(this._outlineVisualElement.isDraped=t)}))])}makeDrawOperation(){return new Wi({view:this.view,manipulators:this.manipulators,geometryType:Ni(this.geometryType),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new Hi(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new Ui(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new gh})}onActiveVertexChanged(t){return s(this._activeVertexVisualElement)?(this._activeVertexVisualElement.vertices=[t],null):(this._activeVertexVisualElement=new Lh({view:this.view,spatialReference:this.view.spatialReference,vertices:[t],elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:kh.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._activeVertexVisualElement.color=kh.colorToVec4(kh.reshapeManipulators.selected.color),this._activeVertexVisualElement.attached=!0,f((()=>{this._activeVertexVisualElement=m(this._activeVertexVisualElement)})))}onOutlineChanged(t){if(s(this._outlineVisualElement))return this._outlineVisualElement.geometry=t,null;const i=this.internalGraphicsLayer.elevationInfo;return this._outlineVisualElement=new Th({view:this.view,geometry:t,elevationInfo:i,isDraped:s(this._createGraphicState)?this._createGraphicState.isDraped:"on-the-ground"===z(this.hasZ,i),attached:!1}),kh.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),kh.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0,f((()=>{this._outlineVisualElement=m(this._outlineVisualElement)}))}onRegularVerticesChanged(t){return s(this._verticesVisualElement)?(this._verticesVisualElement.vertices=t,null):(this._verticesVisualElement=new Lh({view:this.view,spatialReference:this.view.spatialReference,vertices:t,elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:kh.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0,f((()=>{this._verticesVisualElement=m(this._verticesVisualElement)})))}};function Nh(t,s=E(t)){return"on-the-ground"!==s.mode&&!(i(t.geometry)||!t.geometry.hasZ)}t([u({constructOnly:!0})],Wh.prototype,"elevationInfo",void 0),t([u({constructOnly:!0})],Wh.prototype,"geometryType",void 0),t([u({readOnly:!0})],Wh.prototype,"type",void 0),t([u({constructOnly:!0,nonNullable:!0})],Wh.prototype,"view",void 0),Wh=t([d("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],Wh);class Hh{constructor(){this.grabbingState=0,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(t){this.grabbingState=0,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,t.forEachManipulator(((t,s)=>{if(0===s&&(this.zManipulator=t),t instanceof xi&&(t.selected&&(0===this.numSelected&&(this.firstSelected=t),this.numSelected++),i(this.firstGrabbedXY)&&t.grabbing&&1===s&&(this.firstGrabbedXY=t)),t.grabbing)switch(this.grabbingState|=1,s){case 0:this.grabbingState|=2;break;case 1:this.grabbingState|=4}}))}}function Uh(t,i,e){const{graphic:h,view:n}=t,r=[],a=E(h),o="on-the-ground"===a.mode||!a.offset&&"absolute-height"!==a.mode,c=new Hh,u=new Xe({view:n,extensionType:kh.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});kh.visualElements.pointGraphics.shadowStyle.apply(u);const d=F(kh.visualElements.heightPlaneAngleCutoff),p=new Ze({view:n,attached:!1,angleCutoff:d});kh.visualElements.heightPlane.apply(p);let f=1,m=1;const w=()=>{if(c.update(t),!e.displaying||o&&(e.isDraped||!Bh(h)||!h.geometry.hasZ))return i.laserlineEnabled=!1,u.attached=!1,void(p.attached=!1);i.laserlineEnabled=!0;{const t=4&c.grabbingState?kh.visualElements.laserlineAlphaMultiplier:1;t!==f&&(f=t,kh.visualElements.lineGraphics.shadowStyle.apply(i,t),kh.visualElements.pointGraphics.shadowStyle.apply(u,t))}{const t=2&c.grabbingState?kh.visualElements.laserlineAlphaMultiplier:1;t!==m&&(m=t,kh.visualElements.heightPlane.apply(p,t))}(function(t,i){const e=1===i.numSelected?i.firstSelected:i.numSelected>1&&s(i.firstGrabbedXY)?i.firstGrabbedXY:null;s(e)?(t.setStartEndFromWorldDownAtLocation(e.renderLocation),t.attached=!0):t.attached=!1})(u,c),function(t,i,e,h){if(h.numSelected>0){L(Qh,0,0,0);let s=0;t.forEachManipulator(((t,i)=>{1===i&&t.selected&&t instanceof xi&&(Q(Qh,Qh,t.renderLocation),s++)})),s>0?(e.heightManifoldTarget=st(Qh,Qh,1/s),e.attached=!0):e.attached=!1}else{const h=i.attachmentOrigin;s(h)&&t.view.renderCoordsHelper.toRenderCoords(h,Qh)?(e.heightManifoldTarget=Qh,e.attached=!0):e.attached=!1}}(t,i,p,c)};kh.visualElements.zVerticalLine.apply(u),r.push(e.on("changed",w),e.watch("displaying",w),i.events.on("attachment-origin-changed",w),l(u),l(p));const y=[],b=()=>{g(y).remove(),y.length=0,t.forEachManipulator((t=>y.push(t.events.on("grab-changed",w)))),t.forEachManipulator((t=>y.push(t.events.on("select-changed",w)))),w()};return b(),r.push(t.onManipulatorsChanged(b),v((()=>g(y)))),g(r)}function Bh(t){return s(t.geometry)&&("polygon"===t.geometry.type||"polyline"===t.geometry.type)}const Qh=dt();function Zh(t){const{view:e,graphic:h}=t,n=new C({graphic:h}),r=[],a=function(t,i,e){const{view:h,graphic:n}=t,r=new ch({view:h,geometry:qh(n),elevationInfo:E(n),attached:!1});return function(t,i,e,h){(function(t,i,e,h){const{view:n,graphic:r}=t;let a=null;const o=()=>{const t=qh(r);(t=>{s(a)&&(a.remove(),a=null),e.isDraped&&s(t)&&(a=function(t,s,i){ii(s,Xh,t.elevationProvider.spatialReference);const e=Xh[0],h=Xh[1];return t.elevationProvider.on("elevation-change",(t=>{ne(t.extent,e,h)&&i()}))}(n,t,(()=>{i.geometry=t})))})(t),i.geometry=t};h.push(e.on("changed",o),v((()=>a))),o()})(t,i,e,h),kh.visualElements.pointGraphics.outline.apply(i),h.push(o(e,"displaying",(()=>i.attached=e.displaying)))}(t,r,i,e),e.push(l(r)),r}(t,n,r);return function(t,e,h,n){const{view:r,graphic:a}=t,o=new Xe({view:r,extensionType:kh.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});kh.visualElements.zVerticalLine.apply(o);const c=new Ze({view:r,intersectsLineInfinite:!0,attached:!1});kh.visualElements.pointGraphics.shadowStyle.apply(c);const u=F(kh.visualElements.heightPlaneAngleCutoff),d=new Ze({view:r,attached:!1,angleCutoff:u});kh.visualElements.heightPlane.apply(d);const p=E(t.graphic),g=Et.fromElevationInfo(p),f="on-the-ground"===p.mode||!p.offset&&"absolute-height"!==p.mode,m=new Hh;let v=1,w=1;const y=()=>{m.update(t);const h=qh(a),l=f&&(e.isDraped||i(h)||!h.hasZ);let u=!0;if(!l&&s(h)){const t=zt(h,r.elevationProvider,g,r.renderCoordsHelper);L(Xh,h.x,h.y,t),ti(Xh,h.spatialReference,Xh,r.renderCoordsHelper.spatialReference),o.setStartEndFromWorldDownAtLocation(Xh),c.intersectsWorldUpAtLocation=Xh}else u=!1;const p=2&m.grabbingState?kh.visualElements.laserlineAlphaMultiplier:1;p!==v&&(v=p,kh.visualElements.heightPlane.apply(d,p));const y=ni(Kh);!l&&e.displaying&&n.calculateMapBounds(y)&&ti(ai(y,Xh),r.spatialReference,Xh,r.renderCoordsHelper.spatialReference)?(d.heightManifoldTarget=Xh,d.attached=!0):d.attached=!1;const b=4&m.grabbingState?kh.visualElements.laserlineAlphaMultiplier:1;b!==w&&(w=b,kh.visualElements.pointGraphics.shadowStyle.apply(c,b));const M=u&&e.displaying&&!l;c.attached=M,o.attached=M};h.push(e.watch(["displaying","isDraped"],y),e.on("changed",y)),t.forEachManipulator((t=>{h.push(t.events.on("grab-changed",y))})),h.push(l(c)),h.push(l(o)),h.push(l(d)),y()}(t,n,r,a),r.push(e.trackGraphicState(n)),{visualElement:a,remove(){g(r).remove()}}}function qh(t){const s=t.geometry;return i(s)?null:"point"===s.type?s:"mesh"===s.type?s.anchor.clone():null}const Xh=dt(),Kh=ri();function Yh(t){switch(r(t.graphic.geometry).type){case"point":case"mesh":return Zh(t);case"polygon":case"polyline":return function(t){const{view:s,graphic:i}=t,e=new C({graphic:i}),h=function(t,s){const{view:i,graphic:e}=t,h=new Th({view:i,geometry:Bh(e)?e.geometry:null,elevationInfo:E(e),attached:!1});kh.visualElements.lineGraphics.shadowStyle.apply(h);const n=()=>{h.attached=s.displaying};kh.visualElements.lineGraphics.outline.apply(h);const r=[s.watch("displaying",n),s.watch("isDraped",(t=>h.isDraped=t)),s.on("changed",(()=>h.geometry=Bh(e)?e.geometry:null)),l(h)];return n(),{visualElement:h,remove:()=>g(r).remove()}}(t,e),n=[h,Uh(t,h.visualElement,e),s.maskOccludee(i),s.trackGraphicState(e)];return{visualElement:h.visualElement,remove:()=>g(n).remove()}}(t);default:return null}}const Jh=[1,.5,0],$h=70,tn=Math.ceil($h/3*2),sn=5*Math.PI/12,en=1*Math.PI/3;class hn{constructor(){this._available=!0}set location(t){this.forEachManipulator3D((s=>s.location=t))}set elevationAlignedLocation(t){this.forEachManipulator3D((s=>s.elevationAlignedLocation=t))}set elevationInfo(t){this.forEachManipulator3D((s=>s.elevationInfo=t))}get renderLocation(){let t;return this.forEachManipulator3D((s=>{t||(t=s.renderLocation)})),t}get available(){return this._available}set available(t){this._available=t,this.forEachManipulator3D((s=>s.available=t))}get grabbing(){return this.someManipulator((t=>t.grabbing))}get dragging(){return this.someManipulator((t=>t.dragging))}hasManipulator(t){return this.someManipulator((s=>s===t))}someManipulator(t){let s=!1;return this.forEachManipulator((i=>{!s&&t(i)&&(s=!0)})),s}forEachManipulator3D(t){this.forEachManipulator(((s,i)=>{s instanceof xi&&t(s,i)}))}}function nn(t,s){return rn(t,(()=>s))}function rn(t,e){const h=dt(),n=dt();let r=!1;return a=>{const o=e(a);if("start"===a.action){const i=Ns(a.screenStart,Hs(li.get())),e=Ts(t.state.camera,i,pn);s(e)&&(r=es(o,e,h))}if(!r)return null;const l=Ns(a.screenEnd,Hs(li.get())),c=Ts(t.state.camera,l,pn);return i(c)?null:es(o,c,n)?{...a,renderStart:h,renderEnd:n,plane:o,ray:c}:null}}function an(t,e,h,n=null,r=null){return function(t,e,h,n=null,r=null){let a=null;return o=>{if("start"===o.action&&(a=t.sceneIntersectionHelper.intersectElevationFromScreen(Ws(o.screenStart.x,o.screenStart.y),e,h,r),s(a)&&s(n)&&!ei(a,a,n)))return null;if(i(a))return null;const l=t.sceneIntersectionHelper.intersectElevationFromScreen(Ws(o.screenEnd.x,o.screenEnd.y),e,h,r);return s(l)?s(n)&&!ei(l,l,n)?null:{...o,mapStart:a,mapEnd:l}:null}}(t,h,k(e,t,h),n,r)}function on(t,s,i,e=null,h=null){return an(t,i,E(s),e,h)}function ln(t,s,i){let e=null;const h=new Bi;return h.next(nn(t,function(t,s){const i=un,e=dn,h=ss();t.renderCoordsHelper.worldUpAtPosition(s,i);const n=B(h,i,_(e,s,t.state.camera.eye));return B(n,n,i),is(s,n,h)}(t,s))).next(function(t,s){const i=dt(),e=et(s);t.renderCoordsHelper.worldUpAtPosition(s,i);const h=dt(),n=dt(),r=h=>(_(h,h,s),Zt(i,h,h),"global"===t.viewingMode&&et(h)*Math.sign(ht(i,h))<.001-e&&_(h,st(h,i,.001),s),Q(h,h,s),h);return t=>(t.renderStart=r(W(h,t.renderStart)),t.renderEnd=r(W(n,t.renderEnd)),t)}(t,s)).next(cn(t,i)).next((t=>{t.mapEnd.x=t.mapStart.x,t.mapEnd.y=t.mapStart.y,e=t})),t=>(e=null,h.execute(t),e)}function cn(t,i){const e=t.renderCoordsHelper;return t=>{const h=e.fromRenderCoords(t.renderStart,i),n=e.fromRenderCoords(t.renderEnd,i);return s(h)&&s(n)?{...t,mapStart:h,mapEnd:n}:null}}const un=dt(),dn=dt(),pn=Bt();function gn(t,s,i,e){const h=t.graphic,n=(t,i)=>s({action:t,graphic:h,dxScreen:i.screenDeltaX,dyScreen:i.screenDeltaY});return i(((t,s,i)=>{const r=s.next((t=>("start"===t.action&&n("start",t),t))).next(Qi(h,e)).next((t=>{switch(t.action){case"start":case"update":(t.translationX||t.translationY||t.translationZ)&&n("update",t);break;case"end":n("end",t)}return t}));return i.next(Zi(h)).next((()=>{n("end",{screenDeltaX:0,screenDeltaY:0})})),r}))}function fn(t){if(i(t)||"polyline"!==t.type&&"polygon"!==t.type)return 0;const s=("polyline"===t.type?t.paths:t.rings)[0];if(!s||s.length<2)return 0;const e=s[0],h=s[1];return Math.atan2(h[1]-e[1],h[0]-e[0])}class mn extends hn{constructor(t){super(),this._handles=new n,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this.createMaterial(),this._transparentMaterial=this.createMaterial(.5),this._angle=0,this._scale=1,this._radius=$h,this._updateAfterDrag=!1,this.events=new p,this._tool=t.tool,this._view=t.view,null!=t.radius&&(this._radius=t.radius),this._createManipulators(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}set orthogonalAvailable(t){this._arrowManipulatorInfos[1].manipulator.available=t,this._arrowManipulatorInfos[3].manipulator.available=t}destroy(){this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._handles=m(this._handles),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(t){for(const{manipulator:s}of this._arrowManipulatorInfos)t(s,1)}createGraphicDragPipeline(t,s,i){const e=s.graphic,h=E(e),n=r(e.geometry).spatialReference;return gn(s,i,(s=>this.createDragPipeline(((i,e,h,n,r)=>s(i,t(i,e,h,n,r),h)),h,n,e)),this._view.state.viewingMode)}createDragPipeline(t,s,i,e){return g(this._arrowManipulatorInfos.map((({manipulator:h},n)=>qi(h,((h,r,a,o,l)=>{const c=r.next((t=>({...t,manipulatorType:1}))).next(Xi(this._view,h.elevationAlignedLocation)).next(an(this._view,h.elevationAlignedLocation,s,i,e)).next(Ki(h.location,this.angle+(n+1)*Math.PI*.5)).next(Yi());t(h,c,a,o,l)})))))}get angle(){return this._angle}set angle(t){this._angle=t,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(t){this._radius!==t&&(this._radius=t,this._updateManipulators())}_updateManipulators(){for(let t=0;t<this._arrowManipulatorInfos.length;t++)this._updateArrowManipulator(this._arrowManipulatorInfos[t],t);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:t,transform:s},i){const e=this._radius/$h,h=54*e,n=h*Math.sqrt(3)/2,r=Pt.createExtrudedTriangle(n,h/2,h/2,.02);Pt.transformInPlace(r,os(ci.get(),L(oi.get(),0,-n/3,0))),t.renderObjects=[{geometry:r,material:this._opaqueMaterial,stateMask:2},{geometry:r,material:this._transparentMaterial,stateMask:1}],t.radius=n/3*2*1.2;const a=ls(ci.get());cs(a,i*Math.PI/2);const o=ls(ci.get());os(o,L(oi.get(),0,100*e,0)),us(s,a,o)}_createManipulators(){for(let t=0;t<4;t++){const s=this._createArrowManipulator(t);this._arrowManipulatorInfos.push(s)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const t=this.angle,s=ls(ci.get());ds(s,s,t,gt(0,0,1));const i=ps(ci.get(),L(oi.get(),this.displayScale,this.displayScale,this.displayScale)),e=ls(ci.get());us(e,i,s);for(const t of this._arrowManipulatorInfos){const s=us(ci.get(),e,t.transform);t.manipulator.modelTransform=s}}_createArrowManipulator(t){const s=new xi({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:gt(0,0,1)}}),i={manipulator:s,transform:vs()};return this._updateArrowManipulator(i,t),this._handles.add(s.events.on("drag",(t=>{this._updateAfterDrag&&"end"===t.action&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)}))),i}createMaterial(t=1){const s=I.toUnitRGBA(fh.main);return s[3]*=t,new It({color:s,transparent:1!==t,cullFace:2,renderOccluded:2})}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map((({manipulator:t})=>t))}}}class vn{constructor(){this.view=null,this.elevationInfo=null,this.lastDragEvent=null,this.next=new Bi,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&s(this.lastDragEvent)){const i=this.lastDragEvent.mapEnd,e=this.snap(this.lastDragEvent.screenEnd);s(e)&&this.next.execute({action:"update",mapStart:this.lastDragEvent.mapStart,mapEnd:!0===t?e:i,screenStart:this.lastDragEvent.screenEnd,screenEnd:this.lastDragEvent.screenEnd})}this._enabled=t}snap(t){const i=s(this.view)?this.view.toMap(t,{exclude:[]}):null;return s(i)&&s(this.view)&&(i.z=k(i,this.view,this.elevationInfo)),i}createDragEventPipelineStep(t,i){return this.view=t,this.elevationInfo=i,this.lastDragEvent=null,t=>{if(this.lastDragEvent="end"!==t.action?{...t}:null,this._enabled){const i=this.snap(t.screenEnd);return s(i)?{action:t.action,mapStart:t.mapStart,mapEnd:i,screenStart:t.screenStart,screenEnd:t.screenEnd}:null}return{action:t.action,mapStart:t.mapStart,mapEnd:t.mapEnd,screenStart:t.screenStart,screenEnd:t.screenEnd}}}}class wn extends hn{constructor(t){super(),this._handles=new n,this._snapToScene=new vn,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=$h,this._view=t.view,this._tool=t.tool,null!=t.snapToScene&&(this.snapToScene=t.snapToScene),null!=t.radius&&(this._radius=t.radius),this._createManipulator(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this._handles.destroy(),this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(t){t(this._manipulator,1)}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(t){this._snapToScene.enabled=t}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}createGraphicDragPipeline(t,s,i){const e=s.graphic,h=E(e),n=r(e.geometry).spatialReference;return gn(s,i,(s=>this.createDragPipeline(((i,e,h,n,r)=>s(i,t(i,e,h,n,r),h)),h,n,e)),this._view.state.viewingMode)}createDragPipeline(t,s,i,e){const h=this._view;return qi(this._manipulator,((n,r,a,o,l)=>{const c=r.next(Xi(h,n.elevationAlignedLocation)).next(an(h,n.elevationAlignedLocation,s,i,e)).next(this._snapToScene.createDragEventPipelineStep(h,s),this._snapToScene.next).next((t=>({...t,manipulatorType:1}))).next(Yi());t(n,c,a,o,l)}))}_updateManipulatorTransform(){const t=ps(ci.get(),L(oi.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=t}_createManipulator(){this._manipulator=new xi({view:this._view,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:gt(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const t=Pt.createCylinderGeometry(.02,1,128,gt(0,0,1),gt(0,0,0)),s=ps(vs(),gt(this._radius,this._radius,this._radius));this._manipulator.renderObjects=[{geometry:t,material:this._discMaterial,transform:s,stateMask:2},{geometry:t,material:this._discMaterialTransparent,transform:s,stateMask:1}],this._manipulator.radius=this._radius/$h*80}_createMaterial(t=1){const s=I.toUnitRGBA(fh.main);return s[3]*=t,new It({color:s,transparent:1!==t,cullFace:2,renderOccluded:2})}get test(){return{discManipulator:this._manipulator}}}class yn extends hn{constructor(t){super(),this._handles=new n,this._radius=$h,this.events=new p,this._tool=t.tool,this._view=t.view,null!=t.radius&&(this._radius=t.radius),this.createManipulator(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this._handles.destroy(),this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()}))}forEachManipulator(t){t(this._manipulator,0)}createGraphicDragPipeline(t,s,i){const e=r(s.graphic.geometry).spatialReference;return gn(s,i,(s=>this.createDragPipeline(((i,e,h,n,r)=>s(i,t(i,e,h,n,r),h)),e)),this._view.state.viewingMode)}createDragPipeline(t,s){const i=this._view;return qi(this._manipulator,((e,h,n,r,a)=>{const o=h.next((t=>({...t,manipulatorType:0}))).next(ln(i,e.renderLocation,s)).next(Yi());t(e,o,n,r,a)}))}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this.updateManipulator())}updateManipulator(){const t=this._radius/$h,s=kh.zManipulator.height*t,i=kh.zManipulator.coneHeight*t,e=kh.zManipulator.coneWidth*t,h=kh.zManipulator.width*t,n=[gt(0,0,0),gt(0,0,s)],r=Pt.createTubeGeometry(n,h/2,16,!1),a=Pt.createConeGeometry(i,e/2,16,!1),o=[gt(0,0,0),gt(0,0,s+i)],l=(()=>{const t=vs();return as(t,t,[0,0,s]),gs(t,t,Math.PI/2),t})(),c=(t,s)=>{const i=vi(kh.zManipulator.color,s);return[i.r/255,i.g/255,i.b/255,kh.zManipulator.color.a*t]},u=Di(c(1,.25),1),d=Di(c(1,0),1),p=Di(c(.7,0),kh.zManipulator.renderOccluded),g=Di(c(.85,0),kh.zManipulator.renderOccluded);this._manipulator.renderObjects=[{geometry:a,transform:l,material:u,stateMask:1},{geometry:r,material:u,stateMask:1},{geometry:a,transform:l,material:d,stateMask:2},{geometry:r,material:d,stateMask:2},{geometry:a,transform:l,material:p,stateMask:1},{geometry:r,material:p,stateMask:1},{geometry:a,transform:l,material:g,stateMask:2},{geometry:r,material:g,stateMask:2}],this._manipulator.radius=h/2+2,this._manipulator.collisionType={type:"line",paths:[o]}}createManipulator(){const t=new xi({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});t.applyObjectTransform=t=>{const s=this._view.state.camera,i=bn;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,i);const e=nt(s.eye,i),h=s.computeRenderPixelSizeAtDist(e),n=_(Mn,i,s.eye);U(n,n);const r=xn;this._view.renderCoordsHelper.worldUpAtPosition(bn,r);const a=Math.abs(ht(n,r)),o=B(Mn,n,r),l=B(Mn,o,r),c=J(a,.01,1),u=1-Math.sqrt(1-c*c)/c/s.fullWidth,d=kh.zManipulator.width*(this._radius/$h);st(l,U(l,l),(1/u-1)*e+h*d),t[12]-=Mn[0],t[13]-=Mn[1],t[14]-=Mn[2]},this._manipulator=t,this.updateManipulator()}get test(){return{manipulator:this._manipulator}}}const bn=dt(),Mn=dt(),xn=dt();class Dn extends hn{constructor(t){super(),this._handles=new n,this._angleDeferred=null,this._interactive=!0;const{tool:s,view:i,snapToScene:e,radius:h}=t;this._view=i,this.xyManipulation=new wn({tool:s,view:i,snapToScene:e,radius:h}),this.xyAxisManipulation=new mn({tool:s,view:i,radius:h}),this.zManipulation=new yn({tool:s,view:i,radius:h}),this.xyManipulation.available=t.xyAvailable,this.xyAxisManipulation.available=t.xyAxisAvailable,this.zManipulation.available=t.zAvailable,this.autoHideXYAxis(),this.forEachManipulator((t=>{this._handles.add(t.events.on("grab-changed",(()=>this.updateManipulatorInteractivity())))}))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(t,s,i){return g([this.xyManipulation.createGraphicDragPipeline(((s,i,e,h,n)=>t(0,s,i,e,h,n)),s,i),this.xyAxisManipulation.createGraphicDragPipeline(((s,i,e,h,n)=>t(1,s,i,e,h,n)),s,i),this.zManipulation.createGraphicDragPipeline(((s,i,e,h,n)=>t(2,s,i,e,h,n)),s,i)])}createDragPipeline(t,s,i,e){return g([this.xyManipulation.createDragPipeline(((s,i,e,h,n)=>t(0,s,i,e,h,n)),s,i,e),this.xyAxisManipulation.createDragPipeline(((s,i,e,h,n)=>t(1,s,i,e,h,n)),s,i,e),this.zManipulation.createDragPipeline(((s,i,e,h,n)=>t(2,s,i,e,h,n)),i)])}set snapToScene(t){this.xyManipulation.snapToScene=t}set angle(t){this._angleDeferred=null,this.xyAxisManipulation.angle=t}set angleDeferred(t){this.xyAxisVisible?this.angle=t():this._angleDeferred=t}set interactive(t){this._interactive!==t&&(this._interactive=t,this.updateManipulatorInteractivity())}set radius(t){this.xyAxisManipulation.radius=t,this.xyManipulation.radius=t,this.zManipulation.radius=t}set displayScale(t){this.xyManipulation.displayScale=t,this.xyAxisManipulation.displayScale=t}forEachManipulator(t){this.xyManipulation.forEachManipulator((s=>t(s,1))),this.xyAxisManipulation.forEachManipulator((s=>t(s,1))),this.zManipulation.forEachManipulator((s=>t(s,0)))}get xyAxisVisible(){const t=this.xyManipulation.someManipulator((t=>t.focused))||this.xyAxisManipulation.someManipulator((t=>t.focused));return this._view.inputManager&&"touch"===this._view.inputManager.latestPointerType||t}autoHideXYAxis(){const t=this.xyAxisManipulation,i=this.xyManipulation;if(w("esri-mobile"))return;const e=[];i.forEachManipulator((t=>e.push(t))),t.forEachManipulator((t=>e.push(t)));const h=()=>{const i=[];this.xyAxisVisible?s(this._angleDeferred)&&(this.angle=this._angleDeferred()):t.forEachManipulator((t=>i.push(t.disableDisplay()))),this._handles.remove(Sn),this._handles.add(i,Sn)};for(const t of e)this._handles.add(t.events.on("focus-changed",h));this._view.inputManager&&this._handles.add(this._view.inputManager.watch("latestPointerType",h)),h()}updateManipulatorInteractivity(){const t=this.grabbing;this.forEachManipulator((s=>{s.interactive=!t&&this._interactive||s.grabbing}))}static radiusForSymbol(t){const i=s(t)&&"point-3d"===t.type&&t.symbolLayers;return i&&i.length>0&&i.some((t=>"icon"===t.type))?tn:$h}}const Sn="disable-xy-axis-display";class Pn extends hn{constructor(t){super(),this._handles=new n,this._view=t.view,this._tool=t.tool,this._graphicState=t.graphicState,this._createManipulator(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this._handles.destroy(),this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(t){t(this._manipulator,1)}createGraphicDragPipeline(t){return gn(this._graphicState,t,(t=>this.createDragPipeline(t)),this._view.state.viewingMode)}createDragPipeline(t){const i=this._view,e=this._graphicState.graphic,h=s(e.geometry)?e.geometry.spatialReference:null;return qi(this._manipulator,((n,r,a,o,l)=>{const c=r.next(function(t,i,e,h){const n=i.toMap(t.screenStart,{include:[e]});return s(n)?on(i,e,n,h):null}(l,i,e,h)).next(Ji()).next(Yi());t(n,c,a,o,l)}))}_createManipulator(){this._manipulator=new re({graphic:this._graphicState.graphic,view:this._view,selectable:!0,cursor:"move"})}}class An{constructor(t){this.allGraphics=t,this.type="graphic-move-start"}}class On{constructor(t,s,i){this.dx=t,this.dy=s,this.allGraphics=i,this.type="graphic-move"}}class Cn{constructor(t){this.allGraphics=t,this.type="graphic-move-stop"}}let zn=class extends(ee(p.EventedMixin($i))){constructor(t){super(t),this.graphics=new y,this.enableZ=!0,this.type="move-3d",this._toolHandles=new n,this.snappingPipeline=new te}initialize(){this._toolHandles.add([this.graphics.on("change",(()=>this._refreshManipulators()))]),this._refreshManipulators(),this.complete()}destroy(){this._toolHandles.destroy(),this._toolHandles=null,this.graphics.removeAll(),this._set("view",null)}get updating(){return this.updatingHandles.updating}reset(){}_refreshManipulators(){this.handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const t=this.graphics.toArray().filter((t=>0===R(t))).map((t=>new En(t)));t.length&&(this.createManipulators(t),this.createVisualElements(t),this.handles.add(t.map((t=>this.view.trackGraphicState(t.state)))),this.updateMoveManipulation(t))}createManipulators(t){for(const s of t){const i=s.state;s.manipulationXY=new Pn({tool:this,view:this.view,graphicState:i}),s.manipulationXY.forEachManipulator((t=>this.handles.add(t.events.on("immediate-click",(t=>{this.emit("immediate-click",{...t,graphic:i.graphic}),t.stopPropagation()}))))),this.handles.add(s.manipulationXY.createDragPipeline(((s,i,e,h)=>this.buildDragEventPipeline(t,0,s,i,e,h))))}this.createMoveManipulation(t)}createMoveManipulation(t){const s=new Dn({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===t.length?Dn.radiusForSymbol(t[0].graphic.symbol):$h});this._moveManipulation=s,s.elevationInfo={mode:"absolute-height",offset:0},s.forEachManipulator((t=>{this.handles.add(t.events.on("immediate-click",(i=>{s.zManipulation.hasManipulator(t)||1!==this.graphics.length||this.emit("immediate-click",{...i,graphic:this.graphics.getItemAt(0)}),i.stopPropagation()})))}));const i=()=>this.updateMoveManipulation(t);for(const s of t)this.handles.add([s.state.on("changed",i),s.state.watch("displaying",i)]);const e=t[t.length-1];this.handles.add(e.state.on("changed",(()=>this.updateMoveManipulationAngle(e)))),this.handles.add(s.createDragPipeline(((s,i,e,h,n)=>this.buildDragEventPipeline(t,s,i,e,h,n)),E(e.graphic),r(e.graphic.geometry).spatialReference,e.graphic)),this.updateMoveManipulationAngle(e)}createVisualElements(t){for(const s of t){const e=Yh({view:this.view,graphic:s.graphic,forEachManipulator:t=>{s.manipulationXY.forEachManipulator(t),this._moveManipulation.forEachManipulator(t)},onManipulatorsChanged:()=>f()});i(e)||(s.geometryRepresentation=e.visualElement,s.geometryRepresentation instanceof Th&&this.handles.add([s.geometryRepresentation.events.on("attachment-origin-changed",(()=>{s.state.isDraped||this.updateMoveManipulation(t)})),s.state.watch("isDraped",(()=>this.updateMoveManipulation(t)))]),this.handles.add(e))}}updateMoveManipulationAngle(t){this._moveManipulation.angleDeferred=()=>fn(t.graphic.geometry)}updateMoveManipulation(t){const i=wi(0,0,0,this.view.spatialReference);let e=0,h=!1;const n=this._moveManipulation;for(const n of t){if(!n.state.displaying)continue;const t=n.state.graphic;this.enableZ&&Nh(t)&&(h=!0);const r=n.geometryRepresentation instanceof Th&&!n.state.isDraped?n.geometryRepresentation.attachmentOrigin:Si(this.view,t);s(r)&&(i.x+=r.x,i.y+=r.y,i.z+=r.z,e++)}e>0?(i.x/=e,i.y/=e,i.z/=e,n.location=i,n.xyManipulation.available=!0,n.xyAxisManipulation.available=!0,n.zManipulation.available=h):n.available=!1}buildDragEventPipeline(t,s,i,e,h,n){const r=[],a=[];let o=null,l=null;const c=()=>{for(const t of r)t.dragging=!1;r.length=0,a.length=0,o=null,l=null,this._moveManipulation.interactive=!0};if(1===t.length&&0===s){const s=t[0].graphic;e=this.buildSnappingPipelineSteps(s,E(s),e,h,n)}const u=e.next((s=>{if("start"===s.action){r.length=0,a.length=0;for(const s of t)s.dragging||!s.manipulationXY.hasManipulator(i)&&s.manipulationXY.grabbing||(r.push(s),a.push(s.graphic),s.dragging=!0);if(0!==a.length&&(this._moveManipulation.interactive=!1,o=se(a,this.view.state.viewingMode),l=ie(a),this.emit("graphic-move-start",new An(a)),this.destroyed))return null}return 0!==a.length?s:null})).next((t=>o(t))).next((t=>{switch(t.action){case"start":case"update":if(t.translationX||t.translationY||t.translationZ){const s=this.view.toScreen(t.mapStart),i=this.view.toScreen(t.mapEnd);if(this.emit("graphic-move",new On(i.x-s.x,i.y-s.y,a)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new Cn(a)),this.destroyed)return null;c()}}));return h.next((t=>l(t))).next((()=>{if(this.emit("graphic-move-stop",new Cn(a)),this.destroyed)return null;c()})),u}buildSnappingPipelineSteps(t,s,e,h,n){const r=t.geometry;if(i(r)||"point"!==r.type&&"mesh"!==r.type)return e;const a=("point"===r.type?r:r.anchor).clone(),o=new gi({elevationInfo:s,pointer:n,editGeometryOperations:ae.fromGeometry(a,this.view.state.viewingMode),visualizer:new gh,excludeFeature:t}),l=this.snappingManager;return e.next((s=>(a.z=j(this.view,a,E(t),{mode:"absolute-height",offset:0}),{...s,snapOrigin:o.coordinateHelper.pointToVector(a)}))).next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:o,snappingManager:l,cancel:h,updatingHandles:this.updatingHandles}),this.snappingPipeline.next)}};t([u({constructOnly:!0,nonNullable:!0})],zn.prototype,"view",void 0),t([u({readOnly:!0})],zn.prototype,"graphics",void 0),t([u({constructOnly:!0,nonNullable:!0})],zn.prototype,"enableZ",void 0),t([u({constructOnly:!0})],zn.prototype,"snappingManager",void 0),t([u({readOnly:!0})],zn.prototype,"type",void 0),t([u({readOnly:!0})],zn.prototype,"updating",null),zn=t([d("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],zn);class En{constructor(t){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new C({graphic:t})}get graphic(){return this.state.graphic}}function kn(t,s,i){return new oe(t,"on-the-ground"===i.mode?1:0,s,0)}function Rn(t,s,e){const h=dt();if(!t.renderCoordsHelper.toRenderCoords(s,h))return null;const n=jn(t,s,hs(e.plane)),r=jn(t,s,e.edgeDirection);if(i(n)||i(r))return null;const a=B(dt(),n,r);return is(h,a,ss())}function jn(t,s,i){const e=wi(s.x+i[0],s.y+i[1],s.z+i[2],s.spatialReference),h=dt(),n=dt();return t.renderCoordsHelper.toRenderCoords(s,h)&&t.renderCoordsHelper.toRenderCoords(e,n)?rt(n,h,n):null}let Tn=class extends(p.EventedMixin(he)){constructor(t){super(t),this._vertexManipulatorMaterial=Di(kh.colorToVec4(kh.reshapeManipulators.vertex.color),kh.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorOutlineMaterial=Pi(kh.colorToVec4(kh.reshapeManipulators.vertex.outlineColor),kh.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=Pi(kh.colorToVec4(kh.reshapeManipulators.vertex.hoverOutlineColor),kh.reshapeManipulators.vertex.renderOccluded),this._edgeManipulatorMaterial=Di(kh.colorToVec4(kh.reshapeManipulators.edge.color),kh.reshapeManipulators.edge.renderOccluded),this._edgeManipulatorOutlineMaterial=Pi(kh.colorToVec4(kh.reshapeManipulators.edge.outlineColor),kh.reshapeManipulators.edge.renderOccluded),this._edgeOffsetManipulatorMaterial=Di(kh.colorToVec4(kh.reshapeManipulators.edgeOffset.color),kh.reshapeManipulators.edgeOffset.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=Di(kh.colorToVec4(kh.reshapeManipulators.edgeOffset.hoverColor),kh.reshapeManipulators.edgeOffset.renderOccluded,!1),this._selectedManipulatorMaterial=Di(kh.colorToVec4(kh.reshapeManipulators.selected.color),kh.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorOutlineMaterial=Pi(kh.colorToVec4(kh.reshapeManipulators.selected.outlineColor),kh.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=Pi(kh.colorToVec4(kh.reshapeManipulators.selected.hoverOutlineColor),kh.reshapeManipulators.selected.renderOccluded),this._selectedIndex=0,this._vertexManipulatorGeometry=null,this._vertexManipulatorOutlineGeometry=null,this._edgeManipulatorGeometry=null,this._edgeManipulatorOutlineGeometry=null,this._edgeOffsetManipulatorGeometryInside=null,this._edgeOffsetManipulatorGeometryOutside=null,this._manipulatorHandles=new n,this._manipulatorInfos=[],this._editGeometryOperations=null,this._graphicMoveManipulation=null,this._moveManipulation=null,this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=0,this._outlineVisualElement=null,this.tool=null,this.outputGeometry=null,this._snappingPipeline=new te,this._snappingPipelineHandle=new te,this._vertexLaserLineVisualElement=null}initialize(){const t=new C({graphic:this.graphic});this._graphicState=t,this.handles.add([t.watch("displaying",(t=>{for(const s of this._manipulatorInfos)s.manipulator.available=t})),this.view.trackGraphicState(t)])}destroy(){this._editGeometryOperations=m(this._editGeometryOperations),this._moveManipulation=m(this._moveManipulation),this._graphicMoveManipulation=m(this._graphicMoveManipulation),this._manipulatorHandles=m(this._manipulatorHandles),this.manipulators.removeAll(),this._manipulatorInfos=[],this._resetGrabbingDragging()}get inputGeometry(){return s(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null}set inputGeometry(t){this._recreateEditGeometryAndManipulators(t)}get updating(){return this.updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}removeSelectedVertices(){const t=this._manipulatorInfos.filter((t=>t.manipulator.selected&&"vertex"===t.handle.type));this._removeVertices(t)}manipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._moveManipulation=m(this._moveManipulation),this._graphicMoveManipulation=m(this._graphicMoveManipulation),this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[]}_resetGrabbingDragging(){this._numGrabbing=0,this._numDragging=0}_createManipulators(){if(i(this._editGeometryOperations))return;const t=E(this.graphic);for(const s of this._editGeometryOperations.data.components){for(const i of s.vertices)this._createVertexOrEdgeManipulator(i,t);for(const i of s.edges)this._createVertexOrEdgeManipulator(i,t)}this._createGraphicMoveManipulators(t)}get canRedo(){return s(this._editGeometryOperations)&&this._editGeometryOperations.canRedo}get canUndo(){return s(this._editGeometryOperations)&&this._editGeometryOperations.canUndo}redo(){if(i(this._editGeometryOperations))return null;const t=this._editGeometryOperations.redo();return s(t)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}undo(){if(i(this._editGeometryOperations))return null;this.emit("undo");const t=this._editGeometryOperations.undo();return s(t)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}_recreateManipulators(){this._removeManipulators(),this._resetGrabbingDragging(),this._createManipulators()}_recreateEditGeometryAndManipulators(t=this.inputGeometry){this._removeManipulators(),this._resetGrabbingDragging(),i(t)||(m(this._editGeometryOperations),this._editGeometryOperations=ae.fromGeometry(t,this.view.state.viewingMode),this._createManipulators())}_perGraphicManipulatorDragAction(t,s){if("end"===s.action)return;let i=0;const e=[],h=this._manipulatorInfos.some((t=>"vertex"===t.handle.type&&t.manipulator.selected)),n=1===t&&h;for(const t of this._manipulatorInfos)Gn(t)&&(t.manipulator.grabbing||n&&!t.manipulator.selected||e.push(t),i++);if(0!==e.length)if(this._moveVertices(e,s),e.length===i){if(this._updateEventState(1),this.destroyed)return;this.emit("move",{type:"move",dx:s.screenDeltaX,dy:s.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(2),this.destroyed)return;this.emit("reshape",{type:"reshape",mover:this.graphic})}}_isMultiVertexSelection(){let t=0;for(const s of this._manipulatorInfos)Gn(s)&&s.manipulator.selected&&t++;return t>1}_perVertexManipulatorDragAction(t){if(this._updateEventState(2),this.destroyed)return;const{mapDeltaX:s,mapDeltaY:i,mapDeltaZ:e}=t;if(!s&&!i&&!e)return;const h=[];for(const s of this._manipulatorInfos)Gn(s)&&(s.manipulator.selected&&!s.manipulator.grabbing||s===t.info)&&h.push(s);this._moveVertices(h,t,1),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(t){if(t===this._reshapeEventState)return!1;switch(t){case 0:if(0!==this._numGrabbing||0!==this._numDragging)return!1;switch(this._reshapeEventState){case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case 1:switch(this._reshapeEventState){case 0:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case 2:switch(this._reshapeEventState){case 0:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const s=this._reshapeEventState!==t;return this._reshapeEventState=t,s}_createGraphicMoveManipulators(t){if(this._graphicMoveManipulation=new Pn({tool:this.tool,view:this.view,graphicState:this._graphicState}),this.enableMoveGraphic){let t=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline(((s,i,e)=>{i.next((t=>this._trackNumDragging(t))).next((s=>("start"===s.action&&(t=r(this._editGeometryOperations).createUndoGroup()),s))).next((s=>{this._perGraphicManipulatorDragAction(0,s),"end"===s.action&&(t=b(t))})),e.next(this._cancelDragOperation((()=>t=b(t))))})))}else this._graphicMoveManipulation.forEachManipulator((t=>{t.grabbable=!1,t.cursor=null}));this._graphicMoveManipulation.forEachManipulator((t=>this._manipulatorHandles.add([this._watchAndUpdateGrabState(t,!1),t.events.on("immediate-click",(t=>{this._manipulatorInfos.some((t=>t.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...t,graphic:this.graphic}),t.stopPropagation()}))]))),this._moveManipulation=new Dn({tool:this.tool,view:this.view,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&Nh(this.graphic),snapToScene:!1,radius:Dn.radiusForSymbol(this.graphic.symbol)}),this._moveManipulation.forEachManipulator((t=>{this.handles.add([this._watchAndUpdateGrabState(t,!1),t.events.on("immediate-click",(s=>{this._moveManipulation.zManipulation.hasManipulator(t)||this._manipulatorInfos.some((t=>t.manipulator.selected))||this.emit("immediate-click",{...s,graphic:this.graphic}),s.stopPropagation()}))])})),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const i=r(this.graphic.geometry).spatialReference;this.handles.add([this._moveManipulation.createDragPipeline(((s,i,e,h,n)=>{const a=e.next((t=>this._trackNumDragging(t))).next((t=>{const s=this._manipulatorInfos.filter((t=>Gn(t)&&t.manipulator.selected));return 1===t.manipulatorType&&1===s.length?{...t,info:s[0],snapOrigin:s[0].handle.pos}:{...t,info:null}})).next(this._snappingPipelineHandle.createSnapDragEventPipelineStep({predicate:t=>!!t.info,cancel:h,snappingManager:this.tool.snappingManager,snappingContext:new gi({editGeometryOperations:r(this._editGeometryOperations),elevationInfo:t,pointer:n,excludeFeature:this.graphic,visualizer:new gh}),updatingHandles:this.updatingHandles}),this._snappingPipelineHandle.next).next(Ji()).next((t=>(this._perGraphicManipulatorDragAction(1,t),t)));return h.next(this._cancelDragOperation()),a}),t,i,this.graphic),o(this._graphicState,"displaying",(()=>{this._updateMoveManipulationPosition()})),this._graphicState.on("changed",(()=>this._updateMoveManipulationPosition())),o(this._graphicState,"isDraped",(()=>{const t="align-move-manipulation";this._graphicState.isDraped?this.handles.add(this.view.elevationProvider.on("elevation-change",(()=>this._updateMoveManipulationPosition())),t):this.handles.remove(t)}))]),this._updateMoveManipulationPosition();const e=Yh({view:this.view,graphic:this.graphic,forEachManipulator:t=>{if(!this.destroyed){s(this._graphicMoveManipulation)&&this._graphicMoveManipulation.forEachManipulator(t);for(const s of this._manipulatorInfos)t(s.manipulator,1);this._moveManipulation.forEachManipulator(t)}},onManipulatorsChanged:t=>this.on("manipulators-changed",t)});s(e)&&(this._outlineVisualElement=e.visualElement instanceof Th?e.visualElement:null),s(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",(()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()})),this._graphicState.watch("isDraped",(()=>this._updateMoveManipulationPosition()))]),this._manipulatorHandles.add(e)}_createEdgeOffsetManipulator(t,e=E(this.graphic)){const h=kh.reshapeManipulators.edgeOffset,n=h.size/2,r=n+h.collisionPadding;if(i(this._edgeOffsetManipulatorGeometryInside)||i(this._edgeOffsetManipulatorGeometryOutside)){const t=n/r,s=t*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside=Pt.createExtrudedTriangle(s,t/2,t/2,h.height,h.offset),this._edgeOffsetManipulatorGeometryOutside=Pt.createExtrudedTriangle(-s,t/2,t/2,h.height,-h.offset)}const a=new xi({view:this.view,renderObjects:[{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorMaterial,stateMask:1},{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:2},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorMaterial,stateMask:1},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:2}],elevationInfo:"on-the-ground"!==e.mode||ge(this.graphic.symbol)?{mode:"absolute-height",offset:0}:e,worldOriented:!1,focusMultiplier:1,radius:r,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionType:{type:"disc",direction:gt(0,0,1)},collisionPriority:1}),o=new xi({view:this.view,renderObjects:[],worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default"}),l={manipulator:a,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:o,elevationInfo:e,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(l,h.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(l);const c=this._getManipulatorInfoFromHandle(l.handle.leftVertex).manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(l))),u=this._getManipulatorInfoFromHandle(l.handle.rightVertex).manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(l)));l.locationUpdateHandle=g([c,u]),this._manipulatorHandles.add(l.locationUpdateHandle,a),this._manipulatorHandles.add([this._watchAndUpdateGrabState(a,!0),this._watchAndUpdateGrabState(o,!0)],a),this._manipulatorHandles.add(qi(a,this._createEdgeOffsetPipeline(l,e)),a),this._manipulatorHandles.add(qi(o,((t,i,h,n)=>{if("touch"===n)this._createEdgeOffsetPipeline(l,e)(t,i,h);else if(this.enableMoveGraphic){const n=this.graphic,r=s(n.geometry)?n.geometry.spatialReference:null;i.next((t=>this._trackNumDragging(t))).next(Xi(this.view,t.elevationAlignedLocation)).next(an(this.view,t.elevationAlignedLocation,e,r,n)).next(Yi()).next(Ji()).next((t=>this._perGraphicManipulatorDragAction(0,t))),h.next(this._cancelDragOperation())}})),a);const d=t=>{this._manipulatorInfos.some((t=>t.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...t,graphic:this.graphic}),t.stopPropagation()};return this._manipulatorHandles.add([a.events.on("immediate-click",d),o.events.on("immediate-click",d)],a),this._manipulatorInfos.push(l),this.manipulators.add(a),this.manipulators.add(o),this.emit("manipulators-changed"),l}_autoHideEdgeOffsetManipulator(t,i){const e=t.manipulator,h=t.edgeManipulator,n=()=>{b(t.visibilityHandle);const n=function(t,i,e){const h=e.projectToRenderScreen(t,Us()),n=e.projectToRenderScreen(i,Us());return s(h)&&s(n)?at(_(h,h,n)):0}(this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator.renderLocation,this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator.renderLocation,this.view.state.camera)<i;(!e.focused&&!h.focused||n)&&(e.grabbable=!n,h.grabbable=!n,t.visibilityHandle=g([e.disableDisplay(),{remove:()=>{e.grabbable=!0,h.grabbable=this.enableMoveGraphic}}]))};this._manipulatorHandles.add([e.events.on("focus-changed",n),h.events.on("focus-changed",n),{remove:()=>{b(t.visibilityHandle),this.manipulators.remove(h)}}],e),n()}_updateEdgeOffsetManipulator(t){this._updateManipulatorPosition(t);const i=r(this._editGeometryOperations).data.coordinateHelper,e=Rn(this.view,t.manipulator.elevationAlignedLocation,kn(i,t.handle,r(t.manipulator.elevationInfo))),h=this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator.renderLocation,n=this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator.renderLocation,a=s(e)?function(t,s,i){const e=hs(t),h=rt(dt(),s,i),n=B(dt(),h,e),r=B(dt(),h,n);return ws(h[0],h[1],h[2],0,n[0],n[1],n[2],0,r[0],r[1],r[2],0,0,0,0,1)}(e,h,n):ys;t.manipulator.modelTransform=a,t.edgeManipulator.elevationAlignedLocation=t.manipulator.elevationAlignedLocation,t.edgeManipulator.modelTransform=a;const o=et(_(_n,h,n))/2;t.edgeManipulator.collisionType={type:"line",paths:[[[-o,0,0],[o,0,0]]]}}_createEdgeOffsetPipeline(t,s){return(i,e,h)=>{this._clearSelection();const{step:n,cleanup:a}=this._initializeEdgeOffset(t,s);e.next((t=>this._trackNumDragging(t))).next(Xi(this.view,i.elevationAlignedLocation)).next(n).next(function(t){return rn(t,(t=>t.plane))}(this.view)).next(cn(this.view,r(this._editGeometryOperations).data.spatialReference)).next(Ji()).next(this._applyEdgeOffsetStep(t)).next((t=>{"end"===t.action&&a()})),h.next((t=>(a(),t))).next(this._cancelDragOperation())}}_initializeEdgeOffset(t,s){const e=r(this._editGeometryOperations),h=kn(e.data.coordinateHelper,t.handle,s),n=e.createUndoGroup(),a=Rn(this.view,t.manipulator.elevationAlignedLocation,h);h.requiresSplitEdgeLeft&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(t.handle.leftVertex.leftEdge),1),h.requiresSplitEdgeRight&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(t.handle.rightVertex.rightEdge),0);const o=()=>new pe({paths:[[t.handle.leftVertex.pos,t.handle.rightVertex.pos]],spatialReference:r(this._editGeometryOperations).data.spatialReference}),c=new Th({view:this.view,isDraped:this._graphicState.isDraped,geometry:o(),elevationInfo:t.elevationInfo,width:kh.visualElements.lineGraphics.outline.width,color:kh.colorToVec4(fh.main),attached:!0});let u;const d=()=>{this._cleanEdgeOffsetCollapsedEdges(t),u=b(u)},p=this.on("undo",d);return u=g([l(c),this._graphicState.watch("isDraped",(t=>c.isDraped=t)),this._graphicState.on("changed",(()=>c.geometry=o())),n,p]),{step:t=>i(h)||i(a)?(d(),null):{...t,operation:h,plane:a},cleanup:d}}_applyEdgeOffsetStep(t){return s=>{if(this.destroyed||i(s.operation))return s;this._updateEventState(2);const{mapDeltaX:e,mapDeltaY:h,mapDeltaZ:n}=s;return(e||h||n)&&(this._offsetEdge(t,s),this.emit("reshape",{type:"reshape",mover:this.graphic})),s}}_cleanEdgeOffsetCollapsedEdges(t){var s,i;const e=null==(s=t.handle.leftVertex.leftEdge)?void 0:s.leftVertex,h=t.handle.leftVertex,n=null==(i=t.handle.rightVertex.rightEdge)?void 0:i.rightVertex,a=t.handle.rightVertex,o=r(this._editGeometryOperations).data.coordinateHelper,l=1e-6,c=[];e&&o.distance(e.pos,h.pos)<l&&c.push(this._getManipulatorInfoFromHandle(h)),(o.distance(h.pos,a.pos)<l||n&&o.distance(n.pos,a.pos)<l)&&c.push(this._getManipulatorInfoFromHandle(a)),c.length&&this._removeVertices(c)}_computeVertexManipulatorSizeAndOutline(t){const s=t.size/2,i=s+t.collisionPadding;return{size:s/i,outlineSize:(s+t.outlineSize)/i}}_createVertexOrEdgeManipulator(t,e=E(this.graphic)){if("edge"===t.type){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(t,e);if(!this.enableMidpoints)return null}if(i(this._vertexManipulatorGeometry)||i(this._vertexManipulatorOutlineGeometry)){const{size:t,outlineSize:s}=this._computeVertexManipulatorSizeAndOutline(kh.reshapeManipulators.vertex);this._vertexManipulatorGeometry=Pt.createSphereGeometry(t,16,16),this._vertexManipulatorOutlineGeometry=Pt.createSphereGeometry(s,16,16)}if(i(this._edgeManipulatorGeometry)||i(this._edgeManipulatorOutlineGeometry)){const{size:t,outlineSize:s}=this._computeVertexManipulatorSizeAndOutline(kh.reshapeManipulators.edge);this._edgeManipulatorGeometry=Pt.createSphereGeometry(t,16,16),this._edgeManipulatorOutlineGeometry=Pt.createSphereGeometry(s,16,16)}const h=s(this.graphic.geometry)&&"point"===this.graphic.geometry.type?[]:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:4|Fn.Vertex},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:5|Fn.Vertex},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:6|Fn.Vertex},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:8},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:9},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:10}];this.enableMidpoints&&h.push({geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:6|Fn.Edge},{geometry:this._edgeManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:6|Fn.Edge},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:5|Fn.Edge},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:5|Fn.Edge});const n=new xi({view:this.view,renderObjects:h,elevationInfo:e,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(n,t,e);const a="edge"===t.type?{manipulator:n,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:n,handle:t,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(a),this.manipulators.add(n),this._updateManipulatorPosition(a),"edge"===a.type){const t=this._getManipulatorInfoFromHandle(a.handle.leftVertex).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(a))),s=this._getManipulatorInfoFromHandle(a.handle.rightVertex).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(a)));a.locationUpdateHandle=g([t,s]),this._manipulatorHandles.add(a.locationUpdateHandle,n)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(n,!0),n);const o=qi(n,((t,s,i,h)=>{let n=null;s.next((t=>this._trackNumDragging(t))).next((t=>{if("start"===t.action&&(n=r(this._editGeometryOperations).createUndoGroup()),In(a)){const s=this._splitEdgeManipulator(a);return{...t,info:s,snapOrigin:s.handle.pos}}return{...t,info:a,snapOrigin:a.handle.pos}})).next(Xi(this.view,t.elevationAlignedLocation)).next(on(this.view,this.graphic,t.elevationAlignedLocation,t.location.spatialReference,this.graphic)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>!this._isMultiVertexSelection(),cancel:i,snappingManager:this.tool.snappingManager,snappingContext:new gi({editGeometryOperations:r(this._editGeometryOperations),elevationInfo:e,pointer:h,excludeFeature:this.graphic,visualizer:new gh}),updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next(Ji()).next((t=>{this._perVertexManipulatorDragAction(t),"end"===t.action&&(n=b(n))})),i.next(this._cancelDragOperation((()=>n=b(n))))}));return this._manipulatorHandles.add(o,n),this._manipulatorHandles.add([n.events.on("immediate-click",(t=>this._manipulatorClickCallback(t,a))),n.events.on("select-changed",(()=>{a.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}))],n),this.emit("manipulators-changed"),a}_trackNumDragging(t){switch(t.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return t}_cancelDragOperation(t){return()=>{switch(this._numDragging--,this.undo(),this.outputGeometry=s(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null,s(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping(),this._reshapeEventState){case 0:break;case 1:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape",mover:this.graphic})}t&&t(),this.destroyed||this._updateEventState(0)}}_setTypeSpecificManipulatorSettings(t,i,e){switch(i.type){case"vertex":t.state=Fn.Vertex,t.selectable=!0,t.cursor="move",t.collisionPriority=2,t.radius=kh.reshapeManipulators.vertex.size/2+kh.reshapeManipulators.vertex.collisionPadding,t.elevationInfo=e,t.interactive=s(this.graphic.geometry)&&"point"!==this.graphic.geometry.type;break;case"edge":t.state=Fn.Edge,t.selectable=!1,t.cursor="copy",t.collisionPriority=-1,t.radius=kh.reshapeManipulators.edge.size/2+kh.reshapeManipulators.edge.collisionPadding,t.elevationInfo="on-the-ground"!==e.mode||ge(this.graphic.symbol)?{mode:"absolute-height",offset:0}:e}}_watchAndUpdateGrabState(t,i){return t.events.on("grab-changed",(e=>{if("start"===e.action)i&&this._updateSelection(t),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(0),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,("touch"!==e.pointerType||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach((t=>{t.manipulator.interactive=!this._numGrabbing&&s(this.graphic.geometry)&&"point"!==this.graphic.geometry.type,"edgeManipulator"in t&&(t.edgeManipulator.interactive=!this._numGrabbing)})),r(this._graphicMoveManipulation).forEachManipulator((t=>t.interactive=!this._numGrabbing)))}))}_clearSelection(){for(const t of this._manipulatorInfos)t.manipulator.grabbing||(t.manipulator.selected=!1)}_updateSelection(t){t.grabbing&&!t.selected&&t.selectable&&(this._clearSelection(),t.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(t){t&&(this._manipulatorHandles.remove(t.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(t),1),this.manipulators.remove(t.manipulator),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(t){if(t)for(const s of this._manipulatorInfos)if(t===s.handle)return s;return null}_updateManipulatorPosition(t){if(!t)return;const i=r(this._editGeometryOperations);if("vertex"===t.handle.type)t.manipulator.location=i.data.coordinateHelper.vectorToDehydratedPoint(t.handle.pos,Ln),t.manipulator.grabbing&&s(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=t.manipulator.renderLocation);else if("edge"===t.handle.type){const e=this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator,h=this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator;if(s(t.manipulator.elevationInfo)&&"on-the-ground"===t.manipulator.elevationInfo.mode){const s=e.location,n=h.location,r=.5;t.manipulator.location=wi(s.x+r*(n.x-s.x),s.y+r*(n.y-s.y),s.hasZ&&n.hasZ?0:void 0,i.data.spatialReference)}else tt(_n,e.renderLocation,h.renderLocation,.5),t.manipulator.renderLocation=_n}}_splitEdgeManipulator(t,s=.5){const i=r(this._editGeometryOperations),e=r(i.splitEdge(t.handle,s).createdVertex);t.locationUpdateHandle.remove(),t.locationUpdateHandle=void 0;const h=E(this.graphic);let n;this.enableEdgeOffset?(this._removeManipulator(t),n=this._createVertexOrEdgeManipulator(e)):(n=t,n.handle=e,n.type="vertex",this._setTypeSpecificManipulatorSettings(t.manipulator,t.handle,h)),e.leftEdge&&this._createVertexOrEdgeManipulator(e.leftEdge),e.rightEdge&&this._createVertexOrEdgeManipulator(e.rightEdge),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(n),this._updateSelection(t.manipulator);const a=this._updateEventState(2),o=i.data.coordinateHelper.vectorToArray(n.handle.pos),l=i.data.components.indexOf(e.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:o,componentIndex:l,vertexIndex:r(e.index)}],added:o}),a&&this._updateEventState(0),n}_updateMoveManipulationPosition(){const t=L(_n,0,0,0);let e=0,h=!1,n=null,a=null;for(const s of this._manipulatorInfos)Gn(s)&&(s.manipulator.selected?(e++,Q(t,t,s.manipulator.renderLocation),i(n)||s.selectedIndex>n.selectedIndex?(a=n,n=s):(i(a)||s.selectedIndex>a.selectedIndex)&&(a=s)):h=!0);if(0!==e){const t=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=t,this._moveManipulation.xyAxisManipulation.available=t,this._moveManipulation.zManipulation.available=t&&this.enableZVertex&&Nh(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=t&&1!==e}else{const t=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=t,this._moveManipulation.xyAxisManipulation.available=t,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=t,this._moveManipulation.zManipulation.available=t&&this.enableZShape&&Nh(this.graphic)}if(0!==e){let t=0;if(s(n)){const i=n.handle.pos,e=s(a)?a.handle.pos:n.handle.leftEdge&&n.handle.leftEdge.leftVertex?n.handle.leftEdge.leftVertex.pos:null,h=!s(a)&&n.handle.rightEdge&&n.handle.rightEdge.rightVertex?n.handle.rightEdge.rightVertex.pos:null;e&&h?this._moveManipulation.xyAxisManipulation.available=!1:e?t=Vn(e,i):h&&(t=Vn(i,h))}this._moveManipulation.angle=t,this._moveManipulation.radius=tn}else this._moveManipulation.angleDeferred=()=>fn(r(this.graphic.geometry)),this._moveManipulation.radius=Dn.radiusForSymbol(this.graphic.symbol);0!==e&&h?(st(t,t,1/e),Ln.spatialReference=r(this._editGeometryOperations).data.spatialReference,Ln.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(t,Ln),this._moveManipulation.elevationAlignedLocation=Ln):s(this._outlineVisualElement)&&!this._graphicState.isDraped&&s(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:Ai(this.view,this._moveManipulation,this.graphic)}_removeVertices(t){const s=[],i=r(this._editGeometryOperations);for(const e of t)if("vertex"===e.handle.type&&i.canRemoveVertex()){s.push(e.handle),this._removeManipulator(e),this._removeManipulator(this._getManipulatorInfoFromHandle(e.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(e.handle.rightEdge));const t=r(i.removeVertices([e.handle]).removedVertices[0].createdEdge);t&&this._createVertexOrEdgeManipulator(t)}if(s.length>0){const t=s.map((t=>{const s=i.data.components.indexOf(t.component);return{coordinates:i.data.coordinateHelper.vectorToArray(t.pos),componentIndex:s,vertexIndex:r(t.index)}}));this.outputGeometry=i.data.geometry;const e=this._updateEventState(2);if(this.destroyed)return;if(this.emit("vertex-remove",{type:"vertex-remove",removed:t.map((t=>t.coordinates)),vertices:t}),this.destroyed)return;if(e&&(this._updateEventState(0),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(t,s,i=("start"===s.action?0:1)){const e=r(this._editGeometryOperations);e.moveVertices(t.map((t=>t.handle)),s.mapDeltaX,s.mapDeltaY,s.mapDeltaZ,i),this.outputGeometry=e.data.geometry;for(const s of t)this._updateManipulatorPosition(s)}_offsetEdge(t,s){if(i(s.operation))return;const e=r(this._editGeometryOperations),h=s.operation.clone();h.distance=s.operation.signedDistanceToPoint(s.mapEnd),e.updateVertices([t.handle.leftVertex,t.handle.rightVertex],h),this.outputGeometry=e.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.rightVertex))}_manipulatorClickCallback(t,s){t.shiftKey||this._clearSelection(),"vertex"===s.handle.type&&(s.manipulator.selected=!s.manipulator.selected),"vertex"===s.handle.type&&2===t.button&&this._removeVertices([s]),In(s)&&0===t.button&&this._splitEdgeManipulator(s),t.stopPropagation()}};function Vn(t,s){return Math.atan2(s[1]-t[1],s[0]-t[0])+Math.PI/2}function Gn(t){return"vertex"===t.handle.type}function In(t){return"edge"===t.handle.type}t([u({constructOnly:!0})],Tn.prototype,"tool",void 0),t([u()],Tn.prototype,"inputGeometry",null),t([u()],Tn.prototype,"outputGeometry",void 0),t([u({readOnly:!0})],Tn.prototype,"updating",null),Tn=t([d("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],Tn);const Ln=wi(0,0,null,null),_n=dt();var Fn;!function(t){t.Vertex=16,t.Edge=32}(Fn||(Fn={}));let Wn=class extends(p.EventedMixin($i)){constructor(t){super(t),this._handles=new n,this._reshapeOperation=null,this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.snappingManager=null,this.automaticManipulatorSelection=!1}destroy(){this._handles=m(this._handles),this._reshapeOperation=m(this._reshapeOperation),this._set("view",null),this._set("graphic",null)}get updating(){var t,s;return null!=(t=null==(s=this._reshapeOperation)?void 0:s.updating)&&t}_updateGeometry(){const t=V(this.graphic);this._reshapeOperation.inputGeometry=s(t)?t.clone():null}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),0!==T(this.graphic))return;const t=this.watch("graphic.geometry",(()=>{!1===this._internalGeometryUpdate&&this._updateGeometry()}),!0);this._handles.add(t,"onGraphicGeometryChange")}manipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.manipulatorSelectionChanged()}_updateGeometryInternally(t){this._internalGeometryUpdate=!0,this.graphic.geometry=t,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){i(this.graphic)||this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}initialize(){this._reshapeOperation=new Tn({tool:this}),this._handles.add([this._reshapeOperation.on("reshape",(t=>{"reshape"===t.type&&this._onReshapeGeometryChanged(),this.emit("reshape",t)})),this._reshapeOperation.on("move",(t=>{"move"===t.type&&this._onReshapeGeometryChanged(),this.emit("move",t)})),this._reshapeOperation.on("vertex-add",(t=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",t)})),this._reshapeOperation.on("vertex-remove",(t=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",t)})),this._reshapeOperation.on("immediate-click",(t=>this.emit("immediate-click",t))),this.view.on("pointer-down",["Shift"],(t=>{t.stopPropagation()})),o(this,"graphic",(()=>{this._updateGraphic()}),!0)]),this.complete()}get canUndo(){var t,s;return null!=(t=null==(s=this._reshapeOperation)?void 0:s.canUndo)&&t}undo(){s(this.snappingManager)&&this.snappingManager.doneSnapping(),s(this._reshapeOperation.undo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canRedo(){var t,s;return null!=(t=null==(s=this._reshapeOperation)?void 0:s.canRedo)&&t}redo(){s(this.snappingManager)&&this.snappingManager.doneSnapping(),s(this._reshapeOperation.redo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}onInputEvent(t){"key-down"!==t.type||"Delete"!==t.key&&"Backspace"!==t.key||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager}}};var Nn;t([u()],Wn.prototype,"_reshapeOperation",void 0),t([u({constructOnly:!0,nonNullable:!0})],Wn.prototype,"view",void 0),t([u({constructOnly:!0})],Wn.prototype,"graphic",void 0),t([u({constructOnly:!0,nonNullable:!0})],Wn.prototype,"enableZShape",void 0),t([u({constructOnly:!0,nonNullable:!0})],Wn.prototype,"enableZVertex",void 0),t([u({constructOnly:!0,nonNullable:!0})],Wn.prototype,"enableMoveGraphic",void 0),t([u({constructOnly:!0,nonNullable:!0})],Wn.prototype,"enableMidpoints",void 0),t([u({constructOnly:!0,nonNullable:!0})],Wn.prototype,"enableEdgeOffset",void 0),t([u({readOnly:!0})],Wn.prototype,"type",void 0),t([u({constructOnly:!0})],Wn.prototype,"snappingManager",void 0),t([u({readOnly:!0})],Wn.prototype,"updating",null),t([u()],Wn.prototype,"automaticManipulatorSelection",void 0),Wn=t([d("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],Wn),function(t){t.ScaleIn=32,t.ScaleOut=64,t.RotateLeft=128,t.RotateRight=256,t.Unlocked=1024,t.DelayedFocused=2048,t.TouchInput=32768}(Nn||(Nn={}));class Hn{constructor(t){this.mode=null,this._handles=new n,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new p,this.getFocused=()=>this.ringManipulator.focused,this.getScale=()=>s(this._scaleRotateDragData)&&"scale"===this._scaleRotateDragData.mode?this.adapter.scale:1,this.tool=t.tool,this.mode=t.mode,this.adapter=t.adapter,this.createManipulator(),this.updateDragState(),this.updateManipulatorTransform()}get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(t){this.ringManipulator.location=t}set elevationAlignedLocation(t){this.ringManipulator.elevationAlignedLocation=t}get grabbing(){return this.ringManipulator.grabbing}set interactive(t){this.ringManipulator.interactive=t}destroy(){s(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles=m(this._handles),this.tool.manipulators.remove(this.ringManipulator),this.ringManipulator=null}startAnimation(t){this.cancelActiveAnimation(),t.start();const s=M({update:({deltaTime:s})=>{t.update(s)&&this.cancelActiveAnimation()}});this._activeAnimation={...t,frameTask:s}}cancelActiveAnimation(){s(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=m(this._activeAnimation))}forEachManipulator(t){t(this.ringManipulator,4)}createManipulator(){this.ringManipulator=this.createRingManipulator(),this.tool.manipulators.add(this.ringManipulator);const t=this.tool.graphicState.graphic,i=qi(this.ringManipulator,((i,e,h)=>{this._scaleRotateDragData=null,this.adapter.restart();const n={mode:"none",origin:pt(i.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=n,this.updateDragState();const r=oi.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(i.renderLocation,r),e.next(nn(this.tool.view,is(i.renderLocation,r,ss()))).next((i=>{const e=hs(i.plane),h=Oi(i.renderStart,i.renderEnd,n.origin,e),r=fe.shortestSignedDiff(n.angle,h);n.angleDir=J(n.angleDir+r,-.3,.3),n.angle=h;const a=function(t,s){const i=_(oi.get(),s.renderStart,t.origin),e=_(oi.get(),s.renderEnd,t.origin),h=et(i),n=et(e);return 0===h?0:n/h}(n,i);if(n.scaleDir=J(n.scaleDir+(a-this.adapter.scale),-.2,.2),this.onScaleChanged(),"none"===n.mode){const e=this.mode||function(t,s,i,e){const{renderStart:h,renderEnd:n}=t,r=Un(h,e,oi.get()),a=Un(n,e,oi.get());if(lt(r,a)<100)return null;const o=_(oi.get(),h,i),l=B(oi.get(),o,hs(s)),c=h,u=Q(oi.get(),c,l),d=Un(i,e,oi.get()),p=r,g=Un(u,e,oi.get()),f=_(oi.get(),g,p),m=_(oi.get(),r,d),v=Ut(p,f),w=Ut(d,m);return qt(v,a)<qt(w,a)?"rotate":"scale"}(i,i.plane,n.origin,this.tool.view.state.camera);if(s(e)){switch(e){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:t,angle:0}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:t,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}n.mode=e}}switch(n.mode){case"rotate":this.adapter.angle=n.initialAngle+h;break;case"scale":this.adapter.scale=a,this.onScaleChanged()}switch(this.updateDragState(),this.updateManipulatorTransform(),i.action){case"start":case"update":switch(n.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:t,angle:ot(n.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:t,xScale:a,yScale:a})}break;case"end":switch(n.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:ot(n.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,xScale:a,yScale:a})}}"end"===i.action&&(this.startAnimation(Bn(this,(()=>this.onScaleChanged()))),this._scaleRotateDragData=null,this.updateDragState())})),h.next((()=>{if(this.adapter.cancel(),s(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,xScale:1,yScale:1})}this.startAnimation(Bn(this,(()=>this.onScaleChanged()))),this._scaleRotateDragData=null,this.updateDragState()}}))}));this._handles.add(i),this._handles.add([this.ringManipulator.events.on("focus-changed",(t=>{"focus"===t.action?this.startAnimation(function(t,s){let i=0,e=null;const h=()=>!1;return{start:()=>{e=t.getFocused,t.getFocused=h,i=0,s()},update:t=>(i+=t,!e()||i>200?1:0),destroy:()=>{t.getFocused=e,s()}}}(this,(()=>this.updateDelayedFocusedState()))):this.updateDelayedFocusedState()})),this.ringManipulator.events.on("immediate-click",(t=>{t.stopPropagation()})),o(this.tool.graphicState,"displaying",(t=>this.ringManipulator.available=t))])}onScaleChanged(){this.events.emit("scale-changed"),this.updateManipulatorTransform()}updateDelayedFocusedState(){this.ringManipulator.updateStateEnabled(Nn.DelayedFocused,this.getFocused())}updateDragState(){if(this.ringManipulator.updateStateEnabled(Nn.Unlocked,!(s(this._scaleRotateDragData)&&"none"!==this._scaleRotateDragData.mode)),s(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this.ringManipulator.updateStateEnabled(Nn.ScaleIn|Nn.ScaleOut,!1),this.ringManipulator.updateStateEnabled(Nn.RotateLeft,this._scaleRotateDragData.angleDir<0),this.ringManipulator.updateStateEnabled(Nn.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this.ringManipulator.updateStateEnabled(Nn.RotateLeft|Nn.RotateRight,!1),this.ringManipulator.updateStateEnabled(Nn.ScaleIn,this._scaleRotateDragData.scaleDir<0),this.ringManipulator.updateStateEnabled(Nn.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this.ringManipulator.updateStateEnabled(Nn.ScaleIn|Nn.ScaleOut|Nn.RotateLeft|Nn.RotateRight,!1)}updateManipulatorTransform(){const t=ls(ci.get());ds(t,t,this.adapter.angle,gt(0,0,1));const s=this.getScale(),i=ps(ci.get(),L(oi.get(),s,s,s)),e=ls(ci.get());us(e,i,t),this.ringManipulator.modelTransform=e}createRingManipulator(){const t=(t,s,i)=>{const e=[],h=Math.ceil(128*(s-t)/(2*Math.PI));for(let n=0;n<h+1;n++){const r=t+n*(s-t)/h;e.push(gt(i*Math.cos(r),i*Math.sin(r),0))}return e},s=s=>t(0,2*Math.PI,s),i=(t,s)=>Pt.createPathExtrusionGeometry((t=>[[-t/2,0],[t/2,0],[t/2,.25],[-t/2,.25]])(s),t,[],[],!1),e=s(160),h=i(e,24),n={left:[],right:[]},r=[];for(let s=0;s<2;s++){const e=s*Math.PI-Math.PI/4,h=Math.PI/2-sn,a=e+h,o=e+Math.PI/2-h,l=t(a,o,190),c=i(l,9);r.push(l),r.push(t(a,o,201)),n.left.push(c),n.right.push(c);for(let t=0;t<2;t++){const s=0===t,i=vs();if(s){fs(i,i,[1,-1,1]),ds(i,i,-a,[0,0,1]);const t=Math.round(.2*(l.length-1));i[12]=l[t][0],i[13]=l[t][1],i[14]=l[t][2]}else{ds(i,i,o,[0,0,1]);const t=Math.round(.8*(l.length-1));i[12]=l[t][0],i[13]=l[t][1],i[14]=l[t][2]}const e=Pt.createExtrudedTriangle(60,0,23,.5);Pt.transformInPlace(e,i),(s?n.left:n.right).push(e)}}const a=[];for(let s=0;s<2;s++){const e=s*Math.PI-Math.PI/4,h=Math.PI/2-en,n=e+Math.PI/2-h,r=t(e+h,n,213);a.push(i(r,9))}const o=s(190),l=s(213),c=i(o,9),u=i(l,9),d=s(130),p=s(107),g=i(d,9),f=i(p,9),m=this.createMaterial(),v=this.createMaterial(.66),w=this.createMaterial(.5),y=this.createMaterial(.33);let b=[{geometry:h,material:m,stateMask:Nn.DelayedFocused},{geometry:h,material:w,stateMask:0}];this.mode&&"scale"!==this.mode||(b=b.concat([{geometry:a,material:m,stateMask:Nn.DelayedFocused|Nn.Unlocked},{geometry:c,material:v,stateMask:Nn.DelayedFocused|Nn.ScaleIn},{geometry:u,material:y,stateMask:Nn.DelayedFocused|Nn.ScaleIn},{geometry:g,material:v,stateMask:Nn.DelayedFocused|Nn.ScaleOut},{geometry:f,material:y,stateMask:Nn.DelayedFocused|Nn.ScaleOut}])),this.mode&&"rotate"!==this.mode||(b=b.concat([{geometry:n.right,material:m,stateMask:Nn.DelayedFocused|Nn.Unlocked},{geometry:n.left,material:m,stateMask:Nn.DelayedFocused|Nn.RotateLeft},{geometry:n.right,material:m,stateMask:Nn.DelayedFocused|Nn.RotateRight}]));const M=[e,...r];return new xi({view:this.tool.view,renderObjects:b,autoScaleRenderObjects:!1,worldOriented:!0,radius:24,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:E(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:M,direction:gt(0,0,1)}})}createMaterial(t=1){const s=[...Jh,t];return new It({color:s,transparent:1!==t,cullFace:2,renderOccluded:2})}get test(){return{ringManipulator:this.ringManipulator}}}function Un(t,s,i){return s.projectToScreen(t,Qn),L(i,Qn[0],Qn[1],0)}function Bn(t,s){let i=null,e=1;const h=()=>e;return{start:()=>{e=t.getScale(),i=t.getScale,t.getScale=h,s()},update:t=>(e+=((e+1)/2-e)*Math.min(3*t,1),s(),Math.abs(e-1)<.01?1:0),destroy:()=>{t.getScale=i,s()}}}const Qn=Ws();function Zn(t){return s(t.geometry)&&"mesh"===t.geometry.type?function(t){return s(t.transform)?function(t,i){let e=i.clone(),h=null;return{undo:i=>{h=s(t.transform)?t.transform.clone():null,t.transform=e,i.notifyGeometryChanged()},redo:i=>{e=s(t.transform)?t.transform.clone():null,t.transform=h,i.notifyGeometryChanged()}}}(t,t.transform):function(t){let s,i=t.vertexAttributes.clonePositional();return{undo:e=>{s=t.vertexAttributes.clonePositional(),t.vertexAttributes=i,e.notifyGeometryChanged()},redo:e=>{i=t.vertexAttributes.clonePositional(),t.vertexAttributes=s,e.notifyGeometryChanged()}}}(t)}(t.geometry):function(t){let s=t.geometry,i=x;return{undo(t){i=t.geometry,t.geometry=s},redo(t){s=t.geometry,t.geometry=i}}}(t)}let qn=class extends he{constructor(t){super(t),this.angle=0,this.scale=1,this.initialAngle=0,this.previousAngle=0,this.previousScale=1}initialize(){this.restart()}restart(){this.handles.remove(Xn);const t=this.geometry.transform;if(this.scale=1,s(t)){const s=ye(t.rotation)[2];Math.abs(s)>.999999&&(this.angle=F(we(t.rotation))*Math.sign(s))}this.initialAngle=this.angle,this.previousAngle=this.angle,this.previousScale=this.scale,this.handles.add(me((()=>({angle:this.angle,scale:this.scale})),(t=>this.update(t)),ve),Xn)}cancel(){this.scale=1,this.angle=this.initialAngle}createUndoRecord(){return Zn(this.graphic)}update({scale:t,angle:s}){const i=this.geometry.anchor,e=1===this.viewingMode;t!==this.previousScale&&(this.geometry.scale(t/this.previousScale,{origin:i,geographic:e}),this.previousScale=t,this.graphic.notifyGeometryChanged()),s!==this.previousAngle&&(this.geometry.rotate(0,0,ot(s-this.previousAngle),{origin:i,geographic:e}),this.previousAngle=s,this.graphic.notifyGeometryChanged())}};t([u({constructOnly:!0})],qn.prototype,"graphic",void 0),t([u({constructOnly:!0})],qn.prototype,"geometry",void 0),t([u({constructOnly:!0})],qn.prototype,"viewingMode",void 0),t([u()],qn.prototype,"angle",void 0),t([u()],qn.prototype,"scale",void 0),qn=t([d("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],qn);const Xn="scale-heading-update-key";let Kn=class extends he{constructor(t){super(t),this.angle=0,this.scale=1,this.symbol=null,this.initialAngle=0}initialize(){this.restart()}restart(){this.handles.remove(Yn);const t=s(this.graphic.symbol)&&"point-3d"===this.graphic.symbol.type?this.graphic.symbol:x;if(this.symbol=s(t)?t.clone():null,this.initialSizes=[],s(t)){const i=this.findLayerView();s(i)&&(this.initialSizes=t.symbolLayers.map((s=>"object"===s.type?i.getSymbolLayerSize(t,s):null)).toArray())}this.angle=0,s(t)&&t.symbolLayers.some((t=>!("object"!==t.type||!s(t.heading)||(this.angle=-F(t.heading),0)))),this.initialAngle=this.angle,this.scale=1,this.handles.add(me((()=>({angle:this.angle,scale:this.scale})),(t=>this.updateSymbol(t)),ve),Yn)}cancel(){this.graphic.symbol=this.symbol}createUndoRecord(){let t=this.graphic.symbol,s=null;return{undo:i=>{s=i.symbol,i.symbol=t,this.restart()},redo:i=>{t=i.symbol,i.symbol=s,this.restart()}}}updateSymbol({scale:t,angle:e}){const h=this.graphic.symbol;if(i(this.symbol)||i(h)||"point-3d"!==h.type)return;const n=h.clone(),r=-ot(e-this.initialAngle);let o=!1;this.forEachObjectSymbolLayerPair(this.symbol,n,((i,e,h)=>{const n=a(i.heading,0)+r;e.heading!==n&&(e.heading=n,o=!0);const l=this.initialSizes[h];if(s(l)&&"width"in l){l.width=this.sizeFilter(l.width),l.height=this.sizeFilter(l.height),l.depth=this.sizeFilter(l.depth);const s=l.width*t;e.width!==s&&(e.width=s,o=!0);const i=l.depth*t;e.depth!==i&&(e.depth=i,o=!0);const h=l.height*t;e.height!==h&&(e.height=h,o=!0)}})),o&&(this.graphic.symbol=n)}forEachObjectSymbolLayerPair(t,s,i){t.symbolLayers.forEach(((t,e)=>{const h=s.symbolLayers.getItemAt(e);"object"===t.type&&"object"===h.type&&i(t,h,e)}))}};t([u()],Kn.prototype,"angle",void 0),t([u()],Kn.prototype,"scale",void 0),t([u({constructOnly:!0})],Kn.prototype,"graphic",void 0),t([u()],Kn.prototype,"symbol",void 0),t([u({constructOnly:!0})],Kn.prototype,"findLayerView",void 0),t([u({constructOnly:!0})],Kn.prototype,"sizeFilter",void 0),Kn=t([d("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],Kn);const Yn="scale-heading-update-key";let Jn=class extends(ee(p.EventedMixin($i))){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.type="transform-3d",this.scaleRotate=null,this.snappingPipeline=new te}initialize(){this.graphicState=new C({graphic:this.graphic}),this.moveManipulation=new Dn({tool:this,view:this.view,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&Nh(this.graphic),radius:Dn.radiusForSymbol(this.graphic.symbol)}),this.moveManipulation.forEachManipulator((t=>this.handles.add(t.events.on("immediate-click",(t=>{this.emit("immediate-click",{...t,graphic:this.graphicState.graphic}),t.stopPropagation()}))))),this.moveManipulation.elevationInfo=E(this.graphic);const t=this.graphic.geometry;this.moveManipulation.createGraphicDragPipeline(((i,e,h,n,r)=>(s(t)&&0===i&&(h=h.next(this.snappingPipeline.createSnapDragEventPipelineStep({snappingContext:new gi({elevationInfo:E(this.graphic),pointer:r,editGeometryOperations:ae.fromGeometry(new D({spatialReference:t.spatialReference}),this.view.state.viewingMode),visualizer:new gh,excludeFeature:this.graphic}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,cancel:n}),this.snappingPipeline.next)),h)),this.graphicState,(t=>{const{action:s,graphic:i,dxScreen:e,dyScreen:h}=t,n={graphic:i,dxScreen:e,dyScreen:h};switch(s){case"start":this.emit("graphic-translate-start",n),this.emit("record-undo",{record:this.createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",n);break;case"end":this.emit("graphic-translate-stop",n)}})),this.moveManipulation.angle=s(this.scaleRotate)?this.scaleRotate.angle:0,this.scaleRotateAdapter=this.createScaleRotateAdapter(),this.handles.add(this.scaleRotateAdapter.watch("angle",(()=>this.updateMoveAngle()))),(this.enableScaling||this.enableRotation)&&(this.scaleRotate=new Hn({tool:this,mode:this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate",adapter:this.scaleRotateAdapter}),this.handles.add(this.scaleRotate.events.on("scale-changed",(()=>this.onScaleChanged())))),this.handles.add([Yh({view:this.view,graphic:this.graphic,forEachManipulator:t=>this.forEachManipulator(t),onManipulatorsChanged:()=>f()}),this.graphicState.on("changed",(()=>this.onGeometryChanged())),this.hideManipulatorsForGraphicState(),this.view.watch("scale",(()=>this.updateMoveAngle()))]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this.onGeometryChanged(),this.updateMoveAngle(),this.forEachManipulator((t=>{t instanceof xi&&this.handles.add(t.events.on("grab-changed",(()=>this.updateManipulatorsInteractive())))})),this.complete()}updateManipulatorsInteractive(){i(this.scaleRotate)||(this.scaleRotate.interactive=!this.moveManipulation.grabbing,this.moveManipulation.interactive=!this.scaleRotate.grabbing)}createScaleRotateAdapter(){return s(this.graphic.geometry)&&"mesh"===this.graphic.geometry.type?new qn({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new Kn({graphic:this.graphic,sizeFilter:t=>this.enforceNonZeroSize(t),findLayerView:()=>this.view.allLayerViews.find((t=>t.layer===this.graphic.layer))})}forEachManipulator(t){this.moveManipulation.forEachManipulator(t),s(this.scaleRotate)&&this.scaleRotate.forEachManipulator(t)}hideManipulatorsForGraphicState(){return this.graphicState.watch("displaying",(t=>{this.forEachManipulator((s=>s.available=t)),this.moveManipulation.zManipulation.available=t&&this.enableZ&&Nh(this.graphic)}))}createGeometryUndoRecord(){return Zn(this.graphic)}destroy(){this.moveManipulation.destroy(),this.scaleRotate=m(this.scaleRotate),this.scaleRotateAdapter=m(this.scaleRotateAdapter),this._set("view",null),this._set("graphic",null)}set snapToScene(t){this.moveManipulation&&(this.moveManipulation.snapToScene=t),this._set("snapToScene",t)}get updating(){return this.updatingHandles.updating}set location(t){this.moveManipulation.location=t,s(this.scaleRotate)&&(this.scaleRotate.location=t)}set elevationAlignedLocation(t){this.moveManipulation.elevationAlignedLocation=t,s(this.scaleRotate)&&(this.scaleRotate.elevationAlignedLocation=t)}reset(){}onDetach(){s(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}onHide(){s(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}onScaleChanged(){if(i(this.scaleRotate))return;const t=this.scaleRotate.getScale();this.moveManipulation.displayScale=t}updateMoveAngle(){this.moveManipulation.angle=2===this.view.state.viewingMode||this.view.scale<1e6?this.scaleRotateAdapter.angle:0}onGeometryChanged(){Ai(this.view,this,this.graphic)}enforceNonZeroSize(t){return t||this.view.state.camera.computeRenderPixelSizeAt(this.moveManipulation.renderLocation)}get test(){return{discManipulator:this.moveManipulation.xyManipulation.test.discManipulator,zManipulator:this.moveManipulation.zManipulation.test.manipulator,ringManipulator:s(this.scaleRotate)?this.scaleRotate.test.ringManipulator:null,arrowManipulators:this.moveManipulation.xyAxisManipulation.test.arrowManipulators}}};t([u({constructOnly:!0,nonNullable:!0})],Jn.prototype,"view",void 0),t([u({constructOnly:!0,nonNullable:!0})],Jn.prototype,"graphic",void 0),t([u({constructOnly:!0,nonNullable:!0})],Jn.prototype,"enableZ",void 0),t([u()],Jn.prototype,"enableRotation",void 0),t([u()],Jn.prototype,"enableScaling",void 0),t([u({value:!1})],Jn.prototype,"snapToScene",null),t([u({constructOnly:!0})],Jn.prototype,"snappingManager",void 0),t([u({readOnly:!0})],Jn.prototype,"type",void 0),t([u({readOnly:!0})],Jn.prototype,"updating",null),Jn=t([d("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],Jn);const $n="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAACuFBMVEUAAAD/AAD/gAD/VQD/gAD/bQD/gAD/cQD/gAD/dAD/eAD/gAD/gAD/egD/gAD/ewD/gAD/fAD/gAD/fQD/gAD/fQD/fQD/egD/fQD/gAD/fQD/ewD/fQD/gAD/gAD/fQD/gAD/fAD/fgD/fgD/fAD/fgD/fAD/fgD/fAD/fgD/gAD/fAD/fgD/fAD/fQD/fgD/fgD/fQD/fgD/fgD/fQD/fgD/fQD/fQD/fgD/fgD/fQD/fQD/fgD/fQD/fgD/fQD/fgD/fQD/fgD/fgD/gAL/fgD/gAb/gAT/gwr/gQj/hA7/hAz/hxH/iBP/ixn/iRf/jBz/jR7/jyP/kCX/kyr/lS7/lCz/li//mTT/mTf/nDr/mjn/nTz/n0H/nT//oET/oEL/okf/oEX/o0r/pU3/o0v/pU//qFL/plH/qFX/qFP/qVb/q1n/rV3/rFz/rmD/rl7/sGL/rmH/tW3/s2v/tW//tW7/t3L/tnD/uHT/unb/unn/unf/vHv/vX3/v4D/vX7/w4n/xY3/xIv/x4//xY3/x5H/yZP/x5H/yJP/y5f/yZX/zZv/y5n/zZ3/zJv/z5//z6D/z6H/0aT/0KP/0qb/06j/1av/06r/1q3/1q//17H/2rb/2rb/2rj/3bz/4MH/38D/38H/4sX/4MT/48f/4sb/4sf/5Mr/5s3/5cz/5s3/59D/59D/6dT/6dP/6dT/6tb/6tX/6tf/69n/69j/7dr/7Nn/7dz/7dv/7t3/7t7/7t3/7+H/8eL/8uX/8eP/8+j/8+f/9On/8+j/9Or/9ez/9e3/9ez/9e3/9+//9+7/+PD/9+//+PH/+PD/+fL/+PH/+fT/+vX/+fT/+vb/+vX/+/b/+vb/+/j/+/j//Pr//Pn//fv//v3//vz//fz//fv//v3//fz//////v7//v3///9vf1WOAAAA53RSTlMAAQIDBgcICQoLERIYGRobKCkqKywtLzAxMjM4OTo+P0BAQUVGR0hPUFFSUlNUWlthYmNlZmdoamtvcHR1dnd4eXx9f4CAgYGCgoODhIWGhoeIiYqLjIyNjo+QkJGSkpOTlJSVlpaXmJiZmZqbnJydnZ6eoqKjo6Skpaanp6ipqqqvsLCxsbKzs7S1tbe3uLi5uru8vL2+wMDBwsTGx8jLzc3O0NDR0dLT1dXW19ja2tvc3N3e3t/f4ODh4uLl5ufn6urr6+zt7u7v8PDx8fLy8/P09fX29vf3+Pn6+vv8/Pz8/f3+/v7EBDCzAAADmklEQVR42qXXd3sUVRQG8BNDKkU3KLYUIFkLLBo0yRJNBszuuwQlGISIDUTFhljAhhUbtlXEYEcjoEJUNCqKPXZUUCDU0FvI+RpkZpa5c9iZzMzD7+/d88yde+95z5CbvIIhIyqrtbo6rboyUlKQR4GcGI7GIMSi4QHkU1bRKDgaVZRF3nKGanClDc4hD4Nq0CvtzAzqRd8L4GlkX3IVGg0fxpxMzjLOgk9hx2VkRuBbJNPh/+cjpQnezkuvcC6Q8vVseItkkKTWP6Pr17HwVkbCQFg+YJ4P3U0vtrS1t//c9u6zM+DgFLH/av+m7Gfe1IhpLf+ysmbxVBxrdD4ptvPzDvdY2trNUvfytBLlZDkdloZt3GPvPk5z8K0EpFMpJacWlmTqmdnBd1dBqMkm01BY4n+waTsb1nd0drHl/2kQSsiQpcHyKKd0MP/YfOt4AJfPWtTOKRumw04z+0MRlNV81PezoNz5JZv+boRdIemisMxkS+ck2M3rZMPHskcZ/Q/KR6y8D2HqWjbMh11/IgrDfoiU7lsgXGNW6GgQB1quYPrClk9+WnuITash3WGWfw02VUR5MUCKX3n7w8m3P1z121xIzazbMg5KLJcK4Ntl5vV4EDYhGgz/XmDdcnmWRsC/iQeM1wibYVSBAL5g3WQoF9JFCOBN1t0PpZo0BDCPdU9BqaU6BPAA65JQLglWYDbrFooCGgJ4jHXPiSUEeokvse4hKNXBtnEF624W2xiBf/GN3GP3pVCG0xAIE57+9h64uZd1bbApFpcpMXfFLuaVcLOKdS/DJiSu87UHucfhOb0+wIEmeZ0pCqWVdX+Nh5MJ61i3BDaVsqVhphkCnyaQrt68SYdvhE0pEQ2AzRI2LBuX3k1a2fAe7PoRyTU0/seGb66ANPkHNqxpEG1dBIvhvkNs2PLMWCiJ5FY27LlbBouMNsOTXWz6p/lqmK57fR2buh+HjDYVrsqCLhWmK5cuXvbZBhUVzzuGK+XUwO6J3exs5yMQLs6mlNMg3PY7O/nlBkiDyDISQv2CHXysrckEpHI5ZEmTXpUzyp+vTOx1yHLIp/icN74y927z54vuiiNNiISwc5hNub6pHoo8xNI5CCSS4T5sw/ewLZ1wNnwbnklOyuBPrJRcnKTBhzEDyVV+OTyV5x/fZ98Z5CG7RIOr2pJs8tanMApH0cI+5FP/sqoYhFhVaT8KJDdUHKkwP/8rhhWHct1+dwRTps/cplDIpwAAAABJRU5ErkJggg==",tr={mipmap:!0,preMultiplyAlpha:!0,width:64,height:64};class sr{constructor(){this.lastDragEvent=null,this.next=new Bi,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&s(this.lastDragEvent)){const s={...this.lastDragEvent,action:"update"};t&&this.adjustScaleFactors(s),this.next.execute(s)}this._enabled=t}createDragEventPipelineStep(){return this.lastDragEvent=null,t=>(this.lastDragEvent="end"!==t.action?{...t}:null,this._enabled&&this.adjustScaleFactors(t),t)}adjustScaleFactors(t){const s=Ci(t.handle)?Math.max(Math.abs(t.factor1),Math.abs(t.factor2)):0===t.handle.direction[0]?Math.abs(t.factor2):Math.abs(t.factor1);t.factor1=t.factor1<0?-s:s,t.factor2=t.factor2<0?-s:s}get test(){return{adjustScaleFactors:t=>this.adjustScaleFactors(t)}}}function ir(t,s){return hr(t,s,!1)}function er(t,s){return hr(t,s,!0)}function hr(t,s,i){if(t instanceof le){if(t.operation instanceof ce)return function(t,s,i=!1){const e=i?-1:1,h=gt(e*t.dx,e*t.dy,e*t.dz);Q(s.origin,s.origin,h)}(t.operation,s,i),!0;if(t.operation instanceof ue)return function(t,s,i=!1){const e=i?-t.angle:t.angle;ct(s.basis1,s.basis1,ft,e),ct(s.basis2,s.basis2,ft,e)}(t.operation,s,i),!0;if(t.operation instanceof de)return function(t,s,i=!1){const e=i?1/t.factor1:t.factor1,h=i?1/t.factor2:t.factor2;st(s.basis1,s.basis1,e),st(s.basis2,s.basis2,h),Ks(s.origin,s.origin,t.origin,t.axis1,e),Ks(s.origin,s.origin,t.origin,t.axis2,h)}(t.operation,s,i),!0}return!1}let nr=class extends(p.EventedMixin($i)){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this._preserveAspectRatio=new sr,this.grabbing=!1,this.inputState=null,this.type="transform-3d",this.handles=new n,this.moveZManipulator=null,this.resizeManipulators=null,this.rotateManipulator=null,this.attachmentOrigin=null,this.outlineVisualElement=null,this.mapBounds=xe(),this.mapBoundsStart=xe(),this.displayBounds=xe(),this.displayBoundsStart=xe(),this.displayBoundsMarginStart=0,this.resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}]}initialize(){this.graphicState=new C({graphic:this.graphic}),this.editGeometryOperations=ae.fromGeometry(this.graphic.geometry,this.view.state.viewingMode),this.graphicMoveManipulation=new Pn({tool:this,view:this.view,graphicState:this.graphicState}),this.handles.add(this.createMoveXYGraphicDragPipeline()),this.moveZManipulator=zi(this.view,0),this.moveZManipulator.state|=Ei,this.handles.add(this.watch("enableZ",(()=>this.updateManipulatorAvailability(this.moveZManipulator,0)))),this.handles.add(this.createMoveZDragPipeline()),this.manipulators.add(this.moveZManipulator),this.resizeManipulators=this.resizeHandles.map((t=>{const s=ki(this.view,t);return this.handles.add(this.watch("enableScaling",(()=>this.updateManipulatorAvailability(s,2)))),s.events.on("grab-changed",(t=>this.onResizeGrab(t))),this.handles.add(this.createResizeDragPipeline(s,t)),s})),this.manipulators.addMany(this.resizeManipulators),this.rotateManipulatorTexture=function(t){return t.fromData($n,(()=>new Rs($n,tr)))}(this.view.toolViewManager.textures),this.rotateManipulator=Ri(this.view,this.rotateManipulatorTexture.texture),this.handles.add(this.watch("enableRotation",(()=>this.updateManipulatorAvailability(this.rotateManipulator,3)))),this.rotateManipulator.events.on("grab-changed",(t=>{this.onRotateGrab(t)})),this.handles.add(this.createRotateDragPipeline(this.rotateManipulator)),this.manipulators.add(this.rotateManipulator),this.calculateMapBounds(),this.updateDisplayBounds();const t=Yh({view:this.view,graphic:this.graphic,forEachManipulator:t=>this.forEachManipulator(t),onManipulatorsChanged:()=>f()});s(t)&&(this.outlineVisualElement=t.visualElement instanceof Th?t.visualElement:null),s(this.outlineVisualElement)&&this.handles.add(this.outlineVisualElement.events.on("attachment-origin-changed",(()=>this.updateDisplayBounds()))),this.handles.add(t),this.handles.add([this.graphicState.on("changed",(()=>this.onGeometryChanged())),this.graphicState.watch("displaying",(()=>this.updateAllManipulatorAvailability())),o(this.graphicState,"isDraped",(()=>this.graphicDrapedChanged())),this.view.trackGraphicState(this.graphicState)]);const i=this.view.pointsOfInterest;i&&this.handles.add(i.centerOnSurfaceFrequent.watch("location",(()=>this.updateDisplayBounds()))),this.forEachManipulator((t=>{this.handles.add(t.events.on("grab-changed",(()=>{this.grabbing=t.grabbing,this.updateAllManipulatorAvailability()})))})),this.forEachManipulator(((t,s)=>{this.handles.add(t.events.on("immediate-click",(t=>{1===s&&this.emit("immediate-click",{...t,graphic:this.graphic}),t.stopPropagation()})))})),this.onGeometryChanged(),this.updateAllManipulatorAvailability(),this.complete()}graphicDrapedChanged(){this.handles.remove(rr),this.updateDisplayBounds(),this.graphicState.isDraped&&this.handles.add(this.view.elevationProvider.on("elevation-change",(t=>{s(this.attachmentOrigin)&&ne(t.extent,this.attachmentOrigin.x,this.attachmentOrigin.y)&&this.updateDisplayBounds()})),rr)}updateAllManipulatorAvailability(){this.forEachManipulator(((t,s)=>this.updateManipulatorAvailability(t,s)))}updateManipulatorAvailability(t,s){const i=this.grabbing&&!t.grabbing;if(t.interactive=!i,t instanceof xi){const e=this.graphicState.displaying,h=this.enableZ&&Nh(this.graphic);switch(s){case 3:t.available=e&&this.enableRotation;break;case 2:t.available=e&&(this.enableScaling||this.enableRotation||h),t.interactive=!i&&this.enableScaling,t.state=this.enableScaling?ji:Ti;break;case 0:t.available=e&&h;break;default:t.available=e}}}forEachManipulator(t){this.graphicMoveManipulation.forEachManipulator(t),this.resizeManipulators.forEach((s=>t(s,2))),t(this.rotateManipulator,3),t(this.moveZManipulator,0)}destroy(){this.rotateManipulatorTexture.release(),this.handles.destroy(),this.graphicMoveManipulation.destroy(),this.editGeometryOperations.destroy(),this._set("view",null),this._set("graphic",null)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(t){this._preserveAspectRatio.enabled=t,this._set("preserveAspectRatio",t)}reset(){}onDetach(){this.mapBounds=null,this.displayBounds=null}onGeometryChanged(){this.updateDisplayBounds()}calculateMapBounds(){const t=this.graphic.geometry,s=this.editGeometryOperations.data,i=s.components[0].edges[0],e=Qs(li.get(),i.leftVertex.pos,i.rightVertex.pos);Bs(e,e);const h=a(Si(this.view,this.graphic),t.extent.center);let n=or*this.view.pixelSizeAt(h);const r=this.view.spatialReference;r!==t.spatialReference&&(n*=be(r)/be(t.spatialReference)),function(t,s,i,e){e||(e=xe());const h=qs(li.get(),t[1],-t[0]),n=qs(li.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),r=qs(li.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),a=li.get();s.components.forEach((s=>s.vertices.forEach((s=>{const i=s.pos;qs(a,Ys(t,i),Ys(h,i)),Js(n,n,a),$s(r,r,a)}))));const o=1e-6,l=qs(li.get(),r[0]-n[0]<o?i/2:0,r[1]-n[1]<o?i/2:0);Qs(n,n,l),Xs(r,r,l),Zs(e.basis1,t,(r[0]-n[0])/2),Zs(e.basis2,h,(r[1]-n[1])/2),qs(e.origin,n[0]*t[0]+n[1]*h[0],n[0]*t[1]+n[1]*h[1]),Xs(e.origin,e.origin,e.basis1),Xs(e.origin,e.origin,e.basis2)}(e,s,n,this.mapBounds)}updateDisplayBounds(){const t=this.graphic.geometry;if(i(t))return;const e=s(this.outlineVisualElement)&&!this.graphicState.isDraped&&s(this.outlineVisualElement.attachmentOrigin)?this.outlineVisualElement.attachmentOrigin:Si(this.view,this.graphic);this.attachmentOrigin=a(e,t.extent.center);const h=s(e)?e.z:zt(this.mapBounds.origin,this.view.elevationProvider,Et.fromElevationInfo(E(this.graphic)),this.view.renderCoordsHelper),n=De(this.mapBounds);n.origin[2]=h,function(t,s,i,e=0,h){h||(h=xe()),s.toRenderCoords(t.origin,i,h.origin);const n=oi.get();Q(n,t.origin,t.basis1),Q(n,n,t.basis2),s.toRenderCoords(n,i,n);const r=oi.get();Q(r,t.origin,t.basis1),_(r,r,t.basis2),s.toRenderCoords(r,i,r);const a=oi.get();_(a,t.origin,t.basis1),_(a,a,t.basis2),s.toRenderCoords(a,i,a);const o=oi.get();_(o,t.origin,t.basis1),Q(o,o,t.basis2),s.toRenderCoords(o,i,o);const l=tt(oi.get(),n,r,.5);_(l,l,h.origin);const c=tt(oi.get(),a,o,.5);_(c,h.origin,c),tt(h.basis1,l,c,.5);const u=tt(oi.get(),o,n,.5);_(u,u,h.origin);const d=tt(oi.get(),r,a,.5);_(d,h.origin,d),tt(h.basis2,u,d,.5);const p=B(oi.get(),h.basis1,h.basis2),g=B(p,p,h.basis1);U(g,g),st(h.basis2,g,ht(h.basis2,g)),st(h.basis1,h.basis1,1+e/et(h.basis1)),st(h.basis2,h.basis2,1+e/et(h.basis2)),Me(h)}(n,this.view.renderCoordsHelper,t.spatialReference,this.displayBoundsMargin,this.displayBounds),this.updateManipulators()}get displayBoundsMargin(){const t=this.view.pointsOfInterest;return ar*this.view.pixelSizeAt(t?t.centerOnSurfaceFrequent.location:this.editGeometryOperations.data.geometry.extent.center)}createMoveXYGraphicDragPipeline(){return this.graphicMoveManipulation.createDragPipeline(((t,s,i)=>this.applyGraphicMoveSteps(s,i)))}createMoveZDragPipeline(){const t=this.view,s=this.editGeometryOperations.data.spatialReference;return qi(this.moveZManipulator,((i,e,h)=>{const n=pt(i.renderLocation),r=e.next(ln(t,n,s)).next(Yi());this.applyGraphicMoveSteps(r,h)}))}applyGraphicMoveSteps(t,i){const e=t.next((t=>("start"===t.action&&(this.inputState={type:"move"},De(this.mapBounds,this.mapBoundsStart),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:t.screenDeltaX,dyScreen:t.screenDeltaY})),t))).next(Ji()).next(this.moveDragUpdateGeometry()).next((t=>{const s={graphic:this.graphic,dxScreen:t.screenDeltaX,dyScreen:t.screenDeltaY};switch(t.action){case"start":case"update":(t.mapEnd.x-t.mapStart.x||t.mapEnd.y-t.mapStart.y||t.mapEnd.z-t.mapStart.z)&&this.emit("graphic-translate",s);break;case"end":this.inputState=null,this.emit("graphic-translate-stop",s)}return t}));return i.next((()=>{s(this.inputState)&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0}),this.cancel()})),e}moveDragUpdateGeometry(){return t=>{if(i(this.inputState)||"move"!==this.inputState.type)return t;const s=[];for(const t of this.editGeometryOperations.data.components)s.push(...t.vertices);return ir(this.editGeometryOperations.moveVertices(s,t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,"start"===t.action?0:1),this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}onResizeGrab(t){if("start"!==t.action)return;const s=this.calculatePickRay(t.screenPoint);es(this.displayBounds.plane,s,oi.get())&&(De(this.displayBounds,this.displayBoundsStart),De(this.mapBounds,this.mapBoundsStart),this.displayBoundsMarginStart=this.displayBoundsMargin,this.inputState={type:"resize"})}createResizeDragPipeline(t,e){return qi(t,((t,h,n)=>{i(this.inputState)||(h.next((t=>("start"===t.action&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1}),t))).next(nn(this.view,this.displayBoundsStart.plane)).next((t=>({...t,handle:e}))).next(this.resizeDragRenderPlaneToFactors()).next(this._preserveAspectRatio.createDragEventPipelineStep(),this._preserveAspectRatio.next).next(this.resizeDragUpdateGeometry()).next((t=>{const s={graphic:this.graphic,xScale:t.factor1,yScale:t.factor2};switch(t.action){case"start":case"update":this.emit("graphic-scale",s);break;case"end":this.inputState=null,this.emit("graphic-scale-stop",s)}return t})),n.next((()=>{s(this.inputState)&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1}),this.cancel()})))}))}resizeDragRenderPlaneToFactors(){return t=>{const s=this.displayBoundsStart,i=t.handle.direction,e=this.displayBoundsMargin,h=this.displayBoundsMarginStart,n=W(oi.get(),s.origin);ut(n,n,s.basis1,-i[0]),ut(n,n,s.basis2,-i[1]);const r=_(oi.get(),t.renderEnd,n),a=_(oi.get(),t.renderStart,n),o=Ci(t.handle),l=_i(s),c=_i(this.displayBounds)/l,u=(t,s)=>{if(0===t)return 1;let i=et(s),n=.5*t*ht(s,r)/i;const l=n<0?-1:1;o&&(n+=(i-.5*t*ht(s,a)/i)*l*c);const u=i<1.5*h?1:lr;return i=Math.max(i-h,lr),l>0&&(n-=e),l*Math.max(l*(n/i),u)};return{...t,factor1:u(i[0],s.basis1),factor2:u(i[1],s.basis2)}}}resizeDragUpdateGeometry(){return t=>{const s=W(dt(),this.mapBoundsStart.origin);ut(s,s,this.mapBoundsStart.basis1,-t.handle.direction[0]),ut(s,s,this.mapBoundsStart.basis2,-t.handle.direction[1]);const i=qs(Yt(),this.mapBoundsStart.basis1[0],this.mapBoundsStart.basis1[1]);Bs(i,i);const e=[];for(const t of this.editGeometryOperations.data.components)e.push(...t.vertices);const h=this.editGeometryOperations.scaleVertices(e,s,i,t.factor1,t.factor2,"start"===t.action?0:1,1);return De(this.mapBoundsStart,this.mapBounds),ir(h,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}onRotateGrab(t){if("start"!==t.action)return;const s=Vi(this.displayBounds,this.view.renderCoordsHelper,1,ss()),i=this.calculatePickRay(t.screenPoint);es(s,i,oi.get())&&(De(this.displayBounds,this.displayBoundsStart),De(this.mapBounds,this.mapBoundsStart),this.inputState={type:"rotate",rotatePlane:s})}createRotateDragPipeline(t){return qi(t,((t,e,h)=>{const n=this.inputState;i(n)||(e.next((t=>("start"===t.action&&this.emit("graphic-rotate-start",{graphic:this.graphic,angle:0}),t))).next(nn(this.view,n.rotatePlane)).next(this.rotateDragRenderPlaneToRotate(n)).next(this.rotateDragUpdateGeometry()).next((t=>{const s={graphic:this.graphic,angle:ot(t.rotateAngle)};switch(t.action){case"start":case"update":this.emit("graphic-rotate",s);break;case"end":this.inputState=null,this.emit("graphic-rotate-stop",s)}return t})),h.next((()=>{s(this.inputState)&&this.emit("graphic-rotate-stop",{graphic:this.graphic,angle:0}),this.cancel()})))}))}rotateDragRenderPlaneToRotate(t){return s=>{const i=hs(t.rotatePlane),e=Oi(s.renderStart,s.renderEnd,this.displayBounds.origin,i);return{...s,rotateAxis:i,rotateAngle:e}}}rotateDragUpdateGeometry(){return t=>{const s=W(dt(),this.mapBoundsStart.origin),i=[];for(const t of this.editGeometryOperations.data.components)i.push(...t.vertices);const e=this.editGeometryOperations.rotateVertices(i,s,t.rotateAngle,"start"===t.action?0:1,1);return De(this.mapBoundsStart,this.mapBounds),ir(e,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}calculatePickRay(t){const s=Bt(),i=Ns(t);return Ts(this.view.state.camera,i,s),U(s.direction,s.direction),s}updateManipulators(){if(!this.visible)return;const t=Gi(this.displayBounds,ci.get());Ii(this.rotateManipulator,t,this.displayBounds,this.view.renderCoordsHelper),this.updateZMoveHandle(this.moveZManipulator,t),this.resizeManipulators.forEach(((s,i)=>{Li(s,this.resizeHandles[i],t,this.displayBounds)}))}updateZMoveHandle(t,s){const i=this.displayBounds,e={basis:i.basis1,direction:-1,position:_(oi.get(),i.origin,i.basis1),edge:2},h=ci.get();ms(h,s,e.edge*Math.PI/2),h[12]=0,h[13]=0,h[14]=0,t.modelTransform=h,t.renderLocation=e.position}cancel(){const t=this.editGeometryOperations.lastOperation;i(t)||(this.editGeometryOperations.undo(),this.graphic.geometry=this.editGeometryOperations.data.geometry,er(t,this.mapBounds),this.updateDisplayBounds(),this.inputState=null)}get canUndo(){return this.editGeometryOperations.canUndo}undo(){if(s(this.inputState))this.view.activeTool=null;else if(this.canUndo){const t=this.editGeometryOperations.undo();this.graphic.geometry=this.editGeometryOperations.data.geometry,er(r(t),this.mapBounds),this.updateDisplayBounds()}}get canRedo(){return this.editGeometryOperations.canRedo}redo(){if(this.canRedo){const t=this.editGeometryOperations.redo();this.graphic.geometry=this.editGeometryOperations.data.geometry,ir(r(t),this.mapBounds),this.updateDisplayBounds()}}get test(){return{resizeManipulators:this.resizeManipulators,rotateManipulator:this.rotateManipulator,moveZManipulator:this.moveZManipulator}}};t([u({constructOnly:!0,nonNullable:!0})],nr.prototype,"view",void 0),t([u({constructOnly:!0,nonNullable:!0})],nr.prototype,"graphic",void 0),t([u({constructOnly:!0,nonNullable:!0})],nr.prototype,"enableZ",void 0),t([u()],nr.prototype,"enableRotation",void 0),t([u()],nr.prototype,"enableScaling",void 0),t([u()],nr.prototype,"preserveAspectRatio",null),t([u()],nr.prototype,"grabbing",void 0),t([u()],nr.prototype,"inputState",void 0),t([u({readOnly:!0})],nr.prototype,"type",void 0),nr=t([d("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],nr);const rr="draped-elevation-changes",ar=10,or=80,lr=1e-6,cr=Object.freeze({__proto__:null,get DrawGraphicTool3D(){return Wh},get GraphicMoveTool(){return zn},get GraphicReshapeTool(){return Wn},get GraphicTransformTool(){return Jn},get ExtentTransformTool(){return nr}});export{Pe as a,cr as e,Te as l,Ve as o}