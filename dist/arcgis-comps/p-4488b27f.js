import{n as t}from"./p-cb6da774.js";import{y as n,u as r,i as e,c as s,l as o,p as a,o as i,m as c,T as u,h as f,a as l,b as d,d as g,A as p,O as h,x as w,g as m,w as y,E as A,L as v,B as I,F as b,I as L,U,j as M,V as j,M as F,S,k as x,q as D,v as E,z as N,C as k,D as z,G as O,H as P}from"./p-d4dbfa93.js";import{L as B,gd as W,I as $,f3 as G,ge as H,gf as J,dF as K,J as T,O as V,gg as _,gh as q,gi as C,K as Q,gj as R,M as X}from"./p-5420851c.js";import{A as Y}from"./p-5c0c1116.js";import"./p-53bb6ab4.js";import"./p-0bbc1744.js";function Z(t,n,r){const e=n/3,s=new Uint32Array(r+1),o=new Uint32Array(r+1),a=(t,n)=>{t<n?s[t+1]++:o[n+1]++};for(let n=0;n<e;n++){const r=t[3*n],e=t[3*n+1],s=t[3*n+2];a(r,e),a(e,s),a(s,r)}let i=0,c=0;for(let t=0;t<r;t++){const n=s[t+1],r=o[t+1];s[t+1]=i,o[t+1]=c,i+=n,c+=r}const u=new Uint32Array(6*e),f=s[r],l=(t,n,r)=>{if(t<n){const e=s[t+1]++;u[2*e]=n,u[2*e+1]=r}else{const e=o[n+1]++;u[2*f+2*e]=t,u[2*f+2*e+1]=r}};for(let n=0;n<e;n++){const r=t[3*n],e=t[3*n+1],s=t[3*n+2];l(r,e,n),l(e,s,n),l(s,r,n)}const d=(t,n)=>{const r=2*t,e=n-t;for(let t=1;t<e;t++){const n=u[r+2*t],e=u[r+2*t+1];let s=t-1;for(;s>=0&&u[r+2*s]>n;s--)u[r+2*s+2]=u[r+2*s],u[r+2*s+3]=u[r+2*s+1];u[r+2*s+2]=n,u[r+2*s+3]=e}};for(let t=0;t<r;t++)d(s[t],s[t+1]),d(f+o[t],f+o[t+1]);const g=new Int32Array(3*e),p=(n,r)=>n===t[3*r]?0:n===t[3*r+1]?1:n===t[3*r+2]?2:-1,h=(t,n)=>{const r=p(t,n);g[3*n+r]=-1},w=(t,n,r,e)=>{const s=p(t,n);g[3*n+s]=e;const o=p(r,e);g[3*e+o]=n};for(let t=0;t<r;t++){let n=s[t];const r=s[t+1];let e=o[t];const a=o[t+1];for(;n<r&&e<a;){const r=u[2*n],s=u[2*f+2*e];r===s?(w(t,u[2*n+1],s,u[2*f+2*e+1]),n++,e++):r<s?(h(t,u[2*n+1]),n++):(h(s,u[2*f+2*e+1]),e++)}for(;n<r;)h(t,u[2*n+1]),n++;for(;e<a;)h(u[2*f+2*e],u[2*f+2*e+1]),e++}return g}function tt(t,n){return n.push(t.buffer),{buffer:t.buffer,layout:nt(t.layout)}}function nt(t){const n=new Array;return t.fields.forEach(((t,r)=>{const e={...t,constructor:et(t.constructor)};n.push([r,e])})),{stride:t.stride,fields:n,fieldNames:t.fieldNames}}const rt=[n,r,e,s,o,a,i,c,u,f,l,d,g,p,h,w,m,y,A,v,I,b,L,U,M,j,F,S,x,D,E,N,k,z,O,P];function et(t){return`${t.ElementType}_${t.ElementCount}`}const st=new Map;function ot(t,n=0){const r=t.stride;return t.fieldNames.filter((n=>{const r=t.fields.get(n).optional;return!(r&&r.glPadding)})).map((e=>{const s=t.fields.get(e),o=s.constructor.ElementCount,a=at(s.constructor.ElementType);return{name:e,stride:r,count:o,type:a,offset:s.offset,normalized:!(!s.optional||!s.optional.glNormalized),divisor:n}}))}function at(t){const n=it[t];if(n)return n;throw new Error("BufferType not supported in WebGL")}rt.forEach((t=>st.set(et(t),t)));const it={u8:5121,u16:5123,u32:5125,i8:5120,i16:5122,i32:5124,f32:5126},ct=Y().vec3f("position").u16("componentIndex").u16("u16padding");ot(Y().vec2u8("sideness"));const ut=Y().vec3f("position0").vec3f("position1").u16("componentIndex").u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).u8("u8padding",{glPadding:!0}).u16("u16padding",{glPadding:!0}),ft=ut.clone().vec3f("normal"),lt=ut.clone().vec3f("normalA").vec3f("normalB");class dt{updateSettings(t){this.settings=t,this.edgeHashFunction=t.reducedPrecision?mt:wt}write(t,n,r){const e=this.edgeHashFunction(r);bt.seed=e;const s=bt.getIntRange(0,255),o=bt.getIntRange(0,this.settings.variants-1),a=bt.getFloat(),i=255*(.5*function(t){const n=t<0?-1:1;return Math.abs(t)**1.2*n}(-(1-Math.min(a/.7,1))+Math.max(0,a-.7)/(1-.7))+.5);t.position0.setVec(n,r.position0),t.position1.setVec(n,r.position1),t.componentIndex.set(n,r.componentIndex),t.variantOffset.set(n,s),t.variantStroke.set(n,o),t.variantExtension.set(n,i)}trim(t,n){return t.slice(0,n)}}const gt=new Float32Array(6),pt=new Uint32Array(gt.buffer),ht=new Uint32Array(1);function wt(t){const n=gt;n[0]=t.position0[0],n[1]=t.position0[1],n[2]=t.position0[2],n[3]=t.position1[0],n[4]=t.position1[1],n[5]=t.position1[2],ht[0]=5381;for(let t=0;t<pt.length;t++)ht[0]=31*ht[0]+pt[t];return ht[0]}function mt(t){const n=gt;n[0]=yt(t.position0[0]),n[1]=yt(t.position0[1]),n[2]=yt(t.position0[2]),n[3]=yt(t.position1[0]),n[4]=yt(t.position1[1]),n[5]=yt(t.position1[2]),ht[0]=5381;for(let t=0;t<pt.length;t++)ht[0]=31*ht[0]+pt[t];return ht[0]}function yt(t){return Math.round(1e4*t)/1e4}class At{constructor(){this.commonWriter=new dt}updateSettings(t){this.commonWriter.updateSettings(t)}allocate(t){return ft.createBuffer(t)}write(t,n,r){this.commonWriter.write(t,n,r),B(It,r.faceNormal0,r.faceNormal1),W(It,It),t.normal.setVec(n,It)}trim(t,n){return this.commonWriter.trim(t,n)}}At.Layout=ft,At.glLayout=ot(ft,1);class vt{constructor(){this.commonWriter=new dt}updateSettings(t){this.commonWriter.updateSettings(t)}allocate(t){return lt.createBuffer(t)}write(t,n,r){this.commonWriter.write(t,n,r),t.normalA.setVec(n,r.faceNormal0),t.normalB.setVec(n,r.faceNormal1)}trim(t,n){return this.commonWriter.trim(t,n)}}vt.Layout=lt,vt.glLayout=ot(lt,1);const It=$(),bt=new G,Lt=-1;function Ut(t,n){return t.cosAngle<n}function Mt(t,n){return t.cosAngle>n}function jt(t,n){const r=q(t.cosAngle),e=St.fwd,s=St.ortho;return C(e,t.position1,t.position0),r*(V(_(s,t.faceNormal0,t.faceNormal1),e)>0?-1:1)>n}function Ft(t){const n=t.faces.length/3,r=t.vertices.position,e=t.faces,s=xt.v0,o=xt.v1,a=xt.v2,i=new Float32Array(3*n);for(let t=0;t<n;t++){const n=e[3*t+1],c=e[3*t+2];r.getVec(e[3*t+0],s),r.getVec(n,o),r.getVec(c,a),Q(o,o,s),Q(a,a,s),_(s,o,a),W(s,s),i[3*t+0]=s[0],i[3*t+1]=s[1],i[3*t+2]=s[2]}return i}const St={edge:{position0:$(),position1:$(),faceNormal0:$(),faceNormal1:$(),componentIndex:0,cosAngle:0},ortho:$(),fwd:$()},xt={v0:$(),v1:$(),v2:$()},Dt={anglePlanar:4,angleSignificantEdge:35};async function Et(t){const n=kt(t),r=Nt(n),e=[n.data.buffer];return{result:zt(r,e),transferList:e}}function Nt(t){const n=Ot(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return Pt.updateSettings(t.writerSettings),Bt.updateSettings(t.writerSettings),function(t,n,r,e=Dt){const s=t.vertices.position,o=t.vertices.componentIndex,a=X(e.anglePlanar),i=X(e.angleSignificantEdge),c=Math.cos(i),u=Math.cos(a),f=St.edge,l=f.position0,d=f.position1,g=f.faceNormal0,p=f.faceNormal1,h=Ft(t),w=function(t){const n=t.faces.length/3,r=t.faces,e=t.neighbors;let s=0;for(let t=0;t<n;t++){const n=r[3*t+0],o=r[3*t+1],a=r[3*t+2];s+=e[3*t+0]===Lt||n<o?1:0,s+=e[3*t+1]===Lt||o<a?1:0,s+=e[3*t+2]===Lt||a<n?1:0}const o=new Int32Array(4*s);let a=0;for(let t=0;t<n;t++){const n=e[3*t+0],s=e[3*t+1],i=e[3*t+2],c=r[3*t+0],u=r[3*t+1],f=r[3*t+2];(n===Lt||c<u)&&(o[a++]=c,o[a++]=u,o[a++]=t,o[a++]=n),(s===Lt||u<f)&&(o[a++]=u,o[a++]=f,o[a++]=t,o[a++]=s),(i===Lt||f<c)&&(o[a++]=f,o[a++]=c,o[a++]=t,o[a++]=i)}return o}(t),m=w.length/4,y=n.allocate(m);let A=0;const v=r.allocate(m);let I=0,b=0,L=0;const U=H(0,m),M=new Float32Array(m);J(M,((t,n,r)=>{s.getVec(w[4*n+0],l),s.getVec(w[4*n+1],d),r[n]=R(l,d)})),U.sort(((t,n)=>M[n]-M[t]));const j=new Array,F=new Array;for(let t=0;t<m;t++){const e=U[t],i=M[e],m=w[4*e+0],S=w[4*e+1],x=w[4*e+2],D=w[4*e+3],E=D===Lt;if(s.getVec(m,l),s.getVec(S,d),E)K(g,h[3*x+0],h[3*x+1],h[3*x+2]),T(p,g),f.componentIndex=o.get(m),f.cosAngle=V(g,p);else{if(K(g,h[3*x+0],h[3*x+1],h[3*x+2]),K(p,h[3*D+0],h[3*D+1],h[3*D+2]),f.componentIndex=o.get(m),f.cosAngle=V(g,p),Mt(f,u))continue;f.cosAngle<-.9999&&T(p,g)}b+=i,L++,E||Ut(f,c)?(n.write(y,A++,f),j.push(i)):jt(f,a)&&(r.write(v,I++,f),F.push(i))}const S=new Float32Array(j.reverse()),x=new Float32Array(F.reverse());return{regular:{instancesData:n.trim(y,A),lodInfo:{lengths:S}},silhouette:{instancesData:r.trim(v,I),lodInfo:{lengths:x}},averageEdgeLength:b/L}}(n,Pt,Bt)}function kt(t){return{data:ct.createView(t.dataBuffer),indices:"Uint32Array"===t.indicesType?new Uint32Array(t.indicesBuffer):"Uint16Array"===t.indicesType?new Uint16Array(t.indicesBuffer):void 0,indicesLength:t.indicesLength,writerSettings:t.writerSettings,skipDeduplicate:t.skipDeduplicate}}function zt(t,n){return n.push(t.regular.lodInfo.lengths.buffer),n.push(t.silhouette.lodInfo.lengths.buffer),{regular:{instancesData:tt(t.regular.instancesData,n),lodInfo:{lengths:t.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:tt(t.silhouette.instancesData,n),lodInfo:{lengths:t.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:t.averageEdgeLength}}function Ot(n,r,e,s){if(r)return{faces:e,facesLength:s,neighbors:Z(e,s,n.count),vertices:n};const o=t(n.buffer,n.stride/4,{originalIndices:e,originalIndicesLength:s}),a=Z(o.indices,s,o.uniqueCount);return{faces:o.indices,facesLength:o.indices.length,neighbors:a,vertices:ct.createView(o.buffer)}}const Pt=new At,Bt=new vt;export{Nt as work,Et as wrappedWork}