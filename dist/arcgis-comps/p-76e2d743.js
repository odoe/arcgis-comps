import{a1 as t}from"./p-7b6f6c18.js";import{l as s}from"./p-54e8960f.js";import{o as i}from"./p-1dd7027e.js";import{r as e}from"./p-e53f77c2.js";import"./p-227a5838.js";import"./p-47e1bd73.js";import"./p-804725e3.js";import"./p-5bfd1d7e.js";import"./p-b392deaf.js";import"./p-4414d64f.js";import"./p-a617738c.js";import"./p-a16c2b1d.js";import"./p-167d094f.js";import"./p-a4a5967b.js";import"./p-033339b0.js";import"./p-97ec6ae5.js";const o=[1,0],p=[0,1];class a{constructor(){this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._programDesc={blur:{vsPath:"post-processing/drop-shadow",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null),this._horizontalBlurFBO&&(this._horizontalBlurFBO.dispose(),this._horizontalBlurFBO=null),this._verticalBlurFBO&&(this._verticalBlurFBO.dispose(),this._verticalBlurFBO=null)}draw(s,i,a){const{context:r,state:h,painter:n}=s,{materialManager:l}=n,d=this._programDesc,c=i.width,u=i.height,m=[Math.round(c/2),Math.round(u/2)],{blurRadius:f,offsetX:g,offsetY:w,color:_}=a,b=[t(g/2),t(w/2)];this._createOrResizeResources(s,c,u,m);const j=this._horizontalBlurFBO,M=this._verticalBlurFBO;r.setStencilWriteMask(0),r.setStencilTestEnabled(!1),r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1);const x=this._layerFBOTexture;i.copyToTexture(0,0,c,u,0,0,x),this._quad||(this._quad=new e(r,[-1,-1,1,-1,-1,1,1,1])),r.setViewport(0,0,m[0],m[1]);const T=this._quad;T.bind(),r.setBlendingEnabled(!1);const F=l.getProgram(s,d.blur,[{name:"radius",value:Math.ceil(f)}]);r.useProgram(F),r.bindFramebuffer(j),r.bindTexture(i.colorTexture,4),F.setUniformMatrix3fv("u_displayViewMat3",h.displayMat3),F.setUniform2fv("u_offset",b),F.setUniform1i("u_colorTexture",4),F.setUniform2fv("u_texSize",m),F.setUniform2fv("u_direction",o),F.setUniform1f("u_sigma",f),T.draw(),r.bindFramebuffer(M),r.bindTexture(j.colorTexture,5),F.setUniformMatrix3fv("u_displayViewMat3",h.displayMat3),F.setUniform2fv("u_offset",[0,0]),F.setUniform1i("u_colorTexture",5),F.setUniform2fv("u_direction",p),T.draw(),r.bindFramebuffer(i),r.setViewport(0,0,c,u);const y=l.getProgram(s,d.composite);r.useProgram(y),r.bindTexture(M.colorTexture,2),y.setUniform1i("u_blurTexture",2),r.bindTexture(x,3),y.setUniform1i("u_layerFBOTexture",3),y.setUniform4fv("u_shadowColor",[_[3]*(_[0]/255),_[3]*(_[1]/255),_[3]*(_[2]/255),_[3]]),T.draw(),r.setBlendingEnabled(!0),r.setStencilTestEnabled(!0),r.setBlendFunction(1,771),T.unbind()}_createOrResizeResources(t,e,o,p){const{context:a}=t;this._horizontalBlurFBO&&this._size[0]===e&&this._size[1]===o||(this._size[0]=e,this._size[1]=o,this._horizontalBlurFBO?this._horizontalBlurFBO.resize(p[0],p[1]):this._horizontalBlurFBO=new s(a,{colorTarget:0,depthStencilTarget:0,width:p[0],height:p[1]},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:p[0],height:p[1]}),this._verticalBlurFBO?this._verticalBlurFBO.resize(p[0],p[1]):this._verticalBlurFBO=new s(a,{colorTarget:0,depthStencilTarget:0,width:p[0],height:p[1]},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:p[0],height:p[1]}),this._layerFBOTexture?this._layerFBOTexture.resize(e,o):this._layerFBOTexture=new i(a,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:e,height:o}))}}export{a as DropShadow}