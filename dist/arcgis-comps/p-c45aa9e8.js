import{s as e,c as n,D as t}from"./p-e58503d5.js";const r=!0;function o(e,n,t){return{identifier:String.fromCharCode.apply(null,new Uint8Array(e,t+0,10)),version:n.getUint16(t+10,r),checksum:n.getUint32(t+12,r)}}function i(e,n){return{sizeLo:e.getUint32(n+0,r),sizeHi:e.getUint32(n+4,r),minX:e.getFloat64(n+8,r),minY:e.getFloat64(n+16,r),minZ:e.getFloat64(n+24,r),maxX:e.getFloat64(n+32,r),maxY:e.getFloat64(n+40,r),maxZ:e.getFloat64(n+48,r),errorX:e.getFloat64(n+56,r),errorY:e.getFloat64(n+64,r),errorZ:e.getFloat64(n+72,r),count:e.getUint32(n+80,r),reserved:e.getUint32(n+84,r)}}function c(n){const t=new DataView(n,0);let r=0;const{identifier:c,version:s}=o(n,t,r);if(r+=16,"LEPCC     "!==c)throw new e("lepcc-decode-error","Bad identifier");if(s>1)throw new e("lepcc-decode-error","Unknown version");const f=i(t,r);if(r+=88,f.sizeHi*2**32+f.sizeLo!==n.byteLength)throw new e("lepcc-decode-error","Bad size");const u=new Float64Array(3*f.count),l=[],d=[],w=[],y=[];if(r=a(n,r,l),r=a(n,r,d),r=a(n,r,w),r=a(n,r,y),r!==n.byteLength)throw new e("lepcc-decode-error","Bad length");let p=0,h=0;for(let e=0;e<l.length;e++){h+=l[e];let n=0;for(let t=0;t<d[e];t++){n+=w[p];const e=y[p];u[3*p]=Math.min(f.maxX,f.minX+2*f.errorX*n),u[3*p+1]=Math.min(f.maxY,f.minY+2*f.errorY*h),u[3*p+2]=Math.min(f.maxZ,f.minZ+2*f.errorZ*e),p++}}return{errorX:f.errorX,errorY:f.errorY,errorZ:f.errorZ,result:u}}function a(e,n,t){const r=[];n=s(e,n,r);const o=[];for(let i=0;i<r.length;i++){o.length=0,n=s(e,n,o);for(let e=0;e<o.length;e++)t.push(o[e]+r[i])}return n}function s(n,t,o){const i=new DataView(n,t),c=i.getUint8(0),a=31&c,s=!!(32&c),f=(192&c)>>6;let u=0;if(0===f)u=i.getUint32(1,r),t+=5;else if(1===f)u=i.getUint16(1,r),t+=3;else{if(2!==f)throw new e("lepcc-decode-error","Bad count type");u=i.getUint8(1),t+=2}if(s)throw new e("lepcc-decode-error","LUT not implemented");const l=Math.ceil(u*a/8),d=new Uint8Array(n,t,l);let w=0,y=0,p=0;const h=-1>>>32-a;for(let e=0;e<u;e++){for(;y<a;)w|=d[p]<<y,y+=8,p+=1;o[e]=w&h,w>>>=a,y-=a,y+a>32&&(w|=d[p-1]>>8-y)}return t+p}function f(e,n){return{sizeLo:e.getUint32(n+0,r),sizeHi:e.getUint32(n+4,r),count:e.getUint32(n+8,r),colorMapCount:e.getUint16(n+12,r),lookupMethod:e.getUint8(n+14),compressionMethod:e.getUint8(n+15)}}function u(e,n){return{sizeLo:e.getUint32(n+0,r),sizeHi:e.getUint32(n+4,r),count:e.getUint32(n+8,r),scaleFactor:e.getUint16(n+12,r),bitsPerPoint:e.getUint8(n+14),reserved:e.getUint8(n+15)}}const l=n.getLogger("esri.views.3d.layers.i3s.I3SBinaryReader");function d(n,t,r){let o="",i=0;for(;i<r;){const c=n[t+i];if(c<128)o+=String.fromCharCode(c),i++;else if(c>=192&&c<224){if(i+1>=r)throw new e("utf8-decode-error","UTF-8 Decode failed. Two byte character was truncated.");o+=String.fromCharCode((31&c)<<6|63&n[t+i+1]),i+=2}else if(c>=224&&c<240){if(i+2>=r)throw new e("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");o+=String.fromCharCode((15&c)<<12|(63&n[t+i+1])<<6|63&n[t+i+2]),i+=3}else{if(!(c>=240&&c<248))throw new e("utf8-decode-error","UTF-8 Decode failed. Invalid multi byte sequence.");{if(i+3>=r)throw new e("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");const a=(7&c)<<18|(63&n[t+i+1])<<12|(63&n[t+i+2])<<6|63&n[t+i+3];o+=a>=65536?String.fromCharCode(55296+(a-65536>>10),56320+(1023&a)):String.fromCharCode(a),i+=4}}}return o}function w(e,n){const t={byteOffset:0,byteCount:0,fields:Object.create(null)};let r=0;for(let o=0;o<n.length;o++){const i=n[o],c=i.valueType||i.type;t.fields[i.property]=(0,A[c])(e,r),r+=m[c].BYTES_PER_ELEMENT}return t.byteCount=r,t}function y(n,t,r){const o=[];let i,c,a=0;for(c=0;c<n;c+=1){if(i=t[c],i>0){if(o.push(d(r,a,i-1)),0!==r[a+i-1])throw new e("string-array-error","Invalid string array: missing null termination.")}else o.push(null);a+=i}return o}function p(e,n){return new m[n.valueType](e,n.byteOffset,n.count*n.valuesPerElement)}function h(n,r,o){const i=null!=r.header?w(n,r.header):{byteOffset:0,byteCount:0,fields:{count:o}},c={header:i,byteOffset:i.byteCount,byteCount:0,entries:Object.create(null)};let a=i.byteCount;for(let n=0;n<r.ordering.length;n++){const o=r.ordering[n],s=t(r[o]);if(s.count=i.fields.count,"String"===s.valueType){if(s.byteOffset=a,s.byteCount=i.fields[o+"ByteCount"],"UTF-8"!==s.encoding)throw new e("unsupported-encoding","Unsupported String encoding.",{encoding:s.encoding})}else{if(!B(s.valueType))throw new e("unsupported-value-type","Unsupported binary valueType",{valueType:s.valueType});{const e=D(s.valueType);a+=a%e!=0?e-a%e:0,s.byteOffset=a,s.byteCount=e*s.valuesPerElement*s.count}}a+=s.byteCount,c.entries[o]=s}return c.byteCount=a-c.byteOffset,c}function b(n,t,r){if(t!==n&&l.error(`Invalid ${r} buffer size\n expected: ${n}, actual: ${t})`),t<n)throw new e("buffer-too-small","Binary buffer is too small",{expectedSize:n,actualSize:t})}function g(e,n){const t=w(e,n&&n.header);let r=t.byteCount;const o={isDraco:!1,header:t,byteOffset:t.byteCount,byteCount:0,vertexAttributes:{}},i=t.fields,c=null!=i.vertexCount?i.vertexCount:i.count;for(const e of n.ordering){if(!n.vertexAttributes[e])continue;const t={...n.vertexAttributes[e],byteOffset:r,count:c};o.vertexAttributes[I[e]?I[e]:"_"+e]=t,r+=D(t.valueType)*t.valuesPerElement*c}const a=i.faceCount;if(n.faces&&a){o.faces={};for(const e of n.ordering){if(!n.faces[e])continue;const t={...n.faces[e],byteOffset:r,count:a};o.faces[e]=t,r+=D(t.valueType)*t.valuesPerElement*a}}const s=i.featureCount;if(n.featureAttributes&&n.featureAttributeOrder&&s){o.featureAttributes={};for(const e of n.featureAttributeOrder){if(!n.featureAttributes[e])continue;const t={...n.featureAttributes[e],byteOffset:r,count:s};o.featureAttributes[e]=t,r+=("UInt64"===t.valueType?8:D(t.valueType))*t.valuesPerElement*s}}return b(r,e.byteLength,"geometry"),o.byteCount=r-o.byteOffset,o}function U(e,n){return e&&e.compressedAttributes&&"draco"===e.compressedAttributes.encoding?function(e){const n={isDraco:!0,isLegacy:!1,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1};for(const t of e)switch(t){case"position":break;case"normal":n.normal=!0;break;case"uv0":n.uv0=!0;break;case"color":n.color=!0;break;case"uv-region":n.uvRegion=!0;break;case"feature-index":n.featureIndex=!0}return n}(e.compressedAttributes.attributes):e?function(e){return{isDraco:!1,isLegacy:!1,color:null!=e.color,normal:null!=e.normal,uv0:null!=e.uv0,uvRegion:null!=e.uvRegion,featureIndex:null!=e.faceRange&&null!=e.featureId}}(e):function(e){const n={isDraco:!1,isLegacy:!0,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1};for(const t of e.ordering)if(e.vertexAttributes[t])switch(t){case"position":break;case"normal":n.normal=!0;break;case"color":n.color=!0;break;case"uv0":n.uv0=!0;break;case"region":n.uvRegion=!0}return e.featureAttributes&&e.featureAttributeOrder&&(n.featureIndex=!0),n}(n)}const I={position:"position",normal:"normal",color:"color",uv0:"uv0",region:"uvRegion"};function v(n,t,r){if("lepcc-rgb"===n.encoding)return function(n){const t=new DataView(n,0);let r=0;const{identifier:i,version:c}=o(n,t,r);if(r+=16,"ClusterRGB"!==i)throw new e("lepcc-decode-error","Bad identifier");if(c>1)throw new e("lepcc-decode-error","Unknown version");const a=f(t,r);if(r+=16,a.sizeHi*2**32+a.sizeLo!==n.byteLength)throw new e("lepcc-decode-error","Bad size");if((2===a.lookupMethod||1===a.lookupMethod)&&0===a.compressionMethod){if(3*a.colorMapCount+a.count+r!==n.byteLength||a.colorMapCount>256)throw new e("lepcc-decode-error","Bad count");const t=new Uint8Array(n,r,3*a.colorMapCount),o=new Uint8Array(n,r+3*a.colorMapCount,a.count),i=new Uint8Array(3*a.count);for(let e=0;e<a.count;e++){const n=o[e];i[3*e]=t[3*n],i[3*e+1]=t[3*n+1],i[3*e+2]=t[3*n+2]}return i}if(0===a.lookupMethod&&0===a.compressionMethod){if(3*a.count+r!==n.byteLength||0!==a.colorMapCount)throw new e("lepcc-decode-error","Bad count");return new Uint8Array(n,r).slice()}if(a.lookupMethod<=2&&1===a.compressionMethod){if(r+3!==n.byteLength||1!==a.colorMapCount)throw new e("lepcc-decode-error","Bad count");const o=t.getUint8(r),i=t.getUint8(r+1),c=t.getUint8(r+2),s=new Uint8Array(3*a.count);for(let e=0;e<a.count;e++)s[3*e]=o,s[3*e+1]=i,s[3*e+2]=c;return s}throw new e("lepcc-decode-error","Bad method "+a.lookupMethod+","+a.compressionMethod)}(t);if("lepcc-intensity"===n.encoding)return function(n){const t=new DataView(n,0);let r=0;const{identifier:i,version:c}=o(n,t,r);if(r+=16,"Intensity "!==i)throw new e("lepcc-decode-error","Bad identifier");if(c>1)throw new e("lepcc-decode-error","Unknown version");const a=u(t,r);if(r+=16,a.sizeHi*2**32+a.sizeLo!==n.byteLength)throw new e("lepcc-decode-error","Bad size");const f=new Uint16Array(a.count);if(8===a.bitsPerPoint){if(a.count+r!==n.byteLength)throw new e("lepcc-decode-error","Bad size");const t=new Uint8Array(n,r,a.count);for(let e=0;e<a.count;e++)f[e]=t[e]*a.scaleFactor}else if(16===a.bitsPerPoint){if(2*a.count+r!==n.byteLength)throw new e("lepcc-decode-error","Bad size");const t=new Uint16Array(n,r,a.count);for(let e=0;e<a.count;e++)f[e]=t[e]*a.scaleFactor}else{const t=[];if(s(n,r,t)!==n.byteLength)throw new e("lepcc-decode-error","Bad size");for(let e=0;e<a.count;e++)f[e]=t[e]*a.scaleFactor}return f}(t);if(null!=n.encoding&&""!==n.encoding)throw new e("unknown-attribute-storage-info-encoding","Unknown Attribute Storage Info Encoding");n["attributeByteCounts "]&&!n.attributeByteCounts&&(l.warn("Warning: Trailing space in 'attributeByteCounts '."),n.attributeByteCounts=n["attributeByteCounts "]),"ObjectIds"===n.ordering[0]&&n.hasOwnProperty("objectIds")&&(l.warn("Warning: Case error in objectIds"),n.ordering[0]="objectIds");const i=h(t,n,r);b(i.byteOffset+i.byteCount,t.byteLength,"attribute");const c=i.entries.attributeValues||i.entries.objectIds;if(c){if("String"===c.valueType){const e=i.entries.attributeByteCounts,n=p(t,e),r=function(e,n){return new Uint8Array(e,n.byteOffset,n.byteCount)}(t,c);return y(e.count,n,r)}return p(t,c)}throw new e("bad-attribute-storage-info","Bad attributeStorageInfo specification.")}const m={Float32:Float32Array,Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,Int32:Int32Array},A={Float32:(e,n)=>new DataView(e,0).getFloat32(n,!0),Float64:(e,n)=>new DataView(e,0).getFloat64(n,!0),UInt8:(e,n)=>new DataView(e,0).getUint8(n),Int8:(e,n)=>new DataView(e,0).getInt8(n),UInt16:(e,n)=>new DataView(e,0).getUint16(n,!0),Int16:(e,n)=>new DataView(e,0).getInt16(n,!0),UInt32:(e,n)=>new DataView(e,0).getUint32(n,!0),Int32:(e,n)=>new DataView(e,0).getInt32(n,!0)};function B(e){return m.hasOwnProperty(e)}function D(e){return B(e)?m[e].BYTES_PER_ELEMENT:0}export{v as C,c as a,p as c,U as g,g as y}