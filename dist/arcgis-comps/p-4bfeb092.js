import{ae as t,r as s,_ as e,m as r,b_ as i,N as a,v as o}from"./p-9ae46e68.js";import{a2 as p,bL as n}from"./p-566b0715.js";import{e as h,n as m}from"./p-4003c7ae.js";import{m as c}from"./p-dc35ec83.js";import{g as f,f as u}from"./p-47f143cb.js";import{V as j}from"./p-574af054.js";import{O as d,L as l}from"./p-59312e26.js";import{d as y}from"./p-a19e89a5.js";import{B as b}from"./p-7329e343.js";import{d as w}from"./p-5a0fe1d0.js";import"./p-84bf99cb.js";import"./p-fe01b82b.js";import"./p-b2d0e2de.js";import"./p-db87794e.js";import"./p-81e5b36e.js";import"./p-cb4bfb58.js";import"./p-285c6a34.js";import"./p-2a252a78.js";import"./p-bae36c84.js";import"./p-138c2b2c.js";import"./p-50ff864e.js";import"./p-3a2e88bf.js";import"./p-8031c809.js";import"./p-27ef204b.js";import"./p-b74f39e0.js";import"./p-06d309e6.js";import"./p-685003b3.js";import"./p-007111db.js";import"./p-0659cf81.js";import"./p-8ac97b63.js";import"./p-5ee2f7e2.js";import"./p-8d03d70f.js";import"./p-4fd6e394.js";import"./p-9a8fa752.js";import"./p-8e03c038.js";import"./p-32462343.js";export default class{constructor(){this._queryEngine=null,this._customParameters=null,this._snapshotFeatures=async e=>{const{objectIdField:r}=this._queryEngine,i=await b(this._getFeatureUrl,this._featureType.typeName,this._getFeatureOutputFormat,{customParameters:this._customParameters,dateFields:this._queryEngine.fieldsIndex.dateFields.map((t=>t.name)),signal:e});await d(i),t(e);const a=l(i,{geometryType:this._queryEngine.geometryType,hasZ:!1,objectIdField:r});if(!p(this._queryEngine.spatialReference,n))for(const t of a)s(t.geometry)&&(t.geometry=h(f(m(t.geometry,this._queryEngine.geometryType,!1,!1),n,this._queryEngine.spatialReference)));let o=1;for(const t of a){const s={};y(this._fieldsIndex,s,t.attributes,!0),t.attributes=s,null==t.attributes[r]&&(t.objectId=t.attributes[r]=o++)}return a}}destroy(){var t;null==(t=this._queryEngine)||t.destroy(),this._queryEngine=null}async load(s,r){const{getFeatureUrl:i,getFeatureOutputFormat:a,spatialReference:o,fields:p,geometryType:n,featureType:h,objectIdField:m,customParameters:f}=s;this._featureType=h,this._customParameters=f,this._getFeatureUrl=i,this._getFeatureOutputFormat=a,this._fieldsIndex=new w(p),await this._checkProjection(o),t(r),this._queryEngine=new j({fields:p,geometryType:n,hasM:!1,hasZ:!1,objectIdField:m,spatialReference:o,timeInfo:null,featureStore:new c({geometryType:n,hasM:!1,hasZ:!1})});const u=await this._snapshotFeatures(e(r.signal));return this._queryEngine.featureStore.addMany(u),{extent:this._queryEngine.fullExtent}}async applyEdits(){throw new r("wfs-source:editing-not-supported","applyEdits() is not supported on WFSLayer")}async queryFeatures(t={},s={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(t,s.signal)}async queryFeatureCount(t={},s={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(t,s.signal)}async queryObjectIds(t={},s={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForIds(t,s.signal)}async queryExtent(t={},s={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(t,s.signal)}async querySnapping(t,s={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForSnapping(t,s.signal)}async refresh(t){var s;return this._customParameters=t,null==(s=this._snapshotTask)||s.abort(),this._snapshotTask=i(this._snapshotFeatures),this._snapshotTask.promise.then((t=>{this._queryEngine.featureStore.clear(),t&&this._queryEngine.featureStore.addMany(t)}),(t=>{this._queryEngine.featureStore.clear(),a(t)||o.getLogger("esri.layers.WFSLayer").error(new r("wfs-layer:getfeature-error","An error occurred during the GetFeature request",{error:t}))})),await this._waitSnapshotComplete(),{extent:this._queryEngine.fullExtent}}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _checkProjection(t){try{await u(n,t)}catch{throw new r("unsupported-projection","Projection not supported",{spatialReference:t})}}}