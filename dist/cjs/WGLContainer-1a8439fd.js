'use strict';

const request = require('./messageBundle-8be88d04.js');
const DefaultUI = require('./DefaultUI-75d05512.js');
const brushes = require('./brushes-09287871.js');
const Container = require('./Container-afc09537.js');
const DisplayObject = require('./DisplayObject-573912c8.js');
const earcut = require('./earcut-d5562923.js');
const vec2 = require('./vec2-d000a8cb.js');
const vec2f64 = require('./vec2f64-60b3c97e.js');
const featureConversionUtils = require('./featureConversionUtils-df21e951.js');
const OptimizedFeature = require('./OptimizedFeature-cd4fe3c6.js');
const number = require('./number-d65aefed.js');
const FramebufferObject = require('./FramebufferObject-435e1736.js');
const Utils = require('./Utils-a77299a6.js');

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const m$1=request.s$1.getLogger("esri.views.2d.engine.webgl.Mesh2D"),u=t=>{switch(t.BYTES_PER_ELEMENT){case 1:return 5121;case 2:return 5123;case 4:return 5125;default:throw new request.s("Cannot get DataType of array")}},y=(e,t,r,s)=>{let n=0;for(let o=1;o<r;o++){const r=e[2*(t+o-1)],s=e[2*(t+o-1)+1];n+=(e[2*(t+o)]-r)*(e[2*(t+o)+1]+s);}return s?n>0:n<0},x=({coords:e,lengths:t},r)=>{const n=[];for(let o=0,c=0;o<t.length;c+=t[o],o+=1){const i=c,a=[];for(;o<t.length-1&&y(e,c+t[o],t[o+1],r);o+=1,c+=t[o])a.push(c+t[o]-i);const f=e.slice(2*i,2*(c+t[o])),h=earcut.x(f,a,2);for(const e of h)n.push(e+i);}return n};class g{constructor(e,t,r,s=!1){this._cache={},this.vertices=e,this.indices=t,this.primitiveType=r,this.isMapSpace=s;}static fromRect({x:e,y:t,width:r,height:s}){const n=e,o=t,c=n+r,i=o+s;return g.fromScreenExtent({xmin:n,ymin:o,xmax:c,ymax:i})}static fromPath(e){const t=featureConversionUtils.H(new OptimizedFeature.t,e.path,!1,!1),r=t.coords,s=new Uint32Array(x(t,!0)),n=new Uint32Array(r.length/2);for(let o=0;o<n.length;o++)n[o]=number.m(Math.floor(r[2*o]),Math.floor(r[2*o+1]));return new g({geometry:n},s,4)}static fromGeometry(t,r){const s=r.geometry.type;switch(s){case"polygon":return g.fromPolygon(t,r.geometry);case"extent":return g.fromMapExtent(t,r.geometry);default:return m$1.error(new request.s("mapview-bad-type",`Unable to create a mesh from type ${s}`,r)),g.fromRect({x:0,y:0,width:1,height:1})}}static fromPolygon(e,t){const r=featureConversionUtils.D(new OptimizedFeature.t,t,!1,!1),s=r.coords,c=new Uint32Array(x(r,!1)),h=new Uint32Array(s.length/2),m=vec2f64.n(),u=vec2f64.n();for(let o=0;o<h.length;o++)vec2.r(m,s[2*o],s[2*o+1]),e.toScreen(u,m),h[o]=number.m(Math.floor(u[0]),Math.floor(u[1]));return new g({geometry:h},c,4,!0)}static fromScreenExtent({xmin:e,xmax:t,ymin:r,ymax:s}){const n={geometry:new Uint32Array([number.m(e,r),number.m(t,r),number.m(e,s),number.m(e,s),number.m(t,r),number.m(t,s)])},o=new Uint32Array([0,1,2,3,4,5]);return new g(n,o,4)}static fromMapExtent(e,t){const[r,s]=e.toScreen([0,0],[t.xmin,t.ymin]),[n,o]=e.toScreen([0,0],[t.xmax,t.ymax]),c={geometry:new Uint32Array([number.m(r,s),number.m(n,s),number.m(r,o),number.m(r,o),number.m(n,s),number.m(n,o)])},i=new Uint32Array([0,1,2,3,4,5]);return new g(c,i,4)}destroy(){request.r(this._cache.indexBuffer)&&this._cache.indexBuffer.dispose();for(const e in this._cache.vertexBuffers)request.r(this._cache.vertexBuffers[e])&&this._cache.vertexBuffers[e].dispose();}get elementType(){return u(this.indices)}getIndexBuffer(e,t=35044){return this._cache.indexBuffer||(this._cache.indexBuffer=FramebufferObject.h.createIndex(e,t,this.indices)),this._cache.indexBuffer}getVertexBuffers(e,t=35044){return this._cache.vertexBuffers||(this._cache.vertexBuffers=Object.keys(this.vertices).reduce(((r,s)=>({...r,[s]:FramebufferObject.h.createVertex(e,t,this.vertices[s])})),{})),this._cache.vertexBuffers}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const c=request.s$1.getLogger("esri.views.2d.engine.webgl.ClippingInfo"),n=t=>parseFloat(t)/100;class m extends DisplayObject.a{constructor(t,e){super(),this._clip=e,this._cache={},this.stage=t,this._handle=e.watch("version",(()=>this._invalidate())),this.ready();}static fromClipArea(t,e){return new m(t,e)}_destroyGL(){request.r(this._cache.mesh)&&(this._cache.mesh.destroy(),this._cache.mesh=null),request.r(this._cache.vao)&&(this._cache.vao.dispose(),this._cache.vao=null);}destroy(){this._destroyGL(),this._handle.remove();}getVAO(t,e,r,i){const[o,h]=e.size;if("geometry"!==this._clip.type&&this._lastWidth===o&&this._lastHeight===h||(this._lastWidth=o,this._lastHeight=h,this._destroyGL()),request.t$1(this._cache.vao)){const s=this._createMesh(e,this._clip),o=s.getIndexBuffer(t),h=s.getVertexBuffers(t);this._cache.mesh=s,this._cache.vao=new FramebufferObject.f(t,r,i,h,o);}return this._cache.vao}_createTransforms(){return {dvs:DefaultUI.n$2()}}_invalidate(){this._destroyGL(),this.requestRender();}_createScreenRect(t,e){const[r,s]=t.size,i="string"==typeof e.left?n(e.left)*r:e.left,o="string"==typeof e.right?n(e.right)*r:e.right,h="string"==typeof e.top?n(e.top)*s:e.top,a="string"==typeof e.bottom?n(e.bottom)*s:e.bottom,c=i,m=h;return {x:c,y:m,width:Math.max(r-o-c,0),height:Math.max(s-a-m,0)}}_createMesh(e,r){switch(r.type){case"rect":return g.fromRect(this._createScreenRect(e,r));case"path":return g.fromPath(r);case"geometry":return g.fromGeometry(e,r);default:return c.error(new request.s("mapview-bad-type","Unable to create ClippingInfo mesh from clip of type: ${clip.type}")),g.fromRect({x:0,y:0,width:1,height:1})}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class a extends Container.n{constructor(){super(...arguments),this.name=this.constructor.name;}set clips(e){this._clips=e,this.children.forEach((r=>r.clips=e)),this._updateClippingInfo();}_createTransforms(){return {dvs:DefaultUI.n$2()}}doRender(e){const r=this.createRenderParams(e),{painter:s,globalOpacity:t,profiler:i,drawPhase:n}=r,a=n===Utils.I.LABEL?1:t*this.computedOpacity;i.recordContainerStart(this.name),s.beforeRenderLayer(r,this._clippingInfos?255:0,a),this.updateTransforms(e.state),this.renderChildren(r),s.compositeLayer(r,a),i.recordContainerEnd();}renderChildren(r){request.t$1(this._renderPasses)&&(this._renderPasses=this.prepareRenderPasses(r.painter));for(const e of this.children)e.beforeRender(r);for(const e of this._renderPasses)try{e.render(r);}catch(s){}for(const e of this.children)e.afterRender(r);}createRenderParams(e){return e.requireFBO=this.requiresDedicatedFBO,e}prepareRenderPasses(e){return [e.registerRenderPass({name:"clip",brushes:[brushes.G.clip],target:()=>this._clippingInfos,drawPhase:Utils.I.MAP|Utils.I.LABEL|Utils.I.LABEL_ALPHA|Utils.I.DEBUG|Utils.I.HIGHLIGHT})]}updateTransforms(e){for(const r of this.children)r.setTransform(e);}onAttach(){super.onAttach(),this._updateClippingInfo();}onDetach(){super.onDetach(),this._updateClippingInfo();}_updateClippingInfo(){if(request.r(this._clippingInfos)&&(this._clippingInfos.forEach((e=>e.destroy())),this._clippingInfos=null),!this.stage)return;const e=this._clips;request.r(e)&&e.length&&(this._clippingInfos=e.items.map((e=>m.fromClipArea(this.stage,e)))),this.requestRender();}}

exports.a = a;
