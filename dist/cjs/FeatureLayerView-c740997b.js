'use strict';

const request = require('./messageBundle-8be88d04.js');
const OperationalLayer = require('./OperationalLayer-853649aa.js');
const labelingInfo = require('./labelingInfo-594911d5.js');
const opacityUtils = require('./opacityUtils-f2e4b347.js');
const Query = require('./Query-354911d3.js');
const popupUtils = require('./popupUtils-454e6531.js');
const floorFilterUtils = require('./floorFilterUtils-a9b30733.js');

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const P=request.s$1.getLogger("esri.views.layers.FeatureLayerView"),O=i=>{let O=class extends i{constructor(...e){super(...e),this._updatingRequiredFieldsPromise=null,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null;}initialize(){request.i$1(this,["layer.renderer","layer.labelingInfo","layer.elevationInfo.featureExpressionInfo","layer.displayField","filter","featureEffect","layer.timeInfo","layer.floorInfo","timeExtent"],(()=>this._handleRequiredFieldsChange()),!0),request.$(this,"view.floors","change",(()=>this._handleRequiredFieldsChange())),request.$(this,"layer.sublayer","change",(()=>this._handleRequiredFieldsChange()));}get availableFields(){const{layer:e,layer:{fieldsIndex:t},requiredFields:r}=this;return "outFields"in e&&e.outFields?opacityUtils.y(t,[...opacityUtils.I(t,e.outFields),...r]):opacityUtils.y(t,r)}set effect(e){request.r$3(P,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect=e;}get effect(){return request.r$3(P,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(e){void 0!==e?this._override("featureEffect",e):this._clearOverride("featureEffect");}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){P.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported");}get maximumNumberOfFeaturesExceeded(){return !1}highlight(e){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=request.r(this.filter)?this.filter.createQuery(e):new Query.b(e);if("feature"===this.layer.type){const e=floorFilterUtils.o(this);request.r(e)&&(t.where=t.where?`(${t.where}) AND (${e})`:e);}return request.r(this.timeExtent)&&(t.timeExtent=request.r(t.timeExtent)?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}_loadArcadeModules(e){if(e.get("expressionInfos.length"))return opacityUtils.a()}_handleRequiredFieldsChange(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then((()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null);}));}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fieldsIndex:r,objectIdField:i}}=this,o="renderer"in t&&t.renderer,l="orderBy"in t&&t.orderBy,n=t.featureReduction,u=new Set,p=await request.T([o?o.collectRequiredFields(u,r):null,opacityUtils.j(u,t),e?opacityUtils.A(u,t):null,request.r(this.filter)?opacityUtils.V(u,t,this.filter):null,request.r(this.featureEffect)?opacityUtils.V(u,t,this.featureEffect.filter):null,n?opacityUtils.N(u,t,n):null,l?opacityUtils._(u,t,l):null]);if(t.timeInfo&&this.timeExtent&&opacityUtils.g(u,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),"feature"===t.type&&t.floorInfo&&opacityUtils.g(u,t.fieldsIndex,[t.floorInfo.floorField]),"subtype-group"===t.type){opacityUtils.F(u,r,t.subtypeField);const e=t.sublayers.map((e=>{var t;return Promise.all([null==(t=e.renderer)?void 0:t.collectRequiredFields(u,r),opacityUtils.j(u,e)])}));await request.T(e);}for(const s of p)s.error&&P.error(s.error);opacityUtils.F(u,r,i),e&&"displayField"in t&&t.displayField&&opacityUtils.F(u,r,t.displayField);const f=Array.from(u).sort();this._set("requiredFields",f);}validateFetchPopupFeatures(e){if(request.t$1(e))return null;for(const t of e.clientGraphics){const i=t.layer;if("popupEnabled"in i&&!i.popupEnabled)return new request.s("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:i});if("popupTemplate"in i){if(!popupUtils.d(i,e))return new request.s("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:i})}}}async fetchClientPopupFeatures(e){const t=request.r(e)?e.clientGraphics:null;if(!t||0===t.length)return Promise.resolve([]);const r=[],i=[],o=await this.createPopupQuery(e);for(const a of t){const{layer:t}=a;if(!("popupEnabled"in t))continue;const l=opacityUtils.I(this.layer.fieldsIndex,o.outFields),n=popupUtils.d(t,e);if(!request.r(n))continue;const u=await this._loadArcadeModules(n);u&&u.arcadeUtils.hasGeometryOperations(n)||!opacityUtils.ce(l,a)?i.push(a):r.push(a);}return "stream"===this.layer.type||0===i.length?Promise.resolve(r):(o.objectIds=i.map((e=>e.attributes[this.layer.objectIdField])),this.layer.queryFeatures(o).then((e=>r.concat(e.features))).catch((()=>i)))}async createPopupQuery(e){const t=this.layer.createQuery(),r=new Set;let i=!1;const o=request.r(e)&&e.clientGraphics?e.clientGraphics.map((e=>e.layer)):[this.layer];for(const a of o){if(!("popupEnabled"in a))continue;const t=popupUtils.d(a,e);if(!request.r(t))continue;const o=await this._loadArcadeModules(t),l=o&&o.arcadeUtils.hasGeometryOperations(t);i=!("point"!==this.layer.geometryType&&!l);const n=await popupUtils.t(this.layer,t);for(const e of n)r.add(e);}if(t.returnGeometry=i,t.returnZ=i,t.returnM=i,t.outFields=Array.from(r),t.outSpatialReference=this.view.spatialReference,"feature"===this.layer.type){const e=floorFilterUtils.o(this);request.r(e)&&(t.where=t.where?`(${t.where}) AND (${e})`:e);}return t}canResume(){return !!super.canResume()&&(!request.r(this.timeExtent)||!this.timeExtent.isEmpty)}};return request.e([request.d()],O.prototype,"_updatingRequiredFieldsPromise",void 0),request.e([request.d({readOnly:!0})],O.prototype,"availableFields",null),request.e([request.d()],O.prototype,"effect",null),request.e([request.d({type:labelingInfo.a})],O.prototype,"featureEffect",null),request.e([request.d({type:labelingInfo.y})],O.prototype,"filter",void 0),request.e([request.d(OperationalLayer.g)],O.prototype,"timeExtent",void 0),request.e([request.d()],O.prototype,"layer",void 0),request.e([request.d({type:Number})],O.prototype,"maximumNumberOfFeatures",null),request.e([request.d({readOnly:!0,type:Boolean})],O.prototype,"maximumNumberOfFeaturesExceeded",null),request.e([request.d({readOnly:!0})],O.prototype,"requiredFields",void 0),request.e([request.d()],O.prototype,"suspended",void 0),request.e([request.d()],O.prototype,"view",void 0),O=request.e([request.i("esri.views.layers.FeatureLayerView")],O),O};

exports.O = O;
