'use strict';

const request = require('./messageBundle-8be88d04.js');
const unitUtils = require('./unitUtils-083cb8d0.js');
const LayerView3D = require('./LayerView3D-d92910a3.js');
const Scheduler = require('./Scheduler-72cbcf2a.js');

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const h=1.2;let u=class extends request.p{constructor(){super(...arguments),this.suspended=!1,this.extent=null,this.extentIntersectionDirty=!0,this._isVisibleBelowSurface=!1,this.handles=new request.u,this.layerView=null,this.updating=!0;}setup(e){this.layerView=e,this.extentIntersection=new LayerView3D.k({renderCoordsHelper:e.view.renderCoordsHelper});const t=e.view,s=t.basemapTerrain,r=t.resourceController.scheduler;this.handles.add([t.on("resize",(()=>this.viewChange())),t.state.watch("camera",(()=>this.viewChange()),!0),r.registerTask(Scheduler.f.FRUSTUM_VISIBILITY,this),s.on("elevation-bounds-change",(()=>this.elevationBoundsChange()))]),"local"===t.viewingMode?this.isVisibleBelowSurface=!0:this.handles.add([request.i$1(s,["opacity","wireframe"],(()=>this.updateIsVisibleBelowSurface())),request.i$1(t,"map.ground.navigationConstraint.type",(()=>this.updateIsVisibleBelowSurface()))]);}destroy(){this.layerView=null,this.extent=null,this.extentIntersection=null,this.handles&&(this.handles.destroy(),this.handles=null);}_setDirty(){this.updating||this._set("updating",!0);}setExtent(e){this.extent=e,this.extentIntersectionDirty=!0,this._setDirty();}viewChange(){this._setDirty();}elevationBoundsChange(){this._setDirty(),this.extentIntersectionDirty=!0;}set isVisibleBelowSurface(e){this._isVisibleBelowSurface=e,this._setDirty(),this.extentIntersectionDirty=!0;}updateIsVisibleBelowSurface(){const e=this.layerView.view,t=e.basemapTerrain,s="local"===e.viewingMode,i=e.map.ground&&e.map.ground.navigationConstraint&&"none"===e.map.ground.navigationConstraint.type;this.isVisibleBelowSurface=s||!t.opaque||i;}updateExtentIntersection(){if(!this.extentIntersectionDirty)return;this.extentIntersectionDirty=!1;const e=this.layerView.view;let t;if(this._isVisibleBelowSurface)t=-.3*unitUtils.p(e.spatialReference).radius;else {const{min:s,max:i}=e.basemapTerrain.elevationBounds;t=s-Math.max(1,(i-s)*(h-1));}this.extentIntersection.update(this.extent,e.spatialReference,t);}get running(){return this.updating}runTask(){if(this._set("updating",!1),!this.extent)return void this._set("suspended",!1);this.updateExtentIntersection();const e=this.layerView.view.frustum,t=unitUtils.p(this.layerView.view.spatialReference).radius;this._set("suspended",!this.extentIntersection.isVisibleInFrustum(e,t));}};request.e([request.d({readOnly:!0})],u.prototype,"suspended",void 0),request.e([request.d({readOnly:!0})],u.prototype,"updating",void 0),u=request.e([request.i("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],u);const c=u;

exports.c = c;
