'use strict';

const request = require('./messageBundle-8be88d04.js');
const Graphic = require('./Graphic-0aff6059.js');
const diffUtils = require('./diffUtils-df69757f.js');
const Query = require('./Query-354911d3.js');
const ColorMaterial = require('./ColorMaterial-61b9182b.js');
const Graphics3DScaleVisibility = require('./Graphics3DScaleVisibility-7783d850.js');
const Graphics3DObjectStates = require('./Graphics3DObjectStates-d741bf09.js');
const labelingInfo = require('./labelingInfo-594911d5.js');
const geometry = require('./geometry-ef17530a.js');
const QueryEngine = require('./QueryEngine-d6177b5a.js');
const FeatureSet = require('./FeatureSet-8efc5965.js');
const floorFilterUtils = require('./floorFilterUtils-a9b30733.js');
const Scheduler = require('./Scheduler-72cbcf2a.js');
const Graphics3DFrustumVisibility = require('./Graphics3DFrustumVisibility-760fbf68.js');
const attributeUtils = require('./attributeUtils-1a80ac17.js');
const HandleOwner = require('./HandleOwner-9c4c158c.js');

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const c=QueryEngine.V;let l=class extends request.p{constructor(e){super(e),this._dataQueryEngineInstance=null;}get queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return "polygon";default:return}}get defaultQueryJSON(){return new Query.b({outSpatialReference:this.spatialReference}).toJSON()}get dataQueryEngine(){return this.ensureDataQueryEngine()}destroy(){this.clear();}clear(){return !!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}async executeQueryForIdSet(e,r){return this.dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e),r)}async executeQueryForCount(e,r){return this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),r)}async executeQueryForExtent(e,r){const{count:t,extent:s}=await this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),r);return {count:t,extent:request.M.fromJSON(s)}}async executeQueryForIds(e,r){return this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),r)}async executeQueryForLatestObservations(e,r){const t=await this.dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),r),s=FeatureSet['default'].fromJSON(t);return s.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer;})),s}async executeQuery(e,r){const t=await this.dataQueryEngine.executeQuery(this._ensureQueryJSON(e),r),s=FeatureSet['default'].fromJSON(t);return s.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer;})),s}_ensureQueryJSON(e){return request.t$1(e)?this.defaultQueryJSON:("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),e.toJSON())}ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e="timeInfo"in this.layer&&this.layer.timeInfo&&this.layer.timeInfo.toJSON()||null,r=this.layer.objectIdField,t=geometry.i$1.toJSON(this.queryGeometryType),s=this.layer.fields.map((e=>e.toJSON())),a=this.layerView.view.resourceController.scheduler,n=this.priority,o=this.spatialReference.toJSON(),i=this.layerView.graphics3d.graphicsCore.featureStore,{hasZ:u,hasM:l}=this.layerView;return this._dataQueryEngineInstance=new c({hasZ:u,hasM:l,geometryType:t,fields:s,timeInfo:e,spatialReference:o,objectIdField:r,featureStore:i,scheduler:a,priority:n}),this._dataQueryEngineInstance}};request.e([request.d({constructOnly:!0})],l.prototype,"layerView",void 0),request.e([request.d({constructOnly:!0})],l.prototype,"priority",void 0),request.e([request.d({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],l.prototype,"spatialReference",void 0),request.e([request.d({readOnly:!0,aliasOf:"layerView.layer"})],l.prototype,"layer",void 0),request.e([request.d({readOnly:!0})],l.prototype,"queryGeometryType",null),request.e([request.d({readOnly:!0})],l.prototype,"defaultQueryJSON",null),l=request.e([request.i("esri.views.3d.layers.graphics.QueryEngine")],l);const p$1=l;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const p=request.s$1.getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility");let _=class extends request.p{constructor(...e){super(...e),this._dirty=!1,this._querying=!1,this._handles=new request.u;}get updating(){return this._dirty||this._querying||request.r(this._queryResult)}setup(e,i){this._layerView=e,this._core=i,this._objectIdField=e.layer.objectIdField,this._queryEngine=new p$1({layerView:this._layerView,priority:Scheduler.f.FILTER_VISIBILITY});const t=this._layerView.view.resourceController.scheduler;this._handles.add(t.registerTask(Scheduler.f.FILTER_VISIBILITY,this)),this._handles.add(request.$(i.owner,"loadedGraphics","after-changes",(e=>this._graphicsChanged(e)),(()=>this.dirty=!0))),this.filterChanged();}destroy(){this._handles.destroy(),this._handles=null,this.clear(),this._layerView=null,this._core=null;}clear(){this._queryEngine.clear()&&(this._core.modifyGraphics3DGraphicVisibilities((e=>e.clearVisibilityFlag(2))),this._queryResult=null,this._querying=!1),this.dirty=!1;}_graphicsChanged(e){this._queryEngine&&0==(1&e.type)||(this.dirty=!0);}updateVisibility(e){this.active&&(e.hasVisibilityFlag(2,0)||e.setVisibilityFlag(2,!1,0),this.dirty=!0);}filterChanged(){const e=this.recomputeFilter();e!==this._filter&&(this._filter=e,this.dirty=!0);}get active(){return this._filter&&this._core.graphics3DGraphics.size>0}recomputeFilter(){const e="filter"in this._layerView?this._layerView.filter:null,i="timeExtent"in this._layerView?this._layerView.timeExtent:null,t=floorFilterUtils.o(this._layerView);if(request.t$1(i)&&request.t$1(t))return e;const r=request.r(e)?e.clone():new labelingInfo.y;if(request.r(i)&&(r.timeExtent=request.r(r.timeExtent)?r.timeExtent.intersection(i):i),request.r(t)){const e=null==r.where||""===r.where;r.where=e?t:`(${r.where}) AND (${t})`;}return r}get running(){return this._dirty&&!this._querying||request.r(this._queryResult)}runTask(e){if(!this.active)return void this.clear();!this._dirty||this._querying||e.done||(this._querying=!0,this.dirty=!1,this._queryEngine.executeQueryForIdSet(this._filter).then((e=>{this._queryResult=e,this._querying=!1;})).catch((e=>{if(!request.d$1(e)){p.warn("FeatureFilter query failed: "+e,{error:e});const i=new Set;this._core.graphics3DGraphics.forEach((e=>i.add(this._getFeatureId(e.graphic)))),this._queryResult=i,this._querying=!1;}})),e.madeProgress());const i=this._queryResult;request.r(i)&&!e.done&&(this._core.modifyGraphics3DGraphicVisibilities((t=>{if(e.done)return !1;const r=i.has(this._getFeatureId(t.graphic));return !!t.setVisibilityFlag(2,r,0)&&(e.madeProgress(),!0)})),e.done||(this._queryResult=null));}_getFeatureId(e){return null==e.objectId?e.attributes[this._objectIdField]:e.objectId}set dirty(e){this._dirty=e;}};request.e([request.d({readOnly:!0})],_.prototype,"updating",null),request.e([request.d({readOnly:!0})],_.prototype,"running",null),request.e([request.d()],_.prototype,"_dirty",void 0),request.e([request.d()],_.prototype,"_querying",void 0),request.e([request.d()],_.prototype,"_queryResult",void 0),_=request.e([request.i("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],_);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let V=class extends request.p{constructor(t){super(t),this._handles=new request.u,this.watchUpdatingTracking=new HandleOwner.l,this.suspendResumeExtentMode="computed",this.dataExtent=null,this.suspendResumeExtent=null;}get suspended(){var t;return null==(t=this.scaleVisibility)?void 0:t.suspended}get suspendInfo(){var t,e;const i={};return null!=(t=this.scaleVisibility)&&t.suspended&&(i.outsideScaleRange=!0),null!=(e=this.frustumVisibility)&&e.suspended&&(i.outsideOfView=!0),i}get updating(){var t,e,i;return !!(null!=(t=this.graphicsCore)&&t.updating||null!=(e=this.frustumVisibility)&&e.updating||null!=(i=this.watchUpdatingTracking)&&i.updating)}normalizeCtorArgs(t){const e=t.frustumVisibilityEnabled?new Graphics3DFrustumVisibility.c:null,i=t.scaleVisibilityEnabled?new Graphics3DScaleVisibility.y:null,s=(t.filterVisibilityEnabled||t.timeExtentVisibilityEnabled)&&"multipatch"!==t.layer.geometryType?new _:null,r=t.elevationAlignmentEnabled?new Graphics3DObjectStates.d:null,n=new Graphics3DScaleVisibility.Ie({owner:t.owner,layer:t.layer,preferredUpdatePolicy:t.preferredUpdatePolicy,elevationFeatureExpressionEnabled:t.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:t.owner.hasZ,hasM:t.owner.hasM}),{updateClippingExtent:a,suspendResumeExtentMode:o,dataExtent:l}=t;return {graphicsCore:n,frustumVisibility:e,scaleVisibility:i,filterVisibility:s,elevationAlignment:r,updateClippingExtent:a,suspendResumeExtentMode:o,dataExtent:l}}initialize(){this.scaleVisibility&&this.watchUpdatingTracking.add(this.layer,"scaleRangeId",(()=>this.scaleVisibility.layerMinMaxScaleChangeHandler())),this.filterVisibility&&(this.watchUpdatingTracking.add(this.owner,"filter",(()=>this.filterVisibility.filterChanged())),this.watchUpdatingTracking.add(this.owner,"timeExtent",(()=>this.filterVisibility.filterChanged()))),this.elevationAlignment&&this.watchUpdatingTracking.add(this.layer,"elevationInfo",((t,e)=>{diffUtils.m(t,e)&&this.watchUpdatingTracking.addPromise(this.graphicsCore.elevationInfoChange());})),this.watchUpdatingTracking.add(this.layer,"labelsVisible",(()=>this.graphicsCore.updateVisibilityInfo())),this.watchUpdatingTracking.add(this.layer,"labelingInfo",((t,e)=>{diffUtils.m(t,e)&&this.graphicsCore.updateLabelingInfo();}));}async setup(){this.frustumVisibility&&this.frustumVisibility.setup(this.owner);const t=this.owner,e=this.owner.view.basemapTerrain,i=(t,e,i)=>this.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(t,e,i);if(this.scaleVisibility&&this.scaleVisibility.setup(t,this.layer,i,this.graphicsCore,e),this.filterVisibility&&("filter"in t||"timeExtent"in t)&&this.filterVisibility.setup(t,this.graphicsCore),this.elevationAlignment){const e=t.view.elevationProvider;this.elevationAlignment.setup(t,i,this.graphicsCore,e);}this._set("objectStates",new Graphics3DObjectStates.s(this.graphicsCore)),this._set("labeling",this.owner.view.labeler.addGraphicsOwner(this.graphicsCore,this.scaleVisibility)),this._set("deconfliction",t.view.deconflictor.addGraphicsOwner(this.graphicsCore)),await request.y$9(this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,filterVisibility:this.filterVisibility,deconflictor:this.deconfliction,labeler:this.labeling,objectStates:this.objectStates})),this.watchUpdatingTracking.add(this.layer,"renderer",(t=>this.watchUpdatingTracking.addPromise(this.graphicsCore.rendererChange(t)))),this.watchUpdatingTracking.add(t,"fullOpacity",(()=>this.graphicsCore.opacityChange())),this.setupSuspendResumeExtent(),this.updateClippingExtent&&(this.watchUpdatingTracking.add(t.view,"clippingArea",(()=>this._updateClippingExtent())),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&await request.y$9(this.graphicsCore.updateLabelingInfo());}destroy(){this._handles&&(this._handles.destroy(),this._handles=null);const t=["watchUpdatingTracking","frustumVisibility","scaleVisibility","filterVisibility","elevationAlignment","objectStates","graphicsCore"];for(const e of t){const t=this[e];t&&(t.destroy(),this._set(e,null));}this._set("layer",null),this._set("owner",null);}maskOccludee(t){const{set:e,handle:i}=this.objectStates.acquireSet(1,null);return this.objectStates.setUid(e,t.uid),i}highlight(t,i){if(t instanceof Query.b){const{set:e,handle:s}=this.objectStates.acquireSet(0,i);return this.owner.queryObjectIds(t).then((t=>this.objectStates.setObjectIds(e,t))),s}if("number"==typeof t||"string"==typeof t)return this.highlight([t],i);if(t instanceof Graphic.h)return this.highlight([t],i);if("toArray"in t&&(t=t.toArray()),Array.isArray(t)&&t.length>0){if(t[0]instanceof Graphic.h){const e=t;if(null==attributeUtils.n(this.layer.fieldsIndex,e[0].attributes,i)){const t=e.map((t=>t.uid)),{set:i,handle:s}=this.objectStates.acquireSet(0,null);return this.objectStates.setUids(i,t),s}t=e.map((t=>attributeUtils.n(this.layer.fieldsIndex,t.attributes,i)));}if("number"==typeof t[0]||"string"==typeof t[0]){const e=t,{set:s,handle:r}=this.objectStates.acquireSet(0,i);return this.objectStates.setObjectIds(s,e),r}}return S}_updateClippingExtent(){const t=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(t,this.owner.view.spatialReference)&&(this.updateClippingExtent(t)||this.graphicsCore.recreateAllGraphics());}setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this._handles.add(request.i$1(this,"suspendResumeExtentMode",(()=>{switch(this._handles.remove(j),this.suspendResumeExtentMode){case"computed":this._handles.add([request.i$1(this.graphicsCore,"computedExtent",(t=>this.updateSuspendResumeExtent(t))),this.graphicsCore.watch("extentPadding",(()=>this.updateSuspendResumeExtent(this.graphicsCore.computedExtent)))],j);break;case"data":this._handles.add([request.i$1(this,"dataExtent",(t=>this.updateSuspendResumeExtent(t))),this.graphicsCore.watch("extentPadding",(()=>this.updateSuspendResumeExtent(this.dataExtent)))],j);break;}})));}updateSuspendResumeExtent(t){t?this.suspendResumeExtentChanged(this.extentToSuspendResumeRect(t,this.suspendResumeExtent)):this.suspendResumeExtentChanged(null);}extentToSuspendResumeRect(t,e){const i=this.owner.view.spatialReference;if(!t.spatialReference.equals(i)){if(!request.g$3(t,i))return;t=request.M$2(t,i);}return ColorMaterial.F(t,e,ColorMaterial.r$6,this.graphicsCore.extentPadding)}suspendResumeExtentChanged(t){this.frustumVisibility&&this.frustumVisibility.setExtent(t),this.scaleVisibility&&this.scaleVisibility.setExtent(t);}};request.e([request.d({aliasOf:"graphicsCore.layer"})],V.prototype,"layer",void 0),request.e([request.d({aliasOf:"graphicsCore.owner"})],V.prototype,"owner",void 0),request.e([request.d({constructOnly:!0})],V.prototype,"updateClippingExtent",void 0),request.e([request.d({constructOnly:!0})],V.prototype,"graphicsCore",void 0),request.e([request.d({constructOnly:!0})],V.prototype,"scaleVisibility",void 0),request.e([request.d({constructOnly:!0})],V.prototype,"filterVisibility",void 0),request.e([request.d({constructOnly:!0})],V.prototype,"elevationAlignment",void 0),request.e([request.d({constructOnly:!0})],V.prototype,"frustumVisibility",void 0),request.e([request.d({readOnly:!0})],V.prototype,"deconfliction",void 0),request.e([request.d({readOnly:!0})],V.prototype,"labeling",void 0),request.e([request.d({readOnly:!0})],V.prototype,"objectStates",void 0),request.e([request.d({readOnly:!0})],V.prototype,"watchUpdatingTracking",void 0),request.e([request.d()],V.prototype,"suspendResumeExtentMode",void 0),request.e([request.d()],V.prototype,"dataExtent",void 0),request.e([request.d({readOnly:!0})],V.prototype,"suspended",null),request.e([request.d({readOnly:!0})],V.prototype,"suspendInfo",null),request.e([request.d({readOnly:!0,dependsOn:["graphicsCore.updating","frustumVisibility.updating","watchUpdatingTracking.updating"]})],V.prototype,"updating",null),V=request.e([request.i("esri.views.3d.layers.graphics.Graphics3DFeatureLikeLayerView")],V);const v=V,j="suspendResumeExtentMode",S={remove(){},pause(){},resume(){}};

exports.p = p$1;
exports.v = v;
