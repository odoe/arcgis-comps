import { r as registerInstance, c as createEvent, h as h$G, g as getElement } from './index-b157fcf2.js';
import { s as s$w, e as e$x, d as d$y, i as i$H, a1 as a$O, a2 as o$B, a3 as r$y, D as l$A, a0 as k$l, A as r$A, aW as c$N, _ as M$g, aE as b$m, a8 as R$h, c as s$y, af as t$F, bE as B$f, ar as M$h, aJ as g$u, T as T$f, bu as p$M, V as e$z, p as p$N, aT as S$n, S as S$o, f as c$P, ah as b$n, ao as v$s, b as d$B, bT as s$z, n as n$I, u as u$D, I as z$k, a5 as a$S, a6 as d$C, Z as U$c, ac as bt$2, c5 as o$E, r as n$L, aK as r$I, aP as s$A, bs as s$B, cc as s$C, cs as h$w, ct as i$M, ai as l$E, $ as $$9, cq as a$X, bF as G$g, bo as s$E, a as i$P, cu as F$e, cv as n$T, cw as g$w, bp as o$I, bG as C$g, ca as A$l, aF as L$h, bx as n$W, cx as t$U, cy as r$R, ax as m$D, K as s$H, cg as n$Z, aN as n$_, bK as e$J, h as h$B, aw as p$T, ap as j$t, cz as u$G, ce as e$L, cA as y$z, k as a$11, cB as l$L, aI as A$n, cC as u$H, cD as wt$1, b9 as v$v, bU as h$D, q as d$K, bO as e$P, bI as c$_, bv as m$F, cj as k$q, C as l$N, cE as c$11, o as o$T, cF as n$18, cG as t$$, c1 as t$11, c2 as e$W, ck as q$l, cH as s$Z, cI as p$10, cl as e$_, cJ as h$F, aU as O$q, m as a$1c, cK as F$i, bN as r$1c, cp as n$1h, by as e$10, B as r$1d, ad as t$1a } from './messageBundle-f75b4090.js';
import { A as A$j, j as j$q, n as n$X, c as t$V, y as r$T, i as i$U, s as s$I, z as o$K, d as t$Y, u as u$E, g as n$Y, o as o$L, m as s$K, p as s$L, q as e$I, B as s$P, U as U$e, C as n$1b, D as r$17, r as u$U, v as m$J, a as a$1e, x as s$10, P as P$p } from './DefaultUI-022795b8.js';
import { u as u$z, d as d$A } from './Viewpoint-f60966b5.js';
import { n as n$H, t as t$H, m as m$B, B as B$h } from './Portal-c5cfa317.js';
import { n as n$J } from './loadAll-9b2a160e.js';
import { l as l$C, O as O$l } from './MultiOriginJSONSupport-cb4804f4.js';
import { r as r$G } from './originUtils-a479af22.js';
import { v as v$t } from './HeightModelInfo-1a6d7a08.js';
import { w as wn, b as gn, R as Rn, O as O$k, x as xn, v as vn, t as tn, $ as $n, c as En, j as jn, d as bn, u as un, n as ne$3 } from './projection-f3d8779d.js';
import { r as r$H } from './heightModelInfoUtils-b573abf5.js';
import { d as d$D } from './jsonUtils-13b1f6fd.js';
import b$p from './PortalItem-155284f3.js';
import { a as i$G, i as i$J, l as l$D, b as i$L, n as n$M, c as a$$, d as w$n, E as E$k, w as w$o, s as s$Q, T as T$g, e as e$O, f as b$t, p as p$X, g as e$Q, V as V$d, h as s$S, r as r$X, j as E$m, S as S$r, o as o$R, k as r$Z, m as j$u, t as t$_, y as y$B, q as T$i, u as h$E, L as L$l, v as g$z, H as H$l, x as d$N, M as M$k, I as I$l, z as a$17, A as u$O, B as f$F, C as C$j, D as x$w, F as M$l, G as v$x, J as m$H } from './Viewing-639f1e51.js';
import { a as a$T } from './saveUtils-503e6a55.js';
import { h as h$s } from './Color-d1b9b54f.js';
import { r as r$z } from './enumeration-d3301938.js';
import { s as p$J, t as o$M, L as L$j, u as S$q, v as y$A } from './symbols-b414aa72.js';
import { x as x$q } from './Basemap-409fdf8e.js';
import { a as a$P, n as n$$ } from './asyncUtils-fe35d349.js';
import { d as d$z, s as s$x, u as u$A, r as r$B, g as x$p, c as c$O, z as z$i, a as j$p, _ as _$f, m as m$z, l as l$B, I as I$g, M as M$f, b as b$l, v as v$r, q as q$g, S as S$l, o as o$C, L as L$g, e as e$B, G as G$f, h as r$P, i as p$Q, k as s$F, y as y$v, H as H$j, f as y$w, n as l$I, t as a$_, F as F$g, X as X$9, A as s$R, B as a$14, Y as Y$b, P as P$o, C as f$G, D as l$T, J as J$e, T as T$j, E as D$k, K as I$m, N as j$x, O as I$n } from './mathUtils-e16f9389.js';
import { n as n$F, r as r$D, b as t$G, f as f$y, e as e$N, i as i$10, u as u$P } from './common-d5b993de.js';
import { b as b$o } from './Layer-b50ea610.js';
import { u as u$C } from './OperationalLayer-d609e521.js';
import { y as y$u, p as p$O } from './basemapUtils-d3dee4db.js';
import { F as F$c, P as P$k, U as U$b, p as p$P, I as I$i, w as w$l, q as q$i, S as S$p, x as x$u, d as d$R } from './mathUtils-8e5ad7fe.js';
import './geometry-7e07b1ba.js';
import { h as h$t } from './Graphic-3961df6c.js';
import { a as a$Q, o as o$D, p as p$_, f as f$H, u as u$S, n as n$1c } from './mat3-6a23d9ad.js';
import { e as e$A, a as e$S } from './quatf64-b9feea68.js';
import { e as e$y, r as r$Q, a as a$16 } from './mat4f64-677a419d.js';
import { B as B$g, p as p$L, S as S$m, G as G$e, h as h$u, f as f$t, a as a$R, I as I$h, N as N$j, y as y$t, v as v$w, u as u$L, A as A$p, x as x$v } from './aaBoundingBox-876621e6.js';
import { b as b$j, D as D$g, u as u$B, m as m$C, B as B$i, d as d$J, h as h$A, k as k$o, s as s$M, l as l$J, a as a$10, o as o$N, R as R$j, f as f$B, p as p$V, c as c$Y, G as G$i, M as M$i, E as E$l, q as q$k, g as g$A } from './aaBoundingRect-9468599b.js';
import { y as y$s, i as i$I, z as z$j, e as e$C, P as P$l, c as c$R, o as o$J, a as i$R, b as c$S, J as J$d, I as I$j, W as W$c, d as c$W, n as n$10, f as b$q, g as y$x, w as w$m, x as x$t, O as O$o, R as R$i, q as q$j, C as C$i, t as t$Z, K as K$e, h as c$Z, j as n$13, A as A$o, k as a$15, l as n$16, s as se$4, m as i$11, S as S$s, p as d$O, r as l$Q, u as l$R, v as e$V, B as i$14, D as o$Y, E as e$$, F as t$15, G as r$19, _ as _$i, H as u$T, L as m$I, M as s$_, N as s$$, Q as n$1f, T as n$1g, U as r$1b } from './ColorMaterial-cf44e08d.js';
import { p as p$K, d as O$m, H as H$k } from './unitUtils-38774114.js';
import { i as i$K } from './scaleUtils-70512275.js';
import { r as r$C, m as m$A, b as b$k, f as f$s, n as n$K, h as h$x, Q as Q$d, F as F$d, e as e$G, l as l$H, c as c$U, s as s$O, E as E$n, C as C$k } from './mat4-f34c6460.js';
import { f as f$u, C as C$h, D as D$j, R as R$l } from './Scheduler-3464f717.js';
import { c as c$Q } from './Thumbnail-cf2b8bad.js';
import { r as r$E, c as n$G } from './opacityUtils-5e864561.js';
import { r as r$F } from './Version-9295fea2.js';
import { c as c$14 } from './workers-c4ad1958.js';
import { i as i$S, d as d$H, x as x$r, c as c$X, p as p$U, s as s$W } from './screenUtils-9bb7e30c.js';
import { J as J$c, _ as _s, c as cs, G as G$h, D as D$i, l as ls, H as H$m, z as z$m } from './boundedPlane-030abe8d.js';
import { O as O$n, Z as Z$8, f as f$v, j as j$r, U as U$d, q as q$h, F as F$f, k as k$m, d as d$G, P as P$m, I as I$k, L as L$i, i as i$_, E as E$o } from './sphere-c3d60863.js';
import { i as i$T, d as d$I, u as u$F, _ as _$j, a as i$1a, c as c$15 } from './screenUtils-49015526.js';
import { h as h$v } from './ElevationSampler-301a577f.js';
import { n as n$P, r as r$L, e as e$H, _ as _$g, t as t$16 } from './vec4f64-2ec4ac08.js';
import { i as i$Q, p as p$R } from './reactiveUtils-8f9c3a3d.js';
import { o as o$H, n as n$U, r as r$S } from './styleUtils-cb28c5ef.js';
import { r as r$K, d as d$F, a as a$Y, o as o$P, s as s$Y, l as l$W, _ as _$h, j as j$y, x as x$y, v as v$y, q as q$n } from './vec2-5672471e.js';
import { n as n$Q, t as t$Q, f as f$D } from './vec2f64-35868783.js';
import { t as t$I, n as n$R, a as n$S, x as x$s, u as u$M, l as l$O, b as l$U, i as i$15, d as d$P, c as l$V, e as u$Q, f as t$10, r as r$14, g as n$19, h as a$19, j as r$16, k as i$18 } from './objectResourceUtils-46d77106.js';
import { n as n$N, t as t$J, a as a$U, e as e$D, b as t$K, c as t$L, d as n$O, o as o$F, f as t$M, i as i$N, s as s$D, g as t$N, h as e$F, j as a$V, r as r$N, k as t$S, l as f$z, m as b$s, p as i$Z, q as r$W, O as O$p, T as T$h, L as L$k, u as u$K, v as f$E, w as c$10, x as e$R, y as r$_, z as s$U, A as d$M, B as B$j, C as r$$, M as M$j, D as j$w, E as A$q, F as r$12, G as a$18, H as r$13, I as o$V, J as r$15, K as t$12, N as g$B, P as f$I, Q as o$W, R as c$13, S as d$Q, U as i$17, V as o$_, W as l$X, X as t$13, Y as a$1b, Z as g$C } from './Texture-1e5e4be2.js';
import { g as g$v, e as e$E, r as r$J, t as t$O, i as i$O, a as t$R, l as l$P, u as u$R, c as c$12, s as s$V, b as a$1a, d as i$16 } from './OrderIndependentTransparency-3e6c26be.js';
import { w as w$p, F as F$h } from './quat-2d7a417b.js';
import { r as r$M, f as f$x, c as c$T } from './vectorStacks-9205ea46.js';
import { a as a$W, t as t$P, r as r$10, e as e$T, n as n$1a } from './vec3f32-109cf143.js';
import { l as l$F, r as r$O, f as f$w, h as h$y, n as n$15, e as e$X } from './FramebufferObject-3d2e79da.js';
import { o as o$G } from './Texture-f0375c04.js';
import { t as t$T } from './glUtil-240efd97.js';
import { A as A$k } from './InterleavedLayout-4358b016.js';
import { d as d$E, i as i$13, q as q$m, f as f$J, v as v$z, D as D$l } from './Util-68fde664.js';
import { l as l$G } from './HandleOwner-88326c19.js';
import { j as j$s, i as i$V, c as c$V, s as s$N, a as i$W, r as r$U, e as e$K, k as k$p, b as e$M, o as o$O, d as a$12, p as p$W, f as o$X } from './LayerView3D-ad87e12d.js';
import { n as n$V } from './compilerUtils-848c8917.js';
import { k as k$n, D as D$h, p as p$S, v as v$u, W as W$b, z as z$l, A as A$m, P as P$n, y as y$y, R as R$k } from './plane-f3c19202.js';
import { m as m$E, s as s$G, g as g$x, o as o$Z } from './CameraSpace.glsl-6a9b6d21.js';
import { t as t$W, a as t$X, s as s$J, b as a$Z, h as h$z, o as o$S, c as s$X, d as o$10 } from './RenderingContext-c805bbcc.js';
import { createLabelFunction as f$A } from './labelFormatUtils-4a5ae67f.js';
import { l as l$K, n as n$11 } from './DefaultMaterial_COLOR_GAMMA-f230b01e.js';
import { b as b$r, l as l$S } from './geometryDataUtils-7e4c8d4a.js';
import { g as g$y, j as j$v, o as o$U, T as T$k } from './intersectorUtils-8d04b3d1.js';
import { r as r$V, n as n$1d } from './vec4f32-d544d091.js';
import { getGeometryServiceURL as i$X } from './geometryServiceUtils-ba2d6c3e.js';
import { a as a$13, n as n$12 } from './project-a5d2456b.js';
import { h as h$C, i as i$Y } from './MemCache-78a9f000.js';
import { p as p$Y } from './CollectionFlattener-2d3512bc.js';
import { p as p$Z } from './RefreshableLayer-f4d1c27c.js';
import { n as n$17 } from './LercDecoder-35d1826d.js';
import { d as d$L, u as u$N } from './VectorTile-7c020d07.js';
import { u as u$I } from './LayerView-f319a853.js';
import { i as i$$, o as o$Q, s as s$T, l as l$M, f as f$C, n as n$14, r as r$Y, u as u$J, m as m$G, c as c$$ } from './rasterUtils-da611f50.js';
import { i as i$12, x as x$x } from './BufferView-35ef10d7.js';
import { r as r$11, e as e$U } from './quatf32-a39c89f4.js';
import { r as r$18, o as o$$ } from './floatRGBA-7e1629d8.js';
import { e as e$Z } from './vec33-df10f43c.js';
import { p as p$$, f as f$K, D as D$m, i as i$19, t as t$14, d as d$S, w as w$q, e as e$Y } from './EdgeProcessingWorker-7a107dc2.js';
import { n as n$1e } from './WorkerHandle-a0a39e87.js';
import { a as a$1d, f as f$L, d as d$T, o as o$11, c as c$16 } from './screenshotUtils-f9728729.js';
import { t as t$17, r as r$1a } from './capabilities-ffdc19e3.js';
import { t as t$18 } from './hitTestSelectUtils-779b69ca.js';
import { t as t$19 } from './layerViewUtils-4127a8cf.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const r$x="webscene:failed-to-copy-embedded-resources",o$A="webscene:schema-validation";function n$E(){return new s$w(r$x,"Copying of embedded resources is currently not supported")}function s$v(r){return new s$w(o$A,"Failed to save webscene due to schema validation errors. See 'details.errors' for more detailed information",{errors:r})}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var i$F;let p$I=i$F=class extends a$O{constructor(r){super(r),this.viewing=null;}clone(){return new i$F({viewing:this.viewing?this.viewing.clone():null})}};e$x([d$y({type:i$G,json:{write:!0}})],p$I.prototype,"viewing",void 0),p$I=i$F=e$x([i$H("esri.webscene.ApplicationProperties")],p$I);const c$M=p$I;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var d$x;let i$E=d$x=class extends a$O{constructor(e){super(e),this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null;}readDate(e,t){return null!=t.datetime&&new Date(t.datetime)||null}writeDate(e,t,r){t[r]=e.getTime();}readDirectShadowsEnabled(e,t){return !!t.directShadows}writedirectShadowsEnabled(e,t,r){e&&(t[r]=e);}writeDisplayUTCOffset(e,t){null!=e&&(t.displayUTCOffset=e);}clone(){return new d$x(this.cloneConstructProperties())}cloneConstructProperties(){const e={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:null!=this.displayUTCOffset?this.displayUTCOffset:null};return null!=this.date&&(e.date=new Date(this.date.getTime())),e}};e$x([d$y({type:Date,json:{type:Number,write:{target:"datetime"}}})],i$E.prototype,"date",void 0),e$x([o$B("date",["datetime"])],i$E.prototype,"readDate",null),e$x([r$y("date")],i$E.prototype,"writeDate",null),e$x([d$y({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],i$E.prototype,"directShadowsEnabled",void 0),e$x([o$B("directShadowsEnabled",["directShadows"])],i$E.prototype,"readDirectShadowsEnabled",null),e$x([r$y("directShadowsEnabled")],i$E.prototype,"writedirectShadowsEnabled",null),e$x([d$y({type:Number,json:{write:!0}})],i$E.prototype,"displayUTCOffset",void 0),e$x([r$y("displayUTCOffset")],i$E.prototype,"writeDisplayUTCOffset",null),i$E=d$x=e$x([i$H("esri.webscene.Lighting")],i$E);const p$H=i$E;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let t$E=class extends a$O{constructor(r){super(r);}clone(){}};e$x([d$y({readOnly:!0,json:{read:!1}})],t$E.prototype,"type",void 0),t$E=e$x([i$H("esri.webscene.background.Background")],t$E);const c$L=t$E;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var l$z;const a$N={...p$J,nonNullable:!0};let i$D=l$z=class extends c$L{constructor(o){super(o),this.type="color",this.color=new h$s([0,0,0,1]);}clone(){return new l$z(this.cloneProperties())}cloneProperties(){return {color:this.color.clone()}}};e$x([r$z({color:"color"},{readOnly:!0})],i$D.prototype,"type",void 0),e$x([d$y(a$N)],i$D.prototype,"color",void 0),i$D=l$z=e$x([i$H("esri.webscene.background.ColorBackground")],i$D);const n$D=i$D;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const o$z={base:c$L,key:"type",typeMap:{color:n$D}};function t$D(e){return (r,o,t)=>{if(!r)return r;for(const n in e.typeMap)if(r.type===n){const o=new e.typeMap[n];return o.read(r,t),o}}}const n$C={types:o$z,json:{read:t$D(o$z),write:{overridePolicy:(e,r,o)=>({enabled:!o||!o.isPresentation})}}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var a$M;const p$G=(o,e,r)=>({enabled:!r||!r.isPresentation});let l$y=a$M=class extends a$O{constructor(o){super(o),this.lighting=new p$H,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0;}clone(){return new a$M(this.cloneConstructProperties())}cloneConstructProperties(){return {lighting:p$H.prototype.clone.call(this.lighting),background:l$A(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled}}};e$x([d$y({type:p$H,json:{write:!0}})],l$y.prototype,"lighting",void 0),e$x([d$y(n$C)],l$y.prototype,"background",void 0),e$x([d$y({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:p$G}}})],l$y.prototype,"atmosphereEnabled",void 0),e$x([d$y({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:p$G}}})],l$y.prototype,"starsEnabled",void 0),l$y=a$M=e$x([i$H("esri.webscene.Environment")],l$y);const c$K=l$y;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var p$F;let c$J=p$F=class extends a$O{constructor(e){super(e),this.environment=new c$K,this.spatialReference=null,this.viewpoint=null;}set viewingMode(e){this._set("viewingMode",e);}clone(){return new p$F({environment:this.environment.clone(),spatialReference:this.spatialReference?this.spatialReference.clone():null,viewingMode:this.viewingMode,viewpoint:this.viewpoint?this.viewpoint.clone():null})}};e$x([d$y({type:c$K,json:{write:{isRequired:!0}}})],c$J.prototype,"environment",void 0),e$x([d$y({type:k$l})],c$J.prototype,"spatialReference",void 0),e$x([d$y({type:["local","global"]})],c$J.prototype,"viewingMode",null),e$x([d$y({type:u$z,json:{write:{isRequired:!0}}})],c$J.prototype,"viewpoint",void 0),c$J=p$F=e$x([i$H("esri.webscene.InitialViewProperties")],c$J);const l$x=c$J;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function p$E(r,n,t,o){return r$A(r.renderCoordsHelper.fromRenderCoords(n.eye,j$o,o))&&b$j(t,j$o)}function m$y(e,n){return e.elevationProvider?c$N(e.elevationProvider.getElevation(n[0],n[1],n[2],e.renderCoordsHelper.spatialReference,"ground"),0):0}function g$t(e,r,a,c){const l=e.state.camera.clone();r&&(l.eye=r,l.center=a,l.up=c),v$q(e,l.ray,w$k)||r$B(w$k,l.center);const d=e.state.constraints,u=d.minimumPoiDistance;if(x$p(l.eye,w$k)<u){const r=d.collision.enabled;r$B(H$i,l.viewForward),d$z(H$i,H$i,u),r?l.eye=c$O(j$o,w$k,H$i):u$A(w$k,l.eye,H$i);const t=e.renderCoordsHelper,a=t.getAltitude(l.eye),c=d.collision.elevationMargin;r&&a<c&&(c$O(H$i,w$k,l.eye),l.eye=t.setAltitude(j$o,c,l.eye),u$A(w$k,l.eye,H$i));}return l.center=w$k,l}function y$r(e,r,n){if(!e.state.isGlobal)return !1;const o=m$y(e,r),i=e.stateManager.constraintsManager.nearFarHeuristic,{far:s}=i.compute(r,n,e.renderDataExtent,o,C$f),a=s*s;return x$p(r,n)>a}function v$q(e,r,n){let t=M$e[e.viewingMode];t||(t=new y$s(e.state.viewingMode),t.options.backfacesTerrain=!e.state.isGlobal,t.options.invisibleTerrain=!0,M$e[e.viewingMode]=t);const{isGlobal:o}=e.state;return !(!e.sceneIntersectionHelper.intersectRay(r,t,n)||y$r(e,r.origin,n))||(!(!e.renderCoordsHelper.intersectManifold(r,0,n)||y$r(e,r.origin,n))||!!o&&b$i(r,n,p$K(e.spatialReference).radius))}function b$i(e,r,n){const t=z$i(e.origin,e.origin)-n*n,i=t>0?Math.sqrt(t)/3:1;return d$z(r,e.direction,i/s$x(e.direction)),u$A(r,r,e.origin),!0}const M$e={},j$o=n$F(),w$k=n$F(),H$i=n$F(),C$f={near:0,far:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const l$w=n$F(),u$y=n$F();function h$r(){return {direction:n$F(),up:n$F()}}function m$x(f,h,m,p,d){let g=j$p(l$w,f),j=z$i(g,p);const b=j>0;j=Math.abs(j),j>.99&&(j=Math.abs(z$i(h,p)),j<.99?(r$B(g,h),b&&d$z(g,g,-1)):g=null);let k=0;if(g){d$z(u$y,p,z$i(p,g)),c$O(g,g,u$y);const n=z$i(g,d)/(s$x(g)*s$x(d));_$f(u$y,g,d);k=(z$i(u$y,p)>0?1:-1)*m$z(l$B(n));}const v=m$z(l$B(-z$i(p,f)/s$x(f)));return m?(m.heading=k,m.tilt=v,m):{heading:k,tilt:v}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const j$n=r$D(0,1,0),y$q=r$D(0,0,1),g$s=e$y(),x$o=n$F(),h$q=n$F();function R$g(t,n,c,m=h$r()){r$C(g$s);const{direction:f,up:p}=m;return m$A(g$s,g$s,-M$f(n)),b$k(g$s,g$s,M$f(c)),I$g(f,y$q,g$s),d$z(f,f,-1),I$g(p,j$n,g$s),m}function _$e(t,e,o,r){return m$x(e,o,r,y$q,j$n)}function v$p(t,e,o,r){const i=R$g(t,o,r),n=n$F();return d$z(n,i.direction,-e),u$A(n,n,t),{up:i.up,eye:n,heading:o,tilt:r}}function E$j(e){return m$z(e)}function H$h(t){return M$f(t)}function U$a(t,e,o,r,i){const n=t.renderSpatialReference,a=t.map&&t.spatialReference||e.spatialReference;return wn(e,x$o,n),wn(e,h$q,n),x$o[0]-=o/2,h$q[0]+=o/2,x$o[1]-=r/2,h$q[1]+=r/2,gn(x$o,n,x$o,a),gn(h$q,n,h$q,a),i?(i.xmin=x$o[0],i.ymin=x$o[1],i.xmax=h$q[0],i.ymax=h$q[1],i.spatialReference=a):i=new M$g(x$o[0],x$o[1],h$q[0],h$q[1],a),i}const b$h=Object.freeze({__proto__:null,headingTiltToDirectionUp:R$g,directionToHeadingTilt:_$e,eyeForCenterWithHeadingTilt:v$p,lookAtTiltToEyeTilt:E$j,eyeTiltToLookAtTilt:H$h,toExtent:U$a});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function s$u(t,n,o){return u$x(t,n.longitude,n.latitude,o.longitude,o.latitude)}function u$x(t,r,e,s,u){const i=M$f(e),c=M$f(u),a=i-c,h=M$f(r)-M$f(s),d=Math.sin(a/2),f=Math.sin(h/2),m=2*b$l(Math.sqrt(d*d+Math.cos(i)*Math.cos(c)*f*f))*t;return Math.round(1e4*m)/1e4}function i$C(t,n,o){const u=n.spatialReference,i=p$K(u),c=new b$m(n.x,t.y,u),a=new b$m(o.x,t.y,u),h=new b$m(t.x,n.y,u),d=new b$m(t.x,o.y,u);return {lon:s$u(i.radius,c,a),lat:s$u(i.radius,h,d)}}function c$I(r,e,s){const u=e/s,i=M$f(r),c=Math.sin(u/2),a=Math.cos(i),h=2*b$l(Math.sqrt(c*c/(a*a)));return m$z(h)}function d$w(t,n){let o=t/15;return n||(o=Math.round(o)),o}function m$w(t,n){n||(n={hours:0,minutes:0,seconds:0}),n.hours=d$w(t[0],!0);const o=n.hours%1;n.hours-=o,n.minutes=60*o;const r=n.minutes%1;return n.minutes-=r,n.seconds=Math.round(60*r),n}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const w$j=r$D(0,0,1),I$f=j$p(n$F(),r$D(1,1,1)),U$9=new P$k(-180,180),v$o=e$y(),P$j=n$F(),q$f=n$F();function E$i(e,a,i,f=h$r()){_$f(P$j,e,w$j),0===z$i(P$j,P$j)&&_$f(P$j,e,I$f),r$C(v$o),f$s(v$o,v$o,-M$f(a),e),f$s(v$o,v$o,-M$f(i),P$j);const{up:p,direction:h}=f;return _$f(p,P$j,e),j$p(p,p),I$g(p,p,v$o),j$p(h,e),v$r(h,h),I$g(h,h,v$o),f}function _$d(t,e,a,o){const s=P$j,i=q$f;return j$p(s,t),_$f(q$f,s,w$j),0===z$i(q$f,q$f)&&_$f(q$f,s,I$f),_$f(i,q$f,s),m$x(e,a,o,s,i)}function H$g(e,o,s,i){const n={eye:n$F(),up:null,tilt:i,heading:s},r=P$j;r[0]=e[0],r[1]=e[2],r[2]=-e[1];const c=o,l=M$f(s),m=M$f(i),h=Math.sin(l),y=Math.cos(l),M=Math.sin(m),d=Math.cos(m),j=s$x(r);let T;if(Math.abs(m)<1e-8)T=c+j;else {const t=j/M,e=b$l(c/t),o=Math.PI-m-e;T=t*Math.sin(o);}const g=d*c,R=c*c*(M*M),x=y*y*R,b=T-g,w=b*b,I=x*(x+w-r[1]*r[1]);if(I<0)return d$z(n.eye,r,T/j),n.tilt=0,n;const U=Math.sqrt(I),v=r[1]*b,q=x+w;let E;if(E=y>0?-U+v:U+v,Math.abs(q)<1e-8)return j<1e-8?(n.eye[0]=0,n.eye[1]=0,n.eye[2]=c):d$z(n.eye,r,T/j),n.tilt=0,W$a(n.eye),k$k(n,e);n.eye[1]=E/q;const _=h*h*R,H=M*c,z=y*H*n.eye[1],A=n.eye[1]*n.eye[1],G=1-A,S=Math.sqrt(G),C=x*A+_-2*z*S*b+G*w;return Math.abs(C)<1e-8?(d$z(n.eye,r,T/j),n.tilt=0,W$a(n.eye),k$k(n,e)):(n.eye[0]=(G*(T*r[0]-g*r[0])-H*S*(r[0]*n.eye[1]*y+r[2]*h))/C,n.eye[2]=(G*(T*r[2]-g*r[2])-H*S*(r[2]*n.eye[1]*y-r[0]*h))/C,d$z(n.eye,n.eye,T),W$a(n.eye),k$k(n,e))}function W$a(t){const e=t[1];t[1]=-t[2],t[2]=e;}function k$k(t,e){const a=E$i(e,t.heading,t.tilt);return t.up=a.up,t}function z$h(t,o,s){const i=s$x(o),n=Math.sqrt(s*s+i*i-2*s*i*Math.cos(Math.PI-t)),r=b$l(s/(n/Math.sin(t)));return m$z(t-r)}function A$i(e,o,s){const i=M$f(e),n=s$x(o);return b$l(s/(n/Math.sin(i)))+i}function G$d(a,o,s,i,n){let r,c,l,m;const f=o.latitude,p=o.longitude,h=c$I(f,s,p$K(a.spatialReference).radius)/2;r=p-h,c=p+h;const u=M$f(f),T=p$K(a.spatialReference).radius,g=(1+Math.sin(u))/(1-Math.sin(u)),x=(g+1)*Math.tan(i/T/2),w=x*x;function I(t){const e=Math.PI/2;return (t=F$c.normalize(t,-e))>e&&(t=Math.PI-t),t}if(l=1.5*Math.PI-2*Math.atan(.5*(x+Math.sqrt(4*g+w))),m=l+i/T,l=I(l),m=I(m),m<l){const t=m;m=l,l=t;}if(l=Math.max(m$z(l),-90),m=Math.min(m$z(m),90),c=U$9.monotonic(r,c),c-r>180){const t=(c-r-180)/2;r+=t,c-=t;}const v=a.spatialReference&&a.spatialReference.isGeographic?a.spatialReference:k$l.WGS84;return n?(n.xmin=r,n.ymin=l,n.xmax=c,n.ymax=m,n.spatialReference=v):n=new M$g(r,l,c,m,v),a.spatialReference&&a.spatialReference.isWebMercator&&R$h(n,!1,n),n}const S$k=Object.freeze({__proto__:null,headingTiltToDirectionUp:E$i,directionToHeadingTilt:_$d,eyeForCenterWithHeadingTilt:H$g,lookAtTiltToEyeTilt:z$h,eyeTiltToLookAtTilt:A$i,toExtent:G$d});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const k$j=s$y.getLogger("esri.views.3d.support.cameraUtils"),A$h=39.37,I$e=96,L$f=1,q$e=8,E$h=5,F$b=1,G$c=n$F(),O$j=n$F(),W$9={heading:0,tilt:0},X$8=new b$m,D$f=new P$k(-20037508.342788905,20037508.342788905),Y$a=new P$k(-180,180);function N$i(e){return e.spatialReference||k$l.WGS84}function Z$7(e){return "global"===e.viewingMode?S$k:b$h}function B$e(e,t,n,r,i){return Z$7(e).headingTiltToDirectionUp(t,n,r,i)}function J$b(e,t){if(t$F(t))return null;const r=e.renderSpatialReference,o=Z$7(e).headingTiltToDirectionUp,a=n$F();if(!wn(t.position,a,r))return null;const s=o(a,t.heading,t.tilt);d$z(s.direction,s.direction,e.state.camera.distance),u$A(s.direction,s.direction,a);const f=g$t(e,a,s.direction,s.up);return f.fov=M$f(t.fov),f}const K$d=n$F();function Q$c(t,n,o){const a=t.renderSpatialReference,s=te$3(t,n.eye,n.viewForward,n.up,W$9);let l=N$i(t);return gn(n.eye,a,K$d,l)||(l=k$l.WGS84,gn(n.eye,a,K$d,l)),t$F(o)?new d$A(new b$m(K$d,l),s.heading,s.tilt,m$z(n.fov)):(o.position.x=K$d[0],o.position.y=K$d[1],o.position.z=K$d[2],o.position.spatialReference=l,o.heading=s.heading,o.tilt=s.tilt,o.fov=m$z(n.fov),o)}function V$c(e,t,r){const i=e.state.camera,o=i.width/2/i.pixelRatio;1===e.renderCoordsHelper.viewingMode&&null!=r&&(t*=Math.cos(M$f(r))),t/=e.renderCoordsHelper.unitInMeters;return o/(I$e*A$h/t)/Math.tan(i.fovX/2)}function $$8(e,t,r){const i=e.state.camera,o=t*Math.tan(i.fovX/2),a=i.width/2/i.pixelRatio;let s=I$e*A$h/(a/o);return 1===e.renderCoordsHelper.viewingMode&&(s/=Math.cos(M$f(r))),s*=e.renderCoordsHelper.unitInMeters,s}function _$c(e,t,n,r,i,o){return ee$3(e,t,V$c(e,n,t.latitude),r,i,o)}function ee$3(e,t,n,r,o,a){if(we$1(a)){const s=new je$1(a.signal);return ae$2(e,r.heading,r.tilt,t,n,o,s),void s.resolver.promise.then((t=>{const n=ge$1(e,t,r.fov);if(!t$F(n))return a.resolver.resolve(n);a.resolver.reject();}),(e=>a.resolver.reject(e)))}const s=ae$2(e,r.heading,r.tilt,t,n,o);return ge$1(e,s,r.fov,a)}function te$3(e,t,n,r,i){return Z$7(e).directionToHeadingTilt(t,n,r,i)}function ne$2(e,t){return !!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,X$8,e.spatialReference)&&c$N(i$I(e.elevationProvider,X$8),0)>X$8.z-F$b)}async function re$2(e,t,n){if(!e.renderCoordsHelper.fromRenderCoords(t,X$8,e.spatialReference))return !1;const r=await e.elevationProvider.queryElevation(X$8.x,X$8.y,X$8.z,X$8.spatialReference,"ground",n);return c$N(r,0)>X$8.z-F$b}async function ie$2(e,t,n){const r=n$F();if(t)if(t instanceof b$m){if(wn(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const i=await e.elevationProvider.queryElevation(t.x,t.y,t.z,t.spatialReference,"ground",n);return r$A(i)&&e.renderCoordsHelper.setAltitude(r,i),r}}else r$B(r,t);else r$B(r,e.state.camera.center);return r}function oe$2(e,t){const n=n$F();if(t&&t instanceof b$m){if(wn(t,n,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const r=i$I(e.elevationProvider,t);r$A(r)&&e.renderCoordsHelper.setAltitude(n,r);}}else r$B(n,t||e.state.camera.center);return n}function ae$2(e,t,n,r,i,o,a){const s=r&&r instanceof b$m?r:null;if(we$1(a))return ie$2(e,r,a.signal).then((r=>{se$3(e,t,n,s,r,i,o,a);}),(e=>a.resolver.reject(e))),null;const l=oe$2(e,r);return se$3(e,t,n,s,l,i,o,a)}function se$3(e,t,n,r,o,a,s,l){if(t$F(r)){const t=e.renderSpatialReference;if(r=Rn(o,t,N$i(e)),t$F(r))return null}a=Math.max(a,e.state.constraints.minimumPoiDistance);const c=ue$2(e,t,n,o,a,s),f=(0, Z$7(e).eyeForCenterWithHeadingTilt)(o,a,c.heading,c.tilt);if(1===s&&"global"===e.viewingMode&&n>0){const i=()=>{const i=ve$1(e,o,a,de$2(e,a,n,o));return se$3(e,t,i,r,o,a,s=n-i<1?0:1,l)},c=e.map.ground.navigationConstraint;if(!c||"stay-above"===c.type){if(ne$2(e,f.eye))return i();if(we$1(l))return re$2(e,f.eye,l.signal).then((e=>e?i():(l.resolver.resolve({eye:f.eye,up:f.up,center:t$G(o),heading:f.heading,tilt:f.tilt}),null))),null}}const u=!l||we$1(l)?{center:n$F(),eye:n$F(),up:n$F(),tilt:0,heading:0}:l;return u.eye=f.eye,u.up=f.up,u.center=t$G(o),u.heading=f.heading,u.tilt=f.tilt,we$1(l)&&l.resolver.resolve(u),u}function le$3(e,t,n,r,a,s=null){const l=null!=t.zmax&&null!=t.zmin;let c,f,u;if("global"===e.viewingMode){if(!i$J(t.spatialReference,"global"))return we$1(s)&&s.resolver.reject(),null;const e=new b$m(t.xmin,t.ymin,t.spatialReference),n=new b$m(t.xmax,t.ymax,t.spatialReference),r=t.spatialReference.isGeographic?Y$a:D$f;c=new b$m({x:r.center(e.x,n.x),y:(n.y+e.y)/2,z:l?(t.zmax+t.zmin)/2:null,spatialReference:t.spatialReference});const i=p$K(t.spatialReference),o=i$C(c,e,n);f=o.lon,u=o.lat,r.diff(e.x,n.x)>r.range/2&&(f+=i.halfCircumference),f=Math.min(f,i.halfCircumference),u=Math.min(u,i.halfCircumference);}else {const n=c$N(e.renderSpatialReference,t.spatialReference);n.equals(t.spatialReference)||(t=O$k(t,n)),f=t.xmax-t.xmin,u=t.ymax-t.ymin;const r=l?(t.zmax+t.zmin)/2:null;c=new b$m({x:t.xmin+.5*f,y:t.ymin+.5*u,z:r,spatialReference:n});}const m=l?t.zmax-t.zmin:0,p=e.state.camera,d=1/Math.tan(p.fovX/2),h=1/Math.tan(p.fovY/2),g=1/Math.tan(p.fov/2),y=Math.max(.5*f*d,.5*u*h,.5*m*g)/L$f;if(we$1(s)){const t=new je$1(s.signal);return ae$2(e,n,r,c,y,a,t),void t.resolver.promise.then((t=>{const n=ge$1(e,t,e.camera.fov);if(!t$F(n))return s.resolver.resolve(n);s.resolver.reject();}),(e=>s.resolver.reject(e)))}const M=ae$2(e,n,r,c,y,a);return ge$1(e,M,e.camera.fov,s)}function ce$2(e,t,n){const r=e.renderSpatialReference,o=Rn(n,r,N$i(e));if(t$F(o))return null;const a=Math.tan(t.fovX/2),s=Math.tan(t.fovY/2),l=S$l(t.eye,n),c=2*l*a*L$f,u=2*l*s*L$f;return "global"===e.viewingMode?G$d(e,o,c,u):U$a(e,o,c,u)}function fe$1(e,t,n){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(n/r)/Math.LN2>q$e)return !0;const o=e.renderSpatialReference,a=N$i(e),s=Rn(t,o,a),l=Rn(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,o,a);if(t$F(s)||t$F(l))return !1;const c=Math.tan(.5*e.state.camera.fov)*r;return l.distance(s)/c>E$h}function ue$2(e,t,n,r,i,o){let a=0;return 1===o&&fe$1(e,r,i)?(t=0,a=pe$2(e,i,n,r)):a=he$3(e,r,i,n),a=e.state.constraints.clampTilt(i,a),{heading:t,tilt:n=ve$1(e,r,i,a)}}const me$1=.7;function pe$2(e,t,n,r){const i=e.state.constraints.tilt(t);i.max=Math.min(i.max,.5*Math.PI);const o=i.min*(1-me$1)+i.max*me$1,a=he$3(e,r,t,n);return Math.min(a,o)}function de$2(e,t,n,r){const i=e.state.constraints.tilt(t);let o=he$3(e,r,t,n);return o=Math.min(o,.5*Math.PI),i.min*(1-me$1)+o*me$1}function ve$1(e,t,n,r){return Z$7(e).lookAtTiltToEyeTilt(r,t,n)}function he$3(e,t,n,r){return Z$7(e).eyeTiltToLookAtTilt(r,t,n)}function ge$1(t,n,r,o){if(t$F(n))return null;const s=t.renderSpatialReference,l=Rn(n.eye,s,N$i(t));return t$F(l)?null:r$A(o)?(o.position=l,o.heading=n.heading,o.tilt=n.tilt,o.fov=r,o):new d$A(l,n.heading,n.tilt,r)}function ye$1(e,t){var n;const r=null==(n=e.basemapTerrain)?void 0:n.tilingScheme;if(r)return r.levelAtScale(t);k$j.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme");}function Re$1(e,t){var n;const r=null==(n=e.basemapTerrain)?void 0:n.tilingScheme;if(r)return r.scaleAtLevel(t);k$j.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme");}function xe$1(e,t){return e.spatialReference?i$K(t,e.spatialReference):void 0}function Me$1(t,n,r){const i=t.renderSpatialReference;let o,a;n||(n=t.state.camera);const s=k$l.WGS84;return n instanceof d$A?(o=n.position.latitude,wn(n.position,G$c,i),wn(r,O$j,i),a=q$g(G$c,O$j)):(gn(n.center,i,O$j,s),o=O$j[1],a=n.distance),$$8(t,a,o)}class je$1{constructor(e){this.signal=e,this.resolver=B$f();}}function we$1(e){return e&&"resolver"in e}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const se$2=.66;function ce$1(e){return 360-U$b.normalize(e)}function le$2(e){return U$b.normalize(360-e)}function me(e){return r$A(e)&&e.resolver&&e.resolver.reject(),null}function fe(e,t){return r$A(e)&&e.resolver&&e.resolver.resolve(t),t}function ue$1(e,t,n,r=null){if(!t)return me(r);const a=e.spatialReference||k$l.WGS84;if(r$A(t.camera)){const e=M$h(t.camera.position,a);if(t$F(e))return me(r);const n=t.camera.clone();return n.position=e,fe(r,n)}if(t$F(t.targetGeometry))return me(r);const s=t.get("targetGeometry.spatialReference");if(s&&!g$u(s,a))return me(r);const c=Q$c(e,e.state.camera);let l=1;if(null!=t.rotation&&(c.heading=ce$1(t.rotation),l=0),null!=n&&(c.tilt=n),"point"===t.targetGeometry.type){const n=t.targetGeometry;let a;const o=t.targetGeometry.clone();return a=null!=t.scale?V$c(e,t.scale,n.latitude):e.state.camera.distance,ee$3(e,o,a,c,l,r)}const m=t.targetGeometry.extent;return le$3(e,m,c.heading,c.tilt,l,r)}function pe$1(e,t,r=null){return t$F(r)&&(r=new u$z),xe(e,null,t.clone(),r)}async function ge(t,r,o){const i=Fe$1(t,r);if(!i)throw new s$w("viewpointutils-create:no-target","Missing target for creating viewpoint");const s=new d$A({fov:t.camera.fov}),c=new u$z({camera:s});if(i.target instanceof u$z){return Ae$1(await je(t,i.target,i,o,c))}if(i.target instanceof d$A)return Ae$1(Re(t,i.target,c));const l=null!=i.scale||null!=i.zoom;if(i.target instanceof M$g){const e=i.target.xmin===i.target.xmax||i.target.ymin===i.target.ymax;return Ae$1(l||e?await ze$1(t,i,i.target.center,s,o,c):await ke$1(t,i,i.target,s,o,c))}const m={boundingBox:B$g(),hasZ:!1,screenSpaceObjects:[]},f=l?ye(t,i):void 0;if(await be(t,i.target,f,m),isFinite(m.boundingBox[0])){let e;if(p$L(m.boundingBox,Ue),Ye.x=Ue[0],Ye.y=Ue[1],Ye.z=Ue[2],Ye.spatialReference=t.spatialReference,isFinite(Ye.z)&&m.hasZ?e=S$m(m.boundingBox):(Ye.z=void 0,e=D$g(G$e(m.boundingBox,Ne$2))),l||e)return Ae$1(await ze$1(t,i,Ye,s,o,c));const n=Ee$1(t,m.screenSpaceObjects);return Ae$1(await Ze$1(t,i,Ye,m.boundingBox,n,s,o,c))}return i.position?Ae$1(Se(t,i,s,c)):Ae$1(await Be$2(t,i,s,o,c))}function he$2(e,t){return null==t.scale&&null!=t.zoom?Re$1(e,t.zoom):t.scale}function ye(e,t){return xe$1(e,he$2(e,t))}function de$1(e,t){let n=!1;return null!=t.heading?(e.heading=t.heading,n=!0):null!=t.rotation&&(e.heading=ce$1(t.rotation),n=!0),null!=t.tilt&&(e.tilt=t.tilt,n=!0),null!=t.fov&&(e.fov=t.fov),n}function xe(e,t,n,r){const a=e.spatialReference||k$l.WGS84;return t=r$A(t)?t:J$b(e,n),t$F(t)||(r.targetGeometry=Rn(t.center,e.renderSpatialReference,a),r.scale=Me$1(e,t),r.rotation=le$2(n.heading),r.camera=n),r}function we(e,t,n){if(!t)return;if(!g$u(t.spatialReference,e.spatialReference))throw new s$w("viewpointutils:incompatible-spatialreference",`Spatial reference (${t.spatialReference?t.spatialReference.wkid:"unknown"}) is incompatible with the view (${e.spatialReference.wkid})`,{geometry:t});const r=[];if(!t.hasZ&&e.basemapTerrain){let n;switch(t.type){case"point":n=t;break;case"multipoint":case"polyline":n=t.extent.center;break;case"mesh":n=t.origin;break;case"extent":n=t.center;break;case"polygon":n=t.centroid;}n&&g$u(n,e.basemapTerrain.spatialReference)?Ue[2]=c$N(i$I(e.elevationProvider,n),0):Ue[2]=0;}(0, $e$1[t.type])(t,(e=>{r.push(e[0],e[1],e[2]);}),Ue);const o=r.length/3;if(0===o)return;const i=new Array(r.length);if(xn(r,t.spatialReference,0,i,e.spatialReference,0,o)){t.hasZ&&(n.hasZ=!0);for(let e=0;e<i.length;e+=3)t.hasZ?(Ue[0]=i[e+0],Ue[1]=i[e+1],Ue[2]=i[e+2]):(Ue[0]=i[e+0],Ue[1]=i[e+1]),h$u(n.boundingBox,Ue);}}async function ve(e,t,n,a){const o=await a$P(e.whenViewForGraphic(t));if(!1===o.ok||t$F(o.value)||!("whenGraphicBounds"in o.value))return void we(e,t.geometry,a);const s=o.value,c=await a$P(s.whenGraphicBounds(t,{minDemResolution:n}));if(!1===c.ok)return void we(e,t.geometry,a);const{screenSpaceObjects:l,boundingBox:m}=c.value;f$t(a.boundingBox,m),l&&l.forEach((e=>{a.screenSpaceObjects.push(e);})),isFinite(m[2])&&(a.hasZ=!0);}async function be(e,n,r,a){if(Array.isArray(n)&&2===n.length){const t=n[0],r=n[1];if("number"==typeof t&&"number"==typeof r)return Ye.x=t,Ye.y=r,Ye.z=void 0,Ye.spatialReference=e.spatialReference.isGeographic?e.spatialReference:k$l.WGS84,void we(e,Ye,a)}n&&"function"==typeof n.map?await T$f(n.map((t=>be(e,t,r,a)))):n instanceof p$M?we(e,n,a):n instanceof h$t&&await ve(e,n,r,a);}async function je(e,t,n,r,a){if(r$A(t.camera))return Re(e,t.camera,a);a.scale=t.scale,a.rotation=t.rotation,a.targetGeometry=r$A(t.targetGeometry)?t.targetGeometry.clone():null,a.camera=null,null!=n.heading?a.rotation=le$2(n.heading):null!=n.rotation&&(a.rotation=n.rotation);const i=he$2(e,n);null!=i&&(a.scale=i);const s=new je$1(r);return ue$1(e,a,n.tilt,s),a.camera=await s.resolver.promise,a}function Re(e,t,n){const r=e.spatialReference,a=M$h(t.position,r);return t$F(a)?null:((t=t.clone()).fov=e.camera.fov,t.position=a,xe(e,null,t,n))}function Ge$1(e,t,n,r,a,o){const i=e.renderSpatialReference;return wn(n.position,Ve,i),wn(t,We$1,i),o.targetGeometry=new b$m(t),a.position=new b$m(n.position),c$O(Oe$1,We$1,Ve),te$3(e,Ve,Oe$1,r.up,a),o.scale=$$8(e,q$g(Ve,We$1),o.targetGeometry.latitude),o.rotation=le$2(a.heading),o.camera=a,o}async function ze$1(e,t,n,r,o,s){if(t$F(n))throw new s$w("createfromcenter","invalid point");s.targetGeometry=n.clone();const c=g$t(e);if(t.position)return Ge$1(e,s.targetGeometry,t,c,r,s);if(t.zoomFactor){const r=c.distance/t.zoomFactor,a=d$z(Ue,c.viewForward,-r);c.eye=u$A(Ue,c.center,a),s.scale=$$8(e,r,n.latitude);}Q$c(e,c,r);const l=de$1(r,t)?0:1;if(!t.zoomFactor){s.scale=he$2(e,t),null==s.scale&&(wn(n,Ue,e.renderSpatialReference),z$j(c.frustum,Ue)?s.scale=$$8(e,q$g(c.eye,Ue),n.latitude):s.scale=Me$1(e,c));const a=new je$1(o);_$c(e,s.targetGeometry,s.scale,r,l,a),s.camera=await a.resolver.promise;}return s}function Se(e,t,n,r){const a=g$t(e);return r$B(Oe$1,a.viewForward),te$3(e,a.eye,Oe$1,a.up,Ce),n.position=new b$m(t.position),n.heading=null!=t.heading?t.heading:Ce.heading,n.tilt=null!=t.tilt?t.tilt:Ce.tilt,xe(e,null,n,r)}async function Be$2(e,t,n,r,a){const o=g$t(e);return ze$1(e,t,Rn(o.center,e.renderSpatialReference,e.spatialReference),n,r,a)}async function ke$1(e,t,n,r,a,o){o.targetGeometry=n.clone();const i=g$t(e);Q$c(e,i,r);const s=de$1(r,t)?0:1,c=new je$1(a);return le$3(e,n,r.heading,r.tilt,s,c),o.camera=await c.resolver.promise,o}function Me(e,t,n,r,a){let o=0;n.hasZ?o=n.z:e.basemapTerrain&&(o=e$z(i$I(e.elevationProvider,n))),o$C(Ue,n.x,n.y,o),vn(e.spatialReference,Ue,Pe,e.renderSpatialReference),a$Q(Te,Pe),o$D(Te,Te),B$g(Ie$1);const i=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let c=0;c<i.length;c++){const t=i[c];let n=r[t[2]];isFinite(n)||(n=o),o$C(Ue,r[t[0]],r[t[1]],n),gn(Ue,e.spatialReference,Ue,e.renderSpatialReference),h$u(Ie$1,L$g(Ue,Ue,Te));}const s=I$h(Ie$1),l=N$j(Ie$1),u=y$t(Ie$1),p=1/Math.tan(t.fovX/2),g=1/Math.tan(t.fovY/2),h=.5*Math.sqrt(s*s+u*u)*Math.max(g,p)+.5*l,y=.5*l*g+.5*Math.max(s,u);return Math.max(h,y)/a}async function Ze$1(e,t,n,r,a,o,i,s){s.targetGeometry=n.clone();const c=g$t(e),l=Me(e,c,n,r,a);Q$c(e,c,o);const m=de$1(o,t)?0:1;s.scale=$$8(e,l,s.targetGeometry.latitude);const f=new je$1(i);return _$c(e,s.targetGeometry,s.scale,o,m,f),s.camera=await f.resolver.promise,s}function Fe$1(e,t){if(!t||!e.spatialReference)return null;const n={target:null};if("declaredClass"in t||Array.isArray(t))n.target=t;else {for(const e in t)n[e]=t[e];t.center&&!n.target&&(n.target=t.center);}return n}function Ae$1(e){return e&&r$A(e.camera)&&(e.rotation=le$2(e.camera.heading)),e}function Ee$1(e,t){const n=se$2;if(!t.length)return n;let r=Number.NEGATIVE_INFINITY;for(let a=0;a<t.length;a++){const e=t[a].screenSpaceBoundingRect;r=Math.max(r,Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2]),Math.abs(e[3]));}return n-r/Math.min(e.width,e.height)*2}const Ue=n$F(),Pe=e$y(),Te=e$A(),Ie$1=a$R(),Ne$2=u$B(),Oe$1=n$F(),Ve=n$F(),We$1=n$F(),Ce={heading:0,tilt:0},Ye=new b$m,$e$1={point(e,t,n){n[0]=e.x,n[1]=e.y,e.hasZ&&(n[2]=e.z),t(n);},polygon(e,t,n){const r=e.hasZ;for(let a=0;a<e.rings.length;a++){const o=e.rings[a];for(let e=0;e<o.length;e++)n[0]=o[e][0],n[1]=o[e][1],r&&(n[2]=o[e][2]),t(n);}},polyline(e,t,n){const r=e.hasZ;for(let a=0;a<e.paths.length;a++){const o=e.paths[a];for(let e=0;e<o.length;e++)n[0]=o[e][0],n[1]=o[e][1],r&&(n[2]=o[e][2]),t(n);}},multipoint(e,t,n){const r=e.points,a=e.hasZ;for(let o=0;o<r.length;o++)n[0]=r[o][0],n[1]=r[o][1],a&&(n[2]=r[o][2]),t(n);},extent(e,t,n){e.hasZ?(t(o$C(n,e.xmin,e.ymin,e.zmin)),t(o$C(n,e.xmax,e.ymin,e.zmin)),t(o$C(n,e.xmin,e.ymax,e.zmin)),t(o$C(n,e.xmax,e.ymax,e.zmin)),t(o$C(n,e.xmin,e.ymin,e.zmax)),t(o$C(n,e.xmax,e.ymin,e.zmax)),t(o$C(n,e.xmin,e.ymax,e.zmax)),t(o$C(n,e.xmax,e.ymax,e.zmax))):(t(o$C(n,e.xmin,e.ymin,n[2])),t(o$C(n,e.xmax,e.ymin,n[2])),t(o$C(n,e.xmin,e.ymax,n[2])),t(o$C(n,e.xmax,e.ymax,n[2])));},mesh(e,t,n){const r=e.vertexAttributes&&e.vertexAttributes.position;if(r)for(let a=0;a<r.length;a+=3)t(o$C(n,r[a+0],r[a+1],r[a+2]));}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var e$w;let p$D=e$w=class extends a$O{constructor(){super(...arguments),this.text="";}clone(){return new e$w({text:this.text})}};e$x([d$y({type:String,json:{write:!0}})],p$D.prototype,"text",void 0),p$D=e$w=e$x([i$H("esri.webscene.support.Description")],p$D);const c$H=p$D;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var c$G;let p$C=c$G=class extends p$N{constructor(o){super(o),this.type="cloudy",this.cloudCoverage=.5;}clone(){return new c$G({cloudCoverage:this.cloudCoverage})}};e$x([r$z({cloudy:"cloudy"})],p$C.prototype,"type",void 0),e$x([d$y({type:Number,nonNullable:!0,range:{min:0,max:1}})],p$C.prototype,"cloudCoverage",void 0),p$C=c$G=e$x([i$H("esri.view.3d.environment.CloudyWeather")],p$C);const a$L=p$C;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var p$B;let c$F=p$B=class extends p$N{constructor(r){super(r),this.type="foggy",this.fogStrength=.5;}clone(){return new p$B({fogStrength:this.fogStrength})}};e$x([r$z({foggy:"foggy"})],c$F.prototype,"type",void 0),e$x([d$y({type:Number,nonNullable:!0,range:{min:0,max:1}})],c$F.prototype,"fogStrength",void 0),c$F=p$B=e$x([i$H("esri.view.3d.environment.FoggyWeather")],c$F);const a$K=c$F;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var c$E;let a$J=c$E=class extends p$N{constructor(r){super(r),this.type="rainy",this.cloudCoverage=.5;}clone(){return new c$E({cloudCoverage:this.cloudCoverage})}};e$x([r$z({rainy:"rainy"})],a$J.prototype,"type",void 0),e$x([d$y({type:Number,nonNullable:!0,range:{min:0,max:1}})],a$J.prototype,"cloudCoverage",void 0),a$J=c$E=e$x([i$H("esri.view.3d.environment.RainyWeather")],a$J);const p$A=a$J;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var c$D;let p$z=c$D=class extends p$N{constructor(r){super(r),this.type="sunny",this.cloudCoverage=.5;}clone(){return new c$D({cloudCoverage:this.cloudCoverage})}};e$x([r$z({sunny:"sunny"})],p$z.prototype,"type",void 0),e$x([d$y({type:Number,nonNullable:!0,range:{min:0,max:1}})],p$z.prototype,"cloudCoverage",void 0),p$z=c$D=e$x([i$H("esri.view.3d.environment.SunnyWeather")],p$z);const a$I=p$z;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const y$p={key:"type",base:null,typeMap:{sunny:a$I,cloudy:a$L,rainy:p$A,foggy:a$K}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var n$B;let c$C=n$B=class extends a$O{constructor(){super(...arguments),this.lighting=new p$H,this.weather=null;}clone(){return new n$B({lighting:p$H.prototype.clone.call(this.lighting),weather:r$A(this.weather)?this.weather.clone():null})}};e$x([d$y({type:p$H,json:{write:!0}})],c$C.prototype,"lighting",void 0),e$x([d$y({types:y$p,json:{write:!1}})],c$C.prototype,"weather",void 0),c$C=n$B=e$x([i$H("esri.webscene.Environment")],c$C);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var i$B;let n$A=i$B=class extends a$O{constructor(){super(...arguments),this.opacity=null;}clone(){return new i$B({opacity:this.opacity})}cloneAndApplyTo(r){return null==this.opacity||((r=null!=r?r.clone():new A$j).opacity=this.opacity),r}static fromGround(r){return new i$B({opacity:r.opacity})}};e$x([d$y({type:Number,json:{type:S$n,read:{reader:r$E,source:"transparency"},write:{writer:(r,o)=>{o.transparency=n$G(r);},target:"transparency"}}})],n$A.prototype,"opacity",void 0),n$A=i$B=e$x([i$H("esri.webscene.support.SlideGround")],n$A);const u$w=n$A;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var i$A;let c$B=i$A=class extends a$O{constructor(r){super(r),this.id="",this.sublayerIds=null;}clone(){return new i$A({id:this.id,sublayerIds:l$A(this.sublayerIds)})}};e$x([d$y({type:String,json:{write:!0}})],c$B.prototype,"id",void 0),e$x([d$y({type:[S$n],json:{read:{source:"subLayerIds"},write:{target:"subLayerIds"}}})],c$B.prototype,"sublayerIds",void 0),c$B=i$A=e$x([i$H("esri.webscene.support.SlideVisibleLayer")],c$B);const a$H=c$B;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var s$t;let p$y=s$t=class extends a$O{constructor(){super(...arguments),this.text="";}clone(){return new s$t({text:this.text})}};e$x([d$y({type:String,json:{write:{isRequired:!0}}})],p$y.prototype,"text",void 0),p$y=s$t=e$x([i$H("esri.webscene.support.Title")],p$y);const c$A=p$y;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let k$i=0;const O$i=S$o.ofType(a$H),R$f=s$y.getLogger("esri.webscene.Slide");let A$g=class extends a$O{constructor(e){super(e),this.id=Date.now().toString(16)+"-slide-"+k$i++,this.title=new c$A,this.description=new c$H,this.thumbnail=new c$Q,this.viewpoint=null,this.basemap=null,this.ground=null,this.environment=new c$C,this.visibleLayers=new O$i;}destroy(){this.visibleLayers.removeAll(),this.basemap=null,this.thumbnail&&this.thumbnail.destroy(),this.description=null,this.title=null,this.thumbnail=null;}castTitle(e){return "string"==typeof e?new c$A({text:e}):b$n(c$A,e)}castDescription(e){return "string"==typeof e?new c$H({text:e}):b$n(c$H,e)}castThumbnail(e){return "string"==typeof e?new c$Q({url:e}):b$n(c$Q,e)}castBasemap(e){return y$u(e)}set visibleLayers(e){this._set("visibleLayers",n$H(e,this._get("visibleLayers"),O$i));}castVisibleLayers(e){return e&&"function"==typeof e.map?e.map((e=>{if("string"==typeof e)return {id:e};if(e instanceof b$o){const t=M$d(e);return {id:e.id,sublayerIds:t}}return e.id?{id:e.id,sublayerIds:e.sublayerIds}:(R$f.warn('Invalid visible layer, expected { id }, Layer or "id"'),e)})):null}clone(){return new(this.constructor)({id:this.id,title:this.title.clone(),thumbnail:this.thumbnail.clone(),description:this.description&&this.description.clone()||null,viewpoint:this.viewpoint&&this.viewpoint.clone()||null,basemap:this.basemap&&this.basemap.clone()||null,ground:this.ground&&this.ground.clone()||null,visibleLayers:this.visibleLayers.clone(),environment:this.environment&&this.environment.clone()||null})}_updateVisibleLayersFrom(e){const t=[];return T$f(this._getLayers(e.map).map((i=>e.whenLayerView(i).then((e=>{if(e.visible){const n=M$d(i);t.push(new a$H({id:e.layer.id,sublayerIds:n}));}})))).toArray()).then((()=>{this.visibleLayers.removeAll(),this.visibleLayers.addMany(t);}))}updateFrom(e,t){return t={screenshot:{format:"png",quality:80,width:120,height:75,disableDecorations:!0,...t&&t.screenshot}},e.when((()=>(this.viewpoint=e.viewpoint.clone(),this.environment.lighting=p$H.prototype.clone.apply(e.environment.lighting),this.environment.weather=r$A(e.environment.weather)?e.environment.weather.clone():null,this.basemap=e.map.basemap&&e.map.basemap.clone()||null,this.ground=e.map.ground?u$w.fromGround(e.map.ground):null,this._updateVisibleLayersFrom(e)))).then((()=>e.takeScreenshot(t.screenshot))).then((e=>(this.thumbnail=new c$Q({url:e.dataUrl}),this)))}async applyTo(e,t){r$A(this._applyToController)&&this._applyToController.abort();let i=new AbortController;this._applyToController=i;const r=v$s(t,(()=>i.abort())),o=e.resourceController.scheduler.registerTask(f$u.SLIDE);let s=!1;t={animate:!0,...t,signal:this._applyToController.signal};const a=async()=>{await s$z([o.schedule((()=>s=this._setViewpointOfInterest(e,t))),o.schedule((()=>this._applyBasemap(e,t)),t.signal)]),await s$z([o.schedule((()=>this._applyLayerVisibility(e)),t.signal),o.schedule((()=>this._applyGround(e)),t.signal),o.schedule((()=>this._applyWeather(e)),t.signal),o.schedule((()=>this._applyViewpoint(e,t)),t.signal)]);},p=await a$P(e.addUpdatingPromise(a()));if(s&&(e.contentCamera=null),o.remove(),this._applyToController===i&&(this._applyToController=null),i=null,null==r||r.remove(),!1===p.ok)throw p.error;return this}async _applyBasemap(e,t){if(this.basemap){try{await this.basemap.load(t);}catch(i){if(d$B(i))throw i}e.map.basemap=p$O(this.basemap,e.map.basemap);}}_applyGround(e){this.ground&&(e.map.ground=this.ground.cloneAndApplyTo(e.map.ground));}_getLayers(e){const t=new S$o;return this._collectLayers(e,t),this._collectLayers(e.ground,t),t}_collectLayers(e,t){e.layers.forEach((e=>{u$C(e)&&(t.add(e),"layers"in e&&this._collectLayers(e,t));}));}_applyLayerVisibility(e){if(!this.visibleLayers)return;this._getLayers(e.map).forEach((e=>{const t=this.visibleLayers.find((t=>t.id===e.id));e.visible=null!=t;const i=t&&t.sublayerIds,n=q$d(e);i&&n&&n.forEach((e=>e.visible=i.indexOf(e.id)>=0));}));}_setViewpointOfInterest(e,t){if(e.state.fixedContentCamera||!this.viewpoint||t.ignoreViewpoint||!t.useDestinationCamera)return !1;const i=ue$1(e,this.viewpoint);return e.contentCamera=i,r$A(i)}_applyWeather(e){this.environment.weather!==e.environment.weather&&(e.environment.weather=r$A(this.environment.weather)?this.environment.weather.clone():null);}async _applyViewpoint(e,t){if(this.viewpoint&&!t.ignoreViewpoint){if(r$A(this.viewpoint.camera)&&(this.viewpoint.camera.fov=e.camera.fov),t.animate&&this.get("environment.lighting.date"))return void await this._animateToLighting(e,t);t.animate&&(e.environment.applyLighting(this.environment.lighting.clone()),await e.goTo(this.viewpoint,t)),e.viewpoint=this.viewpoint;}e.environment.applyLighting(this.environment.lighting.clone());}async _animateToLighting(e,t){let i=null;"global"===e.viewingMode&&(i=this._animateLightingWithCamera(e)),e.environment.lighting.cameraTrackingEnabled=!1,e.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled,null!=this.environment.lighting.displayUTCOffset&&(e.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset);const n=e.goTo(this.viewpoint,t),r=()=>{i&&i.remove(),e.environment.lighting.cameraTrackingEnabled=!0;};return n.then((()=>{e.environment.applyLighting(this.environment.lighting.clone()),r();}),(e=>{throw r(),e}))}_getTime(e){return [e.getTime(),3600*e.getUTCHours()+60*e.getUTCMinutes()+e.getUTCSeconds()]}_setTime(e,t,i){return e.setTime(t),e.setUTCHours(i/3600),e.setUTCMinutes(i%3600/60),e.setUTCSeconds(i%3600%60),e}_animateLightingWithCamera(e){const t=new Date(e.environment.lighting.date.toString()),[i,n]=this._getTime(t),[r,o]=this._getTime(this.environment.lighting.date),s=G$b(n,o),a=e.renderCoordsHelper,p=n$F();a.toRenderCoords(e.camera.position,p);const m=n$F(),h=n$F();r$A(this.viewpoint.camera)&&a.toRenderCoords(this.viewpoint.camera.position,m);const c=new Date;return e.watch("camera",(t=>{a.toRenderCoords(t.position,h);const o=x$p(p,h),l=x$p(m,h);let u=0;o+l!==0&&(u=o/(o+l));const d=i+(r-i)*u,y=W$8(n,s*u);e.environment.lighting.date=this._setTime(c,d,y);}))}static createFrom(e,t){return (new this).updateFrom(e,t)}};function q$d(e){if("building-scene"===e.type||"map-image"===e.type)return e.allSublayers.toArray()}function M$d(e){const t=q$d(e);if(t)return t.filter((e=>e.visible)).map((e=>e.id))}e$x([d$y({type:String,json:{write:{isRequired:!0}}})],A$g.prototype,"id",void 0),e$x([d$y({type:c$A,json:{default:()=>new c$A({text:""}),write:{isRequired:!0}}})],A$g.prototype,"title",void 0),e$x([c$P("title")],A$g.prototype,"castTitle",null),e$x([d$y({type:c$H,json:{write:{overridePolicy:e=>({enabled:!(!e||!e.text)})}}})],A$g.prototype,"description",void 0),e$x([c$P("description")],A$g.prototype,"castDescription",null),e$x([d$y({type:c$Q,json:{default:()=>new c$Q({url:""}),write:{isRequired:!0}}})],A$g.prototype,"thumbnail",void 0),e$x([c$P("thumbnail")],A$g.prototype,"castThumbnail",null),e$x([d$y({type:u$z,nonNullable:!0,json:{write:{isRequired:!0}}})],A$g.prototype,"viewpoint",void 0),e$x([d$y({type:x$q,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],A$g.prototype,"basemap",void 0),e$x([c$P("basemap")],A$g.prototype,"castBasemap",null),e$x([d$y({type:u$w,json:{write:!0}})],A$g.prototype,"ground",void 0),e$x([d$y({type:O$i,json:{write:{isRequired:!0}}})],A$g.prototype,"visibleLayers",null),e$x([c$P("visibleLayers")],A$g.prototype,"castVisibleLayers",null),e$x([d$y({type:c$C,json:{write:!0}})],A$g.prototype,"environment",void 0),A$g=e$x([i$H("esri.webscene.Slide")],A$g);const B$d=86400,F$a=43200;function G$b(e,t){let i=t-e;return i>F$a&&(i-=B$d),i<-F$a&&(i+=B$d),i}function W$8(e,t){return p$P(e+t,B$d)}const H$f=A$g;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const n$z=S$o.ofType(H$f);let m$v=class extends a$O{constructor(s){super(s),this.slides=new n$z;}destroy(){this.slides.forEach((s=>s.destroy())),this.slides.removeAll();}set slides(s){s&&(s=s.filter((s=>!!s.viewpoint))),this._set("slides",n$H(s,this._get("slides"),n$z));}clone(){return new(this.constructor)({slides:this.slides.clone()})}};e$x([d$y({type:n$z,nonNullable:!0,json:{write:!0}}),c$P(t$H)],m$v.prototype,"slides",null),m$v=e$x([i$H("esri.webscene.Presentation")],m$v);const a$G=m$v;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var s$s;let p$x=s$s=class extends a$O{constructor(t){super(t);}clone(){return new s$s({name:this.name,path:this.path,title:this.title})}};e$x([d$y({type:String,json:{write:!0}})],p$x.prototype,"name",void 0),e$x([d$y({type:String,json:{write:!0}})],p$x.prototype,"path",void 0),e$x([d$y({type:String,json:{write:!0}})],p$x.prototype,"title",void 0),p$x=s$s=e$x([i$H("esri.webscene.TransportationNetwork")],p$x);const i$z=p$x;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class e$v extends r$F{constructor(s,e){super(s,e,"webscene");}get supportsGround(){return this.since(1,8)}get supportsVisibleElevationLayersInSlides(){return this.lessThan(1,8)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const K$c=s$y.getLogger("esri.WebScene"),D$e=new e$v(1,26),H$e=()=>{const e=8,t=[],r=D$e.major;for(let i=e;i<=D$e.minor;i++)t.push(`${r}.${i}`);return t},z$g="Web Scene",Q$b="ViewingMode-Local";let X$7=class extends(m$B.LoadableMixin(n$I(l$C(j$q)))){constructor(e){super(e),this._handles=new u$D,this.applicationProperties=null,this.clippingArea=null,this.clippingEnabled=!1,this.floorInfo=null,this.heightModelInfo=null,this.sourceVersion=null,this.supportsHeightModelInfo=!0,this.transportationNetworks=null,this.presentation=new a$G,this.initialViewProperties=new l$x,this.portalItem=null,this.resourceInfo=null,this.debouncedSaveOperations=z$k((async(e,t,r)=>{switch(e){case 0:return this._saveImpl(t);case 1:return this._saveAsImpl(r,t)}})),this.resourceReferences={portalItem:null,paths:[]},this.authoringApp=null,this.authoringAppVersion=null,this._isAuthoringAppSetByUser=!1,this._isAuthoringAppVersionSetByUser=!1;}initialize(){if(this.when().catch((e=>{K$c.error("#load()","Failed to load web scene",e);})),this.resourceInfo){let t;try{t=this._validateJSON(this.resourceInfo);}catch(e){return void this.addResolvingPromise(Promise.reject(e))}this.read(t),this.addResolvingPromise(this._validateSpatialReference()),this.addResolvingPromise(this._validateHeightModelInfo());}this._handles.add(this.allLayers.on("change",(()=>this._scheduleLayersIdGC())));}destroy(){this._unscheduleLayersIdGC(),this._handles.destroy(),this.presentation&&this.presentation.destroy();const e=this.portalItem;this.portalItem=null,null==e||e.destroy();}writeClippingArea(e,t){t.clippingArea||(t.clippingArea={}),t.clippingArea.geometry=e.toJSON();}readClippingEnabled(e,t){return !!t.clippingArea&&!!t.clippingArea.clip}writeClippingEnabled(e,t){this.clippingArea&&(t.clippingArea||(t.clippingArea={}),t.clippingArea.clip=e);}writeLayers(e,t,r,i){const o={...i,layerContainerType:"operational-layers"},s=e.map((e=>this.verifyWriteLayer(e,i)?e.write({},o):null)).filter((e=>!!e));t[r]=s.toArray();}verifyWriteLayer(e,t){return "write"in e||(t&&t.messages&&t.messages.push(new s$w("layer:unsupported",`Layers (${e.title}, ${e.id}) of type '${e.declaredClass}' cannot be persisted in web scenes`,{layer:e})),!1)}readSourceVersion(e,t){const[r,i]=t.version.split(".");return new e$v(parseInt(r,10),parseInt(i,10))}writeSourceVersion(e,t,r){t[r]=`${D$e.major}.${D$e.minor}`;}get thumbnailUrl(){return this.portalItem&&this.portalItem.thumbnailUrl||null}set thumbnailUrl(e){e?this._override("thumbnailUrl",e):(this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"));}set authoringApp(e){this._isAuthoringAppSetByUser=!0,this._set("authoringApp",e);}writeAuthoringApp(e,t){e&&this._isAuthoringAppSetByUser?t.authoringApp=e:t.authoringApp="ArcGIS API for JavaScript";}set authoringAppVersion(e){this._isAuthoringAppVersionSetByUser=!0,this._set("authoringAppVersion",e);}writeAuthoringAppVersion(e,r){e&&this._isAuthoringAppVersionSetByUser?r.authoringAppVersion=e:r.authoringAppVersion=a$S;}writeGround(e,t,r,i){t[r]=e?e.write({},i):{transparency:0,layers:[]};}readInitialViewProperties(e,t){const r={};return t.initialState&&t.initialState.environment&&(r.environment=c$K.fromJSON(t.initialState.environment)),t.spatialReference?r.spatialReference=k$l.fromJSON(t.spatialReference):r.spatialReference=k$l.WebMercator,r.viewingMode=t.viewingMode||"global",t.initialState&&t.initialState.viewpoint&&(r.viewpoint=u$z.fromJSON(t.initialState.viewpoint)),new l$x(r)}get spatialReference(){var e,t;return null!=(e=null==(t=this.initialViewProperties)?void 0:t.spatialReference)?e:k$l.WebMercator}get viewingMode(){var e,t;return null!=(e=null==(t=this.initialViewProperties)?void 0:t.viewingMode)?e:"global"}load(e){return this.addResolvingPromise(this._loadFromSource()),Promise.resolve(this)}loadAll(){return n$J(this,(e=>{const t=this.presentation&&this.presentation.slides;e(this.ground,this.basemap,this.layers,t&&t.map((e=>e.basemap)));}))}read(e,t){t={...t,origin:"web-scene"};const r=this._isAuthoringAppVersionSetByUser,i=this._isAuthoringAppSetByUser;if(d$C(this,e,(t=>super.read(e,t)),t),i||(this._isAuthoringAppSetByUser=!1),r||(this._isAuthoringAppVersionSetByUser=!1),e.baseMap&&Array.isArray(e.baseMap.elevationLayers)&&this.sourceVersion.supportsVisibleElevationLayersInSlides){const t=e.baseMap.elevationLayers.map((e=>({id:e.id}))),r=this.presentation.slides,i=(e,t)=>e.visibleLayers.some((e=>e.id===t)),o=t.filter((e=>!r.some((t=>i(t,e.id)))));r.forEach((e=>{e.visibleLayers.addMany(o);}));}}_writeBasemapElevationLayers(e){const t=e.ground&&e.ground.layers;!e.baseMap&&t&&t.length&&(e.baseMap={title:"Basemap",baseMapLayers:[]}),e.baseMap&&(e.baseMap.elevationLayers=l$A(t));}write(e,t){var r;if("loaded"!==this.loadStatus){const e=new s$w("webscene:not-loaded","Web scene must be loaded before it can be serialized");throw K$c.error("#toJSON()","Web scene must be loaded before it can be serialized",this.loadError||this.loadStatus),e}this._runLayersIdGC();const i=!(null!=(r=t)&&r.messages);t={messages:[],...t,origin:"web-scene"};const o=super.write(e,t);if(i){const e=t.messages.filter((e=>"web-document-write:property-required"===e.name));if(e.length){const t=new s$w("web-document:property-required","One or more properties that are required in the webscene JSON are missing, see details for the specific errors",{errors:e});throw K$c.error("#toJSON()","One or more properties that are required in the webscene JSON are missing",e),t}}return this._writeBasemapElevationLayers(o),o}async save(e){return this.debouncedSaveOperations(0,e)}async _saveImpl(e){this.portalItem||(K$c.error("save(): requires the .portalItem property to be set"),await Promise.reject(new s$w("webscene:portal-item-not-set","Portal item to save to has not been set on the WebScene"))),this.portalItem.type!==z$g&&await Promise.reject(new s$w("webscene:portal-item-wrong-type",`Portal item needs to have type "${z$g}"`));const t=this._updateFromPromise;await this._ensureLoadBeforeSave();const r=this._enableVerifyItemRelativeUrls({origin:"web-scene",url:this.portalItem.itemUrl&&U$c(this.portalItem.itemUrl),messages:[],portal:this.portalItem.portal||B$h.getDefault(),portalItem:this.portalItem,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}}),i=this.write({},r);return await Promise.all(r.resources.pendingOperations),await this._verifySave(i,r,e),this._updateTypeKeywords(this.portalItem),await this.portalItem.update({data:i}),await a$T(this.resourceReferences,r,null),r$G(r),t&&await t,await this._saveThumbnail(),this.portalItem}async saveAs(e,t){return this.debouncedSaveOperations(1,t,e)}async _saveAsImpl(e,t){let r=b$p.from(e);r||(K$c.error("saveAs(portalItem): requires a portal item parameter"),await Promise.reject(new s$w("webscene:portal-item-required","saveAs requires a portal item to save to"))),r.id&&(r=r.clone(),r.id=null);const i=r.portal||B$h.getDefault();await this._ensureLoadBeforeSave(),r.type=z$g,r.portal=i;const o=this._enableVerifyItemRelativeUrls({origin:"web-scene",url:null,messages:[],portal:i,portalItem:r,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}}),a=this.write({},o);await Promise.all(o.resources.pendingOperations),await this._verifySaveAs(a,o,t);const n=this.thumbnailUrl,l=!this._isOverridden("thumbnailUrl");return this._updateTypeKeywords(r),await i._signIn(),await i.user.addItem({item:r,folder:t&&t.folder,data:a}),await a$T(this.resourceReferences,o,null),this.portalItem=r,O$l.prototype.read.call(this,{version:a.version,authoringApp:a.authoringApp,authoringAppVersion:a.authoringAppVersion},{name:"web-scene",ignoreDefaults:!0,url:r.itemUrl&&U$c(r.itemUrl)}),r$G(o),n&&(this.thumbnailUrl=l?bt$2(n,"w","8192"):n),o.portalItem=r,await this._saveThumbnail(),r}async _saveThumbnail(){this._isOverridden("thumbnailUrl")&&(await this.portalItem.updateThumbnail({thumbnail:this.thumbnailUrl}),this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"));}_verifySave(e,t,r,i=!1){if(!o$E(this.spatialReference))return Promise.reject(new s$w("webscene:unsupported-spatial-reference","Webscenes using spatial reference systems from Mars or Moon can not be saved currently."));let o,a=t.messages.filter((e=>"error"===e.type)).map((e=>new s$w(e.name,e.message,e.details)));t.blockedRelativeUrls&&(a=a.concat(t.blockedRelativeUrls.map((e=>new s$w("url:unsupported",`Relative url '${e}' is not supported in Web Scene`))))),r&&r.ignoreUnsupported&&(a=a.filter((e=>"layer:unsupported"!==e.name&&"symbol:unsupported"!==e.name&&"symbol-layer:unsupported"!==e.name&&"property:unsupported"!==e.name&&"url:unsupported"!==e.name&&"scenemodification:unsupported"!==e.name))),null!=r&&r.requiredPropertyChecksDisabled&&(a=a.filter((e=>"web-document-write:property-required"!==e.name)));const n=r&&r.strictSchemaValidationEnabled;return o=n?import('./schemaValidator-57be1d57.js').then((t=>{const r=t.validate(e);if(r.length>0){const e=`webscene did not validate:\n${r.join("\n")}`;K$c.error(`${i?"saveAs":"save"}(): ${e}`);}return r.map((e=>new s$w("webscene:schema-validation",e)))})).then((e=>{if(n&&e.length>0){throw s$v(e.concat(a))}return a})):Promise.resolve(a),o.then((e=>{if(e.length>0)return Promise.reject(new s$w("webscene:save","Failed to save webscene due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:e}))}))}_verifySaveAs(e,t,r){return this.canNotSaveAs(t)?Promise.reject(n$E()):this._verifySave(e,t,r,!0)}verifySaveAs(e){const t=this._enableVerifyItemRelativeUrls({origin:"web-scene",messages:[]}),r=this.write({},t);return this._verifySaveAs(r,t,e)}canNotSaveAs(e){return e||(e=this._enableVerifyItemRelativeUrls({origin:"web-scene",messages:[]}),this.write({},e)),e.verifyItemRelativeUrls&&e.verifyItemRelativeUrls.writtenUrls.length>0}async updateFrom(e,t={}){const r=this._updateFromInternal(e,t);this._updateFromPromise=r,await r;this._updateFromPromise===r&&(this._updateFromPromise=null);}async _updateFromInternal(e,t={}){if(await e.whenReady(),!t.environmentExcluded&&e.environment&&(this.initialViewProperties.environment=c$K.prototype.clone.apply(e.environment)),!t.viewpointExcluded&&e.viewpoint&&(this.initialViewProperties.viewpoint=e.viewpoint.clone()),this.initialViewProperties.spatialReference=e.spatialReference.clone(),this.initialViewProperties.viewingMode=e.viewingMode,r$A(e.clippingArea)?e.clippingArea!==this.clippingArea&&(this.clippingArea=e.clippingArea.clone(),this.clippingEnabled=!0):this.clippingEnabled=!1,e.heightModelInfo&&(this.heightModelInfo=e.heightModelInfo.clone()),e.map===this)for(const r of e.allLayerViews){const e="visible";e in r&&e in r.layer&&r._isOverridden(e)&&(r.layer[e]=r[e]);}(!1===t.thumbnailExcluded||null==t.thumbnailExcluded&&!t.viewpointExcluded)&&await this._updateFromThumbnail(e,t.thumbnailSize||void 0);}async _updateFromThumbnail(e,t){const r=i$L(e,t),i=await e.takeScreenshot({format:"jpg",width:r.width,height:r.height,disableDecorations:!0});this.thumbnailUrl=i.dataUrl;}_loadFromSource(){return this.resourceInfo?this._loadFromJSON(this.resourceInfo,{origin:"web-scene"}):this.portalItem&&this.portalItem.id?this._loadFromItem(this.portalItem):this._loadObjectsWithLayers()}_readAndLoadFromJSON(e,t){const r=this._validateJSON(e);return this.read(r,t),this._loadFromJSON(r,t)}_extractOperationalLayers(e){const t=[];if(!this.sourceVersion.supportsGround&&e.baseMap&&Array.isArray(e.baseMap.elevationLayers))for(const o of e.baseMap.elevationLayers)t.push(o);const r=[],i=e=>(e.layers&&(e.layers=e.layers.filter(i)),"ArcGISTiledElevationServiceLayer"!==e.layerType||(this.sourceVersion.supportsGround||r.push(e),!1));return {operationalLayers:e.operationalLayers?e.operationalLayers.filter(i):[],operationalElevationLayers:r,basemapElevationLayers:t}}_loadFromJSON(e,t){const r=new S$o;return this._validateSpatialReference().then((()=>this._validateHeightModelInfo())).then((()=>import('./layersCreator-1104c3e6.js'))).then((({populateOperationalLayers:i})=>{const{operationalLayers:o,operationalElevationLayers:s,basemapElevationLayers:a}=this._extractOperationalLayers(e),n=[],l={context:{...t,layerContainerType:"operational-layers"}};if(this.portalItem&&(l.context.portal=this.portalItem.portal||B$h.getDefault()),a.length>0){const e={...l,context:{...l.context,layerContainerType:"ground"}};e.defaultLayerType="ArcGISTiledElevationServiceLayer",n.push(i(this.ground.layers,a,e));}if(s.length>0){const e={...l,context:{...l.context,layerContainerType:"ground"}};e.defaultLayerType="ArcGISTiledElevationServiceLayer",n.push(i(r,s,e));}return o&&o.length>0&&n.push(i(this.layers,o,l)),T$f(n).then((()=>{}))})).then((()=>this._loadObjectsWithLayers())).then((()=>{this.ground.layers.addMany(r);}))}async _ensureLoadBeforeSave(){await this.load(),await this._loadObjectsWithLayers();const e=[];for(const t of this.allLayers.items)if("beforeSave"in t&&"function"==typeof t.beforeSave){const r=t.beforeSave();r&&e.push(r);}await T$f(e);}async _loadObjectsWithLayers(){const e=[];this.ground&&e.push(this.ground.load()),this.basemap&&e.push(this.basemap.load()),this.presentation.slides.forEach((t=>{t.basemap&&e.push(t.basemap.load());})),await T$f(e);}async _loadFromItem(e){if(await e.load().catch((e=>{throw new s$w("webscene:load-portal-item","Failed to load portal item",{error:e})})),"Web Scene"!==e.type)throw new s$w("webscene:invalid-portal-item","Invalid portal item type '${type}', expected 'Web Scene'",{type:e.type});const t=await e.fetchData();this.resourceInfo=t;const r={origin:"web-scene",url:U$c(e.itemUrl),portal:e.portal||B$h.getDefault(),portalItem:e,readResourcePaths:[]};await this._readAndLoadFromJSON(t,r),this.resourceReferences={portalItem:e,paths:r.readResourcePaths};}_validateSpatialReference(){const e=this.initialViewProperties,t=this._sceneSpatialReference;let r;if("local"!==e.viewingMode){if(!i$J(t,"global"))return Promise.reject(new s$w("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in global mode, only Web Mercator, WGS84 GCS or CGCS2000 are supported",{spatialReference:t,viewingMode:e.viewingMode}));r=e=>!e||tn(e,t);}else {if(!i$J(t,"local"))return Promise.reject(new s$w("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in local mode, only projected coordinate systems are supported",{spatialReference:t,viewingMode:e.viewingMode}));r=e=>!e||e.equals(t);}const i=e=>e&&(r$A(e.camera)&&e.camera.position&&e.camera.position.spatialReference||r$A(e.targetGeometry)&&e.targetGeometry.spatialReference),o=e.viewpoint,a=i(o);if(a&&!r(a))return Promise.reject(new s$w("webscene:incompatible-camera-spatial-reference","Camera spatial reference (${cameraSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{cameraSpatialReference:a,sceneSpatialReference:t,viewingMode:e.viewingMode}));const n=this.presentation.slides.find((e=>!r(i(e.viewpoint))));if(n){const r=i(n.viewpoint);return Promise.reject(new s$w("webscene:incompatible-slide-spatial-reference","Slide spatial reference (${slideSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{slideSpatialReference:r,sceneSpatialReference:t,viewingMode:e.viewingMode}))}return Promise.resolve()}_validateHeightModelInfo(){const e=this._sceneSpatialReference,t=r$H(this.heightModelInfo,e);return t?Promise.reject(t):Promise.resolve()}_validateJSON(e){const t=e$v.parse(e.version||"","webscene");return D$e.validate(t),e.version=`${t.major}.${t.minor}`,1===t.major&&t.minor<=2&&(e.spatialReference=k$l.WebMercator.toJSON()),e}_updateTypeKeywords(e){"local"===this.initialViewProperties.viewingMode?e.typeKeywords?-1===e.typeKeywords.indexOf(Q$b)&&e.typeKeywords.push(Q$b):e.typeKeywords=[Q$b]:"global"===this.initialViewProperties.viewingMode&&e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((e=>e!==Q$b))),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)));}get _sceneSpatialReference(){return this.initialViewProperties.spatialReference||k$l.WebMercator}get _verifyItemRelativeRootPath(){return this.portalItem&&this.portalItem.itemUrl?U$c(this.portalItem.itemUrl).path:null}_enableVerifyItemRelativeUrls(e){const t=this._verifyItemRelativeRootPath;return t&&(e.verifyItemRelativeUrls={rootPath:t,writtenUrls:[]}),e}_unscheduleLayersIdGC(){this._layersIdGCTimeoutId&&(clearTimeout(this._layersIdGCTimeoutId),this._layersIdGCTimeoutId=0);}_scheduleLayersIdGC(){this._unscheduleLayersIdGC(),this._layersIdGCTimeoutId=setTimeout((()=>{this._layersIdGCTimeoutId=0,this._runLayersIdGC();}),3e3);}_runLayersIdGC(){this._unscheduleLayersIdGC();const e=this.applicationProperties&&this.applicationProperties.viewing&&this.applicationProperties.viewing.search,t=e=>!!this.allLayers.find((t=>t.id===e));e&&e.layers&&(e.layers=e.layers.filter((e=>t(e.id))));const r=this.presentation&&this.presentation.slides;r&&r.forEach((e=>{e.visibleLayers&&(e.visibleLayers=e.visibleLayers.filter((e=>t(e.id))));}));}static fromJSON(e){if(!e)throw new s$w("webscene:empty-resource","Expected a JSON resource but got nothing");return new this({resourceInfo:e})}};X$7.VERSION=D$e,e$x([d$y({type:c$M,json:{write:!0}})],X$7.prototype,"applicationProperties",void 0),e$x([d$y({json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],X$7.prototype,"basemap",void 0),e$x([d$y({type:M$g,json:{read:{source:"clippingArea.geometry",reader:d$D},write:{target:"clippingArea.geometry"}}})],X$7.prototype,"clippingArea",void 0),e$x([r$y("clippingArea")],X$7.prototype,"writeClippingArea",null),e$x([d$y({type:Boolean,json:{write:{target:"clippingArea.clip"}}})],X$7.prototype,"clippingEnabled",void 0),e$x([o$B("clippingEnabled",["clippingArea"])],X$7.prototype,"readClippingEnabled",null),e$x([r$y("clippingEnabled")],X$7.prototype,"writeClippingEnabled",null),e$x([d$y({type:l$D,json:{read:{source:"mapFloorInfo"},write:{target:"mapFloorInfo"}}})],X$7.prototype,"floorInfo",void 0),e$x([d$y({type:v$t,json:{write:!0}})],X$7.prototype,"heightModelInfo",void 0),e$x([d$y({json:{write:{target:"operationalLayers",ignoreOrigin:!0}}})],X$7.prototype,"layers",void 0),e$x([r$y("layers")],X$7.prototype,"writeLayers",null),e$x([d$y({readOnly:!0,type:e$v,json:{type:H$e(),write:{ignoreOrigin:!0,target:"version",isRequired:!0,overridePolicy:()=>({enabled:!0,allowNull:!0,ignoreOrigin:!0})}}})],X$7.prototype,"sourceVersion",void 0),e$x([o$B("sourceVersion",["version"])],X$7.prototype,"readSourceVersion",null),e$x([r$y("sourceVersion")],X$7.prototype,"writeSourceVersion",null),e$x([d$y({json:{read:!1,write:!1}})],X$7.prototype,"tables",void 0),e$x([d$y()],X$7.prototype,"thumbnailUrl",null),e$x([d$y({type:String,json:{write:{writerEnsuresNonNull:!0,ignoreOrigin:!0}}})],X$7.prototype,"authoringApp",null),e$x([r$y("authoringApp")],X$7.prototype,"writeAuthoringApp",null),e$x([d$y({type:String,json:{write:{writerEnsuresNonNull:!0,ignoreOrigin:!0}}})],X$7.prototype,"authoringAppVersion",null),e$x([r$y("authoringAppVersion")],X$7.prototype,"writeAuthoringAppVersion",null),e$x([d$y({json:{write:{isRequired:!0,allowNull:!0,ignoreOrigin:!0,enabled:!0}}})],X$7.prototype,"ground",void 0),e$x([r$y("ground")],X$7.prototype,"writeGround",null),e$x([d$y({type:S$o.ofType(i$z),json:{write:!0}})],X$7.prototype,"transportationNetworks",void 0),e$x([d$y({type:a$G,nonNullable:!0,json:{write:{ignoreOrigin:!0,writer:(e,t,r,i)=>{if(e.slides&&e.slides.length>0){const r={...i,isPresentation:!0};t.presentation=e.write({},r);}}}}})],X$7.prototype,"presentation",void 0),e$x([d$y({type:l$x,nonNullable:!0,json:{write:{target:"initialState",isRequired:!0,ignoreOrigin:!0},default:()=>new l$x({viewingMode:"global",spatialReference:k$l.WebMercator})}})],X$7.prototype,"initialViewProperties",void 0),e$x([o$B("initialViewProperties",["initialState.environment","spatialReference","viewingMode","initialState.viewpoint"])],X$7.prototype,"readInitialViewProperties",null),e$x([d$y({type:k$l,json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],X$7.prototype,"spatialReference",null),e$x([d$y({type:["local","global"],json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],X$7.prototype,"viewingMode",null),e$x([d$y({type:b$p})],X$7.prototype,"portalItem",void 0),e$x([d$y()],X$7.prototype,"resourceInfo",void 0),X$7=e$x([i$H("esri.WebScene")],X$7);const Y$9=X$7;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function m$u(t){const{value:n,operations:e}=t;return {operations:e,value:e.create(n)}}function h$p(t,n,e){return t.operations.setExtent(t.value,n,e.value),e}function d$v(t){return {operations:t,value:t.create()}}function j$m(t,n,e=d$v(t)){return e.operations=t,t.copy(n,e.value),e}function k$h(t){return j$m(Z$8,O$n(0,0,0,p$K(t).radius))}const A$f=2**50;function x$n(){return j$m(_s,J$c([0,0,0],[A$f,0,0],[0,A$f,0]))}function P$i(t,n,e){return t.operations.axisAt(t.value,n,2,e)}function R$e(t,n,e,o){return t.operations.axisAt(t.value,n,e,o)}function S$j(t,n,e){return t.operations.intersectRay(t.value,n,e)}function C$e(t,n,e){return t.operations.intersectRayClosestSilhouette(t.value,n,e)}function O$h(t,n){return t.operations.altitudeAt(t.value,n)}function T$e(t,n,e,o){return t.operations.setAltitudeAt(t.value,n,e,o)}function q$c(e,o,r,u){return o!==u&&n$K(u,o),o$C(z$f,u[12],u[13],u[14]),T$e(e,z$f,r,z$f),u[12]=z$f[0],u[13]=z$f[1],u[14]=z$f[2],u}function w$i(t,n,e){return t.operations.elevate(t.value,n,e.value)}const z$f=n$F();function D$d(t,n,o,r,u){return u[0]=z$i(t,n),u[1]=z$i(t,o),u[2]=z$i(t,r),u}function F$9(t,n,e,a,i){r$B(e,t),r$B(I$d,n),j$p(I$d,I$d),_$f(a,I$d,e),_$f(i,a,e);}function H$d(t,n){return t?O$m(n):n.isGeographic?k$l.PlateCarree:n}const I$d=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const d$u=s$y.getLogger("esri.views.support.GroundViewElevationSampler");let f$r=class extends n$L.EventedAccessor{constructor(e){super(e),this.demResolution={min:-1,max:-1},this.noDataValue=n$M;}initialize(){this.view.basemapTerrain.on("elevation-change",(()=>this.emit("changed",{})));}get extent(){const e=this.view.basemapTerrain;return r$A(e.extent)&&e.spatialReference?m$C(e.extent,e.spatialReference):null}elevationAt(e){const t=e.spatialReference,r=this.spatialReference;if(!g$u(t,r)){const e=t?t.wkid:"unknown";return d$u.error(`Cannot sample elevation at a location with spatial reference (${e}) different from the view (${r.wkid})`),null}if(t$F(this.extent)||!r$I(this.extent,e)){const t=r$A(this.extent)?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return d$u.warn("#elevationAt()",`Point used to sample elevation (${e.x}, ${e.y}) is outside of the sampler extent (${t})`),this.noDataValue}return i$I(this.view.elevationProvider,e)}queryElevation(e){return h$v(e.clone(),this)}};e$x([d$y({readOnly:!0})],f$r.prototype,"demResolution",void 0),e$x([d$y({readOnly:!0})],f$r.prototype,"extent",null),e$x([d$y({readOnly:!0})],f$r.prototype,"noDataValue",void 0),e$x([d$y({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],f$r.prototype,"spatialReference",void 0),e$x([d$y({constructOnly:!0})],f$r.prototype,"view",void 0),f$r=e$x([i$H("esri.views.support.GroundViewElevationSampler")],f$r);const v$n=f$r;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let p$w=class extends p$N{constructor(e){super(e),this.handles=new u$D,this.view=null,this.layerViews=new S$o;}initialize(){this.handles.add(s$A(this,"view.map.ground",(e=>e.load()))),this.handles.add(this.layerViews.on("after-changes",(()=>this.layerViewsAfterChangesHandler())));}destroy(){this._set("view",null),this.handles&&(this.handles.destroy(),this.handles=null);}get elevationSampler(){return this.view?"2d"===this.view.type?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new v$n({view:this.view}):null:null}get updating(){return !this.suspended&&this.layerViews.some((e=>e.updating))}get suspended(){return !this.view||this.view.suspended}layerViewsAfterChangesHandler(){this.handles.remove("updating"),this.handles.add(this.layerViews.map((e=>e.watch("updating",(()=>this.updateUpdating()),!0))).toArray(),"updating"),this.updateUpdating();}updateUpdating(){this.notifyChange("updating");}};e$x([d$y({readOnly:!0})],p$w.prototype,"elevationSampler",null),e$x([d$y({type:Boolean,readOnly:!0})],p$w.prototype,"updating",null),e$x([d$y({constructOnly:!0})],p$w.prototype,"view",void 0),e$x([d$y({type:S$o,readOnly:!0})],p$w.prototype,"layerViews",void 0),e$x([d$y({readOnly:!0})],p$w.prototype,"suspended",null),p$w=e$x([i$H("esri.views.GroundView")],p$w);const l$v=p$w;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function l$u(l){return "global"===l?1:2}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const a$F=()=>import('./TileLayerView3D-695c0a71.js'),s$r=()=>Promise.resolve().then(function () { return ElevationLayerView3D; }),i$y={analysis:()=>import('./AnalysisLayerView3D-f97a62d7.js'),"base-dynamic":()=>import('./BaseDynamicLayerView3D-a21993fd.js'),"base-elevation":s$r,"base-tile":a$F,"bing-maps":a$F,"building-scene":()=>import('./BuildingSceneLayerView3D-6daa3500.js'),csv:()=>import('./CSVLayerView3D-ac2f7a29.js'),elevation:s$r,feature:()=>import('./FeatureLayerView3D-d9b6247f.js'),geojson:()=>import('./GeoJSONLayerView3D-8891e173.js'),graphics:()=>import('./GraphicsLayerView3D-9767926e.js'),group:()=>import('./GroupLayerView-c1f7755e.js'),imagery:()=>import('./ImageryLayerView3D-dea74832.js'),"integrated-mesh":()=>import('./IntegratedMeshLayerView3D-71b14940.js'),"map-image":()=>import('./MapImageLayerView3D-69bad130.js'),"ogc-feature":()=>import('./OGCFeatureLayerView3D-4d6db4c9.js'),"open-street-map":a$F,"point-cloud":()=>import('./PointCloudLayerView3D-99eabc25.js').then(function (n) { return n.P; }),voxel:()=>import('./VoxelLayerView3D-f7c19052.js'),scene:e=>null==e.profile||"mesh-pyramids"===e.profile?import('./SceneLayerView3D-d419d792.js'):import('./SceneLayerGraphicsView3D-56ab2602.js'),stream:()=>import('./StreamLayerView3D-25dd79ed.js'),tile:a$F,"imagery-tile":()=>import('./ImageryTileLayerView3D-fab8c0ee.js'),"vector-tile":()=>import('./VectorTileLayerView3D-82706d05.js'),wcs:()=>import('./ImageryTileLayerView3D-fab8c0ee.js'),"web-tile":a$F,wfs:()=>import('./WFSLayerView3D-124857b5.js'),wms:()=>import('./WMSLayerView3D-fb54505b.js'),wmts:()=>import('./WMTSLayerView3D-f110cecd.js'),"geo-rss":null,kml:null,"map-notes":null,route:null,"subtype-group":null,unknown:null,unsupported:null};function l$t(r){const a=r.declaredClass?r.declaredClass.slice(r.declaredClass.lastIndexOf(".")+1):"Unknown",s=a.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new s$w(`${s}:view-not-supported`,`${a} is not supported in 3D`)}const o$y={hasLayerViewModule:e=>r$A(i$y[e.type]),importLayerView:e=>{const a=i$y[e.type];if(!r$A(a))throw l$t(e);return a(e)}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const m$t=s$y.getLogger("esri.views.3d.state.Constraints");let c$z=class extends p$N{constructor(t){super(t),this.collision=new y$o,this.distance=1/0,this.minimumPoiDistance=4;}get altitude(){return 2===this.mode?null:this._get("altitude")||null}set altitude(t){2!==this.mode?this._set("altitude",t):m$t.warn("Altitude constraint is ignored in local scenes");}clampAltitude(t){return this.altitude?e$B(t,this.altitude.min,this.altitude.max):t}clampTilt(t,e){if(!this.tilt)return e;const i=this.tilt(t);return e$B(e,i.min,i.max)}clampDistance(t){return Math.min(t,this.distance)}createDefaultTilt(){return 2===this.mode?this.createDefaultTiltLocal():this.createDefaultTiltGlobal()}createConstantMaxTilt(t){return (e,i=h$o)=>(i.min=d$t.min,i.max=t,i)}createDefaultTiltLocal(){const t=this.collision.enabled?I$i([[4e3,d$t.max],[1e4,M$f(88)],[6e6,M$f(88)]]):()=>d$t.max;return (e,i=h$o)=>(i.min=d$t.min,i.max=t(e),i)}createDefaultTiltGlobal(){const t=this.collision.enabled?I$i([[4e3,d$t.max],[5e4,M$f(88)],[6e6,M$f(88)],[2e7,d$t.min]]):I$i([[3e5,d$t.max],[3e6,M$f(88)],[6e6,M$f(88)],[2e7,d$t.min]]);return (e,i=h$o)=>(i.min=d$t.min,i.max=t(e),i)}};function p$v(t){return {min:-2e5,max:4*t.radius}}e$x([d$y()],c$z.prototype,"altitude",null),e$x([d$y({readOnly:!0})],c$z.prototype,"collision",void 0),e$x([d$y()],c$z.prototype,"distance",void 0),e$x([d$y({readOnly:!0})],c$z.prototype,"minimumPoiDistance",void 0),e$x([d$y()],c$z.prototype,"tilt",void 0),e$x([d$y({constructOnly:!0})],c$z.prototype,"mode",void 0),c$z=e$x([i$H("esri.views.3d.state.Constraints")],c$z);const u$v=p$v(s$B),d$t={min:M$f(.5),max:M$f(179.5)},h$o={min:0,max:0};let y$o=class extends p$N{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5;}};e$x([d$y({type:Boolean})],y$o.prototype,"enabled",void 0),e$x([d$y({type:Number})],y$o.prototype,"elevationMargin",void 0),y$o=e$x([i$H("esri.views.3d.state.Constraints.CollisionConstraint")],y$o);const f$q=c$z;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let c$y=class extends p$N{constructor(){super(...arguments),this.min=u$v.min,this.max=u$v.max;}set mode(e){s$C(s$y.getLogger(this.declaredClass),"esri.views.SceneView.constraints.altitude.mode is deprecated. The altitude constraint no longer applies to local scenes and does not have an automatic mode anymore.",{version:"4.6"});}get mode(){return s$C(s$y.getLogger(this.declaredClass),"esri.views.SceneView.constraints.altitude.mode is deprecated. The altitude constraint no longer applies to local scenes and does not have an automatic mode anymore.",{version:"4.6"}),"manual"}};e$x([d$y({type:Number})],c$y.prototype,"min",void 0),e$x([d$y({type:Number})],c$y.prototype,"max",void 0),c$y=e$x([i$H("esri.views.3d.constraints.AltitudeConstraint")],c$y);const n$y=c$y;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let o$x=class extends p$N{constructor(){super(...arguments),this.mode="auto";}get near(){return this._get("near")}set near(t){this._set("near",t),t>=this._get("far")&&(this.far=t+1e-9),this.mode="manual";}castNear(t){return Math.max(1e-8,t)}get far(){return this._get("far")}set far(t){this._set("far",t),t<=this._get("near")&&(this.near=t-1e-9),this.mode="manual";}castFar(t){return Math.max(1e-8,t)}autoUpdate(t,r){"auto"===this.mode&&(this._get("near")!==t&&this._set("near",t),this._get("far")!==r&&this._set("far",r));}};e$x([d$y({type:Number,value:1e-8})],o$x.prototype,"near",null),e$x([c$P("near")],o$x.prototype,"castNear",null),e$x([d$y({type:Number,value:1e-8})],o$x.prototype,"far",null),e$x([c$P("far")],o$x.prototype,"castFar",null),e$x([d$y({type:["auto","manual"]})],o$x.prototype,"mode",void 0),o$x=e$x([i$H("esri.views.3d.constraints.ClipDistanceConstraint")],o$x);const i$x=o$x;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const i$w={min:m$z(d$t.min),max:m$z(d$t.max)};let p$u=class extends p$N{constructor(){super(...arguments),this.mode="auto";}get max(){return this._get("max")}set max(t){this._set("max",t),this.mode="manual";}castMax(t){return e$B(t,i$w.min,i$w.max)}autoUpdate(t){"auto"===this.mode&&this._get("max")!==t&&this._set("max",t);}};e$x([d$y({type:["auto","manual"]})],p$u.prototype,"mode",void 0),e$x([d$y({type:Number,value:i$w.max})],p$u.prototype,"max",null),e$x([c$P("max")],p$u.prototype,"castMax",null),p$u=e$x([i$H("esri.views.3d.constraints.TiltConstraint")],p$u);const n$x=p$u;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let c$x=class extends p$N{constructor(){super(...arguments),this.tilt=new n$x,this.altitude=new n$y,this.clipDistance=new i$x;}};e$x([d$y({type:n$x})],c$x.prototype,"tilt",void 0),e$x([d$y({type:n$y})],c$x.prototype,"altitude",void 0),e$x([d$y({type:i$x})],c$x.prototype,"clipDistance",void 0),c$x=e$x([i$H("esri.views.3d.constraints.Constraints")],c$x);const a$E=c$x;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var t$C;let i$v=t$C=class extends p$N{set quality(r){-1!==["low","high"].indexOf(r)&&this._set("quality",r);}clone(){return new t$C({quality:this.quality})}};e$x([d$y({type:["low","high"],value:"low"})],i$v.prototype,"quality",null),i$v=t$C=e$x([i$H("esri.views.3d.environment.SceneViewAtmosphere")],i$v);const c$w=i$v;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var s$q;let a$D=s$q=class extends(n$L.EventedMixin(p$H)){constructor(e){super(e),this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0},this.cameraTrackingEnabled=!0,this.ambientOcclusionEnabled=!1,this.waterReflectionEnabled=!1;const t=(new Date).getFullYear(),o=new Date("March 15, "+t+" 12:00:00 UTC");this._set("defaultDate",o),this._set("date",o);}static fromWebsceneLighting(e){return new s$q({...e.cloneConstructProperties()})}get defaultDate(){return new Date(this._get("defaultDate").getTime())}set defaultDate(e){const t=this._get("date")===this._get("defaultDate");e=new Date(e.getTime()),this._set("defaultDate",e),t&&this._set("date",e);}set date(e){null!=e&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(e.getTime())));}autoUpdate(e,t){const o=r$w(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=t.hours,this.positionTimezoneInfo.minutes=t.minutes,this.positionTimezoneInfo.seconds=t.seconds;let i=null;null!=e&&(this.positionTimezoneInfo.autoUpdated=!0,i=this.date&&this.date.getTime(),this._set("date",new Date(e.getTime())));const n=r$w(this.positionTimezoneInfo);if(o!==n&&(d$s.target=this,d$s.timezoneOffset=n,this.emit("timezone-will-change",d$s)),null!=e)return i!==e.getTime()}clone(){const e=this._get("date")===this._get("defaultDate"),t=new s$q({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled,ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled});return e&&t._set("date",t._get("defaultDate")),t.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,t.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,t.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,t.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,t}cloneWithWebsceneLighting(e){const t=this.clone();return null!=e.date&&(t.date=e.date),t.directShadowsEnabled=e.directShadowsEnabled,t.displayUTCOffset=e.displayUTCOffset,t}};function r$w({hours:e,minutes:t,seconds:o}){return Math.round(e+t/60+o/3600)}e$x([d$y({type:Boolean})],a$D.prototype,"cameraTrackingEnabled",void 0),e$x([d$y({type:Boolean})],a$D.prototype,"ambientOcclusionEnabled",void 0),e$x([d$y({type:Boolean})],a$D.prototype,"waterReflectionEnabled",void 0),e$x([d$y({type:Date})],a$D.prototype,"defaultDate",null),e$x([d$y({type:Date})],a$D.prototype,"date",null),a$D=s$q=e$x([i$H("esri.views.3d.environment.SceneViewLighting")],a$D);const d$s={target:null,timezoneOffset:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var l$s;let m$s=l$s=class extends c$K{constructor(e){super(e),this.atmosphere=new c$w,this.weather=null;}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new l$s({...t,lighting:a$D.fromWebsceneLighting(t.lighting)})}castLighting(e){return this.convertLighting(e)}applyLighting(e){this.lighting=this.convertLighting(e);}convertLighting(e){return e?e instanceof a$D?e:e instanceof p$H?this.lighting?this.lighting.cloneWithWebsceneLighting(e):a$D.fromWebsceneLighting(e):b$n(a$D,e):new a$D}clone(){return new l$s({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),weather:r$A(this.weather)?this.weather.clone():null,atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:l$A(this.background)})}cloneWithWebsceneEnvironment(e){return new l$s({atmosphere:this.atmosphere.clone(),weather:r$A(this.weather)?this.weather.clone():null,atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:l$A(this.background),...e.cloneConstructProperties(),lighting:null!=this.lighting?this.lighting.cloneWithWebsceneLighting(e.lighting):a$D.fromWebsceneLighting(e.lighting)})}};e$x([d$y({type:c$w,json:{read:!1}})],m$s.prototype,"atmosphere",void 0),e$x([d$y({types:y$p,json:{write:!1}})],m$s.prototype,"weather",void 0),e$x([d$y()],m$s.prototype,"lighting",void 0),e$x([c$P("lighting")],m$s.prototype,"castLighting",null),m$s=l$s=e$x([i$H("esri.views.3d.environment.SceneViewEnvironment")],m$s);const u$u=m$s;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function t$B(e){const t=1e5,n=1e6;return Math.min(1,Math.max(0,(e-t)/(n-t)))}const n$w=1e4,o$w=r$D(5802e-9,13558e-9,331e-7),c$v=3,r$v=r$D(65e-8*c$v,1881e-9*c$v,85e-9*c$v),s$p=3996e-9,a$C=.085,f$p=1e5;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function o$v(o){const l=new n$N;return l.attributes.add("position","vec2"),l.include(t$I,{attributeTextureCoordinates:1}),l.varyings.add("worldRay","vec3"),l.varyings.add("eyeDir","vec3"),l.vertex.uniforms.add("projectionInverse","mat4"),l.vertex.uniforms.add("viewInverse","mat4"),l.vertex.code.add(t$J`void main(void) {
vec3 posViewNear = (projectionInverse * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (viewInverse * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),l.fragment.uniforms.add("lightingMainDirection","vec3").add("radii","vec2").add("scaleHeight","float").add("cameraPosition","vec3").add("nearFar","vec2").add("heightParameters","vec4").add("innerFadeDistance","float").add("altitudeFade","float").add("depthTex","sampler2D").add("betaRayleigh","vec3").add("betaCombined","vec3").add("betaMie","float"),l.include(e$C),o.haze&&l.fragment.include(a$U),l.fragment.code.add(t$J`vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = planet ? heightParameters[1] - radius * radius : heightParameters[2];
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),l.fragment.code.add(t$J`float chapmanApproximation(float X, float h, float cosZenith) {
float c = sqrt(X + h);
float cExpH = c * exp(-h);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),l.fragment.code.add(t$J`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),l.fragment.code.add(t$J`
    const int STEPS = 6;

    float getGlow(float dist, float radius, float intensity) {
      return pow(radius / max(dist, 1e-6), intensity);
    }

    vec3 getAtmosphereColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      float reducedPlanetRadius = radii[0] * 0.995;
      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);
      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);
      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
      bool insideAtmosphere = heightParameters[0] < radii[1];

      if (!(hitsAtmosphere || insideAtmosphere)) {
        return vec3(0);
      }

      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;

      float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;

      if (heightParameters[0] < reducedPlanetRadius) {
        // Long light rays from the night side of the planet lead to numerical instability
        // Do not render the atmosphere in such cases
        if (dot(rayDir, normalize(cameraPos)) < -0.025) {
          return vec3(0);
        }
        start = rayPlanetIntersect.y;
      }

      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
      float maxEnd = end;

      ${o.haze?t$J`if (terrainDepth != -1.0) { end = terrainDepth; }`:""}

      vec3 samplePoint = cameraPos + rayDir * end;
      float multiplier = hitsPlanet ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (end - start) / float(STEPS);
      for (int i = 0; i < STEPS; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= exp(-(betaRayleigh + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {

          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);

          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${o.haze?"":t$J`scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);`}
        }

        lastOpticalDepth = opticalDepth;

      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.05968310365 * mumu;

      ${o.haze?t$J`return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;`:t$J`
            const float g = 0.8;
            const float gg = g * g;
            float phaseMie = end == maxEnd ? 0.11936620731 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;
            phaseMie += getGlow(1.0 - mu, 5e-5, 3.0) * smoothstep(0.01, 0.1, length(scattering));
            phaseMie = clamp(phaseMie, 0.0, 128.0);
            return 4.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }

    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
      vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);
      if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
        return fragColor;
      }

      float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
      vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
      float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
      if (relDist > 1.0) {
        return surfaceColor;
      }

      return mix(gl_FragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${o.haze?t$J`
          vec4 depthSample = texture2D(depthTex, vuv0).rgba;
          if (depthSample != vec4(0)) {
            vec3 cameraSpaceRay = normalize(eyeDir);
            cameraSpaceRay /= cameraSpaceRay.z;
            cameraSpaceRay *= -linearDepthFromTexture(depthTex, vuv0, nearFar);
            terrainDepth = max(0.0, length(cameraSpaceRay));
          }`:t$J`
          float depthSample = texture2D(depthTex, vuv0).r;
          if (depthSample != 1.0) {
            gl_FragColor = vec4(0);
            return;
          }`}

      ${o.haze?t$J`
            vec3 col = vec3(0);
            if(depthSample != vec4(0)){
              col = getAtmosphereColour(cameraPosition, rayDir, lightingMainDirection, terrainDepth);
            }
            float alpha = 1.0;`:t$J`
            vec3 col = getAtmosphereColour(cameraPosition, rayDir, lightingMainDirection, terrainDepth);;
            float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));`}
      col = tonemapACES(col);
      gl_FragColor = delinearizeGamma(vec4(col, alpha));
      ${o.haze?"":t$J`
          if (depthSample == 1.0) {
            gl_FragColor = applyUndergroundAtmosphere(rayDir, lightingMainDirection, gl_FragColor);
          }`}
    }
  `),l}const l$r=Object.freeze({__proto__:null,build:o$v});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class c$u extends t$L{initializeProgram(e){const r=c$u.shader.get(),i=this.configuration,o=r.build({haze:i.haze});return new n$O(e.rctx,o,o$F)}initializePipeline(){return this.configuration.haze?g$v({blending:e$E(1,0,769,1),colorWrite:r$J}):g$v({blending:e$E(770,1,771,771),depthTest:{func:515},colorWrite:r$J})}}c$u.shader=new t$M(l$r,(()=>import('./ChapmanAtmosphere.glsl-29b809ba.js')));class g$r extends t$K{constructor(){super(...arguments),this.haze=!1;}}e$x([e$D()],g$r.prototype,"haze",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class B$c{constructor(e){this._view=e,this.canRender=!0,this._skyslot=12,this._hazeSlot=13,this._cameraPosition=n$F(),this._projectionInverse=e$y(),this._viewInverse=e$y(),this._heightParameters=n$P(),this._betasRayleigh=n$F(),this._betasCombined=n$F(),this._scaleHeight=0,this._radii=n$Q(),this._nearFar=n$Q(),this._cameraHeight=0,this._cameraHeightSq=0,this._cAtmosphere=0,this._innerFadeDistance=0,this._altitudeFade=0,this._lowerElevationBoundRadius=0,this._lowerBoundEarthRadius=s$B.radius,this._updateRadius(s$B.radius);}destroy(){this._atmosphereTechnique=h$w(this._atmosphereTechnique),this._atmosphereHazeTechnique=h$w(this._atmosphereHazeTechnique),this._vao=i$M(this._vao),this._handles=l$E(this._handles);}when(){return Promise.resolve()}initializeRenderContext(t){const i=t.renderContext.rctx;this._handles=new u$D,r$A(this._view.basemapTerrain.rootTiles)&&this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,context:"ground"}),this._handles.add($$9(this._view,"basemapTerrain","elevation-change",(e=>this._updateElevation(e)),(()=>this._updateElevation()))),this._handles.add($$9(this._view,"basemapTerrain","elevation-bounds-change",(()=>this._updateVisibleElevationBounds())));const s=new g$r;s.haze=!1,this._atmosphereTechnique=t.shaderTechniqueRep.acquire(c$u,s),s.haze=!0,this._atmosphereHazeTechnique=t.shaderTechniqueRep.acquire(c$u,s),this._vao=i$N(i,s$D),this._scaleHeight=a$C*f$p,o$C(this._betasRayleigh,o$w[0],o$w[1],o$w[2]),o$C(this._betasCombined,o$w[0]+r$v[0],o$w[1]+r$v[1],o$w[2]+r$v[2]);}uninitializeRenderContext(){this.destroy();}render(e){if(e.slot!==this._hazeSlot&&e.slot!==this._skyslot||0!==e.pass)return !1;this._update(e.camera);const t=e.rctx,i=e.offscreenRenderingHelper,s=e.slot===this._skyslot?this._atmosphereTechnique:this._atmosphereHazeTechnique,a=e.slot===this._skyslot?i.depthTexture:i.linearDepthTexture;return t.useProgram(s.program),s.bindPipelineState(t),i.renderDepthDetached((()=>{s.program.bindTexture(a,"depthTex"),this._renderCommon(s.program,e);})),!0}_renderCommon(e,t){if(t$F(this._vao))return !1;const i=t.rctx;return t.scenelightingData.setLightDirectionUniform(e),e.setUniform4fv("heightParameters",this._heightParameters),e.setUniform3fv("cameraPosition",this._cameraPosition),e.setUniformMatrix4fv("projectionInverse",this._projectionInverse),e.setUniformMatrix4fv("viewInverse",this._viewInverse),e.setUniform2fv("nearFar",this._nearFar),e.setUniform2fv("radii",this._radii),e.setUniform1f("scaleHeight",this._scaleHeight),e.setUniform1f("betaMie",s$p),e.setUniform3fv("betaRayleigh",this._betasRayleigh),e.setUniform3fv("betaCombined",this._betasCombined),e.setUniform1f("innerFadeDistance",this._innerFadeDistance),e.setUniform1f("altitudeFade",this._altitudeFade),i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(5,0,4),!0}_adjustRadiusForTesselation(e){return e*Math.cos(Math.PI/16/16)}_updateElevation(e){const t=e?e.tile:c$N(this._view.basemapTerrain.rootTiles,[null])[0];if(t$F(t)||0!==t.lij[0])return;const i=this._adjustRadiusForTesselation(s$B.radius+t.elevationBounds[0]);i!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=i,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds());}_updateVisibleElevationBounds(){const e=this._adjustRadiusForTesselation(s$B.radius+this._view.basemapTerrain.elevationBounds.min);(this._lowerBoundEarthRadius<0||e<this._lowerBoundEarthRadius)&&this._updateRadius(e);}_updateRadius(e){this._lowerBoundEarthRadius=e,r$K(this._radii,e,e+f$p),this._innerFadeDistance=2*Math.sqrt((2*e-n$w)*n$w);}_update(e){if(t$F(e))return;this._cameraHeight=s$x(e.eye),this._cameraHeightSq=this._cameraHeight*this._cameraHeight,this._cAtmosphere=this._cameraHeightSq-this._radii[1]*this._radii[1];const t=Math.min(1,Math.max(0,(this._cameraHeight-this._radii[0])/f$p));this._heightParameters=r$L(this._cameraHeight,this._cameraHeightSq,this._cAtmosphere,t),r$B(this._cameraPosition,e.eye),h$x(this._projectionInverse,e.projectionMatrix),h$x(this._viewInverse,e.viewMatrix),r$K(this._nearFar,e.near,e.far),this._altitudeFade=t$B(this._cameraHeight-this._lowerBoundEarthRadius);}static isSupported(e){return e.renderContext.rctx.capabilities.depthTexture}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function i$u(n=x$m){return [n[0],n[1],n[2],n[3]]}function m$r(n,t){return g$q(n[0],n[1],n[2],t,r$M.get())}function g$q(n,t,r,u,o=i$u()){return o[0]=n,o[1]=t,o[2]=r,o[3]=u,o}function k$g(n,t,r=i$u()){return _$f(r,n,t),j$p(r,r),r[3]=f$v(n,t),r}function v$m(n){return n}const x$m=[0,0,1,0];

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function a$B(a){a.fragment.uniforms.add("anchorPosition","vec3").add("anchorPositionCrossFade","vec3").add("fadeInOutFactor","float").add("cloudsHeight","float").add("rotationMatrixClouds","mat4").add("rotationMatrixCloudsCrossFade","mat4").add("radiusCurvatureCorrectionFactor","float").add("radius","float").add("cameraPosition","vec3").add("totalFadeInOut","float").add("crossFade","int").add("crossFadeAnchorFactor","float").add("cloudVariables","vec2"),a.include(t$N),a.fragment.code.add(t$J`vec3 intersectWithCloudLayer(vec3 dir, vec3 camPos, vec3 spherePos, float radiusReduction)
{
vec3 dirAnchor = normalize(spherePos);
vec3 sphereOriginOffset = dirAnchor * radiusReduction;
float radiusClouds = radius + cloudsHeight - radiusReduction;
float B = 2.0 * dot(camPos - sphereOriginOffset, dir);
float C = dot(camPos - sphereOriginOffset, camPos - sphereOriginOffset) - radiusClouds * radiusClouds;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
vec3 intersectionPont = camPos + dir * pointIntDist;
intersectionPont =  intersectionPont - spherePos;
return intersectionPont;
}`),a.fragment.code.add(t$J`vec3 correctForPlanetCurvature(vec3 dir)
{
dir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;
return dir;
}`),a.fragment.code.add(t$J`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)
{
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),a.fragment.code.add(t$J`const float SUNSET_TRANSITION_FACTOR = 0.3;
const vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);
const float RIM_SCATTERING_FACTOR = 140.0;
const float BACKLIGHT_FACTOR = 0.2;
const float BACKLIGHT_SCATTERING_FACTOR = 10.0;
const float BACKLIGHT_TRANSITION_FACTOR = 0.3;
const float GAMMA_SRGB = 2.1;
const float INV_GAMMA_SRGB = 0.4761904;
vec3 calculateCloudColor(vec3 worldSpaceRay, vec4 clouds)
{
float upDotLight = dot(normalize(cameraPosition), normalize(lightingMainDirection));
float dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(lightingMainDirection)), 0.0);
float sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);
vec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);
vec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);
vec3 combinedLight = clamp((lightingMainIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA_SRGB)), vec3(INV_GAMMA_SRGB));
float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
float rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);
vec3 directSunScattering = RIM_COLOR * rimLightIntensity * pow(dirDotLight, RIM_SCATTERING_FACTOR) * scatteringMod;
float additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;
return vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);
}`),a.fragment.code.add(t$J`vec4 getCloudData(vec3 rayDir)
{
vec4 cloudData = textureCube(cubeMap, rayDir);
float mu = dot(rayDir, vec3(0, 0, 1));
return mix(vec4(vec3(clamp(1.0 - cloudVariables.y, 0.5, 1.0)), 0.0), cloudData, smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(mu)));
}`),a.fragment.code.add(t$J`vec4 renderCloud(vec3 worldRay)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition, 0.0);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected);
float totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudData.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(calculateCloudColor(normalize(-worldRay), cloudData), totalTransmittance);
}`),a.fragment.code.add(t$J`vec4 renderCloudCrossFade(vec3 worldRay)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition, 0.0);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected);
vec4 cloudColor = vec4(calculateCloudColor(normalize(-worldRay), cloudData), cloudData.a);
intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPositionCrossFade, 0.0);
worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = getCloudData(worldRayRotatedCorrected);
vec4 cloudColorCrossFade = vec4(calculateCloudColor(normalize(-worldRay), cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);
float totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudColor.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(cloudColor.rgb, totalTransmittance);
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function s$o(){const s=new n$N;return s.attributes.add("position","vec2"),s.varyings.add("worldRay","vec3"),s.vertex.uniforms.add("inverseProjectionMatrix","mat4"),s.vertex.uniforms.add("inverseViewMatrix","mat4"),s.vertex.code.add(t$J`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;
gl_Position = vec4(position, 1.0, 1.0);
}`),s.fragment.uniforms.add("lightingMainDirection","vec3").add("cubeMap","samplerCube"),s.fragment.include(e$F),s.fragment.include(a$V),s.include(n$R),s.include(n$S,{pbrMode:0,lightingSphericalHarmonicsOrder:2}),s.include(a$B),s.fragment.code.add(t$J`void main() {
vec4 cloudsColor = crossFade == 0 ? renderCloud(normalize(worldRay)) : renderCloudCrossFade(normalize(worldRay));
gl_FragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);
}`),s}const l$q=Object.freeze({__proto__:null,build:s$o});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class a$A extends t$L{initializeProgram(e){const r=a$A.shader.get().build();return new n$O(e.rctx,r,o$F)}initializePipeline(){return g$v({blending:t$O(1,770),depthTest:{func:515},colorWrite:r$J})}}a$A.shader=new t$M(l$q,(()=>import('./CloudsComposition.glsl-2d5c409f.js')));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var O$g,H$c,S$i,p$t;!function(a){a[a.FINISHED=0]="FINISHED",a[a.CHANGE_ANCHOR=1]="CHANGE_ANCHOR",a[a.FADE_IN=2]="FADE_IN";}(O$g||(O$g={})),function(a){a[a.FINISHED=0]="FINISHED",a[a.FADE_OUT=1]="FADE_OUT",a[a.FADE_IN=2]="FADE_IN";}(H$c||(H$c={})),function(a){a[a.FINISHED=0]="FINISHED",a[a.CROSS_FADE=1]="CROSS_FADE";}(S$i||(S$i={})),function(a){a[a.FINISHED=0]="FINISHED",a[a.HEIGHT_FADE=1]="HEIGHT_FADE";}(p$t||(p$t={}));class x$l{constructor(a,t,s,r){this._viewingMode=t,this._inverseProjectionMatrix=e$y(),this._inverseViewMatrix=e$y(),this._cameraPositionLastFrame=n$F(),this._cloudCompositionTechnique=new a$A({rctx:a,viewingMode:this._viewingMode},null),this._vao=i$N(a),this._setDefaultParallax(s,r);}destroy(){this._cloudCompositionTechnique=h$w(this._cloudCompositionTechnique),this._vao=i$M(this._vao);}render(a,t,s,i,o){const n=a.camera;if(t$F(this._vao)||t$F(n))return !1;const h=a.rctx,d=this._cloudCompositionTechnique.program;return h.useProgram(d),this._cloudCompositionTechnique.bindPipelineState(h),this._isCameraAnimating=s,a.scenelightingData.setLightDirectionUniform(d),a.scenelightingData.setUniforms(d),h$x(this._inverseProjectionMatrix,n.projectionMatrix),h$x(this._inverseViewMatrix,n.viewMatrix),d.setUniformMatrix4fv("inverseProjectionMatrix",this._inverseProjectionMatrix),d.setUniformMatrix4fv("inverseViewMatrix",this._inverseViewMatrix),d.bindTexture(t.colorTexture,"cubeMap"),d.setUniform2fv("cloudVariables",[i,o]),this._setParallaxParams(n.eye),this._bindParallaxParams(d,a.camera),h.bindVAO(this._vao),d.assertCompatibleVertexAttributeLocations(this._vao),h.drawArrays(5,0,4),!0}isFading(){return this._crossFadeParams.crossFadeStage!==S$i.FINISHED||this._fadeInOutParams.fadeInOutStage!==H$c.FINISHED||this._fadeInParams.fadeInStage!==O$g.FINISHED||this._fadeInOutHeightParams.fadeHeightStage!==p$t.FINISHED}_setDefaultParallax(a,t){this._parallaxParams={anchorPointClouds:n$F(),radius:a,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:e$y()},this._parallaxParamsNew={anchorPointClouds:n$F(),radius:a,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:e$y()},this._crossFadeParams={crossFadeStage:S$i.FINISHED,crossFadeFactor:0,distanceThresholdFactor:.3},this._fadeInOutParams={fadeInOutStage:H$c.FINISHED,fadeInOutFactor:0,distanceThresholdFactor:.6},this._fadeInParams={fadeInStage:O$g.FINISHED,fadeInFactor:0,distanceThresholdFactor:2},this._fadeInOutHeightParams={fadeHeightStage:p$t.FINISHED,fadeHeightFactor:t>1e4?1:0,heightThresholdFactor:1e4};}_isCameraPossitionFinal(a){return G$f(this._cameraPositionLastFrame,a)}_setFadeInStage(a){const t=this._isCameraPossitionFinal(a);this._fadeInParams.fadeInStage===O$g.FINISHED&&(this._fadeInParams.fadeInFactor=1,r$B(this._parallaxParams.anchorPointClouds,C$d),this._fadeInParams.fadeInStage=O$g.CHANGE_ANCHOR,this._crossFadeParams.crossFadeStage=S$i.FINISHED,this._fadeInOutParams.fadeInOutStage=H$c.FINISHED),this._fadeInParams.fadeInStage===O$g.CHANGE_ANCHOR&&t&&(r$B(this._parallaxParams.anchorPointClouds,C$d),this._fadeInParams.fadeInStage=O$g.FADE_IN,this._startTime=performance.now()),this._fadeInParams.fadeInFactor>0&&this._fadeInParams.fadeInStage===O$g.FADE_IN&&(this._fadeInParams.fadeInFactor=1-(performance.now()-this._startTime)/500),this._fadeInParams.fadeInFactor<=0&&this._fadeInParams.fadeInStage===O$g.FADE_IN&&(this._fadeInParams.fadeInStage=O$g.FINISHED,this._fadeInParams.fadeInFactor=0);}_setCrossFadingStage(){this._crossFadeParams.crossFadeStage===S$i.FINISHED&&(r$B(this._parallaxParamsNew.anchorPointClouds,C$d),this._startTime=performance.now(),this._crossFadeParams.crossFadeFactor=0,this._crossFadeParams.crossFadeStage=S$i.CROSS_FADE),this._crossFadeParams.crossFadeFactor<1&&this._crossFadeParams.crossFadeStage===S$i.CROSS_FADE&&(this._crossFadeParams.crossFadeFactor=(performance.now()-this._startTime)/500),this._crossFadeParams.crossFadeFactor>=1&&this._crossFadeParams.crossFadeStage===S$i.CROSS_FADE&&(this._crossFadeParams.crossFadeStage=S$i.FINISHED,this._crossFadeParams.crossFadeFactor=1,r$B(this._parallaxParams.anchorPointClouds,this._parallaxParamsNew.anchorPointClouds));}_setFadeInOutStage(a){const t=this._isCameraPossitionFinal(a);this._fadeInOutParams.fadeInOutStage===H$c.FINISHED&&(this._startTime=performance.now(),this._fadeInOutParams.fadeInOutFactor=0,this._fadeInOutParams.fadeInOutStage=H$c.FADE_OUT),this._fadeInOutParams.fadeInOutFactor<1&&this._fadeInOutParams.fadeInOutStage===H$c.FADE_OUT&&(this._fadeInOutParams.fadeInOutFactor=(performance.now()-this._startTime)/250),this._fadeInOutParams.fadeInOutFactor>=1&&this._fadeInOutParams.fadeInOutStage===H$c.FADE_OUT&&(this._fadeInOutParams.fadeInOutFactor=1,r$B(this._parallaxParams.anchorPointClouds,C$d)),this._fadeInOutParams.fadeInOutFactor>=1&&this._fadeInOutParams.fadeInOutStage===H$c.FADE_OUT&&t&&(this._startTime=performance.now(),this._fadeInOutParams.fadeInOutFactor=1,this._fadeInOutParams.fadeInOutStage=H$c.FADE_IN,this._crossFadeParams.crossFadeStage=S$i.FINISHED,this._crossFadeParams.crossFadeFactor=0),this._fadeInOutParams.fadeInOutFactor>0&&this._fadeInOutParams.fadeInOutStage===H$c.FADE_IN&&(this._fadeInOutParams.fadeInOutFactor=1-(performance.now()-this._startTime)/500),this._fadeInOutParams.fadeInOutFactor<=0&&this._fadeInOutParams.fadeInOutStage===H$c.FADE_IN&&(this._fadeInOutParams.fadeInOutStage=H$c.FINISHED,this._fadeInOutParams.fadeInOutFactor=0);}_setFadeInOutHeight(t){const s=performance.now();this._startTimeHeightFade=this._fadeInOutHeightParams.fadeHeightStage===p$t.FINISHED?s:this._startTimeHeightFade,t?this._fadeInOutHeightParams.fadeHeightFactor+=(s-this._startTimeHeightFade)/500:this._fadeInOutHeightParams.fadeHeightFactor-=(s-this._startTimeHeightFade)/500,this._startTimeHeightFade=s,this._fadeInOutHeightParams.fadeHeightFactor=e$B(this._fadeInOutHeightParams.fadeHeightFactor,0,1),this._fadeInOutHeightParams.fadeHeightStage=p$t.HEIGHT_FADE;}_setParallaxParams(a){j$p(C$d,a),d$z(C$d,C$d,this._parallaxParams.radius),0===this._parallaxParams.anchorPointClouds[0]&&0===this._parallaxParams.anchorPointClouds[1]&&0===this._parallaxParams.anchorPointClouds[2]&&r$B(this._parallaxParams.anchorPointClouds,C$d);const t=s$x(c$O(N$h,this._parallaxParams.anchorPointClouds,C$d));let s=!0;t>this._fadeInParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._fadeInParams.fadeInStage!==O$g.FINISHED?this._setFadeInStage(a):t>this._fadeInOutParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._fadeInOutParams.fadeInOutStage!==H$c.FINISHED?this._setFadeInOutStage(a):(t>this._crossFadeParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._crossFadeParams.crossFadeStage!==S$i.FINISHED)&&!this._isCameraAnimating?this._setCrossFadingStage():s=!1;const r=s$x(a),e=r-this._parallaxParams.radius;e>1.7*this._fadeInOutHeightParams.heightThresholdFactor&&this._fadeInOutHeightParams.fadeHeightFactor<1?this._fadeInOutHeightParams.fadeHeightFactor=1:e>this._fadeInOutHeightParams.heightThresholdFactor&&this._fadeInOutHeightParams.fadeHeightFactor<1?this._setFadeInOutHeight(!0):e<this._fadeInOutHeightParams.heightThresholdFactor&&this._fadeInOutHeightParams.fadeHeightFactor>0?this._setFadeInOutHeight(!1):this._fadeInOutHeightParams.fadeHeightStage=p$t.FINISHED,this._parallaxParams.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(r*r-this._parallaxParams.radius*this._parallaxParams.radius,0))/r,k$g(E$g,this._parallaxParams.anchorPointClouds,D$c),this._parallaxParams.transform=e$y(),f$s(this._parallaxParams.transform,this._parallaxParams.transform,D$c[3],v$m(D$c)),s&&(k$g(E$g,this._parallaxParamsNew.anchorPointClouds,D$c),this._parallaxParamsNew.transform=e$y(),f$s(this._parallaxParamsNew.transform,this._parallaxParamsNew.transform,D$c[3],v$m(D$c))),r$B(this._cameraPositionLastFrame,a);}_bindParallaxParams(t,s){t.setUniform1f("cloudsHeight",this._parallaxParams.cloudsHeight),t.setUniformMatrix4fv("rotationMatrixClouds",this._parallaxParams.transform),t.setUniformMatrix4fv("rotationMatrixCloudsCrossFade",this._parallaxParamsNew.transform),t.setUniform3fv("anchorPosition",this._parallaxParams.anchorPointClouds),t.setUniform3fv("anchorPositionCrossFade",this._parallaxParamsNew.anchorPointClouds),this._fadeInOutParams.fadeInOutStage!==H$c.FINISHED?t.setUniform1f("totalFadeInOut",this._fadeInOutHeightParams.fadeHeightFactor+Math.max(e$B(this._fadeInOutParams.fadeInOutFactor,0,1))):t.setUniform1f("totalFadeInOut",this._fadeInOutHeightParams.fadeHeightFactor+Math.max(e$B(this._fadeInParams.fadeInFactor,0,1))),t.setUniform1f("radiusCurvatureCorrectionFactor",this._parallaxParams.radiusCurvatureCorrectionFactor),t.setUniform1i("crossFade",this._crossFadeParams.crossFadeStage),t.setUniform1f("crossFadeAnchorFactor",e$B(this._crossFadeParams.crossFadeFactor,0,1)),t.setUniform1f("radius",this._parallaxParams.radius),t.setUniform3fv("cameraPosition",s.eye);}}const E$g=r$D(0,0,1),D$c=i$u(),C$d=n$F(),N$h=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function n$v(){const n=new n$N;return n.attributes.add("position","vec3"),n.fragment.uniforms.add("cloudRadius","float").add("halfCubeMapSize","float").add("power","float").add("sigmaE","float").add("density","float").add("cloudSize","float").add("detailSize","float").add("smoothness","float").add("cloudHeight","float").add("coverage","float").add("viewMatrix","mat3").add("cloudShapeTexture","sampler2D"),n.vertex.code.add(t$J`void main(void) {
gl_Position = vec4(position, 1.0);
}`),n.fragment.code.add(t$J`const int STEPS = 200;
const int STEPS_LIGHT = 6;
const float stepL = 300.0 / float(STEPS_LIGHT);
const float cloudStart = 1500.0;
vec3 rayDirection(vec2 fragCoord) {
vec2 xy = fragCoord - halfCubeMapSize;
return normalize(vec3(-xy, -halfCubeMapSize));
}
float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}
float saturate(float x) {
return clamp(x, 0.0, 1.0);
}`),n.fragment.code.add("\n    float getCloudShape(vec3 pos, float pOffset) {\n      const float textureWidth = 1560.0;\n      const float dataWidth = 1560.0;\n      const float tileRows = 12.0;\n      const vec3 atlasDimensions = vec3(128.0, 128.0, 144.0);\n\n      //Change from Y being height to Z being height\n      vec3 p = pos.xzy;\n\n      //Pixel coordinates of point in the 3D data\n      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));\n      float f = fract(coord.z);\n      float level = floor(coord.z);\n      float tileY = floor(level / tileRows);\n      float tileX = level - tileY * tileRows;\n\n      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column\n      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;\n      vec2 pixel = coord.xy + offset;\n      vec2 data = texture2D(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;\n\n      return 1.0 - mix(data.x, data.y, f);\n    }"),n.fragment.code.add("\n    float clouds(vec3 p) {\n      float cloudVariations = getCloudShape(0.002 * p, 0.5);\n\n      float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));\n      cloud += (cloudVariations * 0.6 - 0.3) * ( -4.0 * (coverage * coverage - coverage));\n      float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);\n\n      //Round the bottom and top of the clouds\n      cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * saturate(remap(heightFraction, 0.75, 1.0, 1.0, 0.0));\n\n      float shape = getCloudShape(cloudSize * p, 0.0);\n      shape *= mix(0.0, 1.0, min(2.0 * (1.0 - coverage), 1.0));\n      cloud = saturate(remap(cloud, shape, 1.0, 0.0, 1.0));\n\n      if (cloud <= 0.0) {\n        return 0.0;\n      }\n\n      return density * saturate(remap(cloud, smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));\n    }"),n.fragment.code.add("\n    vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {\n      float a = dot(dir, dir);\n      float b = 2.0 * dot(dir, start);\n      float c = dot(start, start) - (radius * radius);\n      float d = (b * b) - 4.0 * a * c;\n\n      if (d < 0.0) {\n        return vec2(1e5, -1e5);\n      }\n\n      return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));\n    }\n      \n    float HenyeyGreenstein(float g, float costh) {\n      return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));\n    }\n    "),n.fragment.code.add("\n    vec3 multipleOctaves(float extinction, float mu, float stepL) {\n      float attenuation = 1.0;\n      float contribution = 1.0;\n      float phaseAttenuation = 1.0;\n      vec3 luminance = vec3(0);\n\n      for (int i = 0; i < 4; i++) {\n        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);\n        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);\n        attenuation *= 0.2;\n        contribution *= 0.6;\n        phaseAttenuation *= 0.5;\n      }\n\n      return luminance;\n    }"),n.fragment.code.add("\n    vec3 lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {\n      float lightRayDensity = clouds(p);\n      lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);\n      lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);\n      lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);\n      lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);\n      lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);\n      \n      vec3 beersLaw = multipleOctaves(lightRayDensity, mu, stepL);\n\n      return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);\n    }"),n.fragment.code.add('\n    vec3 mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {\n\n      // This is never true but having the if statement stops later loop unrolling, texture prefetching and WebGL context crashes\n      if (dir.z < 0.0) {\n        return vec3(0);\n      }\n\n      //Variable to track transmittance along view ray. Assume clear sky and attenuate light when encountering clouds.\n      totalTransmittance = 1.0;\n\n      float stepS = totalDistance / float(STEPS);\n      float cameraHeight = length(org);\n\n      //Alignment of view and light directions.\n      float mu = 0.5 + 0.5 * dot(sunDirection, dir);\n      float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);\n      \n      vec3 p = org + distToStart  * dir;\n      float dist = distToStart;\n      vec3 color = vec3(0.0);\n\n      for (int i = 0; i < STEPS; i++) {\n\n        float sampleDensity = clouds(p);\n        float sampleSigmaE = sampleDensity * sigmaE;\n\n        if (sampleDensity > 0.0 ) {\n          float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));\n\n          vec3 luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));\n          float transmittance = exp(-sampleSigmaE * stepS);\n\n          //Better energy conserving integration\n          //"From Physically based sky, atmosphere and cloud rendering in Frostbite" 5.6\n          color += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;\n\n          totalTransmittance *= transmittance;\n\n          //If ray combined transmittance is close to 0, nothing beyond this sample point is visible, so break early.\n          if (totalTransmittance <= 0.001) {\n            totalTransmittance = 0.0;\n            break;\n          }\n\n        }\n\n        dist += stepS;\n        p = org + dir * dist;\n      }\n\n      return color;\n    }'),n.fragment.code.add("\n    void main() {\n      vec3 rayDir = rayDirection(gl_FragCoord.xy);\n      rayDir = normalize(viewMatrix * rayDir);\n\n      vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);\n\n      bool hitsPlanet = rayDir.z < 0.0;\n\n      if (hitsPlanet) {\n        gl_FragColor = vec4(vec3(0), 1);\n        return;\n      }\n\n      vec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);\n      vec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);\n      float distToStart = rayStartIntersect.y;\n      float totalDistance = rayEndIntersect.y - distToStart;\n\n      float totalTransmittance = 1.0;\n      vec3 sunDirection = normalize(vec3(0, 0, 1));\n      vec3 col = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance).rgb;\n\n      gl_FragColor = vec4(col, totalTransmittance);\n    }\n  "),n}const a$z=Object.freeze({__proto__:null,build:n$v});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class a$y extends t$L{initializeProgram(e){const r=a$y.shader.get().build();return new n$O(e.rctx,r,o$F)}initializePipeline(){return g$v({blending:e$E(1,1,0,0),depthTest:{func:515},colorWrite:r$J})}}a$y.shader=new t$M(a$z,(()=>import('./Clouds.glsl-3687ea12.js')));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function o$u(){const o=new n$N;return o.attributes.add("position","vec3"),o.vertex.code.add(t$J`void main(void) {
gl_Position = vec4(position, 1.0);
}`),o.fragment.uniforms.add("tileRows","float").add("tileSize","float"),o.fragment.code.add("\n    #define NUM_CELLS 2.0\n    #define PERLIN_WORLEY 0\n    #define WORLEY 1\n\n    float remap(float x, float low1, float high1, float low2, float high2) {\n      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);\n    }\n\n    float saturate(float x) {\n      return clamp(x, 0.0, 1.0);\n    }\n\n    vec4 taylorInvSqrt(vec4 r) {\n      return 1.79284291400159 - 0.85373472095314 * r;\n    }\n\n    vec4 mod289(vec4 x) {\n      return x - floor( x * (1.0 / 289.0)) * 289.0;\n    }\n\n    vec4 permute(vec4 x) {\n      return mod289(((x * 34.0) + 1.0) * x);\n    }\n\n    vec4 fade(vec4 t) {\n      return (t * t * t) * (t * (t * vec4(6) - vec4(15)) + vec4(10));\n    }\n\n    float glmPerlin(vec4 Position, vec4 rep) {\n      vec4 Pi0 = mod(floor(Position), rep);\n      vec4 Pi1 = mod(Pi0 + float(1), rep);\n      vec4 Pf0 = fract(Position);\n      vec4 Pf1 = Pf0 - float(1);\n      vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);\n      vec4 iy = vec4(Pi0.y, Pi0.y, Pi1.y, Pi1.y);\n      vec4 iz0 = vec4(Pi0.z);\n      vec4 iz1 = vec4(Pi1.z);\n      vec4 iw0 = vec4(Pi0.w);\n      vec4 iw1 = vec4(Pi1.w);\n\n      vec4 ixy = permute(permute(ix) + iy);\n      vec4 ixy0 = permute(ixy + iz0);\n      vec4 ixy1 = permute(ixy + iz1);\n      vec4 ixy00 = permute(ixy0 + iw0);\n      vec4 ixy01 = permute(ixy0 + iw1);\n      vec4 ixy10 = permute(ixy1 + iw0);\n      vec4 ixy11 = permute(ixy1 + iw1);\n\n      vec4 gx00 = ixy00 / float(7);\n      vec4 gy00 = floor(gx00) / float(7);\n      vec4 gz00 = floor(gy00) / float(6);\n      gx00 = fract(gx00) - float(0.5);\n      gy00 = fract(gy00) - float(0.5);\n      gz00 = fract(gz00) - float(0.5);\n      vec4 gw00 = vec4(0.75) - abs(gx00) - abs(gy00) - abs(gz00);\n      vec4 sw00 = step(gw00, vec4(0));\n      gx00 -= sw00 * (step(float(0), gx00) - float(0.5));\n      gy00 -= sw00 * (step(float(0), gy00) - float(0.5));\n\n      vec4 gx01 = ixy01 / float(7);\n      vec4 gy01 = floor(gx01) / float(7);\n      vec4 gz01 = floor(gy01) / float(6);\n      gx01 = fract(gx01) - float(0.5);\n      gy01 = fract(gy01) - float(0.5);\n      gz01 = fract(gz01) - float(0.5);\n      vec4 gw01 = vec4(0.75) - abs(gx01) - abs(gy01) - abs(gz01);\n      vec4 sw01 = step(gw01, vec4(0.0));\n      gx01 -= sw01 * (step(float(0), gx01) - float(0.5));\n      gy01 -= sw01 * (step(float(0), gy01) - float(0.5));\n\n      vec4 gx10 = ixy10 / float(7);\n      vec4 gy10 = floor(gx10) / float(7);\n      vec4 gz10 = floor(gy10) / float(6);\n      gx10 = fract(gx10) - float(0.5);\n      gy10 = fract(gy10) - float(0.5);\n      gz10 = fract(gz10) - float(0.5);\n      vec4 gw10 = vec4(0.75) - abs(gx10) - abs(gy10) - abs(gz10);\n      vec4 sw10 = step(gw10, vec4(0.0));\n      gx10 -= sw10 * (step(float(0), gx10) - float(0.5));\n      gy10 -= sw10 * (step(float(0), gy10) - float(0.5));\n\n      vec4 gx11 = ixy11 / float(7);\n      vec4 gy11 = floor(gx11) / float(7);\n      vec4 gz11 = floor(gy11) / float(6);\n      gx11 = fract(gx11) - float(0.5);\n      gy11 = fract(gy11) - float(0.5);\n      gz11 = fract(gz11) - float(0.5);\n      vec4 gw11 = vec4(0.75) - abs(gx11) - abs(gy11) - abs(gz11);\n      vec4 sw11 = step(gw11, vec4(float(0)));\n      gx11 -= sw11 * (step(float(0), gx11) - float(0.5));\n      gy11 -= sw11 * (step(float(0), gy11) - float(0.5));\n\n      vec4 g0000 = vec4(gx00.x, gy00.x, gz00.x, gw00.x);\n      vec4 g1000 = vec4(gx00.y, gy00.y, gz00.y, gw00.y);\n      vec4 g0100 = vec4(gx00.z, gy00.z, gz00.z, gw00.z);\n      vec4 g1100 = vec4(gx00.w, gy00.w, gz00.w, gw00.w);\n      vec4 g0010 = vec4(gx10.x, gy10.x, gz10.x, gw10.x);\n      vec4 g1010 = vec4(gx10.y, gy10.y, gz10.y, gw10.y);\n      vec4 g0110 = vec4(gx10.z, gy10.z, gz10.z, gw10.z);\n      vec4 g1110 = vec4(gx10.w, gy10.w, gz10.w, gw10.w);\n      vec4 g0001 = vec4(gx01.x, gy01.x, gz01.x, gw01.x);\n      vec4 g1001 = vec4(gx01.y, gy01.y, gz01.y, gw01.y);\n      vec4 g0101 = vec4(gx01.z, gy01.z, gz01.z, gw01.z);\n      vec4 g1101 = vec4(gx01.w, gy01.w, gz01.w, gw01.w);\n      vec4 g0011 = vec4(gx11.x, gy11.x, gz11.x, gw11.x);\n      vec4 g1011 = vec4(gx11.y, gy11.y, gz11.y, gw11.y);\n      vec4 g0111 = vec4(gx11.z, gy11.z, gz11.z, gw11.z);\n      vec4 g1111 = vec4(gx11.w, gy11.w, gz11.w, gw11.w);\n\n      vec4 norm00 = taylorInvSqrt(vec4(dot(g0000, g0000), dot(g0100, g0100), dot(g1000, g1000), dot(g1100, g1100)));\n      g0000 *= norm00.x;\n      g0100 *= norm00.y;\n      g1000 *= norm00.z;\n      g1100 *= norm00.w;\n\n      vec4 norm01 = taylorInvSqrt(vec4(dot(g0001, g0001), dot(g0101, g0101), dot(g1001, g1001), dot(g1101, g1101)));\n      g0001 *= norm01.x;\n      g0101 *= norm01.y;\n      g1001 *= norm01.z;\n      g1101 *= norm01.w;\n\n      vec4 norm10 = taylorInvSqrt(vec4(dot(g0010, g0010), dot(g0110, g0110), dot(g1010, g1010), dot(g1110, g1110)));\n      g0010 *= norm10.x;\n      g0110 *= norm10.y;\n      g1010 *= norm10.z;\n      g1110 *= norm10.w;\n\n      vec4 norm11 = taylorInvSqrt(vec4(dot(g0011, g0011), dot(g0111, g0111), dot(g1011, g1011), dot(g1111, g1111)));\n      g0011 *= norm11.x;\n      g0111 *= norm11.y;\n      g1011 *= norm11.z;\n      g1111 *= norm11.w;\n\n      float n0000 = dot(g0000, Pf0);\n      float n1000 = dot(g1000, vec4(Pf1.x, Pf0.y, Pf0.z, Pf0.w));\n      float n0100 = dot(g0100, vec4(Pf0.x, Pf1.y, Pf0.z, Pf0.w));\n      float n1100 = dot(g1100, vec4(Pf1.x, Pf1.y, Pf0.z, Pf0.w));\n      float n0010 = dot(g0010, vec4(Pf0.x, Pf0.y, Pf1.z, Pf0.w));\n      float n1010 = dot(g1010, vec4(Pf1.x, Pf0.y, Pf1.z, Pf0.w));\n      float n0110 = dot(g0110, vec4(Pf0.x, Pf1.y, Pf1.z, Pf0.w));\n      float n1110 = dot(g1110, vec4(Pf1.x, Pf1.y, Pf1.z, Pf0.w));\n      float n0001 = dot(g0001, vec4(Pf0.x, Pf0.y, Pf0.z, Pf1.w));\n      float n1001 = dot(g1001, vec4(Pf1.x, Pf0.y, Pf0.z, Pf1.w));\n      float n0101 = dot(g0101, vec4(Pf0.x, Pf1.y, Pf0.z, Pf1.w));\n      float n1101 = dot(g1101, vec4(Pf1.x, Pf1.y, Pf0.z, Pf1.w));\n      float n0011 = dot(g0011, vec4(Pf0.x, Pf0.y, Pf1.z, Pf1.w));\n      float n1011 = dot(g1011, vec4(Pf1.x, Pf0.y, Pf1.z, Pf1.w));\n      float n0111 = dot(g0111, vec4(Pf0.x, Pf1.y, Pf1.z, Pf1.w));\n      float n1111 = dot(g1111, Pf1);\n\n      vec4 fade_xyzw = fade(Pf0);\n      vec4 n_0w = mix(vec4(n0000, n1000, n0100, n1100), vec4(n0001, n1001, n0101, n1101), fade_xyzw.w);\n      vec4 n_1w = mix(vec4(n0010, n1010, n0110, n1110), vec4(n0011, n1011, n0111, n1111), fade_xyzw.w);\n      vec4 n_zw = mix(n_0w, n_1w, fade_xyzw.z);\n      vec2 n_yzw = mix(vec2(n_zw.x, n_zw.y), vec2(n_zw.z, n_zw.w), fade_xyzw.y);\n      float n_xyzw = mix(n_yzw.x, n_yzw.y, fade_xyzw.x);\n      return float(2.2) * n_xyzw;\n    }\n\n    float getPerlinNoise(vec3 pos, float frequency) {\n      const float octaveFrequencyFactor = 2.0;\n\n      float sum = 0.0;\n      float weightSum = 0.0;\n      float weight = 1.0;\n\n      for (int oct = 0; oct < 3; oct++) {\n        vec3 p = pos * frequency;\n        float val = 0.5 + 0.5 * glmPerlin(vec4(p, 0.0), vec4(frequency));\n        sum += val * weight;\n        weightSum += weight;\n        weight *= 0.5;\n        frequency *= octaveFrequencyFactor;\n      }\n\n      float noise = (sum / weightSum);\n      noise = saturate(noise);\n      return noise;\n    }\n\n    float hash(float p) {\n      p = fract(p * 0.1031);\n      p *= p + 33.33;\n      p *= p + p;\n      return fract(p);;\n    }\n\n    float noise(vec3 x) {\n      vec3 p = floor(x);\n      vec3 f = fract(x);\n\n      f = f * f * (3.0 - 2.0 * f);\n      float n = p.x + p.y * 57.0 + 113.0 * p.z;\n\n      return mix(\n      mix(\n        mix(hash(n + 0.0), hash(n + 1.0), f.x),\n        mix(hash(n + 57.0), hash(n + 58.0), f.x),\n        f.y),\n      mix(\n        mix(hash(n + 113.0), hash(n + 114.0), f.x),\n        mix(hash(n + 170.0), hash(n + 171.0), f.x),\n        f.y),\n      f.z);\n    }\n\n    float worley(vec3 pos, float numCells) {\n      vec3 p = pos * numCells;\n      float d = 1.0e10;\n\n      for (int x = -1; x <= 1; x++) {\n        for (int y = -1; y <= 1; y++) {\n          for (int z = -1; z <= 1; z++) {\n            vec3 tp = floor(p) + vec3(x, y, z);\n            tp = p - tp - noise(mod(tp, numCells));\n            d = min(d, dot(tp, tp));\n          }\n        }\n      }\n\n      return 1.0 - clamp(d, 0.0, 1.0);\n    }\n\n    vec3 get3Dfrom2D(vec2 uv, float tileRows) {\n      vec2 tile = floor(uv);\n      float z = floor(tileRows * tile.y + tile.x);\n      return vec3(fract(uv), z);\n    }\n\n    float getTextureForPoint(vec3 p, int type) {\n      if (type == PERLIN_WORLEY) {\n\n        const float frequency = 8.0;\n        float perlinNoise = getPerlinNoise(p, frequency);\n\n        float worley0 = worley(p, NUM_CELLS * 2.0);\n        float worley1 = worley(p, NUM_CELLS * 8.0);\n        float worley2 = worley(p, NUM_CELLS * 14.0);\n\n        float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;\n        return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);\n      }\n\n      float worley0 = worley(p, NUM_CELLS);\n      float worley1 = worley(p, NUM_CELLS * 2.0);\n      float worley2 = worley(p, NUM_CELLS * 4.0);\n      float worley3 = worley(p, NUM_CELLS * 8.0);\n\n      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;\n      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;\n      float FBM2 = worley2 * 0.75 + worley3 * 0.25;\n\n      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;\n    }\n  "),o.fragment.code.add("\n    void main() {\n      const float padWidth = 1.0;\n      float paddedSize = tileSize + 2.0 * padWidth;\n      float tileCount = tileRows * tileRows;\n      vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);\n\n      bool padCell = false;\n      if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {\n        padCell = true;\n      }\n\n      if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {\n        padCell = true;\n      }\n\n      bool startPadX = false;\n      bool startPadY = false;\n      bool endPadX = false;\n      bool endPadY = false;\n\n      if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {\n        startPadX = true;\n      }\n\n      if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {\n        startPadY = true;\n      }\n\n      if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {\n        endPadX = true;\n      }\n\n      if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {\n        endPadY = true;\n      }\n\n      vec2 padding = vec2(2.0 * padWidth) * tile;\n      vec2 uv;\n\n      if (padCell) {\n        vec2 pixel = gl_FragCoord.xy - padWidth - padding;\n\n        if (startPadX) {\n          pixel.x += tileSize;\t\n        }\n\n        if (startPadY) {\n          pixel.y += tileSize;\t\n        }\n\n        if (endPadX) {\n          pixel.x -= tileSize;\t\n        }\n\n        if (endPadY) {\n          pixel.y -= tileSize;\t\n        }\n\n        uv = vec2(pixel.xy / tileSize);\n      } else {\n        vec2 pixel = gl_FragCoord.xy - padWidth - padding;\n        uv = vec2(pixel.xy / tileSize);\n      }\n\n      vec3 p_ = get3Dfrom2D(uv, tileRows);\n      vec3 p = p_;\n      p.z /= (tileRows * tileRows);\n\n      float worleyPerlinNoise = getTextureForPoint(p, PERLIN_WORLEY);\n      float worleyNoise = getTextureForPoint(p, WORLEY);\n\n      gl_FragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));\n\n      p_ = mod(p_ + 1.0, tileRows * tileRows);\n      p = p_;\n      p.z /= (tileRows * tileRows);\n\n      worleyPerlinNoise = getTextureForPoint(p, PERLIN_WORLEY);\n      worleyNoise = getTextureForPoint(p, WORLEY);\n\n      gl_FragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));\n\n    \tgl_FragColor.ba = vec2(0, 1);\n    }\n  "),o}const t$A=Object.freeze({__proto__:null,build:o$u});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class a$x extends t$L{initializeProgram(e){const r=a$x.shader.get().build();return new n$O(e.rctx,r,o$F)}initializePipeline(){return g$v({blending:t$O(1,0),depthTest:{func:515},colorWrite:r$J})}}a$x.shader=new t$M(t$A,(()=>import('./NoiseTextureAtlas.glsl-a57c6932.js')));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class a$w{constructor(e,t){this._shapeTextureDescriptor={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,hasMipmap:!1,width:1,height:1},this._tileSize=1,this._tileRows=1,this._frameBuffer=new l$F(e,{colorTarget:0}),this._vao=i$N(e),this.textureAtlas=new o$G(e,this._shapeTextureDescriptor,null),this._technique=new a$x({rctx:e,viewingMode:t.state.viewingMode},null);}destroy(){this._technique=h$w(this._technique),this._frameBuffer=i$M(this._frameBuffer),this._vao=i$M(this._vao),this.textureAtlas=i$M(this.textureAtlas);}render(e,t){if(t$F(this._vao)||t$F(this.textureAtlas))return !1;this._tileSize=e,this._tileRows=Math.ceil(Math.sqrt(this._tileSize));const r=(e+2)*this._tileRows;this._frameBuffer.resize(r,r),this.textureAtlas.resize(r,r),this._frameBuffer.attachColorTexture(this.textureAtlas),t.bindFramebuffer(this._frameBuffer);const s=this._technique.program;t.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),this._technique.bindPipelineState(t),t.useProgram(s),s.setUniform1f("tileSize",this._tileSize),s.setUniform1f("tileRows",this._tileRows);const o=t.getViewport();return t.setViewport(0,0,r,r),t.gl.drawArrays(t.gl.TRIANGLE_STRIP,0,4),this._frameBuffer.detachColorTexture(),t.setViewport(o.x,o.y,o.width,o.height),!0}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class f$o{constructor(e,t,i){this.rctx=e,this.requestRender=i,this._cubeMapSize=2048,this._viewMat3=e$A(),this._eye=a$W(),this._didRenderFaces=!1,this.viewDirections=[t$P(1,0,0),t$P(-1,0,0),t$P(0,1,0),t$P(0,-1,0),t$P(0,0,1)],this.upDirections=[t$P(0,1,0),t$P(0,1,0),t$P(0,0,-1),t$P(0,0,1),t$P(0,1,0)],this._cloudRadius=0,this._viewMatrix=e$y();const s=p$s.sunny;this.coverage=s.coverage[1]-.5*s.coverage[0],this.density=s.density[1]-.5*s.density[0],this.absorption=s.absorption[1]-.5*s.absorption[0],this.cloudSize=s.cloudSize[1]-.5*s.cloudSize[0],this.detailSize=s.detailSize[1]-.5*s.detailSize[0],this.smoothness=s.smoothness[1]-.5*s.smoothness[0],this.cloudHeight=s.cloudHeight[1]-.5*s.cloudHeight[0],this._noiseTextureAtlas=new a$w(e,t),this._noiseTextureAtlas.render(128,e);const r={target:34067,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,hasMipmap:!1,width:this._cubeMapSize,height:this._cubeMapSize};this._frameBufferCube=new l$F(e,{colorTarget:2,width:this._cubeMapSize,height:this._cubeMapSize},r),this._vao=i$N(e),this._technique=new a$y({rctx:e,viewingMode:t.state.viewingMode},null);const o=p$K(t.spatialReference);this._cloudRadius=.5*o.radius,this.resetRenderFlags();}set coverage(e){this._coverage=e,this.resetRenderFlags();}get coverage(){return this._coverage}set density(e){this._density=this.remap(e,0,1,0,.3),this.resetRenderFlags();}set cloudSize(e){this._cloudSize=this.remap(Math.max(.01,1-e),0,1,0,.02),this.resetRenderFlags();}set detailSize(e){this._detailSize=this.remap(Math.max(.01,1-e),0,1,0,.2),this.resetRenderFlags();}set smoothness(e){this._smoothness=this.remap(1-e,0,1,0,.5),this.resetRenderFlags();}set absorption(e){this._sigmaE=1+e,this._power=this.remap(e,0,1,35,70),this.resetRenderFlags();}get absorption(){return this._sigmaE-1}set cloudHeight(e){this._cloudHeight=this.remap(e,0,1,0,1500),this.resetRenderFlags();}get cloudHeight(){return this._cloudHeight}destroy(){this._technique=h$w(this._technique),this._frameBufferCube=i$M(this._frameBufferCube),this._vao=i$M(this._vao),this._noiseTextureAtlas=l$E(this._noiseTextureAtlas);}resetRenderFlags(){this._didRenderFaces=!1;}remap(e,t,i,s,r){return s+(e-t)*(r-s)/(i-t)}get running(){return !this._didRenderFaces}runTask(e){if(e.done)return;if(t$F(this._vao)||this._didRenderFaces)return;const t=this.rctx.getViewport();this.rctx.setViewport(0,0,this._cubeMapSize,this._cubeMapSize),this.rctx.bindFramebuffer(this._frameBufferCube,!1,34069);const i=this._technique.program;this.rctx.useProgram(i),i.bindTexture(this._noiseTextureAtlas.textureAtlas,"cloudShapeTexture"),i.setUniform1f("cloudRadius",this._cloudRadius),i.setUniform1f("halfCubeMapSize",.5*this._cubeMapSize),i.setUniform1f("power",this._power),i.setUniform1f("sigmaE",this._sigmaE),i.setUniform1f("density",this._density),i.setUniform1f("cloudSize",this._cloudSize),i.setUniform1f("detailSize",this._detailSize),i.setUniform1f("smoothness",this._smoothness),i.setUniform1f("cloudHeight",this._cloudHeight),i.setUniform1f("coverage",this._coverage),this.rctx.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),this._technique.bindPipelineState(this.rctx);for(let s=0;s<5;s++){const e=this.viewDirections[s],t=this.upDirections[s];Q$d(this._viewMatrix,this._eye,e,t),a$Q(this._viewMat3,this._viewMatrix),i.setUniformMatrix3fv("viewMatrix",this._viewMat3);const h=34069+s;this._frameBufferCube.framebufferTexture2D(this._frameBufferCube.colorAttachment.glName,this.rctx.gl,36064,h),this.rctx.gl.drawArrays(this.rctx.gl.TRIANGLE_STRIP,0,4),this.rctx.gl.flush();}this._didRenderFaces=!0,this.rctx.setViewport(t.x,t.y,t.width,t.height),e.madeProgress(),this.requestRender();}get test(){return {coverage:this._coverage,density:this.remap(this._density,0,.3,0,1),absorption:this._sigmaE-1,cloudSize:1-this.remap(this._cloudSize,0,.02,0,1),detailSize:1-this.remap(this._detailSize,0,.2,0,1),smoothness:1-this.remap(this._smoothness,0,.5,0,1),cloudHeight:this.remap(this._cloudHeight,0,1500,0,1)}}}class g$p{constructor(e,t,i,s,r,h,o,a=.5){this.coverage=e,this.density=t,this.absorption=i,this.cloudSize=s,this.detailSize=r,this.smoothness=h,this.cloudHeight=o,this.median=a;}}const p$s={sunny:new g$p([.1,.7],[.02,.02],[0,0],[.86,.86],[.8,.8],[.5,.5],[.05,.05]),cloudy:new g$p([.2,.6],[.2,.4],[0,0],[.5,.7],[.65,.7],[.77,.6],[1,1],.4),rainy:new g$p([.7,1],[.2,.5],[.2,1],[.8,.8],[.75,.8],[.75,.5],[.1,1]),foggy:new g$p([.75,1],[.1,.1],[0,0],[.8,.9],[.5,.93],[.75,.9],[.2,.4])};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function i$t(){const i=new n$N;return i.attributes.add("position","vec2"),i.include(t$I,{attributeTextureCoordinates:1}),i.varyings.add("worldRay","vec3"),i.varyings.add("eyeDir","vec3"),i.vertex.uniforms.add("projectionInverse","mat4"),i.vertex.uniforms.add("viewInverse","mat4"),i.vertex.code.add(t$J`void main(void) {
vec3 posViewNear = (projectionInverse * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (viewInverse * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),i.fragment.uniforms.add("lightingMainDirection","vec3").add("heightParameters","vec2").add("cameraPosition","vec3").add("nearFar","vec2").add("depthTex","sampler2D").add("strength","float").add("renderSkyFog","int"),i.include(e$C),i.fragment.include(a$U),i.fragment.code.add(t$J`vec2 sphereIntersect(vec3 start, vec3 dir) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = heightParameters[1];
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),i.fragment.code.add(t$J`vec4 applyFog(vec3  rgb, float dist, vec3 cameraPos, vec3 rayDir, vec3 sunDir){
bool sky = false;
if(dist == -1.0){
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir);
dist = 0.1 * rayAtmosphereIntersect.y;
sky = true;
}
float fogAmount = smoothstep(10000.0, 9000.0, heightParameters[0]) * (1.0 - exp(-dist * strength));
float sunAmount = max(0.0, dot(rayDir, sunDir));
float lightAngle = max(0.0, dot(normalize(cameraPos + dist * rayDir), sunDir));
vec3 fogColor = mix(vec3(0.15), vec3(1.5), lightAngle);
float phase = sky ? pow(sunAmount, 16.0) : 0.0;
vec3 col = (lightAngle * vec3(1.0, 0.6, 0.3) * phase + fogColor) * fogAmount;
return vec4(col, fogAmount);
}`),i.fragment.code.add(t$J`vec3 tonemapACES(vec3 x) {
return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
}
void main() {
vec3 rayDir = normalize(worldRay);
float terrainDepth = -1.0;
vec4 depthSample = texture2D(depthTex, vuv0).rgba;
if (depthSample != vec4(0)) {
vec3 cameraSpaceRay = normalize(eyeDir);
cameraSpaceRay /= cameraSpaceRay.z;
cameraSpaceRay *= -linearDepthFromTexture(depthTex, vuv0, nearFar);
terrainDepth = max(0.0, length(cameraSpaceRay));
}else if(renderSkyFog == 0){
gl_FragColor = vec4(0);
return;
}
vec4 fog = applyFog(vec3(0), terrainDepth, cameraPosition, rayDir, lightingMainDirection);
vec3 col =  fog.rgb;
gl_FragColor = delinearizeGamma(vec4(tonemapACES(col), fog.a));
}`),i}const n$u=Object.freeze({__proto__:null,build:i$t});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class a$v extends t$L{initializeProgram(e){const r=a$v.shader.get().build();return new n$O(e.rctx,r,o$F)}initializePipeline(){return g$v({blending:e$E(770,0,771,1),colorWrite:r$J})}}a$v.shader=new t$M(n$u,(()=>import('./Fog.glsl-c8dde344.js')));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class d$r{constructor(e,t){this.canRender=!0,this._slot=13,this._cameraPosition=n$F(),this._projectionInverse=e$y(),this._viewInverse=e$y(),this._nearFar=n$Q(),this._renderSkyFog=!1,this._heightParameters=n$Q(),this.strength=1e-5,this._technique=new a$v({rctx:e,viewingMode:t.state.viewingMode},null),this._vao=i$N(e,s$D);const r=p$K(t.spatialReference);this._planetRadius=r.radius,this._atmosphereRadius=r.radius+f$p;}set strength(e){this._strength=e;}get strength(){return this._strength}set renderSkyFog(e){this._renderSkyFog=e;}get renderSkyFog(){return this._renderSkyFog}destroy(){this._technique=h$w(this._technique),this._vao=i$M(this._vao);}when(){return Promise.resolve()}render(e){if(e.slot!==this._slot||0!==e.pass)return !1;this._update(e.camera);const t=e.rctx,r=e.offscreenRenderingHelper,s=r.linearDepthTexture;return t.useProgram(this._technique.program),this._technique.bindPipelineState(t),r.renderDepthDetached((()=>{this._technique.program.bindTexture(s,"depthTex"),this._renderFog(this._technique.program,e);})),!0}_renderFog(e,t){if(t$F(this._vao))return !1;const s=t.rctx;return t.scenelightingData.setLightDirectionUniform(e),e.setUniform3fv("cameraPosition",this._cameraPosition),e.setUniformMatrix4fv("projectionInverse",this._projectionInverse),e.setUniformMatrix4fv("viewInverse",this._viewInverse),e.setUniform2fv("nearFar",this._nearFar),e.setUniform2fv("heightParameters",this._heightParameters),e.setUniform1f("strength",this._strength),e.setUniform1i("renderSkyFog",this._renderSkyFog?1:0),s.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),s.drawArrays(5,0,4),!0}_update(e){if(t$F(e))return;r$B(this._cameraPosition,e.eye),h$x(this._projectionInverse,e.projectionMatrix),h$x(this._viewInverse,e.viewMatrix),r$K(this._nearFar,e.near,e.far);const t=s$x(e.eye),i=t*t-this._atmosphereRadius*this._atmosphereRadius;this._heightParameters=t$Q(t-this._planetRadius,i);}static isSupported(e){return e.renderContext.rctx.capabilities.depthTexture}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function t$z(t){const r=new n$N;if(2===t.geometry)r.attributes.add("position","vec2"),r.varyings.add("color","vec4"),r.vertex.uniforms.add("lightingMainDirection","vec3").add("cameraPosition","vec3").add("undergroundFadeAlpha","float"),r.vertex.code.add(t$J`void main(void) {
float ndotl = dot(normalize(cameraPosition), lightingMainDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);
}`),r.fragment.code.add(t$J`void main() {
gl_FragColor = color;
}`);else {r.include(r$N,{linearDepth:!1}),r.attributes.add("position","vec3"),r.varyings.add("vtc","vec2"),r.varyings.add("falloff","float");const i=1===t.geometry;r.vertex.uniforms.add("proj","mat4").add("view","mat4").add("lightingMainDirection","vec3"),i||(r.varyings.add("innerFactor","float"),r.vertex.uniforms.add("silCircleCenter","vec3").add("silCircleV1","vec3").add("silCircleV2","vec3").add("texV","vec2").add("innerScale","float"));const a=6.2831853,n=1/128;r.vertex.code.add(t$J`
		void main(void) {
      ${i?t$J`
      vec3 pos = position;
      float ndotl = lightingMainDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:t$J`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${t$J.float(a*n)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), lightingMainDirection);
      vtc.x = position.x  * ${t$J.float(n)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
    }
	  `),r.fragment.uniforms.add("tex","sampler2D"),i||r.fragment.uniforms.add("altitudeFade","float"),r.fragment.code.add(t$J`
		void main() {
			vec4 atmosphereColor = texture2D(tex, vtc) * falloff;
      ${i?t$J`gl_FragColor = atmosphereColor;`:t$J`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			gl_FragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));
      `}
    }`);}return r}const r$u=Object.freeze({__proto__:null,build:t$z});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class h$n extends t$L{initializeProgram(e){const r=h$n.shader.get(),i=this.configuration,t=r.build({geometry:i.geometry});return new n$O(e.rctx,t,o$F)}initializePipeline(){return 1===this.configuration.geometry?g$v({blending:e$E(770,1,771,771),culling:i$O,depthTest:{func:515},colorWrite:r$J}):g$v({blending:e$E(770,1,771,771),depthTest:{func:515},colorWrite:r$J})}}h$n.shader=new t$M(r$u,(()=>import('./SimpleAtmosphere.glsl-b5c5f6db.js')));class u$t extends t$K{constructor(){super(...arguments),this.geometry=0;}}e$x([e$D({count:3})],u$t.prototype,"geometry",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const A$e="data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAABD1gYFAAAACXBIWXMAAC4jAAAuIwF4pT92AAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAXVJREFUeNq0k9GWhDAIQ3PjzP9/cuehFqhW19mz++IhkCZAq1prsqT+kSQS9g8Vnqp6VGVWkYVktR6tj3Gr968nLnfwlHzHYyHapkKS73bPd/39eI38AYWj24OGvqdwWjZ3l8IDgacXyl1Dj9tdLOzZiicj+P1YcGk0H2O2vN/VQpTveEHmPHQxZxYlqsQdhUeuCWREuDEvAjqlCqDIMYwIo2ijR1HdYUS58dQrKpgQ0EGeMocsTNXrxzyOhS9kfzlWjn82YuWLqwAnvfNEWJFjYXkJCT0s7AmS0NG4x7Lt6Cpy2MiVPBZmS668QT5AR1cevp7b6CpzQ/ZSNH0vmhy5CsNtdax0MBpXDBiFsrDiMSLKMc8b6hH93bNbEpRsIyHDUhNcfTyeKF16PC7c/2QdczvUnvOB1ylZHVFSMtd5s8C2IW/7w6hwM5GLavLCd1zkiFjB+BwH1DSgctQ7mPOimBLJrw35beSXkd8BM/cCqbXWPgMA+GQQ5sIgkfAAAAAASUVORK5CYII=";

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const x$k=s$y.getLogger("esri.views.3d.environment.PanoramicAtmosphere");class j$l{constructor(){this.slot=12,this._atmosphereTechniqueConfig=new u$t,this._readyResolver=B$f(),this._readyController=new AbortController;}get canRender(){return null!=this._texture}destroy(){this._readyResolver.reject(),this._texture=i$M(this._texture),this._vao=i$M(this._vao),this._readyController=a$X(this._readyController);}when(){return this._readyResolver.promise}initializeRenderContext(e){this._atmosphereTechniqueConfig.geometry=1,this._atmosphereTechnique=e.shaderTechniqueRep.acquire(h$n,this._atmosphereTechniqueConfig);const t=e.renderContext.rctx;this._vao=this._createVertexArrayObject(t),this._vaoCount=r$O(this._vao,"geometry"),t$R(A$e,{signal:this._readyController.signal}).then((r=>{this._texture=new o$G(t,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},r),e.requestRender(),this._readyController=null,this._readyResolver.resolve();})).catch((e=>{d$B(e)||x$k.error("Unable to initialize atmosphere: image request failed",e),this._readyResolver.reject();}));}uninitializeRenderContext(){this.destroy();}render(e){if(e.slot!==this.slot||0!==e.pass)return !1;const t=e.rctx,r=this._atmosphereTechnique.program;return t.useProgram(r),this._atmosphereTechnique.bindPipelineState(t),r.bindTexture(this._texture,"tex"),t$S(r,e.camera.projectionMatrix),v$l(w$h,e.camera.viewMatrix),r.setUniformMatrix4fv("view",w$h),r.setUniform4f("color",1,1,1,1),e.scenelightingData.setLightDirectionUniform(r),t.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(4,0,this._vaoCount),!0}_createVertexArrayObject(e){const t=P$l.createPolySphereGeometry(1,2,!1),r=t.indices.get("position");for(let n=0;n<r.length;n+=3){const e=r[n];r[n]=r[n+2],r[n+2]=e;}const o=t.vertexAttributes.get("position").data,i=C$c.createBuffer(r.length),s=i.position;for(let n=0;n<r.length;++n){const e=3*r[n];s.set(n,0,o[e]),s.set(n,1,o[e+1]),s.set(n,2,o[e+2]);}return new f$w(e,o$F,{geometry:t$T(C$c)},{geometry:h$y.createVertex(e,35044,i.buffer)})}}function v$l(e,t){n$K(e,t),e[12]=0,e[13]=0,e[14]=0,e[15]=1;}const w$h=e$y(),C$c=A$k().vec3f("position");

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function r$t(r){const n=new n$N;return n.attributes.add("position","vec2"),n.attributes.add("uv0","vec2"),n.varyings.add("worldRay","vec3"),n.varyings.add("vtc","vec2"),r.haze&&n.varyings.add("eyeDir","vec3"),n.vertex.uniforms.add("projectionInverse","mat4"),n.vertex.uniforms.add("viewInverse","mat4"),n.vertex.code.add(t$J`
    void main(void) {
      vec3 posViewNear = (projectionInverse * vec4(position, -1, 1)).xyz;

      worldRay = (viewInverse * vec4(posViewNear, 0)).xyz;
      vtc = uv0;

      ${r.haze?t$J`eyeDir = posViewNear;`:""}

      gl_Position = vec4(position, 1, 1);
    }
  `),n.fragment.uniforms.add("lightingMainDirection","vec3").add("radii","vec2").add("atmosphereParameters1","vec4").add("atmosphereParameters2","vec4").add("cameraPosition","vec3").add("nearFar","vec2").add("heightParameters","vec4"),r.haze?n.fragment.uniforms.add("depthTex","sampler2D"):n.fragment.uniforms.add("atmosphereParameters3","vec3").add("innerFadeDistance","float").add("altitudeFade","float"),n.fragment.include(e$F),n.fragment.code.add(t$J`
  const vec3 invWavelength = vec3(${t$J.float(r.invWavelength[0])}, ${t$J.float(r.invWavelength[1])}, ${t$J.float(r.invWavelength[2])});

  const vec3 invWavelengthScaled = vec3(${t$J.float(r.invWavelengthScaled[0])}, ${t$J.float(r.invWavelengthScaled[1])}, ${t$J.float(r.invWavelengthScaled[2])});

  // Atmosphere
  const float krESun = 0.075;        // Kr * ESun = 0.005 * 15.0
  const float kmESun = 0.015;        // Km * ESun = 0.005 * 15

  // The inner (planetary) radius
  #define innerRadius radii[0]
  // The outer (atmosphere) radius
  #define outerRadius radii[1]

  // Atmosphere parameters:

  // shellScale:               1.0 / (outerRadius - innerRadius)
  #define shellScale atmosphereParameters1.x

  // shellDepth:               The scale depth (i.e. the altitude at which the atmosphere's average density is found)
  // scaleDepthBlue:           The scale depth (i.e. the altitude at which the atmosphere's average density is found)
  #define shellDepth vec2(atmosphereParameters1.y, atmosphereParameters2.y)

  // scaleOverScaleDepth:      scale / shellDepth
  // scaleOverScaleDepthBlue:  scale / scaleDepthBlue
  #define scaleOverScaleDepth vec2(atmosphereParameters1.z, atmosphereParameters2.z)

  // oneOverScaleDepth:        1.0 / shellDepth
  // oneOverScaleDepthBlue;    1.0 / scaleDepthBlue
  #define oneOverScaleDepth vec2(atmosphereParameters1.w, atmosphereParameters2.w)
  `),r.haze||n.fragment.code.add(t$J`#define g atmosphereParameters2.x
#define gSq atmosphereParameters3.x
#define miePhaseCoefficients atmosphereParameters3.y
#define lowerAlphaBlendBound atmosphereParameters3.z`),n.fragment.code.add(t$J`
  // The camera's current height
  #define cameraHeight heightParameters[0]
  // cameraHeight^2
  #define cameraHeightSq heightParameters[1]
  // cameraHeightSq - outerRadiusSq; // C = ||o-c||^2 - r^2
  #define C heightParameters[2]
  // cameraHeightSq - (innerRadiusSq - 63756370000.0); // C = ||o-c||^2 - r^2
  #define CSur heightParameters[3]

  ${r.haze?"// Camera HDR\n        const float exposure = 1.5;\n        const vec3 oneOverGamma = vec3(1.0); //Gamma = 1.0":"const float exposure = 2.0;\n        const vec3 oneOverGamma = vec3(0.454545); // Gamma = 2.2\n        vec3 reinhardTM(vec3 inputColor, float _exposure) {\n          vec3 intermediate = inputColor * _exposure;\n          intermediate /= ( 1.0 + intermediate );\n          return pow(intermediate, oneOverGamma);\n        }\n        "}
    // Loop constants for integral approximation
    const float samples = 5.0;
    const int maxSamples = 5;

    // ToneMapping operators
    vec3 expTM(vec3 inputColor,float _exposure) {
        return pow(1.0 - exp(inputColor * -_exposure), oneOverGamma);
    }

    // Approximation for inner integral based on a radii ratio of 10.25:10
    float scale(float _cos) {
      float x = 1.0 - _cos;
      return exp( -0.00287 + x * ( 0.459 + x * ( 3.83 + x * (-6.80 + x * 5.25 ))));
    }

    void main() {
      // Obtain ray from Camera
      vec3 worldSpaceRay = normalize(worldRay);

      // Compute Atmosphere intersection; i.e. ray/sphere intersection
      float B = 2.0 * dot(cameraPosition, worldSpaceRay); // B = 2(l * (o-c))
      float det = B * B - 4.0 * C; // det = B^2 - 4.0* C

      // idealized sphere intersection to discard early some pixels
      float detSur = B * B - 4.0 * CSur; // det = B^2 - 4.0* C

      // the minimal sample start position:
      // at the camera by default, on the earth radius surface if the camera is underground.
      float minRayStart = 0.0;
  `),r.haze||n.fragment.code.add(t$J`float surfaceBlend = 0.0;
vec4 surfaceColor = vec4(0.0);
if (detSur >= 0.0) {
float nearSurface = max(0.0, 0.5 *(-B - sqrt(detSur)));
float farSurface = max(0.0, 0.5 *(-B + sqrt(detSur)));
if (nearSurface == 0.0) {
minRayStart = farSurface;
}
vec3 vPos = cameraPosition + worldSpaceRay * nearSurface;
float lightAngle = dot(lightingMainDirection, normalize(vPos));
float brightness = max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)));
surfaceColor = vec4(brightness, brightness, brightness, 1.0 - altitudeFade);
float relDist = (farSurface - nearSurface) / innerFadeDistance;
if (relDist > 1.0) {
gl_FragColor = surfaceColor;
return;
}
surfaceBlend = smoothstep(0.0, 1.0, relDist * relDist);
}`),n.fragment.code.add(t$J`
    if (det >= 0.0) {
    ${r.haze?"\n          float depthSample = texture2D(depthTex, vtc).r;\n\n          float zNear = nearFar[0];\n          float zFar = nearFar[1];\n\n          // http://web.archive.org/web/20130416194336/http://olivers.posterous.com/linear-depth-in-glsl-for-real\n          float zNorm = 2.0 * depthSample - 1.0;\n          float linDepth = 2.0 * zNear * zFar /\n            (zFar + zNear - zNorm * (zFar - zNear));\n\n          float rayEnd;\n          float altitudeAlpha = 1.0;\n\n          // find intersections with ground, but only between the near and far\n          // clipping planes.\n          if (depthSample < 1.0 && depthSample > 0.0) {\n            vec3 cameraSpaceRay = normalize(eyeDir);\n            cameraSpaceRay /= cameraSpaceRay.z;\n            cameraSpaceRay *= linDepth;\n\n            float cameraSpaceRayLength = length(cameraSpaceRay);\n\n            vec3 world = cameraPosition + worldSpaceRay * cameraSpaceRayLength;\n            float worldRadiusSq = dot(world, world);\n\n            // Handle tall structures:\n            // https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/5450\n            float transitionStart = innerRadius + 20000.0;\n            float transitionHeight = 25000.0;\n            float transitionEnd = transitionStart + transitionHeight;\n\n            float edge0 = transitionStart * transitionStart;\n            float edge1 = transitionEnd * transitionEnd;\n\n            altitudeAlpha = 1.0 - clamp((worldRadiusSq - edge0) / (edge1 - edge0), 0.0, 1.0);\n            rayEnd = cameraSpaceRayLength;\n\n            if (altitudeAlpha > 0.0 && detSur > 0.0) {\n              float nearSurface = 0.5 * ( -B - sqrt(detSur) );\n              float interp = clamp(((cameraHeight - innerRadius) - 2000000.0) / 6000000.0, 0.0, 1.0);\n              rayEnd = mix(cameraSpaceRayLength, nearSurface, interp);\n            }\n          }":""}
    float rayStart = 0.5 *(-B - sqrt(det)); //near intersection with atmosphere
    ${r.haze?"float near = abs(rayStart);\n        float far = abs(rayEnd);":"float rayEnd = 0.5 *(-B + sqrt(det)); //far intersection with atmosphere"}

    float scatterDistance; // calculate its scattering offset
    // Calculate the ray's starting position
    if (rayStart < minRayStart)
    { // ray starts from camera or inner radius sphere to far
      rayStart = minRayStart;
      ${r.haze?"":"// clamp to value at inner radius altitude\n          scatterDistance = shellScale * min(0.0, innerRadius - cameraHeight);"}
    }
    ${r.haze?"":"else { // outside atmosphere\n          scatterDistance = -1.0;\n        }"}
    // Initialize the scattering loop variables
    vec3 start = cameraPosition + worldSpaceRay * rayStart;
  `),r.haze&&n.fragment.code.add(t$J`vec3 end = cameraPosition + worldSpaceRay * rayEnd;
float endLength = length(end);
vec2 altitudeInterval = vec2(length(start) - innerRadius, endLength - innerRadius);
if (altitudeInterval.x < 0.0) {
altitudeInterval = -altitudeInterval;
}
float lightAngle = dot(lightingMainDirection, end) / endLength;
if (near > far)
{
if (altitudeInterval.x < altitudeInterval.y)
{
end = cameraPosition + worldSpaceRay * rayStart;
start = cameraPosition + worldSpaceRay * rayEnd;
worldSpaceRay *= -1.0;
float tmp = altitudeInterval.x;
altitudeInterval.x = altitudeInterval.y;
altitudeInterval.y = tmp;
}
else if (altitudeInterval.x == altitudeInterval.y)
{
altitudeInterval.x += 1.0;
}
}
if (altitudeInterval.x > outerRadius - innerRadius)
{
scatterDistance = innerRadius - outerRadius;
} else
{
scatterDistance = altitudeInterval.y - altitudeInterval.x;
}`),n.fragment.code.add(t$J`vec2 opticalStartDepth = exp(scatterDistance * oneOverScaleDepth);
float rayLength = rayEnd - rayStart;
float sampleLength = rayLength / samples;
float scaledLength = sampleLength * shellScale;
vec3 sampleRay = worldSpaceRay * sampleLength;
vec3 samplePoint = start + sampleRay * 0.5;`),r.haze?n.fragment.code.add(t$J`float cameraAngle = dot(-worldSpaceRay, end) / length(end);
float scaleCameraAngle = scale(cameraAngle);
vec2 cameraOffset = scaleCameraAngle * opticalStartDepth;
float scaledValues = scale(lightAngle) + scaleCameraAngle;
vec2 scaledValuesDepth = scaledValues * shellDepth;`):n.fragment.code.add(t$J`float cameraAngle = dot(worldSpaceRay, start / length(start));
float angleMultiplier = cameraAngle > 0.0 ? cameraAngle : 0.0;
float scaleCameraAngle = scale(cameraAngle);
vec2 cameraOffset = scaleCameraAngle * opticalStartDepth * shellDepth;`),n.fragment.code.add(t$J`vec3 frontColor = vec3(0.0);
vec3 frontColorBlue = vec3(0.0);
vec3 attenuate = vec3(0.0);
vec3 attenuateBlue = vec3(0.0);
for(int i=0; i<maxSamples; i++) {
float height = length(samplePoint);
float altitude = abs(height - innerRadius);
vec2 depth = exp(-altitude * scaleOverScaleDepth);`),r.haze?n.fragment.code.add(t$J`vec2 scatter = depth * scaledValuesDepth - cameraOffset;`):n.fragment.code.add(t$J`float lightAngle = dot(lightingMainDirection, samplePoint) / height;
float cameraAngle = dot(worldSpaceRay, samplePoint) / height;
float tmpScaledValues = scale(lightAngle) - scale(cameraAngle);
vec2 scatter = cameraOffset + tmpScaledValues * depth * shellDepth;`),n.fragment.code.add(t$J`attenuate = exp(-scatter.x * invWavelengthScaled);
attenuateBlue = exp(-scatter.y * invWavelengthScaled);
frontColor += attenuate * depth.x;
frontColorBlue += attenuateBlue * depth.y;
samplePoint += sampleRay;
}
float LdotR = clamp(dot(lightingMainDirection, -worldSpaceRay ),-0.9999999,1.0);
float LdotRSq = LdotR * LdotR + 1.0;`),r.haze?n.fragment.code.add(t$J`vec3 colorCoefficients = (scaledLength * 0.75 * LdotRSq) * (krESun * invWavelength + kmESun );
vec3 color = colorCoefficients * frontColor;
vec3 colorBlue = colorCoefficients * frontColorBlue;`):n.fragment.code.add(t$J`vec3 rayleighCoefficients = (scaledLength * 0.75 * LdotRSq * krESun) * invWavelength;
float mieCoefficients = scaledLength * kmESun * miePhaseCoefficients * LdotRSq / pow(1.0 + gSq - 2.0 * g * LdotR, 1.5);
vec3 color = rayleighCoefficients * frontColor + mieCoefficients * frontColor;
vec3 colorBlue = rayleighCoefficients * frontColorBlue + mieCoefficients * frontColorBlue;`),n.fragment.code.add(t$J`vec3 ldrBlue = expTM(colorBlue, 2.0 * exposure);
vec3 ldrRed = expTM(color, exposure);
vec3 LDR = mix(ldrBlue, ldrRed, 0.2);`),r.haze?n.fragment.code.add(t$J`LDR *= (1.0 - cameraAngle);
vec3 hsv = rgb2hsv(LDR);
hsv.y = clamp(hsv.y * 1.5, 0.0, 1.0);
LDR = hsv2rgb(hsv);
vec3 finalColor = LDR;`):n.fragment.code.add(t$J`vec3 ldrReinhard = reinhardTM(color, exposure);
LDR += angleMultiplier * ldrReinhard;
float side = (rayEnd + rayStart) * 0.5;
float atmoHeight = sqrt(cameraHeightSq - side * side);
float h2 = clamp(1.0 - ( atmoHeight - lowerAlphaBlendBound ) / ( outerRadius - lowerAlphaBlendBound ), 0.0, 1.0);
vec3 finalColor = LDR * h2;
vec3 hsv = rgb2hsv(finalColor);
hsv.y = clamp(hsv.y * 1.5, 0.0, 1.0);
finalColor = hsv2rgb(hsv);`),n.fragment.code.add(t$J`
    ${r.haze?"gl_FragColor = vec4(finalColor, 1.0) * altitudeAlpha;":"float atmosStrength = clamp((length(ldrRed) - 0.05) * 1.05, 0.0, 1.0);\n          gl_FragColor = vec4(finalColor, atmosStrength * clamp(1.0 - ( atmoHeight - innerRadius ) / (outerRadius - innerRadius), 0.0, 1.0));\n          if (surfaceBlend > 0.0) {\n            gl_FragColor = mix(gl_FragColor, surfaceColor, surfaceBlend);\n          }"}
      } else { // Outside Atmosphere
        gl_FragColor = vec4(0.0);
      }
    }
  `),n}const n$t=Object.freeze({__proto__:null,build:r$t});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class p$r extends t$L{initializeProgram(e){const s=.001,n=4*.005*Math.PI,a=4*s*Math.PI,h=r$D(1/.65**4,1/.57**4,1/.475**4),l=t$G(h);d$z(l,l,n),u$A(l,l,r$D(a,a,a));const g=p$r.shader.get(),u=this.configuration,d=g.build({haze:u.haze,invWavelength:h,invWavelengthScaled:l});return new n$O(e.rctx,d,o$F)}initializePipeline(){return this.configuration.haze?g$v({blending:e$E(1,0,769,1),colorWrite:r$J}):g$v({blending:e$E(770,1,771,771),depthTest:{func:515},colorWrite:r$J})}}p$r.shader=new t$M(n$t,(()=>import('./RealisticAtmosphere.glsl-6c06541e.js')));class f$n extends t$K{constructor(){super(...arguments),this.haze=!1;}}e$x([e$D()],f$n.prototype,"haze",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class B$b{constructor(e){this._view=e,this.canRender=!0,this._skyslot=12,this._hazeSlot=13,this._renderData={texDepth:n$Q(),cameraPosition:n$F(),projectionInverse:e$y(),viewInverse:e$y(),heightParameters:n$P(),atmosphereParameters1:n$P(),atmosphereParameters2:n$P(),atmosphereParameters3:n$F(),radii:n$Q(),scale:0,scaleDepth:R$d,lowerAlphaBlendBound:0,scaleOverScaleDepth:0,oneOverScaleDepth:0,scaleDepthBlue:S$h,oneOverScaleDepthBlue:V$b,scaleOverScaleDepthBlue:0,g:E$f,g2:E$f*E$f,miePhaseCoefficients:H$b,nearFar:n$Q(),cameraHeight:0,cameraHeightSq:0,C:0,CSur:0,innerFadeDistance:0,altitudeFade:0},this._lowerElevationBoundRadius=0,this._lowerBoundEarthRadius=s$B.radius,this._updateRadius(s$B.radius);}destroy(){this._handles&&(this._handles.destroy(),this._handles=null),this._vao&&(this._vao.dispose(),this._vao=null);}when(){return Promise.resolve()}initializeRenderContext(r){const a=r.renderContext.rctx;this._handles=new u$D,r$A(this._view.basemapTerrain.rootTiles)&&this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,context:"ground"}),this._handles.add($$9(this._view,"basemapTerrain","elevation-change",(e=>this._updateElevation(e)),(()=>this._updateElevation()))),this._handles.add($$9(this._view,"basemapTerrain","elevation-bounds-change",(()=>this._updateVisibleElevationBounds()),(()=>this._updateVisibleElevationBounds())));const i=new f$n;i.haze=!1,this._atmosphereTechnique=r.shaderTechniqueRep.acquire(p$r,i),i.haze=!0,this._atmosphereHazeTechnique=r.shaderTechniqueRep.acquire(p$r,i),this._vao=this._createVertexArrayObject(a);}uninitializeRenderContext(){this.destroy();}render(e){return (e.slot===this._hazeSlot||e.slot===this._skyslot)&&0===e.pass&&(this._update(e.camera),e.slot===this._skyslot&&this._renderSky(e),e.slot===this._hazeSlot&&this._renderHaze(e),!0)}_renderSky(e){const t=e.rctx,r=this._atmosphereTechnique.program;t.useProgram(r),this._atmosphereTechnique.bindPipelineState(t),r.setUniform3fv("atmosphereParameters3",this._renderData.atmosphereParameters3),this._renderCommon(r,e);}_renderHaze(e){const t=e.rctx,r=e.offscreenRenderingHelper,a=this._atmosphereHazeTechnique.program;t.useProgram(a),this._atmosphereHazeTechnique.bindPipelineState(t),r.renderDepthDetached((()=>{const t=r.depthTexture;a.bindTexture(t,"depthTex"),this._renderCommon(a,e);}));}_renderCommon(e,t){const r=t.rctx;t.scenelightingData.setLightDirectionUniform(e),e.setUniform4fv("heightParameters",this._renderData.heightParameters),e.setUniform3fv("cameraPosition",this._renderData.cameraPosition),e.setUniformMatrix4fv("projectionInverse",this._renderData.projectionInverse),e.setUniformMatrix4fv("viewInverse",this._renderData.viewInverse),e.setUniform2fv("nearFar",this._renderData.nearFar),e.setUniform2fv("radii",this._renderData.radii),e.setUniform4fv("atmosphereParameters1",this._renderData.atmosphereParameters1),e.setUniform4fv("atmosphereParameters2",this._renderData.atmosphereParameters2),e.setUniform1f("innerFadeDistance",this._renderData.innerFadeDistance),e.setUniform1f("altitudeFade",this._renderData.altitudeFade),r.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(5,0,4);}_createVertexArrayObject(e){const t=q$b.createBuffer(4);return t.position.setVec(0,[-1,-1]),t.position.setVec(1,[1,-1]),t.position.setVec(2,[-1,1]),t.position.setVec(3,[1,1]),t.uv0.setVec(0,[0,0]),t.uv0.setVec(1,[1,0]),t.uv0.setVec(2,[0,1]),t.uv0.setVec(3,[1,1]),new f$w(e,o$F,{geometry:t$T(q$b)},{geometry:h$y.createVertex(e,35044,t.buffer)})}_adjustRadiusForTesselation(e){const t=16,r=4,a=Math.PI/2**r/t;return e*Math.cos(a)}_updateElevation(e){const t=e?e.tile:c$N(this._view.basemapTerrain.rootTiles,[null])[0];if(t$F(t)||0!==t.lij[0])return;const s=this._adjustRadiusForTesselation(s$B.radius+t.elevationBounds[0]);s!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=s,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds());}_updateVisibleElevationBounds(){const e=this._adjustRadiusForTesselation(s$B.radius+this._view.basemapTerrain.elevationBounds.min);(this._lowerBoundEarthRadius<0||e<this._lowerBoundEarthRadius)&&this._updateRadius(e);}_updateRadius(e){this._lowerBoundEarthRadius=e;const t=e,r=t/10*10.25,a=1/(r-t),s=a/R$d,i=a/S$h,n=.3*(r-t)+t,h=this._renderData;r$P(h.atmosphereParameters1,a,R$d,s,y$n),r$P(h.atmosphereParameters2,E$f,S$h,i,V$b),o$C(h.atmosphereParameters3,E$f*E$f,H$b,n),r$K(h.radii,t,r),h.scale=a,h.lowerAlphaBlendBound=n,h.scaleOverScaleDepth=s,h.scaleOverScaleDepthBlue=i;const m=n$w;h.innerFadeDistance=2*Math.sqrt((2*t-m)*m);}_update(e){e&&(this._renderData.cameraHeight=s$x(e.eye),this._renderData.cameraHeightSq=this._renderData.cameraHeight*this._renderData.cameraHeight,this._renderData.C=this._renderData.cameraHeightSq-this._renderData.radii[1]*this._renderData.radii[1],this._renderData.CSur=this._renderData.cameraHeightSq-this._renderData.radii[0]*this._renderData.radii[0],this._renderData.heightParameters=r$L(this._renderData.cameraHeight,this._renderData.cameraHeightSq,this._renderData.C,this._renderData.CSur),r$B(this._renderData.cameraPosition,e.eye),h$x(this._renderData.projectionInverse,e.projectionMatrix),h$x(this._renderData.viewInverse,e.viewMatrix),r$K(this._renderData.nearFar,e.near,e.far),this._renderData.altitudeFade=t$B(this._renderData.cameraHeight-this._lowerBoundEarthRadius));}static isSupported(e){return e.renderContext.rctx.capabilities.depthTexture}}const R$d=.25,S$h=.05,y$n=1/R$d,V$b=1/S$h,E$f=-.99999,H$b=(1-E$f*E$f)/(2+E$f*E$f)*1.5,q$b=A$k().vec2f("position").vec2f("uv0");

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const A$d="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAAE00TaTAAAACXBIWXMAAA7AAAAOwAFq1okJAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAp1JREFUSMd9lcmSEzEQRCtflnqxYZgIThBDAP//kXDQ0pJtuDhqycxWZ5fKERFCERARIAVEyCjCtSFFEjWVa9q7OdJE0oiidIhKhRBROlhloiGVhaYERQHJWFEwMpYKrjUlibI2cqSJIJEpKNmM2c3GkRTOJDnThTMpnMWu0VFszs3Jfbe5bza3w+a229yOIs6zmP3czfn1K2w/for8+EVU15pNmmyqkeJyclinXNJRu1xrUaJmjmdzJiejVNt7zZVBRAIq1RwrsrrWnez+SR7WmQQP/1itKz2q/pmzuJtYnNy2bth9x9z2NLfDcB7FHOcGx6ebOb9/iPzxG/ztg4iorglFiKjzF9HSNphCoRb1OY3RZQJrYgRdT68bmgXGDdBzrTG8qNS7QP/m19ef7tGlcoH7vESYkK70uoPuOLEetz0IqeGoWQW6MlB/j36EnipYGKPWwDRg/RkNhXCNJIzAhMk6PrDePJNII6JHqM5VWqYApCtNFPe0GFFGtOWopWCrEVBSoiQi06KkRRaD08IlxXa/ifz8Jvz2LvjyLnh7F/r8Rei8a8xfjNkIrpmMOQ1C02COrkTEHxGhh+6DQJfXc/eZprXxcIyVIf1LJVgWvKaHvwI/1aQxtv851SQ/nqGXL6MHFVY3nmhLyqKsWO/+qzWif+yS1TpNKq8NezjGPCV69ciZoQj1PwfN6QRpWyCGVMe1D/AAHt3/gefu1Ign3AVpjOiNXkN90JlpL6TUnzFEUU+Jvks0tkp/dY3Fy1TzI24BWwsYJPyg11Q0FqDwK72xIz2kLojbeuxS1FpgtfNWyMX1gFw0j3W7RNeSHTVEe3VaV7SdCzVywFaEt02w7QH7Eeg4AvZDNdJ+Cu1HENsutO+Byi6ilEBZ9BeCNBJceJIjHgAAAABJRU5ErkJggg==";

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const z$e=s$y.getLogger("esri.views.3d.environment.SimpleAtmosphere"),H$a=128,B$a=-n$w,I$c=0,E$e=50,G$a=()=>1-511/512,J$a=I$i([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);class K$b{constructor(e){this.view=e,this.slot=12,this._renderData={texV:n$Q(),silCircleCenter:n$F(),silCircleV1:n$F(),silCircleV2:n$F(),altitudeFade:0,innerScale:0,undergroundFadeAlpha:0},this._fadeVaoCount=0,this._readyResolver=B$f(),this._readyController=new AbortController,this.texV1=1,this.isOnMars=G$g(e.spatialReference);const t=p$K(e.spatialReference);this.planetRadius=t.radius,this.outerRimWidth=t.outerAtmosphereRimWidth,this.innerRimFactor=(this.planetRadius+B$a)/this.planetRadius,this.middleRimFactor=(this.planetRadius+I$c)/this.planetRadius,this.outerRimFactor=(this.planetRadius+this.outerRimWidth)/this.planetRadius,this.texV0=I$c/this.outerRimWidth,this.texVScale=this.texV1-this.texV0;}get canRender(){return null!=this._texture}destroy(){this._readyResolver.reject(),this._cameraChangeHandle=s$E(this._cameraChangeHandle),this._texture=i$M(this._texture),this._fadeVao=i$M(this._fadeVao),this._vao=i$M(this._vao),this._readyController=a$X(this._readyController);}when(){return this._readyResolver.promise}initializeRenderContext(e){this._shaderTechniqueRepository=e.shaderTechniqueRep;const t=e.renderContext.rctx;this._cameraChangeHandle=i$P(this.view,"state.camera",(()=>e.requestRender()),!0),this._vao=this._createRibbon(t),this._vaoCount=r$O(this._vao,"geometry"),this._fadeVao=i$N(t),this._fadeVaoCount=r$O(this._fadeVao,"geometry"),t$R(this.isOnMars?A$d:A$e,{signal:this._readyController.signal}).then((r=>{this._texture=new o$G(t,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},r),e.requestRender(),this._readyController=null,this._readyResolver.resolve();})).catch((e=>{d$B(e)||z$e.error("Unable to initialize simple atmosphere: image request failed",e),this._readyResolver.reject();}));}uninitializeRenderContext(){this.destroy();}get atmosphereConeTechnique(){if(t$F(this._atmosphereConeTechnique)){const e=new u$t;e.geometry=0,this._atmosphereConeTechnique=this._shaderTechniqueRepository.acquire(h$n,e);}return this._atmosphereConeTechnique}get atmosphereUndergroundTechnique(){if(t$F(this._atmosphereUndergroundTechnique)){const e=new u$t;e.geometry=2,this._atmosphereUndergroundTechnique=this._shaderTechniqueRepository.acquire(h$n,e);}return this._atmosphereUndergroundTechnique}render(e){if(e.slot!==this.slot||0!==e.pass)return !1;this._update(e.camera);const t=e.rctx;if(this.atmosphereConeTechnique.bindPipelineState(t),this._renderData.undergroundFadeAlpha<1){const r=this.atmosphereConeTechnique.program;t.useProgram(r),r.setUniformMatrix4fv("proj",e.camera.projectionMatrix),r.setUniformMatrix4fv("view",e.camera.viewMatrix),r.setUniform3fv("silCircleCenter",this._renderData.silCircleCenter),r.setUniform3fv("silCircleV1",this._renderData.silCircleV1),r.setUniform3fv("silCircleV2",this._renderData.silCircleV2),r.setUniform2fv("texV",this._renderData.texV),r.bindTexture(this._texture,"tex"),e.scenelightingData.setLightDirectionUniform(r),r.setUniform1f("altitudeFade",this._renderData.altitudeFade),r.setUniform1f("innerScale",this._renderData.innerScale),t.bindVAO(this._vao),t.drawArrays(4,0,this._vaoCount);}if(this._renderData.undergroundFadeAlpha>0){const r=this.atmosphereUndergroundTechnique.program;t.useProgram(r),r.setUniform1f("undergroundFadeAlpha",this._renderData.undergroundFadeAlpha),e.scenelightingData.setLightDirectionUniform(r),r.setUniform3fv("cameraPosition",e.camera.eye),t.bindVAO(this._fadeVao),t.drawArrays(5,0,this._fadeVaoCount);}return !0}_update(e){const i=n$F(),s=this.planetRadius,o=s$x(e.eye),a=o-s;if(a<0){const e=Math.min(-a/5e3,1);this._renderData.undergroundFadeAlpha=e;}else this._renderData.undergroundFadeAlpha=0;const n=Math.max(E$e,a),h=s+B$a;this._renderData.innerScale=Z$6(s+n,s,h)-1,this._renderData.altitudeFade=t$B(a),d$z(i,e.eye,(s+E$e)/o),N$g(i,e.center,e.up,s,this._renderData);const l=this._computeScreenRimWidth(e,i,e.up,this._renderData),m=G$a(),c=J$a(a);let u=this.texV0+m*this.texVScale,_=this.texV0+l*c*this.texVScale;if(a>E$e){N$g(e.eye,e.center,e.up,s,this._renderData);const i=this._computeScreenRimWidth(e,e.eye,e.up,this._renderData),o=e$B((i-1.5)/(l-1.5),0,1);u=this.texV0+o*m*this.texVScale,_=this.texV0+s$F(this.texV1,l*c,o)*this.texVScale;}r$K(this._renderData.texV,u,_);}_createRibbon(e){const t=new Float32Array(3+3*H$a*3),r=new Uint32Array(3*H$a*5);t[0]=0,t[1]=0,t[2]=-1;for(let o=0;o<H$a;o++){const e=9*o+3;t[e+0]=o,t[e+1]=this.innerRimFactor,t[e+2]=-1,t[e+3]=o,t[e+4]=this.middleRimFactor,t[e+5]=0,t[e+6]=o,t[e+7]=this.outerRimFactor,t[e+8]=1;const i=3*o+1,s=o===H$a-1?1:i+3,a=15*o;r[a+0]=i,r[a+1]=i+1,r[a+2]=s+1,r[a+3]=s+1,r[a+4]=s,r[a+5]=i,r[a+6]=i+1,r[a+7]=i+2,r[a+8]=s+2,r[a+9]=s+2,r[a+10]=s+1,r[a+11]=i+1,r[a+12]=i,r[a+13]=s,r[a+14]=0;}const i=$$7.createBuffer(r.length),s=i.position;for(let o=0;o<r.length;++o){const e=3*r[o];s.set(o,0,t[e]),s.set(o,1,t[e+1]),s.set(o,2,t[e+2]);}return new f$w(e,o$F,{geometry:t$T($$7)},{geometry:h$y.createVertex(e,35044,i.buffer)})}_computeScreenRimWidth(e,t,r,i){return u$A(X$6,i.silCircleCenter,i.silCircleV2),d$z(Y$8,X$6,this.outerRimFactor),F$d(Q$a,t,X$6,r),d$E(X$6,Q$a,e.projectionMatrix,e.viewport),d$E(Y$8,Q$a,e.projectionMatrix,e.viewport),q$g(X$6,Y$8)/e.height}}function N$g(e,t,r,i,s){const o=s$x(e),a=i*Math.sqrt(o*o-i*i)/o,n=Math.sqrt(i*i-a*a),h=s.silCircleV1,l=s.silCircleV2;return d$z(s.silCircleCenter,e,n/o),_$f(h,e,t),p$Q(h)<1&&_$f(h,e,r),d$z(h,h,a/s$x(h)),_$f(l,h,e),d$z(l,l,a/s$x(l)),a}const Q$a=e$y(),X$6=n$F(),Y$8=n$F();function Z$6(e,t,r){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-r*r)+t*r)}const $$7=A$k().vec3f("position");

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function i$s(){const i=new n$N;return i.attributes.add("position","vec3"),i.attributes.add("color","vec4"),i.attributes.add("size","float"),i.varyings.add("vcolor","vec4"),i.varyings.add("vsize","float"),i.vertex.uniforms.add("transform","mat4").add("viewport","vec4").add("pixelRatio","float"),i.include(c$R),i.vertex.code.add(t$J`void main(void) {
vec4 posProj = transform * vec4(position, 0);
gl_Position = alignToPixelCenter(posProj, viewport.zw);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;
}`),i.fragment.code.add(t$J`void main() {
float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
gl_FragColor = vec4(vcolor.xyz, intensity);
}`),i}const t$y=Object.freeze({__proto__:null,build:i$s});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class f$m extends t$L{initializeProgram(e){const r=f$m.shader.get().build();return new n$O(e.rctx,r,o$F)}initializePipeline(){return g$v({blending:e$E(770,1,771,771),depthTest:{func:515},colorWrite:r$J})}bindPass(r){const i=this.makeInfiniteProjectionMatrix(r.camera.projectionMatrix,r.camera.near,p$q);e$G(i,i,r.camera.viewMatrix),e$G(i,i,r.modelMatrix),this.program.setUniformMatrix4fv("transform",i),this.program.setUniform4fv("viewport",r.camera.fullViewport),this.program.setUniform1f("pixelRatio",r.camera.pixelRatio);}makeInfiniteProjectionMatrix(e,i,t){const a=24e-8;return n$K(t,e),t[10]=a-1,t[11]=-1,t[14]=(a-2)*i,t}}f$m.shader=new t$M(t$y,(()=>import('./Stars.glsl-4394d1b1.js')));const p$q=e$y();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const D$b=s$y.getLogger("esri.views.3d.environment.Stars");let P$h=class extends p$N{constructor(t){super(t),this._loadDataTask=null,this._numPoints=0,this._renderParameter={camera:null,modelMatrix:e$y()},this._updatingTracking=new l$G;}get updating(){return this._updatingTracking.updating||this.loading}get loading(){return r$A(this._loadDataTask)&&!this._loadDataTask.finished}get canRender(){return !this.loading}initialize(){this._loadDataTask=this._createLoadDataTask();}destroy(){this._loadDataTask=a$X(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=i$M(this._technique),this._vao=i$M(this._vao);}render(t,e){if(this._ensureResources(t),t$F(this._technique)||t$F(this._vao))return !1;const r=this._technique.program;return t.useProgram(r),this._renderParameter.camera=e,this._technique.bindPass(this._renderParameter),this._technique.bindPipelineState(t),t.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(0,0,this._numPoints),!0}_ensureResources(t){if(r$A(this._technique)||t$F(L$e))return;this._technique=new f$m({rctx:t,viewingMode:this.view.state.viewingMode},null),this._numPoints=L$e.byteLength/M$c;const e=new Float32Array(L$e,0,2*this._numPoints),r=new Uint8Array(L$e,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(t,e,r,this._numPoints),this._updatingTracking.add(this.view,"environment.lighting.date",(t=>this._update(t)),2);}_computeDayDuration(t){const e=t,r=new Date(t.getFullYear(),0,1,11,58,56);return (+e-+r)/(+new Date(t.getFullYear()+1,0,1,11,58,55)-+r)}_update(t){if(!t)return;const e=(t.getHours()/12+t.getMinutes()/60*(2/24)+t.getSeconds()/60*(2/1440)-.9972222)%2,r=2*this._computeDayDuration(t),s=this._renderParameter.modelMatrix;n$K(s,A$c),m$A(s,s,-r*Math.PI),e$G(s,q$a,s),m$A(s,s,-e*Math.PI),this.requestRender();}_hexToRGB(t){return [parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16),parseInt(t.substring(4,6),16)]}_unpackUint8Attributes(t){return t>=192?[2.9,t-192]:t>=160?[2.5,t-160]:t>=128?[2,t-128]:t>=96?[1.5,t-96]:t>=64?[1,t-64]:t>=32?[.7,t-32]:[.4,t]}_createVertexArrayObject(t,e,r,s){const a=S$g.createBuffer(s),i=a.position,o=a.color,n=a.size;for(let c=0;c<s;c++){const t=e[2*c+0],s=e[2*c+1];i.set(c,0,-Math.cos(t)*Math.sin(s)),i.set(c,1,-Math.sin(t)*Math.sin(s)),i.set(c,2,-Math.cos(s));const a=this._unpackUint8Attributes(r[c]),f=this._hexToRGB(x$j[a[1]]);o.set(c,0,255*f[0]),o.set(c,1,255*f[1]),o.set(c,2,255*f[2]),o.set(c,3,255),n.set(c,a[0]);}return new f$w(t,o$F,{geometry:t$T(S$g)},{geometry:h$y.createVertex(t,35044,a.buffer)})}_createLoadDataTask(){if(r$A(L$e))return null;const t=F$e((async t=>{const{data:r}=await n$T("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:t});this._verifyStarData(r),L$e=r;}));return t.promise.catch((t=>{d$B(t)||D$b.error(t);})).then((()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"));})),t}_verifyStarData(t){if(!t)throw new s$w("stars:no-data-received","Failed to create stars because star catalogue is missing");const e=t.byteLength/M$c;if(e%1!=0||e>5e4||e<5e3)throw new s$w("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};e$x([d$y({constructOnly:!0})],P$h.prototype,"view",void 0),e$x([d$y({constructOnly:!0})],P$h.prototype,"requestRender",void 0),e$x([d$y({readOnly:!0})],P$h.prototype,"updating",null),e$x([d$y()],P$h.prototype,"_loadDataTask",void 0),e$x([d$y()],P$h.prototype,"_updatingTracking",void 0),P$h=e$x([i$H("esri.views.3d.environment.Stars")],P$h);const x$j=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],q$a=r$Q(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),A$c=r$Q(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),M$c=9,S$g=A$k().vec3f("position").vec4u8("color").f32("size");let L$e=null;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const k$f=[12,13];let S$f=class extends p$N{constructor(){super(...arguments),this._cloudsGeneratorTask=null,this._handles=new u$D,this._context=null,this._enableNewAtmosphere=o$H(),this._pendingAtmosphere=null,this._atmosphere=null,this._stars=null,this._clouds=null,this._cloudComposition=null,this._fog=null,this._fogEnabled=!1;}get needsLinearDepth(){return this._fogEnabled}get canRender(){return !(!this.view.basemapTerrain||!this.view.basemapTerrain.renderer.canRender)||"global"!==this.view.viewingMode}get updating(){return r$A(this._pendingAtmosphere)||r$A(this._stars)&&this._stars.updating||r$A(this._cloudsGeneratorTask)&&this._cloudsGeneratorTask.updating}get weatherEnabled(){var e,t,s;const r=null!==(null==(e=this.view)||null==(t=e.environment)?void 0:t.weather),i=n$U();return (r||i)&&o$E(null==(s=this.view)?void 0:s.spatialReference)}renderCubeMap(){r$A(this._clouds)&&r$A(this._context)&&(this._clouds.resetRenderFlags(),this._context.requestRender());}initialize(){this.view._stage.addRenderPlugin(k$f,this);}destroy(){this._pendingAtmosphere=l$E(this._pendingAtmosphere),this._atmosphere=l$E(this._atmosphere),this._stars=l$E(this._stars),this._handles=l$E(this._handles),this._clouds=l$E(this._clouds),this._cloudComposition=l$E(this._cloudComposition),this._cloudsGeneratorTask=s$E(this._cloudsGeneratorTask),this._fog=l$E(this._fog),this.view&&null!=this.view._stage&&(this.view._stage.removeRenderPlugin(this),this._set("view",null));}initializeRenderContext(e=null){this._context=e,this._handles.add([s$A(this.view,"basemapTerrain",(()=>this._updateBasemapTerrain()),!0),i$Q((()=>({viewingMode:this.view.viewingMode,atmosphereEnabled:this.view.environment.atmosphereEnabled,atmosphereQuality:this.view.environment.atmosphere.quality})),(()=>this._updateAtmosphere()),p$R),i$Q((()=>this._starsUpdateParameters),(e=>this._updateStars(e)),{sync:!0,initial:!0,equals:g$w}),i$Q((()=>this._cloudsCreationParameters),(e=>this._createOrDestroyClouds(e)),{sync:!0,initial:!0,equals:g$w}),i$Q((()=>this._fogCreationParameters),(e=>this._createOrDestroyFog(e)),{sync:!0,initial:!0,equals:g$w}),i$Q((()=>this._weatherUpdateParameters),(e=>{this._updateWeather(e),this._updateFog(e);}),p$R)]);}uninitializeRenderContext(){r$A(this._stars)&&(this._stars.destroy(),this._stars=null),r$A(this._atmosphere)&&(this._atmosphere.uninitializeRenderContext(),this._atmosphere.destroy(),this._atmosphere=null),this._clouds=l$E(this._clouds),this._cloudComposition=l$E(this._cloudComposition),this._fog=l$E(this._fog);}render(e){let t=!1;return r$A(this._stars)&&this._stars.canRender&&12===e.slot&&0===e.pass&&this._stars.render(e.rctx,e.camera)&&(t=!0),r$A(this._atmosphere)&&this._atmosphere.canRender&&this._atmosphere.render(e)&&(t=!0),r$A(this._clouds)&&!this._clouds.running&&r$A(this._cloudComposition)&&12===e.slot&&0===e.pass&&(this._cloudComposition.render(e,this._clouds._frameBufferCube,r$A(this.view.animation),this._clouds.coverage,this._clouds.absorption)&&(t=!0),this._cloudComposition.isFading()&&this._setNeedsRender()),r$A(this._fog)&&this._fog.canRender&&13===e.slot&&0===e.pass&&(t=this._fog.render(e)&&t),t}get _cloudsCreationParameters(){return this.weatherEnabled?{view:this.view,viewingMode:this.view.state.viewingMode,rctx:r$A(this._context)?this._context.renderContext.rctx:null,radius:p$K(this.view.spatialReference).radius}:null}_createOrDestroyClouds(e){this._clouds=l$E(this._clouds),this._cloudsGeneratorTask=s$E(this._cloudsGeneratorTask),this._cloudComposition=l$E(this._cloudComposition),o$I(e,(({view:e,viewingMode:t,rctx:s,radius:r})=>{this._clouds=new f$o(s,e,(()=>this._setNeedsRender()));const i=this.view.resourceController.scheduler;this._cloudsGeneratorTask=i.registerTask(f$u.CLOUDS_GENERATOR,this._clouds),this._cloudComposition=new x$l(s,t,r,s$x(e.state.camera.eye)-r);})),this._setNeedsRender();}get _weatherUpdateParameters(){var e,t;const s=null==(e=this.view)||null==(t=e.environment)?void 0:t.weather;return t$F(s)?null:{type:s.type,presetAdjustment:"foggy"===s.type?s.fogStrength:s.cloudCoverage}}_updateWeather(e){if(t$F(this._clouds)||t$F(e))return;const t=p$s[e.type].median;for(const s in p$s[e.type])if("median"!==s){const r=p$s[e.type][s],o=s$F(r[0],r[1],t);this._clouds[s]=e.presetAdjustment<.5?s$F(r[0],o,2*e.presetAdjustment):s$F(o,r[1],2*(e.presetAdjustment-.5));}}_setNeedsRender(){r$A(this._context)&&this._context.requestRender();}get _starsUpdateParameters(){var e,t,s;return {view:this.view,starsEnabled:null!=(e=null==(t=this.view)||null==(s=t.environment)?void 0:s.starsEnabled)&&e}}_updateStars({view:e,starsEnabled:t}){t&&t$F(this._stars)?(this._stars=new P$h({view:e,requestRender:()=>this._setNeedsRender()}),this._setNeedsRender()):!t&&r$A(this._stars)&&(this._stars.destroy(),this._stars=null,this._setNeedsRender());}_updateFog(e){t$F(this._fog)||t$F(e)||("foggy"===e.type?(this._fog.strength=s$F(1e-5,5e-4,e.presetAdjustment),this._fog.renderSkyFog=!0):(this._fog.strength=1e-5,this._fog.renderSkyFog=!1));}get _fogCreationParameters(){return this.weatherEnabled?{view:this.view,rctx:r$A(this._context)?this._context.renderContext.rctx:null,fogEnabled:this._fogEnabled}:null}_createOrDestroyFog(e){this.weatherEnabled&&this._fogEnabled&&t$F(this._fog)?(o$I(e,(({view:e,rctx:t})=>{this._fog=new d$r(t,e);})),this._updateFog(this._weatherUpdateParameters),this._setNeedsRender()):r$A(this._fog)&&(this._fog.destroy(),this._fog=null,this._setNeedsRender());}_updateAtmosphere(){const e=this._getAtmosphereType();if(this.atmosphereType===e)return;this.atmosphereType=e,r$A(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null);const t=this._getAtmosphereClass();if(!t)return r$A(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),void this._updateBasemapTerrain();const s=new t(this.view);r$A(this._context)&&s.initializeRenderContext(this._context),t$F(this._atmosphere)&&(this._atmosphere=s,this._setNeedsRender()),this._pendingAtmosphere=s,s.when().then((()=>{r$A(this._atmosphere)&&this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere),this._pendingAtmosphere=null,this._setNeedsRender(),this._updateBasemapTerrain();})).catch((()=>{this._pendingAtmosphere===s&&(this._pendingAtmosphere=null);}));}_getAtmosphereClass(){const e=this._getAtmosphereType();if(this.atmosphereClassFromType)return this.atmosphereClassFromType(e);switch(e){case"none":return null;case"chapman":return B$c;case"realistic":return B$b;case"panoramic":return j$l;case"simple":return K$b;default:return}}_getAtmosphereType(){const e=this.view.get("environment.atmosphereEnabled"),t=this.view.get("environment.atmosphere.quality"),s=this.view.viewingMode;return !e||null==t||C$g(this.view.spatialReference)?"none":"local"===s?"panoramic":"high"===t&&this._enableNewAtmosphere&&r$A(this._context)&&B$c.isSupported(this._context)&&!G$g(this.view.spatialReference)?"chapman":"high"===t&&r$A(this._context)&&B$b.isSupported(this._context)&&!G$g(this.view.spatialReference)?"realistic":"simple"}_updateBasemapTerrain(){this.view.basemapTerrain&&(this.view.basemapTerrain.velvetOverground=r$A(this._atmosphere)&&"simple"===this.atmosphereType);}get test(){return {atmosphere:this._atmosphere,clouds:this._clouds,enableNewAtmosphere:e=>{this._enableNewAtmosphere=e;},updateAtmosphere:()=>{this._updateAtmosphere();},enableFog:e=>{this._fogEnabled=e;}}}};e$x([d$y({constructOnly:!0})],S$f.prototype,"view",void 0),e$x([d$y({constructOnly:!0})],S$f.prototype,"atmosphereClassFromType",void 0),e$x([d$y()],S$f.prototype,"_cloudsGeneratorTask",void 0),e$x([d$y({type:Boolean,readOnly:!0})],S$f.prototype,"updating",null),e$x([d$y()],S$f.prototype,"_pendingAtmosphere",void 0),e$x([d$y()],S$f.prototype,"_stars",void 0),e$x([d$y()],S$f.prototype,"_clouds",void 0),e$x([d$y()],S$f.prototype,"_cloudComposition",void 0),e$x([d$y()],S$f.prototype,"_fog",void 0),e$x([d$y()],S$f.prototype,"_fogEnabled",void 0),e$x([d$y()],S$f.prototype,"weatherEnabled",null),e$x([d$y()],S$f.prototype,"_cloudsCreationParameters",null),e$x([d$y()],S$f.prototype,"_weatherUpdateParameters",null),e$x([d$y()],S$f.prototype,"_starsUpdateParameters",null),e$x([d$y()],S$f.prototype,"_fogCreationParameters",null),S$f=e$x([i$H("esri.views.3d.environment.EnvironmentRenderer")],S$f);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var n$s,t$x,r$s,e$u={exports:{}};n$s=e$u,t$x=function(){var n=Math.PI,t=Math.sin,r=Math.cos,e=Math.tan,u=Math.asin,o=Math.atan2,a=Math.acos,i=n/180,c=864e5,f=2440588,d=2451545,s={dec:0,ra:0};function O(n){return n.valueOf()/c-.5+f}function v(n){return new Date((n+.5-f)*c)}function M(n){return O(n)-d}var N=23.4397*i;function P(n,u){return o(t(n)*r(N)-e(u)*t(N),r(n))}function h(n,e){return u(t(e)*r(N)+r(e)*t(N)*t(n))}function E(n,u,a){return o(t(n),r(n)*t(u)-e(a)*r(u))}function I(n,e,o){return u(t(e)*t(o)+r(e)*r(o)*r(n))}function T(n,t){return i*(280.16+360.9856235*n)-t}function A(n){return i*(357.5291+.98560028*n)}function L(n){return i*(1.9148*t(n)+.02*t(2*n)+3e-4*t(3*n))}function R(t,r){return t+r+102.9372*i+n}function p(n,t){var r=A(n),e=R(r,L(r));return t||(t={dec:0,ra:0}),t.dec=h(e,0),t.ra=P(e,0),t}var _={POLAR_EXCEPTION:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(n,t,r,e){var u=i*-r,o=i*t,a=M(n),c=p(a,s),f=T(a,u)-c.ra;return e||(e={azimuth:0,altitude:0}),e.azimuth=E(f,o,c.dec),e.altitude=I(f,o,c.dec),e}},l=[[-.83,"sunrise","sunset"]];_.addTime=function(n,t,r){l.push([n,t,r]);};var x=9e-4;function g(t,r){return Math.round(t-x-r/(2*n))}function m(t,r,e){return x+(t+r)/(2*n)+e}function C(n,r,e){return d+n+.0053*t(r)-.0069*t(2*e)}function X(n,e,u){return a((t(n)-t(e)*t(u))/(r(e)*r(u)))}function G(n){var e=i*(134.963+13.064993*n),u=i*(93.272+13.22935*n),o=i*(218.316+13.176396*n)+6.289*i*t(e),a=5.128*i*t(u),c=385001-20905*r(e);return {ra:P(o,a),dec:h(o,a),dist:c}}return _.getTimes=function(n,e,u){var o=i*-u,a=i*e,c=g(M(n),o),f=m(0,o,c),d=A(f),s=L(d),O=R(d,s),N=h(O,0),P=C(f,d,O);function E(n){return C(m(X(n,a,N),o,c),d,O)}function I(n){var e=(t(n)-t(a)*t(N))/(r(a)*r(N));return e<-1?_.POLAR_EXCEPTION.MIDNIGHT_SUN:e>1?_.POLAR_EXCEPTION.POLAR_NIGHT:_.POLAR_EXCEPTION.NORMAL}var T,p,x,G,H,z={solarNoon:v(P),nadir:v(P-.5),polarException:_.POLAR_EXCEPTION.NORMAL};for(T=0,p=l.length;T<p;T+=1)H=P-((G=E((x=l[T])[0]*i))-P),z[x[1]]=v(H),z[x[2]]=v(G);return z.polarException=I(l[0][0]*i),z},_.getMoonPosition=function(n,t,r){var u=i*-r,o=i*t,a=M(n),c=G(a),f=T(a,u)-c.ra,d=I(f,o,c.dec);return d+=.017*i/e(d+10.26*i/(d+5.1*i)),{azimuth:E(f,o,c.dec),altitude:d,distance:c.dist}},_.getMoonFraction=function(n){var e=M(n),u=p(e),i=G(e),c=149598e3,f=a(t(u.dec)*t(i.dec)+r(u.dec)*r(i.dec)*r(u.ra-i.ra)),d=o(c*t(f),i.dist-c*r(f));return (1+r(d))/2},_},void 0!==(r$s=t$x())&&(n$s.exports=r$s);const u$s=e$u.exports;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const h$m={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,diffuseAtNoon:.65,diffuseAtTwilight:.7},global:{altitude:8e5,ambient:.015,diffuse:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};function g$o(e,n,o,a){const s=n[2];o$C(a.ambient.color,1,1,1),a.ambient.intensity=h$m.global.ambient,o$C(a.diffuse.color,1,1,1),a.diffuse.intensity=h$m.global.diffuse;const r=e$B((Math.abs(s)-h$m.local.altitude)/(h$m.global.altitude-h$m.local.altitude),0,1);a.globalFactor=r;const c=u$s.getTimes(e,n[1],n[0]);if(r<1){const i=E$d(e,c);y$v(a.ambient.color,i.ambient.color,a.ambient.color,r),a.ambient.intensity=s$F(i.ambient.intensity,a.ambient.intensity,r),y$v(a.diffuse.color,i.diffuse.color,a.diffuse.color,r),a.diffuse.intensity=s$F(i.diffuse.intensity,a.diffuse.intensity,r);}a.noonFactor=P$g(e,c),b$g(e,n,o,a.diffuse.directionToLightSource);}function b$g(t,s,u,c){const f=y$m,m=r$C(O$f);if(1===u)u$s.getPosition(t,0,0,f),o$C(c,0,0,-1),b$k(m,m,-f.azimuth),l$H(m,m,-f.altitude),I$g(c,c,m);else {const e=h$m.planarDirection,o=e.globalAngles,u=s[2];let g=(Math.abs(u)-e.localAltitude)/(e.globalAltitude-e.localAltitude);g=e$B(g,0,1),g<1?(u$s.getPosition(t,s[1],s[0],f),f.azimuth=(1-g)*f.azimuth+g*o.azimuth,f.altitude=(1-g)*f.altitude+g*o.altitude):(f.azimuth=o.azimuth,f.altitude=o.altitude),o$C(c,0,-1,0),m$A(m,m,-f.azimuth),b$k(m,m,-f.altitude),I$g(c,c,m);}}function A$b(t,i){if(1===i)return !0;const e=h$m.planarDirection;return Math.abs(t)<e.localAltitude}const N$f=r$D(.5773502691896258,-.5773502691896258,.5773502691896258);class T$d{constructor(){this.ambient={color:r$D(1,1,1),intensity:.55},this.diffuse={color:r$D(1,1,1),intensity:.55,directionToLightSource:t$G(N$f)},this.noonFactor=.5,this.globalFactor=0;}}const O$f=e$y(),y$m={azimuth:0,altitude:0};function P$g(t,e){const n=t.valueOf();let o,a;e.polarException===u$s.POLAR_EXCEPTION.MIDNIGHT_SUN?(o=n-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,a=o+432e6):e.polarException===u$s.POLAR_EXCEPTION.POLAR_NIGHT?(o=n-2,a=n-1):(o=e.sunrise.valueOf(),a=e.sunset.valueOf());const s=o+(a-o)/2;return 1-e$B(Math.abs(n-s)/432e5,0,1)}function E$d(t,i){const e=t.valueOf();let n,o;i.polarException===u$s.POLAR_EXCEPTION.MIDNIGHT_SUN?(n=e-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,o=n+432e6):i.polarException===u$s.POLAR_EXCEPTION.POLAR_NIGHT?(n=e-2,o=e-1):(n=i.sunrise.valueOf(),o=i.sunset.valueOf());const a=o-n,s=n+a/2,l=a/4,u=s-l,r=s+l,f=.06*a,m=n-f/2,g=n+f/2,b=o-f/2,A=o+f/2,p=h$m.local,N=[.01,p.ambientAtNight],T=[.8,.8,1],O=[.01,.01,.01],y=[p.diffuseAtTwilight,p.ambientAtTwilight],P=[1,.75,.75],E=[.8,.8,1],M=[.9*p.diffuseAtNoon,p.ambientAtNoon],z=[1,.98,.98],v=[.98,.98,1],L=[p.diffuseAtNoon,p.ambientAtNoon],_=[1,1,1],j=[1,1,1],D=M,w=z,H=v,R=y,S=P,k=E;let x,C,F=[0,0],G=[0,0,0],X=[0,0,0];return e<m||e>A?(F=N,G=O,X=T,C="night"):e<g?(x=g-m,F=I$b(e-m,x,N,y),G=I$b(e-m,x,O,P),X=I$b(e-m,x,T,E),C="sun rising"):e<u?(x=u-g,F=I$b(e-g,x,y,M),G=I$b(e-g,x,P,z),X=I$b(e-g,x,E,v),C="early morning"):e<s?(x=s-u,F=I$b(e-u,x,M,L),G=I$b(e-u,x,z,_),X=I$b(e-u,x,v,j),C="late morning"):e<r?(x=r-s,F=I$b(e-s,x,L,D),G=I$b(e-s,x,_,w),X=I$b(e-s,x,j,H),C="early afternoon"):e<b?(x=b-r,F=I$b(e-r,x,D,R),G=I$b(e-r,x,w,S),X=I$b(e-r,x,H,k),C="late afternoon"):e<A&&(x=A-b,F=I$b(e-b,x,R,N),G=I$b(e-b,x,S,O),X=I$b(e-b,x,k,T),C="sun setting"),{diffuse:{intensity:F[0],color:r$D(G[0],G[1],G[2])},ambient:{intensity:F[1],color:r$D(X[0],X[1],X[2])},timeOfDay:C}}function I$b(t,i,e,n){const o=[];for(let a=0;a<e.length;a++)o[a]=(n[a]-e[a])*t/i+e[a];return o}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let j$k=class extends n$L.EventedAccessor{constructor(){super(),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandles=new u$D,this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this._referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new o$J,this._ambientLight=new i$R,this._moonLight=new c$S,this._renderer=null,this._referencePosWGS84Comparable=null,this._resetReferencePosition();}destroy(){this.disconnectView(),this._viewHandles.destroy();}get _view(){var e;return null==(e=this._renderer)?void 0:e.view}get updating(){return !!(!this.disableQueries&&(this._referencePosUpdateQuery||this._referencePosMapCoordsRequested)||this._renderer&&this._renderer.updating)}get referencePositionWGS84Comparable(){return this._referencePosWGS84Comparable}connectView(e){this._renderer||(this._renderer=new S$f({view:e}),this._viewHandles.add([e.watch("environment.lighting.date",(e=>this._lightingDateHandler(e)),!0),e.watch("stationary",(()=>this._interactingStationaryHandler())),e.watch(["environment.lighting.directShadowsEnabled","environment.lighting.ambientOcclusionEnabled","environment.lighting.waterReflectionEnabled","environment.background.color"],(()=>this._updateRenderParamsHandler()),!0),e.watch("spatialReference",(()=>this._resetReferencePosition(!0)),!0),i$P(e,"viewingMode",(()=>this._resetReferencePosition(!0)),!0),i$P(e,"environment.lighting.cameraTrackingEnabled",(e=>this._updateCameraTracking(e)),!0),i$P(e,"state.camera",(()=>this._cameraHandler()),!0),this.watch("disableQueries",(()=>this._cameraHandler()))]),this._updateRenderParamsHandler(),this._updateLightParams(),this._cameraHandler(),this.notifyChange("updating"));}disconnectView(){this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer=l$E(this._renderer);}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else {const e=this._view.environment.lighting;e&&(e.positionTimezoneInfo.autoUpdated=!1);}}_lightingDateHandler(e){if(!e)return;const t=this._view.environment.lighting;if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const r=this._view.spatialReference;if(!$n(r)){const e=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(e))return void this._requestReferencePositionUpdate(e)}if(this._preupdateTracking(e),r$A(this._referencePosWGS84Comparable)){const e=m$w(this._referencePosWGS84Comparable,D$a);r$A(e)&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0));}}this._updateLightParams(e);}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e);}_cameraHandler(e=null){const t=this._view;if(!t.ready)return;const r=t.stateManager.camera;r&&(this._cameraHandlerClientSide(r,e)||this._cameraHandlerServerSide(r));}_cameraHandlerClientSide(e,t){const r=o$E(this._view.spatialReference);if(r&&!$n(this._view.spatialReference))return !1;const s=e.position;return t$F(this._referencePosWGS84Comparable)&&(this._referencePosWGS84Comparable=n$F()),r?En(s,this._referencePosWGS84Comparable):o$C(this._referencePosWGS84Comparable,s.longitude,s.latitude,s.z),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLightParams(t),!0}_cameraHandlerServerSide(e){const t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=t.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged());}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate();}_updateLightParams(e){const t=this._view,r=t.environment.lighting,s=e||r.date,i=t._stage,o=this._referencePosWGS84Comparable,a=r$A(o)?k$e:E$c;r$A(o)&&g$o(s,o,t.state.viewingMode,k$e);const c=this._mainLight,h=a.diffuse;d$z(c.intensity,h.color,h.intensity*Math.PI),r$B(c.direction,h.directionToLightSource);const d=this._ambientLight;d$z(d.intensity,a.ambient.color,a.ambient.intensity);const l=this._moonLight;y$v(l.intensity,q$9,L$d,a.globalFactor);const p=(1-.5*a.globalFactor)*(1-.4*a.noonFactor*(1-a.globalFactor));d$z(l.intensity,l.intensity,p),r$B(l.direction,h.directionToLightSource),i.renderView.updateLightSources([c,d,l],1-a.noonFactor,a.globalFactor),this._updateRenderParamsHandler();}_autoUpdateTimezone(e,t=null){if(!this._view.environment.lighting.cameraTrackingEnabled||t$F(e))return !1;const r=Q$9;r.setTime((t||this._view.environment.lighting.date).getTime());const s=m$w(e,D$a);if(t$F(s))return !1;let i=this._view.environment.lighting.positionTimezoneInfo;if(i.autoUpdated){if(i.hours===s.hours&&i.minutes===s.minutes&&i.seconds===s.seconds)return !1}else i=s;const n=r.getUTCHours()-(s.hours-i.hours),a=r.getUTCMinutes()-(s.minutes-i.minutes),c=r.getUTCSeconds()-(s.seconds-i.seconds);return r.setUTCHours(n),r.setUTCMinutes(a),r.setUTCSeconds(c),!t&&this._view.environment.lighting.autoUpdate(r,s)}_updateRenderParamsHandler(){const e=this._view._stage;if(!e)return;const r=A$l(this._referencePosWGS84Comparable,!0,(e=>A$b(e[2],this._view.state.viewingMode))),s=this._view.environment.background,i=s instanceof n$D?{type:"color",color:e$H(h$s.toUnitRGBA(s.color))}:{type:"color",color:r$L(0,0,0,1)};e.renderView.setRenderParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&r,ssao:this._view.environment.lighting.ambientOcclusionEnabled,waterReflectionEnabled:this._view.environment.lighting.waterReflectionEnabled,background:i});}_resetReferencePosition(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler();}_requestReferencePositionUpdate(e,t=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){const e=this._referencePosUpdateQuery=L$h(this._referencePointUpdateDelay).then((()=>{if(this._referencePosUpdateQuery===e){const t=()=>this._referencePosUpdateQuery!==e;return this._doReferencePositionUpdateQuery(t)}})).catch((e=>{"mapcoordshelper:missing-geometry-service"===e.name&&(this.disableQueries=!0);})).then((()=>{this._referencePosUpdateQuery===e&&(this._referencePosUpdateQuery=null,this._referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"));})),t=this._referencePosUpdateTimer=L$h(this._referencePointUpdateInterval).then((()=>{this._referencePosUpdateTimer===t&&(this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate());}));this.notifyChange("updating");}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){const e=this._referencePosMapCoords.z*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=t[0],this._referencePosWGS84Comparable[1]=t[1],this._referencePosWGS84Comparable[2]=e):this._referencePosWGS84Comparable=[t[0],t[1],e],this._referencePosChanged();}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime);}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLightParams():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLightParams(),this.notifyChange("referencePositionWGS84Comparable");}_exceedsReferencePosDistThreshold(e){if(this._referencePosMapCoords){let t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return !0}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e}get test(){const e=this;return {renderer:this._renderer,set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t;},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t;},set referencePosUpdateTimer(t){e._referencePosUpdateTimer=t;},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t;}}}};e$x([d$y({type:Boolean,readOnly:!0})],j$k.prototype,"updating",null),e$x([d$y()],j$k.prototype,"disableQueries",void 0),e$x([d$y()],j$k.prototype,"referencePositionWGS84Comparable",null),e$x([d$y()],j$k.prototype,"_renderer",void 0),e$x([d$y()],j$k.prototype,"_referencePosWGS84Comparable",void 0),j$k=e$x([i$H("esri.views.3d.environment.SceneViewEnvironmentManager")],j$k);const k$e=new T$d,E$c=new T$d,Q$9=new Date,D$a={hours:0,minutes:0,seconds:0},q$9=r$D(.22,.22,.33),L$d=r$D(.22,.22,.22);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function i$r(a,n){return 0!=(a&n)}function m$q(a,n,t,i,m,r){0!==a&&(t?(r.min=Math.min(r.min,n),r.max=Math.max(r.max,n)):null!=i?(r.min-=Math.max(0,(n-r.min)*(1-i)),r.max+=Math.max(0,(n-r.max)*(1-i))):m&&(r.min-=Math.max(0,n-r.min-m),r.max+=Math.max(0,n-r.max-m)));}const r$r={selection:0,interactionType:0,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0};function o$t(i,m,r,o){return m=m||i.viewForward,r$B(o,m),d$z(o,o,Math.sign(z$i(m,r))),o}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function f$l(t,n,o=r$r){const a=p$p(t,n,o);if(0===a)return !1;const m=t.renderCoordsHelper,f=m.getAltitude(n.eye)+a,d=o$t(n,o.interactionDirection,y$l(t,n,Math.sign(a),h$l),g$n),l=r$B(A$a,n.viewForward),j=m.intersectInfiniteManifold(j$r(n.eye,d),f,C$b);return n.eye=r$A(j)?j:m.setAltitude(C$b,f,n.eye),n.center=j$s(C$b,n.eye,l,n.center),!0}function p$p(e,r,n=r$r){if(!d$q(e,n))return 0;const o=j$j(e.state.constraints.altitude,x$i);l$p(e,n,o);const i=e.renderCoordsHelper.getAltitude(r.eye),c=e$B(i,o.min,o.max)-i;return Math.abs(c)<=1e-6?0:c}function d$q(t,e){const r=t.state.constraints.altitude;return !(!t.state.isGlobal||!r)&&(2!==e.interactionType||!i$r(e.selection,1))}function l$p(t,e,r){const n=e.interactionType;if(0===n)return;const{min:o,max:i}=r,{interactionStartCamera:s,interactionFactor:c}=e,a=2===n||1===n,u=p$p(t,s),f=0===u?0:t.renderCoordsHelper.getAltitude(s.eye);r.min=o,r.max=i;m$q(u,f,a,c,.05*f,r);}function y$l(t,e,r,o){return t.renderCoordsHelper.worldUpAtPosition(e.eye,o),d$z(o,o,r),o}function j$j(t,e){return e.min=t.min,e.max=t.max,e}const x$i={min:0,max:0},g$n=n$F(),h$l=n$F(),A$a=n$F(),C$b=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function d$p(e,n,r=r$r){if(!e.state.isLocal)return 0;const t=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||t===1/0)return 0;x$h.min=0,x$h.max=t,O$e(e,r,x$h);const o=g$m(e,n),i=x$h.max-o;return i>=-1e-6?0:i}function y$k(n,t,s=r$r){const p=d$p(n,t,s);if(0===p)return !1;const y=n.pointsOfInterest.surfaceOrigin,O=g$m(n,t)+p,x=r$B(l$o,t.eye),C=o$t(t,s.interactionDirection,j$i(n,t,h$k),L$c);if(!U$d(q$h(y.renderLocation,O),j$r(t.eye,C),k$d))return !1;t.eye=k$d;const b=c$O(I$a,t.eye,x);t.center=u$A(k$d,t.center,b);const v=n.renderCoordsHelper.getAltitude(t.center),H=n.renderCoordsHelper.intersectInfiniteManifold(t.ray,v,k$d);return r$A(H)&&(t.center=H),!0}function O$e(e,n,r){const t=n.interactionType;if(0===t)return;const{min:o,max:i}=r,{interactionStartCamera:s,interactionFactor:c}=n,a=1===t||4===t,f=d$p(e,s),m=0===f?0:g$m(e,s);r.min=o,r.max=i;m$q(f,m,a,c,.05*m,r);}function g$m(e,r){const t=e.pointsOfInterest.surfaceOrigin;return q$g(r.eye,t.renderLocation)}function j$i(e,n,r){const o=e.pointsOfInterest.surfaceOrigin;return H$j(r,n.eye,o.renderLocation)}const x$h={min:0,max:0},l$o=n$F(),I$a=n$F(),L$c=n$F(),h$k=n$F(),k$d=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function i$q(s,i,a=0){const f=s.state.constraints;if(!f.collision.enabled)return !1;const u=m$y(s,i.eye),d=s.renderCoordsHelper.getAltitude(i.eye),y=u+f.collision.elevationMargin;if(d>=y)return !1;const m=s$x(i.eye);if(c$O(c$t,i.center,i.eye),i.eye=s.renderCoordsHelper.setAltitude(l$n,y,i.eye),1===a)i.center=u$A(c$t,i.eye,c$t);else if(2===a){const e=(m-d+y)/m;i.center=d$z(c$t,i.center,e);}return !0}const c$t=n$F(),l$n=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function n$r(c,n,f){c.worldUpAtPosition(n,i$p),c$O(m$p,f,n);const a=s$x(m$p);return 0===a?0:l$B(z$i(m$p,i$p)/a)}const i$p=n$F(),m$p=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function R$c(t,r,n=r$r,i=!0){Q$8.eyeCenterDistance=0,Q$8.requiresTwoSteps=!1;const s=T$c(t,r,n,void 0,Q$8);if(0===s)return !1;switch(r$C(B$9),f$s(B$9,B$9,-s,r.viewRight),n.tiltMode){case 1:I$g(z$d,r.viewForward,B$9),d$z(z$d,z$d,Q$8.eyeCenterDistance),r.center=u$A(G$9,r.eye,z$d);break;case 0:c$O(z$d,r.center,r.eye),I$g(z$d,z$d,B$9),r.eye=c$O(G$9,r.center,z$d);break;}return r.up=I$g(G$9,r.up,B$9),!Q$8.requiresTwoSteps||!i||R$c(t,r,n,!1)}function T$c(e,t,r=r$r,n=r$r,i){if(!e.state.constraints.tilt)return 0;const s=t.distance,a=e.state.constraints.tilt(s,K$a);return L$b(e,r,a),2===n.interactionType&&i$r(n.selection,2)&&E$b(e,n.interactionStartCamera,a),1===r.tiltMode||1===n.tiltMode?v$k(e,t,a,i):P$f(e,t,a)}function P$f(e,r,n){const i=n$r(e.renderCoordsHelper,r.center,r.eye),s=i-e$B(i,n.min,n.max);return k$c(s)?s:0}function v$k(t,r,n,i){switch(i&&(i.requiresTwoSteps=!1),t.viewingMode){case"global":return q$8(t,r,n,i);case"local":return O$d(t,r,n,i);default:return void n$V()}}function O$d(e,r,n,i){const s=n$r(e.renderCoordsHelper,r.center,r.eye),a=e$B(s,n.min,n.max),c=s-a;if(!k$c(c))return 0;if(i){const t=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,n=e.renderCoordsHelper.getAltitude(r.eye)-t,s=Math.cos(a);Math.abs(s)>1e-4?i.eyeCenterDistance=n/s:i.eyeCenterDistance=r.distance;}return c}function q$8(e,r,n,i){const s=b$f(e,r,N$e),a=e$B(s.tiltAtCenter,n.min,n.max);if(!k$c(s.tiltAtCenter-a))return 0;let c,o;return s.centerIsOnSurface?(c=H$9(s),o=F$8(s,c)):(c=s.constraints.clampTilt(s.eyeCenterDistance,s.tiltAtCenter),i&&c<Math.PI/2&&(i.requiresTwoSteps=!0,c=Math.PI/2-1e-5),o=U$8(s,c)),i&&(i.eyeCenterDistance=g$l(s,c)),o}function b$f(e,t,n){const i=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,a=i+p$K(e.spatialReference).radius,c=e.renderCoordsHelper.intersectManifold(t.ray,i,G$9);return n.eyeCenterDistance=t.distance,n.centerIsOnSurface=!1,r$A(c)?(n.eyeCenterDistance=q$g(t.eye,c),n.tiltAtCenter=n$r(e.renderCoordsHelper,c,t.eye),n.centerIsOnSurface=!0):e.state.isLocal?n.tiltAtCenter=n$r(e.renderCoordsHelper,t.center,t.eye):(F$f(k$m(a),t.ray,G$9),n.eyeCenterDistance=q$g(t.eye,G$9),n.tiltAtCenter=l$B(-z$i(t.viewForward,j$p(G$9,G$9)))),n.radius=a,n.eyeRadius=s$x(t.eye),n.constraints=e.state.constraints,n}function k$c(e){return Math.abs(e)>1e-9}function H$9(e){const{constraints:t,eyeCenterDistance:r,tiltAtCenter:n}=e;let i=n,s=t.clampTilt(r,n);const a=g$l(e,s);if(t.clampTilt(a,n)===s)return s;let c=0;for(;c<10&&k$c(s-i);){const r=(i+s)/2,n=g$l(e,r);k$c(t.clampTilt(n,r)-r)?i=r:s=r,c++;}return s}function g$l(e,r){if(!e.centerIsOnSurface)return e.eyeCenterDistance;const i=Math.PI-e$B(r,0,Math.PI),s=b$l(e.radius/e.eyeRadius*Math.sin(i)),a=Math.PI-i-s,c=Math.sin(a)/Math.sin(i);if(e.eyeRadius<e.radius&&c>1){const t=Math.PI-s,r=Math.PI-i-t;return Math.sin(r)/Math.sin(i)*e.eyeRadius}return c*e.eyeRadius}function F$8(e,t){const r=b$l(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),i=b$l(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?r-i:i-r}function U$8(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}function L$b(e,t,r){if(0===t.interactionType)return;const{interactionStartCamera:n,interactionFactor:i}=t,{min:s,max:a}=r,c=T$c(e,n,r$r,t),o=0===c?0:n$r(e.renderCoordsHelper,n.center,n.eye);r.min=s,r.max=a,2===t.interactionType?(i$r(t.selection,2)&&E$b(e,n,r),m$q(c,o,!0,i,J$9,r)):m$q(c,o,!1,i,J$9,r);}function E$b(e,t,n){if(e.state.isLocal)return;const i=e.state.constraints;if(!i.altitude)return;const s=p$Q(t.center),a=Math.sqrt(s),c=t.distance,o=p$K(e.spatialReference).radius,u=i.altitude.min+o,l=i.altitude.max+o,m=(u*u-c*c-s)/(-2*a*c),d=(l*l-c*c-s)/(-2*a*c);n.min=Math.max(n.min,Math.min(Math.PI-l$B(d),n.max)),n.max=Math.min(n.max,Math.PI-l$B(m));}const z$d=n$F(),B$9=e$y(),G$9=n$F(),J$9=M$f(5),K$a={min:0,max:0},N$e={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},Q$8={eyeCenterDistance:0,requiresTwoSteps:!1};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function t$w(t){return t}const u$r=t=>t*t,o$s=t=>1-u$r(1-t),i$o=t=>t<.5?u$r(2*t)/2:(o$s(2*(t-.5))+1)/2,n$q=t=>t*t*t,c$s=t=>1-n$q(1-t),a$u=t=>t<.5?n$q(2*t)/2:(c$s(2*(t-.5))+1)/2,s$n=t=>t*t*t*t,q$7=t=>1-s$n(1-t),r$q=t=>t<.5?s$n(2*t)/2:(q$7(2*(t-.5))+1)/2,e$t=t=>t*t*t*t*t,b$e=t=>1-e$t(1-t),d$o=t=>t<.5?e$t(2*t)/2:(b$e(2*(t-.5))+1)/2,h$j=t=>1-Math.cos(t*Math.PI/2),p$o=t=>1-h$j(1-t),x$g=t=>t<.5?h$j(2*t)/2:(p$o(2*(t-.5))+1)/2,M$b=t=>2**(10*(t-1)),f$k=t=>1-M$b(1-t),l$m=t=>t<.5?M$b(2*t)/2:(f$k(2*(t-.5))+1)/2,I$9=t=>-(Math.sqrt(1-t*t)-1),P$e=t=>1-I$9(1-t),g$k=t=>t<.5?I$9(2*t)/2:(P$e(2*(t-.5))+1)/2;function j$h(t){const u=2*(t-Math.sqrt((t-1)*t)),o=u/2/t;return i=>i<o?t*i*i:u*i-u+1}function k$b(t,u){return (o,i)=>o<u?u*t(o/u,i):1-t((1-o)/(1-u),i)*(1-u)}const m$o=k$b(j$h(1),1),v$j=k$b(j$h(1),0),w$g=k$b(j$h(1),.5),y$j=k$b(j$h(2),1),z$c=k$b(j$h(2),0),A$9=k$b(j$h(2),.5),B$8=k$b(j$h(3),1),C$a=k$b(j$h(3),0),D$9=k$b(j$h(3),.5),E$a=k$b(j$h(4),1),F$7=k$b(j$h(4),0),G$8=k$b(j$h(4),.5),H$8={linear:t$w,"in-quad":u$r,"out-quad":o$s,"in-out-quad":i$o,"in-coast-quad":m$o,"out-coast-quad":v$j,"in-out-coast-quad":w$g,"in-cubic":n$q,"out-cubic":c$s,"in-out-cubic":a$u,"in-coast-cubic":y$j,"out-coast-cubic":z$c,"in-out-coast-cubic":A$9,"in-quart":s$n,"out-quart":q$7,"in-out-quart":r$q,"in-coast-quart":B$8,"out-coast-quart":C$a,"in-out-coast-quart":D$9,"in-quint":e$t,"out-quint":b$e,"in-out-quint":d$o,"in-coast-quint":E$a,"out-coast-quint":F$7,"in-out-coast-quint":G$8,"in-sine":h$j,"out-sine":p$o,"in-out-sine":x$g,"in-expo":M$b,"out-expo":f$k,"in-out-expo":l$m,"in-circ":I$9,"out-circ":P$e,"in-out-circ":g$k};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function p$n(t,r,o=d$n,i=r){let e=!1;i!==r&&i.copyFrom(r),i.computeUp(t.state.viewingMode);for(let s=0;s<j$g;s++){let r=0;for(const s of y$i)if(i$r(o.selection,s.type)){const n=Math.abs(s.error(t,i,o));s.apply(t,i,o)&&(e=!0,r+=n);}if(0===r)break}const a=i$r(o.selection,8),c=m$n(o.interactionType,t);return a&&i$q(t,i,c)&&(e=!0),e&&i.computeUp(t.state.viewingMode),e}function m$n(t,r){switch(t){case 4:return 1;case 5:return r.state.isGlobal?2:1;default:return 0}}function f$j(r,o){const n="number"==typeof r?r:d$F(r,o),i=Math.min(1,n/150);return a$u(i)}function u$q(t,r,o){return T$c(t,r,o)*r.distance}const y$i=[{type:1,error:u$q,apply:R$c},{type:2,error:p$p,apply:f$l},{type:4,error:d$p,apply:y$k}],d$n={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0},j$g=5;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const f$i=n$F(),P$d=n$F(),_$b=n$F(),g$j=n$F(),k$a=n$F(),v$i=n$F(),x$f={upward:r$D(0,0,1),forward:r$D(0,1,0),sideway:r$D(1,0,0)},z$b=e$A();class T$b{constructor(t=1){this.viewingMode=t,this.center=n$F(),this.pitch=0,this.yaw=0,this.distance=0,this.lookAtDirection=t$G(x$f.forward);}pixelsPerPanAtZoom(t){return this.size/2/(this._zoomToPanScale*t)}zoomAtPixelsPerPan(t){return this.size/2/(this._zoomToPanScale*t)}pixelsPerRotateAtZoom(){const t=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/t}compareTo(t,e){if(e||(e={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),1===this.viewingMode){const i=(s$x(this.center)+s$x(t.center))/2;e.pan=w$l(this.center,t.center)*i;}else e.pan=q$g(this.center,t.center);let i=Math.abs(t.yaw-this.yaw);i>=Math.PI&&(i=2*Math.PI-i);const o=Math.abs(t.pitch-this.pitch);return e.rotate=Math.max(i,o),e.sourceZoom=this.distance,e.targetZoom=t.distance,e}interpolate(e,i,s){1===this.viewingMode?q$i(e.center,i.center,s.pan,this.center):y$v(this.center,e.center,i.center,s.pan),this.distance=s$F(e.distance,i.distance,s.zoom),this.pitch=s$F(e.pitch,i.pitch,s.rotate);let a=e.yaw;const h=i.yaw;Math.abs(h-a)>=Math.PI&&(a+=2*(a<h?1:-1)*Math.PI),this.yaw=s$F(a,h,s.rotate);}copyFrom(t){r$B(this.center,t.center),this.pitch=t.pitch,this.yaw=t.yaw,this.distance=t.distance,r$B(this.lookAtDirection,t.lookAtDirection),this.size=t.size,this.copyFromCommon(t),this.viewingMode=t.viewingMode;}copyFromRenderCamera(t){const e=this._lookAtOrientation(t.center,z$b);r$B(this.center,t.center),c$O(g$j,t.center,t.eye),L$g(g$j,g$j,e),L$g(k$a,t.up,e),this.distance=s$x(g$j),g$j[0]/=this.distance,g$j[1]/=this.distance,g$j[2]/=this.distance,this.pitch=this._eyeUpToPitch(g$j),this.yaw=this._eyeUpToYaw(g$j,k$a),this.size=Math.sqrt(t.width*t.width+t.height*t.height),this.copyFromCommon(t);}copyFromCommon(t){this.fov=t.fov,this._zoomToPanScale=Math.atan(.5*this.fov);}copyToRenderCamera(t){const i=this._lookAtOrientation(this.center,z$b);o$D(i,i),this._axisAngleVec3(x$f.sideway,this.pitch-Math.PI/2,x$f.forward,g$j),this._axisAngleVec3(x$f.upward,this.yaw,g$j),this._axisAngleVec3(x$f.sideway,this.pitch-Math.PI/2,x$f.upward,k$a),this._axisAngleVec3(x$f.upward,this.yaw,k$a),d$z(g$j,g$j,this.distance),L$g(g$j,g$j,i),L$g(k$a,k$a,i),t.center=this.center,t.eye=c$O(g$j,this.center,g$j),t.up=k$a;}_axisAngleVec3(t,e,i,s=i){const a=Math.cos(e),o=Math.sin(e);return d$z(f$i,i,a),_$f(P$d,t,i),d$z(P$d,P$d,o),d$z(_$b,t,(1-a)*z$i(t,i)),u$A(s,u$A(s,f$i,P$d),_$b)}_lookAtOrientation(t,e=e$A()){return this._upAtLookAt(t,_$b),_$f(f$i,this.lookAtDirection,_$b),j$p(f$i,f$i),0===f$i[0]&&0===f$i[1]&&0===f$i[2]&&r$B(f$i,x$f.sideway),_$f(P$d,_$b,f$i),j$p(P$d,P$d),e[0]=f$i[0],e[1]=P$d[0],e[2]=_$b[0],e[3]=f$i[1],e[4]=P$d[1],e[5]=_$b[1],e[6]=f$i[2],e[7]=P$d[2],e[8]=_$b[2],e}_upAtLookAt(t,e){return 2===this.viewingMode?r$B(e,x$f.upward):j$p(e,t)}_eyeUpToPitch(t){return Math.PI-w$l(x$f.upward,t)}_eyeUpToYaw(t,e){const i=v$i;return Math.abs(e[2])<.5?(r$B(i,e),t[2]>0&&d$z(i,i,-1)):r$B(i,t),_$f(P$d,i,x$f.upward),j$p(P$d,P$d),w$l(x$f.sideway,P$d,x$f.upward)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const o$r={desiredScreenFlow:2,minDuration:n$W(500),maxDuration:n$W(8e3)};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class t$v{constructor(t){this.createCamera=t,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:o$r.desiredScreenFlow},this.source=t(),this.target=t();}clone(){const e=new t$v(this.createCamera);return e.copyFrom(this),e}copyFrom(e){this.update(e.source,e.target,e.settings);}update(t,r,s){this.source!==t&&this.source.copyFrom(t),this.target!==r&&this.target.copyFrom(r),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=null!=s.desiredScreenFlow?s.desiredScreenFlow:o$r.desiredScreenFlow,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2;}halfWindowPanAtZoom(e){const t=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/t}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>1e-9}get hasRotate(){return this.compared.rotate>1e-9}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class e$s{constructor(){this.segments=[];}get time(){return this.segments.reduce(((e,o)=>t$U(e+o.time)),t$U(0))}interpolateComponentsAt(t,e){t=Math.min(Math.max(t,0),1),t*=this.time;let o=0,n=0;const s=this.definition;for(let m=0;m<this.segments.length;m++){const a=this.segments[m],r=a.definition;if(t<=a.time||m===this.segments.length-1){e=this.segmentInterpolateComponentsAt(a,t/a.time,e),s.hasPan?e.pan=(o+r.compared.pan*e.pan)/s.compared.pan:e.pan=1,s.hasRotate?e.rotate=(n+r.compared.rotate*e.rotate)/s.compared.rotate:e.rotate=1;const m=e.zoom*(r.compared.targetZoom-r.compared.sourceZoom)+r.compared.sourceZoom,i=this.segments[0].definition.compared.sourceZoom,p=this.segments[this.segments.length-1].definition.compared.targetZoom;return s.hasZoom?e.zoom=(m-i)/(p-i):e.zoom=1,e}t-=a.time,o+=r.compared.pan,n+=r.compared.rotate;}}segmentInterpolateComponentsAt(t,e,o){return t.interpolateComponentsAt(e,o)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class i$n{constructor(t){t&&this.update(t);}get time(){return this._time}update(t){t&&(this.definition?this.definition.copyFrom(t):this.definition=t.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow();}_updatePrecomputedVariables(){const t=this.definition,i=t.compared,o=i.sourceZoom,e=i.targetZoom;this._zoomSign=o>e?1:-1,this._panPixelsAtSource=i.pan*t.source.pixelsPerPanAtZoom(o);const s=(t.source.pixelsPerRotateAtZoom(o)+t.target.pixelsPerRotateAtZoom(e))/2;this._rotatePixels=i.rotate*s;}_updatePixelFlow(){const i=this.definition.compared.sourceZoom,o=this.definition.compared.targetZoom,{hasZoom:e,hasPan:s,hasRotate:n}=this.definition;let a=0,h=0;e&&(s&&(a=(o/i-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),n&&(h=this._zoomSign*(Math.log(i/o)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const l=this.definition.desiredPixelFlow;if(e&&s&&n){const t=a+h+a*h;this._zoomPixelFlow=a*h/t*l,this._panPixelFlow=h/t*l,this._rotatePixelFlow=a/t*l;}else if(e&&s){const t=1+a;this._zoomPixelFlow=a/t*l,this._panPixelFlow=1/t*l;}else if(e&&n){const t=1+h;this._zoomPixelFlow=h/t*l,this._rotatePixelFlow=1/t*l;}else if(s&&n){const t=this._panPixelsAtSource/this._rotatePixels,i=1+t;this._panPixelFlow=t/i*l,this._rotatePixelFlow=1/i*l;}else s?this._panPixelFlow=l:e?this._zoomPixelFlow=l:n&&(this._rotatePixelFlow=l);this._time=n?this.rotateTime:e?this.zoomTime:s?this.panTime:t$U(0);}get rotateTime(){return this.definition.hasRotate?t$U(this._rotatePixels/this._rotatePixelFlow):t$U(0)}get zoomTime(){return this.definition.hasZoom?t$U(this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow):t$U(0)}get panTime(){if(this.definition.hasPan){if(this.definition.hasZoom){const i=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,o=i*this._panPixelsAtSource;return t$U(Math.log(o*(this._zoomPixelFlow/this._panPixelFlow)+1)/(i*this._zoomPixelFlow))}return t$U(this._panPixelsAtSource/this._panPixelFlow)}return t$U(0)}_interpolateComponentsZoom(t){if(0===t||1===t)return t;if(this.definition.hasZoom){const i=this.definition.compared.sourceZoom,o=this.definition.compared.targetZoom;return (i*(i/o)**-t-i)/(o-i)}return t}_interpolateComponentsPan(t){if(0===t||1===t)return t;if(this.definition.hasPan&&this.definition.hasZoom){const i=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(i*t*this._time)-1))/(i*Math.LN2)}return t}_interpolateComponentsRotate(t){return t}interpolateComponentsAt(t,i){t=Math.min(Math.max(t,0),1);const o=this._interpolateComponentsZoom(t),e=this._interpolateComponentsPan(t),s=this._interpolateComponentsRotate(t);return i?(i.zoom=o,i.pan=e,i.rotate=s):i={zoom:o,pan:e,rotate:s},i}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function o$q(o,a,e){const n=a-o.compared.sourceZoom,t=o.halfWindowPanAtZoom(n);return -o.halfWindowSize*(e.ascensionFactor*Math.LN2*o.compared.pan+t)*Math.log(o.compared.sourceZoom/a)/(o.desiredPixelFlow*Math.LN2*t)}function a$t(o,a,e){const n=1/a,t=Math.log(o.compared.sourceZoom*n),i=1/o.desiredPixelFlow,r=1/Math.LN2,d=a-o.compared.sourceZoom,c=1/d,l=(e.ascensionFactor*Math.LN2*o.compared.pan+o.halfWindowPanAtZoom(d))/o.halfWindowPanAtZoom(1);return o.halfWindowSize*n*i*r*c*l-o.halfWindowSize*t*i*r*c+o.halfWindowSize*t*i*r*l/(d*d)}function e$r(o,a,e){const n=a-o.compared.sourceZoom,t=1/n,i=1/a,r=Math.log(o.compared.sourceZoom*i),d=(e.ascensionFactor*Math.LN2*o.compared.pan+o.halfWindowPanAtZoom(n))/o.halfWindowPanAtZoom(1);return o.halfWindowSize*t*(-2*t*i*d+2*t*r+2*i-2*r*d/(n*n)-d/(a*a))/(o.desiredPixelFlow*Math.LN2)}function n$p(o,a){return -o.halfWindowSize*Math.log(o.compared.sourceZoom/a)/(o.desiredPixelFlow*Math.LN2)}function t$u(o,a){return o.halfWindowSize/(a*o.desiredPixelFlow*Math.LN2)}function i$m(o,a){return -o.halfWindowSize/(a*a*o.desiredPixelFlow*Math.LN2)}function r$p(o,a,e){return -o.compared.pan*o.halfWindowSize*(e.ascensionFactor+e.descensionFactor-1)/(o.desiredPixelFlow*o.halfWindowPanAtZoom(a))}function d$m(o,a,e){return o.compared.pan*o.halfWindowSize*(e.ascensionFactor+e.descensionFactor-1)/(o.desiredPixelFlow*o.halfWindowPanAtZoom(a*a))}function c$r(o,a,e){return -2*o.compared.pan*o.halfWindowSize*(e.ascensionFactor+e.descensionFactor-1)/(o.desiredPixelFlow*o.halfWindowPanAtZoom(a*a*a))}function l$l(o,a,e){return o.halfWindowSize*(-o.halfWindowPanAtZoom(a)-e.descensionFactor*Math.LN2*o.compared.pan+o.halfWindowPanAtZoom(o.compared.targetZoom))*Math.log(a/o.compared.targetZoom)/(o.desiredPixelFlow*Math.LN2*o.halfWindowPanAtZoom(-a+o.compared.targetZoom))}function m$m(o,a,e){const n=Math.log(a/o.compared.targetZoom),t=1/o.desiredPixelFlow,i=1/Math.LN2,r=-a+o.compared.targetZoom,d=1/r,c=(-o.halfWindowPanAtZoom(a)-e.descensionFactor*Math.LN2*o.compared.pan+o.halfWindowPanAtZoom(o.compared.targetZoom))/o.halfWindowPanAtZoom(1);return -o.halfWindowSize*n*t*i*d+o.halfWindowSize*n*t*i*c/(r*r)+o.halfWindowSize*t*i*d*c/a}function h$i(o,a,e){const n=a-o.compared.targetZoom,t=1/n,i=1/a,r=Math.log(a/o.compared.targetZoom),d=(o.halfWindowPanAtZoom(a)+e.descensionFactor*Math.LN2*o.compared.pan-o.halfWindowPanAtZoom(o.compared.targetZoom))/o.halfWindowPanAtZoom(1);return o.halfWindowSize*t*(-2*t*i*d-2*t*r+2*i+2*r*d/(n*n)-d/(a*a))/(o.desiredPixelFlow*Math.LN2)}function s$m(o,a){return o.halfWindowSize*Math.log(a/o.compared.targetZoom)/(o.desiredPixelFlow*Math.LN2)}function f$h(o,a){return o.halfWindowSize/(a*o.desiredPixelFlow*Math.LN2)}function w$f(o,a){return -o.halfWindowSize/(a*a*o.desiredPixelFlow*Math.LN2)}function p$m(o){const a=Math.LN2*o.compared.pan,e=o.compared.sourceZoom-o.compared.targetZoom,n=o.halfWindowPanAtZoom(e),t=o.halfWindowSize*Math.log(o.compared.sourceZoom/o.compared.targetZoom)/(o.desiredPixelFlow*Math.LN2*n);return o.compared.sourceZoom<=o.compared.targetZoom?t*(a-n):t*(a+n)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function f$g(f,Z){let P=D$8(f,Z);const b={ascensionFactor:null!=Z.ascensionFactor?Z.ascensionFactor:.5,descensionFactor:null!=Z.descensionFactor?Z.descensionFactor:.5},g=0===b.ascensionFactor,h=0===b.descensionFactor,M=g?n$p:o$q,k=g?t$u:a$t,N=g?i$m:e$r,j=h?s$m:l$l,w=h?f$h:m$m,z=h?w$f:h$i,A=e=>M(f,e,b)+r$p(f,e,b)+j(f,e,b),I=o=>k(f,o,b)+d$m(f,o,b)+w(f,o,b),q=o=>N(f,o,b)+c$r(f,o,b)+z(f,o,b);let v=A(P);const y=p$m(f);let B;const C=Z.maximumIterations||20,E=null!=Z.maximumDistance?Z.maximumDistance:1/0;for(B=0;B<C;B++){const o=1e-6,e=(I(P)+o)/q(P);if(isNaN(e)||P>=E&&e<0){if(!isFinite(E))return null;P=E,v=A(P);break}if(P-=e,P<f.compared.sourceZoom||P<f.compared.targetZoom)return null;const n=A(P);if(Math.abs(n-v)/v<=.005)break;v=n;}return v>y*(1-.3)||P<f.compared.sourceZoom||P<f.compared.targetZoom?null:P}function D$8(o,e){const n=Math.max(o.compared.sourceZoom,o.compared.targetZoom),a=o.source.zoomAtPixelsPerPan(o.desiredPixelFlow/o.compared.pan)/2;return a<n?null!=e.maximumDistance?n+(e.maximumDistance-n)/2:1.5*n:e.maximumDistance?Math.min(e.maximumDistance,a):a}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class s$l extends e$s{constructor(i,e){super(),this._preallocSegments=[new i$n,new i$n,new i$n],this.update(i,e);}update(i,e){if(!i)return;this.definition?this.definition.copyFrom(i):this.definition=i.clone();let t=null;e&&e.apex&&(t=f$g(i,e.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,null==t?this._updateWithoutApex():this._updateWithApex(t,e.apex);}segmentInterpolateComponentsAt(t,n,o){return o=t.interpolateComponentsAt(n,o),t===this._ascensionSegment?o.zoom=o$s(o.zoom):t===this._descensionSegment&&(o.zoom=u$r(o.zoom)),o}_updateWithApex(i,e){const[t,n,o]=this._preallocSegments,s=null!=e.ascensionFactor?e.ascensionFactor:.5,d=Math.min(1-s,null!=e.ascensionFactor?e.descensionFactor:.5),a=1-s-d;t.definition?t.definition.copyFrom(this.definition):t.definition=this.definition.clone(),t.definition.compared.targetZoom=i,t.definition.compared.pan=this.definition.compared.pan*s,t.definition.compared.rotate=this.definition.compared.rotate*s,t.update(),this._ascensionSegment=t,this.segments.push(t),a>0&&(n.definition?n.definition.copyFrom(this.definition):n.definition=this.definition.clone(),n.definition.copyFrom(this.definition),n.definition.compared.sourceZoom=i,n.definition.compared.targetZoom=i,n.definition.compared.pan=this.definition.compared.pan*a,n.definition.compared.rotate=this.definition.compared.rotate*a,n.update(),this.segments.push(n)),o.definition?o.definition.copyFrom(this.definition):o.definition=this.definition.clone(),o.definition.compared.sourceZoom=i,o.definition.compared.pan=this.definition.compared.pan*d,o.definition.compared.rotate=this.definition.compared.rotate*d,o.update(),this._descensionSegment=o,this.segments.push(o);}_updateWithoutApex(){const[i]=this._preallocSegments;i.update(this.definition),this.segments.push(i);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const r$o={zoom:0,pan:0,rotate:0};class m$l{constructor(i){this.createCamera=i,this._time=n$W(0),this.definition=new t$v(i),this.path=new s$l;}get time(){return this._time}update(t,a,s){this.definition.update(t,a,s),this.path.update(this.definition,s),this._time=this._applyTimeSettings(r$R(this.path.time),s),this._easing=s.easing?s.easing:this._time>=1e3?w$g:f$k;}cameraAt(t,i){i=i||this.createCamera(),t=Math.min(Math.max(0,t),1),t=this._normalizedEasing(t);const e=this.path.interpolateComponentsAt(t,r$o);return i.interpolate(this.definition.source,this.definition.target,e),i}_normalizedEasing(t){const i=this._easing(0,this._time),e=this._easing(1,this._time);return (this._easing(t,this._time)-i)/(e-i)}_applyTimeSettings(i,e){const n=null!=e.speedFactor?e.speedFactor:1;null!=e.duration?i=e.duration:null!=e.speedFactor&&(i=n$W(i/n));const a=null!=e.minDuration?e.minDuration:o$r.minDuration/n,o=null!=e.maxDuration?e.maxDuration:o$r.maxDuration/n;return n$W(Math.min(Math.max(a,i),o))}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const c$q=n$F();class h$h{constructor(i){this.currentTime=n$W(0),this._animation=new m$l((()=>new T$b(i))),this._current=new T$b(i);}get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}update(i,m,s){const o=this._animation.definition.source,a=this._animation.definition.target,h=c$O(c$q,m.center,i.center),u=s$x(h);u>=1e-5?(h[0]/=u,h[1]/=u,h[2]/=u):(h[0]=0,h[1]=1,h[0]=0),r$B(o.lookAtDirection,h),r$B(a.lookAtDirection,h),o.copyFromRenderCamera(i),a.copyFromRenderCamera(m),this._current.copyFrom(o),this._animation.update(o,a,s),this.currentTime=n$W(0),i.almostEquals(m)&&(this.currentTime=this._animation.time);}cameraAt(t,i){return this._animation.cameraAt(t,this._current),i=i||new J$d,this._current.copyToRenderCamera(i),i}step(e,r){return this.finished||(this.currentTime=n$W(this.currentTime+r$R(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,r)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var o$p;!function(e){e.Ready="ready",e.Rejected="rejected",e.Running="running",e.Stopped="stopped",e.Finished="finished";}(o$p||(o$p={}));let i$l=class extends p$N{constructor(){super(...arguments),this.state=o$p.Ready;}get active(){return this.state===o$p.Running}get isInteractive(){return !1}get canStop(){return !1}stopController(){return !!this.canStop&&(this.state=o$p.Stopped,!0)}finishController(){this.state=o$p.Finished;}get steppingFinished(){return !1}};e$x([d$y({readOnly:!0})],i$l.prototype,"active",null),e$x([d$y()],i$l.prototype,"state",void 0),i$l=e$x([i$H("esri.views.3d.state.controllers.CameraController")],i$l);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let a$s=class extends i$l{get canStop(){return !0}set asyncResult(t){this._asyncResult&&(this._asyncResult.reject(m$D()),this._asyncResult=null),this.state===o$p.Finished||this.state===o$p.Stopped?this.state===o$p.Finished?t.resolve():t.reject(m$D()):this._asyncResult=t;}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=o$p.Running,r$A(this.viewAnimation)&&this.viewAnimation.when((()=>this.updateStateFromViewAnimation()),(()=>this.updateStateFromViewAnimation()));}updateStateFromViewAnimation(){!r$A(this.viewAnimation)||this.state!==o$p.Ready&&this.state!==o$p.Running||(this.viewAnimation.state===n$X.State.FINISHED?this.finish():this.viewAnimation.state===n$X.State.STOPPED&&(this.state=o$p.Stopped));}onControllerEnd(){r$A(this.viewAnimation)&&!this.viewAnimation.done&&(this.state===o$p.Finished?this.viewAnimation.finish():this.state===o$p.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===o$p.Finished?this._asyncResult.resolve():this._asyncResult.reject(m$D()));}finish(){this.finishController();}};a$s=e$x([i$H("esri.views.3d.state.controllers.AnimationController")],a$s);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let h$g=class extends a$s{constructor(i){super(i),this.view=null,this.mode="interaction",this.hasTarget=!1;}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.animation=new h$h(this.view.state.viewingMode),this.viewAnimation="interaction"===this.mode?null:new n$X;}get isInteractive(){return "interaction"===this.mode}begin(i,t){this.hasTarget=!0;const e=this.animationSettings(t);p$l.copyFrom(this.view.state.camera);const n=new y$s(this.view.state.viewingMode);this.intersectionHelper.intersectRay(p$l.ray,n,l$k)&&(p$l.center=l$k),this.animation.update(p$l,i,e),this.animation.finished&&this.finish();}finish(){this.animation.currentTime=this.animation.time,super.finish();}get steppingFinished(){return this.hasTarget&&this.animation.finished}stepController(i,t){this.hasTarget&&this.animation.step(i,t);}onControllerEnd(i){this.hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,i),this.animation.currentTime=this.animation.time),super.onControllerEnd(i);}animationSettings(i={}){return {apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...i,easing:"string"==typeof i.easing?H$8[i.easing]:i.easing}}};e$x([d$y({constructOnly:!0})],h$g.prototype,"view",void 0),e$x([d$y({constructOnly:!0})],h$g.prototype,"mode",void 0),h$g=e$x([i$H("esri.views.3d.state.controllers.PointToPointAnimationController")],h$g);const p$l=new J$d,l$k=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function s$k(r,s,m,p){const n=m$E(s,m,e$q);return U$d(r,n,p)}const e$q=d$G();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function K$9(t,e,n){return n[0]=e[0]/(t.fullWidth/t.pixelRatio),n[1]=e[1]/(t.fullHeight/t.pixelRatio),n}function N$d(t){for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;return t}function O$c(t,e,n){const o=f$x.get();r$C(o),f$s(o,o,n[3],v$m(n)),c$O(Dt,t.eye,e),I$g(Dt,Dt,o),t.eye=u$A(Dt,Dt,e),c$O(Dt,t.center,e),I$g(Dt,Dt,o),t.center=u$A(Dt,Dt,e),t.up=I$g(Dt,t.up,o);}function Q$7(t,e,n,o){return D$h(t,s$G(e,n,Ot),o)}function X$5(t,e,n,o){const r=c$T.get();let a=1-n;c$O(r,e,t.eye);const s=s$x(r);let i=s*(1-a);a>=0&&i<o&&(i=o,a=-(i-s)/s),Math.abs(s-i)<1e-6||(d$z(r,r,a),t.eye=u$A(Dt,t.eye,r),t.center=y$v(Dt,t.center,e,a));}function Y$7(t,e,n){e.getScreenCenter(Z$5),s$k(t,e,Z$5,Dt)&&(e.center=Dt);const o=e.distance,r=o*n;if(Math.abs(o-r)<1e-6)return;const a=d$z(c$T.get(),e.viewForward,r);e.eye=c$O(Dt,e.center,a);}const Z$5=i$S();function _$a(t,e){o$C(e,0,0,0);for(const n of t)u$A(e,e,n);d$z(e,e,1/t.length);}function tt$3(t,e,n,o){return Math.sin(t/s$x(e))*(n+o.radius)}function et$2(t,e,n,o){return tt$3(Math.PI/2,e,n,o)+(t-Math.PI/2)}var nt$2;!function(t){t[t.Vertical=0]="Vertical",t[t.Horizontal=1]="Horizontal";}(nt$2||(nt$2={}));const ot$1={Elevation:3e4,Angle:M$f(6)},rt$1={Pole:.95,Angle:M$f(18),Tilt:45},at$1=M$f(80);function st$1(t,e,n,o,r){const a=n$F(),s=P$m();let i=!0,c=!0;return t.intersectScreen(n,a)?s[3]=s$x(a):(c=!1,e.aboveGround?s[3]=Math.max(s$x(e.center),.9*r.radius):s[3]=s$x(e.eye)-e.relativeElevation,o?ut$1(s,e,n,a):i=s$k(s,e,n,a)),{sphere:s,scenePickPoint:i?a:null,hasGeometryIntersection:c}}function it$2(t,e,n,o){if(s$x(t.eye)-o.radius>ot$1.Elevation)return nt$2.Horizontal;if(!n)return nt$2.Vertical;m$E(t,e,Qt);return -Math.sign(t.relativeElevation)*(.5*Math.PI+f$v(t.eye,Qt.direction))<ot$1.Angle?nt$2.Vertical:nt$2.Horizontal}function ct$1(t,e,n){c$O(mt$1,n,e),t.eye=c$O(Dt,t.eye,mt$1),t.center=c$O(Dt,t.center,mt$1);}const mt$1=n$F();function ut$1(t,e,n,r){const a=m$E(e,n,Ot);return !t$F(a)&&(F$f(t,a,pt$1),U$d(t,a,r)?!(x$p(pt$1,a.origin)<x$p(r,a.origin))||(r$B(r,pt$1),!1):(c$O(lt$1,e.eye,e.center),j$p(lt$1,lt$1),k$n(lt$1,-z$i(j$p(lt$1,lt$1),pt$1),ft$1),D$h(ft$1,a,r),!1))}const pt$1=n$F(),lt$1=n$F(),ft$1=p$S();function ht$1(o,r,a,s,i,c){let m;if(_$f(Lt,o,r),c$O(Jt,o,r),s$x(o)<=i||!s.aboveGround){_$f(a,Jt,s.eye);const u=z$i(o,r)/(s$x(o)*s$x(r)),p=Math.cos(e$B(S$p.normalize(M$f(c)),0,at$1));m=-l$B(u)-Math.max(0,s$x(r)-i)/(p*i);}else c$O(Mt,s.eye,s.center),_$f(a,Jt,Mt),m=-s$x(Jt)/i;return j$p(a,a),d$z(a,a,s$x(Lt)),m}const Mt=n$F();function yt(o,r,a,s){let i,c;const m=Math.cos(e$B(S$p.normalize(M$f(s)),0,at$1));return i=r>a?-(r-a)/(m*a):r<-a?Math.PI-(r+a)/(m*a):l$B(r/a),c=o>a?-(o-a)/(m*a):o<-a?Math.PI-(o+a)/(m*a):l$B(o/a),(c-i)*a}function gt$1(t,e,n,o,r,a,s,i,c,u){const p=yt(t[2],e[2],s[3],c),f=u?yt(t[0],e[0],s[3],180):e[0]-t[0],h=Math.sin(i)*f-Math.cos(i)*p,y=Math.cos(i)*f+Math.sin(i)*p;j$p(Dt,r);const g=u?h/Math.sqrt(Math.abs(s[3]**2-z$i(n,Dt)**2)):h/s[3],b=y/Math.sqrt(Math.abs(s[3]**2-z$i(n,o)**2));r$K(a,g,b);}function bt$1(t,e,n,o,r,a,s,i,c,m){_$f(Lt,t,e),F$9(a.up,a.eye,Et,Gt,St$1),F$9([0,0,1],a.eye,At,Ht,Ut),r$B(n,Ht),r$B(o,At),j$p(n,n),d$z(n,n,s$x(Lt)),D$d(t,j$p(Gt,Gt),j$p(St$1,St$1),j$p(Et,Et),Vt),D$d(e,Gt,St$1,Et,qt),gt$1(Vt,qt,t,At,Ht,r,s,i,c,m);}function dt$1(t,e,n,o,r,c,m){r$C(Ct),r$C(Tt$1),r$C(Wt),f$s(Ct,Ct,r,o),f$s(Tt$1,Tt$1,m,c),e$G(Wt,Ct,Tt$1),c$O(e,t,n),I$g(e,e,Wt),u$A(e,e,n);}function jt(t,e,n,o,r,c){r$C(Ct),r$C(Tt$1),r$C(Wt),f$s(Ct,Ct,o,n),f$s(Tt$1,Tt$1,c,r),e$G(Wt,Ct,Tt$1),c$O(Dt,t.eye,e),I$g(Dt,Dt,Wt),t.eye=u$A(Dt,Dt,e),c$O(Dt,t.center,e),I$g(Dt,Dt,Wt),t.center=u$A(Dt,Dt,e),c$O(Dt,t.up,e),I$g(Dt,Dt,Wt),t.up=u$A(Dt,Dt,e);}function vt(t,e,n,o,r,a,s=rt$1.Pole,i=rt$1.Angle){const c=Math.abs(o)>Math.PI-i||Math.abs(o)<i,m=Math.abs(t[2])<n*s||Math.abs(e)>n;return !!(c&&m&&a.aboveGround&&r<rt$1.Tilt)}function zt(t,e,n,o,r,a){if(a)k$g(n,o,Rt),O$c(e,t,Rt);else {const a=ht$1(n,o,Nt,e,t[3],r);O$c(e,t,m$r(Nt,a));}}function xt$1(t,e,n,o,r,a,s){const i=s?20:1,c=1e-12;let m,u;r$B(Bt,o),Kt.copyFrom(e);for(let p=0;p<i&&x$p(n,Bt)>c&&(m=x$p(n,Bt),bt$1(n,Bt,Ht,At,Ft,Kt,t,r,a,s),jt(Kt,t,At,Ft[1],Ht,Ft[0]),dt$1(Bt,Bt,t,At,Ft[1],Ht,Ft[0]),u=x$p(n,Bt),u<m||0===p);p++)e.copyFrom(Kt);}function Pt(e,n,o,r,a,s,i){vt(o,z$i(n.up,o),e[3],-S$p.normalize(M$f(a)),s,n,rt$1.Pole,rt$1.Angle)?xt$1(e,n,o,r,-S$p.normalize(M$f(a)),s,i):zt(e,n,o,r,s,i);}function kt(t,e,n,o,r,a){const{eye:i}=t;F$9([0,0,1],i,At,Ht,Ut);const c=e.translation[0]*n.pan,m="zoom"===r.mode?0:e.translation[1]*n.pan,u=Math.max(Math.sqrt(Math.abs(1-z$i(t.center,At)**2/s$x(t.center)**2)),.5),p=(Math.sin(a)*m+Math.cos(a)*c)/u,f=-Math.cos(a)*m+Math.sin(a)*c;switch(f$s(o.pan.matrix,o.pan.matrix,p,At),o.pan.enabled=!0,r.mode){case"pan":f$s(o.pan.matrix,o.pan.matrix,f,Ht),o.pan.enabled=!0;break;case"zoom":o.zoom=-e.translation[1]*n.zoom;}}function It(t,e,n,o,r){const{eye:a,viewRight:i}=t,c=_$f(c$T.get(),i,a),m=e.translation[0]*n.pan;switch(0!==m&&(f$s(o.pan.matrix,o.pan.matrix,-m,c),o.pan.enabled=!0),r.mode){case"pan":{const t=e.translation[1]*n.pan;0!==t&&(f$s(o.pan.matrix,o.pan.matrix,t,i),o.pan.enabled=!0);break}case"zoom":o.zoom=-e.translation[1]*n.zoom;}}function wt(e,n,o,r,a,s,i,c,m){vt(e.center,z$i(e.up,e.center),s$x(e.center),-S$p.normalize(M$f(s)),i,n)?kt(n,o,r,c,m,-S$p.normalize(M$f(a))):It(n,o,r,c,m);}const At=n$F(),Ht=n$F(),Ut=n$F(),Et=n$F(),Gt=n$F(),St$1=n$F(),Vt=n$F(),qt=n$F(),Ft=n$Q(),Rt=i$u(),Ct=e$y(),Tt$1=e$y(),Wt=e$y(),Bt=n$F(),Dt=n$F(),Jt=n$F(),Kt=new J$d,Lt=n$F(),Nt=n$F(),Ot={origin:n$F(),direction:n$F()},Qt={origin:n$F(),direction:n$F()};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const S$e=.6,z$a=4,M$a=12,L$a=60,V$a=20;let O$b=class extends h$g{constructor(){super(...arguments),this.zoomLocation=n$F(),this.tmpCamera=new J$d,this.tmpViewDir=n$F(),this.tmpRayDir={origin:n$F(),direction:n$F()},this.targetOnSphere=n$F(),this.tmpCenter=n$F(),this.constraintOptions={selection:7,interactionType:1,interactionFactor:null,interactionStartCamera:new J$d,interactionDirection:null,tiltMode:0},this.sphere=P$m();}initialize(){this.intersector=new y$s(this.view.state.viewingMode);}zoomStep(t,i){if(!this.active)return;const e=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(e.camera):this.animation.cameraAt(1,r);let o=!1,a=!1;this.intersectionHelper.intersectScreen(i,this.zoomLocation)&&(o=t>0,a=!0),this.tmpCamera.copyFrom(e.camera),o?this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter):this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:r$B(this.zoomLocation,this.tmpCamera.center),this.updateCamera(this.tmpCamera,t,this.zoomLocation,i,a),this.begin(this.tmpCamera);}animationSettings(){return {apex:null,duration:n$W(600),easing:f$k}}updateCamera(t,e,r,s,p){const y=p$K(this.view.spatialReference);if(it$2(t,s,p,y)===nt$2.Horizontal||s$H("disable-feature:context-navigation")){let i=S$e**e;this.sphere[3]=s$x(r),c$O(this.tmpViewDir,t.center,t.eye);const h=s$x(this.tmpViewDir);let p=h*i;if(i<=1&&p<z$a&&(p=z$a,i=p/h),Math.abs(h-p)<1e-6)return;const l=s$x(t.center);if(this.sphere[3]!==l){const e=this.sphere[3]+i*(l-this.sphere[3]);t.center=d$z(U$7,t.center,e/l);}d$z(this.tmpViewDir,this.tmpViewDir,-i),t.eye=u$A(U$7,t.center,this.tmpViewDir),p$n(this.view,t,this.constraintOptions),x$p(r,t.center)>1e-12&&s$k(this.sphere,t,s,this.targetOnSphere)&&Pt(this.sphere,t,r,this.targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0);}else {let i=S$e**Math.abs(e);const o=e>0?1:-1;let a;m$E(t,s,this.tmpRayDir),j$p(this.tmpRayDir.direction,this.tmpRayDir.direction),this.view.camera.position.hasZ&&(a=Math.abs(this.view.camera.position.z));let c=Math.max(M$a*a,V$a);const p=this.view._stage.renderView.getMinimalDepthForArea(s[0],s[1],this.view.state.camera,L$a);c=c>p?p:c,d$z(this.tmpRayDir.direction,this.tmpRayDir.direction,c),u$A(r,this.tmpRayDir.origin,this.tmpRayDir.direction);let l=c*i;if(e>0&&l<z$a&&(l=z$a,i=l/c),Math.abs(c-l)<1e-6)return;d$z(this.tmpRayDir.direction,this.tmpRayDir.direction,o*(1-i)),t.eye=u$A(U$7,t.eye,this.tmpRayDir.direction),t.center=u$A(U$7,t.center,this.tmpRayDir.direction);}i$q(this.view,t);}};O$b=e$x([i$H("esri.views.3d.state.controllers.global.ZoomStepController")],O$b);const U$7=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const j$f=.6,g$i=4,w$e=60,b$d=14,v$h=20;let d$l=class extends h$g{constructor(){super(...arguments),this.zoomLocation=n$F(),this.tmpCamera=new J$d,this.tmpRayDir=n$F(),this.tmpCenter=n$F(),this.constraintOptions={selection:15,interactionType:1,interactionFactor:null,interactionStartCamera:new J$d,interactionDirection:null,tiltMode:0};}zoomStep(t,e){if(!this.active)return;const i=this.view.state,{interactionStartCamera:c}=this.constraintOptions;this.animation.finished?c.copyFrom(i.camera):this.animation.cameraAt(1,c),this.tmpCamera.copyFrom(i.camera);const l=new y$s(this.view.state.viewingMode);t>0?(this.intersectionHelper.intersectScreenFreePointFallback(e,this.zoomLocation),this.intersectionHelper.intersectRay(this.tmpCamera.ray,l,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter)):this.intersectionHelper.intersectRay(this.tmpCamera.ray,l,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:r$B(this.zoomLocation,this.tmpCamera.center);const C=j$f**t;if(!r$S()){let t=this.view._stage.renderView.getMinimalDepthForArea(e[0],e[1],this.view.state.camera,w$e);const i=Math.max(b$d*Math.abs(this.view.camera.position.z),v$h);if(t=t?Math.min(t,i):i,t){const e=n$F();c$O(e,this.zoomLocation,this.tmpCamera.eye),t<s$x(e)&&(j$p(e,e),u$A(this.zoomLocation,this.tmpCamera.eye,d$z(e,e,t)));}}this.updateCamera(this.tmpCamera,C,this.zoomLocation),this.begin(this.tmpCamera);}animationSettings(){return {apex:null,duration:n$W(600),easing:f$k}}updateCamera(t,e,i){c$O(this.tmpRayDir,i,t.eye);const o=s$x(this.tmpRayDir);let a=o*e;e<=1&&a<g$i&&(a=g$i,e=a/o),Math.abs(o-a)<1e-6||(d$z(this.tmpRayDir,this.tmpRayDir,e),t.eye=c$O(z$9,i,this.tmpRayDir),t.center=y$v(z$9,t.center,i,1-e),p$n(this.view,t,this.constraintOptions));}};d$l=e$x([i$H("esri.views.3d.state.controllers.local.ZoomStepController")],d$l);const z$9=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class s$j extends i$T{constructor(o,t){super(!0),this.view=o,this.registerIncoming("double-click",t,(o=>this.handleDoubleClick(o)));}handleDoubleClick(r){const s=r.data;if(t$V(s,"primary")){const i=this.view.state.isGlobal?new O$b({view:this.view,mode:"animation"}):new d$l({view:this.view,mode:"animation"});this.view.state.switchCameraController(i),i.zoomStep(Math.log(.5)/Math.log(.6),i$S(s.x,s.y)),r.stopPropagation();}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let a$r=class extends i$l{constructor(){super(...arguments),this.startCamera=new J$d,this.currentCamera=new J$d;}get isInteractive(){return !0}stepController(r,e){e.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(e);}onControllerStart(r){this.state=o$p.Running,this.startCamera.copyFrom(r),this.currentCamera.copyFrom(r);}onControllerEnd(r){r.copyViewFrom(this.currentCamera);}};a$r=e$x([i$H("esri.views.3d.state.controllers.InteractiveController")],a$r);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const O$a=7,U$6=90;let V$9=class extends a$r{constructor(t){super(t),this.view=null,this.pivot=0,this.lastPoint=n$Q(),this.tmpWorldUp=n$F(),this.tmpViewDir=n$F(),this.tmpRotCurPoint=n$Q(),this.tmpTransf=e$y(),this.tmpAxis=n$F(),this.tmpPivotPoint=n$F(),this.pivotPos=n$F(),this.constraintOptions={selection:15,interactionType:2,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0};}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.rotScale=0===this.pivot?3:1.5;}begin(t){if(this.active){switch(this.pivot){case 1:r$B(this.pivotPos,this.startCamera.eye),this.constraintOptions.interactionType=3,this.constraintOptions.tiltMode=1,this.constraintOptions.selection=0;break;case 0:this.intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this.pivotPos)||r$B(this.pivotPos,this.startCamera.center),s$H("disable-feature:context-navigation")||this.constrainPivotPoint(t),this.startCamera.center=this.pivotPos,this.constraintOptions.interactionType=2,this.constraintOptions.tiltMode=0,this.constraintOptions.selection=11;}this.constraintOptions.interactionStartCamera=this.startCamera,K$9(this.startCamera,t,this.lastPoint);}}constrainPivotPoint(t){const i=this.startCamera,s=n$F();c$O(s,this.pivotPos,i.eye);let o=s$x(s);this.view.camera.position.hasZ&&(o=Math.min(o,O$a*Math.abs(this.view.camera.position.z)));const e=p$K(this.view.spatialReference),a=i$S(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),n=it$2(this.startCamera,a,!0,e);let p=this.view._stage.renderView.getMinimalDepthForArea(i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,2.5*U$6,U$6),h=this.view._stage.renderView.getMinimalDepthForArea(t[0],t[1],i,U$6);void 0===p&&void 0===h||(p=void 0===p?h:p,h=void 0===h||n===nt$2.Horizontal?p:h,o=p>h?h:p),j$p(s,s),r$B(this.pivotPos,u$A(this.tmpPivotPoint,i.eye,d$z(this.tmpPivotPoint,s,o)));}update(t){if(this.active){switch(this.pivot){case 1:this.currentCamera.center=this.applyRotation(this.currentCamera,t,this.currentCamera.center,this.pivotPos);break;case 0:this.currentCamera.center=this.pivotPos,this.currentCamera.eye=this.applyRotation(this.currentCamera,t,this.currentCamera.eye,this.pivotPos);}p$n(this.view,this.currentCamera,this.constraintOptions);}}end(){this.active&&this.finishController();}applyRotation(t,i,r,e){this.view.renderCoordsHelper.worldUpAtPosition(e,this.tmpWorldUp),K$9(t,i,this.tmpRotCurPoint);let a=(this.lastPoint[1]-this.tmpRotCurPoint[1])*this.rotScale,h=(this.tmpRotCurPoint[0]-this.lastPoint[0])*this.rotScale;c$O(this.tmpViewDir,r,e);const m=s$x(this.tmpViewDir),l=l$B(z$i(this.tmpViewDir,this.tmpWorldUp)/m);if(1===this.pivot){a*=-.5;const t=.5*Math.PI-l,i=.5*Math.PI*.99;a=t-Math.max(-i,Math.min(i,t+a));}return a=e$B(a+l,d$t.min,d$t.max)-l,r$C(this.tmpTransf),_$f(this.tmpAxis,t.up,this.tmpViewDir),0===this.pivot&&(h=-h),f$s(this.tmpTransf,this.tmpTransf,h,this.tmpWorldUp),f$s(this.tmpTransf,this.tmpTransf,a,this.tmpAxis),I$g(this.tmpViewDir,this.tmpViewDir,this.tmpTransf),t.up=I$g(b$c,t.up,this.tmpTransf),u$A(b$c,e,this.tmpViewDir),a$Y(this.lastPoint,this.tmpRotCurPoint),b$c}};e$x([d$y({constructOnly:!0})],V$9.prototype,"view",void 0),e$x([d$y()],V$9.prototype,"pivot",void 0),V$9=e$x([i$H("esri.views.3d.state.controllers.RotateController")],V$9);const b$c=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class a$q extends i$T{constructor(t,r,e,o){super(!0),this.view=t,this.pointerAction=r,this.pivot=e,this.registerIncoming("drag",o,(t=>this.handleDrag(t)));}handleDrag(e){const a=e.data;if(a.pointers.size>1)return;if(!r$T(e.data,this.pointerAction))return;const i=i$S(a.center.x,a.center.y);switch(a.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.cameraController=new V$9({view:this.view,pivot:this.pivot}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(i);break;case"update":this.cameraController&&this.cameraController.update(i);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null);}e.stopPropagation();}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const x$e=30,M$9=70;let O$9=class extends a$r{constructor(t){super(t),this.view=null,this.pickPoint=n$F(),this.tmpP0=n$Q(),this.panAxisAngle=i$u(),this.tmpRayDir=n$F(),this.targetOnSphere=n$F(),this.tmpRay={origin:n$F(),direction:n$F()},this.dragBeginPoint=i$S(),this.normalizedAnchorPoint=n$Q(),this.constraintOptions={selection:7,interactionType:1,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0},this.sphere=P$m(),this.hasPickPoint=!1;}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(t){if(!this.active)return;a$Y(this.dragBeginPoint,t),K$9(this.startCamera,t,this.normalizedAnchorPoint);const e=p$K(this.view.spatialReference),r=st$1(this.intersectionHelper,this.startCamera,t,!1,e);if(this.navMode=it$2(this.startCamera,t,r.hasGeometryIntersection,e),this.navMode===nt$2.Horizontal||s$H("disable-feature:context-navigation"))this.hasPickPoint=!!r.scenePickPoint,this.pickPoint=r.scenePickPoint,this.sphere=r.sphere;else {let i;m$E(this.startCamera,t,this.tmpRay),j$p(this.tmpRay.direction,this.tmpRay.direction),this.view.camera.position.hasZ&&(i=Math.abs(this.view.camera.position.z));let e=x$e*i;const r=this.view._stage.renderView.getMinimalDepthForArea(t[0],t[1],this.view.state.camera,M$9);e=e>r?r:e,this.hasPickPoint=!0,d$z(this.tmpRay.direction,this.tmpRay.direction,e),u$A(this.pickPoint,this.tmpRay.origin,this.tmpRay.direction);}this.constraintOptions.interactionStartCamera=this.startCamera;}update(t){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this.navMode===nt$2.Horizontal||s$H("disable-feature:context-navigation")){c$O(this.tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const i=s$x(this.tmpRayDir);K$9(this.currentCamera,t,this.tmpP0);const e=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=i*2**e;const s=this.view.state.constraints.minimumPoiDistance;if(e<0&&r<s&&(r=s),Math.abs(i-r)<1e-6)return;if(this.hasPickPoint&&r<i){const t=1-(1-r/i)*(1-this.sphere[3]/s$x(this.currentCamera.center));this.currentCamera.center=d$z(S$d,this.currentCamera.center,t);}d$z(this.tmpRayDir,this.tmpRayDir,-r/i),this.currentCamera.eye=u$A(S$d,this.currentCamera.center,this.tmpRayDir),this.constraintOptions.interactionFactor=f$j(this.dragBeginPoint,t),p$n(this.view,this.currentCamera,this.constraintOptions),this.hasPickPoint&&(ut$1(this.sphere,this.currentCamera,this.dragBeginPoint,this.targetOnSphere),k$g(this.pickPoint,this.targetOnSphere,this.panAxisAngle),O$c(this.currentCamera,this.sphere,this.panAxisAngle));}else {const i=s$x(this.tmpRay.direction);K$9(this.currentCamera,t,this.tmpP0);const e=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=i*2**e;const s=this.view.state.constraints.minimumPoiDistance;if(e<0&&r<s&&(r=s),Math.abs(i-r)<1e-6)return;d$z(this.tmpRayDir,this.tmpRay.direction,1-r/i),this.currentCamera.eye=u$A(S$d,this.currentCamera.eye,this.tmpRayDir),this.currentCamera.center=u$A(S$d,this.currentCamera.center,this.tmpRayDir);}i$q(this.view,this.currentCamera);}}end(){this.active&&this.finishController();}};e$x([d$y({constructOnly:!0})],O$9.prototype,"view",void 0),O$9=e$x([i$H("esri.views.3d.state.controllers.global.ZoomController")],O$9);const S$d=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const j$e=30,w$d=70;let N$c=class extends a$r{constructor(t){super(t),this.view=null,this.tmpP=n$F(),this.tmpDir=n$F(),this.tmpN=n$F(),this.tmpP0=n$Q(),this.tmpPoi=n$F(),this.tmpRayDir=n$F(),this.dragBeginPoint=i$S(),this.normalizedAnchorPoint=n$Q(),this.constraintOptions={selection:15,interactionType:1,interactionFactor:0,interactionStartCamera:null,interactionDirection:n$F(),tiltMode:0},this.plane=p$S();}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(t){if(!this.active)return;let i;a$Y(this.dragBeginPoint,t),K$9(this.startCamera,t,this.normalizedAnchorPoint),this.intersectionHelper.intersectScreenFreePointFallback(t,this.tmpP),c$O(this.tmpDir,this.tmpP,this.startCamera.eye),j$p(this.tmpDir,this.tmpDir),this.view.camera.position.hasZ&&(i=Math.abs(this.view.camera.position.z));let s=j$e*i;const r=this.view._stage.renderView.getMinimalDepthForArea(t[0],t[1],this.view.state.camera,w$d);s=s>r?r:s,d$z(this.tmpDir,this.tmpDir,s),u$A(this.tmpP,this.startCamera.eye,this.tmpDir),c$O(this.tmpN,this.startCamera.eye,this.startCamera.center),j$p(this.tmpN,this.tmpN),this.tmpN[1]<0&&v$r(this.tmpN,this.tmpN),v$u(this.tmpP,this.tmpN,this.plane),this.constraintOptions.interactionStartCamera=this.startCamera;}update(t){if(!this.active)return;Q$7(this.plane,this.currentCamera,this.dragBeginPoint,this.tmpPoi)||r$B(this.tmpPoi,this.currentCamera.center),K$9(this.currentCamera,t,this.tmpP0);let i=4*(this.tmpP0[1]-this.normalizedAnchorPoint[1]);a$Y(this.normalizedAnchorPoint,this.tmpP0),c$O(this.tmpRayDir,this.tmpPoi,this.currentCamera.eye);const s=s$x(this.tmpRayDir);let r=s*(1-i);r$B(this.constraintOptions.interactionDirection,this.tmpRayDir),d$z(this.constraintOptions.interactionDirection,this.constraintOptions.interactionDirection,Math.sign(i)/s);const a=this.view.state.constraints.minimumPoiDistance;i>=0&&r<a&&(r=a,i=-(r-s)/s),Math.abs(s-r)<1e-6||(d$z(this.tmpRayDir,this.tmpRayDir,i),this.currentCamera.eye=u$A(O$8,this.currentCamera.eye,this.tmpRayDir),y$v(O$8,this.currentCamera.center,this.tmpPoi,i),this.tmpPoi[2]>this.startCamera.center[2]?O$8[2]=Math.max(this.startCamera.center[2],O$8[2]):O$8[2]=Math.min(this.startCamera.center[2],O$8[2]),this.currentCamera.center=O$8,this.constraintOptions.interactionFactor=f$j(this.dragBeginPoint,t),p$n(this.view,this.currentCamera,this.constraintOptions));}end(){this.active&&this.finishController();}};e$x([d$y({constructOnly:!0})],N$c.prototype,"view",void 0),N$c=e$x([i$H("esri.views.3d.state.controllers.local.ZoomController")],N$c);const O$8=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class s$i extends i$T{constructor(r,t,e){super(!0),this.view=r,this.pointerAction=t,this.registerIncoming("drag",e,(r=>this.handleDrag(r)));}handleDrag(o){const s=o.data;if(s.pointers.size>1)return;if(!r$T(o.data,this.pointerAction))return;const i=i$S(s.center.x,s.center.y);switch(s.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.view.state.isGlobal?this.cameraController=new O$9({view:this.view}):this.cameraController=new N$c({view:this.view}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(i);break;case"update":this.cameraController&&this.cameraController.update(i);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null);}o.stopPropagation();}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let K$8=class extends a$r{constructor(t){super(t),this.transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this.keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this.tmpCamera=new J$d,this.constraintOptions={selection:15,interactionType:0,interactionStartCamera:new J$d,interactionFactor:0,interactionDirection:null,tiltMode:1};}handleEventGamepad(t){const e=i$U(t,this.view.navigation.gamepad,this.transformation);("end"===t.action||s$I(e))&&this.finishController();}activateDirection(t){this.keysButtonState[t]=1,o$K(this.keysButtonState,this.transformation);}deactivateDirection(t){this.keysButtonState[t]=0;const e=o$K(this.keysButtonState,this.transformation);s$I(e)&&this.finishController();}onControllerStart(t){this.filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this.headingStart=this.view.camera.heading,super.onControllerStart(t);}updateFilteredSurfaceElevation(t){const e=this.view.pointsOfInterest.cameraOnSurface.location.z,i=1;this.filteredSurfaceElevation+=i*(e-this.filteredSurfaceElevation)*t;}stepController(t,e){this.updateStartHeading(),this.updateFilteredSurfaceElevation(t),this.currentCamera.copyViewFrom(e),this.updateCameraCenter(),this.constraintOptions.interactionStartCamera.copyFrom(this.currentCamera),this.calculateControlTransformation(t,this.currentCamera,Y$6),this.applyDisabledMovementTypes(Y$6),this.applyPan(Y$6.pan),this.applyRotate(Y$6.rotate),this.applyZoom(Y$6.zoom),this.applyAscend(Y$6.ascend),this.constraintOptions.interactionType=0,this.constraintOptions.selection=8,p$n(this.view,this.currentCamera,this.constraintOptions),super.stepController(t,e);}updateStartHeading(){0!==this.transformation.heading&&(this.headingStart=this.view.camera.heading);}applyRotate(t){if(!t.enabled)return;const e=this.currentCamera;c$O($$6,e.center,e.eye),I$g($$6,$$6,t.matrix),e.center=u$A($$6,$$6,e.eye),e.up=I$g($$6,e.up,t.matrix),this.constraintOptions.interactionType=3,this.constraintOptions.selection=7,p$n(this.view,e,this.constraintOptions);}applyPan(t,e=this.currentCamera){if(!t.enabled)return;e.eye=I$g($$6,e.eye,t.matrix),e.center=I$g($$6,e.center,t.matrix);this.view.state.isGlobal&&(e.up=I$g($$6,e.up,t.matrix)),this.constraintOptions.interactionType=4,this.constraintOptions.selection=15,p$n(this.view,e,this.constraintOptions);}applyZoom(t){if(!t)return;const e=this.currentCamera.viewForward;this.currentCamera.eye=u$A($$6,this.currentCamera.eye,d$z(c$T.get(),e,t)),r$B(tt$2,e),v$r(tt$2,tt$2),this.constraintOptions.interactionDirection=tt$2,this.constraintOptions.interactionType=1,this.constraintOptions.selection=7,p$n(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null;}applyAscend(t){if(!t)return;const e=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,c$T.get());this.constraintOptions.interactionDirection=r$B(tt$2,e);if(this.view.state.isGlobal){const e=s$x(this.currentCamera.eye),i=(e+t)/e;this.currentCamera.eye=d$z($$6,this.currentCamera.eye,i),this.currentCamera.center=d$z($$6,this.currentCamera.center,i);}else {const i=d$z(c$T.get(),e,t);this.currentCamera.eye=u$A($$6,this.currentCamera.eye,i),this.currentCamera.center=u$A($$6,this.currentCamera.center,i);}this.updateCameraCenter(),this.constraintOptions.interactionType=5,this.constraintOptions.selection=8,p$n(this.view,this.currentCamera,this.constraintOptions)&&this.updateCameraCenter(),this.constraintOptions.selection=7,p$n(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null;}calculateControlTransformation(t,e,i){it$1(i);const a=this.computeVelocities(t);this.view.state.isLocal?this.calculateControlTransformationLocal(a,e,i):this.calculateControlTransformationGlobal(a,e,i);}updateCameraCenter(){const t=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,e=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=e.intersectManifoldClosestSilhouette(i,t,$$6);}calculateControlTransformationLocal(t,a,r){const{viewRight:o,viewForward:s}=a,n=this.transformation,l=this.view.navigation.gamepad,p=o$C(c$T.get(),s[0],s[1],0);j$p(p,p);const h=n.translation[0]*t.pan;if(0!==h){const t=d$z(c$T.get(),o,h);c$U(r.pan.matrix,r.pan.matrix,t),r.pan.enabled=!0;}switch(l.mode){case"pan":{const e=-n.translation[1]*t.pan;if(0!==e){const t=d$z(c$T.get(),p,e);c$U(r.pan.matrix,r.pan.matrix,t),r.pan.enabled=!0;}r.zoom=n.zoom*t.zoom;break}case"zoom":r.zoom=(-n.translation[1]+n.zoom)*t.zoom;break;}const d=n.translation[2]*t.ascend;r.ascend=d;const u=-n.heading*t.rotate;0!==u&&(f$s(r.rotate.matrix,r.rotate.matrix,u,this.view.renderCoordsHelper.worldUpAtPosition(a.eye,c$T.get())),r.rotate.enabled=!0);const v=n.tilt*t.rotate,C=n$r(this.view.renderCoordsHelper,a.center,a.eye),g=e$B(C+v,d$t.min,d$t.max)-C;g&&(f$s(r.rotate.matrix,r.rotate.matrix,g,o),r.rotate.enabled=!0);}calculateControlTransformationGlobal(t,e,i){const{eye:a,viewRight:r}=e,o=this.transformation,s=this.view.navigation.gamepad,n=_$f(c$T.get(),r,a);j$p(n,n),v$r(n,n),wt(this.startCamera,e,o,t,this.view.camera.heading,this.headingStart,this.view.camera.tilt,i,s),this.tmpCamera.copyFrom(this.currentCamera),this.applyPan(Y$6.pan,this.tmpCamera);const c=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,l=o.translation[2]*t.ascend;i.ascend=l;const p=-o.heading*t.rotate;0!==p&&(f$s(i.rotate.matrix,i.rotate.matrix,p,this.tmpCamera.eye),i.rotate.enabled=!0);const h=o.tilt*t.rotate,d=this.clampTiltDeltaGlobalToValidRange(h,e.ray,c);0!==d&&(f$s(i.rotate.matrix,i.rotate.matrix,d,this.tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=o.zoom*t.zoom;}clampTiltDeltaGlobalToValidRange(t,e,r){const o=p$K(this.view.spatialReference),s=tt$3(d$t.min,e.origin,r,o);let n=0,c=0;const m=c$T.get();if(this.view.renderCoordsHelper.intersectManifold(e,r,m)){const t=n$r(this.view.renderCoordsHelper,m,e.origin);n=tt$3(t,e.origin,r,o),c=tt$3(d$t.max,e.origin,r,o);}else {F$f(k$m(r+o.radius),e,m);const t=l$B(-z$i(e.direction,j$p(m,m)));n=et$2(t,e.origin,r,o),c=et$2(d$t.max,e.origin,r,o);}return e$B(n+t,s,c)-n}getPointAbsoluteSurfaceElevation(t,e,i){const{renderCoordsHelper:a}=this.view,r=a.getAltitude(t),o=e+Math.abs(r-e);return a.setAltitude(i,o,t),o}clampedDistanceToSurface(t,e){const{renderCoordsHelper:i}=this.view,{camera:a}=this.view.state,{direction:r}=B$e(this.view,e,0,X$4,et$1),o=i.intersectManifoldClosestSilhouette(j$r(e,r),t,c$T.get()),s=q$g(e,o),n=i.intersectManifoldClosestSilhouette(j$r(e,H$j(c$T.get(),e,a.center)),t,c$T.get()),c=q$g(e,n);return Math.min(s,c)}computeHeadingRotateRadius(t){const{renderCoordsHelper:e,state:i}=this.view,{camera:r,isGlobal:o}=i,s=e.intersectManifoldClosestSilhouette(r.ray,this.filteredSurfaceElevation,c$T.get());if(o){const e=c$O(c$T.get(),t,s),i=s$x(e);d$z(e,e,1/i);const r=j$p(c$T.get(),t),o=l$B(z$i(r,e));return i*Math.sin(Math.min(_$9,o))}{const i=r$B(c$T.get(),t);return e.setAltitude(i,this.filteredSurfaceElevation),q$g(s,i)}}minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:N$b}computeVelocities(t){const e=this.filteredSurfaceElevation,a=e+p$K(this.view.spatialReference).radius,{camera:r,isGlobal:o}=this.view.state,s=c$T.get(),n=this.getPointAbsoluteSurfaceElevation(r.eye,e,s),c=this.clampedDistanceToSurface(e,s),m=r.width/2,l=J$8*r.width,p=J$8*r.width,h=c*Math.tan(.5*r.fovX)/m,d=h/a,u=h/this.computeHeadingRotateRadius(s),f=n-e;return {pan:(o?d:h)*l*t,ascend:Math.max(this.minimumAscendVelocity()*t,2**(l*t/m)*f-f),zoom:2**(l*t/m)*c-c,rotate:e$B(u*p,Q$6,W$7)*t}}applyDisabledMovementTypes(t){!r$A(this.disableMovements)||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(t.zoom=this.disableMovements.zoom?0:t.zoom,t.ascend=this.disableMovements.ascend?0:t.ascend,t.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&r$C(t.pan.matrix),t.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&r$C(t.rotate.matrix));}static activatesFor(t,e){const i=i$U(e,t.navigation.gamepad,Z$4);return !("end"===e.action||s$I(i))}};e$x([d$y({constructOnly:!0})],K$8.prototype,"view",void 0),e$x([d$y({constructOnly:!0})],K$8.prototype,"gamepadDevice",void 0),e$x([d$y({constructOnly:!0})],K$8.prototype,"disableMovements",void 0),K$8=e$x([i$H("esri.views.3d.state.controllers.GamepadKeyboardController")],K$8);const Z$4={translation:[0,0,0],heading:0,tilt:0,zoom:0},X$4=80,_$9=M$f(X$4),J$8=.75,N$b=5,Q$6=M$f(30),W$7=M$f(80),Y$6={zoom:0,ascend:0,pan:{enabled:!1,matrix:e$y()},rotate:{enabled:!1,matrix:e$y()}},$$6=n$F(),tt$2=n$F(),et$1=h$r();function it$1(t){t.zoom=0,t.ascend=0,t.pan.enabled=!1,r$C(t.pan.matrix),t.rotate.enabled=!1,r$C(t.rotate.matrix);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class i$k extends i$T{constructor(e){super(!0),this.view=e,this.watchHandles=new u$D,this.handle=this.registerIncoming("gamepad",(a=>this.handleEventGamepad(a))),this.handle.pause();}onInstall(a){super.onInstall(a),this.watchHandles.add([i$P(this.view.navigation.gamepad,"enabled",(a=>{a?this.handle.resume():(this.handle.pause(),this.cameraControllerGamepad&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null));})),this.view.navigation.gamepad.watch("device",(a=>{this.cameraControllerGamepad&&a&&this.cameraControllerGamepad.gamepadDevice!==a&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null);}))]);}onUninstall(){this.watchHandles.removeAll(),super.onUninstall();}handleEventGamepad(a){const e=this.view.navigation.gamepad.device;if(e&&a.data.device!==e)return;const r=this.cameraControllerGamepad&&this.cameraControllerGamepad.active;if(r||K$8.activatesFor(this.view,a.data)){if(!r){const e=new K$8({view:this.view,gamepadDevice:a.data.device});this.view.state.switchCameraController(e)&&(this.cameraControllerGamepad=e);}this.cameraControllerGamepad&&this.cameraControllerGamepad.active&&this.cameraControllerGamepad.gamepadDevice===a.data.device&&this.cameraControllerGamepad.handleEventGamepad(a.data);}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class r$n extends i$T{constructor(e,t){super(!0),this.view=e,this.disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:2},this.keyToNumber={[t.left]:0,[t.right]:1,[t.forward]:2,[t.backward]:3,[t.up]:4,[t.down]:5,[t.headingLeft]:6,[t.headingRight]:7,[t.tiltUp]:8,[t.tiltDown]:9,[t.zoomIn]:10,[t.zoomOut]:11},this.registerIncoming("key-down",null,(e=>this.handleKeyDown(e))),this.registerIncoming("key-up",null,(e=>this.handleKeyUp(e))),this.registerIncoming("blur",null,(()=>this.handleBlur()));}handleKeyDown(t){if(t.data.native.ctrlKey||t.data.native.metaKey)return;const r=this.keyToNumber[t.data.key];null!=r&&(this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active||(this.cameraControllerKeyboard=new K$8({view:this.view,disableMovements:this.disableMovements}),this.view.state.switchCameraController(this.cameraControllerKeyboard)),this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.activateDirection(r),t.stopPropagation()));}handleBlur(){this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.finishController(),this.cameraControllerKeyboard=null);}handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this.keyToNumber[e.data.key];null!=t&&this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.deactivateDirection(t),e.stopPropagation());}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class i$j extends i$T{constructor(e,t){super(!0),this.view=e,this.registerIncoming("mouse-wheel",t,(e=>this.handleMouseWheel(e)));}handleMouseWheel(r){if(!this.view.navigation.mouseWheelZoomEnabled)return;const i=r.data;this.cameraController&&this.cameraController.active||(this.cameraController=this.view.state.isGlobal?new O$b({view:this.view,mode:"interaction"}):new d$l({view:this.view,mode:"interaction"}),this.view.state.switchCameraController(this.cameraController)),this.cameraController.zoomStep(-1/60*i.deltaY,i$S(i.x,i.y)),r.preventDefault(),r.stopPropagation();}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class t$t{constructor(t){this._gain=t;}reset(t){this._value=t;}set gain(t){this._gain=t;}get value(){return void 0===this._value?0:this._value}update(t){void 0===this._value?this._value=t:this._value=this._gain*t+(1-this._gain)*this._value;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let a$p=class extends a$s{constructor(t){super(t),this.view=null,this.beginCamera=new J$d,this.elapsedTimeSec=0,this.constraintOptions={selection:15,interactionType:4,interactionFactor:0,interactionStartCamera:new J$d,interactionDirection:null,tiltMode:0};}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new n$X;}get steppingFinished(){return this.momentum.isFinished(this.elapsedTimeSec)}onControllerStart(t){this.beginCamera.copyFrom(t),this.constraintOptions.interactionStartCamera=this.beginCamera,super.onControllerStart(t);}stepController(t,e){e.copyViewFrom(this.beginCamera),this.elapsedTimeSec+=t,this.momentumStep(this.elapsedTimeSec,e),p$n(this.view,e,this.constraintOptions);}};e$x([d$y({constructOnly:!0})],a$p.prototype,"view",void 0),a$p=e$x([i$H("esri.views.3d.state.controllers.momentum.MomentumController")],a$p);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let c$p=class extends a$p{constructor(t){super(t),this.interactionType=4,this.tmpPan=n$F();}momentumStep(t,o){const r=this.momentum.value(t);d$z(this.tmpPan,this.momentum.direction,r),o.eye=c$O(i$i,o.eye,this.tmpPan),o.center=c$O(i$i,o.center,this.tmpPan),this.constraintOptions.interactionDirection=this.tmpPan;}};e$x([d$y({constructOnly:!0})],c$p.prototype,"momentum",void 0),c$p=e$x([i$H("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],c$p);const i$i=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const a$o=n$F(),p$k=n$F();let u$p=class extends a$p{constructor(o){super(o),this.interactionType=4;}momentumStep(o,s){const t=this.momentum.value1(o),i=this.momentum.value2(o);r$B(p$k,s.eye),j$p(p$k,p$k),_$f(this.momentum.axis2,p$k,this.momentum.axis1),jt(s,a$o,this.momentum.axis1,t,this.momentum.axis2,i);}};e$x([d$y({constructOnly:!0})],u$p.prototype,"momentum",void 0),u$p=e$x([i$H("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],u$p);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let i$h=class extends a$p{constructor(t){super(t),this.interactionType=2;}set center(t){this._set("center",t$G(t));}set axis(t){this._set("axis",t$G(t));}momentumStep(t,o){const r=this.momentum.value(t);O$c(o,this.center,m$r(this.axis,r));}};e$x([d$y({constructOnly:!0})],i$h.prototype,"momentum",void 0),e$x([d$y({constructOnly:!0})],i$h.prototype,"center",null),e$x([d$y({constructOnly:!0})],i$h.prototype,"axis",null),i$h=e$x([i$H("esri.views.3d.state.controllers.momentum.MomentumController")],i$h);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let a$n=class extends a$p{constructor(t){super(t),this.interactionType=1,this.constraintOptions.interactionDirection=n$F();}set zoomCenter(t){this._set("zoomCenter",t$G(t));}momentumStep(t,o){r$B(this.constraintOptions.interactionDirection,o.eye);const r=this.momentum.valueDelta(0,t);X$5(o,this.zoomCenter,r,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionDirection=H$j(this.constraintOptions.interactionDirection,o.eye,this.constraintOptions.interactionDirection);}};e$x([d$y({constructOnly:!0})],a$n.prototype,"momentum",void 0),e$x([d$y({constructOnly:!0})],a$n.prototype,"zoomCenter",null),a$n=e$x([i$H("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],a$n);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let y$h=class extends a$p{constructor(t){super(t),this.interactionType=1,this.radius=0,this.tmpSceneCenter=n$F(),this.tmpZoomAxisAngle=i$u(),this.sphere=P$m();}set screenCenter(t){this._set("screenCenter",i$S(t[0],t[1]));}set sceneCenter(t){this._set("sceneCenter",t$G(t));}initialize(){this.sphere[3]=this.radius;}momentumStep(t,e){const s=this.momentum.valueDelta(0,t);Y$7(this.sphere,e,s),this.constraintOptions.interactionType=1,p$n(this.view,e,this.constraintOptions),ut$1(this.sphere,e,this.screenCenter,this.tmpSceneCenter),k$g(this.sceneCenter,this.tmpSceneCenter,this.tmpZoomAxisAngle),O$c(e,this.sphere,this.tmpZoomAxisAngle),this.constraintOptions.interactionType=4;}};e$x([d$y({constructOnly:!0})],y$h.prototype,"momentum",void 0),e$x([d$y({constructOnly:!0})],y$h.prototype,"screenCenter",null),e$x([d$y({constructOnly:!0})],y$h.prototype,"sceneCenter",null),e$x([d$y({constructOnly:!0})],y$h.prototype,"radius",void 0),y$h=e$x([i$H("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],y$h);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class e$p{constructor(e){this.gain=e;}update(e){this.hasFilteredValue?this.filteredValue=(1-this.gain)*this.filteredValue+this.gain*e:this.filteredValue=e;}reset(){this.filteredValue=void 0;}get hasFilteredValue(){return void 0!==this.filteredValue}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const u$o=1e-5;class c$o extends t$X{constructor(t,e,i,s,a,h=0,n){super(t,e,i),this.angularVelocity1=s,this.axis1=a,this.angularVelocity2=h,this.axis2=n;}value1(t){return super.valueFromInitialVelocity(this.angularVelocity1,t)}value2(t){return super.valueFromInitialVelocity(this.angularVelocity2,t)}}class o$o{constructor(e=300,i=12,s=.84){this.minimumInitialVelocity=e,this.stopVelocity=i,this.friction=s,this.enabled=!0,this.tmpAxis1=n$F(),this.tmpAxis2=n$F(),this.tmpAngles=n$Q(),this.time=new t$W(.3),this.screen=[new t$W(.4),new t$W(.4)],this.angle1=new e$p(.6),this.angle2=new e$p(.6),this.axis1=n$F(),this.axis2=n$F(),this.lastScene=n$F();}addMomentumDirectRotation(t,a,n,l,r,m){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(n)<.01)return;let t=ht$1(this.lastScene,a,this.tmpAxis2,l,r,m);this.angle2.update(0),p$Q(this.tmpAxis2)<u$o?t=0:j$p(this.axis1,this.tmpAxis2),this.angle1.update(t),r$B(this.lastScene,a);}this.screen[0].update(t[0]),this.screen[1].update(t[1]),this.time.update(n);}}addMomentumPreserveHeading(t,a,h,l,r,m,c){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(h)<.01)return;bt$1(this.lastScene,a,this.tmpAxis2,this.tmpAxis1,this.tmpAngles,l,r,m,c,!1),p$Q(this.tmpAxis2)<u$o?(this.angle1.update(0),this.angle2.update(0)):(this.angle1.update(this.tmpAngles[1]),this.angle2.update(this.tmpAngles[0]),j$p(this.axis1,this.tmpAxis1),j$p(this.axis2,this.tmpAxis2)),r$B(this.lastScene,a);}this.screen[0].update(t[0]),this.screen[1].update(t[1]),this.time.update(h);}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.angle1.reset(),this.angle2.reset(),this.time.reset();}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const t=this.screen[0].filteredDelta,e=this.screen[1].filteredDelta,i=Math.sqrt(t*t+e*e)/this.time.filteredDelta;return Math.abs(i)<this.minimumInitialVelocity?null:this.createMomentum(i,this.stopVelocity,this.friction)}createMomentum(t,e,i){const s=this.angle1.filteredValue/this.time.filteredDelta,a=this.angle2.filteredValue/this.time.filteredDelta;return new c$o(t,e,i,s,this.axis1,a,this.axis2)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let Y$5=class extends a$r{constructor(t){super(t),this.view=null,this.smoothRotation=new t$t(.05),this.rotationAxis=n$F(),this.panningPlane=p$S(),this.smoothScaling=new t$t(.05),this.zoomCenterScreen=i$S(),this.zoomMomentumEstimator=new s$J,this.rotationMomentumEstimator=new a$Z,this.panSphericalMomentumEstimator=new o$o,this.panPlanarMomentumEstimator=new h$z,this.adjustedSphere=P$m(),this.tmp3d=n$F(),this.tmpScreenPointArray=i$S(),this.beginScreenPoint=i$S(),this.beginScenePoint=n$F(),this.screenPickPoint=i$S(),this.navMode=nt$2.Horizontal,this.tmpInteractionDirection=n$F(),this.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new J$d,interactionDirection:null,tiltMode:0};}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(t){if(!this.active)return;const e=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=e,this.rotationMomentumEstimator.enabled=e,this.panPlanarMomentumEstimator.enabled=e,this.panSphericalMomentumEstimator.enabled=e,this.beginHeading=-S$p.normalize(M$f(this.view.camera.heading)),this.beginRadius=t.radius,this.pointerCount=t.pointers.size,this.beginAngle=t.angle,this.smoothRotation.reset(),d$H(t.center,this.screenPickPoint),a$Y(this.beginScreenPoint,this.screenPickPoint);const s=p$K(this.view.spatialReference),o=st$1(this.intersectionHelper,this.startCamera,this.screenPickPoint,!0,s);this.scenePickPoint=o.scenePickPoint,this.sphere=o.sphere,r$B(this.beginScenePoint,this.scenePickPoint),this.navMode=it$2(this.startCamera,this.screenPickPoint,o.hasGeometryIntersection,s),this.navMode===nt$2.Vertical&&this.preparePlanarPanMode(t),this.constraintOptions.interactionStartCamera.copyFrom(this.startCamera);}preparePlanarPanMode(t){const i=v$r(this.tmp3d,this.startCamera.viewForward);v$u(this.scenePickPoint,i,this.panningPlane);const o=i$S(this.screenPickPoint[0],0),r=n$F(),a=s$x(this.startCamera.eye);this.adjustedSphere[3]=a<this.sphere[3]?a-100:this.sphere[3],ut$1(this.adjustedSphere,this.startCamera,o,r);const v=x$r();this.startCamera.projectToRenderScreen(r,v);const C=.9*v[1];if(this.screenPickPoint[1]=Math.min(this.screenPickPoint[1],C),this.intersectionHelper.intersectScreen(this.screenPickPoint,this.scenePickPoint)&&v$u(this.scenePickPoint,W$b(this.panningPlane),this.panningPlane),!r$S()){const t=n$F(),i=n$F(),e=n$F(),n=80,s=5,o=50;c$O(t,this.scenePickPoint,this.currentCamera.eye),j$p(t,t);const r=s*Math.max(Math.abs(this.view.camera.position.z),o),a=this.view._stage.renderView.getMinimalDepthForArea(this.screenPickPoint[0],this.screenPickPoint[1],this.view.state.camera,n),m=a?Math.min(a,r):r;r$B(e,u$A(i,this.currentCamera.eye,d$z(i,t,m))),this.panningPlane[3]=-z$i(this.panningPlane,e),this.startCamera.center=u$A(i,this.startCamera.eye,d$z(i,this.startCamera.viewForward,m));}const M=d$H(t.center,this.tmpScreenPointArray);Q$7(this.panningPlane,this.startCamera,M,this.beginScenePoint);}update(t){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const i=t.pointers.size>1;this.navMode===nt$2.Horizontal?(i&&this.zoomSpherical(t),this.panningSpherical(t),i&&this.rotateSpherical(t)):(i&&this.zoomPlanar(t),this.panningPlanar(t),i&&this.rotatePlanar(t));}end(t){t.pointers.size===this.pointerCount&&this.update(t),this.finishController();const i=this.zoomMomentumEstimator.evaluateMomentum();if(i)return this.navMode===nt$2.Horizontal?new y$h({view:this.view,momentum:i,screenCenter:this.zoomCenterScreen,sceneCenter:this.beginScenePoint,radius:this.sphere[3]}):new a$n({view:this.view,momentum:i,zoomCenter:this.beginScenePoint});const e=this.rotationMomentumEstimator.evaluateMomentum();if(e)return new i$h({view:this.view,momentum:e,center:this.sphere,axis:this.rotationAxis});if(this.navMode===nt$2.Horizontal){const t=this.panSphericalMomentumEstimator.evaluateMomentum();if(t)return new u$p({view:this.view,momentum:t})}else {const t=this.panPlanarMomentumEstimator.evaluateMomentum();if(t)return new c$p({view:this.view,momentum:t})}return null}zoomSpherical(t){const i=this.beginRadius/t.radius,e=.001875*Math.min(Math.max(t.radius,40),120);this.smoothScaling.gain=e,this.smoothScaling.update(i),Y$7(this.sphere,this.currentCamera,this.smoothScaling.value),d$H(t.center,this.zoomCenterScreen),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*t.timestamp),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=f$j(t.radius-this.beginRadius),p$n(this.view,this.currentCamera,this.constraintOptions);}panningSpherical(t){const i=d$H(t.center,this.tmpScreenPointArray);ut$1(this.sphere,this.currentCamera,i,this.tmp3d),vt(this.beginScenePoint,z$i(this.currentCamera.up,this.beginScenePoint),this.sphere[3],this.beginHeading,this.view.camera.tilt,this.startCamera)?(xt$1(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.beginHeading,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumPreserveHeading(i,this.tmp3d,.001*t.timestamp,this.startCamera,this.sphere,this.beginHeading,this.view.camera.tilt)):(zt(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumDirectRotation(i,this.tmp3d,.001*t.timestamp,this.startCamera,this.sphere[3],this.view.camera.tilt)),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=f$j(this.screenPickPoint,i),p$n(this.view,this.currentCamera,this.constraintOptions);}rotateSpherical(t){j$p(this.rotationAxis,this.scenePickPoint),this.currentCamera.aboveGround||v$r(this.rotationAxis,this.rotationAxis);const i=this.smoothRotation.value,e=i+N$d(t.angle-i),n=.00125*Math.min(Math.max(t.radius,40),120);this.smoothRotation.gain=n,this.smoothRotation.update(e);const s=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(s,.001*t.timestamp),O$c(this.currentCamera,this.sphere,m$r(this.rotationAxis,s)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=f$j(t.radius*e),p$n(this.view,this.currentCamera,this.constraintOptions);}panningPlanar(t){const i=d$H(t.center,this.tmpScreenPointArray);Q$7(this.panningPlane,this.currentCamera,i,this.tmp3d)&&(ct$1(this.currentCamera,this.beginScenePoint,this.tmp3d),this.panPlanarMomentumEstimator.add(i,this.tmp3d,.001*t.timestamp),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=f$j(this.beginScreenPoint,i),this.constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this.tmpInteractionDirection),p$n(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null);}zoomPlanar(t){const i=this.beginRadius/t.radius,e=.001875*Math.min(Math.max(t.radius,40),120);this.smoothScaling.gain=e,this.smoothScaling.update(i),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*t.timestamp),X$5(this.currentCamera,this.beginScenePoint,this.smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=f$j(t.radius-this.beginRadius),p$n(this.view,this.currentCamera,this.constraintOptions);}rotatePlanar(t){r$B(this.rotationAxis,this.beginScenePoint),this.currentCamera.aboveGround||v$r(this.rotationAxis,this.rotationAxis);const i=this.smoothRotation.value;let e=t.angle-i;e=N$d(e);const n=i+e,s=.00125*Math.min(Math.max(t.radius,40),120);this.smoothRotation.gain=s,this.smoothRotation.update(n);const o=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(o,.001*t.timestamp),O$c(this.currentCamera,this.sphere,m$r(this.rotationAxis,o)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=f$j(t.radius*o),p$n(this.view,this.currentCamera,this.constraintOptions);}};e$x([d$y({constructOnly:!0})],Y$5.prototype,"view",void 0),Y$5=e$x([i$H("esri.views.3d.state.controllers.global.PinchAndPanController")],Y$5);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const k$9=r$D(0,0,1),I$8={ELEVATION_THRESHOLD:3e4,ANGLE_THRESHOLD:16/180*Math.PI},G$7=80;let N$a=class extends a$r{constructor(t){super(t),this.view=null,this.rotationValueSmooth=new t$t(.05),this.scalingValueSmooth=new t$t(.05),this.planeHorizontal=p$S(),this.planeVertical=p$S(),this.rotationMomentumEstimator=new a$Z,this.panMomentumEstimator=new h$z(300,12,.9),this.zoomMomentumEstimator=new s$J,this.beginCenter=n$F(),this.tmpPoints=[],this.beginCenterScreen=i$S(),this.tmpCentroid3d=n$F(),this.tmpCentroid2d=i$S(),this.tmp2d=i$S(),this.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new J$d,interactionDirection:null,tiltMode:0};}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(t){if(!this.active)return;const e=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=e,this.rotationMomentumEstimator.enabled=e,this.panMomentumEstimator.enabled=e,this.beginRadius=t.radius,this.pointerCount=t.pointers.size,this.beginAngle=t.angle,this.rotationValueSmooth.reset(),this.scalingValueSmooth.reset(),d$H(t.center,this.beginCenterScreen),k$n(k$9,0,this.planeHorizontal);const o=n$F();this.intersectionHelper.intersectScreenFreePointFallback(this.beginCenterScreen,o);const s=n$F();v$r(s,this.startCamera.viewForward);const d=n$F();r$B(d,k$9);const C=z$i(s,d),g=b$l(C<0?-C:C);if(this.panMode=g>=I$8.ANGLE_THRESHOLD?nt$2.Horizontal:nt$2.Vertical,z$l(this.planeHorizontal,o,this.planeHorizontal),this.startCamera.aboveGround||A$m(this.planeHorizontal,this.planeHorizontal),this.panMode===nt$2.Vertical){if(d$z(d,d,C),c$O(this.planeVertical,s,d),j$p(this.planeVertical,this.planeVertical),z$l(this.planeVertical,o,this.planeVertical),!r$S()){const t=n$F(),i=n$F(),e=n$F();c$O(t,o,this.currentCamera.eye),j$p(t,t);const n=5*Math.max(Math.abs(this.view.camera.position.z),50),s=this.view._stage.renderView.getMinimalDepthForArea(this.beginCenterScreen[0],this.beginCenterScreen[1],this.view.state.camera,G$7),r=s?Math.min(s,n):n;r$B(e,u$A(i,this.currentCamera.eye,d$z(i,t,r))),this.planeVertical[3]=-z$i(this.planeVertical,e);}this.computePlanePoints(t.pointers,this.planeVertical,this.startCamera,this.tmpPoints),_$a(this.tmpPoints,this.beginCenter);}else this.computePlanePoints(t.pointers,this.planeHorizontal,this.startCamera,this.tmpPoints),_$a(this.tmpPoints,this.beginCenter);this.constraintOptions.interactionStartCamera.copyFrom(this.startCamera);}update(t){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const i=t.pointers.size>1,e=this.panMode===nt$2.Horizontal?this.planeHorizontal:this.planeVertical,o=this.beginCenter;if(i){const i=this.beginRadius/t.radius,e=.001875*Math.min(Math.max(t.radius,40),120);this.scalingValueSmooth.gain=e,this.scalingValueSmooth.update(i),X$5(this.currentCamera,o,this.scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this.zoomMomentumEstimator.add(this.scalingValueSmooth.value,.001*t.timestamp),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=f$j(Math.abs(t.radius-this.beginRadius)),p$n(this.view,this.currentCamera,this.constraintOptions);}if(this.computePlanePoints(t.pointers,e,this.currentCamera,this.tmpPoints),_$a(this.tmpPoints,this.tmpCentroid3d),d$H(t.center,this.tmpCentroid2d),ct$1(this.currentCamera,o,this.tmpCentroid3d),this.panMomentumEstimator.add(this.tmpCentroid2d,this.tmpCentroid3d,.001*t.timestamp),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=f$j(this.beginCenterScreen,this.tmpCentroid2d),p$n(this.view,this.currentCamera,this.constraintOptions),i){const i=this.planeHorizontal,e=o,n=this.rotationValueSmooth.value,s=n+N$d(t.angle-n),r=.00125*Math.min(Math.max(t.radius,40),120);this.rotationValueSmooth.gain=r,this.rotationValueSmooth.update(s);const a=this.rotationValueSmooth.value-this.beginAngle;this.rotationMomentumEstimator.add(a,.001*t.timestamp),O$c(this.currentCamera,e,m$r(i,a)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=f$j(Math.abs(t.radius*a)),p$n(this.view,this.currentCamera,this.constraintOptions);}}end(t){t.pointers.size===this.pointerCount&&this.update(t),this.finishController();const i=this.zoomMomentumEstimator.evaluateMomentum();if(i)return new a$n({view:this.view,momentum:i,zoomCenter:this.beginCenter});const e=this.rotationMomentumEstimator.evaluateMomentum();if(e)return new i$h({view:this.view,momentum:e,center:this.beginCenter,axis:W$b(this.planeHorizontal)});const n=this.panMomentumEstimator.evaluateMomentum();return n?new c$p({view:this.view,momentum:n}):null}computePlanePoints(t,i,e,n){n.length=t.size;const o=this.tmp2d;let s=0;return t.forEach((t=>{o[0]=t.x,o[1]=t.y,void 0===n[s]&&(n[s]=n$F()),Q$7(i,e,o,n[s]),s+=1;})),n}};e$x([d$y({constructOnly:!0})],N$a.prototype,"view",void 0),N$a=e$x([i$H("esri.views.3d.state.controllers.local.PinchAndPanController")],N$a);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class i$g extends i$T{constructor(t,e,s){super(!0),this.view=t,this.pointerAction=e,this.lastEndTimestamp=0,this.lastTimestamp=0,this.registerIncoming("drag",s,(t=>this.handleDrag(t)));}handleDrag(t){if("mouse"===t.data.pointerType&&!r$T(t.data,this.pointerAction))return;const e=t.timestamp-this.lastEndTimestamp,s=40,i=this.momentum&&this.momentum.active&&e<s;switch(t.data.action){case"start":case"update":if(i)break;this.controller&&this.controller.active?t.data.timestamp-this.lastTimestamp>2&&(this.controller.update(t.data),this.lastTimestamp=t.timestamp):this.startController(t);break;case"end":case"removed":this.endController(t,!0);break;case"added":this.endController(t,!1),this.startController(t);}t.stopPropagation();}endController(t,e){if(this.controller&&this.controller.active){this.lastEndTimestamp=t.timestamp;const s=this.controller.end(t.data);e&&s&&(this.momentum=s,this.view.state.switchCameraController(this.momentum));}this.controller=null;}startController(t){this.controller=this.createController(),this.view.state.switchCameraController(this.controller),this.controller.begin(t.data),this.lastTimestamp=t.timestamp;}createController(){return this.view.state.isGlobal?new Y$5({view:this.view}):new N$a({view:this.view})}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class e$o extends i$T{constructor(t,e){super(!0),this.view=t,this.registerIncoming("pointer-down",e,(()=>this.view.state.stopActiveCameraController()));}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class e$n extends i$T{constructor(t,e){super(!0),this.key=t,this.registerIncoming("key-down",e,(t=>this._handleKeyDown(t)));}_handleKeyDown(t){t.data.key===this.key&&(this.activate(),t.stopPropagation());}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class t$s extends e$n{constructor(e,t,i){super(t,i),this.view=e;}activate(){this.view.goTo({heading:0}).catch((()=>{}));}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class e$m extends e$n{constructor(t,e,i){super(e,i),this.view=t;}activate(){this.view.goTo({tilt:0}).catch((()=>{}));}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class a$m extends i$T{constructor(e,t=!1){super(!0),this.view=e,this.invert=t,this.registerIncoming("vertical-two-finger-drag",(e=>this.handleTwoFinger(e)));}handleTwoFinger(r){var a,o,i;const n=this.invert?-1:1,l=i$S(0,r.data.delta*n);switch(r.data.action){case"begin":null==(a=this.cameraController)||a.end(),this.cameraController=new V$9({view:this.view,pivot:0}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(l);break;case"update":null==(o=this.cameraController)||o.update(l);break;case"end":null==(i=this.cameraController)||i.end(),this.cameraController=null;}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class a$l extends i$T{constructor(e=20,a=40){super(!1),this._threshold=e,this._maxDelta=a,this.state="ready",this.emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this.dragEventSeparator=new t$Y({start:(t,e)=>this.observeStart(t,e),update:(t,e,a)=>this.observeUpdate(t,e,a),end:(t,e)=>this.observeEnd(e)}),this.registerIncoming("drag",(t=>this.dragEventSeparator.handle(t)));}get failed(){return "failed"===this.state}observeStart(t,e){1===t&&this.emittedArtificalEnd2&&(this.emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:e.data.button,buttons:e.data.buttons,pointerType:e.data.pointerType,timestamp:e.data.timestamp,pointers:e.data.pointers,pointer:e.data.pointer,angle:e.data.angle,radius:e.data.radius,center:e.data.center}),e.stopPropagation()),this.state=2===t?"ready":"failed";}observeUpdate(t,e,a){if("failed"!==this.state&&2===t)return "active"===this.state?(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void e.stopPropagation()):void(this.checkMovementWithinLimits(e.data,a.data)?this.checkVerticalThresholdReached(e.data,a.data)&&(this.state="active",this.emittedArtificalEnd2=!0,this._thresholdReachedCenter=e.data.center,this._artificalDrag.emit({action:"end",button:e.data.button,buttons:e.data.buttons,pointerType:e.data.pointerType,timestamp:e.data.timestamp,pointers:e.data.pointers,pointer:e.data.pointer,angle:e.data.angle,radius:e.data.radius,center:e.data.center}),this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),e.stopPropagation()):this.state="failed")}observeEnd(t){"active"===this.state&&(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this.state="ready",t.stopPropagation());}checkMovementWithinLimits(t,e){let a=-1/0,i=1/0,r=-1/0,s=1/0;e.pointers.forEach((t=>{a=Math.max(a,t.x),i=Math.min(i,t.x),r=Math.max(r,t.y),s=Math.min(s,t.y);}));let n=-1/0,h=1/0,d=-1/0,o=1/0;t.pointers.forEach((t=>{n=Math.max(n,t.x),h=Math.min(h,t.x),d=Math.max(d,t.y),o=Math.min(o,t.y);}));const c=a-i,l=r-s,p=n-h,m=d-o;return Math.abs(t.center.x-e.center.x)<this._threshold&&Math.abs(p-c)<=this._maxDelta&&Math.abs(m-l)<=this._maxDelta}checkVerticalThresholdReached(t,e){let a=Math.abs(t.center.y-e.center.y);return t.pointers.forEach(((t,i)=>{const r=e.pointers.get(i);a=Math.min(a,Math.abs(t.y-r.y));})),a>=this._threshold}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let z$8=class extends p$N{constructor(){super(...arguments),this._handles=new u$D;}destroy(){this._handles&&(this._handles.removeAll(),this._handles=null),this.disconnect();}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){"pan"!==e&&"rotate"!==e||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode());}get mode(){return this._get("mode")}set mode(e){"default"!==e&&"pro"!==e||e===this._get("mode")||(this._set("mode",e),this._updateMode());}disconnect(){this.view.viewEvents.disconnect(),this._inputManager&&(this._inputManager.destroy(),this._inputManager=null),this._source&&(this._source.destroy(),this._source=null);}connect(){const e=this.view;this._source=new u$E(this.view.surface,e.input);const t=[new n$Y,new o$L,new s$K,new s$L(this.view.navigation),new a$l],r=new d$I({eventSource:this._source,recognizers:t});this._inputManager=r,r.installHandlers("prevent-context-menu",[new e$I],u$F.INTERNAL),this._modeDragPan=new i$g(e,"primary"),this._modeDragRotate=new a$q(e,"secondary",0),this._modeDragZoom=new s$i(e,"tertiary");const n={lookAround:"b",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},resetHeading:"n",resetTilt:"p"};r.installHandlers("navigation",[new e$o(e),new s$j(e),new i$k(e),new r$n(e,n.pan),new i$j(e),new e$m(e,n.resetTilt),new t$s(e,n.resetHeading),new a$q(e,"primary",1,[n.lookAround]),new a$q(e,"secondary",0,[n.lookAround]),new i$g(e,"tertiary",[n.lookAround]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new a$m(e)],u$F.INTERNAL),this.view.viewEvents.connect(r),this._updateMode(),i$P(this.view.navigation,"browserTouchPanEnabled",(e=>{this._source.browserTouchPanningEnabled=!e;}));}_updateMode(){const e=this.mode,t=this.primaryDragAction,r=R$b.get(e).get(t);this._modeDragPan&&(this._modeDragPan.pointerAction=r.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=r.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=r.zoom);}get test(){return {inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}};e$x([d$y()],z$8.prototype,"view",void 0),e$x([d$y({value:"pan"})],z$8.prototype,"primaryDragAction",null),e$x([d$y({value:"default"})],z$8.prototype,"mode",null),e$x([d$y({readOnly:!0,aliasOf:"_inputManager.hasPendingInputs"})],z$8.prototype,"hasPendingInputs",void 0),e$x([d$y({readOnly:!0,aliasOf:"_inputManager.latestPointerType"})],z$8.prototype,"latestPointerType",void 0),e$x([d$y()],z$8.prototype,"_inputManager",void 0),z$8=e$x([i$H("esri.views.3d.input.SceneInputManager")],z$8);const R$b=new Map,T$a=new Map,b$b=new Map;T$a.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),T$a.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),b$b.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),b$b.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),R$b.set("default",T$a),R$b.set("pro",b$b);const k$8=z$8;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let e$l,i$f,n$o=!1,l$j=!1,o$n=!1,s$h=!1,a$k=null;function c$n(t,e){if(!l$j||!i$f)return;u$n();const n=i$f;let o=0;for(let i=0;i<t.accBinsNumX;i++)for(let e=0;e<t.accBinsNumY;e++){const l=t.accBins[i][t.accBinsNumY-1-e];o+=l.length;const s=i*t.accBinsSizeX,a=(i+1)*t.accBinsSizeX,c=e*t.accBinsSizeY,r=(e+1)*t.accBinsSizeY;n.fillText(l.length.toFixed(),s+5,c+15),p$j(s,a,c,r,"blue");}n.fillText("total totalShownLabels: "+o,70,40),n.fillText("total visible labels: "+e.size,70,50),n.fillText("total numTests: "+t.accNumTests,70,30);}function r$m(i){o$n=I$j.DECONFLICTOR_SHOW_VISIBLE,s$h=I$j.DECONFLICTOR_SHOW_INVISIBLE,n$o=o$n||s$h,l$j=I$j.DECONFLICTOR_SHOW_GRID,a$k=null,n$o||l$j?a$k=()=>h$f(i):e$l&&(e$l.parentElement.removeChild(e$l),e$l=null);}function u$n(){a$k&&(a$k(),a$k=null);}function h$f(t){null==e$l&&(e$l=document.createElement("canvas"),e$l.setAttribute("id","canvas2d"),t.surface.parentElement.style.position="relative",t.surface.parentElement.appendChild(e$l));const n=t.width*t.pixelRatio,l=t.height*t.pixelRatio;e$l.setAttribute("width",`${n}px`),e$l.setAttribute("height",`${l}px`),e$l.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${t.width}px;height:${t.height}px`),i$f=e$l.getContext("2d"),i$f.clearRect(0,0,t.width,t.height),i$f.font="12px Arial";}function p$j(t,n,l,o,s){u$n();const a=e$l.height,c=i$f;c.beginPath(),c.lineWidth=1,c.strokeStyle=s,c.moveTo(t,a-l),c.lineTo(n,a-l),c.stroke(),c.lineTo(n,a-o),c.stroke(),c.lineTo(n,a-l),c.stroke(),c.lineTo(t,a-l),c.stroke(),c.lineTo(t,a-l),c.stroke(),c.closePath();}function f$f(t,e){n$o&&(e&&o$n||!e&&s$h)&&p$j(t.aabr[0],t.aabr[2],t.aabr[1],t.aabr[3],e?"green":"red");}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const W$6=n$F(),U$5=n$P(),H$7=n$P(),L$9=n$F(),Z$3=e$y(),q$6=P$m(),J$7=d$G(),K$7=n$F(),Q$5=u$B();class $$5{constructor(){this.aabr=u$B(),this.distance=0,this.culled=!1,this.visible=!1;}}class ii{constructor(i,t,s={}){this.graphics3DGraphic=i,this.slicePlaneEnabled=t,this.info=s;}}class ti{constructor(){this.active=new Map,this.visible=new Map;}clear(){this.active.clear(),this.visible.clear();}}class si{}class ei{constructor(){this.sortArray=new n$Z({allocator:i=>i||new si});}}class ri{constructor(){this.camera=new J$d,this.slicePlane=G$h(),this.slicePlaneEnabled=!1;}copyFrom(i){this.camera.copyFrom(i.camera),D$i(i.slicePlane,this.slicePlane),this.slicePlaneEnabled=i.slicePlaneEnabled;}}let ai=class extends p$N{constructor(){super(...arguments),this._dirty=!1,this._runningViewState=new ri,this._state=0,this.graphics=new ti,this.iterators=new ei,this.accBinsNumX=15,this.accBinsNumY=20,this.accBinsSizeX=0,this.accBinsSizeY=0,this.accBins=null,this.accNumTests=0;}get dirty(){return this._dirty}get state(){return this._state}destroy(){this.graphics.clear(),this.iterators=null;}setDirty(){!this._dirty&&this.graphics.active.size>0&&(this._dirty=!0,this.notifyChange("updating"));}get updating(){return 0!==this._state||this._dirty}get updatingProgress(){if(!this.updating)return 1;const i=this._state/4;return this._dirty?.5*i:i}get running(){return this.view.ready&&null!=this.view.state&&this.updating}runTask(i){switch(this._state){case 0:this.startUpdate(),i.madeProgress();case 1:if(this._state=1,!this.processActiveGraphics(i))return;case 2:if(this._state=2,!this.sortVisibleGraphics(i))return;case 3:if(this._state=3,!this.deconflictVisibleGraphics(i))return;default:c$n(this,this.graphics.visible),this._state=0,this.notifyChange("updating");}}modifyGraphics(i,t){t?i.forEach((i=>this.addToActiveGraphics(i))):i.forEach((i=>this.removeFromActiveGraphics(i))),this.setDirty();}layerSupportsDeconfliction(i){if(t$F(i)||"object3d"!==i.type)return !1;const t=i.stageObject;if(1!==(t?t.geometryRecords.length:0))return !1;return t.geometryRecords[0].material instanceof W$c}startUpdate(){r$m(this.view),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);const{fullWidth:i,fullHeight:t}=this._runningViewState.camera;this.initBins(i,t),this.resetIterators();}addToActiveGraphics(i){i.info[this.visibilityGroup]=new $$5,this.graphics.active.set(i.graphics3DGraphic.graphic.uid,i),this.setDirty();}removeFromActiveGraphics(i){this.removeFromVisibleGraphics(i),oi(i,this.visibilityGroup),delete i.info[this.visibilityGroup],this.graphics.active.delete(i.graphics3DGraphic.graphic.uid),this.setDirty();}addToVisibleGraphics(i){this.graphics.visible.set(i.graphics3DGraphic.graphic.uid,i);}removeFromVisibleGraphics(i){this.graphics.visible.delete(i.graphics3DGraphic.graphic.uid);}processActiveGraphics(i){const t=this.ensureActiveGraphicsIterator(),s=h$x(Z$3,this._runningViewState.camera.projectionMatrix),e="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this._runningViewState.camera.relativeElevation>0?q$6:null;let a=0;for(r$A(e)&&(I$g(e,f$y,this._runningViewState.camera.viewMatrix),e[3]=p$K(this.view.spatialReference).radius,a=I$k(e,f$y));!i.done;){i.madeProgress();const r=t.next();if(r.done)return this.resetActiveGraphicsIterator(),!0;const o=r.value,c=o&&o.info[this.visibilityGroup];c&&(this.collectGraphics3DGraphics(o,s,e,a),c.culled?this.removeFromVisibleGraphics(o):this.addToVisibleGraphics(o));}return !1}sortVisibleGraphics(i){const t=this.ensureSortGraphicsIterator();for(;!i.done;){const s=t.next();if(i.madeProgress(),s.done)return this.resetSortGraphicsIterator(),!0}return !1}deconflictVisibleGraphics(i){const t=this.ensureVisibleGraphicsIterator(),s=1===this.visibilityGroup;for(;!i.done;){i.madeProgress();const e=t.next();if(e.done)return this.resetVisibleGraphicsIterator(),!0;const r=e.value,a=r.info[this.visibilityGroup];if(!a||a.culled)continue;const o=r.graphics3DGraphic,c=(!s||o.isVisible())&&!this.isConflicted(r);c&&this.addToBins(r),a.visible=c,this.setGraphicVisibility(r,c),f$f(a,c);}return !1}resetIterators(){this.iterators.active=null,this.iterators.visible=null,this.iterators.sort=null;}ensureActiveGraphicsIterator(){return this.iterators.active||(this.iterators.active=ci(this.graphics.active)),this.iterators.active}resetActiveGraphicsIterator(){this.iterators.active=null;}ensureVisibleGraphicsIterator(){return this.iterators.visible||(this.iterators.visible=ci(this.graphics.visible)),this.iterators.visible}resetVisibleGraphicsIterator(){this.iterators.visible=null;}ensureSortGraphicsIterator(){return this.iterators.sort||(this.iterators.sort=ni(this.graphics.visible,this.iterators.sortArray,this.visibilityGroup)),this.iterators.sort}resetSortGraphicsIterator(){this.iterators.sort=null;}collectGraphics3DGraphics(i,t,s,a){const o=i.graphics3DGraphic;if(o.destroyed)return;const c=i.info[this.visibilityGroup];if(!o.isVisible(0,3))return void(c.culled=!0);const n=this.getGraphicsLayers(o);B$i(c.aabr);let h=null;for(const l of n){if(!this.layerSupportsDeconfliction(l))continue;const o=l.stageObject.geometryRecords[0].material;if(t$F(h)){if(h=this.getProjectionInfo(l,t,pi),h.isOutsideScreen||this.isCulledBySlice(i,W$6)||r$A(s)&&this.isCulledByHorizon(h,s,a))return void(c.culled=!0);!I$j.TESTS_DISABLE_OPTIMIZATIONS&&c.visible&&(h.distance*=.7);}this.expandBoundingRect(c,l,o,h);}t$F(h)?c.culled=!0:(c.distance=h.distance,c.culled=!1);}getProjectionInfo(i,t,s){const e=this._runningViewState.camera,r=i.stageObject,a=r.geometryRecords[0],o=a.material,c=L$i(r.boundingVolumeWorldSpace.bounds);I$g(W$6,c,e.viewMatrix);const n=a.geometry.vertexAttributes,h=n.get("normal").data,l=n.get("auxpos1").data;return o.applyShaderOffsetsView(W$6,h,r.transformation,l,e,s.scaleInfo,W$6),r$P(U$5,W$6[0],W$6[1],W$6[2],1),y$w(H$7,U$5,e.projectionMatrix),d$z(s.positionNDC,H$7,1/H$7[3]),o.applyShaderOffsetsNDC(s.positionNDC,l,e,s.positionNDC,L$9),s.distanceWithoutPolygonOffset=e.depthNDCToWorld(L$9[2]),s.distance=L$9[2]===s.positionNDC[2]?s.distanceWithoutPolygonOffset:e.depthNDCToWorld(s.positionNDC[2]),r$P(H$7,s.positionNDC[0],s.positionNDC[1],s.positionNDC[2],1),y$w(U$5,H$7,t),l$I(U$5,U$5,1/U$5[3]),o$C(s.positionView,W$6[0],W$6[1],W$6[2]),s}isCulledByHorizon(i,t,s){return r$B(J$7.direction,i.positionView),o$C(J$7.origin,0,0,0),!!U$d(t,J$7,K$7)&&i.distanceWithoutPolygonOffset>s}isCulledBySlice(i,t){return i.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&cs(this._runningViewState.slicePlane,t)}expandBoundingRect(i,t,e,{positionNDC:r,scaleInfo:a}){const o=this._runningViewState.camera,c=t.getScreenSize(hi);f$z(c,a.factor,c),c[0]*=o.pixelRatio,c[1]*=o.pixelRatio;const n=d$J(e.calculateRelativeScreenBounds(c,a.factorAlignment.scale,Q$5),s$F(0,o.fullWidth,.5+.5*r[0]),s$F(0,o.fullHeight,.5+.5*r[1])),h=this.iconMarginFactor;if(0!==h){const i=h*Math.min(s$M(n),l$J(n));n[0]-=i,n[1]-=i,n[2]+=i,n[3]+=i;}h$A(i.aabr,n,i.aabr);}isConflicted(i){const t=i.graphics3DGraphic.graphic.uid,s=i.info[this.visibilityGroup];for(let e=Math.floor(s.aabr[0]/this.accBinsSizeX);e<=Math.floor(s.aabr[2]/this.accBinsSizeX);e++)if(!(e<0||e>=this.accBinsNumX))for(let i=Math.floor(s.aabr[1]/this.accBinsSizeY);i<=Math.floor(s.aabr[3]/this.accBinsSizeY);i++){if(i<0||i>=this.accBinsNumY)continue;const r=this.accBins[e][i];for(let i=0;i<r.length;i++){const e=r.data[i],a=e.info[this.visibilityGroup];if(a&&a.visible&&(e.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,k$o(a.aabr,s.aabr))))return !0}}return !1}initBins(i,t){if(null==this.accBins){this.accBins=[];for(let i=0;i<this.accBinsNumX;i++){this.accBins.push([]);const i=this.accBins[this.accBins.length-1];for(let t=0;t<this.accBinsNumY;t++)i.push(new n$Z);}}else for(let s=0;s<this.accBinsNumX;s++)for(let i=0;i<this.accBinsNumY;i++)this.accBins[s][i].clear();this.accBinsSizeX=i/this.accBinsNumX,this.accBinsSizeY=t/this.accBinsNumY,this.accNumTests=0;}addToBins(i){const t=i.info[this.visibilityGroup],s=Math.floor(t.aabr[0]/this.accBinsSizeX),e=Math.floor(t.aabr[2]/this.accBinsSizeX),r=Math.floor(t.aabr[1]/this.accBinsSizeY),a=Math.floor(t.aabr[3]/this.accBinsSizeY);for(let o=s;o<=e;o++)if(!(o<0||o>=this.accBinsNumX))for(let t=r;t<=a;t++)t<0||t>=this.accBinsNumY||this.accBins[o][t].push(i);}setGraphicVisibility(i,t){const s=i.graphics3DGraphic;s.destroyed||(s.setVisibilityFlag(3,t,this.visibilityGroup),1===this.visibilityGroup&&this.view.labeler.setLabelGraphicVisibility(s,t));}};function oi(i,t){const s=i.graphics3DGraphic;s.destroyed||s.clearVisibilityFlag(3,t);}function*ci(i){if(Map.prototype.entries){const t=i.entries();for(let i=t.next();!i.done;i=t.next())yield i.value[1];}else yield*i.values();}function*ni(i,t,s){t.clear(),i.forEach(((i,e)=>{const r=t.pushNew();r.id=e,r.prio=i.info?-i.info[s].distance:Number.MAX_VALUE;})),yield;const e=t.iterableSort(((i,t)=>t.prio-i.prio));for(let r=e.next();!r.done;r=e.next())yield;t.forAll((t=>{const s=i.get(t.id);s&&(i.delete(t.id),i.set(t.id,s));})),t.clear();}e$x([d$y({constructOnly:!0})],ai.prototype,"view",void 0),e$x([d$y({type:Boolean,readOnly:!0})],ai.prototype,"updating",null),ai=e$x([i$H("esri.views.3d.layers.graphics.Deconflictor")],ai);const hi=n$Q();class li{constructor(){this.positionView=n$F(),this.positionNDC=n$F(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}};}get isOutsideScreen(){const i=this.positionNDC;return i[0]<-1||i[1]<-1||i[2]<-1||i[0]>=1||i[1]>=1}}const pi=new li;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const o$m=2e3;let i$e=class extends ai{constructor(){super(...arguments),this.visibilityGroup=1,this.iconMarginFactor=0,this._lastDeconfliction=0;}get viewState(){return this.parent.viewState}runTask(r){if(this.parent.running)return;const t=performance.now();(2===r.state||t-this._lastDeconfliction>o$m)&&(super.runTask(r),0===this.state&&(this._lastDeconfliction=t));}enabledChanged(r,t){this.modifyGraphics(t,r.labelsEnabled);}getGraphicsLayers(r){return r.labelGraphics}};e$x([d$y({constructOnly:!0})],i$e.prototype,"parent",void 0),i$e=e$x([i$H("esri.views.3d.layers.graphics.LabelDeconflictor")],i$e);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let d$k=class extends ai{constructor(){super(...arguments),this._handles=new u$D,this._contexts=new Map,this._viewState=new ri,this.visibilityGroup=0,this._iconMarginFactor=-.1;}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._handles.add([this.view.watch("state.camera",(()=>{this.updateViewState(),this.setDirty();})),this.view.watch("map.ground.opacity",((e,t)=>{1!==e&&1!==t||this.setDirty();})),i$P(this.view,"slicePlane",(()=>{this.updateSlicePlane(),this.slicePlaneChanged();}))]),this._frameTask=this.view.resourceController.scheduler.registerTask(f$u.GRAPHICS_DECONFLICTOR,this),this._labels=new i$e({view:this.view,parent:this});}destroy(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null);}get iconMarginFactor(){return this._iconMarginFactor}set iconMarginFactor(e){this._iconMarginFactor=e,this.setDirty();}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty());}runTask(e){super.runTask(e),this.running||this._labels.setDirty();}setInitialIconVisibilityFlag(e,t){const i=!(this._graphicSupportsDeconfliction(t)&&u$m(e));t.setVisibilityFlag(3,i,0);}updateViewState(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this.updateSlicePlane());}updateSlicePlane(){const e=this.view?this.view.slicePlane:null;r$A(e)&&ls(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=r$A(e);}slicePlaneChanged(){n$_(this._contexts,((e,t)=>t.symbolCreationContext.slicePlaneEnabled))&&this.setDirty();}addGraphicsOwner(e){let t=this._contexts.get(e);return null==t&&(t=new Map,this._contexts.set(e,t),this.setDirty()),{addGraphic:i=>this.addGraphic(e,t,i),removeGraphic:e=>this.removeGraphic(t,e),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach((e=>this.removeGraphic(t,e.graphics3DGraphic)))}}removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach((e=>this.removeGraphic(t,e.graphics3DGraphic))),this._contexts.delete(e),this.setDirty());}addGraphic(e,t,i){const s=i.graphic.uid,r=new ii(i,e.symbolCreationContext.slicePlaneEnabled);t.set(s,r),u$m(e)&&this.addToActiveGraphics(r),e.labelsEnabled&&this._labels.addToActiveGraphics(r);}removeGraphic(e,t){const i=t.graphic.uid,s=e.get(i);s&&(this.removeFromActiveGraphics(s),this._labels.removeFromActiveGraphics(s),e.delete(i),this.setDirty());}enabledChanged(e,t){const i=u$m(e);i||m$k(e),this.modifyGraphics(t,i);}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach((e=>e.slicePlaneEnabled=i)),this.setDirty();}getGraphicsLayers(e){return e.graphics}_graphicSupportsDeconfliction(e){if(e.isDraped)return !1;const t=e.graphics;if(!t||!t.length)return !1;for(const i of t)if(this.layerSupportsDeconfliction(i))return !0;return !1}};function u$m(e){const t=e.layer;return !(!t||!t.featureReduction||"selection"!==t.featureReduction.type)}function m$k(e){const t=e.graphics3DGraphics;t&&t.forEach((e=>e.clearVisibilityFlag(3)));}d$k=e$x([i$H("esri.views.3d.layers.graphics.GraphicsDeconflictor")],d$k);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function i$d(i){return i instanceof i$V?i.graphics3DSymbol:i instanceof c$V?i:null}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const u$l=s$y.getLogger("esri.views.3d.layers.graphics.labelPlacement");function b$a(e){const r=k$7(e);if(t$F(r))return null;const a=g$h(e,r);if(t$F(a))return null;const c=a.anchor,l=!!r.hasLabelVerticalOffset;return P$c({anchor:c,verticalOffset:r.verticalOffset,screenOffset:n$Q(),centerOffset:r$L(0,0,0,-1),centerOffsetUnits:"world",translation:n$F(),elevationOffset:0,hasLabelVerticalOffset:l},a,e)}function g$h(e,t){if(t.anchor)return t;const r=e.labelClass.labelPlacement,n=V$8[r],a=n||y$g(e);return r&&!n&&u$l.warnOncePerTick(`the requested label placement '${r}' is not currently supported in SceneView`),d$j(a,e)}function O$7(e){const t=e.graphics3DGraphic.graphics3DSymbol,n=i$d(t);return r$A(n)?n.symbol.symbolLayers.getItemAt(0):null}function d$j(e,n){const a=n.graphics3DGraphic.graphic.geometry;if(t$F(a))return null;if(r$A(n.disablePlacement)){return n.labelClass.labelPlacement?(u$l.warnOncePerTick(v$g(e.placement,n.disablePlacement.logEntityDescription)),y$g(n)):e}const c=a.type;switch(c){case"polyline":case"polygon":case"extent":case"multipoint":if(n.labelClass.labelPlacement)return u$l.warnOncePerTick(v$g(e.placement,`'${c}' geometries`)),y$g(n);break;case"point":case"mesh":return e}return e}function v$g(e,t){return `the requested label placement '${e}' is currently unsupported for ${t} in SceneView`}function y$g(e){const n=e.graphics3DGraphic.graphic.geometry;if(t$F(n))return null;switch(n.type){case"polyline":case"extent":case"multipoint":return {placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const t=O$7(e);return r$A(t)&&"extrude"===t.type?V$8["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return V$8["above-center"];default:return}}function P$c(e,r,n){const a=n.graphics3DGraphic.graphic.geometry;if(t$F(a))return null;switch(a.type){case"point":L$8(e,r,n);break;case"polygon":w$c(e,r,n);break;case"mesh":S$c(e,r,n.graphics3DGraphic.graphics[0]);}return e}function w$c(e,n,c){const l=O$7(c);if(!t$F(l))switch(l.type){case"extrude":{const t=c.graphics3DGraphic.graphics[0];r$A(t)?(t.getBoundingBoxObjectSpace(T$9),p$L(T$9,e.translation),e.translation[2]=N$j(T$9)/2):o$C(e.translation,0,0,0),S$c(e,n,t);break}}}function L$8(e,n,c){const l=O$7(c);if(t$F(l))return;const o=c.graphics3DGraphic.graphics[0];switch(r$A(o)?o.getCenterObjectSpace(e.translation):o$C(e.translation,0,0,0),l.type){case"icon":case"text":z$7(e,n,c,o);break;case"object":S$c(e,n,o);}}function z$7(e,t,n,a){const{graphics3DGraphic:c}=n,l=r$A(a)?a.getScreenSize():null;if(!c.isDraped&&r$A(l)){const r=j$d(n);G$6[0]=l[0]/2*(t.normalizedOffset[0]-r[0]),G$6[1]=l[1]/2*(t.normalizedOffset[1]-r[1]),e.screenOffset[0]=G$6[0],e.hasLabelVerticalOffset?(e.centerOffset[1]=G$6[1],e.centerOffsetUnits="screen"):e.screenOffset[1]=G$6[1];}else e.hasLabelVerticalOffset||"center"===e.anchor||(V$8[n.labelClass.labelPlacement]&&u$l.warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center");}function j$d(e,t=B$7){const{graphics3DGraphic:n}=e,a=n.graphics[0],c=r$A(a)?a.stageObject.geometryRecords[0].material:null;if(c&&c instanceof W$c){const e=c.parameters.anchorPos;t[0]=2*(e[0]-.5),t[1]=2*(e[1]-.5);}else t[0]=0,t[1]=0;return t}function S$c(e,t,n){const a=r$A(n)?n.getBoundingBoxObjectSpace(T$9):T$9,o=r$D(a[3]-a[0],a[4]-a[1],a[5]-a[2]),s=Math.sqrt(o[0]*o[0]+o[1]*o[1]);e.centerOffset[0]=s/2*t.normalizedOffset[0];const i=e.translation[2],f=o[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=i+f;const p=s$x(o);e.centerOffset[2]=p/2*t.normalizedOffset[2];}function D$7(e){return "above-center"===e}function k$7(e){const t=e.labelClass.labelPlacement,{labelSymbol:n,graphics3DGraphic:a}=e,c=i$d(a.graphics3DSymbol),l=r$A(c)?c.symbol:null,o=V$8[t]||y$g(e);return "point-3d"===l.type&&l.supportsCallout()&&l.hasVisibleVerticalOffset()&&!a.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:C$9(l.verticalOffset),anchor:null,normalizedOffset:null}:!n||!n.hasVisibleVerticalOffset()||"point-3d"===l.type&&l.supportsCallout()&&l.verticalOffset&&!a.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:D$7(o.placement)?{placement:"above-center",verticalOffset:C$9(n.verticalOffset),anchor:"bottom",normalizedOffset:[0,o.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(u$l.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null)}function C$9(e){const{screenLength:t,minWorldLength:r,maxWorldLength:n}=e;return {screenLength:t,minWorldLength:r,maxWorldLength:n}}const V$8={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},x$d={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const $ in x$d){const e=x$d[$],t=V$8[$];e.forEach((e=>{V$8[e]=t;}));}Object.freeze&&(Object.freeze(V$8),Object.keys(V$8).forEach((function(e){Object.freeze(V$8[e]),Object.freeze(V$8[e].normalizedOffset);})));const G$6=[0,0],B$7=[0,0],T$9=a$R();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class s$g{constructor(s){this._stage=s,this._materials=new Map;}get(s){return this._materials.get(s)}add(s,t){this._materials.set(s,t),this._stage.add(t);}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear();}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var g$g;const u$k=512,x$c=4096,T$8=.85,v$f=.95;let y$f=g$g=class extends p$N{constructor(e){super(e),this.type=4,this.id=e$J(),this.events=new n$L,this._glTexture=null,this.needsClear=!1,this.elementsToAddOrUpdate=new Map,this.elementsToRemove=new Map,this.elementsToRender=new Map,this.elements=new Map,this.stageObjects=new Map,this.updating=!1;}initialize(){this.stage=this.view._stage,this.canvas=this.create2DCanvas(),this.ctx=this.canvas.getContext("2d"),this.stage.add(this);const e=this.computeAtlasResolution(this.view.width,this.view.height);this.createAtlasRegion(e),this.update2DCanvasSize(),this.resetAtlasCursor();}unload(){this._glTexture=i$M(this._glTexture),this.updating=!1,this.events.emit("unloaded");}get width(){return this.atlas.size.width}get height(){return this.atlas.size.height}get requiresFrameUpdates(){return !1}createDescriptor(e){return {target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,flipped:!0,samplingMode:9987,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}get glTexture(){return this._glTexture}load(e){return r$A(this._glTexture)||(this._glTexture=new o$G(e,this.createDescriptor(e),this.canvas),this.frameWorker=this.view.resourceController.scheduler.registerTask(f$u.TEXT_TEXTURE_ATLAS,this),this.setDirty()),this._glTexture}dispose(){this.elements=null,this.elementsToAddOrUpdate=null,this.elementsToRemove=null,this.elementsToRender=null,this.frameWorker=s$E(this.frameWorker),this._glTexture&&(this.stage.remove(this),this._glTexture=i$M(this._glTexture)),this.canvas.width=0,this.canvas.height=0,this.canvas=null,this.ctx=null;}create2DCanvas(){const e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",u$k.toString()),e.setAttribute("height",u$k.toString()),e}update2DCanvasSize(){this.canvas.setAttribute("width",this.atlas.size.width.toString()),this.canvas.setAttribute("height",this.atlas.size.height.toString());}createAtlasRegion(e=u$k){this.atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0};}computeAtlasResolution(e,t){let s=Math.max(e,t);return s+=256,s=a$_(s),s=Math.min(s,x$c),s}resizeAtlas(e,t){t=t||e;const s=this.atlas;s.size.width=e,s.size.height=t,r$A(this._glTexture)&&this._glTexture.resize(e,t),this.update2DCanvasSize();}resetAtlasCursor(){const e=this.atlas;e.cursor.x=f$e,e.cursor.y=f$e+A$8,e.lineHeight=0,this.needsClear=!0;}getAtlasUsage(){const e=this.atlas;return (e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)}getExpectedAtlasUsage(){const e=this.elementsToRemove.size,t=this.elementsToAddOrUpdate.size,s=this.elements.size;return this.getAtlasUsage()/s*(s+t-e)}addAtlasElement(e,t,s,i){const r=this.atlas,{renderedWidth:a,renderedHeight:n,displayWidth:h,displayHeight:o}=e.textRenderer;e.placement.offset.x=r.cursor.x,e.placement.offset.y=r.cursor.y,e.placement.size.width=a,e.placement.size.height=n,e.placement.size.displayWidth=h,e.placement.size.displayHeight=o,e.placement.uvMinMax=[e.placement.offset.x/r.size.width,1-(e.placement.offset.y+n)/r.size.height,(e.placement.offset.x+a)/r.size.width,1-e.placement.offset.y/r.size.height],r.cursor.x+=s,r.lineHeight=Math.max(r.lineHeight,i),this.elements.set(t,e);}removeAtlasElement(e){if(e&&this.elements.has(e.textId)){const t=e.placement.offset,s=e.placement.size;this.ctx.clearRect(t.x,t.y,s.width,s.height),this.elements.delete(e.textId);}}ensureStageObjects(e){const t=this.stageObjects.get(e);if(t)return t;const s=new Set;return this.stageObjects.set(e,s),s}addStageObject(e,t){this.ensureStageObjects(e).add(t);}removeStageObject(e,t){const s=this.stageObjects.get(e);s&&s.delete(t)&&(t.geometries[0].vertexAttributes.get("size").data=[0,0],t.geometryVertexAttrsUpdated(t.geometryRecords[0]));}_processAddition(e,t){const s=this.atlas,i=e.textId,r=e.textRenderer.renderedWidth,a=e.textRenderer.renderedHeight,n=r+f$e,h=a+f$e+A$8;if(s.cursor.x+n<s.size.width&&s.cursor.y+h<s.size.height)this.addAtlasElement(e,i,n,h),this.elementsToRender.set(i,e),this.elementsToAddOrUpdate.delete(i);else {if(!(s.cursor.y+h+s.lineHeight<s.size.height)){const e=this.getExpectedAtlasUsage(),i=e>T$8&&s.size.width<x$c;return i&&this.resizeAtlas(2*s.size.width,2*s.size.height),!t||!i&&e>v$f&&s.size.width===x$c?(this.processRemovals(),0):(this.repack(),1)}s.cursor.x=f$e,s.cursor.y+=s.lineHeight,s.lineHeight=0,this.addAtlasElement(e,i,n,h),this.elementsToRender.set(i,e),this.elementsToAddOrUpdate.delete(i);}return 0}processRemovals(){this.elementsToRemove.forEach(((e,t)=>{const s=this.stageObjects.get(t);s&&0!==s.size||this.removeAtlasElement(e),s&&0===s.size&&this.stageObjects.delete(t);})),this.elementsToRemove.clear();}repack(){this.processRemovals(),this.elements.forEach(((e,t)=>{e.rendered=!1,this.elementsToAddOrUpdate.set(t,e);})),this.elements.clear(),this.resetAtlasCursor(),this.elementsToRender.clear();}processRenderingRequest(e){this.ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.placement.size.width,e.placement.size.height),e.textRenderer.render(this.ctx,e.placement.offset.x,e.placement.offset.y);const t=this.stageObjects.get(e.textId);t&&t.forEach((t=>{t.geometries[0].vertexAttributes.get("uv0").data=new Float32Array(e.placement.uvMinMax),t.geometries[0].vertexAttributes.get("size").data=[e.placement.size.displayWidth,e.placement.size.displayHeight],t.geometryVertexAttrsUpdated(t.geometryRecords[0]);})),e.rendered=!0;}get running(){return this.updating}runTask(e,t=!0){if(!this._glTexture)return;let s=!1;if(n$_(this.elementsToAddOrUpdate,((e,i)=>{const r=this.elements.get(i);if(r&&r.rendered){const e=this.stageObjects.get(i);return e&&e.forEach((e=>{const t=e.geometries[0].vertexAttributes,s=this.elements.get(i);t.get("uv0").data=new Float32Array(s.placement.uvMinMax),t.get("size").data=new Float32Array([s.placement.size.displayWidth,s.placement.size.displayHeight]),e.geometryVertexAttrsUpdated(e.geometryRecords[0]);})),this.elementsToAddOrUpdate.delete(i),!1}return 1===this._processAddition(this.elementsToAddOrUpdate.get(i),t)&&(s=!0,!0)})),s)return void this.runTask(C$h,!1);let r=!1;this.elementsToRender.size>0&&this.needsClear&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.needsClear=!1),n$_(this.elementsToRender,((t,s)=>(this.processRenderingRequest(t),this.elementsToRender.delete(s),r=!0,e.madeProgress(),e.done))),r&&r$A(this._glTexture)&&this._glTexture.setData(this.canvas),this.updating=this.elementsToRender.size>0,!this.updating&&g$g.test.orderedRepackingEnabled&&this.repackOrdered();}addTextTexture(e,t){const s=e.key;this.elementsToAddOrUpdate.has(s)||this.elementsToAddOrUpdate.set(s,{textId:s,placement:{offset:{x:0,y:0},size:{width:0,height:0,displayWidth:0,displayHeight:0},uvMinMax:[]},textRenderer:e,rendered:!1}),this.addStageObject(s,t),this.elementsToRemove.delete(s),this.setDirty();}removeTextTexture(e,t){const s=e.key;this.elementsToRemove.set(s,this.elements.get(s)),this.removeStageObject(s,t);}setDirty(){this._glTexture&&(this.updating=!0);}repackOrdered(){if(0===this.elements.size)return;const e=[];this.elements.forEach(((t,s)=>e.push({element:t,key:s})));let t=!0;for(let s=0;s<e.length-1;s++)if(e[s].key.localeCompare(e[s+1].key)>0){t=!1;break}if(!t||this.elementsToRemove.size){e.sort(((e,t)=>e.key.localeCompare(t.key))),this.elements.clear();for(const{element:t,key:s}of e)this.elements.set(s,t);this.repack(),this.setDirty();}}get test(){const{elements:e,stageObjects:t,elementsToRemove:s,atlas:i}=this,r=this;return {elements:e,stageObjects:t,elementsToRemove:s,atlas:i,resizeAtlas:(e,t)=>r.resizeAtlas(e,t),run:(e,t)=>r.runTask(e,t)}}};y$f.test={orderedRepackingEnabled:!1},e$x([d$y({constructOnly:!0})],y$f.prototype,"view",void 0),e$x([d$y({type:Boolean})],y$f.prototype,"updating",void 0),y$f=g$g=e$x([i$H("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],y$f);const f$e=2,A$8=2,z$6=y$f;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const O$6=s$y.getLogger("esri.views.3d.layers.graphics.Labeler");let I$7=class extends p$N{constructor(){super(...arguments),this._dirty=!1,this._labels=new Map,this._labelsToAdd=new Map,this._labelsToRemove=new Map,this._labelingContexts=new Array;}setup(){this.dispose(),this._handles=new u$D,this._handles.add([this.view.watch("state.camera",(()=>this.setDirty())),this.view.watch("pixelRatio",(()=>this._resetAllLabels())),this.view.resourceController.scheduler.registerTask(f$u.LABELER,this)]),this._textTextureAtlas=new z$6({view:this.view}),this._hudMaterialCollection=new s$g(this.view._stage),this._calloutMaterialCollection=new s$g(this.view._stage);}dispose(){this._handles=l$E(this._handles),this._textTextureAtlas=i$M(this._textTextureAtlas),this._hudMaterialCollection=i$M(this._hudMaterialCollection),this._calloutMaterialCollection=i$M(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear();}_activateLabelingContext(e){e.labels.forEach(((e,t)=>{this._labels.set(t,e),e.graphics3DGraphic.setVisibilityFlag(0,!0,1);})),e.active=!0;}_deactivateLabelingContext(e){e.labels.forEach(((e,t)=>{e.graphics3DGraphic.setVisibilityFlag(0,!1,1),this.setLabelGraphicVisibility(e.graphics3DGraphic,!1),this._labels.delete(t);})),e.active=!1;}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const s=e.textRenderers[t._labelIndex];s&&this._textTextureAtlas.addTextTexture(s,t.stageObject);}e.rendered=!0;}_removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const s=e.textRenderers[t._labelIndex];s&&this._textTextureAtlas.removeTextTexture(s,t.stageObject);}e.rendered=!1;}get running(){var e;return !!this.view.ready&&(this._dirty||(null==(e=this._textTextureAtlas)?void 0:e.updating)||this.deconflictor.running)}runTask(e){this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e);}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(S$b(t)){if(!P$b(t)){if(E$9(t)){this._deactivateLabelingContext(t);continue}if(this._createLabelClassContext(t),j$c(t)){this._dirty=!0;continue}if(!P$b(t))continue}n$_(t.labelsToInitialize,((s,l)=>(this._ensureGraphics3DResources(s)&&(this._labels.set(l,s),this.deconflictor.setDirty(),e.madeProgress()),(s.visible&&s.hasTextTextureResources||!s.visible&&s.hasGraphics3DResources)&&(t.labelsToInitialize.delete(l),e.madeProgress()),e.done)))&&(this._dirty=!0);}this._labelsToRemove.forEach((e=>this._removeLabelTextureFromAtlas(e))),this._labelsToAdd.forEach((e=>this._addLabelTextureToAtlas(e))),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating");}}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController.signal;await e.layer.when(),h$B(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const a=e.graphics3DCore,i=a.layer,r=i.labelingInfo&&i.labelingInfo.filter((e=>!!e.symbol));if(!r||0===r.length)return;const o=new Array(r.length);let n=!1;await n$$(r,(async(s,i)=>{const r=s.symbol,h=i$d(a.getOrCreateGraphics3DSymbol(r));if(t$F(h))return void O$6.error("Failed to create Graphics3DSymbol for label");await h.load(),h$B(t);let d=null;o$M(r)&&r.hasVisibleCallout()&&(d=e$K(r,a.symbolCreationContext),await d.load(),h$B(t));const p=await a$P(f$A(s,e.layer.fieldsIndex,this.view.spatialReference));h$B(t),!0===p.ok?o[i]={labelClass:s,labelFunction:p.value,graphics3DSymbol:h,graphics3DCalloutSymbolLayer:d,calloutSymbolLayerIndex:0,textRenderParameters:this._createTextRenderParameters(h.symbol)}:(O$6.error(`Label expression failed to evaluate: ${p.error}`),n=!0);})),h$B(t),n||(e.labelClassContexts=o);}async _createLabelClassContext(e){return e.labelClassPromise||(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if(d$B(t))throw t;e.labelClassContexts=null;})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating");})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise}_createTextRenderParameters(e){const t=e.symbolLayers.getItemAt(0);return t&&"text"===t.type?s$N.fromSymbol(t,this.view.pixelRatio):null}_destroyLabelClassContext(e){for(const s of e.labelClassContexts)--s.graphics3DSymbol.referenced,s.graphics3DSymbol=null;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,t&&t.abort(),e.labelClassContexts=[],e.labelClassPromise=null,this.notifyChange("updating");}_createTextSymbolGraphic(e,t,s,l,a){const i={text:e.text,centerOffset:s.centerOffset,translation:s.translation,elevationOffset:s.elevationOffset,screenOffset:s.screenOffset,anchor:s.anchor,centerOffsetUnits:s.centerOffsetUnits,verticalOffset:s.verticalOffset,debugDrawBorder:I$j.LABELS_SHOW_BORDER,displayWidth:e.displayWidth,displayHeight:e.displayHeight};return V$7.graphic=t,V$7.renderingInfo=null,V$7.layer=l,a.createLabel(V$7,i,this._hudMaterialCollection,this._textTextureAtlas)}_createLineCalloutGraphic(e,t,s,l,a){const i={symbol:t,translation:l.translation,elevationOffset:l.elevationOffset,screenOffset:l.screenOffset,centerOffset:l.centerOffset,centerOffsetUnits:l.centerOffsetUnits,materialCollection:this._calloutMaterialCollection};return V$7.graphic=e,V$7.renderingInfo=i,V$7.layer=a,s.createGraphics3DGraphic(V$7)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return !1;const t=e.graphics3DGraphic;if(t.destroyed)return !1;this._ensureTextTextureResources(e);const s=e.labelingContext,l=s.labelClassContexts;if(!l||0===l.length||!s.emptySymbolLabelSupported&&0===t.graphics.length)return !1;let a=!1;const i=t.graphic,r=s.layer,o=a$$(s.layer),n=this.view._stage;for(let h=0;h<l.length;h++){const b=e.textRenderers[h];if(!b)continue;const d=l[h],p=d.graphics3DSymbol;let u=null;p.symbol&&"label-3d"===p.symbol.type&&(u=p.symbol);const g=p.symbolLayers[0];if(!g)continue;const y=d.labelClass,f=s.disablePlacement,_=b$a({graphics3DGraphic:t,labelSymbol:u,labelClass:y,disablePlacement:f});if(t$F(_))continue;g.setElevationInfoOverride(s.elevationInfoOverride);const m=this._createTextSymbolGraphic(b,i,_,r,g);if(!m)return !1;m._labelClass=y,m._labelIndex=h,t.addLabelGraphic(m,n,s.stageLayer),t.setVisibilityFlag(0,o,1),t.clearVisibilityFlag(1,1),t.setVisibilityFlag(3,!1,1),a=!0;const x=d.graphics3DCalloutSymbolLayer;if(x&&_.hasLabelVerticalOffset){x.setElevationInfoOverride(s.elevationInfoOverride);const e=this._createLineCalloutGraphic(i,u,x,_,r);e&&(d.calloutSymbolLayerIndex=t.labelGraphics.length,t.addLabelGraphic(e,n,s.stageLayer));}break}return s.scaleVisibility&&a&&s.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const s of e.graphics3DGraphic.labelGraphics){if(null==s._labelClass)continue;const e=t[s._labelIndex].graphics3DSymbol.symbolLayers[0];null!=e&&e.onRemoveGraphic(s);}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1;}_ensureTextTextureResources(e){if(e.hasTextTextureResources)return;const t=e.labelingContext,s=t.labelClassContexts;if(!s||0===s.length)return;const l=e.graphics3DGraphic.graphic;for(let i=0;i<s.length;i++){const r=s[i];if(e.textRenderers[i]=null,!r.textRenderParameters)continue;const o=r.labelFunction;let n;if("arcade"===o.type)try{const e=o.needsHydrationToEvaluate()?c$W(l,t.layer):l;n=o.evaluate(e);}catch(a){n=null;}else n=o.evaluate(l);t$F(n)||""===n||/^\s+$/.test(n)||(e.textRenderers[i]=new i$W(n,r.textRenderParameters));}e.hasTextTextureResources=!0;}_destroyTextTextureResources(e){e.textRenderers=[],e.hasTextTextureResources=!1;}_addGraphic(e,t){const s={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:e,graphics3DGraphic:t,textRenderers:[]},l=t.graphic.uid;e.labels.set(l,s),e.labelsToInitialize.set(l,s),this.setDirty(),this.deconflictor.setDirty();}_removeGraphic(e,t){const s=t.graphic.uid,l=e.labels.get(s);l&&(this._destroyGraphic(l,s),e.labels.delete(s),e.labelsToInitialize.delete(s),this.setDirty(),this.deconflictor.setDirty());}_destroyGraphic(e,t){this._labels.has(t)&&(this._labels.delete(t),this._labelsToAdd.delete(t),this._labelsToRemove.delete(t)),e.hasTextTextureResources&&(this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e)),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e);}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const s of t){const t=e.labels.get(s);t&&(this._removeGraphic(e,t.graphics3DGraphic),this._addGraphic(e,t.graphics3DGraphic));}}_globalPropertyChanged(e,t){for(const s of t.labelClassContexts){const l=new Map;t.labels.forEach((e=>{const t=e.graphics3DGraphic;l.set(t.graphic.uid,t);}));const a=e=>e.labelGraphics[0];if(e$z(s.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(e,l,a),s.graphics3DCalloutSymbolLayer){const t=e=>e.labelGraphics[s.calloutSymbolLayerIndex];s.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,l,t);}}}_visibilityInfoChange(e){const t=e.layer.labelsVisible;t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty();}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e);}_resetLabels(e){e.labels.forEach(((t,s)=>{this._destroyGraphic(t,s),t.visible=!1,t.rendered=!1,e.labelsToInitialize.set(s,t);})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty();}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,s){const l=s&&s.emptySymbolLabelSupported||!1,a=s&&s.elevationInfoOverride||null,i=s&&s.disablePlacement||null;if(this._findLabelingContext(e))return;const r=e.layer,o={graphics3DCore:e,layer:r,scaleVisibility:t,emptySymbolLabelSupported:l,elevationInfoOverride:a,disablePlacement:i,active:r.labelsVisible,labelClassPromise:null,labelClassAbortController:new AbortController,labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new n$10({isPickable:!0},r.uid)};return this.view._stage.add(o.stageLayer),this._labelingContexts.push(o),this.setDirty(),{addGraphic:e=>this._addGraphic(o,e),removeGraphic:e=>this._removeGraphic(o,e),featureReductionChange:()=>{},layerLabelsEnabled:()=>a$$(o.layer),labelingInfoChange:e=>this._labelingInfoChange(o,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",o),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",o),visibilityInfoChange:()=>this._visibilityInfoChange(o),reset:()=>this._resetLabels(o),clear:()=>{}}}removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const s=this._labelingContexts.indexOf(t);this._labelingContexts.splice(s,1),t.labels.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),this.view._stage.remove(t.stageLayer),t.stageLayer=null,this.setDirty();}setLabelGraphicVisibility(e,t){const s=e.graphic.uid,l=this._labels.get(s);l&&l.visible!==t&&(t&&!l.rendered?(this._labelsToAdd.set(s,l),this._labelsToRemove.delete(s),l.hasTextTextureResources||l.labelingContext.labelsToInitialize.set(s,l)):!t&&l.rendered&&(this._labelsToRemove.set(s,l),this._labelsToAdd.delete(s)),l.visible=t,this.setDirty());}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"));}get updating(){var e;return this._dirty||(null==(e=this._textTextureAtlas)?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some((e=>j$c(e)))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(j$c(t)?0:1)),0)/this._labelingContexts.length:1;return (this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return {textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function S$b(e){return e.active&&a$$(e.layer)}function j$c(e){return e.labelClassPromise&&!!e.labelClassAbortController}function P$b(e){return e.labelClassContexts&&e.labelClassContexts.length}function E$9(e){return null===e.labelClassContexts}e$x([d$y({constructOnly:!0})],I$7.prototype,"view",void 0),e$x([d$y({constructOnly:!0})],I$7.prototype,"deconflictor",void 0),e$x([d$y()],I$7.prototype,"_textTextureAtlas",void 0),e$x([d$y({type:Boolean,readOnly:!0})],I$7.prototype,"updating",null),I$7=e$x([i$H("esri.views.3d.layers.graphics.Labeler")],I$7);const V$7=new r$U(null,null,null);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class c$m{constructor(){this.gltfCache=new Map,this.wosrCache=new Map,this.evictHandles=new u$D;}loadGLTF(e,t,r){const o=r?`gltfPBR:${e}`:`gltf:${e}`;return this.fromCache(this.gltfCache,o,(t=>l$K(new n$11(t.streamDataRequester),e,t,r)),t)}loadWOSR(e,t){const r=`wosr:${e}:${t.disableTextures}`;return this.fromCache(this.wosrCache,r,(t=>x$s(e,t)),t)}destroy(){this.evictHandles.destroy(),this.gltfCache.clear(),this.wosrCache.clear();}get size(){return this.wosrCache.size+this.gltfCache.size}fromCache(e,t,a,n){return new Promise(((l,c)=>{if(p$T(n))return void c(m$D());const m=j$t(n,(()=>{this.remove(e,t),c(m$D());})),h=e.get(t);if(h)return this.evictHandles.remove(t),h.refCount++,void h.item.then(l,c);const f=new AbortController,d={...n,signal:f.signal},C={refCount:1,abortController:f,item:a(d).then((r=>(C.abortController=null,r.remove=()=>this.remove(e,t),r)))};e.set(t,C),C.item.then((e=>{r$A(m)&&m.remove(),l(e);}),(e=>{r$A(m)&&m.remove(),c(e);}));}))}remove(e,o){const s=e.get(o);s&&(s.refCount--,0===s.refCount&&this.evictHandles.add(u$G((()=>{e.delete(o),r$A(s.abortController)&&s.abortController.abort();}),h$e),o));}}const m$j=1e4;let h$e=m$j;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class t$r{constructor(e,t,s,h=null){this.lij=[0,0,0],this.extent=u$B(),this.resolution=0,this.loadPriority=0,this.measures={visibility:2,screenRect:u$B(),distance:0,shouldSplit:!1},this.used=!1,h&&this.acquire(e,t,s,h);}acquire(i,e,s,h){this.tilingScheme=h,this.id=t$r.id(i,e,s),this.lij[0]=i,this.lij[1]=e,this.lij[2]=s,h.getExtent(i,e,s,this.extent),this.resolution=h.resolutionAtLevel(i);}release(){this.tilingScheme=null;}getChildren(i){const e=this.lij[0]+1,s=2*this.lij[1],h=2*this.lij[2];return i?(i[0].acquire(e,s,h,this.tilingScheme),i[1].acquire(e,s+1,h,this.tilingScheme),i[2].acquire(e,s,h+1,this.tilingScheme),i[3].acquire(e,s+1,h+1,this.tilingScheme),i):[new t$r(e,s,h,this.tilingScheme),new t$r(e,s+1,h,this.tilingScheme),new t$r(e,s,h+1,this.tilingScheme),new t$r(e,s+1,h+1,this.tilingScheme)]}copyMeasurementsFrom(i){this.measures.visibility=i.measures.visibility,this.measures.shouldSplit=i.measures.shouldSplit,this.measures.distance=i.measures.distance,a$10(i.measures.screenRect,this.measures.screenRect);}static id(i,e,t){return `${i}/${e}/${t}`}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class c$l{constructor(t){this.renderCoordsHelper=t,this.frustum=b$q(),this._points=y$x(),this.lines=new Array(12),this._origin=n$F(),this._direction=n$F(),this._altitude=null;for(let i=0;i<12;i++)this.lines[i]={origin:null,direction:n$F(),endpoint:null};}get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}update(i){w$m(i.viewMatrix,i.projectionMatrix,this.frustum,this._points),r$B(this._origin,i.eye),r$B(this._direction,i.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this.updateLines();}updatePoints(i){for(let s=0;s<this._points.length;s++)r$B(this._points[s],i[s]);x$t(this.frustum,this._points),this.updateLines();}get altitude(){return this._altitude}intersectsSphere(t){return O$o(this.frustum,t)}intersectsRay(t){return R$i(this.frustum,t)}intersectsLineSegment(t,i){return q$j(this.frustum,t,i)}intersectsPoint(t){return z$j(this.frustum,t)}updateLines(){const t=this._points;for(let i=0;i<4;i++){const s=i+4;a$j(this.lines[i],t[i],t[s]),a$j(this.lines[i+4],t[i],3===i?t[0]:t[i+1]),a$j(this.lines[i+8],t[s],3===i?t[4]:t[s+1]);}}}function a$j(t,s,e){t.origin=s,t.endpoint=e,H$j(t.direction,s,e);}c$l.planePointIndices=C$i,c$l.nearFarLineIndices=[[0,4],[1,5],[2,6],[3,7]];

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class F$6{constructor(e){this.renderCoordsHelper=e,this.surfaceElevation=0,this.cache=new Map,this.frustum=new c$l(e),this.extendedFrustum=new c$l(e),this.intersector=new k$p({renderCoordsHelper:e}),this.renderCoordsHelper=e;}begin(e,t){this.surfaceElevation=t,this.aboveGround=this.renderCoordsHelper.getAltitude(e.eye)>t,this.frustum.update(e),this.shortenFrustumFarPlane(this.frustum),this.updateExtendedFrustum(e);}end(){this.cache.clear();}calculate(e){if(this.allTilesInvisible)return 0;const t=1===this.renderCoordsHelper.viewingMode&&e.lij[0]>=b$9&&e.lij[0]<v$e,i=this.getOrCalculateSingleTileVisibility(e,!t);return 0!==i&&t?this.calculateAggregatedChildrenVisibility(e):i}shortenFrustumFarPlane(e){const t=c$l.nearFarLineIndices,n=e.mutablePoints;for(const o of t){const[e,t]=o,a=n[e],u=n[t];c$O(w$b,u,a),d$z(w$b,w$b,P$a),u$A(n[t],a,w$b);}e.updatePoints(n);}calculateAggregatedChildrenVisibility(e){let t=0;const i=this.cache.get(e.id);if(null!=i)return i;const s=A$7.acquire();e.getChildren(s);for(const r of s){const e=this.calculate(r);if(0!==e&&(t=e,2===e))break}return A$7.release(s),this.cache.set(e.id,t),t}getOrCalculateSingleTileVisibility(e,t){const i=this.cache.get(e.id);if(null!=i)return i;const s=this.calculateSingleTileVisibility(e);return t&&this.cache.set(e.id,s),s}calculateSingleTileVisibility(e){if(!this.aboveGround&&1===this.renderCoordsHelper.viewingMode&&e.lij[0]<x$b){return 0===this.calculateSingleTileVisibilitySided(e,!1)?this.calculateSingleTileVisibilitySided(e,!0):void 0}return this.calculateSingleTileVisibilitySided(e,this.aboveGround)}calculateSingleTileVisibilitySided(e,t){this.intersector.update(e.extent,e.tilingScheme.spatialReference,this.surfaceElevation,t);const i=p$K(e.tilingScheme.spatialReference).radius;return this.intersector.isVisibleInFrustum(this.extendedFrustum,i)?this.intersector.isVisibleInFrustum(this.frustum,i,!0)?2:1:0}updateExtendedFrustum(t){this.extendedFrustum.update(t),this.shortenFrustumFarPlane(this.extendedFrustum);const i=this.renderCoordsHelper.worldUpAtPosition(t.eye,w$b);this.aboveGround||v$r(i,i);const r=l$B(-z$i(i,t.viewForward));if(this.allTilesInvisible=r>(Math.PI+t.fovY)/2,this.allTilesInvisible)return;if(this.hasExtendedFrustum=r>t.fovY/2,!this.hasExtendedFrustum)return;const a=this.extendedFrustumParameters(),u=this.extendedFrustum.mutablePoints;for(let e=0;e<4;e++){const t=a.pointIndices[e],i=u[t],r=this.renderCoordsHelper.getAltitude(i);if(a.needsAltitudeAdjustment(r)){switch(this.renderCoordsHelper.worldUpAtPosition(i,w$b),t){case 4:case 7:case 0:case 3:P$n(this.extendedFrustum.planes[0],w$b,w$b);break;case 5:case 6:case 1:case 2:P$n(this.extendedFrustum.planes[1],w$b,w$b);}d$z(w$b,w$b,a.direction),this.renderCoordsHelper.intersectInfiniteManifold(j$r(i,w$b),a.zWithMargin,i);}}if(this.extendedFrustum.updatePoints(u),y$y(u[0],u[1],u[2],S$a),y$y(u[1],u[2],u[3],y$e),z$i(W$b(S$a),W$b(y$e))<0){const e=this.extendedFrustum.mutablePoints;this.aboveGround?[e[0],e[1]]=[e[1],e[0]]:[e[3],e[2]]=[e[2],e[3]],this.extendedFrustum.updatePoints(e);}}extendedFrustumParameters(){return this.aboveGround?this.extendedFrustumParametersAboveSurface():this.extendedFrustumParametersBelowSurface()}extendedFrustumParametersAboveSurface(){const e=this.surfaceElevation-j$b;return {zWithMargin:e,pointIndices:c$l.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:t=>t>e}}extendedFrustumParametersBelowSurface(){const e=this.surfaceElevation+j$b;return {zWithMargin:e,pointIndices:c$l.planePointIndices.top,direction:1,needsAltitudeAdjustment:t=>t<e}}}const b$9=2,v$e=6,x$b=12,P$a=.95,j$b=1,w$b=n$F(),S$a=p$S(),y$e=p$S(),A$7=new e$L(Array,(e=>{4!==e.length&&(e[0]=new t$r,e[1]=new t$r,e[2]=new t$r,e[3]=new t$r);}),(e=>{e[0].release(),e[1].release(),e[2].release(),e[3].release();}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class S$9{constructor(e){this.camera=new J$d,this.focusOnMap=[0,0],this.screenRect=u$B(),this.tileSize=e.tileSize,this.renderCoordsHelper=e.renderCoordsHelper,this.tilingScheme=e.tilingScheme,this.visibility=new F$6(e.renderCoordsHelper);}begin(e,t,i){this.camera.copyFrom(e),this.surfaceElevation=i,this.focusOnMap[0]=t.x,this.focusOnMap[1]=t.y,o$N(0,0,e.fullWidth,e.fullHeight,this.screenRect),this.visibility.begin(this.camera,i);}end(){this.visibility.end();}updateTile(e){e.measures.visibility=this.visibility.calculate(e),e.measures.distance=R$j(e.extent,this.focusOnMap),0!==e.measures.visibility&&this.updateScreenMeasure(e);}updateScreenMeasure(e){const t=g$f,i=1<<t,s=e.measures.screenRect;B$i(s);let r=0;const o=e.lij[0]+t,n=e.lij[1]<<t,a=e.lij[2]<<t,l=this.tileSizeWithBias(e),h=l*l;for(let c=0;c<i;c++)for(let t=0;t<i;t++)if(r+=this.computeScreenArea(e,o,n+c,a+t,s),r>h)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1;}tileSizeWithBias(e){return 1===e.measures.visibility?this.tileSize*b$8:this.tileSize}computeScreenArea(e,t,i,s,r){const o=1===e.measures.visibility;this.projectToScreen(t,i,s,o,y$d),B$i(j$a);for(let n=0;n<4;n++)f$B(j$a,y$d[n]);return h$A(r,j$a,r),b$r(y$d[0],y$d[1],y$d[2])+b$r(y$d[0],y$d[2],y$d[3])}projectToScreen(e,t,i,s,r){this.tilingScheme.ensureMaxLod(e),this.tilingScheme.getExtent(e,t,i,v$d),this.toRenderCoords(v$d,0,3,C$8[0]),this.toRenderCoords(v$d,2,3,C$8[1]),this.toRenderCoords(v$d,2,1,C$8[2]),this.toRenderCoords(v$d,0,1,C$8[3]),s&&(this.projectToPlane(C$8,this.camera.frustum[4]),this.projectToPlane(C$8,this.camera.frustum[3]),this.projectToPlane(C$8,this.camera.frustum[2]));for(let o=0;o<4;o++)this.camera.projectToRenderScreen(C$8[o],M$8),this.camera.renderToScreen(M$8,r[o]);}projectToPlane(e,t){for(let i=0;i<4;i++)T$7[i]=R$k(t,e[i]);const r=Math.max(T$7[0],T$7[1],T$7[2],T$7[3]);if(r>0){const o=d$z(R$a,W$b(t),-r);for(let t=0;t<4;t++)u$A(e[t],e[t],o);}}toRenderCoords(e,t,i,s){return R$a[0]=e[t],R$a[1]=e[i],R$a[2]=this.surfaceElevation,this.renderCoordsHelper.toRenderCoords(R$a,this.tilingScheme.spatialReference,s),s}}const j$a=u$B(),g$f=2,b$8=5,y$d=[i$S(),i$S(),i$S(),i$S()],v$d=u$B(),R$a=n$F(),C$8=[n$F(),n$F(),n$F(),n$F()],T$7=[0,0,0,0],M$8=x$r();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const w$a=s$y.getLogger("esri.views.3d.layers.support.FeatureTileTree3D");let x$a=class extends p$N{constructor(e){super(e),this.tiles=new S$o,this.tileSize=512,this._idToTile=new Map,this._handles=new u$D,this._clients=new Set,this._dirty=!1,this._newTiles=new n$Z;}get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;if(!e)return null;return e.clone()}set filterExtent(e){if(r$A(e)&&!e.spatialReference.equals(this.viewState.spatialReference))return void w$a.error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||r$A(t)&&e&&t.equals(e))return;const i=r$A(e)?e.clone():null;this._set("filterExtent",i),this._setDirty();}get filterExtentRect(){if(t$F(this.filterExtent)||!this.tilingScheme)return null;const e=u$B();return e$M(this.filterExtent,e,this.tilingScheme.spatialReference),e}get rootTileIds(){return this.filterExtentRect?this.tilingScheme.rootTilesInExtent(this.filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty());}get updating(){return this._dirty||!!this._pendingTiles}initialize(){this._handles.add(this.watch(["tilingScheme","tileSize"],(()=>this._reset()),!0)),this._handles.add(i$P(this,["tileSize","cameraOnSurface.location","tilingScheme","viewState.contentCamera","focus.location"],(()=>this._setDirty()),!0)),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(f$u.FEATURE_TILE_TREE,this));}destroy(){this._frameWorker=s$E(this._frameWorker),this._handles=l$E(this._handles);}addClient(){const e=j$9();return this._clients.add(e),1===this._clients.size&&this._setDirty(),{remove:()=>this._removeClient(e)}}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear();}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(C$h));}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating");}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),r$A(this._frameWorker)&&(this._frameWorker.priority=f$u.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),!this._pendingTiles&&r$A(this._frameWorker)&&(this._frameWorker.priority=f$u.FEATURE_TILE_TREE),this.notifyChange("updating");}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new S$9({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z),this._pendingTiles=this._getRootTiles();}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty();}_getRootTiles(){return this.rootTileIds.map((e=>new t$r(e[0],e[1],e[2],this.tilingScheme)))}_purgeHorizonTiles(e){e.sort(((e,t)=>{const i=e.measures.screenRect,s=t.measures.screenRect;return i[1]+i[3]-(s[1]+s[3])})),B$i(C$7);for(let t=0;t<e.length;t++)if(h$A(C$7,e.data[t].measures.screenRect,C$7),l$J(C$7)>O$5)return e.data.slice(t,e.length);return []}_subdivideTilesForView(e){if(this._pendingTiles){for(;this._pendingTiles.length>0&&!e.done;){const t=this._pendingTiles.pop();e.madeProgress(),this.filterExtentRect&&!k$o(this.filterExtentRect,t.extent)||(this._tileMeasurements.updateTile(t),0!==t.measures.visibility&&(t.measures.shouldSplit?(this.tilingScheme.ensureMaxLod(t.lij[0]+1),this._pendingTiles.push(...t.getChildren())):this._newTiles.push(t)));}0===this._pendingTiles.length&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null);}}_updateTiles(e){for(const s of this.tiles.items)s.used=!1;const t=e.filter((e=>{const t=this._idToTile.get(e.id);return t?(t.copyMeasurementsFrom(e),t.used=!0):this._idToTile.set(e.id,e),!t})),i=this.tiles.items.filter((e=>!e.used&&(this._idToTile.delete(e.id),!0)));this.tiles.removeMany(i),this.tiles.addMany(t),this.sortTiles();}sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort(((e,t)=>e.measures.visibility!==t.measures.visibility?2===e.measures.visibility?-1:1:e.measures.distance-t.measures.distance)),this.tiles.forEach(((e,t)=>e.loadPriority=t));}};e$x([d$y({constructOnly:!0})],x$a.prototype,"scheduler",void 0),e$x([d$y({constructOnly:!0})],x$a.prototype,"renderCoordsHelper",void 0),e$x([d$y({constructOnly:!0})],x$a.prototype,"tilingSchemeOwner",void 0),e$x([d$y({constructOnly:!0})],x$a.prototype,"cameraOnSurface",void 0),e$x([d$y({constructOnly:!0})],x$a.prototype,"focus",void 0),e$x([d$y({constructOnly:!0})],x$a.prototype,"viewState",void 0),e$x([d$y({constructOnly:!0})],x$a.prototype,"terrain",void 0),e$x([d$y()],x$a.prototype,"tiles",void 0),e$x([d$y()],x$a.prototype,"tileSize",void 0),e$x([d$y({readOnly:!0})],x$a.prototype,"tilingScheme",null),e$x([d$y()],x$a.prototype,"filterExtent",null),e$x([d$y({readOnly:!0})],x$a.prototype,"filterExtentRect",null),e$x([d$y({readOnly:!0})],x$a.prototype,"rootTileIds",null),e$x([d$y({value:!1})],x$a.prototype,"suspended",null),e$x([d$y({readOnly:!0})],x$a.prototype,"updating",null),x$a=e$x([i$H("esri.views.3d.layers.support.FeatureTileTree3D")],x$a);let R$9=0;function j$9(){return R$9++}const C$7=u$B(),O$5=10,k$6=x$a;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let C$6=class extends p$N{constructor(){super(...arguments),this._propertiesPool=new o$O({camera:J$d},this),this._lastSeenCameraProjectionValues=new J$d,this.events=new n$L,this.viewingMode=1,this._cameraChanged=!1,this.updateQueue=new Array,this.processingUpdates=!1;}init(e,t){this._set("viewingMode",e),this._set("spatialReference",t),this._set("constraints",new f$q({mode:this.viewingMode}));}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new o$O({camera:J$d},this);}createInitialCamera(){if(1===this.viewingMode){const e=p$K(this.spatialReference).radius;this.camera=new J$d(r$D(4*e,0,0),r$D(e,0,0),r$D(0,0,1));}else this.camera=new J$d(r$D(0,0,100),r$D(0,0,0),r$D(0,1,0));}get animation(){return this.cameraController instanceof a$s&&r$A(this.cameraController.viewAnimation)?this.cameraController.viewAnimation:null}get camera(){return this._get("camera")}set camera(e){e!==y$c&&y$c.copyFrom(e),y$c.computeUp(this.viewingMode),f$d.camera=y$c,this.events.emit("before-camera-change",f$d);const t=this._get("camera");if(this.cameraProjectionChanged(this._lastSeenCameraProjectionValues,y$c)&&(this._lastSeenCameraProjectionValues.copyFrom(y$c),w$9.camera=this._lastSeenCameraProjectionValues,this.events.emit("camera-projection-changed",w$9)),(!t||!t.equals(y$c))&&(this._set("camera",this._propertiesPool.get("camera").copyFrom(y$c)),this._cameraChanged=!t||!t.almostEquals(y$c),this._cameraChanged)){const e=y$z((()=>{this._cameraChanged=!1,e.remove();}));}}get contentCamera(){return r$A(this._contentCamera)?this._contentCamera:this.camera}set contentCamera(e){this._contentCamera=r$A(e)?e.clone():null;}get fixedContentCamera(){return !!r$A(this._contentCamera)}get isGlobal(){return 1===this.viewingMode}get isLocal(){return 2===this.viewingMode}get navigating(){return !(!this.cameraController||!this.cameraController.isInteractive)}get stationary(){return !this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(e&&(e.watch("state",(t=>{t!==o$p.Finished&&t!==o$p.Stopped||(this._set("cameraController",null),this.updateCamera((t=>e.onControllerEnd(t))));}),!0),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=o$p.Rejected);}switchCameraController(e){return this.cameraController=e,e.state!==o$p.Rejected}stopActiveCameraController(){return !(this.cameraController&&!this.cameraController.stopController())}updateCamera(e){this.updateQueue.push(e),this.processUpdateQueue();}processUpdateQueue(){if(0===this.updateQueue.length||this.processingUpdates)return;this.processingUpdates=!0;const e=this.updateQueue.shift();y$c.copyFrom(this._get("camera")),e(y$c),this.camera=y$c,this.processingUpdates=!1,this.processUpdateQueue();}cameraProjectionChanged(e,t){return e.fov!==t.fov||(e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||(e.padding[0]!==t.padding[0]||e.padding[1]!==t.padding[1]||e.padding[2]!==t.padding[2]||e.padding[3]!==t.padding[3]))}};e$x([d$y({readOnly:!0,type:n$X})],C$6.prototype,"animation",null),e$x([d$y({type:J$d})],C$6.prototype,"camera",null),e$x([d$y({})],C$6.prototype,"_contentCamera",void 0),e$x([d$y({type:J$d})],C$6.prototype,"contentCamera",null),e$x([d$y({readOnly:!0})],C$6.prototype,"fixedContentCamera",null),e$x([d$y({readOnly:!0})],C$6.prototype,"constraints",void 0),e$x([d$y({readOnly:!0})],C$6.prototype,"events",void 0),e$x([d$y({readOnly:!0})],C$6.prototype,"isGlobal",null),e$x([d$y({readOnly:!0})],C$6.prototype,"isLocal",null),e$x([d$y({readOnly:!0})],C$6.prototype,"viewingMode",void 0),e$x([d$y({readOnly:!0})],C$6.prototype,"spatialReference",void 0),e$x([d$y({readOnly:!0})],C$6.prototype,"navigating",null),e$x([d$y({readOnly:!0})],C$6.prototype,"stationary",null),e$x([d$y()],C$6.prototype,"_cameraChanged",void 0),e$x([d$y()],C$6.prototype,"cameraController",null),C$6=e$x([i$H("esri.views.3d.state.ViewState")],C$6);const g$e=C$6,y$c=new J$d,f$d={camera:null},w$9={camera:null};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function c$k(e,t,i){return 1===e?new u$j(i):new l$i(t,i)}class l$i{constructor(e,t){this.elevationProvider=e,this._referenceEllipsoid=p$K(t),this.unitInMeters=H$k(t,this._referenceEllipsoid.metersPerDegree);}compute(r,m,o,x,c){c||(c={near:0,far:0});let l=r[2]*this.unitInMeters;const u=l,p=l-x,j=this.elevationProvider?this.elevationProvider.elevationBounds:null;j&&(l=p>=0?u-this.unitInMeters*j.min:this.unitInMeters*j.max-u);const E={x:(o=r$A(o)?o:new M$g({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-o.xmin,y:o.ymax-o.ymin,z:4*Math.max(o.xmax-o.xmin,o.ymax-o.ymin)},_=Math.max(E.x,E.y,E.z);c$O(I$6,m,r),v$c[0]=I$6[0]>0?o.xmax:o.xmin,v$c[1]=I$6[1]>0?o.ymax:o.ymin,v$c[2]=I$6[2]>0?_/2:-_/2,c$O(v$c,v$c,r),j$p(I$6,I$6);const g=1.1*z$i(v$c,I$6)*this.unitInMeters,b=Math.sqrt(l*(l+2*this._referenceEllipsoid.radius)),z=Math.max(o.xmax-o.xmin,o.ymax-o.ymin),P=z*d$i*this.unitInMeters,w=z*y$b*this.unitInMeters;let k=e$B((l-w)/(P-w),0,1);k*=k*k;let q=s$F(b,g,k);return q*=Math.max(Math.log(Math.abs(p)),1),q=Math.min(q,Math.max(34064e4,_)),q/=this.unitInMeters,M$7(q,f$c,this.unitInMeters,c)}}class u$j{constructor(e){this._referenceEllipsoid=p$K(e);}compute(e,i,r,n,s){s||(s={near:0,far:0});const a=s$x(e)-this._referenceEllipsoid.radius,o=this._referenceEllipsoid.radius+Math.min(0,n),h=Math.abs(a-n),x=Math.max(h,Math.abs(a));return M$7(1.2*Math.sqrt(x*(x+2*o)),e$B(2e4-(Math.log(x)-7.983)/9.011*19e3,1e3,2e4),1,s)}}function M$7(e,t,i,r){const n=p$i/i;return e/t>n?(r.far=e,r.near=r.far/t):(r.near=n,r.far=r.near*t),r}const f$c=2e4,p$i=2,d$i=.001,y$b=1e-4,v$c=n$F(),I$6=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let n$n=class extends p$N{constructor(e){super(e),this.handles=new u$D;}initialize(){this.handles.add(this.view.basemapTerrain.on("elevation-change",(e=>this.handleElevationChangeEvent(e))));}destroy(){this.handles&&(this.handles.destroy(),this.handles=null);}handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;p$E(this.view,t,e.extent,e.spatialReference)&&this.applyToCurrentCamera();}applyToCurrentCamera(){this.view.state.updateCamera((e=>{i$q(this.view,e,1);}));}};e$x([d$y({constructOnly:!0})],n$n.prototype,"view",void 0),n$n=e$x([i$H("esri.views.3d.state.ElevationCollisionConstraint")],n$n);const p$h=n$n;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let m$i=class extends p$N{constructor(t){super(t),this._handles=new u$D,this.nearFarHeuristic=c$k(t.view.state.viewingMode,t.view.basemapTerrain,t.view.renderCoordsHelper.spatialReference);}initialize(){this._handles.add([this.view.watch(["constraints.clipDistance.near","constraints.clipDistance.far"],(()=>this._clipDistanceNearFarChanged())),this.view.watch("constraints.clipDistance.mode",(()=>this._updateNearFar())),this.view.state.events.on("before-camera-change",(t=>this._updateCameraNearFar(t.camera))),this.view.watch("renderDataExtent",(()=>this._updateNearFar()),!0),this.view.watch(["constraints.altitude.min","constraints.altitude.max"],(()=>this._updateAltitude()),!0),this.view.watch("constraints.tilt.max",(()=>this._updateTiltMax()),!0),this.view.watch("constraints.tilt.mode",(()=>this._updateTilt()),!0),this.view.watch("state.camera",(()=>this._updateTiltAutoMax()),!0),this.view.watch(["map.ground.navigationConstraint.type","constraints.collision.enabled"],(()=>this._updateCollision()),!0)]),this.view.state.isLocal&&this._handles.add(i$P(this.view,"renderDataExtent",(t=>this._updateLocalSurfaceDistance(t)))),this._updateNearFar(),2!==this.view.state.viewingMode&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new p$h({view:this.view}));}destroy(){this._handles=l$E(this._handles),this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null));}_clipDistanceNearFarChanged(){var t;const a=null==(t=this.view.constraints)?void 0:t.clipDistance;a&&"auto"!==a.mode&&this.view.state.updateCamera((t=>(this._updateCameraNearFarManual(t,a),!0)));}_updateNearFar(){this.view.state.updateCamera((t=>(this._updateCameraNearFar(t),!0)));}_updateCameraNearFar(t){const a=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(a?a.mode:"auto")?this._updateCameraNearFarManual(t,a):this._updateCameraNearFarAuto(t,a);}_updateCameraNearFarAuto(t,a){this.nearFarHeuristic.compute(t.eye,t.center,this.view.renderDataExtent,m$y(this.view,t.eye),t),a&&a.autoUpdate(t.near,t.far);}_updateCameraNearFarManual(t,a){a&&(t.near=a.near,t.far=a.far);}_updateCollision(){var t,a,i;const e=null==(t=this.view.map)||null==(a=t.ground)||null==(i=a.navigationConstraint)?void 0:i.type,s=!e||"stay-above"===e,r=this.view.state.constraints.collision;if(s!==r.enabled){r.enabled=s,s&&this._reapplyConstraints(8);const t=this.view.constraints&&this.view.constraints.tilt;t&&"auto"!==t.mode||this._updateTiltAuto();}}_updateAltitude(){const t=this.view.constraints&&this.view.constraints.altitude;t&&2!==this.view.state.viewingMode?this.view.state.constraints.altitude={min:t.min,max:t.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints();}_updateTiltMax(){const t=this.view.constraints&&this.view.constraints.tilt;t&&"auto"!==t.mode&&(this._updateTiltManual(t),this._reapplyConstraints());}_updateTilt(){const t=this.view.constraints&&this.view.constraints.tilt;"manual"===(t?t.mode:"auto")?this._updateTiltManual(t):this._updateTiltAuto(),this._reapplyConstraints();}_updateTiltManual(t){const a=this.view.state.constraints;a.tilt=a.createConstantMaxTilt(M$f(t.max));}_updateTiltAuto(){const t=this.view.state.constraints;t.tilt=t.createDefaultTilt(),this._updateTiltAutoMax();}_updateTiltAutoMax(){const t=this.view.constraints&&this.view.constraints.tilt;if(!t||"auto"!==t.mode)return;const a=this.view.state.constraints;if(a.tilt){const i=a.tilt(this.view.state.camera.distance).max;t.autoUpdate(m$z(i));}}_updateLocalSurfaceDistance(t){if(t$F(t))return;let a=Math.max(t.width,t.height);if(a<=0)return;t.hasZ&&(a=Math.max(a,t.zmax-t.zmin));const i=this.view.state,e=3*a/Math.atan(i.camera.fov/2);e!==i.constraints.distance&&(i.constraints.distance=e);}_reapplyConstraints(t=15){this.view.state.updateCamera((a=>p$n(this.view,a,{selection:t,interactionType:0,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:0})));}};e$x([d$y({constructOnly:!0})],m$i.prototype,"view",void 0),e$x([d$y({readOnly:!0})],m$i.prototype,"surfaceCollisionConstraint",void 0),m$i=e$x([i$H("esri.views.3d.state.ConstraintsManager")],m$i);const w$8=m$i;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let l$h=class extends i$l{constructor(e){super(e),this.handles=new u$D;}set desiredCamera(e){this._set("desiredCamera",e.clone());}get canStop(){return !0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=o$p.Running,this.handles.add(this.view.basemapTerrain.on("elevation-change",(e=>this.handleElevationChangeEvent(e)))),this.applyCorrection();}onControllerEnd(){this.handles.removeAll();}stepController(){}handleElevationChangeEvent(e){p$E(this.view,this.desiredCamera,e.extent,e.spatialReference)&&this.applyCorrection();}applyCorrection(){this.view.state.updateCamera((e=>{e.copyViewFrom(this.desiredCamera),i$q(this.view,e,1)||this.constraintEnabled||(this.state=o$p.Stopped);}));}};e$x([d$y({constructOnly:!0})],l$h.prototype,"view",void 0),e$x([d$y({constructOnly:!0})],l$h.prototype,"desiredCamera",null),l$h=e$x([i$H("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],l$h);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class v$b{constructor(t,i,e){this.target=t,this.options=i,this.view=e,this.state="pending",this.abortController=null,this.animationController=null,this.promise=new Promise(((t,i)=>{this.resolveCallback=t,this.rejectCallback=i;const e=new AbortController;r$A(this.options.signal)&&j$t(this.options.signal,(()=>{this.abort();})),this.abortController=e,this.waitForReady();}));}then(t,i){return this.promise.then(t,i)}catch(t){return this.promise.catch(t)}resolve(t){return this.state="finished",this.resolveCallback(t)}reject(t){return this.state="finished",this.rejectCallback(t)}abort(t=!1){switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":this.reject(m$D());break;case"wait-for-animation-finish":!t&&r$A(this.animationController)&&this.view.state.cameraController===this.animationController&&this.animationController.active&&this.animationController.stopController(),this.reject(m$D());}}waitForReady(){this.state="wait-for-ready",this.view.ready?this.createViewPoint():a$11(this.view,"ready",this.abortController.signal).then((()=>{this.createViewPoint();}),(t=>{this.reject(t);}));}createViewPoint(){"finished"!==this.state&&(this.state="wait-for-viewpoint",this.animationController=this.options.animate?this.getAnimationController():null,ge(this.view,this.target,this.abortController.signal).then((t=>{if("finished"===this.state)return;const i=this.getCameraFromViewpoint(t);if(!t$F(i))if(this.options.animate){if(t$F(this.animationController))return;this.startAnimation(i,this.animationController);}else this.view.stateManager.setStateCamera(i.camera,{applyConstraints:!i.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve();}),(t=>{this.reject(t);})));}getCameraFromViewpoint(a){const o=!!(this.target instanceof u$z&&this.target.camera||this.target instanceof d$A),r=a.camera;if(t$F(r))return null;if(!this.view.stateManager.isCompatible(r)){const t=r.position,i=t&&t.spatialReference,a=i?i.wkid:"none",n=this.view.spatialReference.wkid;return this.reject(new s$w("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${a}, view: ${n})`,{camera:r})),null}const s=J$b(this.view,r);return t$F(s)?(this.reject(new s$w("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:a,camera:s,isFullySpecified:o}}startAnimation(t,i){this.state="wait-for-animation-finish";const o=i.viewAnimation;if(t$F(o))return void this.reject(new s$w("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(o.update(t.viewpoint,"running"),!i.active||t$F(i.viewAnimation)||i.viewAnimation.target!==t.viewpoint||this.view.state.cameraController!==i)return this.abort();let r;t.isFullySpecified?(r=new l$h({view:this.view,desiredCamera:t.camera}),i$q(this.view,t.camera,1)):p$n(this.view,t.camera),i.begin(t.camera,this.options);const s=()=>{const e=this.view.state.cameraController;r&&(e&&e.active?e instanceof h$g&&r$A(e.viewAnimation)&&e.viewAnimation.target===t.viewpoint&&(this.view.state.cameraController=r):r$A(i.viewAnimation)&&i.viewAnimation.target===t.viewpoint&&"finished"===i.state&&(this.view.state.cameraController=r));},w=t=>{if(!t$F(this.view.state))switch(i.state){case o$p.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.resolve();}break;case o$p.Ready:case o$p.Rejected:case o$p.Running:case o$p.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.reject(t);}}};o.when(s,(t=>w(t))),i.asyncResult={resolve:()=>w(),reject:t=>w(t)};}getAnimationController(){let t,i=null;const n=this.view.state.cameraController;return n instanceof h$g&&(n.updateStateFromViewAnimation(),n.active&&(t=n,i=t.viewAnimation)),null!=t||(t=new h$g({view:this.view,mode:"animation"}),i=t.viewAnimation,this.view.state.switchCameraController(t))?t:(r$A(i)&&i.stop(),this.reject(new s$w("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const G$5=s$y.getLogger("esri.views.3d.state.ViewStateManager");let D$6=class extends p$N{constructor(e){super(e),this.propertiesPool=new o$O({frustum:c$l},this),this.handles=new u$D,this.cameraSetByUser=!1,this.gotoOperation=null,this.ready=!1,this.updateDevicePixelRatio=null,this.test={contentCameraResetState:new Map};}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=Q$c(this.view,this.view.state.camera);return t&&e&&t.equals(e)?e:t}set camera(e){this.updatePropertyBeforeReady("camera",e)||(this.view.elevationProvider.enableElevationCache(!0),this.setStateCamera(J$b(this.view,e),{applyConstraints:!1})||G$5.error("#camera=","Invalid camera",e),this.view.elevationProvider.enableElevationCache(!1));}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=Q$c(this.view,this.view.state.contentCamera);return t&&e&&t.equals(e)?e:t}set contentCamera(e){if(this.updatePropertyBeforeReady("contentCamera",e))return;const t=J$b(this.view,e);t$F(t)?this.view.state.contentCamera=null:(this.updateElevation(t),this.view.state.contentCamera=t);}installContentCameraReset(e){if(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return !1;const t=this.zoom,i=this.view.state.camera.distance**2,r=e$N(this.view.state.camera.center),a=e.sticky?this.contentCamera.clone():null;return this.handles.add([this.watch("contentCamera",(()=>{e.sticky||(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear());})),this.watch("zoom",(e=>{this.test.contentCameraResetState.set("view.zoom",Math.abs(e-t)/2),Math.abs(e-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=a);})),this.view.state.watch("camera",(e=>{const t=x$p(r,e.center);this.test.contentCameraResetState.set("camera.center",t/i),t>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=a);}))],"contentCameraReset"),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this.updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this.centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():G$5.error("#center=","Invalid center",e):G$5.error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):G$5.error("#center=","Center may not be null or undefined"));}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=ce$2(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return r$A(t)?t:this._get("extent")}set extent(e){this.updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this.extentToCamera(e),{applyConstraints:!0})||G$5.error("#extent=","Invalid extent",e):G$5.error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):G$5.error("#extent=","Extent may not be null or undefined"));}get frustum(){const e=this.propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get hasInitialView(){return !!this.view.get("map.initialViewProperties.viewpoint")}get scale(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return $$8(this.view,e.distance,e.location.latitude)}return this._get("scale")}set scale(e){this.updatePropertyBeforeReady("scale",e)||this.setStateCamera(this.scaleToCamera(e),{applyConstraints:!0})||G$5.error("#scale=","Invalid scale",e);}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),a=Math.round(t[0]/i),s=Math.round(t[1]/i),n=Math.round(t[2]/i),o=Math.round(t[3]/i);return null!=r&&r.top===a&&r.right===s&&r.bottom===n&&r.left===o?r:{top:a,right:s,bottom:n,left:o}}set padding(e){this.updatePropertyBeforeReady("padding",e)||(this.paddingToArray(e,this.view.state.camera.pixelRatio,X$3),this.view.state.updateCamera((e=>e.padding=X$3)));}paddingToArray(e,t,i){e?r$P(i,e.top||0,e.right||0,e.bottom||0,e.left||0):r$P(i,0,0,0,0);for(let r=0;r<4;r++)i[r]=Math.round(i[r]*t);}get screenCenter(){const e=this.padding;return c$X((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?pe$1(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this.updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this.viewpointToCamera(e),{applyConstraints:!e.camera})||G$5.error("#viewpoint=","Invalid viewpoint",e);else {const t=r$A(e.camera)?e.camera.position:e.targetGeometry,i=r$A(t)&&t.spatialReference;G$5.error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e);}else G$5.error("#viewpoint=","Viewpoint may not be null or undefined");}get zoom(){return this.ready?ye$1(this.view,this.scale):this._get("zoom")}set zoom(e){this.updatePropertyBeforeReady("zoom",e)||this.setStateCamera(this.zoomToCamera(e),{applyConstraints:!0})||G$5.error("#zoom=","Invalid zoom",e);}initialize(){this.handles.add([$$9(this.view,"state.events","before-camera-change",(e=>this.updateElevation(e.camera)))]),l$L(this.view.state,"camera",(e=>this.updateElevation(e)),!0),this.handles.add(A$n({prepare:()=>this.prepareFrame()})),this.handles.add(this.view.state.watch("cameraController",(()=>{this.cameraSetByUser=!0,this.handles.remove(Y$4);}))),this.handles.add($$9(this.view,"state.events","camera-projection-changed",(()=>this.notifyChange("scale"))));}destroy(){this.deinit(),this.handles&&(this.handles.destroy(),this.handles=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null);}init(){this.constraintsManager=new w$8({view:this.view}),this.prepareFrame();const e=this.getInitialProperties();this.cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this.cameraSetByUser){const e=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;e&&this.isCompatible(e)?this.setInitialView(e):2===this.view.state.viewingMode&&this.handles.add(a$11(this.view.basemapTerrain,"ready",(()=>{this.handles.remove(Y$4),this.setInitialView(this.view.dataExtent);})),Y$4);}}deinit(){this.cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this.cameraSetByUser=!1,this.handles.remove(Y$4),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null));}async goTo(e,t){const i={animate:!0,...t};return r$A(this.gotoOperation)&&this.gotoOperation.abort(i.animate),this.gotoOperation=new v$b(e,i,this.view),this.view.resourceController.scheduler.stopFrame(),this.gotoOperation}debugSetCameraOnContent(){this.setStateCamera(g$t(this.view),{applyConstraints:!1});}step(e){const t=this.view.state,i=t&&this.view.state.cameraController;i&&(t.updateCamera((t=>{i.stepController(e,t);})),i.steppingFinished&&i.finishController());}cancelGoToOperation(){r$A(this.gotoOperation)&&(this.gotoOperation.abort(),this.gotoOperation=null);}getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:r}of W$5){const a=e.has(i),s=this._isOverridden(i);!a&&s&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(a||s)&&r.forEach((t=>e.add(t)));}return t}setInitialView(e){if(t$F(e)||this.cameraSetByUser)return;if(e instanceof d$A)return void this.setStateCamera(J$b(this.view,e),{applyConstraints:!1});if(e instanceof u$z){if(e.targetGeometry instanceof M$g){const t=le$3(this.view,e.targetGeometry,0,.5,0);return void(r$A(t)&&this.setStateCamera(J$b(this.view,t),{applyConstraints:!0}))}const t={applyConstraints:!e.camera},i=this.viewpointToCamera(e);return void this.setStateCamera(i,t)}const r=le$3(this.view,e,0,.5,0);r$A(r)&&this.setStateCamera(J$b(this.view,r),{applyConstraints:!0});}updatePropertyBeforeReady(e,t){return !this.ready&&(this._override(e,t),t&&-1!==q$5.indexOf(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return !t$F(e)&&(e instanceof u$z?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof d$A?this.isCompatible(e.position):e.spatialReference&&g$u(e.spatialReference,this.view.spatialReference))}getPreservingHeadingTilt(e=J$6){return this.cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}centerPointAtDistanceToCamera(e,t,i=Q$4){const{heading:r,tilt:a}=this.getPreservingHeadingTilt(),s=ae$2(this.view,r,a,e,t,1);return t$F(s)?null:(i.copyFrom(this.view.state.camera),i.eye=s.eye,i.center=s.center,i.up=s.up,i)}centerToCamera(e){const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.distance;return this.centerPointAtDistanceToCamera(e,i)}extentToCamera(e){const{heading:t,tilt:i}=this.getPreservingHeadingTilt(),r=le$3(this.view,e,t,i,1,K$6);return r$A(r)?J$b(this.view,r):null}scaleToCamera(e){if(null==e)return null;const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.renderLocation,r=t.location.latitude,a=V$c(this.view,e,r);return this.centerPointAtDistanceToCamera(i,a)}zoomToCamera(e){return this.scaleToCamera(Re$1(this.view,e))}viewpointToCamera(e){return J$b(this.view,ue$1(this.view,e))}setStateCamera(e,t){return !(t$F(e)||!this.view.state.stopActiveCameraController())&&(this.cameraSetByUser=!0,t.doNotCancelGoToOperation||this.cancelGoToOperation(),this.view.state.updateCamera((i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up):i.copyFrom(e),t.applyConstraints&&p$n(this.view,i);})),t.applyConstraints||(this.view.state.cameraController=new l$h({view:this.view,desiredCamera:e})),!0)}prepareFrame(){const{container:e,canvas:t}=this.view;if(!e||!t)return;r$A(this.updateDevicePixelRatio)&&this.updateDevicePixelRatio();const i=this.view.pixelRatio,r=Math.round(e.clientWidth*i),a=Math.round(e.clientHeight*i);if(0!==r&&0!==a&&(t.width===r&&t.height===a||(t.width=r,t.height=a),this.view.state)){const e=this.view.state.camera;e.fullWidth===r&&e.fullHeight===a&&e.pixelRatio===i||(Q$4.copyFrom(e),Q$4.pixelRatio!==i&&(this.paddingToArray(this.padding,i,X$3),Q$4.padding=X$3),Q$4.fullWidth=r,Q$4.fullHeight=a,Q$4.pixelRatio=i,this.view.state.camera=Q$4);}}updateElevation(e){const t=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=this.view.renderCoordsHelper.getAltitude(e.eye),r=t?m$y(this.view,e.eye):0;e.relativeElevation=i-r,e.distanceFromSurface=this.view.pointsOfInterest?this.view.pointsOfInterest.centerOnSurfaceFrequent.distance:-1;}};e$x([d$y({type:d$A,dependsOn:["view.state.camera","ready"]})],D$6.prototype,"camera",null),e$x([d$y({type:d$A,dependsOn:["view.state.contentCamera","ready"]})],D$6.prototype,"contentCamera",null),e$x([d$y({type:b$m})],D$6.prototype,"center",null),e$x([d$y({type:M$g})],D$6.prototype,"extent",null),e$x([d$y({readOnly:!0})],D$6.prototype,"frustum",null),e$x([d$y({readOnly:!0})],D$6.prototype,"hasInitialView",null),e$x([d$y({readOnly:!0,type:Boolean})],D$6.prototype,"ready",void 0),e$x([d$y({type:Number})],D$6.prototype,"scale",null),e$x([d$y()],D$6.prototype,"padding",null),e$x([d$y({readOnly:!0})],D$6.prototype,"screenCenter",null),e$x([d$y({constructOnly:!0})],D$6.prototype,"view",void 0),e$x([d$y({type:u$z})],D$6.prototype,"viewpoint",null),e$x([d$y({type:Number})],D$6.prototype,"zoom",null),e$x([d$y({constructOnly:!0})],D$6.prototype,"updateDevicePixelRatio",void 0),D$6=e$x([i$H("esri.views.3d.state.ViewStateManager")],D$6);const L$7=D$6,q$5=["camera","viewpoint","extent","scale","center","zoom"],W$5=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],J$6={heading:0,tilt:0},K$6=new d$A,Q$4=new J$d,X$3=n$P(),Y$4="pending-initial-view";

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class v$a{constructor(e,t,r){this.viewingMode=e,this._forEachLayer=t,this.view=r,this.externalIntersectionHandlers=new n$Z,this.tolerance=y$s.DEFAULT_TOLERANCE,this.tmpRay=d$G(),this.validateHUDIntersector=new y$s(this.viewingMode),this.validateHUDIntersector.options.hud=!1;}intersectScreen(e,t){return this.intersectRay(this._getPickRay(e,this.tmpRay),I$5(this.viewingMode),t)}intersectScreenFreePointFallback(e,t){return this.intersectRayFreePointFallback(this._getPickRay(e,this.tmpRay),t)}intersectRayFreePointFallback(e,t){return this.intersectRay(e,I$5(this.viewingMode),t)||this._intersectRayFreePointLocal(e,t)}intersectRay(e,t,r,i){return t.options.selectionMode=!1,t.options.store=0,this.computeIntersection(e,t,i),!!t.results.min&&t.results.min.getIntersectionPoint(r)}getCenterRayWithSubpixelOffset(e,t,r=.5,i=.5){return e.getRenderCenter(b$7,r,i),b$7[0]+=.0466,b$7[1]-=.0123,g$x(e,b$7,t)}intersectIntersectorScreen(e,t,r){this.computeIntersection(this._getPickRay(e,this.tmpRay),t,r);}intersectToolIntersectorScreen(e,t,r){const i=this._getPickRay(e,this.tmpRay);this.intersectToolIntersectorRay(i,t,r);}intersectToolIntersectorRay(e,t,r){t.options.selectionMode=!0,this.computeIntersection(e,t,r);const i=t.results.min;!!this.view.basemapTerrain&&this.view.basemapTerrain.opaque||i.hasIntersectionPoint&&"TerrainRenderer"!==i.intersector||(t.options.selectionMode=!1,this.computeIntersection(e,t,r));}setTolerance(e=y$s.DEFAULT_TOLERANCE){this.tolerance=e;}addIntersectionHandler(e){this.externalIntersectionHandlers.push(e),this.externalIntersectionHandlers.sort(((e,t)=>"Terrain"===e.type?1:"Terrain"===t.type?-1:0));}removeIntersectionHandler(e){this.externalIntersectionHandlers.removeUnordered(e),this.externalIntersectionHandlers.sort(((e,t)=>"Terrain"===e.type?1:"Terrain"===t.type?-1:0));}_getPickRay(e,t){const r=this.view.state.camera;return s$G(r,e,t)}_intersectRayFreePointLocal(t,r){if(2!==this.viewingMode||t$F(t))return !1;const i=this.view.renderDataExtent;if(t$F(i))return u$A(r,t.origin,j$p(c$T.get(),t.direction)),!0;const n={x:i.xmax-i.xmin,y:i.ymax-i.ymin,z:8*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},s=Math.max(n.x,n.y,n.z);if(0===s)return u$A(r,t.origin,j$p(c$T.get(),t.direction)),!0;const h=this.view.state.camera,d=Math.max(0,i.xmin-h.eye[0],h.eye[0]-i.xmax),u=Math.max(0,i.ymin-h.eye[1],h.eye[1]-i.ymax),y=Math.sqrt(d*d+u*u),p=Math.abs(h.relativeElevation)+Number.MIN_VALUE,g=Math.max(0,Math.log(s/p))**2;let f=s/Math.max(1,g);f=Math.max(f,Math.min(y,s));const v=d$z(c$T.get(),t.direction,f/s$x(t.direction));return u$A(r,t.origin,v),!0}intersectElevationFromScreen(e,t,r=0,i=null){return this.intersectElevation(this._getPickRay(e,this.tmpRay),t,r,i)}intersectElevation(i,s,a=0,c=null){if(t$F(i))return null;const l=r$A(s)?s.mode:"absolute-height",h=r$A(s)?c$N(s.offset,0):0,d="on-the-ground"!==l?h+a:0,u=d/this.view.renderCoordsHelper.unitInMeters;if("absolute-height"===l){if(this.view.renderCoordsHelper.intersectInfiniteManifold(i,d,P$9)){const e=this.view.computeMapPointFromVec3d(P$9);return e.z-=h,e}return null}const y=this.view.state.camera,p=p$U(c$T.get());y.projectToRenderScreen(i.origin,p);const v=new w$7(null,this._forEachLayer),R=this.view.slicePlane,I=r$A(R)?g$y(R):null,x=new y$s(this.viewingMode);x.options.store=0,x.options.verticalOffset=u;const b=i.origin,M=u$A(c$T.get(),b,i.direction);x.reset(b,M),x.point=p,x.camera=y,x.filterPredicate=null;const H=r$A(c)?"type"in c&&"graphics"===c.type?e=>e.metadata.layerUid!==c.uid:e=>e.metadata.graphicUid!==c.uid:null;switch(l){case"relative-to-scene":{const t=t=>(t$F(H)||H(t))&&t.metadata&&t.metadata.isElevationSource;x.intersect(v.layers,p,y,this.tolerance,null,t),this.externalIntersectionHandlers.forAll((e=>{if("I3S"===e.type||"Terrain"===e.type){const t=e.slicePlane?I:null;e.intersect(x,t,x.rayBeginPoint,x.rayEndPoint,p);}}));}break;case"on-the-ground":case"relative-to-ground":this.externalIntersectionHandlers.forAll((e=>{if(e.isGround){const t=e.slicePlane?I:null;e.intersect(x,t,x.rayBeginPoint,x.rayEndPoint,p);}}));}if(x.results.min.getIntersectionPoint(P$9)){const e=this.view.computeMapPointFromVec3d(P$9);return e.z=a,e}return null}computeIntersection(i,s,a){if(t$F(i))return;const c=this.view.state.camera,l=p$U(c$T.get());c.projectToRenderScreen(i.origin,l);const d=new w$7(a,this._forEachLayer);s.options.selectOpaqueTerrainOnly=!a||!("include"in a||"exclude"in a);const u=i.origin,y=u$A(c$T.get(),i.origin,i.direction);s.reset(u,y),s.intersect(d.layers,l,c,this.tolerance);const p=this.view.slicePlane,g=r$A(p)?g$y(p):null;s.intersect(d.sliceableLayers,l,c,this.tolerance,g);const v=a&&(a.requiresGroundFeedback||a.enableDraped);this.externalIntersectionHandlers.forAll((e=>{if(s.options.isFiltered=!d.filterLayerUid(e.intersectionHandlerId),e.isGround&&v||!s.options.isFiltered){const t=e.slicePlane?g:null;e.intersect(s,t,u,y,l);}}));const R=c$T.get();if(a&&a.enableDraped&&s.results.ground.getIntersectionPoint(R)){const e=this.view.basemapTerrain.overlayManager.renderer,t=this.view.renderCoordsHelper.spatialReference,i=c$T.get();this.view.renderCoordsHelper.fromRenderCoords(R,i,this.view.spatialReference),i[2]=c$N(this.view.elevationProvider.getElevation(R[0],R[1],R[2],t,"ground"),0),e.intersect(s,i,(e=>d.filterRenderGeometry(e)));}s.sortResults();const I=s.results.hud;if(I.hasIntersectionPoint){const e=p$U(c$T.get()),t=c$T.get(),r=c$T.get();this.unprojectHUDResultRay(I.center,e,t,r);const i=q$g(I.center,t)/q$g(t,r)*.99;this.validateHUDIntersector.reset(t,r),this.validateHUDIntersector.intersect(d.layers,e,c,this.tolerance),this.validateHUDIntersector.intersect(d.sliceableLayers,e,c,this.tolerance,g),this.externalIntersectionHandlers.forAll((i=>{if(!d.filterLayerUid(i.intersectionHandlerId))return;const n=i.slicePlane?g:null;i.intersect(this.validateHUDIntersector,n,t,r,e);}));const o=this.validateHUDIntersector.results.min;(null==o.dist||i<=o.dist)&&(s.results.min.copyFrom(I),s.results.all.splice(0,0,I));}}unprojectHUDResultRay(e,t,r,i){const s=this.view.state.camera;s.projectToRenderScreen(e,t);const o=p$U(c$T.get());o[0]=t[0],o[1]=t[1],o[2]=0,s.unprojectFromRenderScreen(o,r),o[2]=1,s.unprojectFromRenderScreen(o,i);}}let R$8;function I$5(e){return R$8||(R$8=new y$s(e)),R$8.viewingMode=e,R$8}class w$7{constructor(e,t){this.layers=new Array,this.sliceableLayers=new Array,this.include=null==e?void 0:e.include,this.exclude=null==e?void 0:e.exclude,t((e=>{e.isPickable&&this.filterLayerUid(e.apiLayerUid)&&(e.isSliceable?this.sliceableLayers:this.layers).push(e);}));}filterLayerUid(t){const{include:r,exclude:i}=this;return t$F(t)?null==r&&null==i:(null==r||r.has(t))&&(null==i||!i.has(t))}filterRenderGeometry(e){return this.filterLayerUid(e.layerUid)}}function x$9(e){return "object"==typeof e&&"intersect"in e}const P$9=n$F(),b$7=x$r();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let u$i=class extends(n$L.EventedMixin(p$N)){constructor(e){super(e),this.im=new Array,this.ground=new Array,this.scene=new Array,this.handles=new Map,this.lastElevationQuery=null,this.elevationCacheEnabled=!1;}destroy(){this._elevationQuery=l$E(this._elevationQuery);}get elevationQuery(){return t$F(this._elevationQuery)&&(this._elevationQuery=new a$12(this.view.resourceController.scheduler,this.view.spatialReference,(()=>this.view.map&&this.view.map.ground),{maximumAutoTileRequests:4})),this._elevationQuery}enableElevationCache(e){e||(this.lastElevationQuery=null),this.elevationCacheEnabled=e;}getElevation(e,t,s,r,o){if(this.elevationCacheEnabled&&null!=this.lastElevationQuery){const i=this.lastElevationQuery;if(e===i.x&&t===i.y&&s===i.z&&r.equals(i.spatialReference)&&o===i.queryContext)return i.result}let n=null;return n=p$g(n,this.im,e,t,s,r,o),t$F(n)&&(n=p$g(n,this.ground,e,t,s,r,o)),"scene"===o&&(n=p$g(n,this.scene,e,t,s,r,o)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:s,spatialReference:r,queryContext:o,result:n}),n}queryElevation(e,t,s,r,i,o=null,l=0){const c=B$f();return this.elevationQuery.queryElevation(e,t,o,l).then((o=>{"scene"===i&&(o=p$g(o,this.scene,e,t,s,r,i)),c.resolve(o);})).catch((o=>{d$B(o)?c.reject(o):c.resolve(this.getElevation(e,t,s,r,i));})),c.promise}register(e,t){this.handles.set(t,t.on("elevation-change",(e=>this.emit("elevation-change",e)))),this[e].push(t);}unregister(e){this.handles.has(e)&&(this.handles.get(e).remove(),this.handles.delete(e));for(const t of [this.im,this.ground,this.scene]){const s=t.indexOf(e);s>-1&&t.splice(s,1);}}};function p$g(e,t,s,r,i,n,a){for(const l of t){const t=l.getElevation(s,r,i,n,a);r$A(t)&&(e=r$A(e)?Math.max(t,e):t);}return e}e$x([d$y({constructOnly:!0})],u$i.prototype,"view",void 0),e$x([d$y({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],u$i.prototype,"spatialReference",void 0),u$i=e$x([i$H("esri.views.3d.support.CombinedElevationProvider")],u$i);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class a$i{static isValidProfile(e){return e in a$i.profiles}static getDefaultProfile(){return s$H("trident")||s$H("esri-iPhone")?"low":"medium"}static apply(e,i){const o=a$i.profiles[e];i.graphics3D.maxTotalNumberOfFeatures=o.graphics3D.maxTotalNumberOfFeatures,i.graphics3D.maxTotalNumberOfPrimitives=o.graphics3D.maxTotalNumberOfPrimitives,i.graphics3D.polygonLodFactor=o.graphics3D.polygonLodFactor,i.graphics3D.polylineLodFactor=o.graphics3D.polylineLodFactor,i.graphics3D.snapshotAvailable=o.graphics3D.snapshotAvailable;{const e=i.sceneService["3dObject"],a=o.sceneService["3dObject"];e.lodFactor=a.lodFactor,e.lodCrossfadeinDuration=a.lodCrossfadeinDuration,e.lodCrossfadeoutDuration=a.lodCrossfadeoutDuration,e.lodCrossfadeUncoveredDuration=a.lodCrossfadeUncoveredDuration;}i.sceneService.point.lodFactor=o.sceneService.point.lodFactor,i.sceneService.integratedMesh.lodFactor=o.sceneService.integratedMesh.lodFactor,i.sceneService.pointCloud.lodFactor=o.sceneService.pointCloud.lodFactor,i.sceneService.uncompressedTextureDownsamplingEnabled=o.sceneService.uncompressedTextureDownsamplingEnabled,i.tiledSurface.lodBias=o.tiledSurface.lodBias,i.tiledSurface.angledSplitBias=o.tiledSurface.angledSplitBias,i.tiledSurface.reduceTileLevelDifferences=o.tiledSurface.reduceTileLevelDifferences,i.tiledSurface.textureFadeDuration=o.tiledSurface.textureFadeDuration,i.antialiasingEnabled=o.antialiasingEnabled,i.physicallyBasedRenderingEnabled=o.physicalBasedRenderingEnabled,i.highQualityTransparency=o.highQualityTransparency,i.memoryLimit=o.memoryLimit,i.additionalCacheMemory=o.additionalCacheMemory,i.frameRate=o.frameRate,i.maximumRenderResolution=o.maximumRenderResolution,i.maximumPixelRatio=o.maximumPixelRatio;}}function i$c(){const a=!!s$H("esri-mobile"),i=!!s$H("ios");return {low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxTotalNumberOfPrimitives:85e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1},sceneService:{"3dObject":{lodFactor:.2,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:0},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,reduceTileLevelDifferences:!1,textureFadeDuration:0},antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,memoryLimit:200,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:a?.8:1,polylineLodFactor:a?1.2:1.5,snapshotAvailable:!i},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:a},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!s$H("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:a?600:750,additionalCacheMemory:a?0:150,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:a?1.2:2,polylineLodFactor:a?1.2:2,snapshotAvailable:!i},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!s$H("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:a?900:1500,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:a?null:4096,maximumPixelRatio:a?1:null}}}a$i.debug={reset(){const e=i$c();for(const i in e)a$i.profiles[i]=e[i];}},function(e){e.profiles=i$c();}(a$i||(a$i={}));const o$l=a$i;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let c$j=class extends p$N{constructor(){super(...arguments),this.color=new h$s([0,255,255]),this.haloColor=null,this.haloOpacity=1,this.fillOpacity=.25,this.shadowOpacity=.4,this.shadowColor=new h$s([0,0,0]),this.shadowDifference=.2;}static toEngineOptions(o){const r=h$s.toUnitRGBA(o.color),i=r$A(o.haloColor)?h$s.toUnitRGBA(o.haloColor):r,p=h$s.toUnitRGBA(o.shadowColor);return {color:r$V(r[0],r[1],r[2],r[3]),haloColor:r$V(i[0],i[1],i[2],i[3]),haloOpacity:o.haloOpacity,haloOpacityOccluded:.25*o.haloOpacity,fillOpacity:o.fillOpacity,fillOpacityOccluded:.25*o.fillOpacity,shadowOpacity:o.shadowOpacity,shadowColor:r$V(p[0],p[1],p[2],p[3]),occludedShadowOpacity:o.shadowOpacity*(1-o.shadowDifference)}}};e$x([d$y({type:h$s})],c$j.prototype,"color",void 0),e$x([d$y({type:h$s})],c$j.prototype,"haloColor",void 0),e$x([d$y()],c$j.prototype,"haloOpacity",void 0),e$x([d$y()],c$j.prototype,"fillOpacity",void 0),e$x([d$y()],c$j.prototype,"shadowOpacity",void 0),e$x([d$y({type:h$s})],c$j.prototype,"shadowColor",void 0),e$x([d$y()],c$j.prototype,"shadowDifference",void 0),c$j=e$x([i$H("esri.views.3d.support.HighlightOptions")],c$j);const e$k=c$j;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class a$h{constructor(i,s){this.spatialReference=s,this.unitInMeters=H$k(this.spatialReference,p$K(this.spatialReference).metersPerDegree),this._geometryServiceURLPromise=i$X(i&&i.get("portalItem")).catch((()=>{throw new s$w("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")}));}async toGeographic(e){const r=await this._geometryServiceURLPromise;let t,o=!0;Array.isArray(e[0])&&"number"!=typeof e[0]?t=e:(t=[e],o=!1);const a=t.map((e=>e instanceof b$m?e:new b$m(e,this.spatialReference))),c=new a$13({geometries:a,outSpatialReference:k$l.WGS84}),n=(await n$12(r,c)).map((e=>"point"===e.type?[e.x,e.y]:void 0));return o?n:n[0]}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let s$f=class extends p$N{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxTotalNumberOfPrimitives=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1;}};e$x([d$y()],s$f.prototype,"minTotalNumberOfFeatures",void 0),e$x([d$y()],s$f.prototype,"maxTotalNumberOfFeatures",void 0),e$x([d$y()],s$f.prototype,"maxTotalNumberOfPrimitives",void 0),e$x([d$y()],s$f.prototype,"snapshotAvailable",void 0),e$x([d$y()],s$f.prototype,"polygonLodFactor",void 0),e$x([d$y()],s$f.prototype,"polylineLodFactor",void 0),s$f=e$x([i$H("esri.views.3d.support.QualitySettings.Graphics3DSettings")],s$f);let r$l=class extends p$N{constructor(){super(...arguments),this.lodFactor=1;}};e$x([d$y()],r$l.prototype,"lodFactor",void 0),r$l=e$x([i$H("esri.views.3d.support.QualitySettings.LoDFactorSettings")],r$l);let p$f=class extends r$l{constructor(){super(...arguments),this.lodCrossfadeinDuration=0,this.lodCrossfadeoutDuration=0,this.lodCrossfadeUncoveredDuration=0;}};p$f=e$x([i$H("esri.views.3d.support.QualitySettings.LoDFactor3DObjectSettings")],p$f);let a$g=class extends p$N{constructor(){super(...arguments),this["3dObject"]=new p$f,this.point=new r$l,this.integratedMesh=new r$l,this.pointCloud=new r$l,this.uncompressedTextureDownsamplingEnabled=!1;}};e$x([d$y({type:p$f})],a$g.prototype,"3dObject",void 0),e$x([d$y({type:r$l})],a$g.prototype,"point",void 0),e$x([d$y({type:r$l})],a$g.prototype,"integratedMesh",void 0),e$x([d$y({type:r$l})],a$g.prototype,"pointCloud",void 0),e$x([d$y()],a$g.prototype,"uncompressedTextureDownsamplingEnabled",void 0),a$g=e$x([i$H("esri.views.3d.support.QualitySettings.SceneServiceSettings")],a$g);let n$m=class extends p$N{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.reduceTileLevelDifferences=!0,this.textureFadeDuration=500;}};e$x([d$y()],n$m.prototype,"lodBias",void 0),e$x([d$y()],n$m.prototype,"angledSplitBias",void 0),e$x([d$y()],n$m.prototype,"reduceTileLevelDifferences",void 0),e$x([d$y()],n$m.prototype,"textureFadeDuration",void 0),n$m=e$x([i$H("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],n$m);let d$h=class extends p$N{constructor(){super(...arguments),this.graphics3D=new s$f,this.sceneService=new a$g,this.tiledSurface=new n$m,this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0;}};e$x([d$y({type:s$f})],d$h.prototype,"graphics3D",void 0),e$x([d$y({type:a$g})],d$h.prototype,"sceneService",void 0),e$x([d$y({type:n$m})],d$h.prototype,"tiledSurface",void 0),e$x([d$y()],d$h.prototype,"antialiasingEnabled",void 0),e$x([d$y()],d$h.prototype,"physicallyBasedRenderingEnabled",void 0),e$x([d$y()],d$h.prototype,"highQualityTransparency",void 0),e$x([d$y()],d$h.prototype,"memoryLimit",void 0),e$x([d$y()],d$h.prototype,"additionalCacheMemory",void 0),e$x([d$y()],d$h.prototype,"frameRate",void 0),e$x([d$y()],d$h.prototype,"maximumRenderResolution",void 0),e$x([d$y()],d$h.prototype,"maximumPixelRatio",void 0),d$h=e$x([i$H("esri.views.3d.support.QualitySettings.QualitySettings")],d$h);const l$g=d$h;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class _$8{constructor(t,e,s,i){this.viewingMode=t,this.spatialReference=e,this.unitInMeters=s,this.coordinateSystem=i,this._coordinateSystem=m$u(i);}set extent(t){t&&h$p(this.coordinateSystem,t,this.coordinateSystem);}getAltitude(t){return O$h(this.coordinateSystem,t)}setAltitude(t,e,s=t){return T$e(this.coordinateSystem,s,e,t)}setAltitudeOfTransformation(t,e){q$c(this.coordinateSystem,e,t,e);}worldUpAtPosition(t,e){return P$i(this.coordinateSystem,t,e)}worldBasisAtPosition(t,e,s){return R$e(this.coordinateSystem,t,e,s)}basisMatrixAtPosition(t,e){const i=this.worldBasisAtPosition(t,0,c$T.get()),r=this.worldBasisAtPosition(t,1,c$T.get()),o=this.worldBasisAtPosition(t,2,c$T.get());return s$O(e,i[0],i[1],i[2],0,r[0],r[1],r[2],0,o[0],o[1],o[2],0,0,0,0,1),e}intersectManifoldClosestSilhouette(t,e,s){return w$i(this.coordinateSystem,e,this._coordinateSystem),C$e(this._coordinateSystem,t,s),s}intersectManifold(t,e,s){w$i(this.coordinateSystem,e,this._coordinateSystem);const r=c$T.get();return S$j(this._coordinateSystem,t,r)?r$B(s,r):null}intersectInfiniteManifold(t,e,s){if(1===this.viewingMode)return this.intersectManifold(t,e,s);w$i(this.coordinateSystem,e,this._coordinateSystem);const r=this._coordinateSystem.value,o=c$T.get();return D$h(r.plane,t,o)?r$B(s,o):null}toRenderCoords(t,e,s){return t$Z(t)?wn(t,e,this.spatialReference):gn(t,e,s,this.spatialReference)}fromRenderCoords(e,s,i=null){return t$Z(s)?(r$A(i)&&(s.spatialReference=i),jn(e,this.spatialReference,s)):s instanceof k$l?Rn(e,this.spatialReference,s):gn(e,this.spatialReference,s,i)?s:null}static create(t,s){switch(t){case 2:return new _$8(2,s,H$k(s),x$n());case 1:return new _$8(1,s,1,k$h(s))}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const r$k=(()=>{const r=new Array;return r[0]=10,r[1]=10,r[2]=10,r[3]=10,r[4]=5,r})(),n$l=30;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function e$j(e){return "function"==typeof e.getUsedMemory}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const h$d=s$y.getLogger("esri.views.3d.support.MemoryController");function o$k(t){return new d$g(t)}const m$h=1,n$k=1,y$a=.75,_$7=.6,l$f=1.3;class d$g{constructor(e){this._view=e,this.events=new n$L,this.minQuality=.1,this._maxMemory=500,this._additionalCacheMemory=100,this._quality=1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryUsed=0,this._memoryPredicted=0,this._cacheStorage=new h$C,this._numQualityChanges=0,this._updating=!1;}destroy(){this.events=null,this._cacheStorage.destroy();}newCache(t,e){return new i$Y(t,this._cacheStorage,e)}set maxMemory(t){null!=t&&t>0&&(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<t&&this._updateQuality(m$h),this._maxMemory=t);}get maxMemory(){return this._maxMemory}set additionalCacheMemory(t){null!=t&&t>=0&&(this._additionalCacheMemory=t);}disableMemCache(){this._additionalCacheMemory=-4096;}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._memoryUsed}resetStableQuality(){this._stableQuality=0;}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let t=this._layersUpdating();if(this._memoryPredicted<_$7&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(m$h);else if(t)(this._memoryPredicted>1.1*n$k||this._memoryUsed>n$k)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/l$f),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>n$k)this._stableQuality=0,this._canFastRecover=!1,t=this._updateQuality(this._quality/l$f),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<y$a&&this._quality<m$h){this._stableQuality=this._quality;const e=.05;t=this._updateQuality(this._quality+e);}else this._quality<1&&(this._canFastRecover=!0);this.updating!==t&&(this._updating=t,this.events.emit("updating-changed",this.updating));}_updateQuality(t){return (t=Math.min(Math.max(t,this.minQuality),m$h))!==this._quality&&(this._quality=t,this.events.emit("quality-changed",this._quality),++this._numQualityChanges,!0)}_layersUpdating(){return this._view.allLayerViews.some((t=>!!t.updating))}_updateMemory(){let t=0,e=0;this._view.basemapTerrain&&this._view.basemapTerrain.getUsedMemory&&(t+=this._view.basemapTerrain.getUsedMemory());const s=this._view._stage&&this._view._stage.renderView&&this._view._stage.renderView.edgeView;r$A(s)&&(t+=s.usedMemory),this._view.allLayerViews&&this._view.allLayerViews.forEach((i=>{if(e$j(i)){const s=i.ignoresMemoryFactor()?this._quality:1;t+=i.getUsedMemory()*s,e+=i.getUnloadedMemory()*s;}}));const a=null==this._warnMemoryUsage||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),o=1048576*this._maxMemory;if(t>o&&a){this._warnMemoryUsage=t;const i=t=>(t/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",s=Math.round(100*this._quality);h$d.warn(`Memory Limit exceeded! Limit: ${i(o)} Current: ${i(t)} Projected: ${i(t+e)} Quality: ${s}%`);}this._memoryUsed=t/o,this._memoryPredicted=(t+e)/o;const m=o-t;this._cacheStorage.maxSize=Math.max(0,m+1048576*this._additionalCacheMemory),this.events.emit("memory-used",this._memoryUsed);}get test(){const t=this;return {cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const e=t._numQualityChanges;return t._numQualityChanges=0,e}}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let y$9=class extends p$N{constructor(){super(...arguments),this.updating=!1;}};function g$d(e,t=(()=>performance.now())){return new C$5.ResourceController({view:e,now:t})}var C$5;e$x([d$y({readOnly:!0})],y$9.prototype,"updating",void 0),y$9=e$x([i$H("esri.views.3d.support.ResourceController")],y$9),function(t){let g=class extends y$9{constructor(){super(...arguments),this._scheduler=null,this._memoryController=null,this._streamDataLoader=null,this._cameraChangeTime=0,this._handles=new u$D,this._frameTask=null,this._scheduleTask=D$j,this._state=2;}initialize(){this._cameraChangeTime=this.now(),this._scheduler=R$l(this.now),this._memoryController=o$k(this.view),this._streamDataLoader=new w$n,this._streamDataLoader.setup(n$l,r$k,this._scheduler),this._handles.add([this.view.watch("state.camera",((e,t)=>this._cameraChangedHandler(e,t)),!0),this.view.watch("stationary",(()=>this._stationaryChangedHandler())),this._memoryController.events.on("updating-changed",(()=>this.notifyChange("updating")))]),this._frameTask=A$n({update:e=>this.frame(e)}),this._scheduleTask=this._scheduler.registerTask(f$u.RESOURCE_CONTROLLER);}destroy(){this._handles=l$E(this._handles),this._scheduleTask.remove(),this._frameTask=s$E(this._frameTask),this._streamDataLoader=l$E(this._streamDataLoader),this._memoryController=l$E(this._memoryController),this._scheduler=l$E(this._scheduler);}get updating(){var e,t;return !!(null!=(e=this._memoryController)&&e.updating||null!=(t=this._streamDataLoader)&&t.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}schedule(e,t,r){return this._scheduleTask.schedule(e,t,r)}createStreamDataRequester(e){const t=this._streamDataLoader;return {request:(r,s,a)=>t.request(r,s,e,a),get busy(){return !t.hasDownloadSlots(e)}}}frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(u$H(e.deltaTime)),!this._scheduler)||(this._updateState(),this._scheduler.state=this._state,this._scheduler.updateBudget(e)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update());}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=this._scheduler.now,this._updateState(),this._scheduler.state=this._state);}_stationaryChangedHandler(){this.memoryController.resetStableQuality();}_updateState(){this.view.animation?this._state=0:this.view.interacting?this._state=1:(0===this._state&&(this._cameraChangeTime=0),this._scheduler.now-this._cameraChangeTime<=C?this._state=1:this._state=2);}get test(){return {getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e),state:this._state}}};e$x([d$y({constructOnly:!0})],g.prototype,"view",void 0),e$x([d$y({constructOnly:!0})],g.prototype,"now",void 0),e$x([d$y()],g.prototype,"_scheduler",void 0),e$x([d$y()],g.prototype,"_memoryController",void 0),e$x([d$y()],g.prototype,"_streamDataLoader",void 0),e$x([d$y({readOnly:!0})],g.prototype,"updating",null),g=e$x([i$H("esri.views.3d.support.ResourceController")],g),t.ResourceController=g;const C=300;}(C$5||(C$5={}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function n$j(n){return "performanceInfo"in n}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class t$q{constructor(t,s){if(this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=t.layer,this.memory=E$k(t)?s.basemapTerrain.getUsedMemoryForLayerView(t):t.getUsedMemory(),n$j(t)){const e=t.performanceInfo;this.displayedNumberOfFeatures=e.displayedNumberOfFeatures,this.maximumNumberOfFeatures=e.maximumNumberOfFeatures,this.totalNumberOfFeatures=e.totalNumberOfFeatures;}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class t$p{constructor(t){this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array;const a=t.resourceController.memoryController;this.totalMemory=1048576*a.maxMemory,this.usedMemory=Math.round(a.usedMemory*this.totalMemory),this.quality=a.memoryFactor,this.load=t.resourceController.scheduler.load,this.terrainMemory=t.basemapTerrain?t.basemapTerrain.getUsedMemory():0;const m=t._stage&&t._stage.renderView&&t._stage.renderView.edgeView;this.edgesMemory=r$A(m)?m.usedMemory:0,t.allLayerViews.items.forEach((e=>{(e$j(e)||E$k(e))&&this.layerPerformanceInfos.push(new t$q(e,t));})),this.layerPerformanceInfos.sort(((e,r)=>r.memory-e.memory));}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class h$c extends s$P{constructor(e,t,r,s){super(t,s),this._streamDataRequester=e,this._parameters=r;}async fromUrl(i,o,n){h$B(n);const h=r$A(n)&&n.signal,a=this.makeUid(i,o);let l=this._textureRequests.get(a);if(!l){const e=new AbortController,t=this._streamDataRequester.request(i,"image",{uid:a,signal:e.signal});l={referenceCount:0,texture:null,textureAsync:null,abortController:e},this._textureRequests.set(a,l),l.textureAsync=t.then((async e=>{const t=this._createTexture(i,e,o);return l.texture=t,l.abortController=null,this._stage.add(t),await this._stage.load(t),{uid:a,texture:t,release:()=>this._release(a)}}),(e=>{throw l.abortController=null,e}));}return l.referenceCount++,new Promise(((e,t)=>{j$t(h,(()=>{t(m$D());})),l.textureAsync.then(e,t);})).catch((e=>{throw this._release(a),e}))}_createTexture(e,t,r){const s={...this._parameters,powerOfTwoResizeMode:2};if(wt$1(e)){if(r||0===t.width&&0===t.height){const e=t.width?t.height/t.width:1;r=r||64,e>1?(t.width=Math.round(r/e),t.height=r):(t.width=r,t.height=Math.round(r*e));}this._stage.renderView&&this._stage.renderView.renderingContext.driverTest.svgAlwaysPremultipliesAlpha&&(s.preMultiplyAlpha=!1);}return s.width=t.width,s.height=t.height,new b$s(t,s)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class c$i{constructor(e){this.textures=null,this.streamDataRequester=null,this.graphicsOwners=[],this.screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this.viewState=e.viewState,this.view=e.view,this.pointsOfInterest=e.pointsOfInterest,this.objectResourceCache=e.objectResourceCache,this.streamDataRequester=e.resourceController.createStreamDataRequester(4),this.textures=new h$c(this.streamDataRequester,e.view._stage,{preMultiplyAlpha:!0,wrap:{s:33071,t:33071}},e.resourceController.scheduler);const t=p$K(this.view.spatialReference).radius;this.screenSizePerspectiveSettings=i$Z(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=r$W(e.viewingMode,t);}destroy(){this.textures.destroy(),this.textures=null,this.streamDataRequester=null;}addGraphicsOwner(t){if(!t)return {remove(){}};this.graphicsOwners.push(t);const s="layer"in t?t.watch("layer.screenSizePerspectiveEnabled",(()=>this.updateScreenSizePerspectiveEnabled())):null;return this.updateScreenSizePerspectiveEnabled(),{remove:()=>{s&&(s.remove(),v$v(this.graphicsOwners,t),this.updateScreenSizePerspectiveEnabled());}}}updateScreenSizePerspectiveEnabled(){const e=this.graphicsOwners.some((e=>!0===e.get("layer.screenSizePerspectiveEnabled")));if(e&&!this.screenSizePerspectiveHandles){this.screenSizePerspectiveHandles=new u$D;const e=()=>this.updateScreenSizePerspectiveSettings();this.screenSizePerspectiveHandles.add([this.pointsOfInterest.centerOnSurfaceInfrequent.watch("distance",e,!0),this.viewState.events.on("camera-projection-changed",e)]),this.updateScreenSizePerspectiveSettings();}else !e&&this.screenSizePerspectiveHandles&&(this.screenSizePerspectiveHandles.destroy(),this.screenSizePerspectiveHandles=null);}updateScreenSizePerspectiveSettings(){const e=this.pointsOfInterest;a$f.distance=e.centerOnSurfaceInfrequent.distance,a$f.fovY=this.viewState.camera.fovY,this.screenSizePerspectiveSettings.update(a$f),this.screenSizePerspectiveSettingsLabels.update(a$f),this.view._stage.renderView.requestRender();}}const a$f={distance:0,fovY:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class c$h{constructor(s,o,i=""){this.graphics=s,this._symbol=new L$j({symbolLayers:[new S$q({material:{color:o},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new y$A({text:i,halo:{color:"white",size:1/.75},material:{color:o},size:12})]});}show(i,e){if(t$F(e))return;this.hide();const r=new b$m({x:i[0],y:i[1],z:i[2],spatialReference:e});this._graphic=new h$t({geometry:r,symbol:this._symbol}),this.graphics.add(this._graphic);}hide(){r$A(this._graphic)&&(this.graphics.remove(this._graphic),this._graphic=null);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let c$g=class extends p$N{constructor(r){super(r),this.handles=new u$D;}destroy(){this.handles.destroy();}};e$x([d$y({constructOnly:!0})],c$g.prototype,"renderCoordsHelper",void 0),e$x([d$y({constructOnly:!0})],c$g.prototype,"surface",void 0),e$x([d$y({constructOnly:!0})],c$g.prototype,"state",void 0),c$g=e$x([i$H("esri.views.3d.support.PointOfInterest")],c$g);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const u$h=Array;let m$g=class extends c$g{constructor(t){super(t),this._dirty=!1,this._propertiesPool=new o$O({location:b$m,renderLocation:u$h},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.cameraName="camera",this.renderLocation=n$F(),this.tmpPoint=new b$m;}initialize(){if(this.scheduler&&this.handles.add(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const t=()=>this._setDirty();this.handles.add($$9(this.map,"ground.layers","change",t,t,t));}this._updateRenderLocation();}destroy(){this._cancelPendingRequest(),this._propertiesPool.destroy(),this._propertiesPool=null;}get _camera(){return this.state[this.cameraName]}get location(){const t=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,t,this.state.spatialReference),t}get scale(){const t=this._camera,e=q$g(t.eye,this.renderLocation),r={renderCoordsHelper:this.renderCoordsHelper,state:{camera:t}};return $$8(r,e,0)}get updating(){return this._dirty||null!=this._pendingElevationQueryController}updateRenderLocation(){this._setDirty(),this._updateRenderLocation();}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"));}_cancelPendingRequest(){const t=this._pendingElevationQueryController;t&&(this._pendingElevationQueryController=null,t.abort(),this.notifyChange("updating"));}get running(){return !this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map||!this.map.ground)return void this._updateSurfaceAltitude(0);this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this.tmpPoint,this.state.spatialReference);let t=new AbortController;this.map.ground.queryElevation(this.tmpPoint,{signal:t.signal,cache:this.cache}).then((t=>this._updateSurfaceAltitude(t.geometry.z))).catch((t=>{d$B(t)||this._updateSurfaceAltitude(0);})).catch((()=>{})).then((()=>{this._pendingElevationQueryController===t&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),t=null;})),this._pendingElevationQueryController=t;}_updateSurfaceAltitude(t){this._estimatedSurfaceAltitude!==t&&(this._estimatedSurfaceAltitude=t,this._updateRenderLocation());}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(y$8,this._estimatedSurfaceAltitude,this._camera.eye),F$g(this._get("renderLocation"),y$8)||this._set("renderLocation",r$B(this._propertiesPool.get("renderLocation"),y$8));}};e$x([d$y({constructOnly:!0})],m$g.prototype,"scheduler",void 0),e$x([d$y({constructOnly:!0})],m$g.prototype,"cache",void 0),e$x([d$y({constructOnly:!0})],m$g.prototype,"task",void 0),e$x([d$y({constructOnly:!0})],m$g.prototype,"cameraName",void 0),e$x([d$y({readOnly:!0})],m$g.prototype,"location",null),e$x([d$y({constructOnly:!0})],m$g.prototype,"map",void 0),e$x([d$y({readOnly:!0})],m$g.prototype,"renderLocation",void 0),e$x([d$y({readOnly:!0})],m$g.prototype,"scale",null),e$x([d$y({readOnly:!0})],m$g.prototype,"updating",null),m$g=e$x([i$H("esri.views.3d.support.CameraOnSurface")],m$g);const y$8=n$F(),_$6=m$g;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const g$c=Array;let A$6=class extends c$g{constructor(t){super(t),this._propertiesPool=new o$O({location:b$m,renderLocation:g$c},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.cameraName="camera",this.distance=0,this.renderLocation=n$F(),this.updating=!1;}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask();}destroy(){this._frameWorker&&(this._frameWorker.remove(),this._frameWorker=null),this._propertiesPool.destroy(),this._propertiesPool=null;}get _camera(){return this.state[this.cameraName]}get location(){const t=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,t,this.state.spatialReference),t}updateRenderLocation(){this.updating=!0,this._updateRenderLocation();}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1;}_updateRenderLocation(){const t=k$5;let e=this.calculateSurfaceIntersection(this._currentSurfaceAltitude,t);const r=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!e&&r&&(e=this.calculateSurfaceIntersection(this._latestSurfaceAltitude,t),e&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const s=v$9;e&&this.latestSurfaceAltitudeChangesDistanceSignificantly(t,s)&&(r$B(t,s),this._currentSurfaceAltitude=this._latestSurfaceAltitude),e?this.distance=q$g(this._camera.eye,t):(d$z(t,this._camera.viewForward,this._get("distance")),u$A(t,t,this._camera.eye)),F$g(this._get("renderLocation"),t)||this._set("renderLocation",r$B(this._propertiesPool.get("renderLocation"),t));}calculateSurfaceIntersection(t,s){const i=this._camera;if(!this.renderCoordsHelper.intersectManifold(i.ray,t,s))return !1;if(this.state.isGlobal){const e=p$K(this.renderCoordsHelper.spatialReference).radius,r=e+t,o=p$Q(i.eye),u=o<r*r,d=q$g(i.eye,s);if(u&&d>e/4){const t=r-Math.sqrt(o);return d$z(s,i.viewForward,t),u$A(s,s,i.eye),!0}}else {const t=this.surface.ready?this.surface.extent:null;r$A(t)&&bn(t,this.surface.spatialReference,L$6,this.renderCoordsHelper.spatialReference)&&(s[0]=e$B(s[0],L$6[0],L$6[2]),s[1]=e$B(s[1],L$6[1],L$6[3]));}return !0}latestSurfaceAltitudeChangesDistanceSignificantly(t,e){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==t)return !1;if(this.calculateSurfaceIntersection(this._latestSurfaceAltitude,e)){if(I$j.TESTS_DISABLE_OPTIMIZATIONS)return !0;const r=this._camera.eye,s=q$g(r,t),i=q$g(r,e);if(Math.abs(i-s)/s>j$8)return !0}return !1}};e$x([d$y({constructOnly:!0})],A$6.prototype,"scheduler",void 0),e$x([d$y({constructOnly:!0})],A$6.prototype,"task",void 0),e$x([d$y({constructOnly:!0})],A$6.prototype,"cameraName",void 0),e$x([d$y()],A$6.prototype,"distance",void 0),e$x([d$y({constructOnly:!0})],A$6.prototype,"estimateSurfaceAltitudeAtCenter",void 0),e$x([d$y({readOnly:!0})],A$6.prototype,"location",null),e$x([d$y({readOnly:!0})],A$6.prototype,"renderLocation",void 0),e$x([d$y()],A$6.prototype,"updating",void 0),A$6=e$x([i$H("esri.views.3d.support.CenterOnSurface")],A$6);const j$8=.05,k$5=n$F(),v$9=n$F(),L$6=u$B(),C$4=A$6;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class t$o{constructor(t){this.handles=new u$D,this.events=new n$L,this.contentLayerViews=t.contentLayerViews,this.handles.add(this.contentLayerViews.on("change",(e=>this.layerViewsChanged(e)))),this.layerViewsChanged({added:this.contentLayerViews.toArray(),removed:[],moved:[],target:this.contentLayerViews});}destroy(){this.handles&&(this.handles.destroy(),this.handles=null);}layerViewsChanged(e){e.added.forEach((e=>{"esri.views.3d.layers.SceneLayerView3D"===e.declaredClass&&this.handles.add(e.on("visible-geometry-changed",(()=>this.contentChanged())),e.uid);})),e.removed.forEach((e=>this.handles.remove(e.uid)));}contentChanged(){this.events.emit("request-update",n$i);}}const n$i={};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const g$b=Array;let _$5=class extends c$g{constructor(e){super(e),this._propertiesPool=new o$O({location:b$m,renderLocation:g$b},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation");}initialize(){this.handles.add([this.centerOnSurface.watch("renderLocation",(()=>this.updateRenderLocation())),this.state.watch("contentCamera",(()=>this.updateRenderLocation()))]),this.scheduler&&this.handles.add(this.scheduler.registerTask(f$u.POINT_OF_INTEREST_FREQUENT,this));}destroy(){this._propertiesPool.destroy(),this._propertiesPool=null;}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),r=this.centerOnSurface.renderLocation,o=this.renderCoordsHelper,s=this.state.contentCamera;this._dirty=!1,o.worldUpAtPosition(r,S$8);const d=Math.max(0,(Math.acos(z$i(S$8,s.viewForward))-.5*Math.PI)*(s.aboveGround?1:-1));if(Number.isNaN(d)){if(!e||!G$f(e,r)){const e=this._propertiesPool.get("renderLocation");r$B(e,r),this._set("renderLocation",e);}return}const p=1-e$B(d/(.5*Math.PI),0,1),h=p*p*p;this._calculateScreenHorizontalEdgeOnSurface(P$8);const u=this._propertiesPool.get("renderLocation");y$v(u,r,P$8,h),e&&G$f(e,u)||this._set("renderLocation",u);}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,o=t.getRenderCenter(x$r());if(o[1]=t.aboveGround?t.padding[2]:t.fullHeight-t.padding[0],this.estimateSurfaceIntersectionAtRenderPoint(o,e))return e;const s=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(o,O$4)){c$O(O$4,O$4,t.eye);const r=j$p(O$4,O$4);if(this.renderCoordsHelper.intersectManifold(j$r(t.eye,r),s,e))return e}return this.renderCoordsHelper.setAltitude(e,s,t.eye)}updateRenderLocation(){this._dirty=!0;}};e$x([d$y()],_$5.prototype,"_dirty",void 0),e$x([d$y({constructOnly:!0})],_$5.prototype,"scheduler",void 0),e$x([d$y({constructOnly:!0})],_$5.prototype,"centerOnSurface",void 0),e$x([d$y({constructOnly:!0})],_$5.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),e$x([d$y({readOnly:!0})],_$5.prototype,"updating",null),e$x([d$y({readOnly:!0})],_$5.prototype,"location",null),e$x([d$y({readOnly:!0})],_$5.prototype,"renderLocation",void 0),_$5=e$x([i$H("esri.views.3d.support.CenterOnSurface")],_$5);const S$8=n$F(),O$4=n$F(),P$8=n$F(),j$7=_$5;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let u$g=class extends p$N{constructor(e){super(e),this.location=null,this._updateController=null,this._handles=new u$D;}get renderLocation(){if(!this.location)return null;const e=n$F();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}initialize(){this.view.state.isLocal&&(this._handles.add([this.watch(["surfaceView.spatialReference","surfaceView.extent"],(()=>this._update())),$$9(this,"surface.layers","change",(()=>this._update()))]),this._update());}destroy(){this._handles.destroy();}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),!this.surfaceView||t$F(this.surfaceView.extent)||!this.surfaceView.spatialReference)return void this._set("location",null);const e=p$V(this.surfaceView.extent),t=new b$m({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then((e=>{this._updateController=null,this._set("location",e.geometry);})).catch((e=>{d$B(e)||e&&"elevation-query:invalid-layer"===e.name||console.error("StableSurfaceCenter failed to update: ",e);}))):this._set("location",t);}};e$x([d$y({constructOnly:!0})],u$g.prototype,"view",void 0),e$x([d$y({constructOnly:!0})],u$g.prototype,"cache",void 0),e$x([d$y({readOnly:!0,aliasOf:"view.map.ground"})],u$g.prototype,"surface",void 0),e$x([d$y({readOnly:!0,aliasOf:"view.basemapTerrain"})],u$g.prototype,"surfaceView",void 0),e$x([d$y({readOnly:!0})],u$g.prototype,"location",void 0),e$x([d$y({readOnly:!0})],u$g.prototype,"renderLocation",null),u$g=e$x([i$H("esri.views.3d.terrain.StableSurfaceCenter")],u$g);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let h$b=class extends p$N{constructor(){super(...arguments),this.handles=new u$D,this._tileGeometryUpdateExtent=B$i(),this._tileGeometryUpdateSpatialReference=null,this.events=new n$L,this.updating=!1;}initialize(){this.handles.add([this.surface.on("elevation-change",(e=>this._tileGeometryChanged(e))),this.scheduler.registerTask(f$u.SURFACE_GEOMETRY_UPDATES,this)]);}destroy(){this.handles&&(this.handles.destroy(),this.handles=null);}get running(){return this.updating}runTask(){this.updating&&(this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",l$e),B$i(this._tileGeometryUpdateExtent),this._set("updating",!1));}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,h$A(this._tileGeometryUpdateExtent,e.tile.extent,this._tileGeometryUpdateExtent),this._set("updating",!0);}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const r=this.centerOnSurfaces[t];r.distance>e.distance&&(e=r);}return e}_centerIntersectsExtent(e,t){const r=this.state.camera.eye,s=y$7,o=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(r,u$f,t),this.renderCoordsHelper.fromRenderCoords(o.renderLocation,m$f,t),u$f[0]<m$f[0]?(s[0]=u$f[0],s[2]=m$f[0]):(s[0]=m$f[0],s[2]=u$f[0]),u$f[1]<m$f[1]?(s[1]=u$f[1],s[3]=m$f[1]):(s[1]=m$f[1],s[3]=u$f[1]),k$o(s,e)}};e$x([d$y({constructOnly:!0})],h$b.prototype,"state",void 0),e$x([d$y({constructOnly:!0})],h$b.prototype,"centerOnSurfaces",void 0),e$x([d$y({constructOnly:!0})],h$b.prototype,"renderCoordsHelper",void 0),e$x([d$y({constructOnly:!0})],h$b.prototype,"scheduler",void 0),e$x([d$y({constructOnly:!0})],h$b.prototype,"surface",void 0),e$x([d$y({readOnly:!0})],h$b.prototype,"updating",void 0),h$b=e$x([i$H("esri.views.3d.support.SurfaceGeometryUpdates")],h$b);const l$e={},u$f=n$F(),m$f=n$F(),y$7=B$i();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let T$6=class extends p$N{constructor(e){super(e),this._handles=new u$D,this._tmpRay=d$G(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new o$O({renderPointOfView:R$7},this),this.renderPointOfView=n$F(),this._pois=new Array,this._debugCenters=new Map;}initialize(){var e;const{state:t,basemapTerrain:r,renderCoordsHelper:n,map:a}=this.view;this._surfaceIntersector=new y$s(t.viewingMode),t.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=0,this._contentIntersector=new y$s(t.viewingMode);const c=()=>this._estimateSurfaceAltitudeAtCenter(),u=this.view.resourceController.scheduler,h=e$z(null==(e=this.view.basemapTerrain)?void 0:e.elevationQueryCache),d={state:t,scheduler:u,surface:r,renderCoordsHelper:n};this._set("centerOnSurfaceInfrequent",new C$4({...d,task:f$u.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:c})),this._set("centerOnSurfaceFrequent",new C$4({...d,task:f$u.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:c})),this._set("contentCenterOnSurface",new C$4({...d,task:f$u.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:c,cameraName:"contentCamera"})),this._set("centerOnContent",new C$4({...d,task:f$u.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new _$6({...d,cache:h,task:f$u.POINT_OF_INTEREST_INFREQUENT,map:a})),this._set("contentCameraOnSurface",new _$6({...d,cache:h,task:f$u.POINT_OF_INTEREST_INFREQUENT,map:a,cameraName:"contentCamera"})),this._set("surfaceGeometryUpdates",new h$b({...d,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new t$o({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:n})),this._set("surfaceOrigin",new u$g({cache:h,view:this.view})),this._set("focus",new j$7({state:t,scheduler:u,surface:r,renderCoordsHelper:n,centerOnSurface:this.contentCenterOnSurface,estimateSurfaceIntersectionAtRenderPoint:(e,t)=>this._estimateSurfaceIntersectionAtRenderPoint(e,this.view.state.contentCamera,t)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.contentCenterOnSurface,this.cameraOnSurface,this.contentCameraOnSurface,this.focus);const f=this.view.graphics;this._debugCenters.set(this.centerOnContent,new c$h(f,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new c$h(f,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new c$h(f,"red","CenterOnSurface")),this._debugCenters.set(this.contentCenterOnSurface,new c$h(f,"red","ContentCenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new c$h(f,"blue","CameraOnSurface")),this._debugCenters.set(this.contentCameraOnSurface,new c$h(f,"blue","ContentCameraOnSurface")),this._debugCenters.set(this.focus,new c$h(f,"green","Focus")),this._handles.add([t.watch("camera",(e=>this._cameraChanged(e)),!0),r.watch("extent",(()=>this._updateCenterPointsOfInterest())),h$D(r,"updating",(()=>this._updateCenterPointsOfInterest()),!0),this.surfaceGeometryUpdates.events.on("request-update",(()=>this._updateCenterPointsOfInterest())),this.contentGeometryUpdates.events.on("request-update",(()=>this._updateCenterOnContent())),i$P(I$j,"SHOW_POI",(e=>this._setDebug(e)))]),this._cameraChanged(this.view.state.camera);for(const s of this._pois)s.runTask();}destroy(){this._setDebug(!1),this._handles.destroy(),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy();}get updating(){var e;return !!(null!=(e=this.surfaceGeometryUpdates)&&e.updating||this._pois.some((e=>e.updating)))}get centerRay(){return this._centerRayDirty&&(this._centerRay=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.camera,this._tmpRay),this._centerRayDirty=!1),this._centerRay}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this.centerRay;return t$F(e)||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,P$7,E$8)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(P$7):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this.centerRay;if(t$F(e))return this._surfaceAltitudeAtCenter;const t=e.origin,r=u$A(P$7,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e),this._surfaceIntersector.camera=this.view.state.camera,this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,r),this._surfaceIntersector.results.min.getIntersectionPoint(P$7)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(P$7)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,r){const s=g$x(t,e,j$6);if(t$F(s))return null;const i=s.origin,o=u$A(P$7,s.origin,s.direction);return this._surfaceIntersector.resetWithRay(s),this._surfaceIntersector.camera=t,this.view.basemapTerrain.intersect(this._surfaceIntersector,null,i,o),this._surfaceIntersector.results.min.getIntersectionPoint(r)?r:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;F$g(this.renderPointOfView,t)||this._set("renderPointOfView",r$B(this._propertiesPool.get("renderPointOfView"),t));}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation();}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation();}_setDebug(e){if(!e)return this._debugCenters.forEach((e=>e.hide())),void this._handles.remove("debug");for(const t of this._pois)this._handles.add(i$P(t,"renderLocation",(e=>this._debugCenters.get(t).show(e,t.renderCoordsHelper.spatialReference))),"debug");}get test(){return {update:()=>{this.surfaceGeometryUpdates.runTask();for(const e of this._pois)e.runTask();},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};e$x([d$y({readOnly:!0})],T$6.prototype,"centerOnContent",void 0),e$x([d$y({readOnly:!0})],T$6.prototype,"centerOnSurfaceFrequent",void 0),e$x([d$y({readOnly:!0})],T$6.prototype,"centerOnSurfaceInfrequent",void 0),e$x([d$y({readOnly:!0})],T$6.prototype,"contentCenterOnSurface",void 0),e$x([d$y({readOnly:!0})],T$6.prototype,"cameraOnSurface",void 0),e$x([d$y({readOnly:!0})],T$6.prototype,"contentCameraOnSurface",void 0),e$x([d$y({readOnly:!0})],T$6.prototype,"focus",void 0),e$x([d$y({readOnly:!0})],T$6.prototype,"renderPointOfView",void 0),e$x([d$y({readOnly:!0})],T$6.prototype,"surfaceOrigin",void 0),e$x([d$y({readOnly:!0})],T$6.prototype,"contentGeometryUpdates",void 0),e$x([d$y({readOnly:!0})],T$6.prototype,"surfaceGeometryUpdates",void 0),e$x([d$y({constructOnly:!0})],T$6.prototype,"view",void 0),e$x([d$y({readOnly:!0})],T$6.prototype,"updating",null),T$6=e$x([i$H("esri.views.3d.support.PointsOfInterest")],T$6);const R$7=Array,P$7=n$F(),j$6=d$G(),E$8={exclude:new Set([O$p])},N$9=T$6;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class t$n{constructor(t){this.store=t;}destroy(){this.store.destroy();}get(t){return this.store.get(t)}put(t,s){this.store.put(t,s,s.values.byteLength+256);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const e$i={value:.5,readOnly:!0},t$m={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const p$e=p=>{let c=class extends p{get imageFormatIsOpaque(){return !1}get isOpaque(){return this.fullOpacity>=1&&this.imageFormatIsOpaque}get dataLevelRange(){const e=this.tileInfo.lods,t=e[0].scale,r=e[e.length-1].scale;return this.levelRangeFromScaleRange(t,r)}get displayLevelRange(){const e=this.tileInfo.lods,t=this.layer.minScale||e[0].scale,r=this.layer.maxScale||e[e.length-1].scale,i=this.levelRangeFromScaleRange(t,r);return this.layer.maxScale&&i.maxLevel++,i}getTileUrl(e,t,r){return this.layer.getTileUrl(e,t,r)}_addTilingSchemeMatchPromise(){if(t$F(this.layer.fullExtent))return this.addResolvingPromise(Promise.reject(new s$w("tilingscheme:extent-not-defined","This layer doesn't define a fullExtent.")));const e=this._getTileInfoSupportError(this.tileInfo,this.layer.fullExtent);if(e)return this.addResolvingPromise(Promise.reject(e));const a=d$K(this.view,"basemapTerrain.tilingSchemeLocked").then((()=>{const e=this.view.basemapTerrain.tilingScheme,t=this._getTileInfoCompatibilityError(this.tileInfo,e);if(t)throw t}));this.addResolvingPromise(a);}_getTileInfoSupportError(e,r){const i=w$o(e,r,this.view.spatialReference,this.view.state.viewingMode);if(i){const e={layer:this.layer,error:i};let r;switch(i.name){case"tilingscheme:spatial-reference-mismatch":case"tilingscheme:global-unsupported-spatial-reference":case"tilingscheme:local-unsupported-spatial-reference":r=new s$w("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",e);break;default:r=new s$w("layerview:tiling-scheme-unsupported","The tiling scheme of this layer is not supported by SceneView",e);}return r}return null}_getTileInfoCompatibilityError(e,r){return r.compatibleWith(e)?null:new s$w("layerview:tiling-scheme-incompatible","The tiling scheme of this layer is incompatible with the tiling scheme of the surface")}levelRangeFromScaleRange(e,t){const r={minLevel:0,maxLevel:1/0},i=this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.tilingScheme;if(!i)return r;const a=i.levels[0],s=e=>{const t=Math.log(a.scale/e)/Math.LN2;return .5-Math.abs(.5-t%1)<1e-9?Math.round(t):Math.ceil(t)};return null!=e&&e>0&&(r.minLevel=Math.max(0,s(e))),null!=t&&t>0&&(r.maxLevel=Math.max(0,s(t))),r}isUpdating(){return !!(this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.updating)}};return e$x([d$y({readOnly:!0})],c.prototype,"imageFormatIsOpaque",null),e$x([d$y({readOnly:!0})],c.prototype,"updating",void 0),e$x([d$y(t$m)],c.prototype,"updatingProgress",void 0),e$x([d$y(e$i)],c.prototype,"updatingProgressValue",void 0),e$x([d$y({readOnly:!0})],c.prototype,"fullExtent",void 0),e$x([d$y({readOnly:!0})],c.prototype,"isOpaque",null),e$x([d$y({readOnly:!0})],c.prototype,"dataLevelRange",null),e$x([d$y({readOnly:!0})],c.prototype,"displayLevelRange",null),e$x([d$y()],c.prototype,"layer",void 0),e$x([d$y({readOnly:!0})],c.prototype,"tileInfo",void 0),c=e$x([i$H("esri.views.3d.layers.TiledLayerView3D")],c),c};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let l$d=class extends(p$e(p$W(u$I))){constructor(){super(...arguments),this.type="elevation-3d";}initialize(){const e=this.get("view.map.allLayers"),o=e&&e.includes(this.layer),s=this.get("view.map.ground.layers"),t=s&&s.includes(this.layer);if(o&&!t){const e=new s$w("layerview:elevation-layer-only","3D elevation layer '"+this.layer.id+"' can only be added in the map ground");this.addResolvingPromise(Promise.reject(e));}this._addTilingSchemeMatchPromise();}};e$x([d$y({readOnly:!0,aliasOf:"layer.fullExtent"})],l$d.prototype,"fullExtent",void 0),e$x([d$y()],l$d.prototype,"layer",void 0),e$x([d$y({readOnly:!0,aliasOf:"layer.tileInfo"})],l$d.prototype,"tileInfo",void 0),l$d=e$x([i$H("esri.views.3d.layers.ElevationLayerView3D")],l$d);const p$d=l$d;

const ElevationLayerView3D = /*#__PURE__*/Object.freeze({
  __proto__: null,
  'default': p$d
});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class s$e{constructor(s=0,a=0){this.min=s,this.max=a,this.level=0,this.hasNoDataValues=!1;}copyFrom(s){this.min=s.min,this.max=s.max,this.level=s.level,this.hasNoDataValues=s.hasNoDataValues;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class i$b{constructor(t,a,s){this.type="elevation",this.samplerData=null,this.level=t[0],this.i=t[1],this.j=t[2],this.extent=a;const i=s.noDataValue,e=s.values;let o=1/0,l=-1/0,h=!0,r=!1;for(let n=0;n<e.length;n++){const t=e[n];t!==i?(o=t<o?t:o,l=t>l?t:l,h=!1):r=!0;}h&&(o=0,l=0),l=l>-3e38?l:0,this.samplerData={pixelData:s.values,width:s.width,height:s.height,noDataValue:i,safeWidth:.99999999*(s.width-1),dx:(s.width-1)/(a[2]-a[0]),dy:(s.width-1)/(a[3]-a[1]),x0:a[0],y1:a[3]},this.bounds=[o,l],this.hasNoDataValues=r;}release(){this.samplerData=null,this.bounds=null;}computeMinMaxValue(t,i,e,o){o.min=1/0,o.max=-1/0,o.hasNoDataValues=!1;const l=t-this.level;if(l<=0)return o;const h=2**l;if(!(Math.floor(i/h)===this.i&&Math.floor(e/h)===this.j))return o;let r=1/0,n=-1/0;const m=this.samplerData.width,f=this.samplerData.pixelData,u=.5*n$M;let c=(m-1)/h,p=(e-this.j*h)*c,d=(i-this.i*h)*c;if(c<1){const t=Math.floor(p),s=Math.floor(d),i=t+s*m,e=f[i],l=f[i+1],h=f[i+m],r=f[i+m+1];if(e+l+h+r<u){const i=p-t,n=d-s,m=x$u(e,l,h,r,i,n),f=x$u(e,l,h,r,i+c,n),u=x$u(e,l,h,r,i,n+c),x=x$u(e,l,h,r,i+c,n+c);return o.min=Math.min(m,f,u,x),o.max=Math.max(m,f,u,x),o}p=t,d=s,c=1;}else p=Math.floor(p),d=Math.floor(d),c=Math.ceil(c);for(let a=p;a<=p+c;a++)for(let t=d;t<=d+c;t++){const s=f[a+t*m];s<u?(r=Math.min(r,s),n=Math.max(n,s)):o.hasNoDataValues=!0;}return o.min=r,o.max=n,o}static sample(a,i,e){for(const o of e){if(!o)continue;const e=o.safeWidth,l=o.width,h=o.pixelData;let r=e$B(o.dy*(o.y1-i),0,e),n=e$B(o.dx*(a-o.x0),0,e);const m=Math.floor(r),f=Math.floor(n),u=m*l+f,c=u+l,p=h[u],d=h[c],x=h[u+1],M=h[c+1];if(p+d+x+M<.5*n$M){r-=m,n-=f;const t=p+(x-p)*n;return t+(d+(M-d)*n-t)*r}}return null}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let E$7=class extends p$N{constructor(e){super(e),this._handles=new u$D;}initialize(){this._handles.add([this.layerViews.on("change",(()=>this.notifyChange("stencilEnabledExtents")))]);}destroy(){this._handles.destroy(),this._handles=null;}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach((t=>{const r=t.layer;if("IntegratedMeshLayer"===r.operationalLayerType&&null!=this.viewSpatialReference){const t=_$4(r.fullExtent,this.viewSpatialReference);r$A(t)&&e.push(c$Y(t));}})),e}};function x$8(e,t){return 1===e?new w$6(t):new g$a(t)}e$x([d$y({readOnly:!0})],E$7.prototype,"layerViewsExtent",null),e$x([d$y({readOnly:!0})],E$7.prototype,"tiledLayersExtent",null),e$x([d$y({readOnly:!0})],E$7.prototype,"stencilEnabledExtents",null),e$x([d$y()],E$7.prototype,"viewSpatialReference",void 0),e$x([d$y()],E$7.prototype,"tilingScheme",void 0),e$x([d$y()],E$7.prototype,"defaultTiledLayersExtent",void 0),e$x([d$y({constructOnly:!0})],E$7.prototype,"layers",void 0),e$x([d$y({constructOnly:!0})],E$7.prototype,"layerViews",void 0),E$7=e$x([i$H("esri.views.3d.terrain.ExtentHelper")],E$7);let w$6=class extends E$7{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?s$Q:T$g}};w$6=e$x([i$H("esri.views.3d.terrain.ExtentHelperGlobal")],w$6);let g$a=class extends E$7{_computeLayerViewsExtent(){const e=B$i(),t=this.viewSpatialReference;this.layerViews.forEach((r=>{const s=r.layer;if(r.isResolved()&&("graphics"!==s.type||!s.internal)){const s=_$4("fullExtentInLocalViewSpatialReference"in r&&r.fullExtentInLocalViewSpatialReference||r.layer.fullExtent,t);h$A(e,s,e);}}));const r=M$i(e)?e:null,s=this._get("layerViewsExtent");return G$i(r,s)?s:r}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,r=B$i();this.layers.forEach((n=>{if(n.loaded&&e$O(n)){const{tileInfo:i,fullExtent:o}=b$t(n,t,2);(r$A(i)&&p$X(n)&&r$A(o)||r$A(i)&&e.compatibleWith(i)&&r$A(o)&&o.spatialReference.equals(e.spatialReference))&&h$A(r,o,r);}})),h$A(r,this.defaultTiledLayersExtent,r);const n=M$i(r)?r:null,i=this._get("tiledLayersExtent");return G$i(n,i)?i:n}};function _$4(e,t){return r$A(e)&&!e.spatialReference.equals(t)?un(e,e.spatialReference,t):e}g$a=e$x([i$H("esri.views.3d.terrain.ExtentHelperLocal")],g$a);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const o$j=25,r$j=n$W(1e3/o$j),t$l=20,m$e=n$W(1e3/t$l);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function e$h(){var e;const r=null==(e=e$P.require)?void 0:e.modules;if(r){const o=Object.keys(r);for(const e of o)-1!==e.search(".glsl")&&delete r[e];}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const ee$2=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let te$2,re$1=class extends p$N{constructor(e){super(e),this._handles=new u$D,this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Map,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._layerViewsDirty=!0,this._hasUnusedRenderTargets=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=s$H("esri-mobile")?2048:4096,this._animationTimeLast=0;}get running(){return (this._placementDirty||this._layerViewsDirty)&&(this._drapeSources.size>0||this.view.graphics.length>0||I$j.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get _worldToPCSRatio(){return r$A(this._spatialReference)&&this._spatialReference.isGeographic&&!this.view.state.isLocal?p$K(this._spatialReference).metersPerDegree:1}get view(){return this.surface.view}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get hasHighlights(){return this.renderer.hasHighlights}get rendersOccluded(){return this.renderer.rendersOccluded}initialize(){const e=this.view;this.renderer=new K$e({view:e,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),this._groundIntersector=new y$s(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this._handles.add([this.renderer.events.on("has-highlights",(()=>{this._setDrawTexturesDirty(),this.notifyChange("hasHighlights");})),this.renderer.events.on("has-water",(t=>{var r;return null==(r=e._stage)?void 0:r.renderView.setRenderParameters({hasOverlayWater:t})})),this.renderer.events.on("renders-occluded",(()=>{this._setDrawTexturesDirty(),this.notifyChange("rendersOccluded");})),this.renderer.events.on("content-changed",(()=>this._setDrawTexturesDirty())),this.renderer.events.on("textures-disposed",(()=>this.updateDrapeTargets())),e.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],(()=>this.setPlacementDirty())),this.surface.on("elevation-change",(()=>this.setPlacementDirty())),e.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0)),e.watch("graphicsView",(()=>this._layerViewsDirty=!0)),e.on("resize",(()=>this.setPlacementDirty())),A$n({preRender:e=>{this._contentUpdated=!1,this.renderer.processSyncLayers(),this._updateLayerViews(),this.renderer.hasOverlays&&(this._dispatchRendererUpdate(e),this._drawOverlayTextures(this.renderer.overlays,1)),this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory();}}),e.resourceController.scheduler.registerTask(f$u.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",(e=>{this._updateOverlays(e,0),this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays,0,e);}))]),this._updateLayerViews();}destroy(){this._drapeSources.forEach(((e,t)=>this.unregisterDrapeSource(t))),this._drapeTargets.forEach((e=>this._unregisterDrapeTarget(e))),this.renderer.dispose(),this._handles&&(this._handles.destroy(),this._handles=null),r$A(te$2)&&(te$2.hide(),te$2=null);}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const t=this.view.renderSpatialReference;r$A(e)&&r$A(t)?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new P$k(-20037508.342787,20037508.342787):new P$k(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays();}get gpuMemoryUsage(){return this.renderer.gpuMemoryUsage}_updateLayerViews(){if(!this._layerViewsDirty)return;const e=new Set;for(const r of this.view.allLayerViews.items)e.add(r.uid),"drapeSourceType"in r&&!this._drapeSources.has(r)&&this._registerDrapeSource(r,0),"drapeTargetType"in r&&!this._drapeTargets.has(r)&&this._registerDrapeTarget(r);const t=this.view.graphicsView;r$A(t)&&!this._drapeSources.has(t)&&(this._registerDrapeSource(t,0),e.add(t.uid)),this._drapeSources.forEach(((t,r)=>{0!==t||e.has(r.uid)||this.unregisterDrapeSource(r);})),this._drapeTargets.forEach((t=>{e.has(t.uid)||this._unregisterDrapeTarget(t);})),this.renderer.updateLayerOrder(),this._setDrawTexturesDirty(),this._layerViewsDirty=!1;}registerDrapeSource(e){this._registerDrapeSource(e,1);}_registerDrapeSource(e,t){this._drapeSources.set(e,t),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources),this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running");}_updateDrapeSourceExtent(e){2===this.renderer.overlays.length&&r$A(e.setDrapingExtent)&&r$A(this._spatialReference)&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference);}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"));}_registerDrapeTarget(e){this._drapeTargets.add(e),this._updateDrapeTarget(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);}updateDrapeTargets(){this._drapeTargets.forEach((e=>this._updateDrapeTarget(e)));}_updateDrapeTarget(e){e.setDrapingTextures(this.renderer.overlays);}_unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets);}_setContentDirty(){this.setPlacementDirty(),this._setDrawTexturesDirty();}setPlacementDirty(){this._placementDirty=!0;}runTask(){this._updateOverlays(this.view.state.camera,1);}_updateOverlays(e,t){if(!this._spatialReference)return;this._updateLayerViews();const r=n$13(e.fullWidth,e.fullHeight,this._maxResolution);this._computeOverlayExtents(e,r,ne$1);const s=s$M(ne$1.inner)/s$M(ne$1.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const i=this._updateOverlay(0,ne$1.inner,r,1*ne$1.pixelRatioAdjustment,ne$1.mapUnitsPerPixel),a=this._updateOverlay(1,ne$1.outer,r,s*ne$1.pixelRatioAdjustment,ne$1.mapUnitsPerPixel);1!==i&&1!==a||(this._drapeSources.forEach(((e,t)=>this._updateDrapeSourceExtent(t))),this.surface.updateTileOverlayParams(t)),0===i&&0===a||this._setDrawTexturesDirty(),this._placementDirty=!1;}_updateOverlay(e,t,r,s,i){if(0===this.renderer.overlays.length)return 0;const a=this.renderer.overlays[e],n=a.mapUnitsPerPixel;if(a.mapUnitsPerPixel=i,a.pixelRatio=s,!se$1(t,a.extent)&&r===a.resolution)return n===i?0:2;a$10(a.extent,t),a.resolution=r;const o=p$V(a.extent);return a.renderLocalOrigin=c$Z(o[0],o[1],0,"OV_"+this._latestOriginId++),1}setTileParameters(e){const t=e.renderData.overlay;if(this.renderer.overlays.length>0){const r=this.renderer.overlays[0],s=this.renderer.overlays[1],i=E$l(e.extent,this.surface.extent,oe$1);this._rectInsideRect(r.extent,i)||this._rectanglesOverlap(i,r.extent)||this._rectanglesOverlap(i,s.extent)?(this._setTileOverlayData(i,0,t),this._setTileOverlayData(i,1,t)):(this._clearTileOverlayData(0,t),this._clearTileOverlayData(1,t));}else this._clearTileOverlayData(0,t),this._clearTileOverlayData(1,t);}overlayPixelSizeInMapUnits(e){if(0===this.renderer.overlays.length)return 0;const t=this.renderer.overlays[0],r=this.renderer.overlays[1],s=this._pointIsInExtent(e,t.extent)?t:r;return (s.extent[2]-s.extent[0])/s.resolution}_setTileOverlayData(e,t,r){if(0===this.renderer.overlays.length)return;const s=this.renderer.overlays[t].extent,i=s$M(s),a=l$J(s);let n=e[0];if(this._longitudeCyclical){n=this._longitudeCyclical.minimalMonotonic(s[0],n);const t=this._longitudeCyclical.minimalMonotonic(s[0],e[2]);n>t&&(n=t-(e[2]-e[0]));}r.setScale(t,s$M(e)/i,l$J(e)/a),r.setOffset(t,(n-s[0])/i,(e[1]-s[1])/a);}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1);}async reloadShaders(){e$h(),await this.renderer.reloadShaders(),this.runTask();}_dispatchRendererUpdate(e){const t=n$W(e.time-this._animationTimeLast);t<m$e&&t$F(this.forcedAnimationTime)||(this._animationTimeLast=e.time,this.renderer.updateLogic({dt:t,forcedTime:this.forcedAnimationTime,camera:this.view.state.camera})&&(this._drawTexturesAnimateDirty=!0));}_setDrawTexturesDirty(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0):this.setPlacementDirty();}_intersectGroundFromView(e,t,r,s){const i=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,le$1,t,r);if(t$F(i))return !1;const a=i.origin,n=u$A(ae$1,i.origin,i.direction);return this._groundIntersector.reset(a,n),this._groundIntersector.intersect([],null,e),this.view.basemapTerrain.intersect(this._groundIntersector,null,a,n),this._groundIntersector.results.min.getIntersectionPoint(s)}_findHorizonBasedPointOfInterest(e,t){let r=.5;const s=.55,a=this.view.renderCoordsHelper.getAltitude(e.eye),n=this.view.pointsOfInterest.centerOnSurfaceFrequent,o=1e-5,h=e$B(n.estimatedSurfaceAltitude,e.aboveGround?-1/0:a+o,e.aboveGround?a-o:1/0),l=e.aboveGround;if("global"===this.view.viewingMode){const t=ae$1;F$f(k$m(p$K(this.view.spatialReference).radius+h),j$r(e.eye,e.viewForward),t),c$O(t,t,e.eye);const i=S$p.normalize(i$_(e.viewForward,t,e.viewRight))/e.fovY+.5,a=i<=0||i>=1?.5:s;r=l?a*i:i+a*(1-i);}else {const t=.5*Math.PI-Math.acos(-e.viewForward[2]),a=Math.tan(t),n=r$L(0,a,1,0),o=y$w(n,n,e.projectionMatrix)[1],h=e$B(.5+.5*o,0,1);r=1===h||0===h?.5:l?h*s:1-(1-h)*s;}return !!this._intersectGroundFromView(e,.5,r,t)&&X$9(t,e.eye)<n.distance*n.distance}_computeOverlayExtents(e,t,r){const s=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,i=n$F();this._findHorizonBasedPointOfInterest(e,i)||r$B(i,s);const l=q$g(e.eye,i),c=n$r(this.view.renderCoordsHelper,s,e.eye),d=Math.PI/2-Math.abs(c-Math.PI/2);I$j.OVERLAY_SHOW_CENTER?(t$F(te$2)&&(te$2=new c$h(this.view.graphics,"red")),te$2.show(i,this._renderSR)):r$A(te$2)&&te$2.hide(),this._overlaySREqualsRenderSR||gn(i,this._renderSR,i,this._spatialReference);const p=this.surface.extent,_=!this._isSpherical&&r$A(this._spatialReference)&&this._spatialReference.isGeographic,y=_&&r$A(this._spatialReference)?1/p$K(this._spatialReference).metersPerDegree:1,g=e.perRenderPixelRatio*l*y;r.mapUnitsPerPixel=g/this._worldToPCSRatio;let w=t*g/2,R=!1,x=_?90:1/0;this._isSpherical&&r$A(p)&&r$A(this._spatialReference)&&(this._spatialReference.isWebMercator?(w/=Math.cos(c$_(i[1])),x=p[3]):(R=!0,w/=p$K(this._spatialReference).metersPerDegree,x=90),w>=x&&(w=x,i[1]=0,this._spatialReference.isWebMercator&&(i[0]=0)));let P=1;R&&(P=1/Math.max(.2,Math.cos(Math.abs(M$f(i[1])))),w*P>180&&(P=180/w),r.mapUnitsPerPixel*=P);const C=Math.log(2)/12;w=Math.exp(Math.round(Math.log(w)/C)*C);const I=w*P,E=32,V=.5*t/(E*I),A=.5*t/(E*w);i[0]=Math.round(i[0]*V)/V,i[1]=Math.round(i[1]*A)/A;const L=r.inner;L[0]=i[0]-I,L[1]=i[1]-w,L[2]=i[0]+I,L[3]=i[1]+w,this._isSpherical&&this._shiftExtentToFitBounds(L,1/0,x);const k=r.outer;if(6*I>s$M(p))a$10(k,e$z(p));else if(d<=.25*Math.PI)k[0]=L[0]-I,k[1]=L[1]-w,k[2]=L[2]+I,k[3]=L[3]+w;else {gn(e.eye,this._renderSR,ae$1,this._spatialReference),o$P(ie$1,i,ae$1);let t=-Math.atan2(ie$1[1],ie$1[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const r=Math.floor(t/(.25*Math.PI));l$I(ie$1,ee$2[r],2*w),ie$1[0]*=P,ie$1[2]*=P,s$R(k,L,ie$1);}if(this._isSpherical)k[0]=this._longitudeCyclical.clamp(k[0]),k[2]=this._longitudeCyclical.clamp(k[2]),k[1]=Math.max(k[1],-x),k[3]=Math.min(k[3],x);else {const e=E$l(L,p,oe$1),t=E$l(k,p,he$1);q$k(e,t)&&(k[2]=k[0],k[3]=k[1]);}const H=Math.abs(L[2]-L[0])/t;r.mapUnitsPerPixel=Math.max(r.mapUnitsPerPixel,H),r.pixelRatioAdjustment=r.mapUnitsPerPixel/H;}_drawOverlayTextures(e,t,r=this.view.state.camera){if(0===e.length||!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return;const s=this._drawTexturesDirty;this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1;const i=this._drawOverlay(e[0],r),a=this._drawOverlay(e[1],r);0!==i&&0!==a||this.surface.updateTileOverlayParams(1),this._collectUnusedRenderTargetMemory(),this.updateDrapeTargets(),s?(this.surface.requestRender(t),1===t&&this.surface.requestUpdate()):this.surface.requestRender(0);}_drawOverlay(e,t){return this._longitudeCyclical?e.setupGeometryViewsCyclical(this._longitudeCyclical):e.setupGeometryViewsDirect(),e.draw(this.renderer,t.pixelRatio)}_collectUnusedRenderTargetMemory(){if(this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays){const e=performance.now();this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory(e);}}_rectanglesOverlap(e,t){return !t$F(e)&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):k$o(e,t))}_rectInsideRect(e,t){return !t$F(t)&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:q$k(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const r=e.x,s=e.y;return r>t[0]&&r<t[2]&&s>t[1]&&s<t[3]}_shiftExtentToFitBounds(e,t,r){let s=0,i=0;e[0]<-t?s=e[0]+t:e[2]>t&&(s=t-e[2]),e[1]<-r?i=e[1]+r:e[3]>r&&(i=r-e[3]),d$J(e,s,i);}get test(){return {renderer:this.renderer,update:()=>this.runTask()}}};function se$1(e,t){const r=1e-5,s=I$j.TESTS_DISABLE_OPTIMIZATIONS?0:r*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);for(let i=0;i<4;i++)if(Math.abs(t[i]-e[i])>s)return !0;return !1}e$x([d$y()],re$1.prototype,"_spatialReference",void 0),e$x([d$y({readOnly:!0})],re$1.prototype,"running",null),e$x([d$y()],re$1.prototype,"_placementDirty",void 0),e$x([d$y()],re$1.prototype,"_contentUpdated",void 0),e$x([d$y()],re$1.prototype,"_layerViewsDirty",void 0),e$x([d$y()],re$1.prototype,"_isSpherical",null),e$x([d$y()],re$1.prototype,"_worldToPCSRatio",null),e$x([d$y()],re$1.prototype,"renderer",void 0),e$x([d$y({constructOnly:!0})],re$1.prototype,"surface",void 0),e$x([d$y({readOnly:!0,aliasOf:"surface.suspended"})],re$1.prototype,"suspended",void 0),e$x([d$y({readOnly:!0})],re$1.prototype,"updating",null),e$x([d$y({type:Boolean})],re$1.prototype,"hasHighlights",null),e$x([d$y({type:Boolean})],re$1.prototype,"rendersOccluded",null),re$1=e$x([i$H("esri.views.3d.terrain.OverlayManager")],re$1);const ie$1=n$P(),ae$1=n$F(),ne$1={inner:u$B(),outer:u$B(),mapUnitsPerPixel:0,pixelRatioAdjustment:1},oe$1=u$B(),he$1=u$B(),le$1=d$G();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class t$k{constructor(e,t){this._factoryCallback=e,this._lengthCallback=t,this._pool=new Map;}acquire(e){if(!t$k.test.disabled){const t=this._pool.get(e);if(t&&0!==t.length)return t.pop()}try{return this._factoryCallback(e)}catch(o){const t=window.performance&&window.performance.memory;let i="";throw t&&(i=`\n  totalJSHeapSize: ${t.totalJSHeapSize}, usedJSHeapSize: ${t.usedJSHeapSize}, jsHeapSizeLimit: ${t.jsHeapSizeLimit}`),console.log("Array allocation of size "+e+" failed: "+o+i),o}}release(o){if(t$k.test.disabled)return;const i=this._lengthCallback(o);let s=this._pool.get(i);s||(s=new n$Z({shrink:!0}),this._pool.set(i,s)),s.push(o);}clear(){this._pool.clear();}get test(){return {size:this._pool.size}}}t$k.test={disabled:!1};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const m$d=A$k().vec3f("position").vec2f("uv0"),g$9=new t$k((t=>m$d.createBuffer(t)),(t=>t.count));class p$c{constructor(){this.indices=null,this.vertexAttributes=null,this.boundingBox=B$g(),this.numSurfaceIndices=0,this.numSkirtIndices=0,this.numWithoutSkirtIndices=0,this.numVertsPerRow=0,this.skirtLength=0,this.uvOffsetAndScale=n$P();}}class h$a{constructor(t,e,n){this.values=t,this.numSurfaceIndices=e,this.numSkirtIndices=n;}}function y$6(){g$9.clear(),V$6.clear();}function d$f(t){g$9.release(t.vertexAttributes),t.vertexAttributes=null,t.indices=null;}const w$5=65536;function I$4(e,n,r,i,c,a,l,m){const p=c[0],h=c[1],y=c[2],d=c[3],w=.1*l.radius*(d-h),I=e.numVertsPerRow-1,v=e.numVertsPerRow-1,V=e.numVertsPerRow*e.numVertsPerRow,x=2*I+2*v,b=g$9.acquire(V+x),R=b.position.typedBuffer,k=b.uv0.typedBuffer,j=i.geometryInfo.boundingBox;B$g(j);const L=n[2]-n[0],O=n[3]-n[1],U=y-p,E=r[0],N=r[1],W=r[2];for(let t=0;t<=I;t++){const e=t/I,o=p+e*U;B$6[t]=Math.sin(o),D$5[t]=Math.cos(o),T$5[t]=e,q$4[t]=n[0]+e*L;}const C=a&&!!(1&m),F=a&&!!(2&m);let z=0;for(let o=0;o<=v;o++){let r=o/v;const s=s$F(h,d,r),i=Math.cos(s),c=Math.sin(s);let m;a?(m=l.halfSemiMajorAxis*Math.log((1+c)/(1-c)),r=(m-n[1])/O):m=180*s/Math.PI;for(let t=0;t<=I;t++){const n=T$5[t],s=B$6[t],a=D$5[t];let g=l.radius;e.samplerData&&(g+=i$b.sample(q$4[t],m,e.samplerData)||0);const p=a*i*g-E,h=s*i*g-N,y=c*g-W;P$6(p,h,y,j);const d=V$d*z;R[d+0]=p,R[d+1]=h,R[d+2]=y,k[d+0]=n,k[d+1]=r;const M=S$7(t,o,I,v);if(M>-1){const t=V$d*(V+M),e=C&&0===o?-1:F&&o===v?1:0,s=0===e?p:-E,i=0===e?h:-N,c=0===e?y:l.radius*e-W;R[t+0]=s,R[t+1]=i,R[t+2]=c,k[t+0]=0===e?A$5(n,r):n,k[t+1]=0===e?w:r,0!==e&&P$6(s,i,c,j);}++z;}}i.geometryInfo.numVertsPerRow=e.numVertsPerRow,i.geometryInfo.vertexAttributes=b,i.geometryInfo.skirtLength=w,r$P(i.geometryInfo.uvOffsetAndScale,0,0,1,1),M$6(i.geometryInfo,e.numVertsPerRow,a?m:0,e.wireframe),i.intersectionData=null,i.skirtIntersectionData=null;}function v$8(t,n,r,i,c){const a=n[0],l=n[1],m=n[2]-a,p=n[3]-l,h=t.clippingArea,y=r$A(h)?Math.max(0,(h[0]-n[0])/m):0,d=r$A(h)?Math.max(0,(h[1]-n[1])/p):0,w=r$A(h)?Math.min(1,(h[2]-n[0])/m):1,I=r$A(h)?Math.min(1,(h[3]-n[1])/p):1,v=w>y?1/(w-y):1,V=I>d?1/(I-d):1,x=-y*v,b=-d*V,R=m*i*.1,k=t.numVertsPerRow-1,j=t.numVertsPerRow-1,B=t.numVertsPerRow*t.numVertsPerRow,D=2*k+2*j,T=g$9.acquire(B+D),q=T.position.typedBuffer,L=T.uv0.typedBuffer,O=c.geometryInfo.boundingBox;B$g(O);let U=0;for(let o=0;o<=j;o++){const n=o/j;let s=b+n*V,c=l+n*p;r$A(h)&&(c<h[1]?(c=h[1],s=0):c>h[3]&&(c=h[3],s=1));for(let l=0;l<=k;l++){const n=l/k;let g=x+n*v,p=a+n*m;r$A(h)&&(p<h[0]?(p=h[0],g=0):p>h[2]&&(p=h[2],g=1));const y=t.samplerData&&i$b.sample(p,c,t.samplerData)||0,d=p*i-r[0],w=c*i-r[1],I=y-r[2];P$6(d,w,I,O);const V=V$d*U;q[V+0]=d,q[V+1]=w,q[V+2]=I,L[V+0]=g,L[V+1]=s;const M=S$7(l,o,k,k);if(M>-1){const t=V$d*(B+M);q[t+0]=d,q[t+1]=w,q[t+2]=I,L[t+0]=A$5(g,s),L[t+1]=R;}++U;}}c.geometryInfo.numVertsPerRow=t.numVertsPerRow,c.geometryInfo.vertexAttributes=T,c.geometryInfo.skirtLength=R,r$P(c.geometryInfo.uvOffsetAndScale,y,d,w-y,I-d),M$6(c.geometryInfo,t.numVertsPerRow,0,t.wireframe),c.intersectionData=null,c.skirtIntersectionData=null;}const V$6=new Map;function M$6(t,e,n,o){const r=(2&n)>0,s=e+(o?1024:0)+(r?2048:0);let i=V$6.get(s);i||(i=x$7(e,r,o),V$6.set(s,i)),t.indices=i.values,t.numSurfaceIndices=i.numSurfaceIndices,t.numSkirtIndices=i.numSkirtIndices,t.numWithoutSkirtIndices=t.numSurfaceIndices+(n?6*(e-1)*(o?2:1):0);}function x$7(t,e,n){const o=t-1,r=t-1,s=t*t,i=2*o+2*r;let c=o*r*2*3,u=6*i,a=6*(2*o+r-1);n&&(c*=2,u*=2,a*=2);const f=s+i>w$5?new Uint32Array(c+u):new Uint16Array(c+u);let l,m,g,p,y=0,d=0,I=c,v=0;for(let h=0;h<=r;h++){e&&(v=0===h?a:h===r?-a:0),I+=v;for(let t=0;t<=o;t++){const e=S$7(t,h,o,r);if(e>-1){const i=b$6(t,h,o,r);0!==i&&(l=y,m=s+e,g=s+(0===t&&1===h?0:e+1),p=y+i,n?(f[I+0]=l,f[I+1]=m,f[I+2]=m,f[I+3]=g,f[I+4]=g,f[I+5]=l,f[I+6]=g,f[I+7]=p,f[I+8]=p,f[I+9]=l,f[I+10]=l,f[I+11]=g,I+=12):(f[I+0]=l,f[I+1]=m,f[I+2]=g,f[I+3]=g,f[I+4]=p,f[I+5]=l,I+=6));}++y,t<o&&h<r&&(l=h*(o+1)+t,m=l+1,g=m+(o+1),p=g-1,n?(f[d+0]=l,f[d+1]=m,f[d+2]=m,f[d+3]=g,f[d+4]=g,f[d+5]=l,f[d+6]=g,f[d+7]=p,f[d+8]=p,f[d+9]=l,f[d+10]=l,f[d+11]=g,d+=12):(f[d+0]=l,f[d+1]=m,f[d+2]=g,f[d+3]=g,f[d+4]=p,f[d+5]=l,d+=6));}I-=v;}return new h$a(f,c,u)}function P$6(t,e,n,o){t<o[0]&&(o[0]=t),t>o[3]&&(o[3]=t),e<o[1]&&(o[1]=e),e>o[4]&&(o[4]=e),n<o[2]&&(o[2]=n),n>o[5]&&(o[5]=n);}function A$5(t,e){const n=e>t?1:0;return 2+4*n+(1-2*n)*(t+e)}function S$7(t,e,n,o){return 0===e?t:t===n?n+e:e===o?n+o+(n-t):0===t&&e>0?2*n+o+(o-e):-1}function b$6(t,e,n,o){return 0===e&&t!==n?1:t===n&&e!==o?n+1:e===o&&0!==t?-1:0===t&&0!==e?-(n+1):0}function R$6(t,n,o,r,s,i,c,u,a,f){const m=i.position,g=i.uv0,p=t[0],h=t[1],y=t[2],d=n[0]-p,w=n[1]-h,I=n[2]-y;r*=3;for(let v=o*=3;v<r;v+=3){const t=s[v],n=s[v+1],o=s[v+2];let r=m.get(t,0),i=m.get(t,1),V=m.get(t,2),M=m.get(n,0),x=m.get(n,1),P=m.get(n,2),A=m.get(o,0),S=m.get(o,1),b=m.get(o,2);if(g.get(t,0)>=2){const t=r+u[0],e=i+u[1],n=V+u[2],o=c/Math.sqrt(t*t+e*e+n*n);r+=t*o,i+=e*o,V+=n*o;}if(g.get(n,0)>=2){const t=M+u[0],e=x+u[1],n=P+u[2],o=c/Math.sqrt(t*t+e*e+n*n);M+=t*o,x+=e*o,P+=n*o;}if(g.get(o,0)>=2){const t=A+u[0],e=S+u[1],n=b+u[2],o=c/Math.sqrt(t*t+e*e+n*n);A+=t*o,S+=e*o,b+=n*o;}r$A(a)&&([r,i,V]=a.applyToVertex(r,i,V),[M,x,P]=a.applyToVertex(M,x,P),[A,S,b]=a.applyToVertex(A,S,b));const R=M-r,k=x-i,j=P-V,B=A-r,D=S-i,T=b-V,q=w*T-D*I,O=I*B-T*d,U=d*D-B*w,E=R*q+k*O+j*U;if(Math.abs(E)<=Number.EPSILON)continue;const N=p-r,W=h-i,C=y-V,F=N*q+W*O+C*U;if(E>0){if(F<0||F>E)continue}else if(F>0||F<E)continue;const z=W*j-k*C,G=C*R-j*N,H=N*k-R*W,J=d*z+w*G+I*H;if(E>0){if(J<0||F+J>E)continue}else if(J>0||F+J<E)continue;const K=(B*z+D*G+T*H)/E;if(K>=0){f(K,T$h(R,k,j,B,D,T,L$5));}}}function k$4(t,e,n,o,r,s){const i=o.position,c=o.uv0,u=new Map,a=3*e,f=3*n-a,l=new Uint32Array(f);let m=0;for(let p=0;p<f;++p){const e=t[p+a];if(u.has(e))l[p]=u.get(e);else {const t=m++;u.set(e,t),l[p]=t;}}const g=new Float64Array(3*m);return u.forEach(((t,e)=>{let n=i.get(e,0),o=i.get(e,1),u=i.get(e,2);if(c.get(e,0)>=2){const t=n+s[0],e=o+s[1],i=u+s[2],c=r/Math.sqrt(t*t+e*e+i*i);n+=t*c,o+=e*c,u+=i*c;}g[3*t+0]=n,g[3*t+1]=o,g[3*t+2]=u;})),{vertices:g,indices:l}}function j$5(t,n,o,r,s,i,c,u,a){const f=i.position,m=i.uv0,g=t[0],p=t[1],h=t[2],y=n[0]-g,d=n[1]-p,w=n[2]-h;r*=3;for(let I=o*=3;I<r;I+=3){const t=s[I],n=s[I+1],o=s[I+2];let r=f.get(t,0),i=f.get(t,1),v=f.get(t,2),V=f.get(n,0),M=f.get(n,1),x=f.get(n,2),P=f.get(o,0),A=f.get(o,1),S=f.get(o,2);m.get(t,0)>=2&&(v+=c);m.get(n,0)>=2&&(x+=c);m.get(o,0)>=2&&(S+=c),r$A(u)&&([r,i,v]=u.applyToVertex(r,i,v),[V,M,x]=u.applyToVertex(V,M,x),[P,A,S]=u.applyToVertex(P,A,S));const b=V-r,R=M-i,k=x-v,j=P-r,B=A-i,D=S-v,T=d*D-B*w,q=w*j-D*y,O=y*B-j*d,U=b*T+R*q+k*O;if(Math.abs(U)<=Number.EPSILON)continue;const E=g-r,N=p-i,W=h-v,C=E*T+N*q+W*O;if(U>0){if(C<0||C>U)continue}else if(C>0||C<U)continue;const F=N*k-R*W,z=W*b-k*E,G=E*R-b*N,H=y*F+d*z+w*G;if(U>0){if(H<0||C+H>U)continue}else if(H>0||C+H<U)continue;const J=(j*F+B*z+D*G)/U;if(J>=0){a(J,T$h(b,R,k,j,B,D,L$5));}}}const B$6=new Array(e$Q+1),D$5=new Array(e$Q+1),T$5=new Array(e$Q+1),q$4=new Array(e$Q+1),L$5=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class r$i{constructor(){this._queue=new n$Z,this._last=null,this.remove=()=>{};}get done(){return 0===this._queue.length&&(!this._last||this._last.isLeaf)}resetOne(t){this._queue.clear(),this._queue.push(t),this._last=null;}reset(e=null){this._queue.clear(),r$A(e)&&this._queue.pushArray(e),this._last=null;}skipSubtree(){this._last=null;}next(){return this._last&&!this._last.isLeaf&&this._queue.pushArray(this._last.children),this._last=this._queue.pop(),this._last}}class s$d{constructor(){this.q=new n$Z;}get done(){return 0===this.q.length}reset(t){if(this.q.clear(),!t$F(t)){this.q.pushArray(t);for(let t=0;t<this.q.length;++t){const e=this.q.data[t];e.isLeaf||this.q.pushArray(e.children);}}}next(){return this.q.pop()}}function u$e(t,n,r){if(t$F(n)||t$F(n.fullExtent))return !1;const s=n.fullExtent,i=t.extent;if(r){if(i[0]<s.xmin||i[1]<s.ymin||i[2]>s.xmax||i[3]>s.ymax)return !1}else if(s.xmin>i[2]||s.ymin>i[3]||s.xmax<i[0]||s.ymax<i[1])return !1;const l=t.surface.tilingScheme.levels[t.lij[0]].scale;return !(n.minScale>0&&l>1.00000001*n.minScale)&&!(n.maxScale>0&&l<.99999999*n.maxScale)}function o$i(t,e){e.sort(((e,n)=>a$e(e,n,t)));}function a$e(t,e,n){const r=t.screenDepth,s=e.screenDepth;return r<s?-n:r>s?n:0}function h$9(t,e){const n=new Map;t.forAll((t=>n.set(t,t.distanceToSquared(e)))),t.sort(((t,e)=>n.get(t)-n.get(e)));}function c$f(t,e,n){let r=1,s=0,i=0;for(;t!==e;)if(r*=.5,s*=.5,i*=.5,1&t.lij[2]&&(s+=.5),0==(1&t.lij[1])&&(i+=.5),null==(t=t.parent))throw new Error("tile was not a descendant of upsampleTile");n.init(e,s,i,r);}function f$b(t){for(let e=0;e<t.length;e++){const n=t[e],r=n.parent;if(r)for(let t=0;t<4;t++){const e=r.children[t];if(e&&e!==n&&e.loadable)return !0}}return !1}function m$c(t,e){if(!t||!e||t[0]===e[0])return !1;const n=t[0]<e[0],r=n?t:e,s=n?e:t,i=1<<s[0]-r[0];return Math.floor(s[1]/i)===r[1]&&Math.floor(s[2]/i)===r[2]}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class r$h{get updating(){return !!this._tileRequested}init(e,t,s,i){this.tile=e,this._layerIdx=t,this._layerClass=s,this._suspended=i,this._tileLayerInfo=e.getLayerInfo(t,s),this._tileRequested=null;const l=this._findAncestorWithData();this._setUpsampleTile(l);}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null;}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update());}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e){this._setUpsampleTile(e),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,0):this._requestNext();}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext();}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose();}_requestNext(){if(this._suspended)return !0;const t=this._findNextDownload();if(this._tileRequested){if(t===this._tileRequested)return !0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null;}return r$A(t)?t.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=t):this._agentDone(),!!this._tileRequested}_findNextDownload(){const r=this._layerIdx,n=this._layerClass,h=this.tile.surface.layerViewByIndex(r,n),d=s$S(h),{minLevel:_,maxLevel:o}=h.dataLevelRange,u=this._desiredMinLevelDelta,p=this._progressiveLevelModulo+u,y=this._scaleRangeEnabled?u$e:()=>!0;let f=this.tile;const q=f.level;let v;const I=this._tileLayerInfo.upsampleInfo,L=I?I.tile.level:-1,m=m$F(d,"tilemapCache");for(;f&&y(f,d,!1)&&f.level>=_;){const e=f.level,t=q-e,l=f.layerInfo[n][r];if(l.data&&t>=u){e>L&&this._setUpsampleTile(f),l.dataInvalidated&&(v=f);break}if((t$F(m)||"unavailable"!==m.getAvailability(f.lij[0],f.lij[1],f.lij[2]))&&e<=o&&!l.data&&!l.dataMissing&&((t$F(v)||f.level===_||e%r$X==0||q-v.level<u)&&(v=f),t>=p))break;f=f.parent;}return r$A(v)&&q-v.level<u&&this._tileLayerInfo.upsampleInfo&&(v=null),v}_findAncestorWithData(){const e=this.tile.vlevel,t=this._desiredMinLevelDelta;let s;for(let i=this.tile;i;i=i.parent)if(i.hasLayerData(this._layerIdx,this._layerClass)){if(e-i.level>=t)return i;s=i;}return s}_setUpsampleTile(e){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,0);}get test(){return {findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}class n$h extends r$h{get _desiredMinLevelDelta(){throw h$8}get _progressiveLevelModulo(){throw h$8}dispose(){}}const h$8=new Error("Abstract method called on TileAgent"),d$e=new n$h;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class r$g extends r$h{constructor(){super(...arguments),this._scaleRangeEnabled=!1;}get _desiredMinLevelDelta(){return E$m-(this.tile.vlevel-this.tile.level)}get _progressiveLevelModulo(){return 0}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class t$j extends r$h{constructor(){super(),this._scaleRangeEnabled=!0;}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return r$X}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const m$b={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class d$d{constructor(t,e,r=null,s=null){this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.scale=1,this.offset=[0,0],this.opacity=1,this.lij=t,this.source=e,this.width=r||e.width,this.height=s||e.height;}get source(){return this._source}set source(t){this._source=t,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._memoryUsed=null);}get symbolizerParameters(){return this.isRendereredSource?{...m$b,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||m$b}set symbolizerParameters(t){this._symbolizerParameters=t;}get bandIds(){return this._bandIds}set bandIds(e){if(r$A(e)&&e.length>0){this._bandIds&&e.every(((t,e)=>!!this._bandIds[e]&&t===this._bandIds[e]))||(this._bandIds=e,this._dirty=!0);}else this._bandIds=null;}get interpolation(){return this._interpolation||"nearest"}set interpolation(t){if(this._interpolation=t,this._rasterTexture){const e=this._getRasterTextureInterpolation(t);this._rasterTexture.setSamplingMode("bilinear"===e?9729:9728);}}get transformGrid(){return this._transformGrid}set transformGrid(t){this._transformGrid=t,this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null,this._memoryUsed=null);}bind(t){return !!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&(this._rasterTexture&&!this._dirty||this._updateRasterTexture(t,this.bandIds),this._rasterTexture&&(this._updateColormapTexture(t),this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=i$$(t,this.transformGrid))),!0)}getUniforms(){const t=u$J(this.scale,this.offset),{symbolizerParameters:e,transformGrid:r,width:s,height:n,opacity:u}=this;return {basic:t,common:o$Q(r,[s,n],[this.source.width,this.source.height],u),colormap:e.colormap?s$T(e.colormap,e.colormapOffset):null,stretch:"stretch"===this.symbolizerParameters.type?l$M(this.symbolizerParameters):null,hillshade:"hillshade"===this.symbolizerParameters.type?f$C(this.symbolizerParameters):null}}getTextures(){const t=new Array,e=[];return this._rasterTexture&&(e.push(this._rasterTexture),t.push("u_image"),this._transformGridTexture&&(e.push(this._transformGridTexture),t.push("u_transformGrid")),this._colormapTexture&&(e.push(this._colormapTexture),t.push("u_colormap"))),{names:t,textures:e}}get memoryUsage(){if(t$F(this._memoryUsed)){const t=this.getTextures();if(null==t)return 0;this._memoryUsed=t.textures.map((t=>t.descriptor.width*t.descriptor.height*4)).reduce(((t,e)=>t+e),0);}return this._memoryUsed}release(){return this._rasterTexture=i$M(this._rasterTexture),this._transformGridTexture=i$M(this._transformGridTexture),this._colormapTexture=i$M(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(r,s){const i=this.source?this.source.extractBands(s):null;if(!(i&&i.pixels&&i.pixels.length>0))return void(this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null));const o=t$F(s)&&t$F(this.bandIds)||r$A(s)&&r$A(this.bandIds)&&s.join("")===this.bandIds.join("");if(this._rasterTexture){if(o)return;this._rasterTexture.dispose(),this._rasterTexture=null;}const a=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=n$14(r,i,a,this.isRendereredSource||this.hasStretchTypeNone());}hasStretchTypeNone(){return "stretchType"in this.symbolizerParameters&&"none"===this.symbolizerParameters.stretchType&&!this.symbolizerParameters.useGamma&&"u8"===this.source.pixelType}_getRasterTextureInterpolation(t){return "lut"===this.symbolizerParameters.type||"nearest"===t||"majority"===t?"nearest":"bilinear"}_updateColormapTexture(t){const e=this._colormap,r=this.symbolizerParameters.colormap;return r?e?r.length!==e.length||r.some(((t,r)=>t!==e[r]))?(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=r$Y(t,r),void(this._colormap=r)):void 0:(this._colormapTexture=r$Y(t,r),void(this._colormap=r)):(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),void(this._colormap=null))}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class l$c{constructor(){this.waitingAgents=new n$Z,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0;}static acquire(t){const s=p$b.acquire();return s._init(t),s}release(){this.dispose(),r$f.delete(this),p$b.release(this);}dispose(){this.loadingAgent=i$M(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=S$r(this._data);}static prune(){p$b.prune(0);}_init(t){this.waitingAgents.clear(),this._data=S$r(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=t,this.elevationBounds=null;}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo();}abortRequest(){this.requestAbort=a$X(this.requestAbort),this.requestPromise=null;}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){this._upsampleInfo&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null);}setUpsampleInfo(t,s){if(t===s||t$F(s))this._unsetUpsampleInfo();else {if(null==this._upsampleInfo)this._upsampleInfo=this._pool.acquire();else {if(this._upsampleInfo.tile===s)return;this._upsampleInfo.tile.unrefMapData();}s.refMapData(),c$f(t,s,this._upsampleInfo);}}get data(){return this._data}set data(t){S$r(this._data),this._data=t;}}const p$b=new e$L(l$c,null,(()=>{})),r$f=new Map;function h$7(){r$f.size>0&&(console.log(`${r$f.size} live TilePerLayerInfo allocations:`),r$f.forEach((t=>console.log(t,"\n"))));}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class t$i{constructor(t){this._texture=t,this.type="tile-texture",this._refCount=1;}retain(){++this._refCount;}release(){--this._refCount,0===this._refCount&&this._texture.dispose();}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap();}get descriptor(){return this._texture.descriptor}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const R$5=n$F(),E$6=n$F(),V$5=n$F(),W$4=.1;class k$3{constructor(){this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0;}}class N$8{constructor(){this.lij=[0,0,0],this._children=[null,null,null,null],this._dirty=!0,this._previouslyRendered=!1,this.extent=u$B(),this._elevationBounds=n$Q(),this.layerInfo=[[],[]],this.extentInRadians=u$B(),this.centerAtSeaLevel=n$F(),this._center=[n$F(),P$m(),n$F()],this.up=i$10(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=F$5,this._mapTileMemory=0,this._mapDataRefCount=0,this._screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0;}static prune(){H$6.prune(0),$$4.prune(0),l$c.prune();}get usedMemory(){return this._usedMemory===F$5&&this._updateMemoryUsed(),this._usedMemory+(this.isCached?0:this.mapTileMemory)}get cachedMemory(){return this.isCached?this.mapTileMemory:0}get mapTileMemory(){this._usedMemory===F$5&&this._updateMemoryUsed();let e=this._mapTileMemory;for(const{data:t}of this.layerInfo[1])t instanceof d$L&&(e+=t.memoryUsage);return e}get isCached(){return !this.shouldLoad&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBounds(){return this._elevationBounds}get level(){return this.lij[0]}get key(){return `${this.lij[0]}/${this.lij[1]}/${this.lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[1][3]}get screenDepth(){return this._screenDepth}get visible(){return this._dirty&&this.updateVisibilityNow(),this._visible}updateVisibilityNow(){this._dirty=!1;const e=this._intersectsClippingArea&&this._isVisible(this.surface.frustum);return e!==this._visible&&(this._visible=e,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setNeedsRender(),this.updateAgentSuspension()),this._visible}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setNeedsRender()),e}get shouldLoad(){if(!this.loadable)return !1;if(1===this._surface.lodSnapping){const e=this.level-this._surface.snapLevel;if(0===e)return !0;if(1===e)return !1}return this.isLeaf}init(e,t,i){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],this.ellipsoid=p$K(i.tilingScheme.spatialReference),i.tilingScheme.getExtent(e[0],e[1],e[2],this.extent),i.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,i.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[1][3]=0,this.vlevel=e?e[0]:0,t&&t.elevationBounds?a$Y(this._elevationBounds,t.elevationBounds):r$K(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this._screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=t,this.unsetChildren(),this._surface=i,this.updateVisibility();for(const s of o$R){const e=i.numLayers(s),t=this.layerInfo[s];for(const i of t)i.release();t.length=e;for(let i=0;i<e;i++)t[i]=l$c.acquire(this._surface.upsampleInfoPool),0===s&&this.findElevationBoundsForLayer(i,-1);}this.computeElevationBounds(),this._maxTesselation=Math.min(i.tilingScheme.pixelSize,e$Q);}release(){r$Z(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);for(const e of o$R){for(const t of this.layerInfo[e])t.release();this.layerInfo[e].length=0;}this._parent=null,this._surface=null,this._usedMemory=F$5;}refMapData(){++this._mapDataRefCount,this.isCached||this._surface.upsampleMapCache.pop(this.key);}unrefMapData(){if(--this._mapDataRefCount,this.isCached){const e=this.cachedMemory;e>0&&(this._surface.upsampleMapCache.put(this.key,this,e),this.setMemoryDirty());}}setMemoryDirty(){this._usedMemory=F$5;}get cpuImageMemorySize(){const e=4,t=this._surface.tilingScheme.pixelSize;return t*t*e}_updateMemoryUsed(){this._usedMemory=0,this._mapTileMemory=0;const e=this.cpuImageMemorySize;for(const{data:t}of this.layerInfo[1])t instanceof t$i?this._mapTileMemory+=n$15(t.texture):t instanceof HTMLImageElement||t instanceof j$u?this._mapTileMemory+=e:t instanceof d$d&&(this._mapTileMemory+=t.memoryUsage);for(const t of this.layerInfo[0])this._usedMemory+=t.data?e:0;this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemory+=n$15(this.renderData.textureDescriptor)),this.isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this.cachedMemory);}getUsedMemoryForLayer(e,t){const i=this.layerInfo[e][t];if(!i||!i.data)return 0;if(1!==e||this.isCached){if(0===e)return this.cpuImageMemorySize}else {const e=i.data;if(e instanceof t$i)return n$15(e.texture);if(e instanceof HTMLImageElement||e instanceof j$u)return this.cpuImageMemorySize;if(e instanceof d$L||e instanceof d$d)return e.memoryUsage}return 0}updateScreenDepth(e){const t=this._center[1],i=e,s=t[0],n=t[1],r=t[2],a=i[2]*s+i[6]*n+i[10]*r+i[14];this._screenDepth=a<0?0:a/(i[3]*s+i[7]*n+i[11]*r+i[15]);}shouldSplit(e,i,s){if(r$A(e.frustum)&&(!this._intersectsClippingArea||!this._isVisible(e.frustum)))return 0;const n=this.level;c$O(R$5,this._center[1],i);let r=p$Q(R$5),a=1;c$O(E$6,this._center[0],i);const o=p$Q(E$6);o<r&&(r=o,a=0),c$O(E$6,this._center[2],i);const g=p$Q(E$6);if(g<r&&(r=g,a=2),this._edgeLen2>r&&n<e.maxLod)return 2;const f=Math.sqrt(r),m=e.fovX*f*2,_=this._edgeLen/m,y=()=>{const t=n+Math.ceil(-Math.log2(e.relativeWidthLimit/_));return t!==this.vlevel?(this.vlevel=t,4):1};if(1===s){if(1===this._surface.snapLevel-n)return n>=e.maxLod?y():2}const v=z$i(this.up,R$5),A=this._elevationBounds[1]-this._elevationBounds[0],M=A/this.edgeLen;if(e.aboveGround&&v>0&&M<.001){if(v/f-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-M>0)return 0}if(_<e.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,4):0;if(n>=e.maxLod)return y();if(n>6){c$O(E$6,this._center[a],i),d$z(V$5,this.up,v),c$O(V$5,V$5,E$6);const t=p$Q(V$5);if(t>this.radius*this.radius){d$z(V$5,V$5,this.radius/Math.sqrt(t)),u$A(V$5,V$5,this._center[a]),c$O(V$5,i,V$5);const s=Math.min(1,(Math.abs(z$i(V$5,this.up))+.5*A+this._curvatureHeight)/s$x(V$5)),n=W$4/e.angledSplitBias,r=e.fovY*f*2;if(s*(this._edgeLen/r)<n*e.relativeHeightLimit)return 0}}return 2}setChildren(e,t,i,s){r$Z(!!(e&&t&&i&&s),"Null child passed"),this._children[0]=e,this._children[1]=t,this._children[2]=i,this._children[3]=s;}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null;}load(e){this.refMapData();for(const t of o$R)this._createOrUpdateAgents(0,t);e.loadTile(this);}unload(e){e.unloadTile(this);for(const t of o$R){const e=this.layerInfo[t];for(const t of e)t.loadingAgent&&t.loadingAgent!==d$e&&(z$5(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0;}this.resetPendingUpdate(32),this.resetPendingUpdate(64),this.resetPendingUpdate(128),this.unrefMapData();}unloadMapData(){const e=this.layerInfo[1];for(const t of e)t.loadingAgent&&t.loadingAgent!==d$e&&(z$5(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty();}updateClippingStatus(e){if(G$i(e,this._clippingArea))return !1;const i=this._intersectsClippingArea,s=this._isWithinClippingArea;r$A(e)?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const n=s&&this._isWithinClippingArea,r=!(s||i||this._isWithinClippingArea||this._intersectsClippingArea);return !this.renderData||n||r||this.setPendingUpdate(32),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty();}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const i=this.layerInfo[t][e];return !(!i||!i.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return !0;for(const e of o$R){const t=this.layerInfo[e];for(const e of t)if(e.loadingAgent&&e.loadingAgent!==d$e&&e.loadingAgent.updating)return !0}return !1}isSuspended(e){return !!this.hasPendingUpdate(2)||0!==e&&!this.loadable}get hasPendingUpdates(){return 0!==this._pendingUpdates}hasPendingUpdate(e){return (this._pendingUpdates&e)===e}setPendingUpdate(e){this._pendingUpdates|=e,2===e||8===e?this._surface.setTileTreeDirty():this._surface.requestUpdate();}resetPendingUpdate(e){return !!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,s){const n=this.layerInfo[t][e];if(n.waitingAgents.has(s))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),s.tile.lij.toString(),t,e),!0;if(n.waitingAgents.push(s),n.data&&!n.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),s.tile.lij.toString(),t,e),s.dataArrived(this),!0;if(n.requestPromise)return !0;a$X(n.requestAbort),n.requestAbort=new AbortController;const r=this._surface.requestTileData(this,e,t,n.requestAbort);if(!r)return n.requestAbort=null,!1;const a=()=>{n.requestPromise===r&&(n.requestPromise=null,n.requestAbort=null);};return n.requestPromise=r,r.then(a,a),!0}get isLeaf(){return null==this._children[0]}hasLij(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;if(this.isLeaf)return null;const t=this._children[0].findByLij(e)||this._children[1].findByLij(e)||this._children[2].findByLij(e)||this._children[3].findByLij(e);return t||null}distanceToSquared(e){return p$Q(c$O(V$5,this._center[1],e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}unrequestLayerData(e,t,i){const s=this.layerInfo[t][e],n=s.waitingAgents,r=null!=n.removeUnordered(i);r$Z(r,"agent has not requested this piece of map data"),n.length<1&&(s.abortRequest(),this._updateMemoryUsed());}dataArrived(e,t,i){const s=this.layerInfo[t][e];s.data=i,s.dataInvalidated=!1,s.waitingAgents.forAll((e=>e.dataArrived(this))),s.waitingAgents.clear(),this._updateMemoryUsed();}dataMissing(e,t,i){i.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${t}/${e} error ${i}`);const s=this.layerInfo[t][e];s.dataMissing=!0,s.waitingAgents.forAll((e=>e.dataMissing())),s.waitingAgents.clear(),this._updateMemoryUsed();}updateRenderData(e,t){switch(e){case 1:return this.updateTexture(t);case 0:return this.updateGeometry()}}updateTexture(e){this.renderData&&(this.resetPendingUpdate(0===e?64:128),this.setPendingUpdate(0===e?128:64));}updateGeometry(){this.setPendingUpdate(32);for(const e of this.layerInfo[0])e.pendingUpdates|=32;}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t);}computeElevationBounds(){r$K(this._elevationBounds,Number.MAX_VALUE,-Number.MAX_VALUE);const e=this.layerInfo[0];let i=!0;for(const s of e)r$A(s.elevationBounds)&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],s.elevationBounds.min),this._elevationBounds[1]=Math.max(this._elevationBounds[1],s.elevationBounds.max),s.elevationBounds.hasNoDataValues||(i=!1));i&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],0),this._elevationBounds[1]=Math.max(this._elevationBounds[1],0)),this.updateRadiusAndCenter(),this._surface.setTileTreeDirty();}_updateCenter(){const e=.5*(this._elevationBounds[0]+this._elevationBounds[1]);d$z(V$5,this.up,e),u$A(this._center[1],this.centerAtSeaLevel,V$5),d$z(V$5,this.up,this._elevationBounds[0]),u$A(this._center[0],this.centerAtSeaLevel,V$5),d$z(V$5,this.up,this._elevationBounds[1]),u$A(this._center[2],this.centerAtSeaLevel,V$5);}findElevationBoundsForLayer(e,i){const n=this.layerInfo[0][e];if(r$A(n.elevationBounds)&&n.elevationBounds.level>=i)return;const r=this._surface.layerViewByIndex(e,0),a=s$S(r);if(!u$e(this,a,!1))return;const o=G$4;let h=!1;if(n.data){const e=n.data;o.min=e.bounds[0],o.max=e.bounds[1],o.hasNoDataValues=e.hasNoDataValues,o.level=this.lij[0],h=!0;}else {let t,i,s=0;for(let n=this._parent;n&&(!i||s<E$m)&&(s=this.vlevel-n.level,t=i||t,i=n.layerInfo[0][e].data,!(!i&&t&&s>=E$m));n=n.parent);i=i||t,i&&(i.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],o),o.min!==1/0&&(o.level=i.level,h=!0));}h&&(t$F(n.elevationBounds)&&(n.elevationBounds=new s$e),n.elevationBounds.copyFrom(o));}modifyLayers(e,t,i){const s=this.layerInfo[i];for(const a of s)a.loadingAgent&&a.loadingAgent!==d$e&&(z$5(a.loadingAgent),a.loadingAgent=null),a.waitingAgents.clear();for(let a=0;a<s.length;++a)void 0===e[a]&&s[a].release();const n=new Array(...s),r=t.length;s.length=r;for(let a=0;a<r;a++){const e=t[a];s[a]=e>-1?n[e]:l$c.acquire(this._surface.upsampleInfoPool);}this._updateMemoryUsed();}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,0));}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const e of t)e.loadingAgent===d$e&&(e.loadingAgent=null);this._createOrUpdateAgents(0,e);}}updateAgentSuspension(){for(const e of o$R){const t=this.isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==d$e&&(i.loadingAgent.setSuspension(t),i.loadingAgent===d$e&&this.updateRenderData(e,0));}}removeLayerAgent(e,t){const i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==d$e&&i.loadingAgent.dispose(),i.loadingAgent=null;}agentDone(e,t){const i=this.layerInfo[t][e];i.loadingAgent=d$e,i.data||i.upsampleInfo||this._createOrUpdateAgents(e+1,t);}_createOrUpdateAgents(e,t){const i=this.isSuspended(t),s=this.layerInfo[t];for(let n=e;n<s.length;++n){const e=s[n];let r=!1;const a=this._surface.layerViewByIndex(n,t),o=s$S(a);if(e.loadingAgent?u$e(this,o,!1)?(e.loadingAgent!==d$e&&e.loadingAgent.setSuspension(i),e.loadingAgent!==d$e&&(r=e.loadingAgent.update())):e.dispose():u$e(this,o,!1)&&(e.loadingAgent=O$3(this,n,t,i),r=e.loadingAgent.startLoading(),r?e.loadingAgent===d$e&&this.setPendingUpdate(32):(z$5(e.loadingAgent),e.loadingAgent=d$e)),e.loadingAgent===d$e&&this.updateRenderData(t,0),r&&a.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}getElevationBasedVerticesPerRow(t){const i=this.vlevel-this.level,s=Math.max(this.level-t,E$m-i);return e$B(1+(this.maxTesselation>>s),2,this.maxTesselation+1)}get test(){return {cachedMemory:this.cachedMemory}}}function O$3(e,t,i,s){const n=0===i?$$4.acquire():H$6.acquire();return n.init(e,t,i,s),n}function z$5(e){e.dispose(),e instanceof r$g?$$4.release(e):e instanceof t$j&&H$6.release(e);}const H$6=new e$L(t$j),$$4=new e$L(r$g),G$4=new s$e,F$5=-1;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class l$b extends N$8{constructor(t,e,i){super(),this.horizontalScaleFactor=1,void 0!==t&&this.init(t,e,i);}init(i,s,r){super.init(i,s,r);const a=r.view.renderSpatialReference,n=r$A(a)&&k$q(a)&&r.spatialReference.isGeographic;this.horizontalScaleFactor=n?this.ellipsoid.radius*Math.PI/180:1,this._edgeLen=(this.extent[2]-this.extent[0])*this.horizontalScaleFactor,this._edgeLen2=this._edgeLen*this._edgeLen,this.centerAtSeaLevel[0]=s$F(this.extent[0],this.extent[2],.5)*this.horizontalScaleFactor,this.centerAtSeaLevel[1]=s$F(this.extent[1],this.extent[3],.5)*this.horizontalScaleFactor,this.centerAtSeaLevel[2]=0,this.updateRadiusAndCenter();}updateRadiusAndCenter(){this._updateCenter();const t=(this.extent[2]-this.extent[0])*Math.SQRT1_2,e=.5*(this.elevationBounds[0]-this.elevationBounds[1]);this._center[1][3]=Math.sqrt(t*t+e*e);}_isVisible(t){return A$o(t,this._aabb())}_aabb(){return v$w(this.extent[0]*this.horizontalScaleFactor,this.extent[1]*this.horizontalScaleFactor,this.elevationBounds[0],this.extent[2]*this.horizontalScaleFactor,this.extent[3]*this.horizontalScaleFactor,this.elevationBounds[1])}intersectsRay(t,e,i,s,r){c$e[0]=1/e[0],c$e[1]=1/e[1],c$e[2]=1/e[2];const o=r*(this.extent[2]-this.extent[0])*this.horizontalScaleFactor*.1;return L$k(this._aabb(),t,c$e,i+o,s)}createGeometry(t,e){v$8(t,this.extent,e,this.horizontalScaleFactor,this.renderData),this.setMemoryDirty();}getDefaultVerticesPerRowOnLevel(){return this.level<8?3:2}}const c$e=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class u$d extends N$8{constructor(t,i,e){super(),this.obb=new Array(8),this.isWebMercator=!1;for(let s=0;s<8;s++)this.obb[s]=n$F();void 0!==t&&this.init(t,i,e);}init(e,s,r){super.init(e,s,r),this.isWebMercator=r.tilingScheme.spatialReference.isWebMercator;const h=this.ellipsoid.radius,a=this.extentInRadians[0],l=this.extentInRadians[1],d=this.extentInRadians[2],c=this.extentInRadians[3],u=e[0],p=s$F(l,c,.5),m=s$F(a,d,.5),f=0===u?0:Math.min(Math.abs(l),Math.abs(c));this._edgeLen=(d-a)*Math.cos(f)*h,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=h-Math.sqrt(h*h-this._edgeLen2/4),ne$3(this.centerAtSeaLevel,m,p,this.ellipsoid.radius,0);const _=e$N(this.centerAtSeaLevel);j$p(_,_),this.up=_,this._updateOBB(),this.updateRadiusAndCenter();}updateRadiusAndCenter(){if(0===this.lij[0])o$C(this._center[1],0,0,0),o$C(this._center[0],0,0,0),o$C(this._center[2],0,0,0),this.ellipsoid||(this.ellipsoid=p$K(this.surface.spatialReference)),this._center[1][3]=this.ellipsoid.radius+this.elevationBounds[1];else {this._updateCenter();const t=Math.max(x$p(this._center[1],this.obb[0]),x$p(this._center[1],this.obb[1]));this._center[1][3]=Math.sqrt(t);}}_isVisible(t){if(!O$o(t,this._center[1]))return !1;if(this.lij[0]<10)return !0;const i=this.obb;for(let e=0;e<6;e++){const s=4===e,r=t[e];s&&(m$a[0]=r[0],m$a[1]=r[1],m$a[2]=r[2],m$a[3]=r[3]-this.surface.view.state.camera.near);const o=s?m$a:r;let n;for(n=0;n<8;n++){const t=i[n];if(o[0]*t[0]+o[1]*t[1]+o[2]*t[2]+o[3]<0)break}if(8===n)return !1}return !0}computeElevationBounds(){super.computeElevationBounds(),this._updateOBB();}createGeometry(t,i){const e=this._isPole(this.lij[1],this.lij[0]);I$4(t,this.extent,i,this.renderData,this.extentInRadians,this.isWebMercator,this.ellipsoid,e),this.setMemoryDirty();}_updateOBB(){const t=this.extentInRadians,i=this.obb;for(let e=0;e<2;e++){const s=this.elevationBounds[e];let r=4*e;ne$3(i[r++],t[0],t[1],this.ellipsoid.radius,s),ne$3(i[r++],t[0],t[3],this.ellipsoid.radius,s),ne$3(i[r++],t[2],t[3],this.ellipsoid.radius,s),ne$3(i[r++],t[2],t[1],this.ellipsoid.radius,s);}if(this.isWebMercator){const t=this._isPole(this.lij[1],this.lij[0]);2===t?(o$C(i[1],0,0,this.ellipsoid.radius),o$C(i[2],0,0,this.ellipsoid.radius),o$C(i[5],0,0,this.ellipsoid.radius),o$C(i[6],0,0,this.ellipsoid.radius)):1===t&&(o$C(i[0],0,0,-this.ellipsoid.radius),o$C(i[3],0,0,-this.ellipsoid.radius),o$C(i[4],0,0,-this.ellipsoid.radius),o$C(i[7],0,0,-this.ellipsoid.radius));}}_isPole(t,i){let e=0;return t===(1<<i)-1&&(e+=1),0===t&&(e+=2),e}intersectsRay(t,i,e,s,r){const o=this._center[1],n=o[3]+e+.2*this.ellipsoid.radius*Math.abs(r*(this.extentInRadians[3]-this.extentInRadians[1])),h=i[0]*i[0]+i[1]*i[1]+i[2]*i[2],a=o[0]-t[0],l=o[1]-t[1],d=o[2]-t[2],c=(a*i[0]+l*i[1]+d*i[2])/h,u=i[0]*c-a,p=i[1]*c-l,m=i[2]*c-d;return u*u+p*p+m*m<n*n}getDefaultVerticesPerRowOnLevel(){return this.level<p$a.length?p$a[this.level]+1:2}}const p$a=[128,64,32,16,16,8,8,4],m$a=p$S();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class s$c{constructor(t){this._getFadeDuration=t,this._fadeStart=0,this._delayedTime=0;}clear(){this._current=l$E(this._current),this._next=l$E(this._next),this._waiting=l$E(this._waiting),this._delayed=l$E(this._delayed);}get current(){if(t$F(this._current))return null;if(!this._isFadingEnabled){const t=this._delayed||this._waiting||this._next||this._current;t!==this._current&&(this._current=null,this.clear(),this._current=t);}let n=s$c.test.fadeMoment;if(r$A(this._delayed)&&(n=n||performance.now(),n>=this._delayedTime&&(this._push(this._delayed,0),this._delayed=null)),r$A(this._next)){n=n||performance.now();const e=this._fadeDuration,s=r$A(this._current)&&this._next.texture===this._current.texture,r=0!==this._next.type,a=n-this._fadeStart>=e;(s||r||a)&&(l$E(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(n));}return this._current}get next(){return this._next}get fadeFactor(){if(t$F(this._next))return 1;const t=s$c.test.fadeMoment||performance.now(),i=Math.max(0,t-this._fadeStart),n=this._fadeDuration;return i>n?0:1-i/n}get isFading(){return r$A(this._next)||r$A(this._delayed)}push(e,i=0){this._delayed=l$E(this._delayed),this._push(e,i);}_push(i,n){if(this._isFadingEnabled||this.clear(),t$F(this._current))return void(this._current=i);const r=s$c.test.fadeMoment||performance.now();return 0!==n?(this._delayed=i,void(this._delayedTime=r+n)):t$F(this._next)?(this._next=i,void(this._fadeStart=this._alignFadeStart(r))):void(t$F(i)||(l$E(this._waiting),this._waiting=i))}get _fadeDuration(){return t$F(this._waiting)?this._getFadeDuration():.5*this._getFadeDuration()}_alignFadeStart(t){const e=this._getFadeDuration();return t+e-t%e}get _isFadingEnabled(){return this._getFadeDuration()>0}}s$c.test={fadeMoment:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class s$b{constructor(){this._scales=[-1,-1,-1,-1],this._offsets=[-1,-1,-1,-1];}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1;}setScale(s,t,e){this._scales[2*s]=t,this._scales[2*s+1]=e;}setOffset(s,t,e){this._offsets[2*s]=t,this._offsets[2*s+1]=e;}get scales(){return this._scales}get offsets(){return this._offsets}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class f$a{constructor(){this.geometryInfo=new p$c,this.intersectionData=null,this.skirtIntersectionData=null,this._textureRef=new s$c((()=>this.tile.surface.textureFadeDuration)),this.overlay=new s$b;}init(e){this.tile=e,this.clear();const t=this.geometryInfo;t.indices=null,t.vertexAttributes=null,B$g(t.boundingBox),t.numSurfaceIndices=0,t.numSkirtIndices=0,t.numWithoutSkirtIndices=0,t.numVertsPerRow=0,this.intersectionData=null,this.skirtIntersectionData=null,this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},this.localOrigin=null,this.overlay.clear();}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear();}updateGeometry(e,t){return !!this._updateGeometryState(t)&&(this._releaseGeometry(),this._createGeometry(e),!0)}releaseGeometry(){return !!this._releaseGeometry()&&(this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},!0)}ensureTexture(e,i){return r$A(this._texture)&&this._texture.descriptor.width!==e&&this.releaseTexture(),t$F(this._texture)&&(this._texture=i(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){r$A(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty());}_updateGeometryState(t){const r=this._getElevationInfo(),i=r.samplerData?this.tile.getElevationBasedVerticesPerRow(r.maxTileLevel):this.tile.getDefaultVerticesPerRowOnLevel();let s=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(s=null);const a=this.geometryState;let n=!1;return a.numVertsPerRow!==i&&(a.numVertsPerRow=i,n=!0),r.changed&&(a.samplerData=r.samplerData,n=!0),l$N(a.clippingArea,s)||(a.clippingArea=s,n=!0),a.wireframe!==t&&(a.wireframe=t,n=!0),n}_createGeometry(e){this.tile.createGeometry(this.geometryState,this.localOrigin);const t=this.geometryInfo.vertexAttributes,r=this.geometryInfo.indices,i=e.gl;this._vao=new f$w(e,o$F,{geometry:t$T(t.layout)},{geometry:h$y.createVertex(e,i.STATIC_DRAW,t.buffer)},h$y.createIndex(e,i.STATIC_DRAW,r));}_releaseGeometry(){return !!this._vao&&(this._vao.dispose(),this._vao=null,d$f(this.geometryInfo),!0)}get vao(){return this._vao}setTextureReference(e,r=0){r$A(e)&&e.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(e,r);}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[0],r=t.length;let i=new Array(r),s=0,a=0,n=!1;for(let o=0;o<r;o++){const r=t[o];if(r.upsampleInfo){const t=r.upsampleInfo.tile,l=t.layerInfo[0][o].data,u=l&&l.samplerData;e&&e[s]===u||(n=!0),i[s++]=u,a=Math.max(a,t.lij[0]);}else if(r.data){const t=this.tile.surface.layerViewByIndex(o,0);if(u$e(this.tile,t.layer,!1)){const t=r.data;e&&e[s]===t.samplerData||(n=!0),i[s++]=t.samplerData,a=this.tile.lij[0];}}}return e&&e.length!==s&&(n=!0),s>0?i.length=s:i=null,{changed:n,samplerData:i,maxTileLevel:a}}get estimatedGeometryMemoryUsage(){const e=A$l(this.intersectionData,0,(e=>e.estimatedMemoryUsage))+A$l(this.skirtIntersectionData,0,(e=>e.estimatedMemoryUsage+e.vertexPositionBuffer.byteLength));return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength+e}get textureDescriptor(){return r$A(this._texture)?this._texture.descriptor:null}get test(){return {hasTexture:null!=this._texture}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class r$e{constructor(){this.extent=n$P(),this.minLevel=0,this.maxLevel=0,this.callback=null;}}class u$c{constructor(){this._queries=new n$Z({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new n$Z({initialSize:30}),this._queryPool=new e$L(r$e);}queryVisibleLevelRange(e,t,i,r){const u=this._queryPool.acquire();a$14(u.extent,e),u.minLevel=t||-Number.MAX_VALUE,u.maxLevel=null!=i?i:Number.MAX_VALUE,u.callback=r,this._queryQueue.push(u);}hasPendingQueries(){return 0!==this._queryQueue.length}prepareQueries(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e);}this._queriesInvPtr=this._queries.length;}processQueries(){for(let e=0;e<this._queries.length;e++){const t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null;}this._queries.clear();}scaleQueriesForTile(e){const t=e.lij[0];let s=0;for(;s<this._queriesInvPtr;){const i=this._queries.data[s],r=i.extent;t>=i.minLevel&&t<=i.maxLevel&&r[0]<=e.extent[2]&&r[2]>=e.extent[0]&&r[1]<=e.extent[3]&&r[3]>=e.extent[1]?(this._queries.swapElements(s,this._queriesInvPtr-1),this._queriesInvPtr--):s++;}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const a$d=.125;class s$a{constructor(){this._renderParams={context:null,drawPhase:1,state:o$S(new U$e({viewpoint:new u$z({targetGeometry:new b$m(0,0),scale:1,rotation:0}),size:[256,256]})),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1};}dispose(){this._renderParams=null;}render(e,t,r,i,s,l,n,o,p,d){const c=l.adjustLevel(t[0]),m=this._renderParams;m.context=e,m.painter=i,m.glyphMosaic=i.glyphMosaic,m.spriteMosaic=i.spriteMosaic,m.pixelRatio=d,m.displayLevel=c,m.requiredLevel=c;const u=l.getScale(t[0]),[g,y]=l.getShift(t,n*u),h=a$d*n*u/p,f=r.transforms.dvs;f[0]=h,f[4]=-h,f[6]=-1-g-o[0]*n*2,f[7]=1+y+(1-o[1])*n*2-2,m.state.size[0]=p,m.state.size[1]=p,r.stage||r.attachWithContext(e),r.triangleCount=0,i.drawTile(m,r,s);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function r$d(){const r=new n$N;return r.attributes.add("position","vec2"),r.attributes.add("uv0","vec2"),r.vertex.uniforms.add("scale","float"),r.vertex.uniforms.add("offset","vec2"),r.varyings.add("uv","vec2"),r.vertex.code.add(t$J`void main(void) {
gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
}`),r.fragment.uniforms.add("tex","sampler2D"),r.fragment.uniforms.add("opacity","float"),r.fragment.code.add(t$J`void main() {
vec4 color = texture2D(tex, uv);
gl_FragColor = vec4(color.xyz, 1.0) * color.a * opacity;
}`),r}const t$h=Object.freeze({__proto__:null,build:r$d});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class m$9 extends t$L{initializeProgram(e){const r=m$9.shader.get().build();return new n$O(e.rctx,r,o$F)}initializePipeline(){const e=2===this.configuration.mode?t$O(1,771):1===this.configuration.mode?t$O(0,770):null;return g$v({blending:e,colorWrite:r$J})}}m$9.shader=new t$M(t$h,(()=>import('./BlendLayers.glsl-56c36027.js')));class g$8 extends t$K{constructor(){super(...arguments),this.mode=0;}}e$x([e$D({count:3})],g$8.prototype,"mode",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function o$h(o){o.attributes.add("position","vec2"),o.attributes.add("uv0","vec2"),o.vertex.uniforms.add("u_scale","float"),o.vertex.uniforms.add("u_offset","vec2"),o.varyings.add("v_texcoord","vec2"),o.vertex.code.add(t$J`void main(void) {
v_texcoord = uv0 * u_scale + u_offset;
gl_Position = vec4(position, 0.0, 1.0);
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function e$g(e){e.fragment.uniforms.add("u_colormap","sampler2D"),e.fragment.uniforms.add("u_colormapOffset","float"),e.fragment.uniforms.add("u_colormapMaxIndex","float"),e.fragment.code.add(t$J`vec4 colormap(vec4 currentPixel, bool isFloat) {
float clrIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || clrIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 clrPosition = vec2((clrIndex + 0.5) / (u_colormapMaxIndex + 1.0), 0.0);
vec4 color = texture2D(u_colormap, clrPosition);
result = vec4(color.rgb, 1.0) * color.a * u_opacity;
}
return result;
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function o$g(o){o.fragment.uniforms.add("u_transformGrid","sampler2D"),o.fragment.uniforms.add("u_transformSpacing","vec2"),o.fragment.uniforms.add("u_transformGridSize","vec2"),o.fragment.uniforms.add("u_targetImageSize","vec2"),o.fragment.code.add(t$J`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(0.25 / u_transformGridSize.s, 1.0 / u_transformGridSize.t);
vec2 index_transform = floor(index_image / u_transformSpacing) / u_transformGridSize;
vec2 pos = fract((index_image + vec2(0.5, 0.5)) / u_transformSpacing);
vec2 srcLocation;
vec2 transform_location = index_transform + oneTransformPixel * 0.5;
if (pos.s <= pos.t) {
vec4 ll_abc = texture2D(u_transformGrid, vec2(transform_location.s, transform_location.t));
vec4 ll_def = texture2D(u_transformGrid, vec2(transform_location.s + oneTransformPixel.s, transform_location.t));
srcLocation.s = dot(ll_abc.rgb, vec3(pos, 1.0));
srcLocation.t = dot(ll_def.rgb, vec3(pos, 1.0));
} else {
vec4 ur_abc = texture2D(u_transformGrid, vec2(transform_location.s + 2.0 * oneTransformPixel.s, transform_location.t));
vec4 ur_def = texture2D(u_transformGrid, vec2(transform_location.s + 3.0 * oneTransformPixel.s, transform_location.t));
srcLocation.s = dot(ur_abc.rgb, vec3(pos, 1.0));
srcLocation.t = dot(ur_def.rgb, vec3(pos, 1.0));
}
return srcLocation;;
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function e$f(e){e.include(o$g),e.fragment.uniforms.add("u_image","sampler2D"),e.fragment.uniforms.add("u_isFloatTexture","bool"),e.fragment.uniforms.add("u_flipY","bool"),e.fragment.uniforms.add("u_applyTransform","bool"),e.fragment.uniforms.add("u_opacity","float"),e.fragment.code.add(t$J`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}
vec4 getPixel(vec2 pixelLocation) {
return texture2D(u_image, pixelLocation);
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function r$c(o){const l=new n$N;return l.include(o$h),l.include(e$f),l.include(e$g),0===o.output?n$g(l,o):1===o.output?u$b(l):2===o.output&&f$9(l,o),l}function u$b(a){a.fragment.code.add(t$J`void main() {
vec2 pixelLocation = getPixelLocation(v_texcoord);
if (isOutside(pixelLocation)) {
gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
return;
}
vec4 currentPixel = getPixel(pixelLocation);
gl_FragColor = colormap(currentPixel, true);
}`);}function n$g(a,e){a.fragment.uniforms.add("u_bandCount","int"),a.fragment.uniforms.add("u_minCutOff","float",3),a.fragment.uniforms.add("u_maxCutOff","float",3),a.fragment.uniforms.add("u_factor","float",3),a.fragment.uniforms.add("u_minOutput","float"),a.fragment.uniforms.add("u_maxOutput","float"),a.fragment.uniforms.add("u_useGamma","bool"),a.fragment.uniforms.add("u_gamma","float",3),a.fragment.uniforms.add("u_gammaCorrection","float",3),a.fragment.code.add(t$J`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const t=e.applyColormap?t$J`gl_FragColor = colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma);`:t$J`gl_FragColor = vec4(grayVal, grayVal, grayVal, 1.0) * currentPixel.a * u_opacity;`;a.fragment.code.add(t$J`
      void main() {
        vec2 pixelLocation = getPixelLocation(v_texcoord);
        if (isOutside(pixelLocation)) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        ${0===e.stretchType?t$J`
        gl_FragColor = vec4(currentPixel.rgb, 1.0) * currentPixel.a * u_opacity;`:t$J`
        if (currentPixel.a == 0.0) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }
        if (u_bandCount == 1) {
          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          ${t}
        } else {
          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
          gl_FragColor = vec4(redVal, greenVal, blueVal, 1.0) * currentPixel.a * u_opacity;
        }`}
      }`);}function f$9(a,e){a.fragment.uniforms.add("u_hillshadeType","int"),a.fragment.uniforms.add("u_sinZcosAs","float",6),a.fragment.uniforms.add("u_sinZsinAs","float",6),a.fragment.uniforms.add("u_cosZs","float",6),a.fragment.uniforms.add("u_weights","float",6),a.fragment.uniforms.add("u_factor","vec2"),a.fragment.uniforms.add("u_applyColormap","bool"),a.fragment.uniforms.add("u_minValue","float"),a.fragment.uniforms.add("u_maxValue","float"),a.fragment.uniforms.add("u_srcImageSize","vec2"),a.fragment.include(e$F),a.fragment.code.add(t$J`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 rgb = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(rgb.xyz);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv) * alpha, alpha);
}`),a.fragment.code.add(t$J`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const t=e.applyColormap?t$J`gl_FragColor = overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha);`:t$J`hillshade *= alpha;
gl_FragColor = vec4(hillshade, hillshade, hillshade, alpha);`;a.fragment.code.add(t$J`
    void main() {
      vec2 pixelLocation = getPixelLocation(v_texcoord);
      if (isOutside(pixelLocation)) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture2D(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture2D(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture2D(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture2D(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture2D(u_image, pixelLocation);
      vec4 vf = texture2D(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture2D(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture2D(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture2D(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${t}
    }
  `);}const c$d=Object.freeze({__proto__:null,build:r$c});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class f$8 extends t$L{get uniformLocationInfos(){return this._uniformLocationInfos||(this._uniformLocationInfos=m$G(this._context,this.program)),this._uniformLocationInfos}initializeProgram(o){const r=f$8.shader.get(),e=this.configuration,i=r.build({output:e.colorizerType,applyColormap:e.applyColormap,stretchType:e.stretchType});return this._context=o.rctx,new n$O(o.rctx,i,o$F)}initializePipeline(){const o=2===this.configuration.mode?t$O(1,771):1===this.configuration.mode?t$O(0,770):null;return g$v({blending:o,colorWrite:r$J})}bindPass(o){c$$(this.program,this.uniformLocationInfos,o.basic),c$$(this.program,this.uniformLocationInfos,o.common),r$A(o.colormap)&&c$$(this.program,this.uniformLocationInfos,o.colormap),0===this.configuration.colorizerType&&r$A(o.stretch)?c$$(this.program,this.uniformLocationInfos,o.stretch):2===this.configuration.colorizerType&&r$A(o.hillshade)&&c$$(this.program,this.uniformLocationInfos,o.hillshade);}}f$8.shader=new t$M(c$d,(()=>import('./RasterColorizer.glsl-70f43fef.js')));class g$7 extends t$K{constructor(){super(...arguments),this.mode=2,this.colorizerType=0,this.stretchType=0,this.applyColormap=!0;}}e$x([e$D({count:3})],g$7.prototype,"mode",void 0),e$x([e$D({count:3})],g$7.prototype,"colorizerType",void 0),e$x([e$D({count:2})],g$7.prototype,"stretchType",void 0),e$x([e$D()],g$7.prototype,"applyColormap",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class e$e{constructor(e,f,o,r,c,i,a){this.texture=e,this.type=f,e.retain(),this.offsetAndScale=r$L(o.offset[0],o.offset[1],o.scale,o.scale),this.opacities=r$D(r,a?i:0,c);}destroy(){this.texture.release();}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class o$f{constructor(t){this._rctx=t,this._pools=new Map;}acquire(t){return this.getPool(t).acquire()}release(t){this.getPool(t.width).release(t);}clear(){this._pools.forEach((t=>t.destroy())),this._pools.clear();}getPool(o){let r=this._pools.get(o);if(!r){const s=l$F.bind(l$F,this._rctx,{colorTarget:0,depthStencilTarget:1,width:o,height:o});r=new e$L(s),this._pools.set(o,r);}return r}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class D$4{constructor(e,t,r){this._rctx=e,this.tileSize=t,this._techniqueRepository=r,this._backgroundIsGrid=!1,this._backgroundTexture=null,this._backgroundColor=null,this._blackTex=null,this._vectorTileHelper=new s$a,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._vaoQuad=i$N(this._rctx,s$D),this._blackTex=new t$i(u$K(this._rctx,[0,0,0,1])),this._fboPool=new o$f(this._rctx);}dispose(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad=i$M(this._vaoQuad),this._backgroundTexture=h$w(this._backgroundTexture),this._blackTex=h$w(this._blackTex),this._blendLayersTechnique=i$M(this._blendLayersTechnique),this._applyOpacityTechnique=i$M(this._applyOpacityTechnique),this._vectorTileHelper=i$M(this._vectorTileHelper);}get blendLayersTechnique(){if(t$F(this._blendLayersTechnique)){const e=new g$8;e.mode=2,this._blendLayersTechnique=this._techniqueRepository.acquire(m$9,e);}return this._blendLayersTechnique}get applyOpacityTechnique(){if(t$F(this._applyOpacityTechnique)){const e=new g$8;e.mode=1,this._applyOpacityTechnique=this._techniqueRepository.acquire(m$9,e);}return this._applyOpacityTechnique}get backgroundIsGrid(){return this._backgroundIsGrid}get backgroundColor(){return this._backgroundColor}updateTileTexture(e,t){const r=e.layerInfo[1];for(const i of r)i.pendingUpdates&=-1;if(!e.renderData)return;const s=e.surface,a=s.baseOpacity;let o=0,n=0,l=this.tileSize,u=!1;const h=s.view.pixelRatio;let d=r.length,f=0;for(;f<r.length&&!u;f++){const t=s.layerViewByIndex(f,1),i=t.fullOpacity;if(E$5[f]=i,t$_(t.layer)&&d>=r.length&&(d=f),0===i)continue;++n;const _=U$4(e,f,z$4);_&&(y$B(t)?l=Math.max(l,this.tileSize*h):1===a&&1===i&&(t.isOpaque||this._dataToTexture(_)&&_.sourceLayerInfo.data.descriptor.isOpaque)&&(u=!0),++o);}this._cleanupFBOPool(h,r.length),l=P$5(l);const _=l/this.tileSize,p=f-1;0!==o?1===o&&(u||this._backgroundIsGrid||r$A(this._backgroundColor))&&this._useLayerTexture(e,p,d,E$5[p])||this._composeMapLayers(e,t,p,d,u,E$5,l,_):this._useBackgroundTexture(e,n);}_useBackgroundTexture(e,t){let r=0;(e.surface.view.layerViewManager.updating||t>0)&&(r=5e3),this._backgroundTexture&&t$F(e.renderData.textureReference)&&(r=0),e.renderData.setTextureReference(r$A(this._backgroundTexture)?new e$e(this._backgroundTexture,0,S$6,e.surface.baseOpacity,1,1,!1):null,r);}_useLayerTexture(e,t,r,s){const i=t<r,a=i?1:e.surface.baseOpacity,o=i?e.surface.baseOpacity:1,n=U$4(e,t,z$4);return !!this._dataToTexture(n)&&(e.renderData.setTextureReference(new e$e(n.sourceLayerInfo.data,0,n,a,s,o,!0)),!0)}_composeMapLayers(e,t,r,s,a,o,l,u){const c=this._rctx,d=this._fboPool.acquire(l);c.bindFramebuffer(d),c.setViewport(0,0,l,l),c.setClearColor(0,0,0,0),c.setClearDepth(1),c.clearSafe(16640);let f=!1;!a&&r$A(this._backgroundTexture)&&this._drawRasterData(this.blendLayersTechnique,this._backgroundTexture.texture,1,f$D);const _=e.surface.baseOpacity;let p=!1,T=9987;for(let i=r;i>=0;i--){const t=U$4(e,i,z$4);t&&(i<s&&_<1&&!p&&(this._drawRasterData(this.applyOpacityTechnique,this._blackTex.texture,1,f$D,_),p=!0),0!==o[i]&&(T$i(t)?f=this._drawVectorData(this.blendLayersTechnique,t,u,o[i],l,d,f):h$E(t)?(this._drawImageryTileData(t,o[i]),this.hasNearestInterpolation(t)&&(T=9728)):this._dataToTexture(t)&&this._drawRasterData(this.blendLayersTechnique,t.sourceLayerInfo.data.texture,t.scale,t.offset,o[i])));}const b=e.renderData.ensureTexture(l,(()=>this._buildTexture(l,T))),m=c.bindTexture(b.texture,o$G.TEXTURE_UNIT_FOR_UPDATES),g=b.descriptor;c.gl.copyTexImage2D(c.gl.TEXTURE_2D,0,g.pixelFormat,0,0,g.width,g.height,0),b.generateMipmap(),c.bindTexture(m,o$G.TEXTURE_UNIT_FOR_UPDATES),c.bindFramebuffer(null),this._fboPool.release(d);const w=p?1:_;e.renderData.setTextureReference(new e$e(b,t,S$6,w,1,1,!1));}_drawQuad(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(5,0,r$O(this._vaoQuad,"geometry"));}_drawRasterData(e,t,r,i,a=1){if(t$F(t))return;const o=this._rctx,n=e.program;e.bindPipelineState(o),o.useProgram(n),n.bindTexture(t,"tex"),n.setUniform1f("scale",r),n.setUniform2f("offset",i[0],i[1]),n.setUniform1f("opacity",a),this._drawQuad(n);}hasNearestInterpolation(e){const t=e.sourceLayerInfo.data;return !!t.source&&"nearest"===t.interpolation}_drawImageryTileData(e,t=1){const r=e.sourceLayerInfo.data;if(!r.source)return;e.tile.surface.layerViewByIndex(e.layerIndex,1).ensureSymbolizerParameters(r);const s=this._getRasterColorizerTechnique(r),i=this._rctx,a=s.program;if(s.bindPipelineState(i),i.useProgram(a),!r.bind(i))return;r.opacity=t,r.scale=e.scale,r.offset=e.offset;const{names:o,textures:n}=r.getTextures();o.forEach(((e,t)=>a.bindTexture(n[t],e))),s.bindPass(r.getUniforms()),this._drawQuad(a),i.bindVAO();}_getRasterColorizerTechnique(e){const t=e.symbolizerParameters,r=["stretch","lut","hillshade"].indexOf(t.type);return t$F(this._rasterColorizerConfig)&&(this._rasterColorizerConfig=new g$7,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.colorizerType=r,this._rasterColorizerConfig.applyColormap=!!t.colormap,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?0:1,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(f$8,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}_drawVectorData(e,t,r,s,a,o,n){const l=this._rctx,u=t.sourceLayerInfo.data,c=t.tile.surface.layerViewByIndex(t.layerIndex,1);let h;return e.bindPipelineState(l),s<1?(h=this._fboPool.acquire(a),l.bindFramebuffer(h),l.setClearColor(1,1,1,0),l.clearSafe(16640)):n&&l.clearSafe(256),this._vectorTileHelper.render(l,t.sourceLod,u,c.painter,c.layer.styleRepository,c.schemaHelper,Math.round(1/t.scale),t.offset,this.tileSize,r),!r$A(h)||(l.bindFramebuffer(o),this._drawRasterData(e,h.colorTexture,1,[0,0],s),this._fboPool.release(h),n)}_dataToTexture(e){return L$l(e)&&this._rasterDataToTexture(e),g$z(e)}_rasterDataToTexture(e){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty();}setBackground(e,t){h$w(this._backgroundTexture),this._backgroundIsGrid=t,e instanceof HTMLImageElement?(this._backgroundTexture=this._buildTexture(e),this._backgroundColor=null):(this._backgroundTexture=new t$i(u$K(this._rctx,r$L(e[0]||0,e[1]||0,e[2]||0,1))),this._backgroundColor=r$D(e[0]||0,e[1]||0,e[2]||0));}_buildTexture(e,t=9987){if(t$F(e))return null;const r={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:t,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},i=this._rctx;let a;if("number"==typeof e)r.width=r.height=e,a=new t$i(new o$G(i,r));else if(e instanceof j$u)r.isOpaque=e.isOpaque,a=new t$i(new o$G(i,r,e.image)),e.release();else try{a=new t$i(new o$G(i,r,e));}catch(n){a=new t$i(f$E(i)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.");}const o=i.bindTexture(a.texture,o$G.TEXTURE_UNIT_FOR_UPDATES);return a.generateMipmap(),i.bindTexture(o,o$G.TEXTURE_UNIT_FOR_UPDATES),a}_cleanupFBOPool(e,t){e===this._lastPixelRatio&&t===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=e,this._lastNumLayers=t);}get test(){return {backgroundTexture:this._backgroundTexture}}}function P$5(t){const r=a$_(t),s=r*r,i=t*t;if(s===i)return t;const a=r/2;return s-i<i-a*a?r:a}function U$4(e,t,r){r.layerIndex=t;const s=e.layerInfo[1][t];if(s.data)return r$K(r.offset,0,0),r.tile=e,r.scale=1,r.sourceLod=e.lij,r.sourceLayerInfo=s,r;const i=s.upsampleInfo;if(i){const e=i.tile.layerInfo[1][t];return r.tile=i.tile,a$Y(r.offset,i.offset),r.scale=i.scale,r.sourceLod=i.tile.lij,r.sourceLayerInfo=e,r}return null}const E$5=new Array,z$4={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},S$6={offset:[0,0],scale:1};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const r$b=40,s$9=20,o$e=.8,a$c=15,c$c=1e-6;function h$6(t,e,i){const n=e,r=i;let s=0,o=1/0;for(let a=0;a<3;++a){{const e=t[a];if(n[a]<e){if(r[a]<=c$c)return !1;const t=(e-n[a])/r[a];s=Math.max(s,t);}else if(r[a]<=-c$c){const t=(e-n[a])/r[a];o=Math.min(o,t);}if(s>o)return !1}{const e=t[a+3];if(n[a]>e){if(r[a]>=-c$c)return !1;const t=(e-n[a])/r[a];s=Math.max(s,t);}else if(r[a]>=c$c){const t=(e-n[a])/r[a];o=Math.min(o,t);}if(s>o)return !1}}return !0}class f$7{constructor(t,e,i,n,r){this.aabb=t,this.axis=e,this.d=i,this.midStartIndex=n,this.rightStartIndex=r;}}class d$c{constructor(e,i,n,r){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=i,this.positionAttribute=r,this.rayDirection=n$F(),this.bspNodeTree=new Array,this.vertexPositionBuffer=r.data,this.vertexPositionStride=r.stride;const c=n-i,h=c<=p$9?new Uint16Array(c):new Uint32Array(c);this.indices=h;for(let t=0;t<c;++t)h[t]=t;{const t=N$7(e,i,n,r.data,r.stride),d=(e,i,n)=>{const r=x$6(h,t,e,i),c=i-e;if(c<=s$9){const t=new f$7(r,void 0,0,e,i);return this.bspNodeTree.push(t),t}const{axis:l,midValue:u}=y$5(r),m=g$6(h,t,e,i,l,u),N=(t,e)=>{if(n>a$c)return;const i=e-t;return i<s$9||i>=o$e*c?void 0:d(t,e,n+1)},b=new f$7(r,l,u,m.next,m.mid);return this.bspNodeTree.push(b),b.leftNode=N(e,m.next),b.rightNode=N(m.mid,i),b};d(0,c,0),this.triangleVertexIndices=b$5(h,e,i,n);}}intersectRayTriangleRange(t,e){{if(t>=e)return;const i=this.triangleVertexIndices,r=this.positionAttribute.data,s=this.positionAttribute.stride,o=this.rayOrigin,a=o[0],c=o[1],h=o[2],f=this.rayDirection,d=f[0],u=f[1],m=f[2];for(let g=t,x=3*t;g<e;++g){const t=i[x]*s,e=r[t],o=r[t+1],f=r[t+2],y=i[x+1]*s,N=r[y],b=r[y+1],p=r[y+2],I=i[x+2]*s,T=r[I],R=r[I+1],M=r[I+2];x+=3;const S=N-e,A=b-o,w=p-f,V=T-e,v=R-o,B=M-f,P=u*B-v*m,U=m*V-B*d,D=d*v-V*u,F=S*P+A*U+w*D;if(Math.abs(F)<=Number.EPSILON)continue;const O=a-e,j=c-o,k=h-f,L=O*P+j*U+k*D;if(F>0){if(L<0||L>F)continue}else if(L>0||L<F)continue;const E=j*w-A*k,q=k*S-w*O,z=O*A-S*j,C=d*E+u*q+m*z;if(F>0){if(C<0||L+C>F)continue}else if(C>0||L+C<F)continue;const G=(V*E+v*q+B*z)/F;if(G>=0){const t=this.indices[g]+this.firstTriangleIndex,e=T$h(S,A,w,V,v,B,l$a);this.callback(G,e,t);}}}d$c.numFacesTested+=e-t;}intersectRay(t,i){d$c.numFacesTested=0;const n=r$D(t.r0[0],t.r0[1],t.r0[2]),r=r$D(t.r1[0],t.r1[1],t.r1[2]),s=r[0]-n[0],o=r[1]-n[1],a=r[2]-n[2];if(s*s+o*o+a*a<c$c)return;this.rayOrigin=n;const h=this.rayDirection;h[0]=s,h[1]=o,h[2]=a;const f=this.triangleVertexIndices.length/3;this.callback=i;const l=this.bspNodeTree[0];this.intersectRayBSP(l,0,f);}intersectRayBSP(t,e,i){const n=this.rayOrigin,r=this.rayDirection;if(!h$6(t.aabb,n,r))return;const s=t.axis,o=t.d;if(n[s]<o||r[s]<0){const i=e,n=t.midStartIndex;if(i<n){const e=t.leftNode;void 0!==e?this.intersectRayBSP(e,i,n):this.intersectRayTriangleRange(i,n);}}if(this.intersectRayTriangleRange(t.midStartIndex,t.rightStartIndex),n[s]>o||r[s]>0){const e=t.rightStartIndex,n=i;if(e<n){const i=t.rightNode;void 0!==i?this.intersectRayBSP(i,e,n):this.intersectRayTriangleRange(e,n);}}}get estimatedMemoryUsage(){return this.triangleVertexIndices.byteLength+this.indices.byteLength}}d$c.numFacesTested=0;const l$a=n$F(),u$a=[1/0,1/0,1/0],m$8=[-1/0,-1/0,-1/0];function g$6(t,e,i,n,r,s){let o=i,a=n;for(;o<a;){const i=t[o];e[6*i+r+3]<=s?++o:(--a,t[o]=t[a],t[a]=i);}let c=o;for(a=n;c<a;){const i=t[a-1];e[6*i+r]>=s?--a:(t[a-1]=t[c],t[c]=i,++c);}return {next:o,mid:c}}function x$6(t,e,n,r){if(r<=n)return u$L(NaN,NaN,NaN,NaN,NaN,NaN);{const i=6*t[n];for(let t=0;t<3;++t)u$a[t]=e[i+0+t],m$8[t]=e[i+3+t];}for(let i=n+1;i<r;++i){const n=6*t[i];for(let t=0;t<3;++t)u$a[t]=Math.min(u$a[t],e[n+0+t]),m$8[t]=Math.max(m$8[t],e[n+3+t]);}return u$L(u$a[0],u$a[1],u$a[2],m$8[0],m$8[1],m$8[2])}function y$5(t){const e=t[3]-t[0],i=t[4]-t[1],n=t[5]-t[2],r=e>i?e>n?0:i>n?1:2:i>n?1:n>e?2:0;return {axis:r,midValue:(t[r]+t[r+3])/2}}function N$7(t,e,i,n,r){const s=i-e,o=new Float32Array(6*s);for(let a=0;a<s;++a){const i=3*(a+e),s=t[i+0]*r,c=t[i+1]*r,h=t[i+2]*r;for(let t=0;t<3;++t){const e=n[s+t],i=n[c+t],r=n[h+t];o[6*a+t]=Math.min(e,i,r),o[6*a+3+t]=Math.max(e,i,r);}}return o}function b$5(t,e,i,n){const r=n-i;let s=0;for(let a=i;a<n;++a)for(let t=0;t<3;++t)s=Math.max(e[3*a+t],s);const o=s<=p$9?new Uint16Array(3*r):new Uint32Array(3*r);for(let a=0;a<r;++a){const n=3*(t[a]+i);for(let t=0;t<3;++t){const i=e[n+t];o[3*a+t]=i;}}return o}const p$9=65535;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function e$d(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),1===t.viewingMode?e.vertex.code.add(t$J`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):e.vertex.code.add(t$J`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),e.fragment.code.add(t$J`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function a$b(a,t){a.extensions.add("GL_OES_standard_derivatives"),3!==t.pbrMode&&4!==t.pbrMode||a.include(a$15,t),a.vertex.uniforms.add("overlayTexOffset","vec4"),a.vertex.uniforms.add("overlayTexScale","vec4"),a.varyings.add("vtcOverlay","vec4"),a.vertex.code.add(t$J`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),a.fragment.uniforms.add("ovColorTex","sampler2D"),a.fragment.uniforms.add("overlayOpacity","float"),a.fragment.code.add(t$J`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture2D(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture2D(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),a.fragment.code.add(t$J`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),3!==t.pbrMode&&4!==t.pbrMode||(a.include(n$R),a.fragment.code.add(t$J`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, lightingMainDirection, colorInput.rgb, lightingMainIntensity, localUp, 1.0 - shadow, maskInput.w, position);
return vec4(final, colorInput.w);
}`));}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function v$7(v){v.vertex.code.add(t$J`vec3 applySkirts(inout vec2 uv, vec3 vpos, vec3 vnormal, float skirtScale) {
float skirtLength = 0.0;
if (uv.x >= 2.0) {
skirtLength = uv.y * skirtScale;
vec2 x = vec2(uv.x) - vec2(3.5, 4.5);
uv = clamp(vec2(1.5) - abs(x), vec2(0.0), vec2(1.0));
}
return vpos - vnormal * skirtLength;
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function t$g(t,o){t.varyings.add("vtc","vec2"),t.vertex.uniforms.add("texOffsetAndScale","vec4"),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("textureOpacities","vec3"),o.textureFadingEnabled&&(t.vertex.uniforms.add("nextTexOffsetAndScale","vec4"),t.varyings.add("nvtc","vec2"),t.fragment.uniforms.add("texNext","sampler2D"),t.fragment.uniforms.add("nextTexOpacities","vec3"),t.fragment.uniforms.add("fadeFactor","float")),t.vertex.code.add(t$J`
  void forwardTextureCoordinates(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${o.textureFadingEnabled?t$J`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:t$J``}
  }`),o.useGrid?(t.fragment.code.add(t$J`float lineFactorAtPosition(float value) {
float pos = value * 129.0;
if(pos < 0.5 || pos > 128.5) {
return 1.0;
}
pos = pos + 0.5;
float modulo = mod(pos, 16.0);
return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
}
float lineFactorAtUV(vec2 uv) {
return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
}
float lineFactor(vec2 uv) {
vec2 offset = fwidth(uv) * 0.25;
return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
}
vec4 gridColor(vec2 uv) {
float line = lineFactor(uv) * 0.1 + 0.9;
float backgroundOpacity = textureOpacities.y;
return vec4(1.0, 0.972, 0.918, 1.0) * line * backgroundOpacity;
}`),t.fragment.code.add(t$J`vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
if (opacities.y <= 0.0) {
return color * opacities.z * opacities.x;
}
vec4 grid = gridColor(uv);
float alpha = opacities.z * color.a;
return mix(grid, color, alpha) * opacities.x;
}`)):o.hasBackgroundColor?(t.fragment.uniforms.add("backgroundColor","vec3"),t.fragment.code.add(t$J`vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
if (opacities.y <= 0.0) {
return color * opacities.z * opacities.x;
}
float alpha = opacities.z * color.a;
float backgroundOpacity = opacities.y;
return mix(vec4(backgroundColor, 1.0) * backgroundOpacity, color, alpha) * opacities.x;
}`)):t.fragment.code.add(t$J`vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
return color;
}`),o.textureFadingEnabled?t.fragment.code.add(t$J`vec4 getTileColor() {
vec4 color = getColor(texture2D(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture2D(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):t.fragment.code.add(t$J`vec4 getTileColor() {
return getColor(texture2D(tex, vtc), vtc, textureOpacities);
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function m$7(m){const p=new n$N;if(p.include(u$M,{name:"Terrain Shader",output:m.output}),p.include(v$7),p.attributes.add("position","vec3"),p.attributes.add("uv0","vec2"),p.vertex.uniforms.add("proj","mat4").add("view","mat4").add("origin","vec3").add("skirtScale","float"),0===m.output){p.include(r$N,{linearDepth:!1}),p.include(n$16,m),p.include(t$g,m);const a=0!==m.overlayMode,i=2===m.overlayMode;a&&p.include(a$b,{pbrMode:3,useCustomDTRExponentForWater:!1,ssrEnabled:m.ssrEnabled,highStepCount:m.highStepCount}),i&&p.include(e$d,m),p.varyings.add("vnormal","vec3"),p.varyings.add("vpos","vec3"),p.vertex.uniforms.add("viewNormal","mat4"),m.receiveShadows&&p.varyings.add("linearDepth","float"),m.tileBorders&&p.varyings.add("vuv","vec2"),m.atmosphere&&(p.vertex.uniforms.add("lightingMainDirection","vec3"),p.varyings.add("wnormal","vec3"),p.varyings.add("wlight","vec3")),m.screenSizePerspective&&(p.vertex.uniforms.add("screenSizePerspective","vec4"),p.varyings.add("screenSizeDistanceToCamera","float"),p.varyings.add("screenSizeCosAngle","float")),p.vertex.code.add(t$J`
      void main(void) {
        vpos = position;
        vnormal = getLocalUp(vpos, origin);

        vec2 uv = uv0;
        vpos = applySkirts(uv, vpos, vnormal, skirtScale);
        ${m.atmosphere?t$J`
        wnormal = normalize((viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz);
        wlight = normalize((view  * vec4(lightingMainDirection, 1.0)).xyz);`:""}
        ${m.tileBorders?t$J`vuv = uv;`:""}
        ${m.screenSizePerspective?t$J`
        vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
        screenSizeDistanceToCamera = length(viewPos);
        vec3 viewSpaceNormal = (viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz;
        screenSizeCosAngle = abs(viewSpaceNormal.z);`:""}
        gl_Position = transformPosition(proj, view, vpos);
        ${m.receiveShadows?t$J`linearDepth = gl_Position.w;`:""}
        forwardTextureCoordinates(uv);
        ${a?t$J`setOverlayVTC(uv);`:""}
        ${i?t$J`forwardVertexTangent(vnormal);`:t$J``}
      }
    `),p.extensions.add("GL_OES_standard_derivatives"),p.extensions.add("GL_EXT_shader_texture_lod"),p.include(c$10,m),p.include(l$O,m),p.fragment.uniforms.add("camPos","vec3").add("viewDirection","vec3").add("ssaoTex","sampler2D").add("viewportPixelSz","vec4"),m.screenSizePerspective&&p.fragment.uniforms.add("screenSizePerspective","vec4"),i&&(p.fragment.uniforms.add("ovWaterTex","sampler2D"),p.fragment.uniforms.add("view","mat4")),p.fragment.code.add(t$J`const float sliceOpacity = 0.2;
float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),p.fragment.code.add(t$J`
      void main() {
        ${m.receiveShadows?t$J`float shadow = readShadowMap(vpos, linearDepth);`:t$J`float shadow = 0.0;`}
        float vndl = dot(normalize(vnormal), lightingMainDirection);

        float ssao = viewportPixelSz.w < .0 ? 1.0 : texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
        vec4 tileColor = getTileColor();
        ${a?t$J`
            vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
            vec4 overlayColor = overlayOpacity * overlayColorOpaque;
            vec4 groundColor = tileColor;
            tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`:""}
        if (rejectBySlice(vpos)) {
          tileColor *= sliceOpacity;
        }
        ${m.atmosphere?t$J`
            float ndotl = clamp(vndl, 0.0, 1.0);
            vec3 atm = vec3(max(0.0, dot(wlight, wnormal)) + clamp(1.0 - dot(-viewDirection, wnormal), 0.0, 1.0));
            atm *= clamp(1.0 - lum(tileColor.rgb) * 1.5, 0.0, 1.0); //avoid atmosphere on bright base maps
            atm *= clamp(ndotl * 2.0, 0.0, 1.0); // avoid atmosphere on dark side of the globe
            atm *= tileColor.a; // premultiply with tile alpha`:""}

        vec3 albedo = ${m.atmosphere?t$J`atm + tileColor.rgb;`:t$J`tileColor.rgb;`}
        vec3 normal = normalize(vnormal);

        // heuristic shading function used in the old terrain, now used to add ambient lighting
        float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

        gl_FragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);
        ${i?t$J`
            vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
            float waterNormalLength = length(overlayWaterMask);
            if (waterNormalLength > 0.95) {
              mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
              vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
              vec4 viewPosition = view*vec4(vpos, 1.0);
              vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - camPos), shadow, vnormal, tbnMatrix, viewPosition.xyz);
              vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
              // un-gamma the ground color to mix in linear space
              gl_FragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w);
            }`:""}
        ${m.screenSizePerspective?t$J`
          float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, screenSizePerspective);
          if (perspectiveScale <= 0.25) {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
          }
          else if (perspectiveScale <= 0.5) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
          }
          else if (perspectiveScale >= 0.99) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
          }
          else {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
          }`:""}
        ${m.tileBorders?t$J`
            vec2 dVuv = fwidth(vuv);
            vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv, 1.0 - vuv));
            float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`:""}
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
      }
    `);}return 1!==m.output&&3!==m.output||(p.include(r$N,{linearDepth:!0}),p.include(e$R,{output:m.output}),p.include(n$16,m),p.varyings.add("linearDepth","float"),p.vertex.uniforms.add("nearFar","vec2"),p.vertex.code.add(t$J`void main(void) {
vec3 normal = getLocalUp(position, origin);
vec2 uv = uv0;
vec3 vpos = applySkirts(uv, position, normal.xyz, skirtScale);
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);
}`),p.fragment.code.add(t$J`void main() {
outputDepth(linearDepth);
}`)),2===m.output&&(p.include(r$N,{linearDepth:!1}),p.include(n$16,m),p.varyings.add("vnormal","vec3"),p.varyings.add("vpos","vec3"),p.vertex.uniforms.add("viewNormal","mat4"),p.vertex.code.add(t$J`void main(void) {
vec3 normal = getLocalUp(position, origin);
vec2 uv = uv0;
vpos = applySkirts(uv, position, normal, skirtScale);
gl_Position = transformPosition(proj, view, vpos);
vnormal = normalize((viewNormal * vec4(normal, 1.0)).xyz);
}`),p.fragment.code.add(t$J`void main() {
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) {
normal = -normal;
}
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 0.0);
}`)),4===m.output&&(p.include(r$N,{linearDepth:!1}),p.include(n$16,m),p.include(a$b,{pbrMode:0}),p.vertex.code.add(t$J`void main() {
vec3 vnormal = getLocalUp(position, origin);
vec2 uv = uv0;
vec3 vpos = applySkirts(uv, position, vnormal, skirtScale);
setOverlayVTC(uv);
gl_Position = transformPosition(proj, view, vpos);
}`),p.include(r$_),p.fragment.code.add(t$J`void main() {
vec4 overlayColor = getCombinedOverlayColor();
if (overlayColor.a == 0.0) {
gl_FragColor = vec4(0.0);
return;
}
outputHighlight();
}`)),p}const p$8=Object.freeze({__proto__:null,build:m$7});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class b$4 extends t$L{constructor(){super(...arguments),this.useStencil=!1;}initializeProgram(e){const r=b$4.shader.get(),t=this.configuration,i=r.build({overlayMode:t.overlayMode,output:t.output,viewingMode:e.viewingMode,slicePlaneEnabled:t.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,textureFadingEnabled:t.textureFadingEnabled&&!t.renderOccluded,hasBackgroundColor:t.hasBackgroundColor,useGrid:t.useGrid,receiveShadows:t.receiveShadows&&!t.renderOccluded,receiveAmbientOcclusion:!1,atmosphere:t.atmosphere,tileBorders:t.tileBorders,screenSizePerspective:t.screenSizePerspective,pbrMode:0,ssrEnabled:t.ssrEnabled,highStepCount:!1});return new n$O(e.rctx,i,o$F)}initializePipeline(){return this._stencilPipelineState=this.createPipeline(!0),this.createPipeline(!1)}createPipeline(e){const r=this.configuration,t=r.backfaceCullingEnabled&&!r.renderOccluded;return g$v({blending:r.renderOccluded?t$O(1,771):null,culling:t&&i$O,depthTest:!r.renderOccluded&&{func:513},depthWrite:!r.renderOccluded&&l$P,colorWrite:r$J,stencilTest:e?s$U(1):null})}getPipelineState(e,r){return this.useStencil?this._stencilPipelineState:super.getPipelineState(e,r)}}b$4.shader=new t$M(p$8,(()=>import('./Terrain.glsl-5af9a43f.js')));class g$5 extends t$K{constructor(){super(...arguments),this.output=0,this.overlayMode=0,this.atmosphere=!1,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.backfaceCullingEnabled=!1,this.stencilEnabled=!1,this.textureFadingEnabled=!1,this.hasBackgroundColor=!1,this.useGrid=!1,this.renderOccluded=!1,this.ssrEnabled=!1,this.tileBorders=!1,this.screenSizePerspective=!1;}}e$x([e$D({count:8})],g$5.prototype,"output",void 0),e$x([e$D({count:3})],g$5.prototype,"overlayMode",void 0),e$x([e$D()],g$5.prototype,"atmosphere",void 0),e$x([e$D()],g$5.prototype,"receiveShadows",void 0),e$x([e$D()],g$5.prototype,"slicePlaneEnabled",void 0),e$x([e$D()],g$5.prototype,"backfaceCullingEnabled",void 0),e$x([e$D()],g$5.prototype,"stencilEnabled",void 0),e$x([e$D()],g$5.prototype,"textureFadingEnabled",void 0),e$x([e$D()],g$5.prototype,"hasBackgroundColor",void 0),e$x([e$D()],g$5.prototype,"useGrid",void 0),e$x([e$D()],g$5.prototype,"renderOccluded",void 0),e$x([e$D()],g$5.prototype,"ssrEnabled",void 0),e$x([e$D()],g$5.prototype,"tileBorders",void 0),e$x([e$D()],g$5.prototype,"screenSizePerspective",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const $$3=7,ee$1=10,te$1=a$R(),ie=n$P();let re=class extends p$N{constructor(e){super(e),this.type="Terrain",this.isGround=!0,this.tileSize=256,this.rctx=null,this._isTransparent=!1,this._scaleRangeQueries=new u$c,this.renderDataPool=new e$L(f$a),this._patchGroups=new n$Z({allocator:e=>e||{root:null,origin:null,patches:new n$Z},deallocator:e=>(e.root=null,e.origin=null,e.patches.clear(),e)}),this.patchGroupsDirty=!0,this.patchGroupsMap=new Map,this.tileIterator=new r$i,this.highestVisibleLODTile=null,this.visible=!0,this._opaque=!0,this._skirtScale=1,this._velvetOverground=!0,this.castShadows=!0,this._ssrEnabled=!1,this.emptyTex=null,this.tileRenderer=null,this.tileBackgroundInitialized=!1,this.tileBackgroundUpdating=!1,this.stencilEnabledLayerExtents=[],this.numTrianglesRendered=0,this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this.overlayOpacity=1,this.needsHighlight=!1,this.renderOccludedFlags=1;}get isGlobal(){return 1===this.stage.viewingMode}initialize(){const e=[1,6,8];this.stage.addRenderPlugin(e,this);}destroy(){this.stage.removeRenderPlugin(this),y$6();}get updating(){return !this.tileBackgroundInitialized||this.tileBackgroundUpdating}get canRender(){return this.visible&&!!this._rootTiles&&this.tileBackgroundInitialized&&!this.renderingDisabled}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setNeedsRender();}set opaque(e){this._opaque!==e&&(this._opaque=e,this.setNeedsRender());}get needsLinearDepth(){return this.overlayRenderer.hasWater}get opaque(){return this._opaque&&!this.shaderTechniqueConfig.slicePlaneEnabled}set isTransparent(e){this._isTransparent!==e&&(this._isTransparent=e,this.setNeedsRender());}get isTransparent(){return this._isTransparent}set skirtScale(e){e!==this._skirtScale&&(this._skirtScale=e,this.setNeedsRender());}get skirtScale(){return this._skirtScale}get renderPatchBorders(){return !!this.shaderTechniqueConfig.tileBorders}set renderPatchBorders(e){this.shaderTechniqueConfig.tileBorders!==e&&(this.shaderTechniqueConfig.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"));}get cullBackFaces(){return this.shaderTechniqueConfig.backfaceCullingEnabled}set cullBackFaces(e){this.shaderTechniqueConfig.backfaceCullingEnabled!==e&&(this.shaderTechniqueConfig.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender());}set renderOrder(e){this._set("renderOrder",e),this.setNeedsRender();}set velvetOverground(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender());}get intersectionHandlerId(){return O$p}get slicePlane(){return this.shaderTechniqueConfig.slicePlaneEnabled}set slicePlane(e){this.shaderTechniqueConfig.slicePlaneEnabled!==e&&(this.shaderTechniqueConfig.slicePlaneEnabled=e,this.setNeedsRender());}set textureFadingEnabled(e){this.shaderTechniqueConfig.textureFadingEnabled!==e&&(this.shaderTechniqueConfig.textureFadingEnabled=e,this.setNeedsRender());}setDebugScreenSizePerspective(e){this.shaderTechniqueConfig.screenSizePerspective!==e&&(this.shaderTechniqueConfig.screenSizePerspective=e,this.setNeedsRender());}setRootTiles(e){this._rootTiles=e,this.setNeedsRender();}setNeedsHighlight(e){this.needsHighlight=e,this.setNeedsRender();}setRenderOccludedOverlay(e){this.renderOccludedFlags=e?se$4:1,this.setNeedsRender();}setStencilEnabledLayerExtents(e){this.stencilEnabledLayerExtents=e,this.setNeedsRender();}setTileSize(e){this.tileSize=e,this.tileRenderer&&(this.tileRenderer.tileSize=e),this.setNeedsRender();}loadTile(e){e.renderData||(e.renderData=this.renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e)),this.updateTileGeometry(e),this.updateTileTexture(e,128);}queryVisibleLevelRange(e,t,i,r){this._scaleRangeQueries.queryVisibleLevelRange(e,t,i,r),this.setNeedsRender();}updateTileTexture(e,t){this.tileRenderer&&this.tileBackgroundInitialized&&(this.tileRenderer.updateTileTexture(e,128===t?0:2),this.setNeedsRender(),e.resetPendingUpdate(t));}updateTileGeometry(e){for(const t of e.layerInfo[0])t.pendingUpdates&=-33;e.resetPendingUpdate(32),e.renderData.updateGeometry(this.rctx,this.wireframe)&&this.setNeedsRender();}unloadTile(e){e.renderData&&(e.renderData.releaseGeometry()&&this.setNeedsRender(),this.renderDataPool.release(e.renderData),e.renderData.clear(),e.renderData=null,e.setMemoryDirty(),this.setNeedsRender());}_getLocalOriginOfTile(e){const t=ee$1-$$3,i=Math.max(0,Math.floor((e.lij[0]-t)/$$3)*$$3);if(this.isGlobal&&0===i)return f$y;for(;e.parent&&e.lij[0]>i;)e=e.parent;return e.centerAtSeaLevel}setVisibility(e){this.visible=e,this.setNeedsRender();}getStats(){return {numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numTrianglesRendered:this.numTrianglesRendered,numOriginsRendered:this.numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.allTiles.forAll((t=>{var i;return null==(i=t.renderData)?void 0:i.updateGeometry(this.rctx,e)})),this.setNeedsRender());}setNeedsRender(e=1){this.patchGroupsDirty=!0,this.context.requestRender(e);}setTileBackground(e){this.tileBackground=e,this._updateTileBackground();}initializeRenderContext(e){this.context=e,this.rctx=e.renderContext.rctx,this.shaderTechniques=e.shaderTechniqueRep,this.shaderTechniqueConfig=new g$5,this.tileRenderer=new D$4(this.rctx,this.tileSize,this.shaderTechniques),this.tileBackground&&this._updateTileBackground(),this.emptyTex=f$E(this.rctx);}uninitializeRenderContext(){null!=this.emptyTex&&(this.emptyTex.dispose(),this.emptyTex=null),this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null);}intersect(e,t,i,n){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&!this._opaque)return;const a=de,o=he;c$O(a,n,i),o$C(o,1/a[0],1/a[1],1/a[2]);const l=e.results.min,d=e.results.max,h=e.results.ground,g=0===e.options.store,m=!!e.results.ground.target;let T;const v=d$M(e.verticalOffset),b=this._skirtScale,y=e.tolerance;let x=g&&null!=l.dist?l.dist:1/0;const O=p=>{const m=p.renderData;if(null==m)return;const O=m.geometryInfo;A$p(te$1,O.boundingBox);const q=m.localOrigin;r$A(v)&&(v.localOrigin=q,v.applyToAabb(te$1));const D=-b*O.skirtLength;if(0!==D){const e=p.up;x$v(te$1,D*e[0],D*e[1],D*e[2]);}const w=te$1;if(ce[0]=i[0]-q[0],ce[1]=i[1]-q[1],ce[2]=i[2]-q[2],!L$k(w,ce,o,y,x))return;const B=(e,t,i)=>{e.set(void 0,p.key,t,i,a$16,void 0),e.intersector=pe,e.target={type:"external",metadata:{tile:p}},x=g&&null!=l.dist?l.dist:1/0;},j=(r,o)=>{if(r>=0&&(e.options.backfacesTerrain||z$i(o,a)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||null==t||t(i,n,r))){if((null==h.dist||r<h.dist)&&B(h,r,o),e.options.isFiltered)return;2===e.options.store&&(t$F(T)?(T=new j$v(e.ray),B(T,r,o),e.results.all.push(T)):r<T.dist&&B(T,r,o)),(null==l.dist||r<l.dist)&&B(l,r,o),0!==e.options.store&&(null==d.dist||r>d.dist)&&B(d,r,o);}},U=ue;c$O(U,n,q);const G=O.indices,M=O.vertexAttributes,N={data:M.getField("position",i$12).typedBuffer,size:3,stride:M.stride/4},I=O.numWithoutSkirtIndices/3;if(!r$A(v)&&I>r$b){const e=p.renderData;r$A(e.intersectionData)||(e.intersectionData=new d$c(G,0,I,N)),e.intersectionData.intersectRay({r0:ce,r1:U},j);}else M$j(ce,U,0,I,G,N,null,v,j);if(0!==D){const e=G.length/3;if(this.isGlobal){const t=e-I;if(!r$A(v)&&t>r$b){const i=p.renderData;if(!r$A(i.skirtIntersectionData)){const r=k$4(G,I,e,M,D,q);i.skirtIntersectionData=new d$c(r.indices,0,t,{data:r.vertices,stride:3});}i.skirtIntersectionData.intersectRay({r0:ce,r1:U},j);}else R$6(ce,U,I,e,G,M,D,q,v,j);}else j$5(ce,U,I,e,G,M,D,v,j);}},q=this._rootTiles;if(r$A(q)){(()=>{const t=this.tileIterator;t.reset(q);const s=e.options.invisibleTerrain;for(;!t.done;){const e=t.next();!(e.visible||s&&e.intersectsClippingArea)||!r$A(v)&&!e.intersectsRay(i,a,y,x,b)||m&&this._useStencilForTile(e)?t.skipSubtree():O(e);}})();}}render(e){if(8===e.slot){if(0==(e.renderOccludedMask&se$4))return !1}else {const t=this.opaque?1:6;if(e.slot!==t)return !1}const t=e.pass,i=1===e.scenelightingData.globalFactor,r=this._updatePatchGroups();let s=!1;switch(t){case 0:{const t=e.shadowMap&&e.shadowMap.enabled;this.shaderTechniqueConfig.receiveShadows!==t&&(this.shaderTechniqueConfig.receiveShadows=t);const i=this.overlayRenderer.isEmpty()?0:this.overlayRenderer.hasWater?2:1;this.shaderTechniqueConfig.overlayMode!==i&&(this.shaderTechniqueConfig.overlayMode=i);const n=8===e.slot?3:1;this._renderMaterialPass(e,0,r,n),s=!0;break}case 4:case 6:this.castShadows&&i&&(this._renderAuxiliaryPass(e,3,r,0),s=!0);break;case 2:this.isTransparent&&this.overlayRenderer.isEmpty()||(this._renderAuxiliaryPass(e,1,r,0),s=!0);break;case 3:this._renderAuxiliaryPass(e,2,r,0),s=!0;break;case 5:this.needsHighlight&&(this._renderAuxiliaryPass(e,4,r,2),e.rctx.clearSafe(256),s=!0);}return this._scaleRangeQueries.hasPendingQueries()&&this.setNeedsRender(),s}_renderMaterialPass(e,t,i,r){const{rctx:s,camera:n}=e;this._ssrEnabled=e.ssrParams.ssrEnabled,this._setTerrainTechnique(t,3===r);const a=this._shaderTechnique.program;s.useProgram(a),0!==this.shaderTechniqueConfig.overlayMode&&1===r&&e.ssrParams&&i$11(a,e.ssrParams),e.shadowMap.bind(a),e.ssaoHelper.bind(a,e.camera),this._bindOverlayData(a,r),a.setUniformMatrix4fv("viewNormal",n.viewInverseTransposeMatrix),t$S(a,n.projectionMatrix),e.scenelightingData.setUniforms(a,!0);const o=n.viewMatrix;o$C(le,o[12],o[13],o[14]),j$p(le,le),a.setUniform3fv("viewDirection",le),this.numTilesRendered=0,this.numTilesCulled=0,this.numTrianglesRendered=0,this.numOriginsRendered=0,this._scaleRangeQueries.prepareQueries(),this.opaque?this._renderPatchGroups(e,a,i,r):e.offscreenRenderingHelper.renderToTargets((()=>this._renderPatchGroups(e,a,i,r)),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]),this._scaleRangeQueries.processQueries();}_renderAuxiliaryPass(e,t,i,r){this._setTerrainTechnique(t,3===r);const s=e.rctx,n=this._shaderTechnique.program;if(s.useProgram(n),5===e.pass){const t=e.offscreenRenderingHelper;n.bindTexture(t.depthTexture,"depthTex"),n.setUniform4f("highlightViewportPixelSz",0,0,1/t.width,1/t.height);}else n.setUniformMatrix4fv("viewNormal",e.camera.viewInverseTransposeMatrix),2!==e.pass&&4!==e.pass&&6!==e.pass||n.setUniform2fv("nearFar",e.camera.nearFar);this._renderPatchGroupsAuxiliary(e,n,i,r);}_updateTileBackground(){if(!this.tileRenderer)return;this.tileBackgroundUpdating=!0;const e=()=>{this.tileBackgroundInitialized=!0,this.tileBackgroundUpdating=!1,this.shaderTechniqueConfig.useGrid=this.tileRenderer.backgroundIsGrid,this.shaderTechniqueConfig.hasBackgroundColor=!this.tileRenderer.backgroundIsGrid&&!!r$A(this.tileRenderer.backgroundColor),this.allTiles.forAll((e=>this.tileRenderer.updateTileTexture(e,0))),this.setNeedsRender();};if("string"==typeof this.tileBackground){const t=this.tileBackground;t$R(t).then((i=>{t===this.tileBackground&&this.tileRenderer&&(this.tileRenderer.setBackground(i,this.tileBackground===H$l),e());}));}else {const i=this.tileBackground?h$s.toUnitRGBA(this.tileBackground):[0,0,0,0];this.tileRenderer.setBackground(i,!1),e();}}_updatePatchGroups(){const e=this._patchGroups;if(!this.patchGroupsDirty)return e;if(this.highestVisibleLODTile=null,this._renderCollectOrigins(e),0!==this.renderOrder){for(let t=0;t<e.length;t++)o$i(this.renderOrder,e.data[t].patches);e.sort(((e,t)=>ne(e,t,this.renderOrder)));}return this.patchGroupsDirty=!1,e}_renderCollectOrigins(e){const t=this._rootTiles;if(t$F(t))return;const i=this.isGlobal;e.clear();for(const r of t){const t=e.pushNew();t.root=r,t.origin=i?f$y:r.centerAtSeaLevel,t.patches.clear(),this._renderCollectOriginsForRoot(e,t);}e.filterInPlace((e=>e.patches.length>0));}_renderCollectOriginsForRoot(e,t){const i=this.tileIterator;i.resetOne(t.root);const r=this.patchGroupsMap;for(r.clear(),r.set(t.origin,t);!i.done;){const t=i.next(),s=t.renderData;if(!s||t.visible){if(t.lij[0]%$$3==0){const i=e.pushNew();i.root=t,i.origin=t.centerAtSeaLevel,r.set(t.centerAtSeaLevel,i),i.patches.clear();}if(t.rendered){if(s){const e=r.get(s.localOrigin);e&&e.patches.push(t),(!this.highestVisibleLODTile||t.vlevel>this.highestVisibleLODTile.vlevel)&&(this.highestVisibleLODTile=t),i.skipSubtree();}}else this.numTilesCulled++;}else this.numTilesCulled++,i.skipSubtree();}}_useStencilForTile(e){for(const t of this.stencilEnabledLayerExtents)if(e.intersectsExtent(t))return !0;return !1}_renderPatchGroupsAuxiliary(e,t,i,r){const s=e.rctx;this._shaderTechnique.useStencil=!1,this._shaderTechnique.bindPipelineState(s,e.slot);const n=this.stencilEnabledLayerExtents.length>0;t.setUniformMatrix4fv("proj",e.camera.projectionMatrix),t.setUniform1f("skirtScale",this._skirtScale),0!==r&&this._bindOverlayData(t,r);for(let a=0;a<i.length;a++){const s=i.data[a];this._bindPatchGroupData(t,s,e.camera.eye,e.camera.viewMatrix);for(let i=0;i<s.patches.length;i++)this._renderPatch(e,t,s.patches.data[i],4,n,r);}e.rctx.bindVAO(null);}_renderPatchGroups(e,t,i,n){const a=e.rctx,o=e.camera,l=o.viewMatrix;if(this._shaderTechnique.useStencil=!1,this._shaderTechnique.bindPipelineState(a,e.slot),this.shaderTechniqueConfig.screenSizePerspective&&this.pointsOfInterest){const e=i$Z(this.stage.viewingMode,this.ellipsoidRadius),i=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:i,fovY:o.fovY}),B$j(e,t,"screenSizePerspective");}const d=this.stencilEnabledLayerExtents.length>0,h=3===n;h&&(t.bindTexture(this.emptyTex,"tex"),t.setUniform1f("blend",1),t.setUniform4fv("texOffsetAndScale",_$g));const c=r$A(this.tileRenderer.backgroundColor)?this.tileRenderer.backgroundColor:f$y;this.shaderTechniqueConfig.hasBackgroundColor&&t.setUniform3fv("backgroundColor",c);const u=h?0:this._skirtScale;t.setUniform1f("skirtScale",u);const p=this.wireframe?1:4;this.shaderTechniqueConfig.textureFadingEnabled&&t.bindTexture(this.emptyTex,"texNext");for(let g=0;g<i.length;g++){const a=i.data[g],c=a.patches;this._bindPatchGroupData(t,a,o.eye,l);const u=e.sliceHelper&&e.sliceHelper.plane;r$$(t,this._shaderTechnique.configuration,u,a.origin),e.shadowMap&&e.shadowMap.bindView(t,a.origin),this.numOriginsRendered++;for(let i=0;i<c.length;i++){const a=c.data[i],o=a.renderData.textureReference;if(t$F(o))continue;if(!h){this._scaleRangeQueries.scaleQueriesForTile(a),ae(a.renderData.geometryInfo.uvOffsetAndScale,o.offsetAndScale,ie),t.setUniform4fv("texOffsetAndScale",ie),t.bindTexture(o.texture.texture,"tex");const e=a.renderData.textureFadeFactor,i=e<1?a.renderData.nextTextureReference:null;this.shaderTechniqueConfig.textureFadingEnabled&&r$A(i)&&e<1?(ae(a.renderData.geometryInfo.uvOffsetAndScale,i.offsetAndScale,ie),t.setUniform1f("fadeFactor",e),t.setUniform4fv("nextTexOffsetAndScale",ie),t.setUniform3fv("nextTexOpacities",i.opacities),t.bindTexture(i.texture.texture,"texNext")):t.setUniform1f("fadeFactor",1),a.renderData.textureIsFading&&this.setNeedsRender(),t.setUniform3fv("textureOpacities",o.opacities);}const l=this._renderPatch(e,t,a,p,d,n);a.renderOrder=this.numTilesRendered,this.numTilesRendered++,this.numTrianglesRendered+=l/3;}}a.bindVAO(null);}_renderPatch(e,t,i,r,n,a){if(t$F(i.renderData.vao.indexBuffer))return 0;0!==a&&this._bindOverlayPatchData(t,i.renderData.overlay),n&&(this._shaderTechnique.useStencil=this._useStencilForTile(i),this._shaderTechnique.bindPipelineState(e.rctx,e.slot));const o=0===this._skirtScale?i.renderData.geometryInfo.numWithoutSkirtIndices:i.renderData.vao.indexBuffer.size;return e.rctx.bindVAO(i.renderData.vao),t.assertCompatibleVertexAttributeLocations(i.renderData.vao),e.rctx.drawElements(r,o,i.renderData.vao.indexBuffer.indexType,0),o}_bindPatchGroupData(e,t,i,r){e.setUniform3fv("origin",t.origin),c$U(oe,r,t.origin),e.setUniformMatrix4fv("view",oe),e.setUniform3f("camPos",i[0]-t.origin[0],i[1]-t.origin[1],i[2]-t.origin[2]);}_bindOverlayData(e,t){if(0===this.shaderTechniqueConfig.overlayMode)return;e.setUniform1f("overlayOpacity",this.overlayOpacity);const i=this.overlayRenderer.overlays;if(i.length>0){const s=i[0],n=s.getColorTexture(t);if(e.bindTexture(r$A(n)?n:this.emptyTex,"ovColorTex"),2===this.shaderTechniqueConfig.overlayMode){const i=s.getNormalTexture(t);e.bindTexture(r$A(i)?i:this.emptyTex,"ovWaterTex");}}}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales);}_setTerrainTechnique(e,t){this.shaderTechniqueConfig.output=e,0===e&&(this.shaderTechniqueConfig.atmosphere=this.isGlobal&&this._velvetOverground,this.shaderTechniqueConfig.ssrEnabled=this._ssrEnabled),this.shaderTechniqueConfig.renderOccluded=t,this.shaderTechniqueConfig.stencilEnabled=!1,this._shaderTechnique=this.shaderTechniques.releaseAndAcquire(b$4,this.shaderTechniqueConfig,this._shaderTechnique);}get test(){return {tileRenderer:this.tileRenderer}}};e$x([d$y()],re.prototype,"tileBackgroundInitialized",void 0),e$x([d$y()],re.prototype,"tileBackgroundUpdating",void 0),e$x([d$y({constructOnly:!0})],re.prototype,"overlayRenderer",void 0),e$x([d$y({constructOnly:!0})],re.prototype,"stage",void 0),e$x([d$y({readOnly:!0})],re.prototype,"isGlobal",null),e$x([d$y({constructOnly:!0})],re.prototype,"allTiles",void 0),e$x([d$y({constructOnly:!0})],re.prototype,"ellipsoidRadius",void 0),e$x([d$y({readOnly:!0})],re.prototype,"updating",null),e$x([d$y({value:!1})],re.prototype,"renderingDisabled",null),e$x([d$y()],re.prototype,"renderPatchBorders",null),e$x([d$y()],re.prototype,"cullBackFaces",null),e$x([d$y({value:1})],re.prototype,"renderOrder",null),e$x([d$y()],re.prototype,"wireframe",null),re=e$x([i$H("esri.views.3d.terrain.TerrainRenderer")],re);const se=re;function ne(e,t,i){return 0===e.patches.length?-i:0===t.patches.length?i:a$e(e.patches.data[0],t.patches.data[0],i)}function ae(e,t,i){const r=e[0]*t[2]+t[0],s=e[1]*t[3]+t[1],n=e[2]*t[2],a=e[3]*t[3];r$P(i,r,s,n,a);}const oe=e$y(),le=n$F(),de=n$F(),he=n$F(),ce=n$F(),ue=n$F(),pe="TerrainRenderer";

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class e$c{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let g$4=class extends p$N{constructor(e){super(e),this._handles=new u$D;}initialize(){this._handles.add(this.layers.on("change",(()=>this._update()))),this._handles.add(this.extentHelper.watch("layerViewsExtent",(()=>this._setAdHocTilingScheme()))),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme();}destroy(){this._handles=l$E(this._handles),this._waitTask=null;}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this._set("tilingSchemeDone",!1),this.layers.some((t=>!(!e$O(t)||t.isRejected())&&(!(t.isFulfilled()&&!u$9(t,this.viewSpatialReference,this.viewingMode))&&(e=t,!d$N(t)&&!p$X(t))))),e)if(e.isResolved()){const t=e,{tileInfo:i}=b$t(t,this.viewSpatialReference,this.viewingMode),s=new M$k(i);this._set("tilingSchemeDone",!0),this._lockTilingScheme(s);}else this._updateWhen(e);else this._set("tilingSchemeDone",!0);}_updateWhen(e){const t=e.when().catch((()=>{})).then((()=>{t!==this._waitTask||this.destroyed||this._update();}));this._waitTask=t;}_lockTilingScheme(e){if(1===this.viewingMode){const t=e.levels.length-1;e.spatialReference.isWebMercator?e=M$k.makeWebMercatorAuxiliarySphere(t):$n(e.spatialReference)&&(e=M$k.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t));}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._handles.removeAll(),this._handles.add(this.extentHelper.watch("tiledLayersExtent",(()=>this._updateTiledLayerExtent())));}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent);}_setAdHocTilingScheme(){if(1===this.viewingMode){const e=this.extentHelper.viewSpatialReference,t=$n(e)||G$g(e)||C$g(e);e.isWebMercator?this.tilingScheme=M$k.WebMercatorAuxiliarySphere:t&&(this.tilingScheme=M$k.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent);}else {const e=this.extentHelper.layerViewsExtent;r$A(e)&&!G$i(e,this.extent)&&(this.tilingScheme=M$k.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e));}}get test(){return {lockTilingScheme:e=>this._lockTilingScheme(e),done:!this._waitTask}}};function u$9(e,t,i){return !!b$t(e,t,i).tileInfo}e$x([d$y()],g$4.prototype,"tilingScheme",void 0),e$x([d$y({readOnly:!0})],g$4.prototype,"extent",void 0),e$x([d$y({value:!1})],g$4.prototype,"tilingSchemeLocked",void 0),e$x([d$y({readOnly:!0,value:!1})],g$4.prototype,"tilingSchemeDone",void 0),e$x([d$y({constructOnly:!0})],g$4.prototype,"viewSpatialReference",void 0),e$x([d$y({constructOnly:!0})],g$4.prototype,"layers",void 0),e$x([d$y({constructOnly:!0})],g$4.prototype,"extentHelper",void 0),e$x([d$y({constructOnly:!0})],g$4.prototype,"viewingMode",void 0),g$4=e$x([i$H("esri.views.3d.terrain.TilingSchemeLogic")],g$4);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class t$f{constructor(){this.offset=n$Q(),this.scale=0,this.tile=null;}init(s,t,i,e){this.tile=s,this.offset[0]=t,this.offset[1]=i,this.scale=e;}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const Ee=s$y.getLogger("esri.views.3d.terrain.TerrainSurface"),Ie=.25;let qe=class extends(n$L.EventedMixin(p$N)){constructor(e){super(e),this._elevationBounds=new s$e,this._iteratorPool=new e$L(r$i,(e=>e.remove=()=>this._iteratorPool.release(e))),this._postorderIterator=new s$d,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._visible=!1,this._usedMemory=He,this._performanceInfo=new e$c,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=n$F(),this._eyePosSurfaceSR=n$F(),this._splitLimits=new k$3,this._snapLevel=1/0,this._frustum=b$q(),this._viewProjectionMatrix=e$y(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._handles=new u$D,this._watchUpdatingTracking=new l$G,this._frameTask=D$j,this._allTiles=new n$Z,this._upsampleInfoPool=new e$L(t$f),this._rootTilesExtent=u$B(),this._maxNumUpdating=1,this.maxTextureScale=1.2,this.backgroundImage=H$l,this.backgroundColor=null,this._layerViewsDirty=!1;}initialize(){this._lercDecoder=n$17(this.view.resourceController),this._tilePool=this.view.state.isLocal?new e$L(l$b):new e$L(u$d);const e=this.view.resourceController.memoryController;this._upsampleMapCache=e.newCache("esri.views.3d.terrain.upsample",(e=>e.unloadMapData())),this._elevationQueryCache=new t$n(e.newCache("elevation-query")),this._set("overlayManager",new re$1({surface:this})),this._handles.add([this.watch("overlayManager.hasHighlights",(e=>this._renderer.setNeedsHighlight(e))),this.watch("overlayManager.rendersOccluded",(e=>this._renderer.setRenderOccludedOverlay(e)))],"overlayManager"),this._renderer=new se({overlayRenderer:this.overlayManager.renderer,ellipsoidRadius:p$K(this.view.spatialReference).radius,stage:this.view._stage,allTiles:this._allTiles}),this._handles.add([i$P(this,"baseOpacity",(e=>{this._handleLayerViewChanges(),this._updateBaseOpacity(e);}),!0),i$P(this,"_background",(()=>{this._handleLayerViewChanges(),this._renderer.setTileBackground(this._background);}),!0),this.view.watch("pointsOfInterest",(e=>{this._renderer.pointsOfInterest=e,this._watchUpdatingTracking.removeAll(),e&&this._watchUpdatingTracking.add(e.focus,"renderLocation",(()=>()=>this._allTilesSorted=!1));})),i$P(I$j,"TERRAIN_TILE_TREE_SHOW_TILES",(e=>{e&&!this._treeDebugger?import('./TerrainTileTree3DDebugger-8e9019cb.js').then((({TerrainTileTree3DDebugger:e})=>{!this._treeDebugger&&I$j.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new e({view:this.view}));})):e||(this._treeDebugger=l$E(this._treeDebugger));}))]),this._extentHelper=x$8(this.viewingMode,{layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,viewSpatialReference:this.view.spatialReference});const t=this.view.defaultsFromMap?new p$Y({getCollections:()=>{var e,t,i;return null==(e=this.view)||null==(t=e.defaultsFromMap)||null==(i=t.mapCollectionPaths)?void 0:i.map((e=>this.view.map.get(e)))},getChildrenFunction:e=>e&&"layers"in e?e.layers:null}):this.view.map.allLayers,i=new g$4({layers:t,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",i),this._updateTilingScheme(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(0),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(1);const r=this.view.resourceController.scheduler;this._frameTask=r.registerTask(f$u.TERRAIN_SURFACE,this),this.view.resourceController.memoryController.events.on("quality-changed",(()=>this._viewChangeUpdate())),this._handles.add([i$P(this._extentHelper,"stencilEnabledExtents",(e=>this._renderer.setStencilEnabledLayerExtents(e))),this.tilingSchemeLogic.watch("tilingScheme",(()=>this._updateTilingScheme()),!0),this.tilingSchemeLogic.watch("extent",(()=>this._updateClippingExtent()),!0),i$P(this,"extent",(()=>this._updateRootTiles())),this.view.on("resize",(()=>this._viewChangeUpdate())),this.view.watch("state.camera",(()=>this._viewChangeUpdate()),!0),this.view.watch("state.contentCamera",(()=>this.view.state.fixedContentCamera&&this._viewChangeUpdate()),!0),this.view.watch("qualitySettings.tiledSurface.lodBias",(()=>this._viewChangeUpdate())),i$P(this.view,"qualitySettings.tiledSurface.textureFadeDuration",(e=>this._renderer.textureFadingEnabled=e>0)),this.view.watch("lodSnapping",(()=>this._viewChangeUpdate())),this.view.watch("clippingArea",(()=>this._updateClippingExtent()))]),this._handles.add(this.view.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0))),this._layerViewsDirty=!0,this._handleLayerViewChanges();}destroy(){this._frameTask.remove(),this._handles.destroy(),this._watchUpdatingTracking.destroy(),this._lercDecoder=h$w(this._lercDecoder),this._removeAllTiles(),this._upsampleMapCache=l$E(this._upsampleMapCache),this._elevationQueryCache=l$E(this._elevationQueryCache),this._set("tilingSchemeLogic",l$E(this.tilingSchemeLogic)),this._extentHelper=l$E(this._extentHelper),this._basemapLayerViewHandles.forEach(((e,t)=>this._unregisterTiledLayerView(t))),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",l$E(this.overlayManager)),this._tilePool=l$E(this._tilePool),N$8.prune(),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this._renderer=l$E(this._renderer),this._iteratorPool=l$E(this._iteratorPool),this._set("view",null),this._upsampleInfoPool=l$E(this._upsampleInfoPool),u$N(),h$7();}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){var e,t;const i=null==(e=this.view.pointsOfInterest)||null==(t=e.contentCameraOnSurface)?void 0:t.scale;if(i){const e=this.view.state.contentCamera;let t=te$3(this.view,e.eye,e.viewForward,e.up).tilt;t>90&&(t=180-t);const r=2*(t/90)**2,s=ye$1(this.view,i)-r;Math.abs(this._snapLevel-s)>Ie&&(Math.round(s)!==Math.round(this._snapLevel)&&(this._viewChanged=!0),this._snapLevel=s);}return Math.round(this._snapLevel)}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?1:0}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get mapTileRequester(){return this._mapDataRequester}get extent(){const e=E$l(this.groundExtent,this._userClippingExtent,u$B()),t=this._get("extent");return G$i(e,t)?t:e}get groundExtent(){return c$N(this._tilingSchemeExtent,this._rootTilesExtent)}get _tilingSchemeExtent(){var e;return null==(e=this.tilingSchemeLogic)?void 0:e.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this._watchUpdatingTracking.updating||this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||this._asyncWorkItems>0||!this._allTilesSorted||this._renderer.updating||this._layerViewsDirty)&&this.ready&&!this.suspended||this.overlayManager.updating||this._frameTask.updating)}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get viewingMode(){return this.view.state.viewingMode}get ready(){return r$A(this.rootTiles)}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e);}set skirtScale(e){this._renderer.skirtScale=e;}get skirtScale(){return this._renderer.skirtScale}get spatialReference(){var e,t;return null!=(e=null==(t=this.tilingScheme)?void 0:t.spatialReference)?e:null}get _background(){return null!=this.backgroundColor?this.backgroundColor:this.backgroundImage}set slicePlaneEnabled(e){var t,i;this._renderer.slicePlane=e,this._set("slicePlaneEnabled",e),null==(t=this.view)||null==(i=t._stage)||i.renderView.setRenderParameters({opaqueTerrain:this.opaque});}set velvetOverground(e){e!==this.velvetOverground&&(this._renderer.velvetOverground=e),this._set("velvetOverground",e);}set visible(e){e!==this._visible&&(this._visible=e,this._renderer.setVisibility(e),this.suspended=!e);}get opaque(){return this._renderer.opaque}set suspended(e){this._set("suspended",e),this._viewChangeUpdate();}intersect(e,t,i,r){this._renderer.intersect(e,t,i,r);}getElevation(e,t,i,r){const s=We,a=this.getTileWithElevation(e,t,i,r,s);return t$F(a)?null:i$b.sample(s[0],s[1],a.renderData.geometryState.samplerData)}getTileWithElevation(e,t,i,r,s=We){var a;const n=this.rootTiles;if(t$F(n)||!n.length)return null;if(0===n[0].layerInfo[0].length)return null;if(s[0]=e,s[1]=t,s[2]=i,!gn(s,r,s,null==(a=this.tilingScheme)?void 0:a.spatialReference))return Ee.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(let l of n){if(!l.containsPoint(s))continue;for(;l&&!l.rendered&&!l.isLeaf;){let e=0;s[0]>.5*(l.extent[0]+l.extent[2])&&(e+=1),s[1]<.5*(l.extent[1]+l.extent[3])&&(e+=2),l=l.children[e];}const e=l.renderData;return (e&&e.geometryState?e.geometryState.samplerData:null)?l:null}return null}get elevationBounds(){return this._elevationBounds}getScale(e){if(this.tilingScheme){if(!wn(e,We,this.spatialReference))return Ee.error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const t=this.rootTiles;if(r$A(t))for(let e of t)if(e.containsPoint(We)){for(;null!=e.children[0];){let t=0;We[0]>e.children[0].extent[2]&&(t+=1),We[1]<e.children[0].extent[1]&&(t+=2),e=e.children[t];}return this._getLodBiasCorrectedScale(e.level)}}return 1e100}getSphereScale(e,t){if(!this.tilingScheme)return null;if(!wn(e,We,this.spatialReference))return Ee.error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;We[3]=t;let i=null;const r=e=>{if(e&&g$A(e.extent,We))if(null!=e.children[0])for(const t of e.children)r(t);else {const t=this._getLodBiasCorrectedScale(e.level);i=null==i?t:Math.min(i,t);}},s=this.rootTiles;if(r$A(s))for(const a of s)r(a);return i}queryVisibleScaleRange(e,t,i,r){const s=t?this.tilingScheme.levelAtScale(t):0,a=i?this.tilingScheme.levelAtScale(i):1/0,n=this.lodBias;this._renderer.queryVisibleLevelRange(e,s+n,a+n,r);}_updateBaseOpacity(e){const t=this._renderer.opaque;this._renderer.opaque=e>=1,this._renderer.isTransparent=this._allTransparentSurfaceLayers();const i=t===this._renderer.opaque?2:1;var r,s;1===i&&(null==(r=this.view)||null==(s=r._stage)||s.renderView.setRenderParameters({opaqueTerrain:this.opaque}));this._updateTileTextures(i);}_updateTilingScheme(){const e=this.tilingSchemeLogic.tilingScheme;e!==this.tilingScheme&&(r$Z(!!e,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",e),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.setTileSize(e.pixelSize),this.overlayManager.setSpatialReference(e.spatialReference),this._updateRootTiles()));}_acquireTile(e,t,i,r){const s=this._tilePool.acquire();return Ge[0]=e,Ge[1]=t,Ge[2]=i,s.init(Ge,r,this),s}_updateRootTiles(){const{extent:e,tilingScheme:t}=this;if(!t)return;const i=Ne$1;let s=t.rootTilesInExtent(e,i,5*I$l);if(r$A(this.rootTiles)){if(s.length>I$l)return void Ee.warn(a$17);const e=this.rootTiles.map((e=>e.lij)),t=c$11(e,s,Ae);if(t.removed.length>0||t.added.length>0){const e=this.rootTiles.filter((e=>!(t.removed.findIndex((t=>Ae(t,e.lij)))>-1)||(this._purgeTile(e),!1)));t.added.forEach((t=>e.push(this._newRootTile(t)))),this._setRootTiles(e);}}else s.length>I$l&&(Ee.warn(u$O),s=t.rootTilesInExtent(e,i,I$l)),this._setRootTiles(s.map((e=>this._newRootTile(e))));G$i(i,this._rootTilesExtent)||(this._rootTilesExtent=u$B(i)),this.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready");}_newRootTile(e){const t=this._acquireTile(0,e[1],e[2],null);return 2===t.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&t.setPendingUpdate(2),this._loadTile(t),t}_setRootTiles(e){if(this._set("rootTiles",e),this._allTiles.clear(),r$A(e)){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove();}this._renderer.setRootTiles(this.rootTiles),this._updateTilesVisibility(e);}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate());}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this._visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateSkirts(),this._updateTilesVisibility(this.rootTiles)));}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(32)&&this._updateTileGeometry(e);}_updateTilesVisibility(e){if(t$F(e))return;const t=f$b(e);let i=t?this._elevationBounds.min:1/0,r=t?this._elevationBounds.max:-1/0;const s=this.view.state.fixedContentCamera,a=this.extent,n=this._viewProjectionMatrix;this.setTileTreeDirty();const l=this._iteratorPool.acquire();for(l.reset(e);!l.done;){const e=l.next();e.updateClippingStatus(a)&&e.resetPendingUpdate(32)&&this._updateTileGeometry(e),e.setPendingUpdate(16);const t=e.updateVisibilityNow();s||t?(e.updateScreenDepth(n),e.renderData&&(i=Math.min(e.elevationBounds[0],i),r=Math.max(e.elevationBounds[1],r))):l.skipSubtree();}l.remove(),this._viewChanged=!0,this._allTilesDirty=!0,isFinite(i)&&isFinite(r)&&(this._elevationBounds.min===i&&this._elevationBounds.max===r||(this._elevationBounds.min=i,this._elevationBounds.max=r,this.emit("elevation-bounds-change",null)));}_updateViewDependentParameters(){const e=this.view.state.camera,t=this.view.state.contentCamera,i=Math.tan(.5*t.fovX),r=Math.tan(.5*t.fovY),s=this.tilingScheme.pixelSize,a=2**-this.lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/e.width*this.maxTextureScale*a,this._splitLimits.relativeHeightLimit=s/e.height*this.maxTextureScale*a,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?(t$F(this._splitLimits.frustum)&&(this._splitLimits.frustum=b$q()),S$s(t.frustum,this._splitLimits.frustum)):this._splitLimits.frustum=null,S$s(e.frustum,this._frustum),e$G(this._viewProjectionMatrix,t.projectionMatrix,t.viewMatrix),r$B(this._eyePosRenderSR,t.eye),gn(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference);}_updateSkirts(){const e=this.view.state.camera,t=this.view.state.constraints.collision.enabled?0:1.11*e.near;this.skirtScale=f$F(this,this._eyePosSurfaceSR,t);}_updateRenderData(e){e.rendered&&!e.shouldLoad&&(Be$1(e)?this._loadChildren(e):Fe(e)&&this._loadParent(e));}_updateTileGeometry(e){e.updateVisibility(),this._renderer.updateTileGeometry(e),this._elevationUpdate(e),this._usedMemory=He;}_updateTileTexture(e,t){const i=e.resetPendingUpdate(128)?128:!!e.resetPendingUpdate(64)&&64;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=He,t.madeProgress());}_elevationUpdate(e){ze.spatialReference=this.spatialReference,ze.tile=e,ze.extent=e.extent,this.emit("elevation-change",ze),b$j(e.extent,this._eyePosSurfaceSR)&&this._updateSkirts();}get running(){return this.updating&&this.ready&&!this.suspended}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateTileStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;this._mergeAndSplit(e,t),e.run((()=>this._updateElevation(e))),e.run((()=>this._updateTextures(e))),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),e.done&&this.requestUpdate(),this.notifyChange("updatingProgressValue");}_updateTileStatus(e){if(!this._viewChanged||!this.rootTiles||e.done)return;this._viewChanged=!1;const t=this._iteratorPool.acquire();for(t.reset(this.rootTiles);!t.done;){const e=t.next();if(e.loadable){const i=e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping);if(2===i){e.resetPendingUpdate(8),e.isLeaf&&(e.setPendingUpdate(2),t.skipSubtree());continue}e.resetPendingUpdate(2)&&e.updateAgentSuspension(),4===i&&e.updateAgents(0);}if(t.skipSubtree(),!e.isLeaf){e.setPendingUpdate(8),e.resetPendingUpdate(2);const t=this._iteratorPool.acquire();t.resetOne(e);for(let e=t.next();!t.done;e=t.next())this._updateClippingStatus(e),e.updateVisibility(),e.loadable&&e.updateScreenDepth(this._viewProjectionMatrix);t.remove();}}t.remove(),this.requestUpdate(),e.madeProgress();}_sortTiles(e){e.done||this._allTilesSorted||(h$9(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress());}_mergeAndSplit(e,t){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=0;for(;!e.done;){let r=!1;i=0;const s=!this._allTiles.some((s=>{if(i+=s.usedMemory,s.resetPendingUpdate(8)){if(!t)return s.setPendingUpdate(8),e.done;this._mergeTile(s),r=!0,e.madeProgress();}else s.resetPendingUpdate(2)&&(this._splitTile(s),r=!0,e.madeProgress());return s.resetPendingUpdate(16)&&(this._updateRenderData(s),e.madeProgress()),e.done}));if(r&&(this._allTilesSorted=!1,this._allTilesDirty=!0),s){if(this._usedMemory=i,!r)break}else this._allTilesDirty=!0;}0===i&&(this._allTilesDirty=!0),this._sortTiles(e);}_updateElevation(e){return this._allTiles.some((t=>(t.resetPendingUpdate(32)&&(this._updateTileGeometry(t),this._updateTileTexture(t,e),e.madeProgress()),e.done))),e.hasProgressed}_updateTextures(e){return this._allTiles.some((t=>(this._updateTileTexture(t,e),e.done))),e.hasProgressed}_updateClippingExtent(){if(!this.spatialReference)return;let e;r$A(this.view.clippingArea)&&(e=u$B(),e$M(this.view.clippingArea,e,this.spatialReference)||(e=null)),G$i(e,this._userClippingExtent)||(this._userClippingExtent=e,this.updateTileOverlayParams(1),this.overlayManager.setPlacementDirty(),this._updateRootTiles());}get lodBias(){const e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*C$j}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=e$B(e-this.lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r}_removeAllTiles(){r$A(this.rootTiles)&&(this.rootTiles.forEach((e=>this._purgeTile(e))),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.visible=!1;}_purgeChildTiles(e){if(e.isLeaf)return !1;let t=this._purgeTile(e.children[0]);return t=this._purgeTile(e.children[1])||t,t=this._purgeTile(e.children[2])||t,t=this._purgeTile(e.children[3])||t,e.unsetChildren(),t}_purgeTile(e){const t=this._purgeChildTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),e.unload(this._renderer),this._tilePool.release(e),t}_splitTile(e){r$Z(e.isLeaf,"tile that is already split should not be split again!");const t=e.level+1,i=2*e.lij[1],r=2*e.lij[2];e.setChildren(this._createTile(t,i,r,e),this._createTile(t,i,r+1,e),this._createTile(t,i+1,r,e),this._createTile(t,i+1,r+1,e)),e.setPendingUpdate(16),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this._allTilesDirty=!0,this._emitTileScaleChange(e,t),++this._performanceInfo.numSplit;}_emitTileScaleChange(e,t=e.level){Xe$1.spatialReference=this.spatialReference,Xe$1.extent=e.extent,Xe$1.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",Xe$1);}_createTile(e,t,i,r){r$Z(!!r,"_createTile sanity check");const s=this._acquireTile(e,t,i,r);return s.updateClippingStatus(this.extent),s.loadable&&(s.updateScreenDepth(this._viewProjectionMatrix),2===s.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&s.setPendingUpdate(2)),s}_mergeTile(e){r$Z(!e.hasPendingUpdate(2),"_mergeTile sanity check"),this._purgeChildTiles(e)&&(r$Z(!e.renderData,"_mergeTile sanity check"),this._loadTile(e)),this._allTilesDirty=!0,++this._performanceInfo.numMerged,this._emitTileScaleChange(e);}_loadChildren(e){r$Z(e.rendered,"parent should be rendered"),e.unload(this._renderer),this._loadTile(e.children[0]),this._loadTile(e.children[1]),this._loadTile(e.children[2]),this._loadTile(e.children[3]);}_loadParent(e){const t=e.parent;this._unloadChildren(t),this._loadTile(t);}_unloadChildren(e){e.isLeaf||(this._unloadChildren(e.children[0]),e.children[0].unload(this._renderer),this._unloadChildren(e.children[1]),e.children[1].unload(this._renderer),this._unloadChildren(e.children[2]),e.children[2].unload(this._renderer),this._unloadChildren(e.children[3]),e.children[3].unload(this._renderer));}_loadTile(e){e.load(this._renderer),e.setPendingUpdate(16),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e),this._elevationUpdate(e);}_elevationDataArrived(e,t,i){const r=new i$b(e.lij,e.extent,i);e.dataArrived(t,0,r);const s=[e],a=e.level,n=this._iteratorPool.acquire();for(n.reset(s);!n.done;){const e=n.next();e.findElevationBoundsForLayer(t,a),e.computeElevationBounds();}n.remove(),this._updateTilesVisibility(s);}_handleLayerViewChanges(e=C$h){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(const s of this.view.allLayerViews.items)if(i.add(s.uid),E$k(s))if(this._basemapLayerViewHandles.has(s.uid)){const e=this.layerClassFromLayerView(s),i=this._layerIndexByUid[e].get(s.uid);i<r&&(t=!0),r=i;}else this._registerTiledLayerView(s),s.layer.loaded&&(t=!0);this._basemapLayerViewHandles.forEach(((e,r)=>{i.has(r)||(this._unregisterTiledLayerView(r),t=!0);})),t&&this._updateTiledLayers(),this._renderer.isTransparent=this._allTransparentSurfaceLayers(),e.madeProgress();}_allTransparentSurfaceLayers(){let e=0===this.view.map.ground.opacity;for(const t of this.view.allLayerViews.items)if(E$k(t)&&!x$w(t)&&!t$_(t.layer)&&0!==t.fullOpacity)return e=!1,e;return e}layerClassFromLayerView(e){return x$w(e)?0:1}_registerTiledLayerView(e){const t=[],i=this.layerClassFromLayerView(e);t.push(e.watch("suspended",(()=>this._updateTiledLayers()))),t.push(e.watch("fullOpacity",(()=>this._updateTileTextures(2)))),t.push(e.layer.watch("scaleRangeId",(()=>this._restartAllAgents(i)))),e.on("data-changed",(()=>{const t=this._layerIndexByUid[i].get(e.uid);null!=t&&this._invalidateLayerData(t,i);})),this._basemapLayerViewHandles.set(e.uid,t);}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(let e=0;e<t.length;e++)t[e].remove();this._basemapLayerViewHandles.delete(e);}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;const r=B$i();e.forEach((e=>{const s=e.layer;if(!s||e.suspended||!E$k(e))return;const a=e.fullExtent;if(!a)return void Ee.warn("Terrain: Map or elevation layer does not have fullExtent: "+s.id);if(!this.tilingScheme.compatibleWith(e.tileInfo))return void Ee.warn("Terrain: tiling scheme of layer "+s.id+" is incompatible with other tiled layers, will not be drawn");h$A(r,a,r);const n=this.layerClassFromLayerView(e);if(1===n){const t=e.displayLevelRange;t.maxLevel!==1/0&&(null===i||t.maxLevel>i)&&(i=t.maxLevel);}t[n].push(e);}));for(const s of o$R){const e=this._layerViews[s],i=t[s];i.reverse();const r=i.length;let a=e.length!==r;const n=new Array(r),l=new Array(e.length);this._layerIndexByUid[s].clear();for(let t=0;t<r;t++){const r=i[t].uid;this._layerIndexByUid[s].set(r,t);const o=e.indexOf(i[t]);n[t]=o,t!==o&&(a=!0),o>-1&&(l[o]=t);}if(a){const e=this._postorderIterator;for(e.reset(this.rootTiles);!e.done;)e.next().modifyLayers(l,n,s);this._layerViews[s]=i,this._restartAllAgents(s),this._updateTilesVisibility(this.rootTiles);}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate();}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;){const i=t.next();i.restartAgents(e),0===e&&i.computeElevationBounds();}}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll((t=>{t.updateAgents(1),1===e?this.renderer.updateTileTexture(t,64):t.updateRenderData(1,e);})),this._renderer.isTransparent=this._allTransparentSurfaceLayers();}_invalidateLayerData(e,t){this._allTiles.forAll((i=>i.removeLayerAgent(e,t))),this._allTiles.forAll((i=>i.invalidateLayerData(e,t)));}setTileTreeDirty(){this._allTilesDirty=!0;}requestRender(e=1){this.renderer.setNeedsRender(e);}requestUpdate(){1==++this._pendingUpdates&&(this._hasPendingUpdates=!0);}requestTileData(e,t,i,r){const s=this.layerViewByIndex(t,i),a=s.layer;return !a.tilemapCache||y$B(s)?this._requestTileData(e,i,s,r):(++this._asyncWorkItems,a.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],{...r,timeout:6e3}).then((()=>--this._asyncWorkItems)).catch((t=>{throw --this._asyncWorkItems,d$B(t)||this._dataMissing(e,i,s,{notInTilemap:!0}),t})).then((()=>this._frameTask.schedule((()=>this._requestTileData(e,i,s,r)),r.signal))))}_requestTileData(e,t,i,r){return 0===t?this._requestElevationTileData(e,i,r):this._requestMapTileData(e,i,r)}_requestElevationTileData(e,t,i){if(!x$w(t))return void r$Z(!1,"_requestElevationTileData can only be called for elevation layer views");const r=r=>{if(--this._asyncWorkItems,p$T(i))return;const s=this._layerIndexByUid[0].get(t.uid);null!=s?(this._usedMemory=He,this.requestUpdate(),this._elevationDataArrived(e,s,r)):Ee.warn("TerrainSurface: received data from unknown layer %d %s",0,e.lij.toString());},s=i=>{--this._asyncWorkItems,d$B(i)||(this._dataMissing(e,0,t,i),this.requestUpdate());};if(++this._asyncWorkItems,M$l(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:n$M,signal:i.signal}).then((e=>{if(p$T(i))return Ee.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void s(m$D());this._frameTask.schedule((()=>r(e)),i.signal,s);}),s);const a=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(a,"binary",i).then((e=>this._lercDecoder.decode(e,{noDataValue:n$M},i.signal))).then((e=>{r({values:e.pixelData,width:e.width,height:e.height,noDataValue:e.noDataValue,minValue:e.minValue,maxValue:e.maxValue});}),s)}_requestMapTileData(e,t,i){if(t instanceof p$d)return Promise.reject();++this._asyncWorkItems;const r=(r,s)=>{--this._asyncWorkItems,S$r(s),p$T(i)||(this._dataMissing(e,1,t,r),this.requestUpdate());},s=e=>t=>r(t,e),a=r=>this._frameTask.schedule((()=>{--this._asyncWorkItems,this.requestUpdate(),p$T(i)?S$r(r):this._mapTileDataArrived(e,t,r);}),i.signal,s(r)).catch(s(r)),n=(e,t=null)=>this._frameTask.schedule((()=>r(e,t)));if(y$B(t)){const r=t.schemaHelper.getLevelRowColumn(e.lij);return t.fetchTile(r[0],r[1],r[2],i).then(a,n)}if(v$x(t))return t.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(a,n);if(m$H(t)&&M$l(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then((e=>{if(p$T(i))return Ee.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void n(m$D());a(e);}),n);let l=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);p$Z(t.layer)&&t.layer.refreshTimestamp&&(l+=`${l.includes("?")?"&":"?"}_ts=${t.layer.refreshTimestamp}`);const o=t.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(l,o,i).then(a,n)}_mapTileDataArrived(e,t,i){const r=this._layerIndexByUid[1].get(t.uid);null!=r?e.dataArrived(r,1,i):(S$r(i),Ee.warn("TerrainSurface: received data from unknown layer"));}_dataMissing(e,t,i,r){const s=this._layerIndexByUid[t].get(i.uid);null!=s?e.dataMissing(s,t,r):Ee.warn("TerrainSurface: received data from unknown layer");}updateTileOverlayParams(e){this.rootTiles&&this.overlayManager&&(this._allTiles.forAll((e=>{e.renderData&&this.overlayManager.setTileParameters(e);})),this._renderer.setNeedsRender(e));}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((t=>{t.isLeaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++));})),e}getUsedMemory(){return this.tilingScheme?(this._usedMemory===He&&(this._usedMemory=0,this._allTiles.forAll((e=>this._usedMemory+=e.usedMemory))),this._usedMemory):0}getUsedMemoryForLayerView(e){let t=0;const i=this.layerClassFromLayerView(e),r=this._layerIndexByUid[i].get(e.uid);return this._allTiles.forAll((e=>t+=e.getUsedMemoryForLayer(i,r))),t}getTile(e){if(t$F(e)||t$F(this.rootTiles))return null;const t=e.split("/").map((e=>+e));if(0===t[0])return this.rootTiles.find((e=>e.lij[1]===t[1]&&e.lij[2]===t[2]));const i=2**t[0],r=Math.floor(t[1]/i),s=Math.floor(t[2]/i);let a;if(this.rootTiles.some((e=>e.lij[1]===r&&e.lij[2]===s&&(a=e,!0))),a){let e=1<<t[0]-1;for(;a.lij[0]<t[0];){let i=t[1]&e?2:0;if((t[2]&e)>0&&i++,!a.children[i])return null;a=a.children[i],e>>=1;}return r$Z(a.lij[0]===t[0]&&a.lij[1]===t[1]&&a.lij[2]===t[2],"not the right tile?"),a}return null}get test(){const e=this;return {renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:()=>{r$A(e.rootTiles)&&(e._mergeTile(e.rootTiles[0]),e._viewChangeUpdate());},getTiles:()=>e._allTiles.toArray(),getRenderedTiles:()=>(Qe$1.clear(),e._allTiles.forAll((e=>{e.visible&&e.rendered&&Qe$1.push(e);})),o$i(e.renderOrder,Qe$1),Qe$1.toArray()),lockTilingScheme(t,i){e._extentHelper.defaultTiledLayersExtent=i,e.tilingSchemeLogic.test.lockTilingScheme(t);}}}};e$x([d$y()],qe.prototype,"_renderer",void 0),e$x([d$y()],qe.prototype,"_hasPendingUpdates",void 0),e$x([d$y()],qe.prototype,"_asyncWorkItems",void 0),e$x([d$y()],qe.prototype,"_allTilesDirty",void 0),e$x([d$y()],qe.prototype,"_allTilesSorted",void 0),e$x([d$y()],qe.prototype,"_viewChanged",void 0),e$x([d$y({readOnly:!0})],qe.prototype,"_watchUpdatingTracking",void 0),e$x([d$y()],qe.prototype,"_frameTask",void 0),e$x([d$y({readOnly:!0})],qe.prototype,"snapLevel",null),e$x([d$y({readOnly:!0})],qe.prototype,"lodSnapping",null),e$x([d$y({constructOnly:!0})],qe.prototype,"view",void 0),e$x([d$y()],qe.prototype,"_userClippingExtent",void 0),e$x([d$y()],qe.prototype,"_rootTilesExtent",void 0),e$x([d$y({readOnly:!0})],qe.prototype,"extent",null),e$x([d$y({readOnly:!0})],qe.prototype,"groundExtent",null),e$x([d$y({readOnly:!0})],qe.prototype,"_tilingSchemeExtent",null),e$x([d$y({readOnly:!0})],qe.prototype,"updating",null),e$x([d$y(t$m)],qe.prototype,"updatingProgress",void 0),e$x([d$y({readOnly:!0})],qe.prototype,"updatingProgressValue",null),e$x([d$y()],qe.prototype,"_maxNumUpdating",void 0),e$x([d$y({aliasOf:"view.map.ground.opacity"})],qe.prototype,"baseOpacity",void 0),e$x([d$y({readOnly:!0})],qe.prototype,"overlayManager",void 0),e$x([d$y({readOnly:!0})],qe.prototype,"viewingMode",null),e$x([d$y()],qe.prototype,"maxTextureScale",void 0),e$x([d$y({readOnly:!0})],qe.prototype,"ready",null),e$x([d$y({value:1})],qe.prototype,"renderOrder",null),e$x([d$y({readOnly:!0})],qe.prototype,"rootTiles",void 0),e$x([d$y({readOnly:!0})],qe.prototype,"spatialReference",null),e$x([d$y()],qe.prototype,"backgroundImage",void 0),e$x([d$y({type:h$s,aliasOf:"view.map.ground.surfaceColor"})],qe.prototype,"backgroundColor",void 0),e$x([d$y()],qe.prototype,"_background",null),e$x([d$y({value:!1})],qe.prototype,"slicePlaneEnabled",null),e$x([d$y({readOnly:!0})],qe.prototype,"tilingScheme",void 0),e$x([d$y({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],qe.prototype,"tilingSchemeLocked",void 0),e$x([d$y({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],qe.prototype,"tilingSchemeDone",void 0),e$x([d$y({readOnly:!0})],qe.prototype,"tilingSchemeLogic",void 0),e$x([d$y({value:!0})],qe.prototype,"velvetOverground",null),e$x([o$T("_renderer.wireframe")],qe.prototype,"wireframe",void 0),e$x([d$y({value:!1})],qe.prototype,"suspended",null),e$x([d$y({readOnly:!0,aliasOf:"view.qualitySettings.tiledSurface.textureFadeDuration"})],qe.prototype,"textureFadeDuration",void 0),e$x([d$y()],qe.prototype,"_layerViewsDirty",void 0),e$x([o$T("_renderer.renderPatchBorders")],qe.prototype,"renderPatchBorders",void 0),e$x([o$T("_renderer.renderingDisabled")],qe.prototype,"renderingDisabled",void 0),qe=e$x([i$H("esri.views.3d.terrain.TerrainSurface")],qe);const Oe=qe;function Ae(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function Be$1(e){return !e.isLeaf&&(e.children[0].shouldLoad||e.children[1].shouldLoad||e.children[2].shouldLoad||e.children[3].shouldLoad||Be$1(e.children[0])||Be$1(e.children[1])||Be$1(e.children[2])||Be$1(e.children[3]))}function Fe(e){return e.isLeaf&&e.parent&&e.parent.shouldLoad}const He=-1,We=n$P(),Ne$1=u$B(),Ge=[0,0,0],Qe$1=new n$Z,ze={spatialReference:null,tile:null,extent:null,context:"ground"},Xe$1={spatialReference:null,extent:null,scale:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let m$6=class extends p$N{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1;}commit(e){this.dirty=!1,this._dirtyGeomRecords.forEach(((t,r)=>this.commitLayer(r,e)));}commitLayer(e,t){const r=this._dirtyGeomRecords.get(e);r&&(r.forEach(((r,s)=>{const d=this._ensureGeomRecord(e,s);r.forEach(((e,r)=>{const i=e[0],c=e[1],m=e[2];let h=!1;if(2&c){const e=d.get(r);if(e){const r=e[1];if(4&m){const e=this.model.getObject(s);this.model.updateRenderGeometryTransformation(e,i,r)&&(h=!0);}h||t.updates.push({renderGeometry:r,updateType:m});}else i$13(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update");}if(4&c||h){const e=d.get(r);e?(t.removes.push(e[1]),d.delete(r),e[0].disposed&&o$U.pool.release(e[0])):4===c&&i$13(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove");}if(1&c||h){const e=this.model.getObject(s);if(r$A(e)){const o=this.model.getRenderGeometry(e,i),s=[i,o];t.adds.push(o),d.set(r,s);}}})),0===d.size&&this._residentGeomRecords.get(e).delete(s);})),0===this._residentGeomRecords.get(e).size&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e));}getResidentRenderGeometries(e,t){const r=this._residentGeomRecords.get(e);r&&r.forEach((e=>e.forEach((e=>t.push(e[1])))));}_objectStateChanged(e,t){for(const r of t.geometryRecords)this._updateOrCreateDirtyRecord(t,r,null,2,0,0,2,5,e);}visibilityChanged(e){this._objectStateChanged(1,e);}highlightChanged(e){this._objectStateChanged(8,e);}occlusionChanged(e){this._objectStateChanged(16,e);}vertexAttrsUpdated(e){this._updateOrCreateDirtyRecord(e.object,e.record,null,2,0,0,2,5,2);}layerAdded(e){e.objects.forAll((t=>this._layerObjectAdded(e,t)));}layerRemoved(e){e.objects.forAll((t=>this._layerObjectRemoved(e,t)));}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object);}_layerObjectAdded(e,t){const r=e.id;for(const o of t.geometryRecords)this._objectGeometryAdded(t,o,r);}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object);}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t);}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t);}_layerObjectRemoved(e,t){const r=e.id;for(const o of t.geometryRecords)this._objectGeometryRemoved(t,o,r);}shaderTransformationChanged(e){const t=this._residentGeomRecords.get(e.id);t&&t.forEach(((e,t)=>{const r=this.model.getObject(t);r&&r.hasVolativeTransformation()&&e.forEach((e=>{e[1].shaderTransformationChanged();}));}));}objectTransformation(e){const t=this._getParentLayerId(e),r=e.id;this._ensureGeomRecord(t,r).forEach((r=>{this._updateOrCreateDirtyRecord(e,r[0],t,2,0,0,2,5,4);}));}objectGeometryAdded(e){this._objectGeometryAdded(e.object,e.record);}_objectGeometryAdded(e,t,r=null){this._updateOrCreateDirtyRecord(e,t,r,1,4,0,0,0);}objectGeometryRemoved(e){this._objectGeometryRemoved(e.object,e.record);}_objectGeometryRemoved(e,t,r=null){this._updateOrCreateDirtyRecord(e,t,r,4,1,2,0,0);}_updateOrCreateDirtyRecord(e,t,r,o,d,i,c,m,h){r=c$N(r,this._getParentLayerId(e));const y=e.id,l=t.id,p=this._ensureDirtyRecord(r,y),R=p.get(l);if(R){const e=R[1];e&d?(p.delete(l),R[0].disposed&&o$U.pool.release(R[0])):e&i?(R[1]=o,R[2]=h):e&c?R[2]|=h:e&m||i$13(!1,"ModelDirtySet.objectGeometryAdded: inconsistent state");}else p.set(l,[t,o,h]);this.dirty=this._hasDirtyGeometryRecords;}_ensureGeomRecord(e,t){let r=this._residentGeomRecords.get(e);r||(r=new Map,this._residentGeomRecords.set(e,r));let o=r.get(t);return o||(o=new Map,r.set(t,o)),o}get _hasDirtyGeometryRecords(){return n$_(this._dirtyGeomRecords,(e=>n$_(e,(e=>e&&e.size>0))))}_ensureDirtyRecord(e,t){let r=this._dirtyGeomRecords.get(e);r||(r=new Map,this._dirtyGeomRecords.set(e,r));let o=r.get(t);return o||(o=new Map,r.set(t,o)),o}_getParentLayerId(e){return r$A(e.parentLayer)?e.parentLayer.id:n$18}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach(((r,o)=>{r.forEach(((r,s)=>{t.length>0&&(t+="\n"),t+=o+"."+s;const d=[];r.forEach((e=>{const t=e[1];d[t]||(d[t]=[]),d[t].push(e[0].geometry.id);}));for(let o=0;o<d.length;o++)if(d[o]){t+=" "+e[o-1]+": ";for(let e=0;e<d[o].length;e++)t+=d[o][e]+", ";}}));})),t}get test(){const e=this;return {get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce(((e,t)=>e+t.size),0)}}}};e$x([d$y({constructOnly:!0})],m$6.prototype,"model",void 0),e$x([d$y()],m$6.prototype,"dirty",void 0),m$6=e$x([i$H("esri.views.3d.webgl-engine.lib.ModelDirtySet")],m$6);const h$5=m$6;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let l$9=class extends p$N{constructor(){super(...arguments),this.dirtySet=new h$5({model:this}),this._content=new Map,this._originFactory=new d$O(null,75e4);}getObject(t){return this._content.get(t)}add(t){const e=t.id;i$13(!this._content.has(e),"Model/Stage already contains object to be added"),this._content.set(e,t),l$Q(t)&&this.dirtySet.layerAdded(t);}remove(t){i$13(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id),t.unload(),l$Q(t)&&this.dirtySet.layerRemoved(t);}addMany(t){for(const e of t)r$A(e)&&(i$13(!this._content.has(e.id),"Model/Stage already contains object to be added"),this._content.set(e.id,e));}removeMany(t){for(const e of t)i$13(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id),e.unload();}forEachOfType(t,e){this._content.forEach((o=>{o.type===t&&e(o);}));}getRenderGeometry(t,e){const{geometry:o,material:r,id:n,shaderTransformation:i,origin:s,instanceParameters:a}=e,d=new l$R(o,r,null,null,n,o.boundingInfo,i,t.castShadow);return d.updateTransformation((o=>t.getCombinedStaticTransformation(e,o))),d.origin=s||this._originFactory.getOrigin(d.boundingSphere),d.instanceParameters=a,d}updateRenderGeometryTransformation(t,e,o){if(t$F(t))return !1;o.updateTransformation((o=>t.getCombinedStaticTransformation(e,o)));const n=this._originFactory.getOrigin(o.boundingSphere);return o.origin!==n}getStats(){const t={},e=Array.from(this._content.values());for(let o=0;o<5;++o)t[o]=e.filter((t=>t.type===o)).length;return {contentTypes:t,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){return {content:Array.from(this._content.values())}}};e$x([d$y({constructOnly:!0})],l$9.prototype,"dirtySet",void 0),l$9=e$x([i$H("esri.views.3d.webgl-engine.parts.Model")],l$9);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const t$e=1e-6,n$f=[0,0,0],r$a=[0,0,0];function i$a(t,i){const{data:s,size:e}=t,a=s.length/e;if(a<=0)return;const c=new H$5(t);L$4(n$f,c.minProj,c.maxProj),R$4(n$f,n$f,.5),Q$3(r$a,c.maxProj,c.minProj);const h=K$5(r$a),u=new J$5;u.quality=h,a<14&&(t={data:new Float64Array(c.buffer,112,42),size:3});const f=[0,0,0],m=[0,0,0],P=[0,0,0],j=[0,0,0],b=[0,0,0],x=[0,0,0],I=[0,0,0];switch(o$d(c,t,I,f,m,P,j,b,x,u)){case 1:return void z$3(n$f,r$a,i);case 2:return void G$3(t,j,i)}l$8(t,I,f,m,P,j,b,x,u),O$2(t,u.b0,u.b1,u.b2,Y$3,_$3);const N=[0,0,0];Q$3(N,_$3,Y$3),u.quality=K$5(N),u.quality<h?C$3(u.b0,u.b1,u.b2,Y$3,_$3,N,i):z$3(n$f,r$a,i);}function o$d(n,r,i,o,s,e,a,c,h,u){if(P$4(n,o,s),$$2(o,s)<t$e)return 1;Q$3(a,o,s),X$2(a,a);return b$3(r,o,a,e)<t$e?2:(Q$3(c,s,e),X$2(c,c),Q$3(h,e,o),X$2(h,h),W$3(i,c,a),X$2(i,i),d$b(r,i,a,c,h,u),0)}const s$8=[0,0,0],e$b=[0,0,0],a$a=[0,0,0],c$b=[0,0,0],h$4=[0,0,0],u$8=[0,0,0],f$6=[0,0,0],m$5=[0,0,0];function l$8(t,n,r,i,o,l,P,j,b){I$3(t,n,r,s$8,e$b),void 0!==s$8[0]&&(Q$3(a$a,s$8,r),X$2(a$a,a$a),Q$3(c$b,s$8,i),X$2(c$b,c$b),Q$3(h$4,s$8,o),X$2(h$4,h$4),W$3(u$8,c$b,l),X$2(u$8,u$8),W$3(f$6,h$4,P),X$2(f$6,f$6),W$3(m$5,a$a,j),X$2(m$5,m$5),d$b(t,u$8,l,c$b,a$a,b),d$b(t,f$6,P,h$4,c$b,b),d$b(t,m$5,j,a$a,h$4,b)),void 0!==e$b[0]&&(Q$3(a$a,e$b,r),X$2(a$a,a$a),Q$3(c$b,e$b,i),X$2(c$b,c$b),Q$3(h$4,e$b,o),X$2(h$4,h$4),W$3(u$8,c$b,l),X$2(u$8,u$8),W$3(f$6,h$4,P),X$2(f$6,f$6),W$3(m$5,a$a,j),X$2(m$5,m$5),d$b(t,u$8,l,c$b,a$a,b),d$b(t,f$6,P,h$4,c$b,b),d$b(t,m$5,j,a$a,h$4,b));}function P$4(t,n,r){let i=$$2(t.maxVert[0],t.minVert[0]),o=0;for(let s=1;s<7;++s){const n=$$2(t.maxVert[s],t.minVert[s]);n>i&&(i=n,o=s);}U$3(n,t.minVert[o]),U$3(r,t.maxVert[o]);}const j$4=[0,0,0];function b$3(t,n,r,i){const{data:o,size:s}=t;let e=Number.NEGATIVE_INFINITY,a=0;for(let c=0;c<o.length;c+=s){j$4[0]=o[c]-n[0],j$4[1]=o[c+1]-n[1],j$4[2]=o[c+2]-n[2];const t=r[0]*j$4[0]+r[1]*j$4[1]+r[2]*j$4[2],i=r[0]*r[0]+r[1]*r[1]+r[2]*r[2],s=j$4[0]*j$4[0]+j$4[1]*j$4[1]+j$4[2]*j$4[2]-t*t/i;s>e&&(e=s,a=c);}return U$3(i,o,a),e}const x$5=[0,0];function I$3(n,r,i,o,s){T$4(n,r,x$5,s,o);const e=tt$1(i,r);x$5[1]-t$e<=e&&(o[0]=void 0),x$5[0]+t$e>=e&&(s[0]=void 0);}const N$6=[0,0,0],V$4=[0,0,0],y$4=[0,0,0],q$3=[0,0,0],w$4=[0,0,0],A$4=[0,0,0];function d$b(n,r,i,o,s,e){if(Z$2(r)<t$e)return;W$3(N$6,i,r),W$3(V$4,o,r),W$3(y$4,s,r),F$4(n,r,x$5),w$4[1]=x$5[0],q$3[1]=x$5[1],A$4[1]=q$3[1]-w$4[1];const a=[i,o,s],c=[N$6,V$4,y$4];for(let t=0;t<3;++t){F$4(n,a[t],x$5),w$4[0]=x$5[0],q$3[0]=x$5[1],F$4(n,c[t],x$5),w$4[2]=x$5[0],q$3[2]=x$5[1],A$4[0]=q$3[0]-w$4[0],A$4[2]=q$3[2]-w$4[2];const i=K$5(A$4);i<e.quality&&(U$3(e.b0,a[t]),U$3(e.b1,r),U$3(e.b2,c[t]),e.quality=i);}}const M$5=[0,0,0];function F$4(t,n,r){const{data:i,size:o}=t;r[0]=Number.POSITIVE_INFINITY,r[1]=Number.NEGATIVE_INFINITY;for(let s=0;s<i.length;s+=o){const t=i[s]*n[0]+i[s+1]*n[1]+i[s+2]*n[2];r[0]=Math.min(r[0],t),r[1]=Math.max(r[1],t);}}function T$4(t,n,r,i,o){const{data:s,size:e}=t;U$3(i,s),U$3(o,i),r[0]=tt$1(M$5,n),r[1]=r[0];for(let a=e;a<s.length;a+=e){const t=s[a]*n[0]+s[a+1]*n[1]+s[a+2]*n[2];t<r[0]&&(r[0]=t,U$3(i,s,a)),t>r[1]&&(r[1]=t,U$3(o,s,a));}}function z$3(t,n,r){U$3(r.center,t),R$4(r.halfSize,n,.5),r.quaternion[0]=0,r.quaternion[1]=0,r.quaternion[2]=0,r.quaternion[3]=1;}const E$4=[0,0,0],v$6=[0,0,0],g$3=[0,0,0],Y$3=[0,0,0],_$3=[0,0,0],S$5=[0,0,0];function G$3(n,r,i){U$3(E$4,r),Math.abs(r[0])>Math.abs(r[1])&&Math.abs(r[0])>Math.abs(r[2])?E$4[0]=0:Math.abs(r[1])>Math.abs(r[2])?E$4[1]=0:E$4[2]=0,Z$2(E$4)<t$e&&(E$4[0]=E$4[1]=E$4[2]=1),W$3(v$6,r,E$4),X$2(v$6,v$6),W$3(g$3,r,v$6),X$2(g$3,g$3),O$2(n,r,v$6,g$3,Y$3,_$3),Q$3(S$5,_$3,Y$3),C$3(r,v$6,g$3,Y$3,_$3,S$5,i);}function O$2(t,n,r,i,o,s){F$4(t,n,x$5),o[0]=x$5[0],s[0]=x$5[1],F$4(t,r,x$5),o[1]=x$5[0],s[1]=x$5[1],F$4(t,i,x$5),o[2]=x$5[0],s[2]=x$5[1];}const p$7=[0,0,0],B$5=[1,0,0,0,1,0,0,0,1],k$2=[0,0,0];function C$3(t,n,r,i,o,s,e){B$5[0]=t[0],B$5[1]=t[1],B$5[2]=t[2],B$5[3]=n[0],B$5[4]=n[1],B$5[5]=n[2],B$5[6]=r[0],B$5[7]=r[1],B$5[8]=r[2],nt$1(e.quaternion,B$5),L$4(k$2,i,o),R$4(k$2,k$2,.5),R$4(e.center,t,k$2[0]),R$4(p$7,n,k$2[1]),L$4(e.center,e.center,p$7),R$4(p$7,r,k$2[2]),L$4(e.center,e.center,p$7),R$4(e.halfSize,s,.5);}const D$3=7;class H$5{constructor(t){this.minVert=new Array(D$3),this.maxVert=new Array(D$3);const n=64*D$3;this.buffer=new ArrayBuffer(n);let r=0;this.minProj=new Float64Array(this.buffer,r,D$3),r+=8*D$3,this.maxProj=new Float64Array(this.buffer,r,D$3),r+=8*D$3;for(let a=0;a<D$3;++a)this.minVert[a]=new Float64Array(this.buffer,r,3),r+=24;for(let a=0;a<D$3;++a)this.maxVert[a]=new Float64Array(this.buffer,r,3),r+=24;for(let a=0;a<D$3;++a)this.minProj[a]=Number.POSITIVE_INFINITY,this.maxProj[a]=Number.NEGATIVE_INFINITY;const i=new Array(D$3),o=new Array(D$3),{data:s,size:e}=t;for(let a=0;a<s.length;a+=e){let t=s[a];t<this.minProj[0]&&(this.minProj[0]=t,i[0]=a),t>this.maxProj[0]&&(this.maxProj[0]=t,o[0]=a),t=s[a+1],t<this.minProj[1]&&(this.minProj[1]=t,i[1]=a),t>this.maxProj[1]&&(this.maxProj[1]=t,o[1]=a),t=s[a+2],t<this.minProj[2]&&(this.minProj[2]=t,i[2]=a),t>this.maxProj[2]&&(this.maxProj[2]=t,o[2]=a),t=s[a]+s[a+1]+s[a+2],t<this.minProj[3]&&(this.minProj[3]=t,i[3]=a),t>this.maxProj[3]&&(this.maxProj[3]=t,o[3]=a),t=s[a]+s[a+1]-s[a+2],t<this.minProj[4]&&(this.minProj[4]=t,i[4]=a),t>this.maxProj[4]&&(this.maxProj[4]=t,o[4]=a),t=s[a]-s[a+1]+s[a+2],t<this.minProj[5]&&(this.minProj[5]=t,i[5]=a),t>this.maxProj[5]&&(this.maxProj[5]=t,o[5]=a),t=s[a]-s[a+1]-s[a+2],t<this.minProj[6]&&(this.minProj[6]=t,i[6]=a),t>this.maxProj[6]&&(this.maxProj[6]=t,o[6]=a);}for(let a=0;a<D$3;++a){let t=i[a];U$3(this.minVert[a],s,t),t=o[a],U$3(this.maxVert[a],s,t);}}}class J$5{constructor(){this.b0=[1,0,0],this.b1=[0,1,0],this.b2=[0,0,1],this.quality=0;}}function K$5(t){return t[0]*t[1]+t[0]*t[2]+t[1]*t[2]}function L$4(t,n,r){t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2];}function Q$3(t,n,r){t[0]=n[0]-r[0],t[1]=n[1]-r[1],t[2]=n[2]-r[2];}function R$4(t,n,r){t[0]=n[0]*r,t[1]=n[1]*r,t[2]=n[2]*r;}function U$3(t,n,r=0){t[0]=n[r+0],t[1]=n[r+1],t[2]=n[r+2];}function W$3(t,n,r){const i=n[0],o=n[1],s=n[2],e=r[0],a=r[1],c=r[2];t[0]=o*c-s*a,t[1]=s*e-i*c,t[2]=i*a-o*e;}function X$2(t,n){const r=n[0]*n[0]+n[1]*n[1]+n[2]*n[2];if(r>0){const i=1/Math.sqrt(r);t[0]=n[0]*i,t[1]=n[1]*i,t[2]=n[2]*i;}}function Z$2(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]}function $$2(t,n){const r=n[0]-t[0],i=n[1]-t[1],o=n[2]-t[2];return r*r+i*i+o*o}function tt$1(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]}function nt$1(t,n){const r=n[0]+n[4]+n[8];if(r>0){let i=Math.sqrt(r+1);t[3]=.5*i,i=.5/i,t[0]=(n[5]-n[7])*i,t[1]=(n[6]-n[2])*i,t[2]=(n[1]-n[3])*i;}else {let r=0;n[4]>n[0]&&(r=1),n[8]>n[3*r+r]&&(r=2);const i=(r+1)%3,o=(r+2)%3;let s=Math.sqrt(n[3*r+r]-n[3*i+i]-n[3*o+o]+1);t[r]=.5*s,s=.5/s,t[3]=(n[3*i+o]-n[3*o+i])*s,t[i]=(n[3*i+r]+n[3*r+i])*s,t[o]=(n[3*o+r]+n[3*r+o])*s;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const w$3=e$S(),A$3=n$F(),B$4=n$F(),C$2=e$A();class D$2{constructor(t){const e=56,a=0,n=24,r=36,s=t*e;this.buffer=new ArrayBuffer(s),this.obbs=new Array(t);for(let o=0;o<t;o++)this.obbs[o]={center:u$P(this.buffer,e*o+a),halfSize:e$T(this.buffer,e*o+n),quaternion:e$U(this.buffer,e*o+r)};}}function E$3(t=[0,0,0],e=[-1,-1,-1],a=[0,0,0,1]){return {center:t$G(t),halfSize:r$10(e),quaternion:r$11(a)}}function F$3(t){return E$3(t.center,t.halfSize,t.quaternion)}function G$2(t,e){r$B(e.center,t.center),r$B(e.halfSize,t.halfSize),F$h(e.quaternion,t.quaternion);}function H$4(t,e){return e=e||E$3(),i$a(t,e),e}function J$4(t,e){const a=R$k(e,t.center),n=U$2(t,W$b(e));return a>n?1:a<-n?-1:0}function K$4(e,a){a||(a=a$R());const n=p$_(C$2,e.quaternion),r=e.halfSize[0]*Math.abs(n[0])+e.halfSize[1]*Math.abs(n[3])+e.halfSize[2]*Math.abs(n[6]),s=e.halfSize[0]*Math.abs(n[1])+e.halfSize[1]*Math.abs(n[4])+e.halfSize[2]*Math.abs(n[7]),f=e.halfSize[0]*Math.abs(n[2])+e.halfSize[1]*Math.abs(n[5])+e.halfSize[2]*Math.abs(n[8]);return a[0]=e.center[0]-r,a[1]=e.center[1]-s,a[2]=e.center[2]-f,a[3]=e.center[0]+r,a[4]=e.center[1]+s,a[5]=e.center[2]+f,a}function L$3(t,e){return R$k(e,t.center)-U$2(t,W$b(e))}function N$5(t,e){return R$k(e,t.center)+U$2(t,W$b(e))}function O$1(t,e){return J$4(t,e[0])<=0&&J$4(t,e[1])<=0&&J$4(t,e[2])<=0&&J$4(t,e[3])<=0&&J$4(t,e[4])<=0&&J$4(t,e[5])<=0}function P$3(t,e,a,n=0){w$p(w$3,t.quaternion),c$O(A$3,e,t.center);const s=P$o(A$3,A$3,w$3),f=P$o(B$4,a,w$3);let o=-1/0,i=1/0;for(let r=0;r<3;r++)if(Math.abs(f[r])>1e-6){const e=(n+t.halfSize[r]-s[r])/f[r],a=(-n-t.halfSize[r]-s[r])/f[r];o=Math.max(o,Math.min(e,a)),i=Math.min(i,Math.max(e,a));}else if(s[r]>t.halfSize[r]+n||s[r]<-t.halfSize[r]-n)return !1;return o<=i}(()=>{const t=new Int8Array(162);let e=0;const a=a=>{for(let n=0;n<a.length;n++)t[e+n]=a[n];e+=6;};return a([6,2,3,1,5,4]),a([0,2,3,1,5,4]),a([0,2,3,7,5,4]),a([0,1,3,2,6,4]),a([0,1,3,2,0,0]),a([0,1,5,7,3,2]),a([0,1,3,7,6,4]),a([0,1,3,7,6,2]),a([0,1,5,7,6,2]),a([0,1,5,4,6,2]),a([0,1,5,4,0,0]),a([0,1,3,7,5,4]),a([0,2,6,4,0,0]),a([0,0,0,0,0,0]),a([1,3,7,5,0,0]),a([2,3,7,6,4,0]),a([2,3,7,6,0,0]),a([2,3,1,5,7,6]),a([0,1,5,7,6,2]),a([0,1,5,7,6,4]),a([0,1,3,7,6,4]),a([4,5,7,6,2,0]),a([4,5,7,6,0,0]),a([4,5,1,3,7,6]),a([0,2,3,7,5,4]),a([6,2,3,7,5,4]),a([6,2,3,1,5,4]),t})();function U$2(t,e){w$p(w$3,t.quaternion),P$o(A$3,e,w$3);const a=t.halfSize;return Math.abs(A$3[0]*a[0])+Math.abs(A$3[1]*a[1])+Math.abs(A$3[2]*a[2])}function V$3(t,e){for(let a=0;a<8;++a){const n=e[a];n[0]=1&a?-t.halfSize[0]:t.halfSize[0],n[1]=2&a?-t.halfSize[1]:t.halfSize[1],n[2]=4&a?-t.halfSize[2]:t.halfSize[2],P$o(n,n,t.quaternion),u$A(n,n,t.center);}}function W$2(t){return Y$b(t.halfSize)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class t$d{constructor(t){this._totalCount=t,this._indexRanges=[0,t];}componentCount(){const t=this._indexRanges;let n=0;for(let e=0;e<t.length;e+=2)n+=t[e+1];return n}reset(t){"all"===t||t.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=n$e(t);}forEachComponent(t){const n=this._indexRanges;for(let e=0;e<n.length;e+=2){const s=n[e],o=s+n[e+1];for(let n=s;n<o;n++)if(!t(n))return !1}return !0}forEachComponentRange(t){const n=this._indexRanges;for(let e=0;e<n.length;e+=2){const s=n[e];if(!t(s,s+n[e+1]))return !1}return !0}computeOffsetRanges(t){const n=new Array(this._indexRanges.length),e=this._indexRanges;for(let s=0;s<e.length;s+=2){const o=e[s],r=o+e[s+1],h=t[o],i=t[r];n[s]=h,n[s+1]=i-h;}return n}}function n$e(t){const n=new Array;if(0===t.length)return n;let e=t[0],s=1;for(let o=1;o<t.length;o++){const r=t[o];e+s===r?s+=1:(n.push(e),n.push(s),e=r,s=1);}return n.push(e),n.push(s),n}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class a$9 extends e$V{constructor(t,e){super(),this.pickability=null,this.highlightCounts=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null,this.offsets=t$$(e);const s=this.count;this.visibility=new t$d(s),this.materialDataBuffer=t.getBuffer(s),this.materialDataIndices=new Uint16Array(s);for(let h=0;h<s;h++)this.materialDataIndices[h]=this.materialDataBuffer.acquireIndex();}dispose(){super.dispose();for(let t=0;t<this.count;t++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[t]);}get count(){return this.offsets.length-1}get geometryRanges(){return t$F(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return t$F(this.highlightCounts)?null:(this.updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return t$F(this.highlightCounts)?this.geometryRanges:(this.updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null;}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty();}updateCachedHighlightRanges(){if((t$F(this.cachedHighlightRanges)||t$F(this.cachedDefaultRanges))&&r$A(this.highlightCounts)){const{highlightRanges:t,defaultRanges:e}=n$d(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=t,this.cachedDefaultRanges=e;}}}function n$d(t,e,h){const i=[],s=[];let a=h.length,n=h.length;return e.forEachComponent((e=>(t[e]>0?(a!==e-1&&(i.length&&i.push(h[a+1]-i[i.length-1]),i.push(h[e])),a=e):(n!==e-1&&(s.length&&s.push(h[n+1]-s[s.length-1]),s.push(h[e])),n=e),!0))),i.length&&i.push(h[a+1]-i[i.length-1]),s.length&&s.push(h[n+1]-s[s.length-1]),{highlightRanges:i,defaultRanges:s}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class e$a extends e$V{constructor(){super(...arguments),this.visible=0;}}e$x([i$14()],e$a.prototype,"renderable",void 0),e$x([i$14()],e$a.prototype,"components",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function n$c(n){return "function"==typeof n}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function t$c(t,n,e,l){if(e>=n)return t;null==t&&(t=i$9());const s=t.isVisibleBit;let a=t.data;const c=r$9(a),o=e/c|0,f=e-c*o,h=(n-1)/c|0,B=a,E=l===s;if(!(e<B.length*c)&&E){const t=1.5,n=o+1,i=Math.ceil(B.length*t),e=h+1;let r=Math.max(n,i);r=Math.min(r,e),a=new Uint32Array(r),a.set(B);}return o<a.length&&(a[o]=u$7(a[o],f,E)),t.data=a,t}function n$b(t,n){if(null==t)return !0;const{isVisibleBit:i,data:u}=t,l=r$9(u);return n<u.length*l?e$9(i,u,n,l):!t.isVisibleBit}function i$9(t=!0){return {isVisibleBit:!t,data:new Uint32Array(0)}}function e$9(t,n,i,e){const r=i/e|0,u=i-r*e;return l$7(n[r],u)===t}function r$9(t){const n=8;return t.BYTES_PER_ELEMENT*n}function u$7(t,n,i){return t&~(1<<n)|(i?1:0)<<n}function l$7(t,n){return 0!=(t&1<<n)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class u$6{constructor(o,s){this._indices=r$A(o.indices)?o.indices:l$S(o.positions.length/3),this._positions=new i$12(o.positions),this._components=s,this._componentIntersectionData=new Array(s.count);}getComponentAabb(o,s){if(r$A(this._perComponentAabbs)){for(let t=0;t<6;t++)s[t]=this._perComponentAabbs[6*o+t];return s}return this._computePerComponentAabbs(),this.getComponentAabb(o,s)}getComponentPositions(t,o){o.indices=this._indices,o.data=this._positions.typedBuffer,o.stride=this._positions.typedBufferStride,o.startIndex=this._components.offsets[t],o.endIndex=this._components.offsets[t+1];}intersect(s,e,i,r,p,h){const u={data:this._positions.typedBuffer,stride:this._positions.typedBufferStride,size:3},l=this._indices,C=this._components.offsets,y=j$w(s,e,d$a);this._components.visibility.forEachComponent((f=>{if(!n$b(this._components.pickability,f))return !0;const d=this.getComponentAabb(f,A$2);if(r$A(p)&&p.applyToAabb(d),!A$q(d,s,y,i))return !0;const g=C[f]/3,B=C[f+1]/3,j=(t,o,s)=>{h(f,t,L$g(o,o,r),s);},I=B-g;return t$F(p)&&I>r$b?(null==this._componentIntersectionData[f]&&(this._componentIntersectionData[f]=new d$c(this._indices,g,B,u)),this._componentIntersectionData[f].intersectRay({r0:s,r1:e},j)):M$j(s,e,g,B,l,u,void 0,p,j),!0}));}_computePerComponentAabbs(){const t=this._components.count;this._perComponentAabbs=new Float32Array(6*t);for(let o=0;o<t;o++)this._computeAABB(o);}_computeAABB(t){const o=this._indices,n=this._positions,i=this._components.offsets,r=i[t],p=i[t+1],m=[0,0,0],a=[1/0,1/0,1/0],c=[-1/0,-1/0,-1/0];for(let f=r;f<p;f++){const t=o[f];n.getVec(t,m),f$G(a,a,m),l$T(c,c,m);}let h=6*t;this._perComponentAabbs[h++]=a[0],this._perComponentAabbs[h++]=a[1],this._perComponentAabbs[h++]=a[2],this._perComponentAabbs[h++]=c[0],this._perComponentAabbs[h++]=c[1],this._perComponentAabbs[h]=c[2];}get positions(){return this._positions}get indices(){return this._indices}}const d$a=n$F(),A$2=a$R();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class s$7{constructor(s,t,e,i){this.material=s,this.drawParameters=t,this.geometry=e,this.meta=i;}dispose(){this.material.dispose(),this.geometry.dispose();}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class o$c extends e$V{constructor(s,t,i,o){super(),this.primitiveType=t,this.parameters=i,this.indexed=o,this.vao=s;}}e$x([i$14()],o$c.prototype,"vao",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function r$8(r,n){return {near:r,far:n}}function n$a(n){return n?a$8(n,1/0,-1/0):r$8(1/0,-1/0)}function a$8(r,n,a){return r.near=n,r.far=a,r}function t$b(r,n,a=r){return a.near=Math.min(r.near,n.near),a.far=Math.max(r.far,n.far),a}function e$8(r,n){return r.near<=n&&n<=r.far}const f$5={near:0,far:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function z$2(t,n){const r=n$a(),{eye:e,frustum:o,viewForward:a}=t;n.forAll((t=>{const n=t.obb,f=z$i(J$e(E$2,n.center,e),a),l=U$2(n,a);if(e$8(r,f-l)&&e$8(r,f+l))return;const u=R$3(n,o);if(-1===u)return;if(0===u)return q$2.far=f+l,q$2.near=f-l,void t$b(r,q$2);const i=S$4.pushNew();i.near=f-l,i.far=f+l,i.mask=u,i.object=t;}));for(let f=0;f<S$4.length;f++){const t=S$4.data[f];if(e$8(r,t.near)&&e$8(r,t.far))continue;q$2.far=t.far,q$2.near=1/0;const n=M$4(t.object.obb,e,A$1,(n=>{let r=x$4;for(let e=0;e<P$2&&n.length>0;e++){if(0==(t.mask&1<<e))continue;B$3(o[e],n,r);const a=n;n=r,r=a;}for(let t=0;t<n.length;t+=3){o$C(v$5,n.data[t+0],n.data[t+1],n.data[t+2]);const r=z$i(J$e(v$5,v$5,e),a);q$2.near=Math.min(q$2.near,r);}}));0===n&&(q$2.near=0),t$b(r,q$2);}return S$4.length=0,r}const S$4=new n$Z({allocator:t=>t||{near:1/0,far:-1/0,mask:0,object:null},deallocator:t=>(t.object=null,t)}),q$2=n$a(),v$5=n$F(),y$3=n$F(),A$1=new n$Z({deallocator:null}),x$4=new n$Z({deallocator:null});function B$3(t,n,r){r.length=0;const e=n.length-3;F$2(v$5,n,e);const o=R$k(t,v$5);o<=0&&(r.push(v$5[0]),r.push(v$5[1]),r.push(v$5[2]));let a=0,s=o;for(;a<e;a+=3){F$2(y$3,n,a);const e=R$k(t,y$3);if(s*e<0){y$v(v$5,y$3,v$5,e/(e-s)),I$2(r,v$5);}e<=0&&I$2(r,y$3),s=e,r$B(v$5,y$3);}if(s*o<0){F$2(y$3,n,e);y$v(v$5,y$3,v$5,o/(o-s)),I$2(r,v$5);}}function F$2(t,n,r){return o$C(t,n.data[r+0],n.data[r+1],n.data[r+2])}function I$2(t,n){t.push(n[0]),t.push(n[1]),t.push(n[2]);}function M$4(t,e,a,s){w$p(D$1,t.quaternion),J$e(E$2,e,t.center),P$o(E$2,E$2,D$1);const i=8*((E$2[0]<-t.halfSize[0]?-1:E$2[0]>t.halfSize[0]?1:0)+3*(E$2[1]<-t.halfSize[1]?-1:E$2[1]>t.halfSize[1]?1:0)+9*(E$2[2]<-t.halfSize[2]?-1:E$2[2]>t.halfSize[2]?1:0)+13),h=N$4[i];if(0===h)return h;p$_(C$1,t.quaternion),f$H(C$1,C$1,t.halfSize);const p=(n,r)=>{const e=N$4[i+r+1];return o$C(n,((1&e)<<1)-1,(2&e)-1,((4&e)>>1)-1),L$g(n,n,C$1),u$A(n,t.center,n)};return a.length=0,I$2(a,p(G$1,0)),I$2(a,p(H$3,1)),I$2(a,p(E$2,2)),I$2(a,p(J$3,3)),s(a),1===h?h:(a.length=0,I$2(a,G$1),I$2(a,J$3),I$2(a,p(E$2,4)),I$2(a,p(K$3,5)),s(a),2===h||(a.length=0,I$2(a,G$1),I$2(a,K$3),I$2(a,p(E$2,6)),I$2(a,H$3),s(a)),h)}const N$4=(()=>{const t=new Int8Array(216);let n=0;const r=r=>{for(let e=0;e<r.length;e++)t[n+e]=r[e];n+=8;};return r([3,0,6,2,3,1,5,4]),r([2,0,2,3,1,5,4,0]),r([3,1,0,2,3,7,5,4]),r([2,0,1,3,2,6,4,0]),r([1,0,1,3,2,0,0,0]),r([2,1,5,7,3,2,0,0]),r([3,2,0,1,3,7,6,4]),r([2,2,0,1,3,7,6,0]),r([3,3,0,1,5,7,6,2]),r([2,0,1,5,4,6,2,0]),r([1,0,1,5,4,0,0,0]),r([2,1,3,7,5,4,0,0]),r([1,0,2,6,4,0,0,0]),r([0,0,0,0,0,0,0,0]),r([1,1,3,7,5,0,0,0]),r([2,2,3,7,6,4,0,0]),r([1,2,3,7,6,0,0,0]),r([2,3,1,5,7,6,2,0]),r([3,4,0,1,5,7,6,2]),r([2,5,7,6,4,0,1,0]),r([3,5,0,1,3,7,6,4]),r([2,4,5,7,6,2,0,0]),r([1,4,5,7,6,0,0,0]),r([2,5,1,3,7,6,4,0]),r([3,6,0,2,3,7,5,4]),r([2,6,2,3,7,5,4,0]),r([3,7,6,2,3,1,5,4]),t})(),P$2=4;function R$3(t,n){let r=0;for(let e=0;e<P$2;e++){const o=J$4(t,n[e]);if(o>0)return -1;0===o&&(r|=1<<e);}return r}const C$1=e$A(),D$1=e$S(),E$2=n$F(),G$1=n$F(),H$3=n$F(),J$3=n$F(),K$3=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class e$7{constructor(t){this._objects=t;}submit(t,e){this._objects.preSubmit(e),this._objects.visibleObjects.forAll((e=>e.renderable.material.submit(t,e)));}queryShadowCasterDepthRange(e){return this._objects.visibleObjects.length?z$2(e,this._objects.visibleObjects):null}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function e$6(e){const r=A$k().vec3f("position");return e.normals&&r.vec2i16("normalCompressed",{glNormalized:!0}),1===e.textureCoordinates?r.vec2f("uv0"):2===e.textureCoordinates&&(r.vec2f("uv0"),r.vec4u16("uvRegion",{glNormalized:!0})),e.colors&&r.vec4u8("color",{glNormalized:!0}),r.alignTo(4)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function r$7(r,n){1===n.componentData&&(r.vertex.uniforms.add("uComponentColorTex","sampler2D"),r.vertex.uniforms.add("uComponentColorTexInvDim","vec2"),r.attributes.add("componentIndex","float"),r.varyings.add("vExternalColorMixMode","mediump float"),r.varyings.add("vExternalColor","vec4"),r.include(l$U),r.vertex.code.add(t$J`vec4 _readComponentColor() {
float normalizedIndex = (componentIndex + 0.5) * uComponentColorTexInvDim.x;
vec2 indexCoord = vec2(
mod(normalizedIndex, 1.0),
(floor(normalizedIndex) + 0.5) * uComponentColorTexInvDim.y
);
return texture2D(uComponentColorTex, indexCoord);
}
vec4 forwardExternalColor(out bool castShadows) {
vec4 componentColor = _readComponentColor() * 255.0;
float shadowFlag = mod(componentColor.b * 255.0, 2.0);
componentColor.b -= shadowFlag;
castShadows = shadowFlag >= 1.0;
int decodedColorMixMode;
vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451;
vExternalColorMixMode = float(decodedColorMixMode) + 0.5;
return vExternalColor;
}`),r.fragment.code.add(t$J`void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
externalColor = vExternalColor;
externalColorMixMode = int(vExternalColorMixMode);
}`)),0===n.componentData&&(r.vertex.uniforms.add("uExternalColor","vec4"),r.fragment.uniforms.add("uExternalColorMixMode","int"),r.varyings.add("vExternalColor","vec4"),r.vertex.code.add(t$J`vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = uExternalColor;
castShadows = true;
return uExternalColor;
}`),r.fragment.code.add(t$J`void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
externalColor = vExternalColor;
externalColorMixMode = uExternalColorMixMode;
}`));}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function c$a(c,i){const a=c.vertex;switch(a.code.add(t$J`#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)`),i.vertexDiscardMode){case 0:a.code.add(t$J`#define vertexDiscardByOpacity(_opacity_) {}`);break;case 2:a.code.add(t$J`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case 1:a.code.add(t$J`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function a$7(a,t){a.include(r$12,t),a.fragment.include(i$15);const l=a.fragment;l.uniforms.add("uBaseColor","vec4"),l.uniforms.add("uObjectOpacity","float"),t.attributeColor?l.code.add(t$J`vec3 _baseColor() {
return uBaseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return uBaseColor.a * vColor.a;
}`):l.code.add(t$J`vec3 _baseColor() {
return uBaseColor.rgb;
}
float _baseOpacity() {
return uBaseColor.a;
}`),l.code.add(t$J`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = uObjectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function d$9(d,a){const i=d.fragment;0===a.doubleSidedMode?i.code.add(t$J`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`):1===a.doubleSidedMode?(d.include(d$P,a),i.uniforms.add("uTransform_ViewFromCameraLocal_T","vec3"),i.code.add(t$J`vec3 _adjustDoublesided(vec3 normal) {
vec3 viewDir = vPositionWorldCameraRelative + uTransform_ViewFromCameraLocal_T;
return dot(normal, viewDir) > 0.0 ? -normal : normal;
}`)):2===a.doubleSidedMode&&i.code.add(t$J`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`),0===a.normalType||1===a.normalType?(d.include(l$V,a),i.code.add(t$J`vec3 shadingNormalWorld() {
return _adjustDoublesided(normalize(vNormalWorld));
}
vec3 shadingNormal_view() {
vec3 normal = normalize(vNormalView);
return gl_FrontFacing ? normal : -normal;
}`)):3===a.normalType?(d.extensions.add("GL_OES_standard_derivatives"),d.include(d$P,a),i.code.add(t$J`vec3 shadingNormalWorld() {
return normalize(cross(
dFdx(vPositionWorldCameraRelative),
dFdy(vPositionWorldCameraRelative)
));
}
vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));
}`)):2===a.normalType&&(1===a.viewingMode?(d.include(d$P,a),i.code.add(t$J`vec3 shadingNormalWorld() {
return normalize(positionWorld());
}`)):2===a.viewingMode&&i.code.add(t$J`vec3 shadingNormalWorld() {
return vec3(0.0, 0.0, 1.0);
}`),d.extensions.add("GL_OES_standard_derivatives"),i.code.add(t$J`vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;
}`));}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function t$a(t,u){const a=t.fragment;u.baseColorTexture?(t.include(u$Q,u),a.uniforms.add("uBaseColorTexture","sampler2D"),a.uniforms.add("uBaseColorTextureSize","vec2"),2===u.attributeTextureCoordinates?(t.include(t$10),a.code.add(t$J`vec4 readBaseColorTexture() {
return textureAtlasLookup(
uBaseColorTexture,
uBaseColorTextureSize,
vuv0,
vuvRegion
);
}`)):a.code.add(t$J`vec4 readBaseColorTexture() {
return texture2D(uBaseColorTexture, vuv0);
}`)):a.code.add(t$J`vec4 readBaseColorTexture() { return vec4(1.0); }`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const S$3=new Map([["position",0],["normal",1],["normalCompressed",1],["color",2],["uv0",3],["uvRegion",4],["componentIndex",5]]);function j$3(S){const j=new n$N;j.include(d$P,S),j.include(l$V,S),j.include(r$12,S),j.include(t$I,S),j.include(a$18,S),j.include(r$7,S),j.include(r$13,S),j.include(c$10,S),j.include(t$a,S),j.include(c$a,S),j.fragment.uniforms.add("view","mat4"),1!==S.pbrMode&&2!==S.pbrMode||(j.include(r$14,S),S.hasNormalTexture&&j.include(n$19,S)),3===S.output&&1===S.componentData?j.vertex.code.add(t$J`#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`):j.vertex.code.add(t$J`#define discardShadows(castShadows) {}`);const N=S.overlayEnabled&&0===S.output&&4===S.pbrMode;return S.overlayEnabled&&(j.include(a$b,S),1===S.viewingMode?j.vertex.code.add(t$J`
      const float invEllipsoidRadius = ${t$J.float(1/(1===S.ellipsoidMode?s$B.radius:2===S.ellipsoidMode?t$11.radius:e$W.radius))};
      vec2 projectOverlay(vec3 pos) {
        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);
      }
      `):j.vertex.code.add(t$J`vec2 projectOverlay(vec3 pos) { return pos.xy; }`)),N&&(j.varyings.add("tbnTangent","vec3"),j.varyings.add("tbnBiTangent","vec3"),j.varyings.add("groundNormal","vec3"),j.varyings.add("positionView","vec3")),j.vertex.code.add(t$J`
    void main() {
      bool castShadows;
      vec4 externalColor = forwardExternalColor(castShadows);
      discardShadows(castShadows);

      vertexDiscardByOpacity(externalColor.a);

      if (externalColor.a < ${t$J.float(o$V)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
      forwardPosition();
      forwardNormal();
      ${N?t$J`
        positionView = position_view();
        ${1===S.viewingMode?t$J`
        groundNormal = normalize(positionWorld());
        tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
        tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:t$J`
        groundNormal = vec3(0.0, 0.0, 1.0);
        tbnTangent = vec3(1.0, 0.0, 0.0);
        tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`}
        `:""}

      ${S.overlayEnabled?t$J`setOverlayVTC(projectOverlay(position));`:""}
      forwardTextureCoordinates();
      forwardVertexColor();
      forwardLinearDepth(); // depends on forwardPosition()
    }
  `),7===S.output&&(j.fragment.include(a$U),S.multipassTerrainEnabled&&j.include(r$15,S),j.include(a$7,S),j.fragment.code.add(t$J`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${S.multipassTerrainEnabled?t$J`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${S.overlayEnabled?t$J`
        vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
        vec4 overlayColor = overlayOpacity * overlayColorOpaque;
        materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        gl_FragColor = vec4(materialColor.a);
      }
    `)),0===S.output&&(j.fragment.include(a$U),S.multipassTerrainEnabled&&j.include(r$15,S),j.include(a$7,S),j.include(d$9,S),j.include(l$O,S),N&&j.fragment.uniforms.add("ovNormalTex","sampler2D"),S.receiveShadows?(j.include(t$12,S),j.fragment.code.add(t$J`float evaluateShadow() {
return readShadowMap(vPositionWorldCameraRelative, linearDepth);
}`)):j.fragment.code.add(t$J`float evaluateShadow() { return 0.0; }`),j.fragment.code.add(t$J`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${S.multipassTerrainEnabled?t$J`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${S.overlayEnabled?t$J`
        vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
        vec4 overlayColor = overlayOpacity * overlayColorOpaque;
        materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}
    `),1===S.pbrMode||2===S.pbrMode?(j.fragment.code.add(t$J`
        ${1===S.pbrMode?t$J`
        applyPBRFactors();
        if (int(externalColorMixMode) == 3) {
          mrr = vec3(0.0, 0.6, 0.2);
        }`:""}
        vec3 normalVertex = shadingNormalWorld();
        float additionalIrradiance = 0.02 * lightingMainIntensity[2];
      `),S.hasNormalTexture?j.fragment.code.add(t$J`mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);
vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`):j.fragment.code.add(t$J`vec3 shadingNormal = normalVertex;`),j.fragment.code.add(t$J`${1===S.viewingMode?t$J`vec3 normalGround = normalize(positionWorld());`:t$J`vec3 normalGround = vec3(0.0, 0.0, 1.0);`}
      `),j.fragment.code.add(t$J`vec3 viewDir = normalize(vPositionWorldCameraRelative);
float ssao = 1.0 - occlusion * (1.0 - evaluateAmbientOcclusion());
vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);`)):(S.receiveShadows?j.fragment.code.add(t$J`float shadow = evaluateShadow();`):1===S.viewingMode?j.fragment.code.add(t$J`float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());
float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);`):j.fragment.code.add(t$J`float shadow = 0.0;`),j.fragment.code.add(t$J`
      float ambientOcclusion = evaluateAmbientOcclusion();
      // At global scale we create some additional ambient light based on the main light to simulate global illumination
      vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());
      vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);
      ${N?t$J`
          vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
          float waterNormalLength = length(overlayWaterMask);
          if (waterNormalLength > 0.95) {
            mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
            vec4 waterOverlayColor = vec4(overlayColorOpaque.xyz, overlayColor.w);
            vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, positionView);
            vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
            // un-gamma the ground color to mix in linear space
            shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
          }`:""}
      `)),j.fragment.code.add(t$J`
        gl_FragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);
        ${S.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),1!==S.output&&3!==S.output||(j.include(e$R,S),j.fragment.code.add(t$J`void main() {
discardBySlice(vPositionWorldCameraRelative);
vec4 textureColor = readBaseColorTexture();
discardOrAdjustAlpha(textureColor);
outputDepth(linearDepth);
}`)),2===S.output&&(j.include(d$9,S),j.fragment.code.add(t$J`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        // note: the alpha component needs to be 1.0 in order for this material
        // to influence ambient occlusion, see the ssao fragment shader
        float alpha = ${2===S.normalType?"0.0":"1.0"};
        gl_FragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);
      }
    `)),4===S.output&&(j.include(r$_),j.fragment.code.add(t$J`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${S.overlayEnabled?t$J`
        vec4 overlayColor = getCombinedOverlayColor();

        if (overlayColor.a == 0.0) {
          gl_FragColor = vec4(0.0);
          return;
        }`:""}

        outputHighlight();
      }
    `)),j}const N$3=Object.freeze({__proto__:null,attributeLocations:S$3,build:j$3});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class O extends t$L{bindPass(e){const r=this.program;d$P.bindViewProjTransform(r,e.viewTransform),r$$(this.program,this.configuration,e.slicePlane),0===e.identifier&&(void 0!==e.ssrParams&&i$11(this.program,e.ssrParams),r.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",e.transformNormal_ViewFromGlobal),2===e.subPass&&r.setUniform2fv("cameraNearFar",e.cameraNearFar),0===e.subPass&&e.lighting.setUniforms(this.program,e.integratedMesh)),1===e.identifier&&this.program.setUniform2fv("cameraNearFar",e.cameraNearFar);}bindMaterial(e,o){this._material=e;const t=this.program;t.setUniform4fv("uBaseColor",e.baseColor),t.setUniform1f("uObjectOpacity",e.objectOpacity),t.setUniform1f("textureAlphaCutoff",e.alphaCutoff),1===e.componentParameters.type?e.componentParameters.texture.bind(t,"uComponentColorTex","uComponentColorTexInvDim"):(t.setUniform4fv("uExternalColor",e.componentParameters.externalColor),t.setUniform1i("uExternalColorMixMode",e.componentParameters.externalColorMixMode)),r$A(e.baseColorTexture)&&e.baseColorTexture.bind(t,"uBaseColorTexture","uBaseColorTextureSize"),0!==this.configuration.output&&7!==this.configuration.output||(a$19(this.program,e,this.configuration.isSchematic),r$A(e.metallicRoughnessTexture)&&e.metallicRoughnessTexture.bind(t,"texMetallicRoughness","texMetallicRoughnessSize"),r$A(e.emissionTexture)&&e.emissionTexture.bind(t,"texEmission","texEmissionSize"),r$A(e.occlusionTexture)&&e.occlusionTexture.bind(t,"texOcclusion","texOcclusionSize"),r$A(e.normalTexture)&&e.normalTexture.bind(t,"normalTexture","normalTextureSize")),e.isIntegratedMesh&&(0===o.identifier&&0===o.subPass?(t.bindTexture(e.overlayColor,"ovColorTex"),t.bindTexture(e.overlayNormal,"ovNormalTex")):2===o.identifier&&t.bindTexture(e.overlayHighlight,"ovColorTex"),t.setUniform1f("overlayOpacity",1)),2===o.identifier&&g$B(this.program,o),0===o.identifier&&0===o.subPass&&(o.ambientOcclusionEnabled&&o.bindAmbientOcclusion(t),o.shadowsEnabled&&o.bindShadowMap(t)),0!==o.identifier||0!==o.subPass&&1!==o.subPass||!o.multipassTerrainParams.multipassTerrainEnabled||(this.program.setUniform2fv("cameraNearFar",o.cameraNearFar),t.setUniform2fv("inverseViewport",o.inverseViewport),o.multipassTerrainParams.terrainLinearDepthTexture&&t.bindTexture(o.multipassTerrainParams.terrainLinearDepthTexture,"terrainDepthTexture"));}bindDraw(e){if(d$P.bindModelTransform(this.program,e),this.program.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",e.transformNormal_GlobalFromModel),this.program.rebindTextures(),r$A(this._material)&&this._material.isIntegratedMesh){const r=this._material.overlayTexScale,o=this._material.overlayTexOffset;this.program.setUniform4fv("overlayTexOffset",[e.toMapSpace[0]*r[0]+o[0],e.toMapSpace[1]*r[1]+o[1],e.toMapSpace[0]*r[2]+o[2],e.toMapSpace[1]*r[3]+o[3]]),this.program.setUniform4fv("overlayTexScale",[e.toMapSpace[2]*r[0],e.toMapSpace[3]*r[1],e.toMapSpace[2]*r[2],e.toMapSpace[3]*r[3]]);}}initializeProgram(e){const r=O.shader.get(),o=this.configuration,t=r.build({multipassTerrainEnabled:o.multipassTerrainEnabled,cullAboveGround:o.cullAboveGround,OITEnabled:0===o.transparencyPassType,output:o.output,normalType:0===o.integratedMeshMode?o.hasNormals?1:3:2,attributeColor:o.hasVertexColors,attributeTextureCoordinates:o.vertexTextureCoordinates,componentData:o.componentData,alphaDiscardMode:o.alphaDiscardMode,baseColorTexture:o.baseColorTexture,doubleSidedMode:o.doubleSidedMode,receiveAmbientOcclusion:o.receiveAmbientOcclusion,receiveShadows:o.receiveShadows,slicePlaneEnabled:o.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,viewingMode:e.viewingMode,vertexDiscardMode:o.vertexDiscardMode,pbrMode:3===o.integratedMeshMode?4:o.usePBR?o.isSchematic?2:1:0,hasMetalnessAndRoughnessTexture:o.hasMetalnessAndRoughnessTexture,hasEmissionTexture:o.hasEmissionTexture,hasOcclusionTexture:o.hasOcclusionTexture,hasNormalTexture:o.hasNormalTexture,vertexTangents:!1,supportsTextureAtlas:!0,doublePrecisionRequiresObfuscation:r$16(e.rctx),overlayEnabled:2===o.integratedMeshMode||3===o.integratedMeshMode,ssrEnabled:o.ssrEnabled,highStepCount:!1,ellipsoidMode:o.ellipsoidMode});return new n$O(e.rctx,t,r.attributeLocations)}setPipelineState(e){const r=this.configuration,o=0!==r.integratedMeshMode,t=3===e,s=2===e;return g$v({blending:0!==r.output&&7!==r.output||!r.blendingEnabled?null:t?u$R:c$12(e),culling:s$V(r.cullFace),depthTest:{func:a$1a(e)},depthWrite:t||s?l$P:null,colorWrite:r$J,stencilWrite:o||r.sceneHasOcludees?f$I:null,stencilTest:o?o$W(1):r.sceneHasOcludees?c$13:null,polygonOffset:t||s?r.polygonOffsetEnabled?{factor:2,units:2}:null:i$16})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}O.shader=new t$M(N$3,(()=>import('./ComponentShader.glsl-a5d157ae.js')));class j$2 extends d$P.ModelTransform{constructor(){super(...arguments),this.transformNormal_GlobalFromModel=e$A(),this.toMapSpace=n$P();}}class N$2 extends t$K{constructor(){super(...arguments),this.output=0,this.hasVertexColors=!1,this.hasNormals=!1,this.vertexTextureCoordinates=0,this.componentData=0,this.slicePlaneEnabled=!1,this.cullFace=2,this.baseColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.vertexDiscardMode=0,this.doubleSidedMode=2,this.blendingEnabled=!0,this.alphaDiscardMode=1,this.integratedMeshMode=0,this.ssrEnabled=!1,this.polygonOffsetEnabled=!1,this.usePBR=!1,this.isSchematic=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.ellipsoidMode=1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1;}}e$x([e$D({count:8})],N$2.prototype,"output",void 0),e$x([e$D()],N$2.prototype,"hasVertexColors",void 0),e$x([e$D()],N$2.prototype,"hasNormals",void 0),e$x([e$D({count:3})],N$2.prototype,"vertexTextureCoordinates",void 0),e$x([e$D({count:2})],N$2.prototype,"componentData",void 0),e$x([e$D()],N$2.prototype,"slicePlaneEnabled",void 0),e$x([e$D({count:3})],N$2.prototype,"cullFace",void 0),e$x([e$D()],N$2.prototype,"baseColorTexture",void 0),e$x([e$D()],N$2.prototype,"receiveAmbientOcclusion",void 0),e$x([e$D()],N$2.prototype,"receiveShadows",void 0),e$x([e$D({count:3})],N$2.prototype,"vertexDiscardMode",void 0),e$x([e$D({count:3})],N$2.prototype,"doubleSidedMode",void 0),e$x([e$D()],N$2.prototype,"blendingEnabled",void 0),e$x([e$D({count:4})],N$2.prototype,"alphaDiscardMode",void 0),e$x([e$D({count:4})],N$2.prototype,"integratedMeshMode",void 0),e$x([e$D()],N$2.prototype,"ssrEnabled",void 0),e$x([e$D()],N$2.prototype,"polygonOffsetEnabled",void 0),e$x([e$D()],N$2.prototype,"usePBR",void 0),e$x([e$D()],N$2.prototype,"isSchematic",void 0),e$x([e$D()],N$2.prototype,"hasMetalnessAndRoughnessTexture",void 0),e$x([e$D()],N$2.prototype,"hasEmissionTexture",void 0),e$x([e$D()],N$2.prototype,"hasOcclusionTexture",void 0),e$x([e$D()],N$2.prototype,"hasNormalTexture",void 0),e$x([e$D()],N$2.prototype,"sceneHasOcludees",void 0),e$x([e$D({count:4})],N$2.prototype,"transparencyPassType",void 0),e$x([e$D({count:4})],N$2.prototype,"ellipsoidMode",void 0),e$x([e$D()],N$2.prototype,"multipassTerrainEnabled",void 0),e$x([e$D()],N$2.prototype,"cullAboveGround",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class t$9{constructor(){this._dirty=!0;}_setDirty(){this._dirty=!0;}_setClean(){if(this._dirty=!1,null!=this._parameterBlocks)for(const t of this._parameterBlocks)this[t]._setClean();}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(null==this._parameterBlocks)return !1;for(const t of this._parameterBlocks)if(this[t].dirty)return !0;return !1}}class r$6{constructor(){this._dirty=!0;}_setDirty(){this._dirty=!0;}_setClean(){this._dirty=!1;}get dirty(){return this._dirty}}function e$5(t={}){return (r,e)=>{var s;const i=null!=(s=r._parameterCount)?s:0;if(r._parameterCount=i+1,t.vectorOps){const s=t.vectorOps;Object.defineProperty(r,e,{get(){return this[i]},set(t){const r=this[i];if(null==r)this[i]=t;else {if(s.equals(r,t))return;s.copy(r,t);}this._setDirty();}});}else Object.defineProperty(r,e,{get(){return this[i]},set(r){this[i]!==r&&(t.dispose&&this[i]&&this[i].dispose(),this[i]=r,this._setDirty());}});}}function s$6(){return (t,r)=>{var e;const s=null!=(e=t._parameterCount)?e:0;t._parameterCount=s+1,t._parameterBlocks=t._parameterBlocks||[],t._parameterBlocks.push(s),Object.defineProperty(t,r,{get(){return this[s]},set(t){this[s]!==t&&(this[s]=t,this._setDirty());}});}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class x$3 extends t$9{constructor(){super(...arguments),this.baseColor=r$V(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=t$P(1,1,.5),this.emissiveFactor=t$P(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.overlayTexOffset=r$L(-1,-1,-1,-1),this.overlayTexScale=r$L(0,0,0,0),this.overlayColor=null,this.overlayHighlight=null,this.overlayNormal=null,this.objectOpacity=1,this.commonMaterialParameters=new g$2,this.componentParameters=new f$4,this.alphaCutoff=d$Q,this.alphaDiscardMode=1,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=1,this.sceneHasOcludees=!1,this._techniqueConfig=new N$2;}dispose(){this._technique=h$w(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null;}getTechnique(e,t,r){const o=this._techniqueConfig;if(o.hasVertexColors=r.colors,o.hasNormals=r.normals,o.vertexTextureCoordinates=r.textureCoordinates,o.usePBR=this.usePBR,o.hasMetalnessAndRoughnessTexture=r$A(this.metallicRoughnessTexture),o.hasEmissionTexture=r$A(this.emissionTexture),o.hasOcclusionTexture=r$A(this.occlusionTexture),o.hasNormalTexture=r$A(this.normalTexture),o.transparencyPassType=0===t.identifier&&null!=t.transparencyPassType?t.transparencyPassType:3,o.multipassTerrainEnabled=0===t.identifier&&null!=t.multipassTerrainParams&&t.multipassTerrainParams.multipassTerrainEnabled,o.cullAboveGround=0===t.identifier&&null!=t.multipassTerrainParams&&t.multipassTerrainParams.cullAboveGround,o.ellipsoidMode=this.ellipsoidMode,this.dirty){o.componentData=this.componentParameters.type,o.cullFace=this.commonMaterialParameters.cullFace,o.doubleSidedMode=this.commonMaterialParameters.doubleSided?1:0,o.baseColorTexture=r$A(this.baseColorTexture),o.isSchematic=this.hasParametersFromSource&&!r$A(this.baseColorTexture);const e=this._computeWhichMaterialPass();o.blendingEnabled=1===e||2===e,o.alphaDiscardMode=this.alphaDiscardMode,o.integratedMeshMode=this.isIntegratedMesh?this.overlayColor?this.overlayNormal?3:2:1:0,o.polygonOffsetEnabled=this.polygonOffsetEnabled,this._setClean();}return o.slicePlaneEnabled=t.slicePlaneEnabled&&this.commonMaterialParameters.slicePlaneEnabled,1===t.identifier?(o.output=3,o.vertexDiscardMode=0):2===t.identifier?(o.output=4,o.vertexDiscardMode=0):(2===this._computeWhichMaterialPass()?o.vertexDiscardMode=t.transparent?2:1:o.vertexDiscardMode=0,o.output=T$3(t.subPass),1===t.subPass&&(o.sceneHasOcludees=t.sceneHasOcludees),0===t.subPass?(o.receiveAmbientOcclusion=t.ambientOcclusionEnabled,o.sceneHasOcludees=t.sceneHasOcludees,o.receiveShadows=t.shadowsEnabled,o.ssrEnabled=t.ssrParams.ssrEnabled):(o.receiveAmbientOcclusion=!1,o.receiveShadows=!1)),this._technique=e.releaseAndAcquire(O,o,this._technique),this._technique}submit(e,t){if(0===this.objectOpacity)return;const r=t.renderable.geometry,o=t.components,a=t.renderable.drawParameters,i=t.renderable.meta.cameraDepthSquared,l=o.geometryRanges,n=o.highlightRanges,h=o.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case 0:e.materialOpaque.submitDraw(this,r,l,a,i);break;case 1:e.materialTransparent.submitDraw(this,r,l,a,i);break;case 2:e.materialOpaque.submitDraw(this,r,l,a,i),e.materialTransparent.submitDraw(this,r,l,a,i);break;case 3:e.materialIntegratedMesh.submitDraw(this,r,l,a,i),this.overlayHighlight&&e.highlightIntegratedMesh.submitDraw(this,r,l,a,i);}const c=2!==this.componentParameters.castShadows;c&&e.shadowMap.submitDraw(this,r,l,a,i),r$A(n)&&(e.highlight.submitDraw(this,r,n,a,i),c&&e.highlightShadowMap.submitDraw(this,r,n,a,i)),c&&r$A(h)&&e.defaultShadowMap.submitDraw(this,r,h,a,i);}get attributeLocations(){return S$3}_computeWhichMaterialPass(){return this.isIntegratedMesh?3:this.objectOpacity<1?1:0===this.componentParameters.opaqueOverride?0:this.baseColor[3]<1||0===this.alphaDiscardMode||3===this.alphaDiscardMode?1:2===this.componentParameters.transparent?0:0===this.componentParameters.transparent?1:2}}e$x([e$5({vectorOps:I$m})],x$3.prototype,"baseColor",void 0),e$x([e$5()],x$3.prototype,"usePBR",void 0),e$x([e$5()],x$3.prototype,"hasParametersFromSource",void 0),e$x([e$5({vectorOps:T$j})],x$3.prototype,"mrrFactors",void 0),e$x([e$5({vectorOps:T$j})],x$3.prototype,"emissiveFactor",void 0),e$x([e$5({dispose:!0})],x$3.prototype,"baseColorTexture",void 0),e$x([e$5({dispose:!0})],x$3.prototype,"metallicRoughnessTexture",void 0),e$x([e$5({dispose:!0})],x$3.prototype,"emissionTexture",void 0),e$x([e$5({dispose:!0})],x$3.prototype,"occlusionTexture",void 0),e$x([e$5({dispose:!0})],x$3.prototype,"normalTexture",void 0),e$x([e$5({vectorOps:{equals:D$k,copy:a$14}})],x$3.prototype,"overlayTexOffset",void 0),e$x([e$5({vectorOps:{equals:D$k,copy:a$14}})],x$3.prototype,"overlayTexScale",void 0),e$x([e$5()],x$3.prototype,"overlayColor",void 0),e$x([e$5()],x$3.prototype,"overlayHighlight",void 0),e$x([e$5()],x$3.prototype,"overlayNormal",void 0),e$x([e$5()],x$3.prototype,"objectOpacity",void 0),e$x([s$6()],x$3.prototype,"commonMaterialParameters",void 0),e$x([s$6()],x$3.prototype,"componentParameters",void 0),e$x([e$5()],x$3.prototype,"alphaCutoff",void 0),e$x([e$5()],x$3.prototype,"alphaDiscardMode",void 0),e$x([e$5()],x$3.prototype,"isIntegratedMesh",void 0),e$x([e$5()],x$3.prototype,"polygonOffsetEnabled",void 0),e$x([e$5()],x$3.prototype,"ellipsoidMode",void 0),e$x([e$5()],x$3.prototype,"sceneHasOcludees",void 0);class g$2 extends r$6{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=2,this.slicePlaneEnabled=!0;}}e$x([e$5()],g$2.prototype,"doubleSided",void 0),e$x([e$5()],g$2.prototype,"cullFace",void 0),e$x([e$5()],g$2.prototype,"slicePlaneEnabled",void 0);class f$4 extends r$6{constructor(){super(...arguments),this.externalColor=r$V(1,1,1,1),this.externalColorMixMode=1,this.castShadows=0;}get transparent(){return this.externalColor[3]<1?0:2}get opaqueOverride(){return 3===this.externalColorMixMode&&1===this.externalColor[3]?0:2}get visible(){return this.externalColor[3]>0?0:2}get type(){return 0}}e$x([e$5({vectorOps:I$m})],f$4.prototype,"externalColor",void 0),e$x([e$5()],f$4.prototype,"externalColorMixMode",void 0),e$x([e$5()],f$4.prototype,"castShadows",void 0);class M$3 extends r$6{constructor(){super(...arguments),this.texture=null,this.transparent=2,this.opaqueOverride=2,this.castShadows=2;}get type(){return 1}}function T$3(e){switch(e){case 0:return 0;case 1:return 7;case 2:return 1;case 3:return 2}}e$x([e$5()],M$3.prototype,"texture",void 0),e$x([e$5()],M$3.prototype,"transparent",void 0),e$x([e$5()],M$3.prototype,"opaqueOverride",void 0),e$x([e$5()],M$3.prototype,"castShadows",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class c$9{constructor(s){this._low=n$1a(),this._high=n$1a(),s&&this.set(s);}get low(){return this._low}get high(){return this._high}set(h){const e=this._low,i=this._high;r$B(e,h),J$e(i,h,e);}setElements(s,t,e){o$C(n$9,s,t,e),this.set(n$9);}get(s){return u$A(s,this._low,this._high)}getLowScaled(s){return d$z(s,this._low,1)}}const n$9=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class e$4{constructor(e){this.maxCount=e,this._nextIndex=0,this.recycledIndices=[];}get activeCount(){return this._nextIndex-this.recycledIndices.length}get availableCount(){return this.recycledIndices.length+this.maxCount-this._nextIndex}acquire(){return this.recycledIndices.length>0?this.recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this.recycledIndices.push(e);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class i$8{constructor(i,s=1){this.rctx=i,this.fieldCount=s,this.textureWidth=4096,this.dirty=!0,this.texture=new o$G(this.rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:this.textureWidth,height:1,flipped:!1}),this.data=new x$x(new ArrayBuffer(4*this.textureWidth));}dispose(){this.texture.dispose(),this.texture=void 0,this.data=void 0;}setData(t,e,i,s,r,h){const d=t*this.fieldCount+e;this.dirty=!0,this.data.set(d,0,i),this.data.set(d,1,s),this.data.set(d,2,r),this.data.set(d,3,h);}setDataElement(t,e,i,s){const r=t*this.fieldCount+e;this.dirty=!0,this.data.set(r,i,s);}resizeToFit(e){const i=e*this.fieldCount;if(i>=this.data.count){const e=Math.ceil((i+1)/this.textureWidth)*this.textureWidth,s=new x$x(new ArrayBuffer(4*e));s.typedBuffer.set(this.data.typedBuffer),this.data=s;}}updateTexture(){if(!this.dirty)return;const t=this.texture.descriptor.width,e=this.texture.descriptor.height;this.data.count>t*e&&this.texture.resize(t,this.data.count/t),this.texture.setData(this.data.typedBuffer),this.dirty=!1;}bind(t,e,i){t.bindTexture(this.texture,e),t.setUniform2f(i,1/this.texture.descriptor.width,1/this.texture.descriptor.height);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const r$5=65536;class i$7{constructor(i,a=1){this.textureBuffer=new i$8(i,a),this.indexManager=new e$4(r$5);}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0;}get availableCount(){return this.indexManager.availableCount}get activeCount(){return this.indexManager.activeCount}acquireIndex(){const e=this.indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this.indexManager.release(e);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class r$4{constructor(t,e=1){this.rctx=t,this.fieldCount=e,this.buffers=[];}garbageCollect(){this.buffers=this.buffers.filter((t=>0!==t.activeCount||(t.dispose(),!1)));}destroy(){this.buffers.forEach((t=>t.dispose())),this.buffers=[];}getBuffer(r){for(const t of this.buffers)if(t.availableCount>=r)return t;if(r>r$5)return null;const s=new i$7(this.rctx,this.fieldCount);return this.buffers.push(s),s}updateTextures(){for(const t of this.buffers)t.textureBuffer.updateTexture();}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const F$1=s$y.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class H$2{constructor(e){this._renderManager=e,this._objects=[new n$Z,new n$Z],this._renderSubmit=new e$7(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new r$4(e.rctx);}dispose(){i$13(0===this._objects[0].length&&0===this._objects[1].length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy();}createObject(e){const t=new e$a;return t.toMapSpace=e.toMapSpace.slice(),t.transform=e.transform,t.obb=F$3(e.obb),t.components=new a$9(this._componentBufferManager,e.geometry.componentOffsets),t.renderable=this._createRenderable(e,t.components),t.intersectionGeometry=new u$6(e.geometry.positionData,t.components),this._objects[t.visible].push(t),t}destroyObject(e){const t=e;this._objects[t.visible].removeUnordered(t),t.dispose(),this._notifyDirty();}setObjectVisibility(e,t){const o=e;t!==o.visible&&(this._objects[o.visible].removeUnordered(o),this._objects[t].push(o),o.visible=t,this._notifyDirty());}preSubmit(e){const t=e.camera.eye;this.visibleObjects.forAll((e=>{const o=x$p(t,e.obb.center);e.renderable.meta.cameraDepthSquared=o;}));}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const o=e.renderable.material;t(o),o.dirty&&this._notifyDirty();}setAllComponentVisibilities(e,t){const o=e;o.components.visibility.reset(t),o.components.visibilityDirty(),this._notifyDirty();}forEachVisibleComponent(e,t){return e.components.visibility.forEachComponent(t)}getComponentCount(e){const t=e,o=t.components.visibility.componentCount();return {visible:o,invisible:t.components.count-o}}setComponentData(e,t){const o=e,r=o.renderable.material;if(n$c(t)){const e=o.components,n=e.materialDataBuffer,i=e.materialDataIndices,s={castShadows:!0,pickable:!0,externalColor:n$1d(),externalColorMixMode:1},a=n.textureBuffer,m=new Uint8Array(4),c=new Uint32Array(m.buffer);let l=0,p=0,h=0,f=!1,u=0;for(let o=0;o<e.count;o++)t(o,s),l+=+(s.externalColor[3]<1),p+=+(3===s.externalColorMixMode&&1===s.externalColor[3]),h+=+s.castShadows,o$X(s.externalColor,s.externalColorMixMode,m),m[2]=254&m[2]|+s.castShadows,a.setData(i[o],0,m[0],m[1],m[2],m[3]),f=f||o>0&&u!==c[0],u=c[0],s.pickable!==n$b(e.pickability,o)&&(e.pickability=t$c(e.pickability,e.count,o,s.pickable));f?(r.componentParameters=new M$3,r.componentParameters.castShadows=N$1(h,e.count),r.componentParameters.transparent=N$1(l,e.count),r.componentParameters.opaqueOverride=N$1(p,e.count),r.componentParameters.texture=a,a.updateTexture()):(r.componentParameters=new f$4,r.componentParameters.castShadows=s.castShadows?0:2,r.componentParameters.externalColor=s.externalColor,r.componentParameters.externalColorMixMode=s.externalColorMixMode);}else r.componentParameters=new f$4,r.componentParameters.castShadows=t.castShadows?0:2,r.componentParameters.externalColor=t.externalColor,r.componentParameters.externalColorMixMode=t.externalColorMixMode;this._notifyDirty();}getComponentAabb(e,t,o){return e.intersectionGeometry.getComponentAabb(t,o)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,o){return e.intersectionGeometry.getComponentPositions(t,o)}intersect(e,o,r,n,i,m){const c=e;r$A(i)&&(i.localOrigin=c.transform.position);const l=u$S(J$2,c.transform.rotationScale);J$e(K$2,o,c.transform.position),J$e(Q$2,r,c.transform.position),L$g(K$2,K$2,l),L$g(Q$2,Q$2,l);const p=o$D(J$2,l);return c.intersectionGeometry.intersect(K$2,Q$2,n,p,i,m)}addEdges(e,t,o,r){const n=e,{indices:i,positions:s}=n.intersectionGeometry,a=n.components.offsets;return t.addComponentObject(e,n.transform,{center:n.obb.center,radius:W$2(n.obb)},s,i,a,o,r)}addComponentHighlight(e,t){const r=e.components;t$F(r.highlightCounts)&&(r.highlightCounts=new Uint32Array(r.count+1));0===r.highlightCounts[t]++&&(r.highlightsDirty(),this._notifyDirty()),r.highlightCounts[r.count]++;}removeComponentHighlight(e,t){const r=e.components;if(t$F(r.highlightCounts))return void F$1.warn("Removing non-existing highlight.");const n=r.highlightCounts[t],i=r.highlightCounts[r.count];if(0!==n){if(n>1)return r.highlightCounts[t]=n-1,void(r.highlightCounts[r.count]=i-1);r.highlightCounts[t]=0,r.highlightsDirty(),this._notifyDirty(),1===i?r.highlightCounts=null:r.highlightCounts[r.count]=i-1;}else F$1.warn("Removing non-existing highlight.");}clearHighlights(e){const o=e.components;r$A(o.highlightCounts)&&(o.highlightCounts=null,o.highlightsDirty(),this._notifyDirty());}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._objects[1]}_createRenderable(e,o){const i=this._renderManager.rctx,c=e.geometry,p=c.vertices.layoutParameters,h=h$y.createVertex(i,35044,c.vertices.data),f=o$I(c.indices,(e=>h$y.createIndex(i,35044,e))),b=t$T(e$6(p)),d=new Uint16Array(c.vertices.count);for(let r=0;r<o.count;r++){const e=o.offsets[r],n=o.offsets[r+1],i=o.materialDataIndices[r];if(r$A(c.indices))for(let t=e;t<n;t++){d[c.indices[t]]=i;}else for(let t=e;t<n;t++)d[t]=i;}const y=h$y.createVertex(i,35044,d.buffer),C=new c$9(e.transform.position),j=r$17(e.transform.rotationScale);u$S(j,j),o$D(j,j);const M=new j$2;r$B(M.worldFromModel_TL,C.low),r$B(M.worldFromModel_TH,C.high),n$1c(M.worldFromModel_RS,e.transform.rotationScale),n$1c(M.transformNormal_GlobalFromModel,j),a$14(M.toMapSpace,e.toMapSpace);const x=new x$3,_=new f$w(i,x.attributeLocations,{data:b,componentIndices:z$1},{data:h,componentIndices:y},e$z(f)),v=new o$c(_,4,p,r$A(f)),S={cameraDepthSquared:.5,gpuMemoryEstimate:h.byteSize+y.byteSize+(r$A(f)?f.byteSize:0)};return new s$7(x,M,v,S)}_notifyDirty(){this._renderManager.notifyDirty();}}const z$1=t$T(A$k().u16("componentIndex"));function N$1(e,t){return e===t?0:0===e?2:1}const J$2=n$1b(),K$2=n$F(),Q$2=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function o$b(o){const t=new n$N;return t.include(o$Y),t.fragment.uniforms.add("tex","sampler2D"),0===o.function&&(o.hasOpacityFactor?(t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(t$J`void main() {
gl_FragColor = texture2D(tex, uv) * opacity;
}`)):t.fragment.code.add(t$J`void main() {
gl_FragColor = texture2D(tex, uv);
}`)),3===o.function&&(t.fragment.uniforms.add("overlayIdx","int"),o.hasOpacityFactor&&t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(t$J`
      void main() {
        vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5+ 0.5, uv.y);
        gl_FragColor = texture2D(tex, overlayUV) ${o.hasOpacityFactor?"* opacity":""};
      }`)),1===o.function&&t.fragment.code.add(t$J`void main() {
gl_FragColor = vec4(1.0 - texture2D(tex, uv).a);
}`),2===o.function&&(t.fragment.uniforms.add("colorTexture","sampler2D"),t.fragment.uniforms.add("alphaTexture","sampler2D"),t.fragment.uniforms.add("frontFaceTexture","sampler2D"),t.fragment.code.add(t$J`void main() {
vec4 srcColor = texture2D(colorTexture, uv);
float srcAlpha = texture2D(alphaTexture, uv).r;
vec4 frontFace = texture2D(frontFaceTexture, uv);
if(srcColor.a <= 1e-5){
discard;
}
gl_FragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
}`)),t}const t$8=Object.freeze({__proto__:null,build:o$b});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class p$6 extends t$L{initializeProgram(o){const r=p$6.shader.get().build(this.configuration);return new n$O(o.rctx,r,o$F)}initializePipeline(){if(1===this.configuration.function)return g$v({colorWrite:{r:!1,g:!0,b:!1,a:!1}});switch(this.configuration.alphaMode){case 0:return g$v({colorWrite:r$J});case 1:return g$v({blending:e$E(770,1,771,771),colorWrite:r$J});default:return g$v({blending:t$O(1,771),colorWrite:r$J})}}}p$6.shader=new t$M(t$8,(()=>import('./Compositing.glsl-cedd457b.js')));class d$8 extends t$K{constructor(){super(...arguments),this.function=0,this.alphaMode=0,this.hasOpacityFactor=!1;}}e$x([e$D({count:4})],d$8.prototype,"function",void 0),e$x([e$D({count:3})],d$8.prototype,"alphaMode",void 0),e$x([e$D()],d$8.prototype,"hasOpacityFactor",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class a$6{constructor(r,t){this._rctx=r,this._techniqueRepository=t;}dispose(){this._vao=i$M(this._vao);}compositeTransparent(r,t,e,o=1){const a=this._rctx;n$8.alphaMode=1,n$8.function=2,n$8.hasOpacityFactor=1!==o;const c=this._techniqueRepository.acquire(p$6,n$8);a.useProgram(c.program),c.bindPipelineState(a),c.program.bindTexture(r,"colorTexture"),c.program.bindTexture(t,"alphaTexture"),c.program.bindTexture(e,"frontFaceTexture");const p=this.ensureVAO();a.bindVAO(p),a.drawArrays(5,0,r$O(p,"geometry")),c.release();}composite(r,t=0,e=1,o=0,a=0){const c=this._rctx;n$8.alphaMode=t,n$8.function=o,n$8.hasOpacityFactor=1!==e;const p=this._techniqueRepository.acquire(p$6,n$8);c.useProgram(p.program),p.bindPipelineState(c),p.program.bindTexture(r,"tex"),n$8.hasOpacityFactor&&p.program.setUniform1f("opacity",e),3===o&&p.program.setUniform1i("overlayIdx",a);const m=this.ensureVAO();c.bindVAO(m),c.drawArrays(5,0,r$O(m,"geometry")),p.release();}ensureVAO(){return t$F(this._vao)&&(this._vao=i$N(this._rctx)),this._vao}}const n$8=new d$8;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const v$4=1e4,j$1=100,R$2=500,B$2=500,C=.1;function M$2(t,r,i){return r$18(r,t)*(i[1]-i[0])+i[0]}function A(e,t,r){if(t.size<v$4)return U$1.compute(e,t);const i=n$a();return r.forAll((t=>{t.isVisible&&t$b(i,S$2(e,t));})),i}function S$2(e,r){if(!r.isVisible)return;const i=n$a(),n=r.getSpatialQueryAccelerator();return r$A(n)?y$2(i,e,n):I$1(i,e,r.objects),i}function y$2(e,t,r){const i=t.eye,n=t.viewForward,s=t.frustum,a=e=>e.isVisible,o=r.objectCount;if(o<R$2)a$8(T$2,t.near,Math.min(e.near,t.far)),r.forEachInDepthRange(i,n,1,T$2,((r,i)=>{P$1(e,t,r),T$2.far=e.near,i.setRange(T$2);}),s,a),a$8(T$2,Math.max(e.far,t.near),t.far),r.forEachInDepthRange(i,n,-1,T$2,((r,i)=>{P$1(e,t,r),T$2.near=e.far,i.setRange(T$2);}),s,a);else {const i=Math.max(Math.min(o,B$2),Math.ceil(o*C)),h=r.findClosest(n,1,s,a,i),f=r.findClosest(n,-1,s,a,i);h&&f&&(V$2(e,t,h.boundingVolumeWorldSpace.bounds),V$2(e,t,f.boundingVolumeWorldSpace.bounds));}}function I$1(e,t,r){N.clear(),r.forAll((e=>{e.isVisible&&0!==e.geometryRecords.length&&N.add(e);})),N.empty||(N.sort(t),a$8(T$2,t.near,Math.min(e.near,t.far)),N.forEachInDepthRange(T$2,1,((r,i)=>{i<e.near&&P$1(e,t,r);})),a$8(T$2,Math.max(e.far,t.near),t.far),N.forEachInDepthRange(T$2,-1,((t,r,i)=>{e.far=Math.max(e.far,i);})));}function P$1(e,t,r){if(!r.isVisible)return;if(!O$o(t.frustum,r.boundingVolumeWorldSpace.bounds))return;const i=r.transformation,s=F;r.geometryRecords.forEach((r=>{e$G(s,i,r.getShaderTransformation());const a=d$R(s);x$2(e,t,r.geometry.boundingInfo,s,a);}));}function x$2(e,t,i,n,s){if(t$F(i))return;const a=t.eye,h=t.viewForward;I$g(k$1,i.center,n);const f=h[0]*(k$1[0]-a[0])+h[1]*(k$1[1]-a[1])+h[2]*(k$1[2]-a[2]);if(k$1[3]=i.radius*s,!(f-k$1[3]>e.near&&f+k$1[3]<e.far)&&O$o(t.frustum,k$1))if(i.radius>j$1&&i.getChildren()){const r=i.getChildren();for(let i=0;i<8;++i)r[i]&&x$2(e,t,r[i],n,s);}else L$2.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,n,i.bbMin,i.bbMax);}function V$2(e,t,r){const i=t.eye,n=t.viewForward,s=(r[0]-i[0])*n[0]+(r[1]-i[1])*n[1]+(r[2]-i[2])*n[2];e.near=Math.min(e.near,s-r[3]),e.far=Math.max(e.far,s+r[3]);}class _$2{constructor(){this._items=new n$Z({allocator:e=>e||{obj:null,distance:0,near:0,far:0},deallocator:e=>(e.obj=null,e.distance=0,e.near=0,e.far=0,e)});}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear();}add(e){this._items.pushNew().obj=e;}sort(e){const t=e.eye,r=e.viewForward;this._items.forAll((e=>{const i=e.obj.boundingVolumeWorldSpace.bounds,n=(i[0]-t[0])*r[0]+(i[1]-t[1])*r[1]+(i[2]-t[2])*r[2];e.distance=n,e.near=n-i[3],e.far=n+i[3];})),this._items.sort(((e,t)=>e.distance-t.distance));}forEachInDepthRange(e,t,r){if(1===t)for(let i=0;i<this._items.length;++i){const t=this._items.data[i];t.far<e.near||t.near>e.far||r(t.obj,t.near,t.far);}else for(let i=this._items.length-1;i>=0;--i){const t=this._items.data[i];t.far<e.near||t.near>e.far||r(t.obj,t.near,t.far);}}}class D{constructor(){this.view=e$y(),this.viewProj=e$y(),this.frustum=b$q(),this.geometries=[],this.near=[],this.far=[],this.nearCandidates=[],this.farCandidates=[],this.range={near:0,far:0},this.looseRange={near:0,far:0};}compute(e,t){this.reset(),n$K(this.view,e.viewMatrix),e$G(this.viewProj,e.projectionMatrix,this.view),S$s(e.frustum,this.frustum);const r=this.view,i=r[2],a=r[6],o=r[10],h=r[14],f=this.range;let c=0;if(t.forEach((e=>{if(!e.instanceParameters.visible)return;if(!e.castShadow)return;let t;e.hasShaderTransformation?(e.computeBoundingSphere(e.getShaderTransformation(),k$1,1),t=k$1):t=e.boundingSphere;const r=i*t[0]+a*t[1]+o*t[2]+h,n=r-t[3],s=r+t[3];this.geometries[c]=e,this.near[c]=-s,this.far[c]=-n,++c;})),0===this.geometries.length)return f;for(let n=0;n<this.geometries.length;++n)this.near[n]>f.far&&(f.far=this.near[n]),this.near[n]>2&&this.far[n]<f.near&&(f.near=this.far[n]);const l=this.looseRange;l.near=Math.max(.5*f.near,2),l.far=2*f.far;let d=0,g=0;for(let n=0;n<this.geometries.length;++n)this.near[n]<f.near&&(this.near[n]>=l.near?f.near=this.near[n]:this.nearCandidates[d++]=n),this.far[n]>f.far&&(this.far[n]<=l.far?f.far=this.far[n]:this.farCandidates[g++]=n);if(0===this.nearCandidates.length&&0===this.farCandidates.length)return f;this.nearCandidates.sort(((e,t)=>this.near[e]<this.near[t]?-1:this.near[e]>this.near[t]?1:0)),this.farCandidates.sort(((e,t)=>this.far[e]<this.far[t]?1:this.far[e]>this.far[t]?-1:0));for(let n=0;n<this.nearCandidates.length;++n){const e=this.nearCandidates[n];if(this.near[e]<f.near){const t=this.geometries[e],r=t.boundingInfo;this.includeNearBoundingInfoRec(r,t.getShaderTransformation());}}for(let n=0;n<this.farCandidates.length;++n){const e=this.farCandidates[n];if(this.far[e]>f.far){const t=this.geometries[e],r=t.boundingInfo;this.includeFarBoundingInfoRec(r,t.getShaderTransformation());}}return f}reset(){this.geometries.length=0,this.near.length=0,this.far.length=0,this.nearCandidates.length=0,this.farCandidates.length=0,this.range.near=Number.MAX_VALUE,this.range.far=-Number.MAX_VALUE;}includeNearBoundingInfoRec(e,t){if(t$F(e))return;const i=e.getCenter();I$g(k$1,i,t);const n=d$R(t),s=k$1[0],a=k$1[1],h=k$1[2],f=e.getBSRadius()*n,c=this.frustum;if(c[0][0]*s+c[0][1]*a+c[0][2]*h+c[0][3]>f||c[1][0]*s+c[1][1]*a+c[1][2]*h+c[1][3]>f||c[2][0]*s+c[2][1]*a+c[2][2]*h+c[2][3]>f||c[3][0]*s+c[3][1]*a+c[3][2]*h+c[3][3]>f)return;const l=this.view[2]*s+this.view[6]*a+this.view[10]*h+this.view[14],u=l+f;if(!(-(l-f)<2||-u>=this.range.near))if(-u>this.looseRange.near)this.range.near=-u;else {if(f>j$1){const r=e.getChildren();if(void 0!==r){for(let e=0;e<8;++e)void 0!==r[e]&&this.includeNearBoundingInfoRec(r[e],t);return}}L$2.unionDepthRangeWithAABB(this.range,this.viewProj,t,e.getBBMin(),e.getBBMax());}}includeFarBoundingInfoRec(e,t){if(t$F(e))return;let i=e.getBSRadius();const n=e.getCenter();I$g(k$1,n,t);const s=d$R(t),a=k$1[0],h=k$1[1],f=k$1[2];i*=s;const c=this.frustum;if(c[0][0]*a+c[0][1]*h+c[0][2]*f+c[0][3]>i||c[1][0]*a+c[1][1]*h+c[1][2]*f+c[1][3]>i||c[2][0]*a+c[2][1]*h+c[2][2]*f+c[2][3]>i||c[3][0]*a+c[3][1]*h+c[3][2]*f+c[3][3]>i)return;const l=this.view[2]*a+this.view[6]*h+this.view[10]*f+this.view[14]-i;if(!(-l<=this.range.far))if(-l<this.looseRange.far)this.range.far=-l;else {if(i>j$1){const r=e.getChildren();if(void 0!==r){for(let e=0;e<8;++e)void 0!==r[e]&&this.includeFarBoundingInfoRec(r[e],t);return}}L$2.unionDepthRangeWithAABB(this.range,this.viewProj,t,e.getBBMin(),e.getBBMax());}}}class E$1{constructor(){this.modelViewProj=e$y(),this.clipPosition=[n$P(),n$P(),n$P(),n$P(),n$P(),n$P(),n$P(),n$P()];}unionDepthRangeWithAABB(e,t,r,i,s){const a=this.modelViewProj;e$G(a,t,r);let o=!1;for(let n=0;n<8;++n){const e=this.clipPosition[n],t=0===n||3===n||4===n||7===n?i[0]:s[0],r=0===n||1===n||4===n||5===n?i[1]:s[1],o=n<4?i[2]:s[2];e[0]=a[0]*t+a[4]*r+a[8]*o+a[12],e[1]=a[1]*t+a[5]*r+a[9]*o+a[13],e[2]=a[2]*t+a[6]*r+a[10]*o+a[14],e[3]=a[3]*t+a[7]*r+a[11]*o+a[15];}for(let n=0;n<12;++n){const t=this.clipPosition[W$1[n][0]],r=this.clipPosition[W$1[n][1]],i=this.clipPosition[W$1[n][2]],s=this.clipTriangle(t,r,i);let a=!0;for(let e=0;e<s.length;++e){if(s[e][3]>=2){a=!1;break}}if(!a){o=!0;for(let t=0;t<s.length;++t){const r=s[t][3];r<e.near&&(e.near=r),r>e.far&&(e.far=r);}}}return o}inside(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void i$13(!1)}intersect(e,t,r){let i=0;return 0===r?i=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===r?i=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===r?i=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===r&&(i=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),j$x(n$P(),e,t,i)}clipTriangle(e,t,r){let i=[e,t,r];for(let n=0;n<4;++n){const e=i;i=[];for(let t=0;t<e.length;++t){const r=e[t],s=e[(t+1)%e.length];this.inside(s,n)?(this.inside(r,n)||i.push(this.intersect(r,s,n)),i.push(s)):this.inside(r,n)&&i.push(this.intersect(r,s,n));}}return i}}const W$1=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],k$1=P$m(),F=e$y(),T$2=n$a(),N=new _$2,U$1=new D,L$2=new E$1;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function o$a(){const o=new n$N;return o.attributes.add("position","vec2"),o.vertex.uniforms.add("proj","mat4"),o.vertex.uniforms.add("drawPosition","vec4"),o.varyings.add("vUV","vec2"),o.vertex.code.add(t$J`void main(void) {
vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);
}`),o.fragment.uniforms.add("textureInput","sampler2D"),o.fragment.uniforms.add("textureMask","sampler2D"),o.fragment.uniforms.add("textureOverlay","sampler2D"),o.fragment.uniforms.add("maskEnabled","bool"),o.fragment.uniforms.add("overlayEnabled","bool"),o.fragment.code.add(t$J`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}
void main() {
float mask = maskEnabled ? texture2D(textureMask, vUV).a : 1.0;
vec4 inputColor = texture2D(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture2D(textureOverlay, vUV) : vec4(0);
gl_FragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;
}`),o}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let x$1=class extends p$N{constructor(){super(...arguments),this._handles=new u$D,this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this.events=new n$L,this.attributeLocations=new Map([["position",0]]),this.tmpScreenPoint=i$S(),this.tmpRenderPoint=s$W();}get updating(){return t$F(this._imageSources)&&r$A(this._imageLoadTask)&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const s=()=>{this.updateResourceLoading(),this.events.emit("request-render");};r$A(this._magnifier)&&this._handles.add(this._magnifier.watch("version",s)),s();}get enabled(){return r$A(this._validMagnifier)}get _validMagnifier(){return r$A(this._magnifier)&&this._magnifier.visible&&r$A(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}get factor(){return r$A(this._magnifier)&&this._magnifier.factor||1}dispose(){this._magnifier=null,this._handles.destroy(),r$A(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this.disposeResources();}render(e,s){const r=this._validMagnifier;if(t$F(r))return;const t=s.camera.pixelRatio,a=Math.ceil(t*r.size);if(this.updateResources(e,a),t$F(this._resources))return;const n=this._resources.program;e.useProgram(n);const m=this._resources.textures,u=Math.ceil(1/this.factor*a);m.input.resize(u,u);const p=s.camera.fullWidth,c=s.camera.fullHeight;d$H(r.position,this.tmpScreenPoint);const h=s.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint),d=.5*u,g=.5*u;h[0]=e$B(h[0],d,p-d-1),h[1]=e$B(h[1],g,c-g-1);const f=Math.floor(h[0]-d),_=Math.floor(h[1]-g);n.bindTexture(m.input,"textureInput"),e.gl.copyTexImage2D(m.input.descriptor.target,0,m.input.descriptor.pixelFormat,f,_,u,u,0);const k=r.offset.x*t,y=r.offset.y*t,v=(h[0]+k)/p*2-1,b=(h[1]-y)/c*2-1,T=a/p*2,j=a/c*2;e.bindVAO(this._resources.vao),n.bindTexture(m.overlay,"textureOverlay"),n.bindTexture(m.mask,"textureMask"),n.setUniform4f("drawPosition",v,b,T,j),n.setUniform1i("maskEnabled",r.maskEnabled?1:0),n.setUniform1i("overlayEnabled",r.overlayEnabled?1:0),e.setPipelineState(this._resources.pipelineState),e.drawArrays(5,0,4);}updateResourceLoading(){const e=this._validMagnifier;if(t$F(e))return;const s=e.maskUrl,r=e.overlayUrl;!r$A(this._imageLoadTask)||this._imageLoadTask.maskUrl===s&&this._imageLoadTask.overlayUrl===r||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),r$A(this._imageSources)||r$A(this._imageLoadTask)||(this._imageLoadTask={maskUrl:s,overlayUrl:r,task:F$e((async e=>{const t=t$F(s)||t$F(r)?s$X(e):null,i=r$A(s)?t$R(s,{signal:e}):t.then((e=>e.mask)),n=r$A(r)?t$R(r,{signal:e}):t.then((e=>e.overlay));this._imageSources={mask:await i,overlay:await n},this.disposeResources(),this.events.emit("request-render");}))},this._imageLoadTask.task.promise.then((()=>this.notifyChange("updating")),(()=>this.notifyChange("updating"))));}updateResources(e,s){if(!this.enabled)return void this.disposeResources();if(r$A(this._resources)){if(this._resources.textures.size!==s){const r=this.createTextureResources(e,s);if(t$F(r))return void this.disposeResources();this.disposeTextureResources(this._resources.textures),this._resources.textures=r;}return}const r=this.createTextureResources(e,s);t$F(r)||(this._resources={textures:r,program:this.createProgram(e),vao:i$N(e,i$17,this.attributeLocations,0,1),pipelineState:g$v({blending:t$O(1,771),depthTest:null,depthWrite:null,colorWrite:r$J})});}disposeResources(){t$F(this._resources)||(this.disposeTextureResources(this._resources.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null);}disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose();}createTextureResources(e,s){if(t$F(this._imageSources))return null;this._imageSources.overlay.width=s,this._imageSources.overlay.height=s,this._imageSources.mask.width=s,this._imageSources.mask.height=s;const r=new o$G(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0,preMultiplyAlpha:!wt$1(this._imageSources.overlay.src)||!e.driverTest.svgAlwaysPremultipliesAlpha},this._imageSources.overlay),t=new o$G(e,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},this._imageSources.mask);return {input:new o$G(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1}),mask:t,overlay:r,size:s}}createProgram(e){const s=o$a();return new n$O(e,s,this.attributeLocations)}};e$x([d$y()],x$1.prototype,"_imageSources",void 0),e$x([d$y()],x$1.prototype,"_imageLoadTask",void 0),e$x([d$y({readOnly:!0})],x$1.prototype,"updating",null),x$1=e$x([i$H("esri/views/3d/webgl-engine/lib/MagnifierHelper")],x$1);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class a$5{constructor(){this.viewTransform=new d$P.ViewProjectionTransform,this.slicePlane=G$h();}}class n$7 extends a$5{constructor(){super(...arguments),this.identifier=0,this.slicePlaneEnabled=!0,this.transparent=!1,this.integratedMesh=!1,this.transformNormal_ViewFromGlobal=e$A(),this.cameraNearFar=n$Q(),this.inverseViewport=n$Q(),this.ambientOcclusionEnabled=!0,this.shadowsEnabled=!0,this.sceneHasOcludees=!1,this.transparencyPassType=3;}}class o$9 extends a$5{constructor(){super(...arguments),this.identifier=1,this.cameraNearFar=n$Q();}}class c$8 extends a$5{constructor(){super(...arguments),this.identifier=2,this.inverseViewport=n$Q(),this.viewport=n$P();}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class s$5{constructor(e,s,r=0){this._rctx=e,this._techniqueRepository=s,this._sorting=r,this._draws=new n$Z({initialSize:32,allocator:e=>e||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._passBoundTechniques=new Set,this._previouslyBoundMaterials=new Map,this._previouslyBoundDraw=new Map;}submitDraw(t,s,r,i,a){const n=this._draws.pushNew();n.geometry=s,n.geometryRanges=r,n.material=t,n.bindDrawParams=i,n.depthSquaredHint=a,n.indexType=s.indexed?e$z(s.vao.indexBuffer).indexType:0;}dispatch(e){const t=this._rctx;this._passBoundTechniques.clear(),this._previouslyBoundMaterials.clear(),this._previouslyBoundDraw.clear();let s=null;const i=this._draws.length;for(let a=0;a<i;a++){const i=this._draws.data[a],n=i.geometry,o=i.material.getTechnique(this._techniqueRepository,e,n.parameters);o===s&&3===o.configuration.transparencyPassType||(t.useProgram(o.program),o.bindPipelineState(t,e.slot),s=o),this._passBoundTechniques.has(o)||(o.bindPass(e),this._passBoundTechniques.add(o)),t.bindVAO(n.vao),this._previouslyBoundMaterials.get(o)!==i.material&&(o.bindMaterial(i.material,e),this._previouslyBoundMaterials.set(o,i.material)),this._previouslyBoundDraw.get(o)!==i.bindDrawParams&&(o.bindDraw(i.bindDrawParams),this._previouslyBoundDraw.set(o,i.bindDrawParams));const d=i.geometryRanges,l=d.length;if(0!==i.indexType){const e=r$3.get(i.indexType);for(let s=0;s<l;s+=2){const r=d[s],a=d[s+1];t.drawElements(n.primitiveType,a,i.indexType,r*e);}}else for(let e=0;e<l;e+=2){const s=d[e],r=d[e+1];t.drawArrays(n.primitiveType,s,r);}}return i>0}prepareSubmit(){this._draws.clear();}finishSubmit(){const e=0===this._sorting?1:-1;this._draws.sort(((t,s)=>{const r=e*(t.depthSquaredHint-s.depthSquaredHint);return 0!==r?r:t.geometry.vao.size-s.geometry.vao.size}));}get count(){return this._draws.length}}const r$3=new Map;r$3.set(5121,1),r$3.set(5123,2),r$3.set(5125,4);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class b$2{constructor(s,a){this.rctx=s,this.shaderTechniqueRepository=a,this.canRender=!0,this._materialPassParams=new n$7,this._shadowPassParams=new o$9,this._highlightPassParams=new c$8,this._systems=new Set,this._passes={materialOpaque:new s$5(s,this.shaderTechniqueRepository),materialTransparent:new s$5(s,this.shaderTechniqueRepository,1),materialIntegratedMesh:new s$5(s,this.shaderTechniqueRepository),shadowMap:new s$5(s,this.shaderTechniqueRepository),highlight:new s$5(s,this.shaderTechniqueRepository),highlightIntegratedMesh:new s$5(s,this.shaderTechniqueRepository),highlightShadowMap:new s$5(s,this.shaderTechniqueRepository),defaultShadowMap:new s$5(s,this.shaderTechniqueRepository)};}register(s){this._systems.add(s);}prepareRender(s){if(0!==this._systems.size){for(const s of Object.values(this._passes))s.prepareSubmit();this._systems.forEach((a=>a.submit(this._passes,{camera:s})));for(const s of Object.values(this._passes))s.finishSubmit();this.shaderTechniqueRepository.frameUpdate();}}render(s){if(0===this._systems.size)return !1;switch(this._configure(s),s.slot){case 3:switch(s.pass){case 0:return this._materialPassParams.subPass=0,this._configureMaterialColorPass(s),this._passes.materialOpaque.dispatch(this._materialPassParams);case 2:return this._materialPassParams.subPass=2,this._passes.materialOpaque.dispatch(this._materialPassParams);case 3:return this._materialPassParams.subPass=3,this._passes.materialOpaque.dispatch(this._materialPassParams);case 5:return this._passes.highlight.dispatch(this._highlightPassParams);case 4:return this._passes.shadowMap.dispatch(this._shadowPassParams);case 7:return this._passes.highlightShadowMap.dispatch(this._shadowPassParams);case 6:return this._passes.defaultShadowMap.dispatch(this._shadowPassParams)}return !1;case 5:switch(s.pass){case 0:return this._materialPassParams.subPass=0,this._configureMaterialColorPass(s),this._passes.materialTransparent.dispatch(this._materialPassParams);case 1:return this._materialPassParams.subPass=1,this._configureMaterialColorPass(s),this._passes.materialTransparent.dispatch(this._materialPassParams);case 2:return this._materialPassParams.subPass=2,this._passes.materialTransparent.dispatch(this._materialPassParams);case 3:return this._materialPassParams.subPass=3,this._passes.materialTransparent.dispatch(this._materialPassParams)}return !1;case 0:switch(s.pass){case 0:return this._materialPassParams.subPass=0,this._configureMaterialColorPass(s),this._materialPassParams.ssrParams=s.ssrParams,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);case 2:return this._materialPassParams.subPass=2,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);case 3:return this._materialPassParams.subPass=3,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);case 5:return this._passes.highlightIntegratedMesh.dispatch(this._highlightPassParams)}return !1}return !1}notifyDirty(){this._context.requestRender();}slots(){return [3,5,0]}initializeRenderContext(s){this._context=s;}uninitializeRenderContext(){}queryDepthRange(a){const e={near:1/0,far:-1/0};return this._systems.forEach((r=>{const t=r.queryShadowCasterDepthRange(a);r$A(t)&&t$b(e,t,e);})),e}get shadowCastingEnabled(){return this._materialPassParams.shadowsEnabled}set shadowCastingEnabled(s){this._materialPassParams.shadowsEnabled=s;}get screenSpaceReflectionsEnabled(){return r$A(this._materialPassParams.ssrParams.ssrEnabled)}set screenSpaceReflectionsEnabled(s){this._materialPassParams.ssrParams.ssrEnabled=!!s;}_configureMaterialColorPass(s){this._materialPassParams.bindShadowMap=a=>{s.shadowMap.bind(a);const e=this._materialPassParams.viewTransform;u$A(T$1,e.worldFromView_TL,e.worldFromView_TH),s.shadowMap.bindView(a,T$1);},this._materialPassParams.bindAmbientOcclusion=a=>s.ssaoHelper.bind(a,s.camera),this._materialPassParams.ambientOcclusionEnabled=!!s.ssaoHelper&&s.ssaoHelper.ready,this._materialPassParams.sceneHasOcludees=s.hasOccludees;}_configure(s){const a=4===s.pass||7===s.pass||6===s.pass?this._shadowPassParams:5===s.pass?this._highlightPassParams:this._materialPassParams;this._updateParameters(s,a);}_updateParameters(s,t){const n=s.camera,P=n.viewInverseTransposeMatrix;o$C(T$1,P[3],P[7],P[11]),R$1.set(T$1),r$B(t.viewTransform.worldFromView_TH,R$1.high),r$B(t.viewTransform.worldFromView_TL,R$1.low),a$Q(t.viewTransform.viewFromCameraRelative_RS,n.viewMatrix),n$K(t.viewTransform.projFromView,n.projectionMatrix),0===t.identifier?(this._materialPassParams.transparent=5===s.slot,this._materialPassParams.integratedMesh=0===s.slot,this._materialPassParams.lighting=s.scenelightingData,o$D(y$1,t.viewTransform.viewFromCameraRelative_RS),u$S(t.transformNormal_ViewFromGlobal,y$1),r$K(t.cameraNearFar,n.near,n.far)):1===t.identifier?r$K(t.cameraNearFar,n.near,n.far):2===t.identifier&&(t.highlightDepthTexture=s.highlightDepthTexture,a$14(t.viewport,n.fullViewport)),0!==t.identifier&&2!==t.identifier||(t.inverseViewport[0]=1/n.fullViewport[2],t.inverseViewport[1]=1/n.fullViewport[3]),H$m(s.sliceHelper.plane,t.slicePlane),c$O(t.slicePlane.origin,t.slicePlane.origin,T$1),t.slicePlaneEnabled=s.sliceHelper.isEnabled,this._materialPassParams.slot=s.slot,this._materialPassParams.transparencyPassType=s.transparencyPassType,this._materialPassParams.multipassTerrainParams=s.multipassTerrainParams;}get needsHighlight(){return this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0}}const T$1=n$F(),y$1=e$A(),R$1=new c$9;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function t$7(t){const o=new n$N,r=o.vertex.code,l=o.fragment.code;return o.attributes.add("position","vec2"),2===t.highlightStage&&(r.add(t$J`void main() {
gl_Position = vec4(vec2(1.0) - position * 2.0, 0.0, 1.0);
}`),o.fragment.uniforms.add("tex","sampler2D"),o.fragment.uniforms.add("invFramebufferDim","vec2"),l.add(t$J`void main() {
vec2 coord = gl_FragCoord.xy * invFramebufferDim;
vec4 value = texture2D(tex, coord);
float mx = floor(max(value.g, value.b));
gl_FragColor = vec4(ceil(value.r), mx, mx, 1.0);
}`)),0===t.highlightStage&&(o.attributes.add("uv0","vec2"),t.gridOptimization?(o.vertex.uniforms.add("coverageTex","sampler2D"),o.fragment.uniforms.add("blurSize","vec2"),o.varyings.add("blurCoordinate","vec3")):(o.vertex.uniforms.add("blurSize","vec2"),o.varyings.add("blurCoordinates[5]","vec2")),r.add(t$J`
    void main() {
      gl_Position = vec4(position, 0.0, 1.0);
      ${t.gridOptimization?t$J`
      vec4 cov = texture2D(coverageTex, uv0);
      if (cov.r == 0.0) {
        gl_Position = vec4(0.0);
      }
      blurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), max(cov.g, cov.b));
      `:t$J`
      vec2 uv = position.xy * 0.5 + vec2(0.5);
      blurCoordinates[0] = uv;
      blurCoordinates[1] = uv + blurSize * 1.407333;
      blurCoordinates[2] = uv - blurSize * 1.407333;
      blurCoordinates[3] = uv + blurSize * 3.294215;
      blurCoordinates[4] = uv - blurSize * 3.294215;
          `}
    }`),o.fragment.uniforms.add("tex","sampler2D"),l.add(t$J`
    void main() {
      ${t.gridOptimization?t$J`
          vec2 uv = blurCoordinate.xy;
          vec4 center = texture2D(tex, uv);

          // do not blur if no pixel or all pixels in neighborhood are set
          if (blurCoordinate.z == 1.0) {
            gl_FragColor = center;
          } else {
            vec4 sum = vec4(0.0);
            sum += center * 0.204164;
            sum += texture2D(tex, uv + blurSize * 1.407333) * 0.304005;
            sum += texture2D(tex, uv - blurSize * 1.407333) * 0.304005;
            sum += texture2D(tex, uv + blurSize * 3.294215) * 0.093913;
            sum += texture2D(tex, uv - blurSize * 3.294215) * 0.093913;
            gl_FragColor = sum;
          }`:t$J`
          vec4 sum = vec4(0.0);
          sum += texture2D(tex, blurCoordinates[0]) * 0.204164;
          sum += texture2D(tex, blurCoordinates[1]) * 0.304005;
          sum += texture2D(tex, blurCoordinates[2]) * 0.304005;
          sum += texture2D(tex, blurCoordinates[3]) * 0.093913;
          sum += texture2D(tex, blurCoordinates[4]) * 0.093913;
          gl_FragColor = sum;`}
    }`)),1===t.highlightStage&&(o.varyings.add("uv","vec2"),t.gridOptimization&&(o.attributes.add("uv0","vec2"),o.vertex.uniforms.add("coverageTex","sampler2D")),r.add(t$J`
      void main() {
        ${t.gridOptimization?t$J`
            vec4 cov = texture2D(coverageTex, uv0);
            // if no highlight pixel set in this block, hide block
            if (cov.r == 0.0) {
              gl_Position = vec4(0.0);
              return;
            }`:""}
        gl_Position = vec4(position, 0.0, 1.0);
        uv = position.xy * 0.5 + vec2(0.5);
      }`),o.fragment.uniforms.add("tex","sampler2D"),o.fragment.uniforms.add("origin","sampler2D"),o.fragment.uniforms.add("color","vec4"),o.fragment.uniforms.add("haloColor","vec4"),o.fragment.uniforms.add("outlineSize","float"),o.fragment.uniforms.add("blurSize","float"),o.fragment.uniforms.add("opacities","vec4"),l.add(t$J`void main() {
vec4 blurredHighlightValue = texture2D(tex, uv);
float highlightIntensity = blurredHighlightValue.a;
if (highlightIntensity == 0.0) {
discard;
}
vec4 origin_color = texture2D(origin, uv);
float outlineIntensity;
float fillIntensity;
if (blurredHighlightValue.g > blurredHighlightValue.b) {
outlineIntensity = haloColor.w * opacities[1];
fillIntensity = color.w * opacities[3];
}
else {
outlineIntensity = haloColor.w * opacities[0];
fillIntensity = color.w * opacities[2];
}
float inner = 1.0 - outlineSize / 9.0;
float outer = 1.0 - (outlineSize + blurSize) / 9.0;
float outlineFactor = smoothstep(outer, inner, highlightIntensity);
float fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;
float intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;
gl_FragColor = vec4(mix(haloColor.rgb, color.rgb, fillFactor), intensity);
}`)),o}const o$8=Object.freeze({__proto__:null,build:t$7});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const m$4=8.6,p$5=.4;class g$1 extends t$L{initializeProgram(i){const o=g$1.shader.get().build(this.configuration);return new n$O(i.rctx,o,o$F)}bindApplyPass(i){this.program.setUniform4fv("color",i.color),this.program.setUniform4fv("haloColor",i.haloColor),this.program.setUniform1f("outlineSize",m$4),this.program.setUniform1f("blurSize",p$5),this.program.setUniform4f("opacities",i.haloOpacity,i.haloOpacityOccluded,i.fillOpacity,i.fillOpacityOccluded);}initializePipeline(){return 1===this.configuration.highlightStage?g$v({blending:e$E(770,1,771,771),colorWrite:r$J}):g$v({colorWrite:r$J})}get primitiveType(){return this.configuration.gridOptimization?4:5}}g$1.shader=new t$M(o$8,(()=>import('./HighlightComposition.glsl-b106125b.js')));class d$7 extends t$K{constructor(){super(...arguments),this.highlightStage=0,this.gridOptimization=!1;}}e$x([e$D({count:3})],d$7.prototype,"highlightStage",void 0),e$x([e$D()],d$7.prototype,"gridOptimization",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const d$6=32;class b$1{constructor(e,i){this._techniqueRep=e,this._rctx=i,this.viewportToRestore=n$P(),this.defaultOptions={color:r$V(1,0,1,1),haloColor:r$V(1,0,1,1),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05,shadowColor:r$V(1,0,1,1),shadowOpacity:.15,occludedShadowOpacity:.075},this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0};}assertResources(){if(this.quadVAO)return;this.quadVAO=i$N(this._rctx);const e={colorTarget:0,depthStencilTarget:0,width:0,height:0},i={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this.blur0Fbo=new l$F(this._rctx,e,i),this.blur1Fbo=new l$F(this._rctx,e,i);const t=new d$7;t.highlightStage=0,t.gridOptimization=!1,this.blurTechnique=this._techniqueRep.acquire(g$1,t),t.highlightStage=0,t.gridOptimization=!0,this.blurGridTechnique=this._techniqueRep.acquire(g$1,t),t.highlightStage=1,t.gridOptimization=!1,this.applyTechnique=this._techniqueRep.acquire(g$1,t),t.highlightStage=1,t.gridOptimization=!0,this.applyGridTechnique=this._techniqueRep.acquire(g$1,t),t.highlightStage=2,t.gridOptimization=!1,this.downsampleTechnique=this._techniqueRep.acquire(g$1,t);}dispose(){if(this._grid.coverageMipmap)for(let e=1;e<this._grid.coverageMipmap.length;e++)this._grid.coverageMipmap[e].dispose();this._grid.vao&&this._grid.vao.dispose(!0),this.quadVAO&&(this.quadVAO.dispose(!0),this.quadVAO=null),this.blur0Fbo=i$M(this.blur0Fbo),this.blur1Fbo=i$M(this.blur1Fbo);}get profilingCallback(){return I$j.HIGHLIGHTS_PROFILE_TO_CONSOLE?e=>console.log(e):null}setDefaultOptions(e){this.defaultOptions=e;}render(e,i,r){const o=e.pixelRatio,s=I$j.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED,l=this._rctx;this.assertResources(),a$14(this.viewportToRestore,e.fullViewport);const h=e.fullWidth,p=e.fullHeight,c=Math.ceil(h/o),g=Math.ceil(p/o);this.blur0Fbo.resize(c,g),this.blur1Fbo.resize(c,g),l.bindVAO(this.quadVAO);let u=null;const n=s?this.blurGridTechnique:this.blurTechnique;n.bindPipelineState(l),l.useProgram(n.program),s?(this._gridUpdateResources(i,d$6),this._gridComputeMipmap(),u=this._grid.vao,n.program.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,"coverageTex")):u=this.quadVAO,l.bindVAO(u),l.bindFramebuffer(this.blur0Fbo),l.setViewport(0,0,c,g),l.setClearColor(0,0,0,0),l.clear(16384),n.program.bindTexture(i.colorTexture,"tex"),n.program.setUniform2f("blurSize",1/c,0),l.drawArrays(n.primitiveType,0,r$O(u,"geometry")),l.bindFramebuffer(this.blur1Fbo),l.clear(16384),n.program.bindTexture(this.blur0Fbo.colorTexture,"tex"),n.program.setUniform2f("blurSize",0,1/g),l.drawArrays(n.primitiveType,0,r$O(u,"geometry"));const b=s?this.applyGridTechnique:this.applyTechnique;if(l.bindFramebuffer(r),b.bindPipelineState(l),l.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]),l.useProgram(b.program),b.program.bindTexture(this.blur1Fbo.colorTexture,"tex"),b.program.bindTexture(i.colorTexture,"origin"),s){const e=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture;b.program.bindTexture(e,"coverageTex");}b.bindApplyPass(this.defaultOptions),l.drawArrays(b.primitiveType,0,r$O(u,"geometry")),l.bindVAO(null);}_gridUpdateResources(e,i){const t=this._rctx,r=this._grid;let o=!1;if(null===r.coverageMipmap&&(r.coverageMipmap=[e],o=!0),r.viewportWidth===e.width&&r.viewportHeight===e.height||(o=!0,r.viewportWidth=e.width,r.viewportHeight=e.height),r.coverageMipmap[0]=e,r.cellPixelSize!==i&&(r.cellPixelSize=i,o=!0),o){for(let e=1;e<r.coverageMipmap.length;e++)r.coverageMipmap[e].dispose();r.mipmapLevels=Math.ceil(Math.log(r.cellPixelSize)*Math.LOG2E),r.coverageMipmap.length=r.mipmapLevels+1;for(let e=0;e<r.mipmapLevels;e++){const i=r.coverageMipmap[e],o={target:3553,pixelFormat:6407,dataType:33635,samplingMode:9729,wrapMode:33071,width:Math.ceil(i.width/2),height:Math.ceil(i.height/2)},a={colorTarget:0,depthStencilTarget:0,width:Math.ceil(i.width/2),height:Math.ceil(i.height/2)};r.coverageMipmap[e+1]=new l$F(t,a,o);}}const a=Math.ceil(e.height/r.cellPixelSize),h=Math.ceil(e.width/r.cellPixelSize);if(!r.vao||r.verticalCellCount!==a||r.horizontalCellCount!==h){r.verticalCellCount=a,r.horizontalCellCount=h;const e=a+1,i=h+1,o=1/a,p=1/h,c=6,u=4,m=new Float32Array(c*u*e*i);let d=0;for(let t=0;t<e;t++)for(let e=0;e<i;e++)m[d+0]=(e-.5)*p*2-1,m[d+1]=(t-.5)*o*2-1,m[d+2]=e*p,m[d+3]=t*o,m[d+4]=(e+.5)*p*2-1,m[d+5]=(t-.5)*o*2-1,m[d+6]=e*p,m[d+7]=t*o,m[d+8]=(e-.5)*p*2-1,m[d+9]=(t+.5)*o*2-1,m[d+10]=e*p,m[d+11]=t*o,m[d+12]=(e-.5)*p*2-1,m[d+13]=(t+.5)*o*2-1,m[d+14]=e*p,m[d+15]=t*o,m[d+16]=(e+.5)*p*2-1,m[d+17]=(t-.5)*o*2-1,m[d+18]=e*p,m[d+19]=t*o,m[d+20]=(e+.5)*p*2-1,m[d+21]=(t+.5)*o*2-1,m[d+22]=e*p,m[d+23]=t*o,d+=c*u;r.vao&&r.vao.dispose(!0),r.vao=new f$w(t,o$F,{geometry:s$D},{geometry:h$y.createVertex(t,35044,m)});}}_gridComputeMipmap(){const e=this._rctx,i=this._grid,t=this.downsampleTechnique.program;this.downsampleTechnique.bindPipelineState(e),e.bindVAO(this.quadVAO),e.useProgram(t);for(let r=0;r<i.mipmapLevels;r++){e.bindFramebuffer(i.coverageMipmap[r+1]),t.bindTexture(i.coverageMipmap[r].colorTexture,"tex");const o=i.coverageMipmap[r+1].width,a=i.coverageMipmap[r+1].height;t.setUniform2f("invFramebufferDim",1/o,1/a),e.setViewport(0,0,o,a),e.drawArrays(5,0,r$O(this.quadVAO,"geometry"));}}get gpuMemoryUsage(){let e=(r$A(this.blur0Fbo)?this.blur0Fbo.gpuMemoryUsage:0)+(r$A(this.blur1Fbo)?this.blur1Fbo.gpuMemoryUsage:0);if(this._grid.coverageMipmap)for(const i of this._grid.coverageMipmap)e+=i.gpuMemoryUsage;return e}get test(){return {coverage:this._grid.coverageMipmap,blur:[this.blur0Fbo,this.blur1Fbo]}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const o$7={dataType:5121,internalFormat:6408},d$5={};class a$4{constructor(e){this.rctx=e,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this.depthTextureSupported=e.capabilities.depthTexture;}dispose(){this._depthBuffers.forEach((e=>e.dispose())),this._depthBuffers.clear(),this._depthTextures.forEach((e=>e.dispose())),this._depthTextures.clear(),this._colorTextures.forEach((e=>e.dispose())),this._colorTextures.clear(),this._framebuffers.forEach((e=>e.dispose())),this._framebuffers.clear();}disposeTargetResource(e){const t=e.id;this._activeTargets.has(t)&&(this._activeTargets.delete(t),this.disposeWithFramebuffers(this._depthTextures,t),this.disposeWithFramebuffers(this._depthBuffers,t),this.disposeWithFramebuffers(this._colorTextures,t));}disposeWithFramebuffers(e,t){const r=e.get(t);r&&(this._framebuffers.forEach(((e,t)=>{e.colorAttachment!==r&&e.depthStencilAttachment!==r||(e.detachAll(),e.dispose(),this._framebuffers.delete(t));})),r.dispose(),e.delete(t));}getDepthTexture(e,t){if(!this.depthTextureSupported)return null;let r=this._depthTextures.get(e.id);return !r||r.descriptor.width===t.width&&r.descriptor.height===t.height||(r.dispose(),r=null),r||(r=new o$G(this.rctx,{target:3553,pixelFormat:34041,dataType:34042,samplingMode:9728,wrapMode:33071,width:t.width,height:t.height}),this._depthTextures.set(e.id,r),this._activeTargets.add(e.id)),r}getAllocatedDepthTexture(e){return this._depthTextures.get(e.id)}getDepthBuffer(e,t){if(this.depthTextureSupported)return null;let r=this._depthBuffers.get(e.id);return r?r.descriptor.width===t.width&&r.descriptor.height===t.height||r.resize(t.width,t.height):(r=new e$X(this.rctx,{internalFormat:34041,...t}),this._depthBuffers.set(e.id,r),this._activeTargets.add(e.id)),r}getColorTexture(e,t){let r=this._colorTextures.get(e.id);return r&&(r.descriptor.width===t.width&&r.descriptor.height===t.height||(r.dispose(),r=null)),r||(r=new o$G(this.rctx,{target:3553,pixelFormat:6408,internalFormat:e.internalFormat,dataType:e.dataType,samplingMode:null!=e.samplingMode?e.samplingMode:9729,wrapMode:33071,width:t.width,height:t.height}),this._colorTextures.set(e.id,r),this._activeTargets.add(e.id)),r}getAllocatedColorTexture(e){return this._colorTextures.get(e.id)}registerDepthTarget(e={}){return {id:e$J(),...d$5,...e}}registerColorTarget(e={}){return {id:e$J(),...o$7,...e}}getFramebuffer(t,i,s){const h=this.getKey(i,s);let o=this._framebuffers.get(h);const d=this.getColorTexture(i,t);if(this.depthTextureSupported){const i=s?this.getDepthTexture(s,t):void 0;if(!o)return o=r$A(s)?new l$F(this.rctx,{colorTarget:0,depthStencilTarget:4},d,i):new l$F(this.rctx,{colorTarget:0,depthStencilTarget:0},d),this._framebuffers.set(h,o),o;return (o.width!==t.width||o.height!==t.height||o.colorTexture!==d||o.depthStencilTexture!==i)&&(o.detachAll(),o.resize(t.width,t.height),o.attachColorTexture(d),o.attachDepthStencilTexture(i)),o}const a=s?this.getDepthBuffer(s,t):void 0;if(!o)return o=new l$F(this.rctx,{colorTarget:0,depthStencilTarget:s?3:0},d,a),this._framebuffers.set(h,o),o;return (o.width!==t.width||o.height!==t.height||o.colorTexture!==d)&&(o.detachAll(),o.resize(t.width,t.height),o.attachColorTexture(d),o.attachDepthStencilBuffer(a)),o}getKey(e,t){return `${e.id}_${t?t.id:"X"}_${e.name}${t?"_"+t.name:""}`}get gpuMemoryUsage(){let e=0;const t=new Set,r=r=>{t.has(r)||(t.add(r),e+=n$15(r));};return this._depthTextures.forEach(r),this._colorTextures.forEach(r),this._depthBuffers.forEach(r),e}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class r$2{constructor(e,r){this._rctx=e,this._compositingHelper=r,this._mainColorTarget=0,this._dimensions={width:4,height:4},this._needLastFrameColorTexture=!1,this._background={type:"color",color:[0,0,0,1]};const i="webgl2"===e.webglVersion;this._renderTargetHelper=new a$4(e);const o=this._renderTargetHelper;this.mainColorTargets=[o.registerColorTarget({name:"mainColorTarget0"}),o.registerColorTarget({name:"mainColorTarget1"})],this.frontFaceTarget=o.registerColorTarget({name:"frontFaceTarget"});const s=e=>o.registerColorTarget({name:e,dataType:5126,internalFormat:i?34836:6408,samplingMode:9728});this.colorFloatTarget=s("colorFloatTarget"),this.alphaFloatTarget=s("alphaFloatTarget"),this.mainDepth=o.registerDepthTarget({name:"mainDepth"}),this.linearDepth=o.registerColorTarget({name:"linearDepth",samplingMode:9728}),this.terrainLinearDepth=o.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=o.registerColorTarget({name:"geometryLinearDepth"}),this.normal=o.registerColorTarget({name:"normal"}),this.highlight=o.registerColorTarget({name:"highlight",internalFormat:i?32854:6408,dataType:32819}),this.hudVisibility=o.registerColorTarget({name:"hudVisibility",internalFormat:i?32854:6408,dataType:32819}),this.tmpColor=o.registerColorTarget({name:"tmpColor"}),this.tmpDepth=o.registerDepthTarget({name:"tmpDepth"}),this.hudColor=o.registerColorTarget({name:"hudColor"});}dispose(){this._renderTargetHelper.dispose();}get width(){return this._dimensions.width}get height(){return this._dimensions.height}set background(e){this._background=e;}get background(){return this._background}get currentColorTarget(){return this.mainColorTargets[this._mainColorTarget]}get previousColorTarget(){return this.mainColorTargets[1-this._mainColorTarget]}get framebuffer(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}getFramebuffer(e,t){return this._renderTargetHelper.getFramebuffer(this._dimensions,e,t)}get colorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}get depthTexture(){return this._renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}get linearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}get terrainLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}get geometryLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}get lastFrameColorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}get normalTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.normal)}get highlightTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.highlight)}get hudVisibilityTexture(){return this.getColorTexture(this.hudVisibility)}get tmpColorTexture(){return this.getColorTexture(this.tmpColor)}get hudColorTexture(){return this.getColorTexture(this.hudColor)}get mainColorTexture(){return this.getColorTexture(this.currentColorTarget)}advanceCurrentRenderTarget(){this._mainColorTarget=0===this._mainColorTarget&&this._needLastFrameColorTexture?1:0;}initializeFrame(e){const t=this._rctx;this._dimensions.width=e.fullWidth,this._dimensions.height=e.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),t.setClearStencil(0);const r=this._background.color;t.setClearColor(r[0]*r[3],r[1]*r[3],r[2]*r[3],r[3]),t.clearSafe(17664);}composite(){r$A(this.colorTexture)&&this._compositingHelper.composite(this.colorTexture,0);}renderTmpAndCompositeToMain(e,t,r=!1){this.renderToTargets(e,this.tmpColor,r?this.tmpDepth:this.mainDepth,i$6),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),t);}renderHUDVisibility(e,t=!1){this.renderToTargets(e,this.hudVisibility,t?this.tmpDepth:this.mainDepth,o$6);}compositeTransparentTerrainOntoHUDVisibility(){this.renderToTargets((()=>this._compositingHelper.composite(this.getColorTexture(this.tmpColor),0,1,1)),this.hudVisibility,this.tmpDepth);}renderOITPass(e,t,r){let i,o;switch(t){case 0:i=this.colorFloatTarget,o=[0,0,0,0];break;case 1:i=this.alphaFloatTarget,o=[1,1,1,1];break;case 2:i=this.frontFaceTarget,o=[0,0,0,0];}r?this.renderToTargets(e,i,this.tmpDepth,o,!0,!0):this.renderToTargets(e,i,this.mainDepth,o,!1);}compositeTransparentTerrainOntoMain(){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2);}compositeOccludedOntoMain(e){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2,e);}compositeTransparentOntoOpaque(e){e?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(16384)):this.bindFramebuffer(),this._compositingHelper.compositeTransparent(this.getColorTexture(this.colorFloatTarget),this.getColorTexture(this.alphaFloatTarget),this.getColorTexture(this.frontFaceTarget));}bindFramebuffer(){this._rctx.bindFramebuffer(this.framebuffer);}renderDepthDetached(e){this.bindTarget(this.currentColorTarget),e(),this.bindTarget(this.currentColorTarget,this.mainDepth);}disposeTarget(e){this._renderTargetHelper.disposeTargetResource(e);}set needLastFrameColorTexture(e){!e&&this._needLastFrameColorTexture&&(this._mainColorTarget=0,this.disposeTarget(this.mainColorTargets[1])),this._needLastFrameColorTexture=e;}get needLastFrameColorTexture(){return this._needLastFrameColorTexture}renderToTargets(e,t,r,i,o=!1,s=!1){const a=this._rctx,h=this.bindTarget(t,r);let n=0;if(i){const e=1e-13,t=Math.max(e,i[3]);a.setClearColor(i[0],i[1],i[2],t),n|=16384;}return o&&(n|=256),!1===s?s=0:(!0===s&&(s=255),n|=1024),n&&a.clearSafe(n,s),e(),a.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth),h}bindTarget(e,t){const r=this._renderTargetHelper.getFramebuffer(this._dimensions,e,t);return this._rctx.bindFramebuffer(r),r}getColorTexture(e){return this._renderTargetHelper.getColorTexture(e,this._dimensions)}get gpuMemoryUsage(){let e=0;return this._renderTargetHelper&&(e+=this._renderTargetHelper.gpuMemoryUsage),e}}const i$6=[0,0,0,0],o$6=[0,1,0,1];

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class n$6{constructor(e){this.context=e,this.renderPlugins=new Array,this.slots=[];for(let t=0;t<22;++t)this.slots[t]=[];}add(t,r,n){const s=()=>{this.renderPlugins.push(r);for(const e of t)this.slots[e].push(r);this.context.requestRender();},i=r.initializeRenderContext(this.context,n);if(q$l(i))return i.then(s);s();}remove(e){const t=this.renderPlugins.length;this.renderPlugins=this.renderPlugins.filter((t=>t!==e)),i$13(this.renderPlugins.length<t,"Removing non-added render plugin");for(let r=0;r<this.slots.length;++r)this.slots[r]=this.slots[r].filter((t=>t!==e));e.uninitializeRenderContext(),this.context.requestRender();}prepareRender(e,t){for(const r of this.renderPlugins)r.prepareRender&&r.prepareRender(e,t);}render(){const e=this.slots[this.context.renderContext.slot];let t=!1;for(const r of e)r.canRender&&r.render(this.context.renderContext)&&(t=!0);return t}queryDepthRange(e){const r=s$4;r.near=1/0,r.far=-1/0;for(const n of this.renderPlugins)if(n.queryDepthRange){const s=n.queryDepthRange(e);s&&t$b(r,s,r);}return r}get needsHighlight(){return this.renderPlugins.some((e=>e.needsHighlight))}get needsLinearDepth(){return this.renderPlugins.some((e=>e.needsLinearDepth))}get needsLaserlineWithContrastControl(){const e=this.slots[15];return !!e&&e.length>0}get renderOccludedFlags(){let e=0;return this.renderPlugins.forEach((t=>{t.renderOccludedFlags&&(e|=t.renderOccludedFlags);})),e}}const s$4={near:0,far:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const i$5=255,n$5=1/i$5;function l$6(l){const c=new n$N;c.fragment.include(a$V),c.fragment.include(a$U),c.include(o$Z),c.include(o$Y);const{pass:p}=l;if(1===p){const{visualization:e,bandsEnabled:a}=l;c.fragment.constants.add("inverseSampleValue","float",i$5),c.fragment.uniforms.add("shadowCastMap","sampler2D"),c.fragment.uniforms.add("sampleScale","float"),c.fragment.uniforms.add("opacityFromElevation","float");const r=0===e,o=1===e;c.fragment.uniforms.add("color","vec4"),r?a&&c.fragment.uniforms.add("bandSize","float"):o&&c.fragment.uniforms.add("threshold","float"),c.fragment.code.add(t$J`
      void main(void) {
        vec4 record = texture2D(shadowCastMap, uv);
        float pixelSamples = record.r * inverseSampleValue;

        if (pixelSamples < 1.0) {
          discard;
        }

        float strength = pixelSamples * sampleScale;

        ${o?t$J`
            if (strength <= threshold) {
              discard;
            }`:""}

        ${r&&a?t$J`strength = ceil(strength / bandSize) * bandSize;`:""}

        gl_FragColor = vec4(color.xyz, color.a * opacityFromElevation ${r?t$J`* strength`:""});
      }
    `);}else 0!==p&&2!==p||(c.include(t$12),c.fragment.uniforms.add("depthMap","sampler2D"),c.fragment.uniforms.add("inverseView","mat4"),c.fragment.uniforms.add("nearFar","vec2"),0===p?c.fragment.constants.add("sampleValue","float",n$5):c.fragment.constants.add("shadowColor","vec4",[0,0,0,.8]),c.fragment.code.add(t$J`
      void main(void) {

        float depth = rgba2float(texture2D(depthMap, uv));
        // 0.0 is the clear value of depthMap, which means nothing has been drawn there and we should discard
        if (depth == 0.0) {
          discard;
        }

        float currentPixelDepth = linearDepthFromFloat(depth, nearFar);

        if (-currentPixelDepth > nearFar.y || -currentPixelDepth < nearFar.x) {
          discard;
        }

        vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
        vec4 worldSpacePos = inverseView * currentPixelPos;

        mat4 shadowMatrix;
        float linearDepth = -currentPixelDepth;
        int i = chooseCascade(linearDepth, shadowMatrix);

        if (i >= uShadowMapNum) {
          discard;
        }

        vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);

        // vertex completely outside? -> no shadow
        if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
          discard;
        }

        vec2 uvShadow = cascadeCoordinates(i, lvpos);

        float depthShadow = readShadowMapDepth(uvShadow, uShadowMapTex);
        bool shadow = depthShadow < lvpos.z;

        if (!shadow) {
          discard;
        }

        gl_FragColor = ${0===p?t$J`vec4(sampleValue)`:t$J`shadowColor`};
      }
    `));return c}const c$7=Object.freeze({__proto__:null,shadowCastMaxSamples:i$5,build:l$6});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class c$6 extends t$L{initializeProgram(r){const i=c$6.shader.get().build(this.configuration);return new n$O(r.rctx,i,o$F)}initializePipeline(r){switch(this.configuration.pass){case 0:return g$v({blending:e$E(1,1,1,1),colorWrite:r$J,depthTest:null,depthWrite:null});case 1:case 2:return g$v({blending:u$R,colorWrite:r$J,depthTest:null,depthWrite:null})}return g$v({})}bindPass(r){if(0===this.configuration.pass||2===this.configuration.pass){const i=r;this.program.bindTexture(i.linearDepthTexture,"depthMap"),i.shadowMap.bind(this.program),i.shadowMap.bindView(this.program,i.camera.center),this.program.setUniform2fv("nearFar",i.camera.nearFar),this.program.setUniformMatrix4fv("inverseView",i.inverseView),this.program.setUniform4fv("projInfo",i.projInfo),this.program.setUniform2fv("zScale",i.zScale);}else if(1===this.configuration.pass){const i=r;if(this.program.bindTexture(i.shadowCastMap,"shadowCastMap"),this.program.setUniform1f("sampleScale",i.sampleScale),this.program.setUniform1f("opacityFromElevation",i.opacityFromElevation),this.program.setUniform4fv("color",i.color),0===this.configuration.visualization&&this.configuration.bandsEnabled){const i=r;this.program.setUniform1f("bandSize",i.bandSize);}else if(1===this.configuration.visualization){const i=r;this.program.setUniform1f("threshold",i.threshold);}}}get primitiveType(){return 5}}c$6.shader=new t$M(c$7,(()=>import('./ShadowCast.glsl-ffa930e5.js')));class d$4 extends t$K{constructor(){super(...arguments),this.pass=0,this.visualization=0,this.bandsEnabled=!1;}}e$x([e$D({count:3})],d$4.prototype,"pass",void 0),e$x([e$D()],d$4.prototype,"visualization",void 0),e$x([e$D()],d$4.prototype,"bandsEnabled",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const c$5=r$L(.01,0,.25,1),d$3=4e4,m$3=5e4,p$4=1/512;let v$3=class extends p$N{constructor(e,i,t,s){super({}),this._techniqueRepository=e,this._rctx=i,this._shadowAccumulator=t,this._requestRender=s,this._visualizationParams={shadowCastMap:this._shadowCastTexture,sampleScale:0,color:c$5,threshold:.5,bandSize:.1,opacityFromElevation:1},this._techniqueConfig=new d$4,this._enabled=!1,this._vao=i$N(i),this._techniqueConfig.pass=1,this._techniqueConfig.visualization=0;}normalizeCtorArgs(){return {}}dispose(){this._stop(),this._vao=i$M(this._vao),this._techniqueRepository.release(this._technique),this._technique=null,this._shadowAccumulator=null;}get visualizeShadowCastTechnique(){return this._technique=this._techniqueRepository.releaseAndAcquire(c$6,this._techniqueConfig,this._technique),this._technique}render(){if(!this._isRenderingVisualization)return;this._sampleScale=1/this._computedSamples,this._rctx.bindVAO(this._vao);const e=this.visualizeShadowCastTechnique;this._rctx.useProgram(e.program),e.bindPipelineState(this._rctx),e.bindPass(this._visualizationParams),this._rctx.drawArrays(e.primitiveType,0,r$O(this._vao,"geometry"));}setOptions(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.color&&this._setColor(e.color),void 0!==e.threshold&&(this._threshold=e.threshold),void 0!==e.visualization&&(this._visualization=e.visualization),void 0!==e.bandSize&&(this._bandSize=e.bandSize),void 0!==e.bandsEnabled&&(this._bandsEnabled=e.bandsEnabled);}get opacityFromElevation(){return this._visualizationParams.opacityFromElevation}set opacityFromElevation(e){this._visualizationParams.opacityFromElevation!==e&&(this._visualizationParams.opacityFromElevation=e,this.notifyChange("opacityFromElevation"));}get _isRenderingVisualization(){return this._enabled&&this._computedSamples>0&&this.opacityFromElevation>p$4}get _computedSamples(){return this._shadowAccumulator.computedSamples}get _shadowCastTexture(){return this._shadowAccumulator.shadowCastTexture}get _sampleScale(){return this._visualizationParams.sampleScale}set _sampleScale(e){this._visualizationParams.sampleScale=e;}get _threshold(){return this._visualizationParams.threshold}set _threshold(e){this._threshold!==e&&(this._visualizationParams.threshold=e,this._requestRenderIfRunning());}get _visualization(){return this._techniqueConfig.visualization}set _visualization(e){e!==this._visualization&&(this._techniqueConfig.visualization=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning());}get _bandSize(){return this._visualizationParams.bandSize}set _bandSize(e){e!==this._bandSize&&(this._visualizationParams.bandSize=e,this._requestRenderIfRunning());}get _bandsEnabled(){return this._techniqueConfig.bandsEnabled}set _bandsEnabled(e){e!==this._bandsEnabled&&(this._techniqueConfig.bandsEnabled=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning());}_setColor(e){const i=this._visualizationParams.color;D$k(e,i)||(a$14(this._visualizationParams.color,e),this._requestRenderIfRunning());}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop());}_requestRenderIfRunning(){this._enabled&&this._requestRender();}_start(){this._enabled=!0,this._requestRender();}_stop(){this._enabled=!1,this._requestRender();}};e$x([d$y()],v$3.prototype,"opacityFromElevation",null),v$3=e$x([i$H("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],v$3);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class L$1{constructor(){this.camera=new J$d,this.lightMat=e$y();}}class H$1{constructor(t,s,e=0){this.rctx=t,this.viewingMode=s,this._enabled=!1,this._snapshots=new Array,this.textureSize=0,this.maxTextureSize=0,this.numCascades=1,this.maxNumCascades=4,this.splitSchemeLambda=0,this.warp=!0,this.cascadeDistances=[0,0,0,0,0],this.cascades=[],this.maxTextureSize=this.rctx.parameters.maxTextureSize;for(let a=0;a<4;++a)this.cascades.push(new L$1);this.snapshotCount=e;}dispose(){this.discardDepthTexture(),this.discardAllSnapshots();}set maxCascades(s){this.maxNumCascades=e$B(Math.floor(s),1,4);}get maxCascades(){return this.maxNumCascades}set enabled(t){this._enabled=t,t||(this.discardDepthTexture(),this.discardAllSnapshots());}get enabled(){return this._enabled}get snapshotCount(){return this._snapshots.length}set snapshotCount(t){const s=this._snapshots.length;if(t>s){const e=t-s;this._snapshots.length=t;for(let t=0;t<e;++t)this._snapshots[s+t]=null;}else if(t<this.snapshotCount){const e=s-t;for(let s=0;s<e;++s)this.discardSnapshot(t+s);this._snapshots.length=t;}}getSnapshot(t){return this.enabled?this._snapshots[t]:null}getCascades(){for(let t=0;t<this.numCascades;++t)st[t]=this.cascades[t];return st.length=this.numCascades,st}start(t,s,e){i$13(this.enabled),this.textureSize=this.computeTextureSize(t.fullWidth,t.fullHeight),this.ensureDepthTexture();const{near:a,far:i}=this.clampNearFar(e);this.computeCascadeDistances(i,a),this.setupMatrices(t,s);const r=t.viewMatrix,h=t.projectionMatrix;for(let o=0;o<this.numCascades;++o)this.constructCascade(o,h,r,s);this.lastOrigin=null,this.clear();}finish(t){i$13(this.enabled),this.rctx.bindFramebuffer(t);}bind(t){this.enabled?(this._depthTextureUnit=t.bindTexture(this._depthTexture,"uShadowMapTex"),t.setUniform1f("uDepthHalfPixelSz",.5/this.textureSize),t.setUniform1i("uShadowMapNum",this.numCascades),t.setUniform4f("uShadowMapDistance",this.cascadeDistances[0],this.numCascades>1?this.cascadeDistances[1]:1/0,this.numCascades>2?this.cascadeDistances[2]:1/0,this.numCascades>3?this.cascadeDistances[3]:1/0)):t.setUniform1f("uDepthHalfPixelSz",-1);}bindView(t,s){if(!this.enabled)return;const e=this.lastOrigin;if(!(e&&e[0]===s[0]&&e[1]===s[1]&&e[2]===s[2])){this.lastOrigin=this.lastOrigin||n$F(),r$B(this.lastOrigin,s);for(let t=0;t<this.numCascades;++t){c$U(et,this.cascades[t].lightMat,s);for(let s=0;s<16;++s)at[16*t+s]=et[s];}}t.setUniformMatrix4fv("uShadowMapMatrix",at);}takeCascadeSnapshotTo(t,s){i$13(this.enabled),this.ensureSnapshot(s),this._bindFbo();const e=this.rctx,a=e.bindTexture(this._snapshots[s],o$G.TEXTURE_UNIT_FOR_UPDATES);e.gl.copyTexSubImage2D(3553,0,t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[2],t.camera.viewport[3]),e.bindTexture(a,o$G.TEXTURE_UNIT_FOR_UPDATES);}clear(){const t=this.rctx;this._bindFbo(),t.setClearColor(1,1,1,1),t.clearSafe(16640);}computeTextureSize(t,s){const e=.5*Math.log(t*t+s*s)*Math.LOG2E,a=.35,i=2**Math.round(e+a);return Math.min(this.maxTextureSize,2*i)}ensureDepthTexture(){if(null!=this._depthTexture&&this._depthTexture.descriptor.width===this.textureSize)return;this.discardDepthTexture();const t={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize};this._depthTexture=new o$G(this.rctx,t),this.fbo=new l$F(this.rctx,{colorTarget:0,depthStencilTarget:1,width:this.textureSize,height:this.textureSize},this._depthTexture);}ensureSnapshot(t){const s=this._snapshots[t];if(r$A(s)&&s.descriptor.width===this.textureSize)return;this.discardSnapshot(t);const e={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize};this._snapshots[t]=new o$G(this.rctx,e);}discardDepthTexture(){this.fbo=i$M(this.fbo),this._depthTexture=i$M(this._depthTexture);}discardSnapshot(t){this._snapshots[t]=i$M(this._snapshots[t]);}discardAllSnapshots(){for(let t=0;t<this.snapshotCount;++t)this.discardSnapshot(t);}_bindFbo(){const t=this.rctx;r$A(this._depthTextureUnit)&&(t.bindTexture(null,this._depthTextureUnit),this._depthTextureUnit=null),t.bindFramebuffer(this.fbo);}constructCascade(t,s,e,a){const i=this.cascades[t],r=-this.cascadeDistances[t],c=-this.cascadeDistances[t+1],n=(s[10]*r+s[14])/Math.abs(s[11]*r+s[15]),u=(s[10]*c+s[14])/Math.abs(s[11]*c+s[15]);i$13(n<u);for(let h=0;h<8;++h){r$P(G,h%4==0||h%4==3?-1:1,h%4==0||h%4==1?-1:1,h<4?n:u,1),y$w(V$1[h],G,q$1);for(let t=0;t<3;++t)V$1[h][t]/=V$1[h][3];}v$r(tt,V$1[0]),c$U(I,$$1,tt),i.camera.viewMatrix=I;for(let h=0;h<8;++h)I$g(V$1[h],V$1[h],i.camera.viewMatrix);r$B(W,V$1[0]),r$B(B$1,V$1[0]);for(let h=1;h<8;++h)for(let t=0;t<3;++t)W[t]=Math.min(W[t],V$1[h][t]),B$1[t]=Math.max(B$1[t],V$1[h][t]);W[2]-=200,B$1[2]+=200,i.camera.near=-B$1[2],i.camera.far=-W[2],this.warp?this.constructTrapezoidalProjection(e,a,i):this.constructOrthogonalProjection(i),e$G(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);const d=this.textureSize/2;i.camera.viewport[0]=t%2==0?0:d,i.camera.viewport[1]=0===Math.floor(t/2)?0:d,i.camera.viewport[2]=d,i.camera.viewport[3]=d;}constructOrthogonalProjection(t){E$n(t.camera.projectionMatrix,W[0],B$1[0],W[1],B$1[1],t.camera.near,t.camera.far);}constructTrapezoidalProjection(t,e,a){const i=1/V$1[0][3],r=1/V$1[4][3];i$13(i<r);let h=i+Math.sqrt(i*r);const o=Math.sin(l$B(t[2]*e[0]+t[6]*e[1]+t[10]*e[2]));h/=o,lt(V$1,h,o,J$1,K$1,Q$1,Y$2,Z$1),Tt(J$1,K$1,Y$2,Z$1,a.camera.projectionMatrix),a.camera.projectionMatrix[10]=2/(W[2]-B$1[2]),a.camera.projectionMatrix[14]=-(W[2]+B$1[2])/(W[2]-B$1[2]);}setupMatrices(t,s){e$G(X$1,t.projectionMatrix,t.viewMatrix),h$x(q$1,X$1);const e=1===this.viewingMode?t.eye:o$C(tt,0,0,1);F$d($$1,[0,0,0],[-s[0],-s[1],-s[2]],e);}clampNearFar(t){let{near:s,far:e}=t;return s<2&&(s=2),e<2&&(e=2),s>=e&&(s=2,e=4),{near:s,far:e}}computeCascadeDistances(t,s){this.numCascades=Math.min(1+Math.floor(q$m(t/s,4)),this.maxNumCascades);const a=(t-s)/this.numCascades,i=(t/s)**(1/this.numCascades);let r=s,h=s;for(let o=0;o<this.numCascades+1;++o)this.cascadeDistances[o]=s$F(r,h,this.splitSchemeLambda),r*=i,h+=a;}get gpuMemoryUsage(){var t,s;return this._snapshots.reduce(((t,s)=>t+n$15(s)),null!=(t=null==(s=this.fbo)?void 0:s.gpuMemoryUsage)?t:0)}get test(){const t=this;return {maxNumCascades:this.maxNumCascades,cascades:this.cascades,textureSize:this.textureSize,depthTexture:this._depthTexture,set splitSchemeLambda(s){t.splitSchemeLambda=s;},get splitSchemeLambda(){return t.splitSchemeLambda},set warp(s){t.warp=s;},get warp(){return t.warp}}}}const I=e$y(),X$1=e$y(),q$1=e$y(),G=n$P(),V$1=[];for(let wt=0;wt<8;++wt)V$1.push(n$P());const W=n$F(),B$1=n$F(),J$1=n$Q(),K$1=n$Q(),Q$1=n$Q(),Y$2=n$Q(),Z$1=n$Q(),$$1=e$y(),tt=n$F(),st=[],et=e$y(),at=new Float32Array(64),it=n$Q(),rt=n$Q(),ht=[n$Q(),n$Q(),n$Q(),n$Q()],ot=n$Q(),ct=n$Q(),nt=n$Q(),ut=n$Q(),dt=n$Q(),mt=n$Q(),pt=n$Q();function lt(t,s,e,a,i,r,h,o){r$K(it,0,0);for(let m=0;m<4;++m)s$Y(it,it,t[m]);l$W(it,it,.25),r$K(rt,0,0);for(let m=4;m<8;++m)s$Y(rt,rt,t[m]);l$W(rt,rt,.25),_$h(ht[0],t[4],t[5],.5),_$h(ht[1],t[5],t[6],.5),_$h(ht[2],t[6],t[7],.5),_$h(ht[3],t[7],t[4],.5);let c=0,n=q$n(ht[0],it);for(let m=1;m<4;++m){const t=q$n(ht[m],it);t<n&&(n=t,c=m);}o$P(ot,ht[c],t[c+4]);const u=ot[0];let d,M;ot[0]=-ot[1],ot[1]=u,o$P(ct,rt,it),j$y(ct,ot)<0&&x$y(ot,ot),_$h(ot,ot,ct,e),v$y(ot,ot),d=M=j$y(o$P(nt,t[0],it),ot);for(let m=1;m<8;++m){const s=j$y(o$P(nt,t[m],it),ot);s<d?d=s:s>M&&(M=s);}a$Y(a,it),l$W(nt,ot,d-s),s$Y(a,a,nt);let _=-1,C=1,j=0,v=0;for(let m=0;m<8;++m){o$P(ut,t[m],a),v$y(ut,ut);const s=ot[0]*ut[1]-ot[1]*ut[0];s>0?s>_&&(_=s,j=m):s<C&&(C=s,v=m);}f$J(_>0,"leftArea"),f$J(C<0,"rightArea"),l$W(dt,ot,d),s$Y(dt,dt,it),l$W(mt,ot,M),s$Y(mt,mt,it),pt[0]=-ot[1],pt[1]=ot[0];const z=v$z(a,t[v],mt,s$Y(nt,mt,pt),1,i),D=v$z(a,t[j],mt,nt,1,r),U=v$z(a,t[j],dt,s$Y(nt,dt,pt),1,h),y=v$z(a,t[v],dt,nt,1,o);f$J(z,"rayRay"),f$J(D,"rayRay"),f$J(U,"rayRay"),f$J(y,"rayRay");}function ft(t,s){return 3*s+t}const xt=n$Q();function bt(t,s){return r$K(xt,t[s],t[s+3]),xt}const gt=n$Q(),St=e$A();function Tt(t,s,e,a,i){o$P(gt,e,a),l$W(gt,gt,.5),St[0]=gt[0],St[1]=gt[1],St[2]=0,St[3]=gt[1],St[4]=-gt[0],St[5]=0,St[6]=gt[0]*gt[0]+gt[1]*gt[1],St[7]=gt[0]*gt[1]-gt[1]*gt[0],St[8]=1,St[ft(0,2)]=-j$y(bt(St,0),t),St[ft(1,2)]=-j$y(bt(St,1),t);let r=j$y(bt(St,0),e)+St[ft(0,2)],h=j$y(bt(St,1),e)+St[ft(1,2)],o=j$y(bt(St,0),a)+St[ft(0,2)],c=j$y(bt(St,1),a)+St[ft(1,2)];r=-(r+o)/(h+c),St[ft(0,0)]+=St[ft(1,0)]*r,St[ft(0,1)]+=St[ft(1,1)]*r,St[ft(0,2)]+=St[ft(1,2)]*r,r=1/(j$y(bt(St,0),e)+St[ft(0,2)]),h=1/(j$y(bt(St,1),e)+St[ft(1,2)]),St[ft(0,0)]*=r,St[ft(0,1)]*=r,St[ft(0,2)]*=r,St[ft(1,0)]*=h,St[ft(1,1)]*=h,St[ft(1,2)]*=h,St[ft(2,0)]=St[ft(1,0)],St[ft(2,1)]=St[ft(1,1)],St[ft(2,2)]=St[ft(1,2)],St[ft(1,2)]+=1,r=j$y(bt(St,1),s)+St[ft(1,2)],h=j$y(bt(St,2),s)+St[ft(2,2)],o=j$y(bt(St,1),e)+St[ft(1,2)],c=j$y(bt(St,2),e)+St[ft(2,2)],r=-.5*(r/h+o/c),St[ft(1,0)]+=St[ft(2,0)]*r,St[ft(1,1)]+=St[ft(2,1)]*r,St[ft(1,2)]+=St[ft(2,2)]*r,r=j$y(bt(St,1),s)+St[ft(1,2)],h=j$y(bt(St,2),s)+St[ft(2,2)],o=-h/r,St[ft(1,0)]*=o,St[ft(1,1)]*=o,St[ft(1,2)]*=o,i[0]=St[0],i[1]=St[1],i[2]=0,i[3]=St[2],i[4]=St[3],i[5]=St[4],i[6]=0,i[7]=St[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=St[6],i[13]=St[7],i[14]=0,i[15]=St[8];}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var E;let V=E=class extends p$N{constructor(e,t,i,r,a,c){super({}),this._rctx=e,this._stage=i,this._prepareForShadowMapPass=r,this._renderToShadowMap=a,this._requestRender=c,this._progress=0,this._sampleCount=0,this._cachedCamera=new J$d,this._contentCamera=new J$d,this._enabled=!1,this._cachedLightDirections=[],this._depthRange=f$5,this._previewing=!1,this._handles=new u$D,this._cameraForcedForScreenshot=!1,this._shadowMap=new H$1(e,i.viewingMode),this._shadowMap.enabled=!0,this._vao=i$N(e);const _={colorTarget:0,depthStencilTarget:0,width:0,height:0},u={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this._fbo=new l$F(e,_,u),this._accumulationParams={camera:this._cachedCamera,linearDepthTexture:null,shadowMap:this._shadowMap,inverseView:e$y(),projInfo:n$P(),zScale:n$Q()},this._accumulationRenderer=new v$3(t,e,this,c);const l=this._stage.resourceController.scheduler;this._handles.add(l.registerTask(f$u.SHADOW_ACCUMULATOR,this)),this._handles.add(i$Q((()=>i.renderView),(e=>{this._handles.remove(E.renderViewHandleKey),t$F(e)||this._handles.add(e.events.on("force-camera-for-screenshot",(()=>this._cameraForcedForScreenshot=!0)),E.renderViewHandleKey);}),p$R));}normalizeCtorArgs(){return {}}get computedSamples(){return this._progress}get shadowCastTexture(){return this._fbo.colorTexture}get isAccumulating(){return this._isPreviewing||this._isRefining}get accumulationTechnique(){if(t$F(this._accumulationTechnique)){const e={rctx:this._rctx,viewingMode:this._stage.viewingMode},t=new d$4;t.pass=0,this._accumulationTechnique=new c$6(e,t);}return this._accumulationTechnique}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return this._enabled&&this._sampleCount>0}get _canAccumulate(){return null!==this._accumulationParams.linearDepthTexture&&this._depthRange!==f$5&&this._opacityFromElevation>p$4}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(e){const t=this._cachedLightDirections;if(l$N(t,e,G$f))return;const s=e.length;t.length=s,this._sampleCount=Math.min(i$5,s);for(let i=0;i<s;++i){const s=e[i],r=t[i]||n$F();r$B(r,s),t[i]=r;}this._invalidate();}get _projInfo(){return this._accumulationParams.projInfo}get _zScale(){return this._accumulationParams.zScale}get _inverseView(){return this._accumulationParams.inverseView}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e;}get running(){return this._isRefining&&this._canAccumulate}runTask(e){for(this._prepareForShadowMapPass(this._cachedCamera,this._contentCamera);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender();}accumulateFixedSamples(){if(!this.isAccumulating||!this._canAccumulate)return;(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();const e=this._cameraForcedForScreenshot?this._sampleCount:Math.min(E.previewSamples,this._sampleCount-this._progress);for(let t=0;t<e;++t)this._accumulateShadow();this._cameraForcedForScreenshot=!1;}render(){this._accumulationRenderer.render();}dispose(){this._stop(),this._handles.destroy(),this._accumulationRenderer=i$M(this._accumulationRenderer),this._shadowMap=i$M(this._shadowMap),this._fbo=i$M(this._fbo),this._vao=i$M(this._vao),this._accumulationTechnique=i$M(this._accumulationTechnique),this._cachedLightDirections.length=0,this._sampleCount=0;}setOptions(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.previewing&&this.setPreviewing(e.previewing),void 0!==e.lightDirections&&this.setLightDirections(e.lightDirections),this._accumulationRenderer.setOptions(e);}setPreviewing(e){this._previewing!==e&&(this._previewing=e,this._requestRenderIfEnabled());}setLightDirections(e){this._lightDirections=e;}setAccumulationDependencies(e,t,i,s){this._accumulationParams.linearDepthTexture=e,this._depthRange=t,this._updateCamera(i),this._contentCamera=s,this.notifyChange("_canAccumulate");}readAccumulatedShadow(e,t){if(!this._isActive||this._progress<1||e<0||e>this._fbo.width||t<0||t>this._fbo.height)return 0;const i=k;return this._fbo.readPixels(e,t,1,1,6408,5121,i),i[0]/this._progress}_start(){this._progress=0,this._enabled=!0;}_stop(){this._enabled=!1;}_invalidate(){this._progress=0,this._requestRenderIfEnabled();}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(16384),this._progress=0;}_accumulateShadow(){const e=this._lightDirections[this._progress],t=this._cachedCamera;this._renderToShadowMap(this._shadowMap,e,t,this._depthRange),this._rctx.bindFramebuffer(this._fbo);const i=this.accumulationTechnique;this._rctx.useProgram(i.program),i.bindPipelineState(this._rctx),i.bindPass(this._accumulationParams),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(i.primitiveType,0,r$O(this._vao,"geometry")),this._progress++;}_updateCamera(e){if(e.equals(this._cachedCamera))return;const{fullWidth:t,fullHeight:i,projectionMatrix:s,viewMatrix:o,center:a}=e;this._cachedCamera.copyFrom(e),this._fbo.resize(t,i),D$l(s,t,i,this._projInfo,this._zScale),c$U(this._inverseView,o,a),h$x(this._inverseView,this._inverseView),this._opacityFromElevation=1-I$n(d$3,m$3,e.relativeElevation);}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop());}_requestRenderIfEnabled(){this._enabled&&this._requestRender();}get test(){return {lightDirections:this._lightDirections,isDone:()=>this._isDoneAccumulating,isActive:()=>this._isActive}}};V.previewSamples=6,V.renderViewHandleKey="renderView",e$x([d$y()],V.prototype,"_progress",void 0),e$x([d$y()],V.prototype,"_sampleCount",void 0),e$x([d$y()],V.prototype,"_enabled",void 0),e$x([d$y()],V.prototype,"_depthRange",void 0),e$x([d$y()],V.prototype,"_previewing",void 0),e$x([d$y()],V.prototype,"_accumulationRenderer",void 0),e$x([d$y()],V.prototype,"_isRefining",null),e$x([d$y()],V.prototype,"_isActive",null),e$x([d$y()],V.prototype,"_canAccumulate",null),e$x([d$y()],V.prototype,"_isDoneAccumulating",null),e$x([d$y()],V.prototype,"_opacityFromElevation",null),e$x([d$y()],V.prototype,"running",null),V=E=e$x([i$H("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],V);const k=new Uint8Array(4);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function h$3(h){const c=new n$N;return c.include(t$12),c.fragment.include(a$V),c.fragment.include(a$U),c.include(o$Z),c.include(o$Y),c.fragment.uniforms.add("defaultDepthTex","sampler2D").add("highlightDepthTex","sampler2D").add("depthMap","sampler2D").add("highlightMap","sampler2D").add("color","vec4").add("nearFar","vec2").add("opacity","float").add("occludedOpacity","float").add("terminationFactor","float").add("inverseView","mat4").add("lightingMainDirectionView","vec3").add("texelSize","vec2"),c.fragment.constants.add("unoccludedHighlightFlag","vec4",o$_).add("highlightedThreshold","float",h.highlightedThreshold).add("selfShadowThreshold","float",h.selfShadowThreshold),c.fragment.code.add(t$J`vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, vec2 uv, vec2 texelSize, sampler2D depthMap, vec2 nearFar) {
float leftPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(-1.0, 0.0) * texelSize, nearFar);
float rightPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(1.0, 0.0) * texelSize, nearFar);
float bottomPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, -1.0) * texelSize, nearFar);
float topPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, 1.0) * texelSize, nearFar);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`),c.fragment.code.add(t$J`void main(void) {
vec4 highlightInfo = texture2D(highlightMap, uv);
float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;
if (visiblyHighlighted > highlightedThreshold) {
discard;
}
float depth = rgba2float(texture2D(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseView * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= uShadowMapNum) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
bool shadowHighlight = depthHighlight < lvpos.z;
if (!shadowHighlight) {
discard;
}
float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
bool shadowDefault = depthDefault < lvpos.z;
vec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, uv, texelSize, depthMap, nearFar);
bool shaded = dot(normal, lightingMainDirectionView) < selfShadowThreshold;
float differenceOpacity = opacity;
float bothOpacity = occludedOpacity;
float fragOpacity = (shadowDefault || shaded) ? bothOpacity : differenceOpacity;
gl_FragColor = vec4(color.rgb, color.a * fragOpacity * terminationFactor);
}`),c}const c$4=Object.freeze({__proto__:null,build:h$3});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const w$2=0,b=1;class j extends t$L{initializeProgram(r){const e=j.shader.get().build({highlightedThreshold:.99999,selfShadowThreshold:.025});return new n$O(r.rctx,e,o$F)}initializePipeline(r){return g$v({blending:e$E(770,1,771,771),colorWrite:r$J,depthTest:null,depthWrite:null})}bindPass(a,o){if(t$F(o.linearDepthTexture))return;this.program.bindTexture(o.linearDepthTexture,"depthMap"),this.program.bindTexture(o.highlightColorTexture,"highlightMap"),I$g(v$2,o.lighting.lightingMainDirection,o.camera.viewInverseTransposeMatrix),j$p(v$2,v$2),D$l(o.camera.projectionMatrix,o.camera.fullWidth,o.camera.fullHeight,S$1,M$1),c$U(U,o.camera.viewMatrix,o.camera.center),h$x(U,U),this.program.setUniform4fv("color",a.shadowColor),this.program.setUniform1f("opacity",a.shadowOpacity),this.program.setUniform1f("occludedOpacity",a.occludedShadowOpacity),this.program.setUniform1f("terminationFactor",a.opacityElevation*a.dayNightTerminator),this.program.setUniform2fv("nearFar",o.camera.nearFar),this.program.setUniformMatrix4fv("inverseView",U),this.program.setUniform4fv("projInfo",S$1),this.program.setUniform2fv("zScale",M$1),this.program.setUniform3fv("lightingMainDirectionView",v$2),this.program.setUniform2f("texelSize",1/o.linearDepthTexture.descriptor.width,1/o.linearDepthTexture.descriptor.height),o.shadowMap.bind(this.program),o.shadowMap.bindView(this.program,o.camera.center);let n=o.shadowMap.getSnapshot(w$2);r$A(n)&&this.program.bindTexture(n,"highlightDepthTex"),n=o.shadowMap.getSnapshot(b),r$A(n)&&this.program.bindTexture(n,"defaultDepthTex");}get primitiveType(){return 5}}j.shader=new t$M(c$4,(()=>import('./ShadowHighlight.glsl-34612758.js')));const v$2=n$F(),M$1=n$Q(),S$1=n$P(),U=e$y();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const _$1=.001953125,d$2=4e4,l$5=5e4;class u$5{constructor(t,i){this._rctx=t,this._viewingMode=i,this._maxOpacity=1,this._parameters={shadowColor:r$V(1,0,1,1),shadowOpacity:.2,occludedShadowOpacity:.1,opacityElevation:1,dayNightTerminator:1},this._vao=i$N(this._rctx);}get technique(){return t$F(this._technique)&&(this._technique=new j({rctx:this._rctx,viewingMode:this._viewingMode},null)),this._technique}render(t,i){if(this._updateParameters(t),!t.shadowMap.enabled||!t.linearDepthTexture||!this.isVisible)return;const e=this.technique;this._rctx.bindFramebuffer(i),this._rctx.useProgram(e.program),e.bindPipelineState(this._rctx),e.bindPass(this._parameters,t),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(e.primitiveType,0,r$O(this._vao,"geometry"));}get gpuMemoryUsage(){var t,i;return null!=(t=null==(i=this._vao)?void 0:i.size)?t:0}setDefaultOptions(t){this._parameters={...this._parameters,...t},this._updateMaxOpacity();}_updateParameters(e){this._parameters.opacityElevation=1-I$n(d$2,l$5,e.camera.relativeElevation);const a=1===this._viewingMode?j$p(g,e.camera.center):o$C(g,0,0,1),o=z$i(a,e.lighting.lightingMainDirection);this._parameters.dayNightTerminator=I$n(0,1,e$B(30*o,0,1));}dispose(){this._vao=i$M(this._vao),this._technique=i$M(this._technique);}get isVisible(){return this._maxOpacity*this._parameters.opacityElevation*this._parameters.dayNightTerminator>=_$1}_updateMaxOpacity(){const t=this._parameters,i=t.shadowColor,e=Math.max(t.shadowOpacity,t.occludedShadowOpacity);this._maxOpacity=e*i[3];}}const g=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const t$6=G$h();class n$4{constructor(){this._worldPlane=t$6;}get isEnabled(){return this.plane!==t$6}get plane(){return this._worldPlane}set plane(e){this._worldPlane=e||t$6;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function t$5(t){const r=new n$N;return 0===t.output&&(r.attributes.add("position","vec2"),r.vertex.uniforms.add("uResolution","vec4"),r.varyings.add("fTexCoord","vec2"),r.varyings.add("fOffset[3]","vec4"),r.vertex.code.add(t$J`void SMAAEdgeDetectionVS( vec2 texcoord ) {
fOffset[0] = texcoord.xyxy + uResolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 );
fOffset[1] = texcoord.xyxy + uResolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 );
fOffset[2] = texcoord.xyxy + uResolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 );
}
void main() {
fTexCoord = (position + 1.0 ) * 0.5;
gl_Position = vec4(position, 0, 1);
SMAAEdgeDetectionVS( fTexCoord );
}`),r.fragment.uniforms.add("tColor","sampler2D"),r.fragment.code.add(t$J`
      vec4 SMAAColorEdgeDetectionPS( vec2 texcoord, vec4 offset[3], sampler2D colorTex ) {
        vec2 threshold = vec2( ${t$J.float(t.threshold)} );

        // Calculate color deltas:
        vec4 delta;
        vec3 C = texture2D( colorTex, texcoord ).rgb;

        vec3 Cleft = texture2D( colorTex, offset[0].xy ).rgb;
        vec3 t = abs( C - Cleft );
        delta.x = max( max( t.r, t.g ), t.b );

        vec3 Ctop = texture2D( colorTex, offset[0].zw ).rgb;
        t = abs( C - Ctop );
        delta.y = max( max( t.r, t.g ), t.b );

        // We do the usual threshold:
        vec2 edges = step( threshold, delta.xy );

        // Then discard if there is no edge:
        if ( dot( edges, vec2( 1.0, 1.0 ) ) == 0.0 )
            discard;

        // Calculate right and bottom deltas:
        vec3 Cright = texture2D( colorTex, offset[1].xy ).rgb;
        t = abs( C - Cright );
        delta.z = max( max( t.r, t.g ), t.b );

        vec3 Cbottom  = texture2D( colorTex, offset[1].zw ).rgb;
        t = abs( C - Cbottom );
        delta.w = max( max( t.r, t.g ), t.b );

        // Calculate the maximum delta in the direct neighborhood:
        float maxDelta = max( max( max( delta.x, delta.y ), delta.z ), delta.w );

        // Calculate left-left and top-top deltas:
        vec3 Cleftleft  = texture2D( colorTex, offset[2].xy ).rgb;
        t = abs( C - Cleftleft );
        delta.z = max( max( t.r, t.g ), t.b );

        vec3 Ctoptop = texture2D( colorTex, offset[2].zw ).rgb;
        t = abs( C - Ctoptop );
        delta.w = max( max( t.r, t.g ), t.b );

        // Calculate the final maximum delta:
        maxDelta = max( max( maxDelta, delta.z ), delta.w );

        // Local contrast adaptation in action:
        edges.xy *= step( maxDelta, float(${t$J.float(t.localConstrastAdaption)}) * delta.xy );

        return vec4( edges, 0.0, 0.0 );
      }

      void main() {
        gl_FragColor = SMAAColorEdgeDetectionPS( fTexCoord, fOffset, tColor );
      }
    `)),1===t.output&&(r.attributes.add("position","vec2"),r.vertex.uniforms.add("uResolution","vec4"),r.varyings.add("fTexCoord","vec2"),r.varyings.add("fOffset[3]","vec4"),r.varyings.add("fPixCoord","vec2"),r.vertex.code.add(t$J`
      void SMAABlendingWeightCalculationVS( vec2 texcoord ) {
        fPixCoord = texcoord * uResolution.zw;
        fOffset[0] = texcoord.xyxy + uResolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );
        fOffset[1] = texcoord.xyxy + uResolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );
        fOffset[2] = vec4( fOffset[0].xz, fOffset[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * uResolution.xxyy * float( ${t$J.int(t.maxSearchSteps)} );
      }

      void main() {
        fTexCoord = (position + 1.0 ) * 0.5;
        gl_Position = vec4(position, 0, 1);
        SMAABlendingWeightCalculationVS( fTexCoord );
      }
    `),r.fragment.uniforms.add("tEdges","sampler2D").add("tArea","sampler2D").add("tSearch","sampler2D").add("tColor","sampler2D").add("uResolution","vec4"),r.fragment.code.add(t$J`
      #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )
      #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )

      vec4 SMAASampleLevelZeroOffset(sampler2D tex, vec2 coord, vec2 offset) {
        return texture2D( tex, coord + offset.x * uResolution.xy, 0.0 );
      }

      vec2 round( vec2 x ) {
        return sign( x ) * floor( abs( x ) + 0.5 );
      }

      float SMAASearchLength( sampler2D searchTex, vec2 e, float bias, float scale ) {
        e.r = bias + e.r * scale;
        return 255.0 * texture2D( searchTex, e, 0.0 ).r;
      }

      float SMAASearchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${t$J.int(t.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 2.0, 0.0 ) * uResolution.xy;
          if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x += 0.25 * uResolution.x;
        texcoord.x += uResolution.x;
        texcoord.x += 2.0 * uResolution.x;
        texcoord.x -= uResolution.x * SMAASearchLength(searchTex, e, 0.0, 0.5);
        return texcoord.x;
      }

      float SMAASearchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${t$J.int(t.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 2.0, 0.0 ) * uResolution.xy;
          if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x -= 0.25 * uResolution.x;
        texcoord.x -= uResolution.x;
        texcoord.x -= 2.0 * uResolution.x;
        texcoord.x += uResolution.x * SMAASearchLength( searchTex, e, 0.5, 0.5 );
        return texcoord.x;
      }

      float SMAASearchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${t$J.int(t.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 0.0, 2.0 ) * uResolution.xy;
          if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y -= 0.25 * uResolution.y;
        texcoord.y -= uResolution.y;
        texcoord.y -= 2.0 * uResolution.y;
        texcoord.y += uResolution.y * SMAASearchLength( searchTex, e.gr, 0.0, 0.5 );
        return texcoord.y;
      }

      float SMAASearchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${t$J.int(t.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 0.0, 2.0 ) * uResolution.xy;
          if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y += 0.25 * uResolution.y;
        texcoord.y += uResolution.y;
        texcoord.y += 2.0 * uResolution.y;
        texcoord.y -= uResolution.y * SMAASearchLength( searchTex, e.gr, 0.5, 0.5 );
        return texcoord.y;
      }

      vec2 SMAAArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {
        vec2 texcoord = float( ${t$J.int(t.maxDistanceAreaTex)} ) * round( 4.0 * vec2( e1, e2 ) ) + dist;
        texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );
        texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;
        return texture2D( areaTex, texcoord, 0.0 ).rg;
      }

      vec4 SMAABlendingWeightCalculationPS( vec2 texcoord, vec2 pixcoord, vec4 offset[ 3 ], sampler2D edgesTex, sampler2D areaTex, sampler2D searchTex, ivec4 subsampleIndices ) {
        vec4 weights = vec4( 0.0, 0.0, 0.0, 0.0 );
        vec2 e = texture2D( edgesTex, texcoord ).rg;
        if ( e.g > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.x = SMAASearchXLeft( edgesTex, searchTex, offset[ 0 ].xy, offset[ 2 ].x );
          coords.y = offset[ 1 ].y;
          d.x = coords.x;
          float e1 = texture2D( edgesTex, coords, 0.0 ).r;
          coords.x = SMAASearchXRight( edgesTex, searchTex, offset[ 0 ].zw, offset[ 2 ].y );
          d.y = coords.x;
          d = d * uResolution.z - pixcoord.x;
          vec2 sqrt_d = sqrt( abs( d ) );
          coords.y -= 1.0 * uResolution.y;
          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 1.0, 0.0 ) ).r;
          weights.rg = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.y ) );
        }

        if ( e.r > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.y = SMAASearchYUp( edgesTex, searchTex, offset[ 1 ].xy, offset[ 2 ].z );
          coords.x = offset[ 0 ].x;
          d.x = coords.y;
          float e1 = texture2D( edgesTex, coords, 0.0 ).g;
          coords.y = SMAASearchYDown( edgesTex, searchTex, offset[ 1 ].zw, offset[ 2 ].w );
          d.y = coords.y;
          d = d * uResolution.w - pixcoord.y;
          vec2 sqrt_d = sqrt( abs( d ) );
          coords.y -= 1.0 * uResolution.y;
          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 0.0, 1.0 ) ).g;
          weights.ba = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.x ) );

          // for some reason the following lines are necessary to prevent
          // texture lookup precision issues on some Intel integrated graphics chips
          vec4 dbg = (offset[ 0 ]+offset[ 1 ]+offset[ 2 ] + coords.xyyx);
          weights.r += 0.00000001 * dot(vec4(0,1,0,1),dbg);
        }
        return weights;
      }

      void main() {
        gl_FragColor = SMAABlendingWeightCalculationPS( fTexCoord, fPixCoord, fOffset, tEdges, tArea, tSearch, ivec4( 0.0 ) );
      }
    `)),2===t.output&&(r.attributes.add("position","vec2"),r.vertex.uniforms.add("uResolution","vec4"),r.varyings.add("fTexCoord","vec2"),r.varyings.add("fOffset[2]","vec4"),r.vertex.code.add(t$J`void SMAANeighborhoodBlendingVS( vec2 texcoord ) {
fOffset[0] = texcoord.xyxy + uResolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 );
fOffset[1] = texcoord.xyxy + uResolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 );
}
void main() {
fTexCoord = (position + 1.0 ) * 0.5;
gl_Position = vec4(position, 0, 1);
SMAANeighborhoodBlendingVS(fTexCoord);
}`),r.fragment.uniforms.add("tBlendWeights","sampler2D"),r.fragment.uniforms.add("tColor","sampler2D"),r.fragment.uniforms.add("uResolution","vec4"),r.fragment.code.add(t$J`vec4 SMAANeighborhoodBlendingPS( vec2 texcoord, vec4 offset[ 2 ], sampler2D colorTex, sampler2D blendTex ) {
vec4 a;
a.xz = texture2D( blendTex, texcoord ).xz;
a.y = texture2D( blendTex, offset[ 1 ].zw ).g;
a.w = texture2D( blendTex, offset[ 1 ].xy ).a;
if ( dot(a, vec4( 1.0, 1.0, 1.0, 1.0 )) < 1e-5 ) {
return texture2D( colorTex, texcoord, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture2D( colorTex, texcoord, 0.0 );
texcoord += sign( offset ) * uResolution.xy;
vec4 Cop = texture2D( colorTex, texcoord, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
vec4 mixed = mix(C, Cop, s);
return mixed;
}
}
void main() {
gl_FragColor = SMAANeighborhoodBlendingPS( fTexCoord, fOffset, tColor, tBlendWeights );
}`)),r}const r$1=Object.freeze({__proto__:null,build:t$5});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class h$2 extends t$L{initializeProgram(e){const r=h$2.shader.get(),t=this.configuration,o=r.build({output:t.output,threshold:.05,localConstrastAdaption:2,maxSearchSteps:8,maxDistanceAreaTex:16});return new n$O(e.rctx,o,o$F)}initializePipeline(){return g$v({colorWrite:r$J})}}h$2.shader=new t$M(r$1,(()=>import('./SMAA.glsl-7a68c340.js')));class m$2 extends t$K{constructor(){super(...arguments),this.output=0;}}e$x([e$D({count:3})],m$2.prototype,"output",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let _=class extends p$N{constructor(e,t){super({}),this.rctx=e,this._techniqueRep=t,this._isEnabled=!1;}normalizeCtorArgs(){return {}}dispose(){this._abortController=a$X(this._abortController),this.disable();}_loadResources(e){if(r$A(this._abortController))return !1;if(r$A(this._searchTexture))return !0;this._abortController=new AbortController;const t=this._abortController.signal;return import('./SmaaRenderPassData-0cecc86b.js').then((e=>this._loadTextures(e,t))).then((()=>e())).finally((()=>this._abortController=null)),!1}_loadTextures(e,t){return h$B(t),Promise.all([this.loadTextureFromBase64(e.areaTexture,9729,6407),this.loadTextureFromBase64(e.searchTexure,9728,6409)]).then((([e,r])=>{p$T(t)?(e.dispose(),r.dispose(),h$B(t)):(this._areaTexture=e,this._searchTexture=r);}))}get updating(){return r$A(this._abortController)}enable(e){if(this._isEnabled)return !0;if(!this._edgeDetectTechnique||!this._blendWeights||!this._blur){const e=new m$2,t=(e,t)=>this._techniqueRep.releaseAndAcquire(h$2,e,t);e.output=0,this._edgeDetectTechnique=t(e,this._edgeDetectTechnique),e.output=1,this._blendWeights=t(e,this._blendWeights),e.output=2,this._blur=t(e,this._blur);}return !!this._loadResources(e)&&(this._vao=l$X(this.rctx),this._edges=new l$F(this.rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6407,dataType:5121,samplingMode:9729,wrapMode:33071,width:4,height:4}),this._blend=new l$F(this.rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:4,height:4}),this._isEnabled=!0,!0)}disable(){this._isEnabled&&(this._vao=i$M(this._vao),this._areaTexture=i$M(this._areaTexture),this._searchTexture=i$M(this._searchTexture),this._blend=i$M(this._blend),this._edges=i$M(this._edges),this._isEnabled=!1);}render(e){if(!this._isEnabled)return;const t=this.rctx,r=t.getBoundFramebufferObject(),i={x:0,y:0,width:e.descriptor.width,height:e.descriptor.height};t.bindVAO(this._vao),this._edgeDetectTechnique.bindPipelineState(t),t.setViewport(i.x,i.y,i.width,i.height),this._edges.resize(i.width,i.height),t.bindFramebuffer(this._edges),t.setClearColor(0,0,0,1),t.clear(16384),t.useProgram(this._edgeDetectTechnique.program),this._edgeDetectTechnique.program.bindTexture(e,"tColor"),this._edgeDetectTechnique.program.setUniform4f("uResolution",1/i.width,1/i.height,i.width,i.height),t.drawArrays(4,0,3),this._blend.resize(i.width,i.height),t.bindFramebuffer(this._blend),t.setClearColor(0,0,1,1),t.clear(16384),t.useProgram(this._blendWeights.program),this._blendWeights.program.setUniform4f("uResolution",1/i.width,1/i.height,i.width,i.height),this._blendWeights.program.bindTexture(this._searchTexture,"tSearch"),this._blendWeights.program.bindTexture(this._areaTexture,"tArea"),this._blendWeights.program.bindTexture(this._edges.colorTexture,"tEdges"),t.drawArrays(4,0,3),t.bindFramebuffer(r),t.setClearColor(0,1,0,1),t.clear(16384),t.useProgram(this._blur.program),this._blur.program.setUniform4f("uResolution",1/i.width,1/i.height,i.width,i.height),this._blur.program.bindTexture(e,"tColor"),this._blur.program.bindTexture(this._blend.colorTexture,"tBlendWeights"),t.drawArrays(4,0,3);}loadTextureFromBase64(e,t,r){const i=new o$G(this.rctx,{pixelFormat:r,dataType:5121,wrapMode:33071,samplingMode:t},null);return t$R(e).then((e=>(i.resize(e.width,e.height),i.setData(e),i)))}};e$x([d$y()],_.prototype,"_abortController",void 0),e$x([d$y({readOnly:!0})],_.prototype,"updating",null),_=e$x([i$H("esri.views.3d.webgl-engine.lib.SmaaRenderPass")],_);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function n$3(n){const s=new n$N;return s.include(o$Y),1===n.output&&(s.fragment.include(a$U),s.fragment.uniforms.add("normalMap","sampler2D").add("depthMap","sampler2D").add("tex","sampler2D").add("blurSize","vec2").add("projScale","float").add("nearFar","vec2"),s.fragment.code.add(t$J`
      void blurFunction(vec2 uv, float r, float center_d, float sharpness, inout float wTotal, inout float bTotal) {
        float c = texture2D(tex, uv).r;
        float d = linearDepthFromTexture(depthMap, uv, nearFar);

        float ddiff = d - center_d;

        float w = exp(-r * r * ${t$J.float(n.blurFalloff)} - ddiff * ddiff * sharpness);
        wTotal += w;
        bTotal += w * c;
      }
    `),s.fragment.code.add(t$J`
      void main(void) {
        float b = 0.0;
        float w_total = 0.0;

        float center_d = linearDepthFromTexture(depthMap, uv, nearFar);

        float sharpness = -0.05 * projScale/center_d;
        for (int r = -${t$J.int(n.filterRadius)}; r <= ${t$J.int(n.filterRadius)}; ++r) {
          float rf = float(r);
          vec2 uvOffset = uv + rf * blurSize;
          blurFunction(uvOffset, rf, center_d, sharpness, w_total, b);
        }

        gl_FragColor = vec4(b / w_total);
      }
    `)),0===n.output&&(s.fragment.include(a$U),s.include(o$Z),s.fragment.uniforms.add("normalMap","sampler2D").add("depthMap","sampler2D").add("intensity","float").add("projScale","float").add("radius","float").add("nearFar","vec2").add("screenDimensions","vec2").add("rnmScale","vec2").add("rnm","sampler2D"),s.fragment.code.add(t$J`vec3 sphere[16];
void fillSphere() {
sphere[0] = vec3(0.186937, 0.0, 0.0);
sphere[1] = vec3(0.700542, 0.0, 0.0);
sphere[2] = vec3(-0.864858, -0.481795, -0.111713);
sphere[3] = vec3(-0.624773, 0.102853, -0.730153);
sphere[4] = vec3(-0.387172, 0.260319, 0.007229);
sphere[5] = vec3(-0.222367, -0.642631, -0.707697);
sphere[6] = vec3(-0.01336, -0.014956, 0.169662);
sphere[7] = vec3(0.122575, 0.1544, -0.456944);
sphere[8] = vec3(-0.177141, 0.85997, -0.42346);
sphere[9] = vec3(-0.131631, 0.814545, 0.524355);
sphere[10] = vec3(-0.779469, 0.007991, 0.624833);
sphere[11] = vec3(0.308092, 0.209288,0.35969);
sphere[12] = vec3(0.359331, -0.184533, -0.377458);
sphere[13] = vec3(0.192633, -0.482999, -0.065284);
sphere[14] = vec3(0.233538, 0.293706, -0.055139);
sphere[15] = vec3(0.417709, -0.386701, 0.442449);
}
float fallOffFunction(float vv, float vn, float bias) {
float f = max(radius * radius - vv, 0.0);
return f * f * f * max(vn-bias, 0.0);
}`),s.fragment.code.add(t$J`float aoValueFromPositionsAndNormal(vec3 C, vec3 n_C, vec3 Q) {
vec3 v = Q - C;
float vv = dot(v, v);
float vn = dot(normalize(v), n_C);
return fallOffFunction(vv, vn, 0.1);
}`),s.fragment.code.add(t$J`
      void main(void) {
        fillSphere();
        vec3 fres = normalize((texture2D(rnm, uv * rnmScale).xyz * 2.0) - vec3(1.0));
        float currentPixelDepth = linearDepthFromTexture(depthMap, uv, nearFar);

        if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
          gl_FragColor = vec4(0.0);
          return;
        }

        vec3 currentPixelPos = reconstructPosition(gl_FragCoord.xy,currentPixelDepth);

        // get the normal of current fragment
        vec4 norm4 = texture2D(normalMap, uv);
        vec3 norm = vec3(-1.0) + 2.0 * norm4.xyz;
        bool isTerrain = norm4.w<0.5;

        float sum = .0;
        vec3 tapPixelPos;

        // note: the factor 2.0 should not be necessary, but makes ssao much nicer.
        // bug or deviation from CE somewhere else?
        float ps = projScale/(2.0 * currentPixelPos.z * zScale.x + zScale.y);

        for(int i = 0; i < ${t$J.int(n.samples)}; ++i) {
          vec2 unitOffset = reflect(sphere[i], fres).xy;
          vec2 offset = vec2(-unitOffset * radius * ps);

          //don't use current or very nearby samples
          if ( abs(offset.x)<2.0 || abs(offset.y)<2.0) continue;

          vec2 tc = vec2(gl_FragCoord.xy + offset);
          if (tc.x < 0.0 || tc.y < 0.0 || tc.x > screenDimensions.x || tc.y > screenDimensions.y) continue;
          vec2 tcTap = tc/screenDimensions;
          float occluderFragmentDepth = linearDepthFromTexture(depthMap, tcTap, nearFar);

          if (isTerrain) {
            bool isTerrainTap = texture2D(normalMap, tcTap).w<0.5;
            if (isTerrainTap) {
              continue;
            }
          }

          tapPixelPos = reconstructPosition(tc, occluderFragmentDepth);

          sum+= aoValueFromPositionsAndNormal(currentPixelPos, norm, tapPixelPos);
        }

        // output the result
        float A = max(1.0-sum*intensity/float(${t$J.int(n.samples)}),0.0);

        // Anti-tone map to reduce contrast and drag dark region farther: (x^0.2 + 1.2 * x^4)/2.2
        A = (pow(A, 0.2) + 1.2 * A*A*A*A) / 2.2;
        gl_FragColor = vec4(A);
      }
    `)),s}const s$3=Object.freeze({__proto__:null,build:n$3});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class m$1 extends t$L{initializeProgram(e){const r=m$1.shader.get(),t=this.configuration,s=(m$1.filterRadius+1)/2,o=1/(2*s*s),u=r.build({output:t.output,samples:m$1.samples,filterRadius:m$1.filterRadius,blurFalloff:o});return new n$O(e.rctx,u,o$F)}initializePipeline(){return g$v({colorWrite:r$J})}}m$1.shader=new t$M(s$3,(()=>import('./SSAO.glsl-9739a487.js'))),m$1.samples=16,m$1.filterRadius=4;class p$3 extends t$K{constructor(){super(...arguments),this.output=0;}}e$x([e$D({count:2})],p$3.prototype,"output",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class d$1{constructor(e,t,s){this._techniqueRep=e,this._rctx=t,this._requestRender=s,this._enabled=!1,this._ssaoTechniqueConfig=new p$3,this.quadVAO=null,this._blurSizePx=2,this._attenuation=.5;}dispose(){this.quadVAO=i$M(this.quadVAO);}set enabled(e){e?this._enable():this._disable();}get enabled(){return this._enabled}get ready(){return this.enabled&&r$A(this._noiseTexture)&&r$A(this._ssaoFBO)&&r$A(this._blur0FBO)&&r$A(this._blur1FBO)}computeSSAO(e,t,i){if(!this.enabled||t$F(t)||t$F(i)||t$F(this._noiseTexture)||t$F(this._ssaoFBO)||t$F(this._blur0FBO)||t$F(this._blur1FBO))return;const h=this._rctx,o=e.fullViewport,n=o[2],u=o[3],_=n/this._blurSizePx,b=u/this._blurSizePx;this._ssaoFBO.resize(n,u),this._blur0FBO.resize(_,b),this._blur1FBO.resize(_,b);const d=1,p=1,O=n*d,x=u*p;h.bindFramebuffer(this._ssaoFBO),h.setViewport(0,0,n,u);const F=this._ssaoTechnique.program;h.useProgram(F),this._ssaoTechnique.bindPipelineState(h),F.setUniform2f("rnmScale",n/this._noiseTexture.descriptor.width,u/this._noiseTexture.descriptor.height),D$l(e.projectionMatrix,e.fullWidth,e.fullHeight,f$3,c$3),F.setUniform4fv("projInfo",f$3),F.setUniform2fv("zScale",c$3),F.setUniform2f("nearFar",e.near,e.far);let g=1/e.computeRenderPixelSizeAtDist(1);F.setUniform1f("projScale",g*d),F.setUniform2f("screenDimensions",O,x);const T=q$g(e.eye,e.center);let B=20*e.computeRenderPixelSizeAtDist(T);B=Math.max(.1,B),F.setUniform1f("radius",B),F.setUniform1f("intensity",4*this._attenuation/B**6),F.bindTexture(this._noiseTexture,"rnm"),F.bindTexture(i,"normalMap"),F.bindTexture(t,"depthMap"),t$F(this.quadVAO)&&(this.quadVAO=i$N(this._rctx)),h.bindVAO(this.quadVAO),h.drawArrays(5,0,r$O(this.quadVAO,"geometry"));const q=this._blurTechnique.program;h.useProgram(q),q.bindTexture(this._ssaoFBO.colorTexture,"tex"),q.bindTexture(i,"normalMap"),q.bindTexture(t,"depthMap"),h.setViewport(0,0,O/this._blurSizePx,x/this._blurSizePx),h.bindFramebuffer(this._blur0FBO),q.setUniform2f("screenDimensions",O,x),q.setUniform2f("blurSize",0,this._blurSizePx*d/x),q.setUniform2f("nearFar",e.near,e.far),T>5e4&&(g=Math.max(0,g-(T-5e4))),q.setUniform1f("projScale",g),h.drawArrays(5,0,r$O(this.quadVAO,"geometry")),q.setUniform2f("blurSize",this._blurSizePx*p/O,0),h.bindFramebuffer(this._blur1FBO),q.bindTexture(this._blur0FBO.colorTexture,"tex"),h.drawArrays(5,0,r$O(this.quadVAO,"geometry")),h.setViewport(o[0],o[1],o[2],o[3]);}bind(e,s){this.enabled&&r$A(this._blur1FBO)&&r$A(this._ssaoFBO)?(e.bindTexture(this._blur1FBO.colorTexture,"ssaoTex"),e.setUniform4f("viewportPixelSz",s.fullViewport[0],s.fullViewport[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height)):e.setUniform4f("viewportPixelSz",-1,-1,-1,-1);}_selectPrograms(){this._ssaoTechniqueConfig.output=0,this._ssaoTechnique=this._techniqueRep.releaseAndAcquire(m$1,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=1,this._blurTechnique=this._techniqueRep.releaseAndAcquire(m$1,this._ssaoTechniqueConfig,this._blurTechnique);}_enable(){this.enabled||(this._enabled=!0,this._loadResources((()=>{this._enabled&&this._initialize();})));}_loadResources(e){this._data?e():import('./SSAOHelperData-25a41450.js').then((t=>{this._data=t,e();}));}_initialize(){const e={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},t={colorTarget:0,depthStencilTarget:0};t$R(this._data.noiseTexture).then((s=>{this._enabled&&(this._ssaoFBO=new l$F(this._rctx,t,e),this._blur0FBO=new l$F(this._rctx,t,e),this._blur1FBO=new l$F(this._rctx,t,e),this._noiseTexture=new o$G(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,hasMipmap:!0,width:s.width,height:s.height},s),this._requestRender());})),this._selectPrograms();}_disable(){this._enabled=!1,this._noiseTexture=i$M(this._noiseTexture),this._blur1FBO=i$M(this._blur1FBO),this._blur0FBO=i$M(this._blur0FBO),this._ssaoFBO=i$M(this._ssaoFBO);}get gpuMemoryUsage(){return (r$A(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(r$A(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(r$A(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}get test(){return {ssao:this._ssaoFBO,blur:this._blur1FBO}}}const c$3=n$Q(),f$3=n$P();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function n$2(n,o){const t=o,c=-n[0],f=-n[1],i=-n[2],s=t[3],u=t[7],e=t[11],p=t[15];t[0]+=s*c,t[1]+=s*f,t[2]+=s*i,t[4]+=u*c,t[5]+=u*f,t[6]+=u*i,t[8]+=e*c,t[9]+=e*f,t[10]+=e*i,t[12]+=p*c,t[13]+=p*f,t[14]+=p*i;}function o$5(n,o){const t=o,c=n[0],f=n[1],i=n[2];t[12]+=c*t[0]+f*t[4]+i*t[8],t[13]+=c*t[1]+f*t[5]+i*t[9],t[14]+=c*t[2]+f*t[6]+i*t[10],t[14]+=c*t[3]+f*t[7]+i*t[11];}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class e$3{constructor(i){this.factory=i,this.originData=new Map;}acquire(i){return this.register(this.factory.getOrigin(i))}register(i){const r=this.originData.get(i.id);return r?(r.refCount++,r.origin):(this.originData.set(i.id,{refCount:1,viewMatrix:e$y(),origin:i}),i)}release(i){const t=this.originData.get(i.id);t&&(t.refCount--,0===t.refCount&&this.originData.delete(i.id));}updateViewMatrices(t){this.originData.forEach((e=>{n$K(e.viewMatrix,t),o$5(e.origin.vec3,e.viewMatrix);}));}getViewMatrix(i){return this.originData.get(i.id).viewMatrix}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function o$4(o){const e=t$J`bool isNaN( float val )
{
return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;
}`;o.code.add(e);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function a$3(a,t){a.vertex.include(o$4),a.include(d$P,t);const s=a.vertex;s.uniforms.add("uDepthBias","vec2"),s.uniforms.add("uViewportDimInv","vec2"),t.legacy?(s.uniforms.add("uView","mat4"),s.uniforms.add("uProj","mat4")):s.uniforms.add("uTransformNormal_ViewFromGlobal","mat3"),t.legacy?s.code.add(t$J`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = uDepthBias.x;
float offsetZ  = uDepthBias.y;
vec4 projNormal = uProj * uView * vec4(globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * uViewportDimInv * normalize(projNormal.xyz).xy;
}`):s.code.add(t$J`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = uDepthBias.x;
float offsetZ  = uDepthBias.y;
vec4 projNormal = uTransform_ProjFromView * vec4(uTransformNormal_ViewFromGlobal * globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * uViewportDimInv * normalize(projNormal.xyz).xy;
}`),s.code.add(t$J`float _calculateProjectedBiasZ(vec4 projPos) {
float offsetZ = uDepthBias.y;
return sqrt(projPos.z) * offsetZ;
}
vec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {
vec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);
if (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {
projPos.xy += offsetXY;
}
projPos.z += _calculateProjectedBiasZ(projPos);
return projPos;
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function a$2(a,r){const d=a.fragment;d.constants.add("coverageTestThreshold","float",.01),r.antialiasing?d.code.add(t$J`#define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }`):d.code.add(t$J`#define discardByCoverage(radius, coverage) { float coverageLimit = radius <= 0.5 ? coverageTestThreshold : 0.75; if (coverage < coverageLimit) discard; }`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function o$3(o,r){const l=o.vertex;r.silhouette?(l.code.add(t$J`bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {
float faceAVisible = dot(viewDir, normalA);
float faceBVisible = dot(viewDir, normalB);
return faceAVisible * faceBVisible < 0.0;
}`),r.legacy?l.code.add(t$J`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 viewNormalA = _modelToViewNormal(normalA);
vec3 viewNormalB = _modelToViewNormal(normalB);
vec3 viewDir = -viewPos;
if (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`):l.code.add(t$J`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 worldNormalA = _modelToWorldNormal(normalA);
vec3 worldNormalB = _modelToWorldNormal(normalB);
vec3 viewDir = -worldPos;
if (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`)):l.code.add(t$J`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
return false;
}`);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function t$4(t,i){const d=t.vertex;switch(i.mode){case 1:d.code.add(t$J`#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}`);break;case 2:d.code.add(t$J`#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (unpackedAttributes.type <= 0.0 && lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}`);break;case 0:d.code.add(t$J`#define discardShortEdges(unpackedAttributes, lineLengthPixels) {}`);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function t$3(t,n){const r=t.vertex;r.uniforms.add("uDistanceFalloffFactor","float"),r.code.add(t$J`float distanceBasedPerspectiveFactor(float distance) {
return clamp(sqrt(uDistanceFalloffFactor / distance), 0.0, 1.0);
}`),r.uniforms.add("uComponentDataTex","sampler2D"),r.uniforms.add("uComponentDataTexInvDim","vec2"),t.attributes.add("componentIndex","float"),r.constants.add("componentColorFieldOffset","float",0),r.constants.add("componentOtherFieldOffset","float",1),r.constants.add("componentFieldCount","float",2),r.constants.add("lineWidthFractionFactor","float",8),r.constants.add("extensionLengthOffset","float",128),r.constants.add("componentTexWidth","float",4096),r.code.add(t$J`vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {
float fieldIndex = componentFieldCount * componentIndex + fieldOffset;
float rowIndex = floor(fieldIndex / componentTexWidth);
float colIndex = mod(fieldIndex, componentTexWidth);
vec2 linearIndex = vec2(
(colIndex + 0.5) / componentTexWidth,
(rowIndex + 0.5) * uComponentDataTexInvDim.y
);
return linearIndex;
}
struct ComponentData {
vec4 color;
float lineWidth;
float extensionLength;
float type;
};
ComponentData readComponentData() {
vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);
vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);
vec4 colorValue = texture2D(uComponentDataTex, colorIndex);
vec4 otherValue = texture2D(uComponentDataTex, otherIndex);
return ComponentData(
vec4(colorValue.rgb, colorValue.a * otherValue.w),
otherValue.x * (255.0 / lineWidthFractionFactor),
otherValue.y * 255.0 - extensionLengthOffset,
-(otherValue.z * 255.0) + 0.5
);
}`),n.legacy?r.code.add(t$J`vec3 _modelToWorldNormal(vec3 normal) {
return (uModel * vec4(normal, 0.0)).xyz;
}
vec3 _modelToViewNormal(vec3 normal) {
return (uView * uModel * vec4(normal, 0.0)).xyz;
}`):(r.uniforms.add("uTransformNormal_GlobalFromModel ","mat3"),r.code.add(t$J`vec3 _modelToWorldNormal(vec3 normal) {
return uTransformNormal_GlobalFromModel * normal;
}`)),n.silhouette?(t.attributes.add("normalA","vec3"),t.attributes.add("normalB","vec3"),r.code.add(t$J`vec3 worldNormal() {
return _modelToWorldNormal(normalize(normalA + normalB));
}`)):(t.attributes.add("normal","vec3"),r.code.add(t$J`vec3 worldNormal() {
return _modelToWorldNormal(normal);
}`)),n.legacy?r.code.add(t$J`vec3 worldFromModelPosition(vec3 position) {
return (uModel * vec4(position, 1.0)).xyz;
}
vec3 viewFromModelPosition(vec3 position) {
return (uView * vec4(worldFromModelPosition(position), 1.0)).xyz;
}
vec4 projFromViewPosition(vec3 position) {
return uProj * vec4(position, 1.0);
}`):(t.vertex.include(i$18,n),r.code.add(t$J`vec3 worldFromModelPosition(vec3 position) {
vec3 rotatedModelPosition = uTransform_WorldFromModel_RS * position;
vec3 transform_CameraRelativeFromModel = dpAdd(
uTransform_WorldFromModel_TL,
uTransform_WorldFromModel_TH,
-uTransform_WorldFromView_TL,
-uTransform_WorldFromView_TH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}
vec3 viewFromModelPosition(vec3 position) {
return uTransform_ViewFromCameraRelative_RS * worldFromModelPosition(position);
}
vec4 projFromViewPosition(vec3 position) {
return uTransform_ProjFromView * vec4(position, 1.0);
}`)),r.code.add(t$J`float calculateExtensionLength(float extensionLength, float lineLength) {
return extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);
}`);}!function(o){function e(o){return 1===o.mode||2===o.mode}function t(o){return 0===o.mode||2===o.mode}o.usesSketchLogic=e,o.usesSolidLogic=t;}(t$3||(t$3={}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function t$2(t,s){const i=t.vertex;switch(t.include(t$3,s),t.attributes.add("sideness","vec2"),2===s.mode?i.code.add(t$J`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
float type;
};`):i.code.add(t$J`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
};`),s.mode){case 2:i.code.add(t$J`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float fType = component.type;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
if (fType <= 0.0) {
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
}
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);
}`);break;case 1:i.code.add(t$J`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case 0:i.code.add(t$J`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function u$4(u,a){const d=u.vertex;switch(u.include(t$2,a),t$3.usesSketchLogic(a)&&d.uniforms.add("uStrokesAmplitude","float"),a.mode){case 0:d.code.add(t$J`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return 0.0;
}`);break;case 1:d.code.add(t$J`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return uStrokesAmplitude;
}`);break;case 2:d.code.add(t$J`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
float type = unpackedAttributes.type;
if (type <= 0.0) {
return uStrokesAmplitude;
}
else {
return 0.0;
}
}`);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function u$3(u,s){const c=u.vertex;u.include(t$2,s);const l=u.fragment;switch(t$3.usesSketchLogic(s)&&(c.uniforms.add("uStrokesTextureScale","vec2"),c.uniforms.add("uStrokesLog2Resolution","float"),c.uniforms.add("uStrokeVariants","float"),u.varyings.add("vStrokeUV","vec2"),l.uniforms.add("uStrokesTexture","sampler2D"),l.uniforms.add("uStrokesNormalizationScale","float"),c.code.add(t$J`void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
float lineIndex = clamp(ceil(log2(lineLength)), 0.0, uStrokesLog2Resolution);
vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * uStrokeVariants + variantStroke + 0.5) * uStrokesTextureScale;
vStrokeUV.x += variantOffset;
}`),u.fragment.include(a$V),l.code.add(t$J`float calculateLineOffsetSketch() {
float offsetNorm = rgba2float(texture2D(uStrokesTexture, vStrokeUV));
return (offsetNorm - 0.5) * uStrokesNormalizationScale;
}
float calculateLinePressureSketch() {
return rgba2float(texture2D(uStrokesTexture, vStrokeUV + vec2(0.0, 0.5)));
}`)),s.mode){case 0:c.code.add(t$J`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}`),l.code.add(t$J`float calculateLineOffset() {
return 0.0;
}
float calculateLinePressure() {
return 1.0;
}`);break;case 1:c.code.add(t$J`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}`),l.code.add(t$J`float calculateLineOffset() {
return calculateLineOffsetSketch();
}
float calculateLinePressure() {
return calculateLinePressureSketch();
}`);break;case 2:u.varyings.add("vType","float"),c.code.add(t$J`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
vType = unpackedAttributes.type;
if (unpackedAttributes.type <= 0.0) {
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}
}`),l.code.add(t$J`float calculateLineOffset() {
if (vType <= 0.0) {
return calculateLineOffsetSketch();
}
else {
return 0.0;
}
}
float calculateLinePressure() {
if (vType <= 0.0) {
return calculateLinePressureSketch();
}
else {
return 1.0;
}
}`);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function p$2(p){const v=new n$N,g=v.vertex,f=v.fragment;return p.legacy&&g.uniforms.add("uModel","mat4"),p.antialiasing&&(g.code.add(t$J`#define ANTIALIASING 1`),f.code.add(t$J`#define ANTIALIASING 1`)),v.include(a$3,p),v.include(u$4,p),v.include(t$3,p),v.include(t$2,p),v.include(u$3,p),v.include(c$10,p),v.include(o$3,p),v.include(a$2,p),v.include(t$4,p),v.varyings.add("vColor","vec4"),v.varyings.add("vRadius","float"),v.varyings.add("vPosition","vec3"),v.varyings.add("vWorldPosition","vec3"),v.varyings.add("vViewPos","vec3"),v.varyings.add("vLineLengthPixels","float"),v.varyings.add("vSizeFalloffFactor","float"),g.uniforms.add("uPixelToNDC","vec2"),g.uniforms.add("uNDCToPixel","vec2"),g.uniforms.add("uPixelRatio","float"),v.attributes.add("position0","vec3"),v.attributes.add("position1","vec3"),v.attributes.add("variantOffset","float"),v.attributes.add("variantStroke","float"),v.attributes.add("variantExtension","float"),g.code.add(t$J`const float opaqueCutoff = 1.0 / 255.0;
void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {
vec2 sideness = unpackedAttributes.sideness;
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;
vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);
vViewPos = viewPos;
vec4 projPosV0 = projFromViewPosition(viewPosV0);
vec4 projPosV1 = projFromViewPosition(viewPosV1);
vec4 projPos = projFromViewPosition(viewPos);
vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);
vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * uNDCToPixel;
float lineLengthPixels = length(screenSpaceLinePixels);
float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;
vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;
vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;
float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * uPixelRatio;
float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;
float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;
float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * uPixelRatio;
vSizeFalloffFactor = falloffFactor;
float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;
float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;
#ifdef ANTIALIASING
const float aaPaddingPixels = 1.0;
float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;
float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;
#else
float halfAAPaddedLineWidthAndAmplitudePixels = max(lineWidthAndAmplitudePixels, 1.0) * 0.5;
float aaPaddedRoundedCapSizePixels = max(lineWidthPixels, 1.0) * 0.5;
#endif
vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * uPixelToNDC;
vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * uPixelToNDC;
vec2 extensionLengthNDC = extensionLengthPixels * uPixelToNDC;
vec2 ndcOffset = (
screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)
+ perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC
);
projPos.xy += ndcOffset * projPos.w;
projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;
projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));
float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;
float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;
vPosition = vec3(
halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,
pixelPositionAlongLine,
pixelPositionAlongLine / extendedLineLengthPixels
);
vRadius = lineWidthPixels * 0.5;
vLineLengthPixels = extendedLineLengthPixels;
discardShortEdges(unpackedAttributes, lineLengthPixels);
gl_Position = projPos;
}
void main() {
ComponentData component = readComponentData();
UnpackedAttributes unpackedAttributes = unpackAttributes(component);
vec3 worldPosV0 = worldFromModelPosition(position0);
vec3 worldPosV1 = worldFromModelPosition(position1);
vec3 viewPosV0 = viewFromModelPosition(position0);
vec3 viewPosV1 = viewFromModelPosition(position1);
vColor = component.color;
if (vColor.a < opaqueCutoff) {
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return;
}
if (discardNonSilhouetteEdges(viewPosV0, worldPosV0)) {
return;
}
calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(), unpackedAttributes);
calculateStyleOutputs(unpackedAttributes);
}`),p.multipassTerrainEnabled&&(v.fragment.include(a$U),v.include(r$15,p)),v.fragment.code.add(t$J`
    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {
      float lineOffset = calculateLineOffset();
      float positionX = position.x - lineOffset;

      if (radius < 1.0) {
        // Handle this specifically for subpixel sizes:
        // 1. Compute correct coverage (note coverage is computed by
        //    0.5 - dist, so we make sure that that will lead to correct
        //    subpixel coverage
        // 2. Ignore rounded caps
        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);
        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);

        float coverage = min(coverageX, coverageY);

        return vec2(0.5 - coverage, 0.0);
      }
      else {
        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius
        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);

        vec2 lineToPosition = vec2(positionX, positionOnCap);
        return vec2(length(lineToPosition) - radius, positionOnCap / radius);
      }
    }

    void main() {
      ${p.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, vViewPos.z);":""}
      float radius = vRadius * calculateLinePressure();

      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);
      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);

      discardByCoverage(radius, coverage);
      discardBySlice(vWorldPosition);

      float alpha = vColor.a * coverage;

      gl_FragColor = vec4(vColor.rgb, alpha);

    }
  `),v}const v$1=Object.freeze({__proto__:null,build:p$2});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const f$2=-4e-4,p$1=.5;class h$1 extends t$L{bindPass(e){const i=this.program,{edgeRenderParameters:o,bindParameters:t}=e;d$P.bindViewProjTransform(i,o.viewProjectionTransform),i.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",o.transformNormal_ViewFromGlobal),i.setUniformMatrix4fv("uProj",t.camera.projectionMatrix),i.setUniform2f("uDepthBias",p$1,f$2),i.setUniform2f("uPixelToNDC",2/t.camera.fullViewport[2],2/t.camera.fullViewport[3]),i.setUniform2f("uNDCToPixel",t.camera.fullViewport[2]/2,t.camera.fullViewport[3]/2),i.setUniform1f("uDistanceFalloffFactor",o.distanceFalloffFactor),i.setUniform2f("uViewportDimInv",1/t.camera.fullViewport[2],1/t.camera.fullViewport[3]),i.setUniform1f("uPixelRatio",t.camera.pixelRatio||1);}initializeProgram(e){const r=h$1.shader.get(),i=this.configuration,o=r.build({slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,silhouette:i.silhouette,legacy:i.legacy,antialiasing:i.antialiasing,mode:i.mode,doublePrecisionRequiresObfuscation:i.doublePrecisionRequiresObfuscation,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new n$O(e.rctx,o,p$$)}initializePipeline(e){const r=e.rctx.capabilities.blendMinMax;return g$v(r?{blending:e$E(1,1,0,1,32774,r.MAX),depthTest:{func:515},colorWrite:r$J}:{depthTest:{func:515},depthWrite:l$P,colorWrite:r$J})}}h$1.shader=new t$M(v$1,(()=>import('./EdgeShaderProgram.glsl-0e7d845b.js'))),function(r){class i extends t$K{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.silhouette=!1,this.legacy=!1,this.antialiasing=!1,this.mode=0,this.doublePrecisionRequiresObfuscation=!1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1;}}e$x([e$D()],i.prototype,"slicePlaneEnabled",void 0),e$x([e$D()],i.prototype,"silhouette",void 0),e$x([e$D()],i.prototype,"legacy",void 0),e$x([e$D()],i.prototype,"antialiasing",void 0),e$x([e$D({count:3})],i.prototype,"mode",void 0),e$x([e$D()],i.prototype,"doublePrecisionRequiresObfuscation",void 0),e$x([e$D()],i.prototype,"multipassTerrainEnabled",void 0),e$x([e$D()],i.prototype,"cullAboveGround",void 0),r.Configuration=i;}(h$1||(h$1={}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const y=8,T=128,R={type:"uber",slicePlaneEnabled:!1,sliceHighlightDisabled:!1,strokesTexture:null,legacy:!0};class v{constructor(){this._value=0;}get value(){return this._value}increment(){this._value++;}decrement(){this._value--;}}const x={solid:0,sketch:1,uber:2};class P{constructor(e,t,r){this.rctx=e,this.shaderTechniqueRepository=t,this.config=new h$1.Configuration,this.technique=null,this.refCount=new v,this.renderables=new Set,this.sortedRenderables={1:{1:new n$Z,2:new n$Z},2:{1:new n$Z,2:new n$Z}},this.renderablesDirty=!1,this.settings={...R,...r},this.key=P.getKey(this.settings.type,this.settings.slicePlaneEnabled,this.settings.legacy);const i=this.settings.strokesTexture.variants;this.writerSettings={variants:i,reducedPrecision:I$j.TESTS_DISABLE_OPTIMIZATIONS},this.config.legacy=this.settings.legacy,this.config.mode=x[this.settings.type],this.config.silhouette=!1,this.config.antialiasing=!!this.rctx.capabilities.blendMinMax,this.config.slicePlaneEnabled=this.settings.slicePlaneEnabled,this.config.doublePrecisionRequiresObfuscation=r$16(e);}dispose(){this.technique=h$w(this.technique);}addRenderable(e){this.renderables.add(e),this.renderablesDirty=!0;}removeRenderable(e){this.renderables.delete(e),this.renderablesDirty=!0;}setRenderablesDirty(){this.renderablesDirty=!0;}forEachRenderable(e,t){this.renderablesDirty&&this.sortRenderables(),this.sortedRenderables[t][1].forAll(e),this.sortedRenderables[t][2].forAll(e);}setMultipassParameters(e){this.config.multipassTerrainEnabled=!!e.multipassTerrainEnabled&&e.multipassTerrainEnabled,this.config.cullAboveGround=!!e.cullAboveGround&&e.cullAboveGround;}bindRegularEdges(e,t){this.setMultipassParameters(e),this.config.silhouette=!1,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(h$1,this.config,this.technique),this.technique.bindPass({bindParameters:e,edgeRenderParameters:t}),this.technique.bindPipelineState(this.rctx,e.slot),this.rctx.useProgram(this.technique.program);}bindSilhouetteEdges(e,t){this.setMultipassParameters(e),this.config.silhouette=!0,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(h$1,this.config,this.technique),this.technique.bindPass({bindParameters:e,edgeRenderParameters:t}),this.technique.bindPipelineState(this.rctx,e.slot),this.rctx.useProgram(this.technique.program);}renderRegularEdges(e,t,s){this.render(e,e.regular.vao,t,s);}renderSilhouetteEdges(e,t,s){this.render(e,e.silhouette.vao,t,s);}render(e,t,s,r){this.setUniforms(e,s),this.rctx.bindVAO(t),this.rctx.capabilities.instancing.drawArraysInstanced(6,0,4,r);}setUniforms(e,t){const s=this.technique.program;if(e.components.buffer.textureBuffer.bind(s,S,M),t.multipassTerrainEnabled&&(s.setUniform2fv("cameraNearFar",t.camera.nearFar),s.setUniform2fv("inverseViewport",t.inverseViewport),t$13(s,t)),"origin"in e.transform)s.setUniformMatrix4fv("uView",t.localViewMatrixForEdges),s.setUniformMatrix4fv("uModel",e.transform.modelMatrix),r$$(s,this.settings,t.slicePlane,e.transform.origin.vec3);else {const o=new c$9(e.transform.position),h=o$D(w$1,u$S(w$1,e.transform.rotationScale)),c=new j$2;r$B(c.worldFromModel_TL,o.low),r$B(c.worldFromModel_TH,o.high),n$1c(c.worldFromModel_RS,e.transform.rotationScale),n$1c(c.transformNormal_GlobalFromModel,h),d$P.bindModelTransform(s,c),s.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",c.transformNormal_GlobalFromModel);const f=t.camera.viewInverseTransposeMatrix,g=o$C(q,f[3],f[7],f[11]);r$$(s,this.settings,t.slicePlane,g);}"uber"!==this.settings.type&&"sketch"!==this.settings.type||this.setSketchUniforms(s),s.setUniform1f("uWorldLineRadiusPerDistance",Math.tan(t.camera.fovY/2)/(t.camera.fullViewport[3]/2));}setSketchUniforms(e){const s=this.settings.strokesTexture,r=s.texture;t$F(r)||(e.bindTexture(r,"uStrokesTexture"),e.setUniform2f("uStrokesTextureScale",1/r.descriptor.width,1/r.descriptor.height),e.setUniform1f("uStrokesLog2Resolution",Math.log2(s.resolution)),e.setUniform1f("uStrokesNormalizationScale",s.normalizationScale),e.setUniform1f("uStrokesAmplitude",s.amplitude),e.setUniform1f("uStrokeVariants",s.variants));}sortRenderables(){this.renderablesDirty=!1,this.sortedRenderables[1][1].clear(),this.sortedRenderables[1][2].clear(),this.sortedRenderables[2][1].clear(),this.sortedRenderables[2][2].clear(),this.renderables.forEach((e=>{0!==e.objectTransparency&&0!==e.edgeTransparency&&this.sortedRenderables[e.objectTransparency][e.edgeTransparency].push(e);}));const e=(e,t)=>"origin"in e.transform&&"origin"in t.transform?e.transform.origin.id<t.transform.origin.id?-1:e.transform.origin.id>t.transform.origin.id?1:0:0;this.sortedRenderables[1][1].sort(e),this.sortedRenderables[1][2].sort(e),this.sortedRenderables[2][1].sort(e),this.sortedRenderables[2][2].sort(e);}static getKey(e,t,s){return `edges-t:${e}:${t}:${s}`}}const S="uComponentDataTex",M="uComponentDataTexInvDim",w$1=n$1b(),q=n$F();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class s$2 extends n$1e{constructor(e){super("EdgeProcessingWorker","wrappedWork",e);}async process(e,r,t){if(t)return f$K(e);const s=this._packInput(e),a=await this.invoke(s,r);return this._unpackOutput(a)}getTransferList(e){return [e.dataBuffer]}_packInput(r){return {dataBuffer:r.data.buffer,writerSettings:r.writerSettings,skipDeduplicate:r.skipDeduplicate,indicesBuffer:r.indices.buffer,indicesType:s$Z(r.indices)?"Uint32Array":"Uint16Array",indicesLength:r.indicesLength}}_unpackOutput(e){return {regular:{instancesData:D$m(e.regular.instancesData),lodInfo:{lengths:new Float32Array(e.regular.lodInfo.lengths)}},silhouette:{instancesData:D$m(e.silhouette.instancesData),lodInfo:{lengths:new Float32Array(e.silhouette.lodInfo.lengths)}},averageEdgeLength:e.averageEdgeLength}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function o$2(e){const r=4,o=u$2.resolution,n=o/2,l=new Uint8Array(r*o*o),a=r*o*n,h=u$2.amplitude,p=2*h,m=r*o,f=Math.log2(o)+1,d=u$2.strokes.length;let g=(f-1)*d*m;for(const{distance:s,pressure:c}of u$2.strokes){let e=s,o=c,n=g;for(let s=0;s<f;s++){0!==s&&(e=i$4(e,0),o=i$4(o,1));for(let s=0;s<u$2.resolution;s++){const i=.5+(e?e[s%e.length]/p:0),c=o?o[s%o.length]:1;o$$(i,l,n),o$$(c,l,n+a),n+=r;}n-=m*(d+1);}g+=m;}const w=new o$G(e,{pixelFormat:6408,dataType:5121,hasMipmap:!1,samplingMode:9729,width:o,height:o,wrapMode:10497},l);return new c$2(o,p,h,d,w)}function i$4(t,e){if(!t)return null;const r=t.length/2,s=l$4*r,o=new Array(r);let n=0;const i=1===e;for(let l=0;l<t.length;l+=2){const e=(t[l]+t[l+1])/2;o[n++]=i?Math.min(s,1-(1-e)*a$1):Math.min(s,e*a$1);}return o}const l$4=.1,a$1=.5;class c$2{constructor(t,e,r,s,o){this.resolution=t,this.normalizationScale=e,this.amplitude=r,this.variants=s,this.texture=o;}dispose(){this.texture=i$M(this.texture);}}const u$2={amplitude:8,resolution:256,strokes:[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}]};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function e$2(t){let e=null;for(const r of t){const t=r.type;if(c$1(r))if(t$F(e))e=t;else if(e!==t)return "uber"}return r$A(e)?e:"solid"}function o$1(t){let n=0;for(const{material:r}of t)if(c$1(r)){if(r.color[3]*r.opacity<1)return 1;n=2;}return n}function i$3(t){let n=0;for(const{material:r}of t)if(c$1(r)){switch(r.objectTransparency){case 1:case 0:return 1;case 2:if(r.opacity<1)return 1}n=2;}return n}function c$1(t){return t.size*t.color[3]*t.opacity>0}function u$1(n,r){const e=p$10(n,r,!0);return -1===e?r<n[0]?0:n.length:e}function s$1(t,n,r){return t.length-u$1(t,n*r.minimumEdgeLength)}function l$3(t,n,r,e){for(let o=0;o<t.length;o++){const i=t[o].index,c=n[o],f=n[o+1];if(e)for(let t=c;t<f;t++){const n=e[t];r.set(n,i);}else for(let t=c;t<f;t++)r.set(t,i);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const Y$1=s$y.getLogger("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView");let Z=class extends p$N{constructor(e){super(e),this.updatingHandles=new l$G,this.perObjectData=new Map,this.perObjectDataEvictionCache=new Set,this.renderers=new Map,this.numberOfRenderedEdges=0,this.gpuMemoryUsage=0,this.workerAbort=new AbortController,this.tmpModelPosition=n$F(),this.localOrigins=new e$3(new d$O(e.renderSR));}initialize(){this.worker=new s$2(this.schedule),this.componentColorManager=new r$4(this.rctx,2);const e=i$19.createBuffer(4);for(let t=0;t<4;t++)e.sideness.set(t,0,0===t||3===t?0:1),e.sideness.set(t,1,0===t||1===t?0:1);this.verticesBufferObject=h$y.createVertex(this.rctx,35044,e.buffer);}destroy(){this.destroyed||(this.perObjectData.forEach((e=>this._discardObjectEntry(e))),this.perObjectData.clear(),this.strokesTexture=i$M(this.strokesTexture),this.componentColorManager=l$E(this.componentColorManager),this.workerAbort.abort(),this.worker.destroy(),this.verticesBufferObject=i$M(this.verticesBufferObject),this.renderers.clear(),this.updatingHandles.destroy());}get updating(){return this.updatingHandles.updating}get usedMemory(){return this.gpuMemoryUsage}get numberOfRenderedPrimitives(){return this.numberOfRenderedEdges}shouldRender(){return this.renderers.size>0}async addComponentObject(e,t,r,s,o,i,n,a){if(this.hasObject(e))return;let c;const d=new te(new Promise((e=>c=e)),r.center,r.radius);this.perObjectData.set(e,d),await this.updatingHandles.addPromise(this.addComponentGeometry(t,d,s,o,i,n,a)),this.setNeedsRender(),c();}async addOrUpdateObject3D(e,t,r,s){if(this.destroyed)return void Y$1.warn("Attempt to add an object to a destroyed instance");const o=this.perObjectData.get(e);let i;(null==o?void 0:o.renderables.length)>0&&this.perObjectDataEvictionCache.add(o);const n=e.boundingVolumeWorldSpace.bounds,a=new te(new Promise((e=>i=e)),L$i(n),E$o(n));this.perObjectData.set(e,a);const c=new Array;if(r.mergeGeometries&&e.geometries.length>1&&ee(e))c.push(this.addObjectMergedGeometries(e,a,t,r,s));else for(let d=0;d<e.geometries.length;d++){const o=e.geometryRecords[d];if(!o.material.supportsEdges)continue;const i=e.geometries[d];c.push(this.addGeometry(e,a,i,o,t[0],r,s));}await this.updatingHandles.addPromise(Promise.all(c)),this.perObjectDataEvictionCache.delete(a),this._discardObjectEntry(o),this.setNeedsRender(),i();}_discardObjectEntry(e){e&&(e.renderables.length&&(e.renderables.forEach((e=>this.removeRenderable(e))),this.setNeedsRender()),e.loaded=null);}hasObject(e){return this.perObjectData.has(e)}async updateAllComponentOpacities(e,t){const r=t instanceof Array?e=>t[e]:()=>t;(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach((e=>{const t=e.components.meta.length;for(let s=0;s<t;s++){const t=r(s),o=e.components.meta[s],i=o.index;o.material.opacity=t,e.components.buffer.textureBuffer.setDataElement(i,1,3,255*t);}this.updateTransparency(e);})),this.setNeedsRender();}async updateAllComponentMaterials(e,t,r,s){const o=e instanceof T$k,i=!!r.slicePlaneEnabled,n=e$2(t),a=P.getKey(n,i,o);(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach((e=>{if(a!==e.rendererKey){const t=this.renderers.get(e.rendererKey),r=this.acquireRenderer(n,i,o);t.removeRenderable(e),t.refCount.decrement(),e.rendererKey=a,r.addRenderable(e);}for(let r=0;r<t.length;r++)e.components.meta[r].material=t[r];s&&this.updateComponentBuffer(e.components),this.updateTransparency(e);})),this.setNeedsRender();}async updateObjectVisibility(e,t){(await this.updatingHandles.addPromise(this.getObjectEntry(e))).renderables.forEach((e=>e.visible=t)),this.setNeedsRender();}removeObject(e){const t=this.perObjectData.get(e);t&&(this.perObjectData.delete(e),this._discardObjectEntry(t));}async getObjectEntry(e){const t=this.perObjectData.get(e);if(!t)throw "no object";return await t.loaded,t}removeAll(){this.perObjectData.forEach(((e,t)=>this.removeObject(t)));}render(e,t){if(t$F(this.componentColorManager))return;this.localOrigins.updateViewMatrices(e.camera.viewMatrix);const r=e.camera.viewInverseTransposeMatrix,s=n$F(),o=new c$9,i=new d$P.ViewProjectionTransform,n=e$A();o$C(s,r[3],r[7],r[11]),o.set(s),r$B(i.worldFromView_TH,o.high),r$B(i.worldFromView_TL,o.low),a$Q(i.viewFromCameraRelative_RS,e.camera.viewMatrix),n$K(i.projFromView,e.camera.projectionMatrix);const c=e$A();o$D(c,i.viewFromCameraRelative_RS),u$S(n,c);let d=0,l=0;if(this.renderers.forEach((e=>{0===e.refCount.value?(this.renderers.delete(e.key),e.dispose()):e.forEachRenderable((e=>{d+=e.statistics.averageEdgeLength,l++;}),t);})),this.componentColorManager.garbageCollect(),this.componentColorManager.updateTextures(),0===l)return;const f={distanceFalloffFactor:40*d/l,minimumEdgeLength:e.camera.perScreenPixelRatio,transparency:t,viewProjectionTransform:i,transformNormal_ViewFromGlobal:n};this.updateObjectCameraDistances(e),this.numberOfRenderedEdges=0,this.renderers.forEach((t=>{this.renderRegularEdges(t,e,f),this.renderSilhouetteEdges(t,e,f);}));}updateTransparency(e){const t=o$1(e.components.meta),r=i$3(e.components.meta);t===e.edgeTransparency&&r===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=r,this.renderers.get(e.rendererKey).setRenderablesDirty());}computeModelTransformWithLocalOrigin(e,t,r){if(e.getCombinedStaticTransformation(t,r),r$A(t.origin))this.localOrigins.register(t.origin);else {const e=o$C(this.tmpModelPosition,r[12],r[13],r[14]);t.origin=this.localOrigins.acquire(e);}return n$2(t.origin.vec3,r),t.origin}updateComponentBuffer(e){const{meta:t,buffer:r}=e;for(let s=0;s<t.length;s++){const e=t[s].material,i=t[s].index,n=e$B(Math.round(e.size*y),0,255),a=e$B(e.extensionLength,-T,255-T)+T,c="solid"===e.type?0:1,d=255*e.opacity,l=e.color,g=255*l[0],u=255*l[1],h=255*l[2],m=255*l[3];r.textureBuffer.setData(i,0,g,u,h,m),r.textureBuffer.setData(i,1,n,a,c,d);}}createComponentBuffers(e){if(t$F(this.componentColorManager))return null;const t=new Array,r=this.componentColorManager.getBuffer(e.length);for(let o=0;o<e.length;o++){const s=e[o],i=r.acquireIndex();t.push({index:i,material:s});}const s={meta:t,buffer:r};return this.updateComponentBuffer(s),s}extractEdges(e,t,r,s,o,i=o.length){return this.worker.process({data:t,indices:o,indicesLength:i,writerSettings:e,skipDeduplicate:r},this.workerAbort.signal,s)}createEdgeResources(e){const t={};if(t$F(this.verticesBufferObject))return t;if(e.regular.lodInfo.lengths.length>0){const r=new f$w(this.rctx,p$$,{vertices:t$14,instances:d$S.glLayout},{vertices:this.verticesBufferObject,instances:h$y.createVertex(this.rctx,35044,e.regular.instancesData.buffer)});t.regular={vao:r,lod:e.regular.lodInfo};}if(e.silhouette.lodInfo.lengths.length>0){const r=new f$w(this.rctx,p$$,{vertices:t$14,instances:w$q.glLayout},{vertices:this.verticesBufferObject,instances:h$y.createVertex(this.rctx,35044,e.silhouette.instancesData.buffer)});t.silhouette={vao:r,lod:e.silhouette.lodInfo};}return t}async addGeometry(e,t,r,s,o,i,n){const a=r.vertexAttributes.get("position"),c=r.indices.get("position"),d=e$y(),l={position:a,indices:c,modelTransform:d,origin:this.computeModelTransformWithLocalOrigin(e,s,d)};return this.addPositionData(t,l,r.edgeIndicesLength,o,i,n)}async addPositionData(e,t,r,s,o,i=!1){if(null==e.loaded)return;const n=this.createComponentBuffers([s]);if(t$F(n)||r<=0)return;const c=this.acquireRenderer(s.type,!!o.slicePlaneEnabled),{modelTransform:d,origin:l}=t,g=t.indices,u=t.position,h=u.data.length/u.size,m=e$Y.createBuffer(h);for(let a=0;a<h;a++)m.position.set(a,0,u.data[a*u.size+0]),m.position.set(a,1,u.data[a*u.size+1]),m.position.set(a,2,u.data[a*u.size+2]);l$3(n.meta,[0,m.componentIndex.count],m.componentIndex);const p=await this.updatingHandles.addPromise(this.extractEdges(c.writerSettings,m,!1,i,g,r));if(null==e.loaded)return;const{regular:f,silhouette:b}=this.createEdgeResources(p),y=(f?f.vao.size:0)+(b?b.vao.size:0),j={regular:f,silhouette:b,transform:{modelMatrix:d,origin:l},statistics:{gpuMemoryUsage:y,averageEdgeLength:p.averageEdgeLength},components:n,visible:!0,edgeTransparency:o$1(n.meta),objectTransparency:i$3(n.meta),distanceToCamera:0,rendererKey:c.key};e.renderables.push(j),c.addRenderable(j),this.gpuMemoryUsage+=y;}async addComponentGeometry(e,t,r,s,o,i,n){if(null==t.loaded)return;const c=this.createComponentBuffers(i);if(t$F(c))return;const d=e$2(i),l=this.acquireRenderer(d,n.slicePlaneEnabled||!1,!1),g=e$Y.createBuffer(r.count);e$Z(g.position,r),l$3(c.meta,o,g.componentIndex,s);const u=!0,h=l.writerSettings,m=await this.updatingHandles.addPromise(this.extractEdges(h,g,u,!1,s));if(null==t.loaded)return;const{regular:p,silhouette:f}=this.createEdgeResources(m),b=(p?p.vao.size:0)+(f?f.vao.size:0),y={regular:p,silhouette:f,transform:e,statistics:{gpuMemoryUsage:b,averageEdgeLength:m.averageEdgeLength},components:c,visible:!0,edgeTransparency:o$1(c.meta),objectTransparency:i$3(c.meta),distanceToCamera:0,rendererKey:l.key};t.renderables.push(y),l.addRenderable(y),this.gpuMemoryUsage+=b;}async addObjectMergedGeometries(e,t,r,s,o){const i=new Map;let n=0,a=null,c=0;for(let f=0;f<e.geometries.length;f++){const t=e.geometries[f],r=e.geometryRecords[f];if(!r.material.supportsEdges)continue;!a&&r.origin&&(a=r);const s=t.vertexAttributes.get("position");c+=s.data.length/s.size,n+=t.edgeIndicesLength;}const d=c>=65536?Uint32Array:Uint16Array,l=n?new d(n):null,g=[];let u=0;for(let f=0;f<e.geometries.length;f++){const t=e.geometries[f];if(!e.geometryRecords[f].material.supportsEdges)continue;const r=t.vertexAttributes.get("position"),s=t.indices.get("position");let o=i.get(r.data);if(null==o){o=g.length/3;for(let e=0;e<r.data.length;e+=r.size)g.push(r.data[e+0]),g.push(r.data[e+1]),g.push(r.data[e+2]);i.set(r.data,o);}if(s)for(let e=0;e<t.edgeIndicesLength;e++)l[u++]=o+s[e];}const h=a||e.geometryRecords[0],m=e$y(),p=this.computeModelTransformWithLocalOrigin(e,h,m);for(let f=0;f<e.geometryRecords.length;f++)e.geometryRecords[f].origin=p;const b={position:{data:g,size:3},indices:l,modelTransform:m,origin:p};await this.updatingHandles.addPromise(this.addPositionData(t,b,l.length,r[0],s,o));}acquireRenderer(e,t,r=!0){const s=P.getKey(e,t,r);let o=this.renderers.get(s);return t$F(this.strokesTexture)&&(this.strokesTexture=o$2(this.rctx)),o||(o=new P(this.rctx,this.techniqueRepository,{type:e,slicePlaneEnabled:t,strokesTexture:this.strokesTexture,legacy:r}),this.renderers.set(s,o)),o.refCount.increment(),o}removeRenderable(e){$(e);const t=this.renderers.get(e.rendererKey);if(t){t.removeRenderable(e),t.refCount.decrement(),"origin"in e.transform&&this.localOrigins.release(e.transform.origin),this.gpuMemoryUsage-=e.statistics.gpuMemoryUsage;for(const t of e.components.meta)e.components.buffer.releaseIndex(t.index);}}updateObjectCameraDistances(e){const t=e.camera.eye,r=e.camera.viewForward,s=n$F(),o=e=>{const{center:o,radius:i}=e;J$e(s,o,t);const n=z$i(s,r),a=n<-i?1/0:n<i?0:n-i;e.renderables.forEach((e=>e.distanceToCamera=a));};this.perObjectData.forEach(o),this.perObjectDataEvictionCache.forEach(o);}renderRegularEdges(e,t,r){e.bindRegularEdges(t,r);const s=r.transparency;e.forEachRenderable((s=>{if(!s.visible||!s.regular)return;const o=s$1(s.regular.lod.lengths,s.distanceToCamera,r);"origin"in s.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(s.transform.origin)),e.renderRegularEdges(s,t,o),this.numberOfRenderedEdges+=o;}),s);}renderSilhouetteEdges(e,t,r){e.bindSilhouetteEdges(t,r);const s=r.transparency;e.forEachRenderable((s=>{if(!s.visible||!s.silhouette)return;const o=s$1(s.silhouette.lod.lengths,s.distanceToCamera,r);"origin"in s.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(s.transform.origin)),e.renderSilhouetteEdges(s,t,o),this.numberOfRenderedEdges+=o;}),s);}};function $(e){e.regular&&(e.regular.vao.vertexBuffers.instances.dispose(),e.regular.vao.dispose(!1),e.regular.vao=null),e.silhouette&&(e.silhouette.vao.vertexBuffers.instances.dispose(),e.silhouette.vao.dispose(!1),e.silhouette.vao=null);}function ee(e){let t=null,s=null;for(let i=0;i<e.geometries.length;i++){var o;const n=e.geometryRecords[i];if(n.material.supportsEdges){if(t){if(!l$N(t,n.transformation))return !1}else t=n.transformation;if(!s&&r$A(n.origin))s=n;else if(r$A(null==(o=s)?void 0:o.origin)&&r$A(n.origin)&&s.origin.id!==n.origin.id)return !1}}return !0}e$x([d$y({constructOnly:!0})],Z.prototype,"rctx",void 0),e$x([d$y({constructOnly:!0})],Z.prototype,"renderSR",void 0),e$x([d$y({constructOnly:!0})],Z.prototype,"techniqueRepository",void 0),e$x([d$y({constructOnly:!0})],Z.prototype,"setNeedsRender",void 0),e$x([d$y({constructOnly:!0})],Z.prototype,"schedule",void 0),e$x([d$y({readOnly:!0})],Z.prototype,"updatingHandles",void 0),e$x([d$y({readOnly:!0})],Z.prototype,"updating",null),Z=e$x([i$H("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],Z);class te{constructor(e,t,r){this.center=t,this.radius=r,this.renderables=new Array,this.loaded=e,this.loaded.then((()=>{null!=this.loaded&&(this.loaded=!0);}));}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function e$1(e){const u=e.capabilities.disjointTimerQuery;return t$F(u)?null:u.timestampBits()>0?new i$2(u):r?null:new s(u)}class i$2{constructor(t){this.timer=t,this.start=t.createQuery(),t.createTimestamp(this.start);}stop(t,e=50){this.end=this.timer.createQuery(),this.timer.createTimestamp(this.end),this.checkQueryResult(t,e);}checkQueryResult(t,e){if(!this.timer.resultAvailable(this.end))return void setTimeout((()=>this.checkQueryResult(t,e)),e);if(this.timer.disjoint())return void t(null);const i=this.timer.getResult(this.start),s=this.timer.getResult(this.end);t((s-i)/1e6);}}class s{constructor(t){this.timer=t,this.query=t.createQuery(),r=!0,this.timer.beginTimeElapsed(this.query);}stop(t,e=50){this.timer.endTimeElapsed(),r=!1,this.checkQueryResult(t,e);}checkQueryResult(t,e){const i=this.timer.resultAvailable(this.query),s=this.timer.disjoint();if(!i||s)s?t(null):setTimeout((()=>this.checkQueryResult(t,e)),e);else {const e=this.timer.getResult(this.query);t(e/1e6);}}}let r=!1;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const i$1=["prepare","shadowmap","lineardepth","normals","ssao","opaque","opaque edges","transparent","transparent edges","hudvisibility","transparent terrain","atmosphere","laserline","occluded","antialiasing","highlights","hudOccluded","hudNotoccluded"];class a extends e$_{constructor(){super("total"),this.total=0,this.frameCount=0;}}class o{constructor(){this._startTime=0,this._lastSample=0,this._enableGPUTimer=0,this.totalTime=new a,this.gpuTime=new e$_("gpu",9),this.renderPassTimings=i$1.map((e=>new e$_(e)));}enableGPUTimer(){return ++this._enableGPUTimer,{remove:h$F((()=>--this._enableGPUTimer))}}prerender(e){this._startTime=this._lastSample=performance.now(),this._enableGPUTimer&&(this._gpuTimer=e$1(e));}advance(e){const t=performance.now();this.renderPassTimings[e].record(t-this._lastSample),this._lastSample=t;}postrender(){r$A(this._gpuTimer)&&(this._gpuTimer.stop((t=>r$A(t)&&this.gpuTime.record(t)),16),this._gpuTimer=null);const t=performance.now()-this._startTime;this.totalTime.record(t),this.totalTime.total+=t,this.totalTime.frameCount++;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let B=class extends p$N{constructor(e,r,s,n,i,a,h,o$1,l){super({}),this._materialRepository=e,this._shaderTechniqueRepository=s,this._rctx=n,this._compositingHelper=i,this._magnifierHelper=a,this._requestRender=h,this._stage=l,this._materialRenderers=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._hasWater=!1,this._hasOverlayWater=!1,this._content=new Map,this._isRendering=!1,this._fallbackDepthStencilTexture=null,this.performanceInfo=new o,this._antialiasing=1,this._oitEnabled=!1,this._multipassTerrain=!0,this._opaqueTerrain=!0,this._lighting=new e$$,this._enableNewAtmosphere=!1,this._handles=new u$D,this.renderHiddenTransparentEdges=()=>{},this._smaaPass=new _(this._rctx,s),this._oitEnabled=this._hasOITSupport,this._enableNewAtmosphere=o$H(),this._requestRender(),this._offscreenRendering=new r$2(this._rctx,this._compositingHelper),this._sliceHelper=new n$4,this._shadowMap=new H$1(this._rctx,l.viewingMode,2),this._ssaoHelper=new d$1(s,this._rctx,(()=>this._requestRender())),this._highlightHelper=new b$1(s,this._rctx),this._shadowHighlightHelper=new u$5(this._rctx,l.viewingMode),this._shadowAccumulator=new V(this._rctx,s,l,((e,r)=>{this.renderPassManager.shadowCastingEnabled=!0,this._renderPlugins.prepareRender(e,r),this.renderPassManager.shadowCastingEnabled=this._shadowMap.enabled;}),((e,r,t,s)=>{e.start(t,r,s),this.renderShadowCascades(4,e),t.setGLViewport(this._rctx),this.ensureCameraBindParameters(t);}),(()=>this._requestRender())),this._bindParameters={slot:null,camera:null,inverseViewport:n$Q(),shadowMap:this._shadowMap,shadowMappingEnabled:this._shadowMap.enabled,ssaoHelper:this._ssaoHelper,ssaoEnabled:this._ssaoHelper.enabled,origin:null,screenToWorldRatio:null,screenToPCSRatio:null,slicePlane:this._sliceHelper.plane,highlightDepthTexture:null,hasOccludees:!1,linearDepthTexture:null,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,multipassGeometryEnabled:!1,cullAboveGround:!1,lastFrameColorTexture:null,reprojectionMatrix:a$16,ssrEnabled:!1,lighting:this._lighting,highlightColorTexture:null},this._renderContext=new t$15(this._rctx,this._offscreenRendering,this._lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderContext.multipassTerrainParams={camera:null,multipassTerrainEnabled:!1,cullAboveGround:!1,terrainLinearDepthTexture:null},this._renderContext.multipassGeometryParams={multipassGeometryEnabled:!1,geometryLinearDepthTexture:null},this._renderContext.ssrParams={camera:null,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:a$16,ssrEnabled:!1},this._renderPlugins=new n$6({renderContext:this._renderContext,shaderTechniqueRep:s,textureRep:r,materialRep:this._materialRepository,requestRender:this._requestRender,schedule:o$1}),this.renderPassManager=new b$2(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._handles.add([i$P(I$j,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",(e=>{this.renderHiddenTransparentEdges=e?()=>this.renderEdges(1):()=>{},this._requestRender();})),i$P(this._stage,"camera",(()=>this._requestRender()),!0)]);}get hasWater(){return this._hasWater||this._hasOverlayWater}get hasWaterReflection(){return this.hasWater&&this._waterReflectionEnabled}normalizeCtorArgs(){return {}}dispose(){this._handles.destroy(),this._smaaPass.dispose(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._edgeView=l$E(this._edgeView),this._offscreenRendering.dispose(),this._fallbackDepthStencilTexture=i$M(this._fallbackDepthStencilTexture),this._shadowMap.enabled=!1,this._shadowMap.dispose(),this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose(),this._highlightHelper.dispose(),this._shadowHighlightHelper.dispose(),this._shadowAccumulator.dispose(),a$1b.prune(),this._content.clear();}get updating(){return 1===this._antialiasing&&this._smaaPass.updating||r$A(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}ensureEdgeView(){return t$F(this._edgeView)&&(this._edgeView=new Z({rctx:this._rctx,renderSR:this._stage.renderSR,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:e=>this._stage.resourceController.schedule(e)}),this._handles.add(this._edgeView.watch("updating",(()=>this._requestRender()),!0)),this._requestRender()),this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return null===this._bindParameters.reprojectionMatrix||C$k(this._bindParameters.reprojectionMatrix,a$16)}set _reprojectionMatrix(e){C$k(this._bindParameters.reprojectionMatrix,e)||(this._bindParameters.reprojectionMatrix=e,this.notifyChange("isCameraFinal"));}get hasShadowsEnabled(){var e;return !(null==(e=this._shadowMap)||!e.enabled)}setRenderParameters(e){const{renderPassManager:r,_shadowMap:t,_ssaoHelper:s}=this;void 0!==e.screenSpaceReflectionsEnabled&&r.screenSpaceReflectionsEnabled!==e.screenSpaceReflectionsEnabled&&(r.screenSpaceReflectionsEnabled=e.screenSpaceReflectionsEnabled,this._requestRender()),void 0===e.shadowMap||t.enabled===e.shadowMap&&r.shadowCastingEnabled===e.shadowMap||(t.enabled=e.shadowMap,r.shadowCastingEnabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),void 0!==e.ssao&&s.enabled!==e.ssao&&(s.enabled=e.ssao,this._requestRender()),e.background&&this._offscreenRendering.background!==e.background&&(this._offscreenRendering.background=e.background,this._requestRender());const n=e.antialiasingEnabled?1:0;void 0!==e.antialiasingEnabled&&this._antialiasing!==n&&(this._antialiasing=n,this._requestRender()),void 0!==e.highQualityTransparency&&this._multipassTerrain!==e.highQualityTransparency&&(this._multipassTerrain=e.highQualityTransparency,this._oitEnabled=e.highQualityTransparency&&this._hasOITSupport,this._requestRender()),void 0!==e.defaultHighlightOptions&&(this._highlightHelper.setDefaultOptions(e.defaultHighlightOptions),this._shadowHighlightHelper.setDefaultOptions(e.defaultHighlightOptions),this._requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=e$z(e.slicePlane),this._requestRender()),void 0!==e.waterReflectionEnabled&&this._waterReflectionEnabled!==e.waterReflectionEnabled&&(this._waterReflectionEnabled=e.waterReflectionEnabled,this._requestRender()),void 0!==e.opaqueTerrain&&this._opaqueTerrain!==e.opaqueTerrain&&(this._opaqueTerrain=e.opaqueTerrain,this._requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),void 0!==e.shadowCastOptions&&this._shadowAccumulator.setOptions(e.shadowCastOptions);}get hasSlicePlane(){return !!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlendWorking}modify(e){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:r,removes:t,updates:n}=e;if(0===r.length&&0===t.length&&0===n.length)return;t.forAll((({id:e})=>this._content.delete(e))),r.forAll((e=>this._content.set(e.id,e)));const i=r$19(e);let a=!1;i.forEach(((e,r)=>{let t=this._materialRenderers.get(r);if(!t){if(!(e.adds.length>0))return;t=new _$i(this._rctx,this._materialRepository,r),this._materialRenderers.set(r,t);}t.modify(e),t.isEmpty&&(a=!0);})),a&&this._materialRenderers.forEach(((e,r)=>{e.isEmpty&&(this._materialRenderers.delete(r),e.dispose());})),this._hasHighlights=n$_(this._materialRenderers,(e=>e.hasHighlights)),this._hasOccludees=n$_(this._materialRenderers,(e=>e.hasOccludees)),this._hasWater=n$_(this._materialRenderers,(e=>e.hasWater)),this._requestRender();}updateLogic(e){let r=!1;return this._materialRenderers.forEach((t=>r=t.updateLogic(e)||r)),r}updateLightSources(e,r,t){this._lighting.groundLightingFactor=r,this._lighting.globalFactor=t,this._lighting.set(e);}render(e,r,t,s){this._isRendering=!0,this.performanceInfo.prerender(this._rctx),this._bindParameters.lighting=this._lighting,this._renderContext.hasOccludees=this._hasOccludees,this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=3;const n=this._offscreenRendering;n.needLastFrameColorTexture=this.hasWaterReflection,n.advanceCurrentRenderTarget();const i=this._sliceHelper.plane;0===s&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),r.setGLViewport(this._rctx),this.needsShadowCast&&(this.renderPassManager.shadowCastingEnabled=!0),this._renderPlugins.prepareRender(r,t),this.performanceInfo.advance(0);const o=this.computeDepthRange(r);this.renderShadowMap(e,r,this._lighting.lightingMainDirection,o),this.performanceInfo.advance(1),n.initializeFrame(r),this.ensureBindParameters(r),this.renderLinearDepth(),this.performanceInfo.advance(2),this.accumulateShadows(o,r,t),this.renderNormal(),this.performanceInfo.advance(3),this.ensureBindParametersSSR(),this._ssaoHelper.computeSSAO(r,n.linearDepthTexture,n.normalTexture),this.performanceInfo.advance(4),this._renderContext.pass=0,n.bindFramebuffer(),this.renderOpaqueGeometry(),this.performanceInfo.advance(5);const d=this._multipassTerrain&&!this._opaqueTerrain;this.renderTerrainLinearDepth(d),this.setMultipassFlags(d),this.setTerrainCulling(d),this.renderEdges(2),this.performanceInfo.advance(6),this.renderHiddenTransparentEdges(),this._oitEnabled?this.renderOrderIndependentTransparency((()=>this.renderTransparentGeometry()),!1):this.renderTransparentGeometry(),this.performanceInfo.advance(7),this.renderGeometryLinearDepth(d);const l={hudVisibility:!1,transparentTerrain:!1};l.hudVisibility=this.renderHUDVisibility(),d||this.renderInternalSlot(18),this.performanceInfo.advance(9),this.renderEdges(1,d),this.performanceInfo.advance(8),l.transparentTerrain=this.renderTransparentTerrain(),l.transparentTerrain&&l.hudVisibility&&(d?this.renderLineCallouts(0):n.compositeTransparentTerrainOntoHUDVisibility(),this.renderHUD(0,n.framebuffer),this.performanceInfo.advance(16)),this.performanceInfo.advance(10),this.setTerrainCulling(!1),l.transparentTerrain&&(n.compositeTransparentTerrainOntoMain(),d&&(this.renderEdges(2),this.performanceInfo.advance(6),this._oitEnabled?this.renderOrderIndependentTransparency((()=>this.renderTransparentGeometry()),!1):this.renderTransparentGeometry(),this.performanceInfo.advance(7),this.renderEdges(1),this.performanceInfo.advance(8))),d&&this.renderLineCallouts(1),this.setMultipassFlags(!1),this._shadowAccumulator.render(),n.renderToTargets((()=>{this.renderInternalSlot(7),this.renderSlot(13),this.renderSlot(14);}),n.currentColorTarget,n.mainDepth),this.performanceInfo.advance(11),this._renderPlugins.needsLaserlineWithContrastControl&&n.renderTmpAndCompositeToMain((()=>this.renderSlot(15)),2),this.performanceInfo.advance(12),this.renderOccluded(),this.performanceInfo.advance(13);const p=1===s&&this._magnifierHelper.enabled,c=p&&t$F(e)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):e;this._rctx.bindFramebuffer(c);const _=this._offscreenRendering.colorTexture;!this.renderAntiAliasing(this._antialiasing,_)&&r$A(_)&&this._compositingHelper.composite(_,0),this.performanceInfo.advance(14),this.renderHUD(1,c),this.performanceInfo.advance(17),this.renderHighlights(c,this._bindParameters),this.performanceInfo.advance(15),p&&this._magnifierHelper.render(this._rctx,this._bindParameters),c!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._offscreenRendering.tmpColorTexture,0)),this._renderContext.lastFrameCamera.copyFrom(this._renderContext.camera),this._sliceHelper.plane=i,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.postrender();}readDepthPixels(e,r,t,s,n,i){const a=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);if(!this._needsLinearDepth){this.ensureBindParameters(e),this._renderContext.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const r=17664;this._rctx.clearSafe(r),this.renderGeometryAndTransparentTerrainPass(2);}a.readPixels(r,t,s,n,6408,5121,i);}readAccumulatedShadow(e,r){return this._shadowAccumulator.readAccumulatedShadow(e,r)}setMultipassFlags(e){this._renderContext.multipassTerrainParams.multipassTerrainEnabled=this._bindParameters.multipassTerrainEnabled=e,this._renderContext.multipassGeometryParams.multipassGeometryEnabled=this._bindParameters.multipassGeometryEnabled=e;}setTerrainCulling(e){this._renderContext.multipassTerrainParams.cullAboveGround=this._bindParameters.cullAboveGround=e;}renderSlot(e){return this._renderContext.slot=e,this._renderPlugins.render()}renderEdges(e,r=!1){const t=this._edgeView;r$A(t)&&t.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain((()=>t.render(this._bindParameters,e)),1,r);}renderShadowMap(e,r,t,s){const n=this._shadowMap;n.enabled&&(n.start(r,t,s),this.needsShadowHighlight?(this.renderShadowCascades(7,this._shadowMap,(e=>n.takeCascadeSnapshotTo(e,w$2))),n.clear(),this.renderShadowCascades(6,this._shadowMap,(e=>{n.takeCascadeSnapshotTo(e,b),this.renderGeometryAndTransparentTerrainPass(7);}))):this.renderShadowCascades(4),n.finish(e),r.setGLViewport(this._rctx));}renderShadowCascades(e,r=this._shadowMap,t=(e=>{})){for(const s of r.getCascades())s.camera.setGLViewport(this._rctx),this.ensureCameraBindParameters(s.camera),this.renderGeometryAndTransparentTerrainPass(e),t(s);}get _needsLinearDepth(){return this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled||this.needsShadowHighlight||this.needsShadowCast||this._enableNewAtmosphere}renderLinearDepth(){this._needsLinearDepth?this._offscreenRendering.renderToTargets((()=>this.renderGeometryAndTransparentTerrainPass(2)),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth),this._renderContext.ssrParams.linearDepthTexture=this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture;}renderTerrainLinearDepth(e){if(e){const e=this._renderContext.pass;this._renderContext.pass=2,this._offscreenRendering.renderToTargets((()=>this.renderTransparentTerrain()),this._offscreenRendering.terrainLinearDepth,this._offscreenRendering.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.pass=e;}else this._offscreenRendering.disposeTarget(this._offscreenRendering.terrainLinearDepth);this._renderContext.multipassTerrainParams.terrainLinearDepthTexture=this._bindParameters.terrainLinearDepthTexture=this._offscreenRendering.terrainLinearDepthTexture;}renderGeometryLinearDepth(e){if(e){const e=this._renderContext.pass;this._offscreenRendering.renderToTargets((()=>this.renderGeometryPass(2)),this._offscreenRendering.geometryLinearDepth,this._offscreenRendering.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.pass=e;}else this._offscreenRendering.disposeTarget(this._offscreenRendering.geometryLinearDepth);this._renderContext.multipassGeometryParams.geometryLinearDepthTexture=this._bindParameters.geometryLinearDepthTexture=this._offscreenRendering.geometryLinearDepthTexture;}get needsNormal(){return this._ssaoHelper.enabled}renderNormal(){this.needsNormal?this._offscreenRendering.renderToTargets((()=>{this.renderGeometryAndTransparentTerrainPass(3);}),this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal);}get needsDepthRange(){return this._shadowMap.enabled||this.needsShadowCast}computeDepthRange(e){if(!this.needsDepthRange)return f$5;const r=A(e,this._content,this._stage.layers);return t$b(r,this.renderPlugins.queryDepthRange(e)),r.near=Math.max(e.near,r.near),r.far=Math.min(e.far,r.far),r}renderGeometryAndTransparentTerrainPass(e){this._renderContext.pass=e,this.renderGeometryPass(e),this.renderTransparentTerrain();}renderGeometryPass(e){this._renderContext.pass=e,this.renderOpaqueGeometry(),this.renderTransparentGeometry();}renderOpaqueGeometry(){this.renderSlot(0),this.renderSlot(1),this.renderInternalSlot(2),this.renderSlot(3),this.renderSlot(12);}renderTransparentGeometry(){this.renderInternalSlot(4),this.renderSlot(5);}renderTransparentTerrain(){return this.renderSlot(6)}renderHUDVisibility(){let e=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility((()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper?this._renderContext.offscreenRenderingHelper.hudVisibilityTexture:null,e=this.renderInternalSlot(11);}),this._multipassTerrain&&!this._opaqueTerrain),e}renderLineCallouts(e){this._bindParameters.renderTransparentlyOccludedHUD=e,0===e?this._offscreenRendering.renderToTargets((()=>this.renderInternalSlot(18)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderInternalSlot(18);}renderHUD(e,r){this._oitEnabled?(this.renderOrderIndependentTransparency((()=>this.renderHUDElements(e)),!0),this._rctx.bindFramebuffer(r),this._compositingHelper.composite(this._offscreenRendering.hudColorTexture,2)):0===e?this._offscreenRendering.renderToTargets((()=>this.renderHUDElements(0)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderHUDElements(e);}renderHUDElements(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this.renderInternalSlot(19),this.renderInternalSlot(16),this.renderInternalSlot(17);}get needsHighlight(){return this._hasHighlights||this._renderPlugins.needsHighlight}get needsShadowHighlight(){return this._shadowMap.enabled&&this._shadowHighlightHelper.isVisible&&this.needsHighlight}renderHighlights(e,r){if(!this.needsHighlight)return void this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight);const t=this._highlightHelper,s=t.profilingCallback&&e$1(this._renderContext.rctx);this._renderContext.highlightDepthTexture=r.highlightDepthTexture;const n=this._offscreenRendering.renderToTargets((()=>{this.renderGeometryAndTransparentTerrainPass(5),this._rctx.clearSafe(256),this.renderHUDElements(2);}),this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=n.colorTexture,this.needsShadowHighlight&&this._shadowHighlightHelper.render(r,e),t.render(this._renderContext.camera,n,e),r$A(s)&&t.profilingCallback&&s.stop((e=>{t.profilingCallback&&t.profilingCallback(e);}));}get needsShadowCast(){return this._shadowAccumulator.isAccumulating}accumulateShadows(e,r,t){this.needsShadowCast&&(this._shadowAccumulator.setAccumulationDependencies(this._offscreenRendering.linearDepthTexture,e,r,t),this._shadowAccumulator.accumulateFixedSamples(),this.renderPassManager.shadowCastingEnabled=this._shadowMap.enabled);}renderOrderIndependentTransparency(e,r){const t=t=>{this._renderContext.transparencyPassType=t,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._offscreenRendering.renderOITPass((()=>e()),t,r);},s=this._renderContext.pass;this._renderContext.pass=1,t(1),this._renderContext.pass=0,t(0),t(2),this._offscreenRendering.compositeTransparentOntoOpaque(r),this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._renderContext.pass=s;}renderOccluded(){let e=0;this._materialRenderers.forEach(((r,t)=>{t&&t.isVisible()&&8===t.renderOccluded&&(e|=t.renderOccluded,z.push(t));}));const r=this._offscreenRendering,t=(t,s,n,i,a)=>{0!=(e&s)&&(r.renderToTargets(n,r.tmpColor,r.mainDepth,[0,0,0,0],i,a),r.compositeOccludedOntoMain(t));};0!==z.length&&(this.renderInternalSlot(9,z),t(.5,8,(()=>this.renderInternalSlot(10,z)),!1,!1),z.length=0),this._materialRenderers.forEach(((r,t)=>{t&&t.isVisible()&&(4===t.renderOccluded||2===t.renderOccluded||16===t.renderOccluded)&&(e|=t.renderOccluded,Q.push(t));}));const s=this._renderPlugins.renderOccludedFlags;if(e|=s,!e)return;const n=e=>{this._renderContext.renderOccludedMask=e,s>1&&this.renderSlot(8),this.renderInternalSlot(2,Q),this.renderInternalSlot(4,Q),this.renderInternalSlot(7,Q),this._renderContext.resetRenderOccludedMask();};this._renderContext.pass=0,t(.5,4,(()=>n(4)),!0,2),t(.5,2,(()=>n(2)),!0,2),t(1,16,(()=>n(16)),!0,2),Q.length=0;}renderAntiAliasing(e,r){if(1===e){if(this._smaaPass.enable((()=>this._requestRender()))&&r$A(r))return this._smaaPass.render(r),!0}else this._smaaPass.disable();return !1}ensureCameraBindParameters(e){this._renderContext.camera=e,this._bindParameters.camera=this._renderContext.camera,this._bindParameters.inverseViewport[0]=1/this._renderContext.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/this._renderContext.camera.fullViewport[3];}ensureBindParameters(e){var r;this.ensureCameraBindParameters(e);const t=this._renderContext.offscreenRenderingHelper;this._bindParameters.shadowMap=this._renderContext.shadowMap,this._bindParameters.shadowMappingEnabled=this._renderContext.shadowMap.enabled,this._bindParameters.ssaoHelper=this._renderContext.ssaoHelper,this._bindParameters.ssaoEnabled=this._renderContext.ssaoHelper.enabled,this._bindParameters.slicePlane=this._renderContext.sliceHelper.plane,this._bindParameters.hasOccludees=this._renderContext.hasOccludees,this._renderContext.multipassTerrainParams.camera=this._renderContext.camera,this._bindParameters.hudVisibilityTexture=t.hudVisibilityTexture,this._bindParameters.highlightDepthTexture=null!=(r=t.depthTexture)?r:this.getFallbackDepthTexture();}ensureBindParametersSSR(){this.hasWaterReflection?(this._renderContext.lastFrameCamera.equals(this._renderContext.camera)?this._renderContext.ssrParams.reprojectionMatrix=this._reprojectionMatrix=a$16:(c$U(J,this._renderContext.lastFrameCamera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),c$U(X,this._renderContext.camera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),h$x(X,X),h$x(K,this._renderContext.camera.projectionMatrix),e$G(Y,X,K),e$G(Y,J,Y),e$G(Y,this._renderContext.lastFrameCamera.projectionMatrix,Y),this._renderContext.ssrParams.reprojectionMatrix=this._reprojectionMatrix=Y),this._renderContext.ssrParams.camera=this._renderContext.camera,this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=null,this._renderContext.ssrParams.ssrEnabled=this._bindParameters.ssrEnabled=this.hasWaterReflection;}renderInternalSlot(e,r){let t=!1;return this._bindParameters.slot=e,r$A(r)?r.forEach((r=>{if(!r.shouldRender(this._renderContext))return;const s=this._materialRenderers.get(r);r$A(s)&&(t=s.render(e,this._renderContext.pass,this._bindParameters)||t);})):this._materialRenderers.forEach(((r,s)=>{s.shouldRender(this._renderContext)&&(t=r.render(e,this._renderContext.pass,this._bindParameters)||t);})),t}getFallbackDepthTexture(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=g$C(this._rctx)),this._fallbackDepthStencilTexture}get gpuMemoryUsage(){var e,r,t,s,n,i,a,h,o,d;return {offscreen:null!=(e=null==(r=this._offscreenRendering)?void 0:r.gpuMemoryUsage)?e:0,highlights:(null!=(t=null==(s=this._highlightHelper)?void 0:s.gpuMemoryUsage)?t:0)+(null!=(n=null==(i=this._shadowHighlightHelper)?void 0:i.gpuMemoryUsage)?n:0),shadows:null!=(a=null==(h=this._shadowMap)?void 0:h.gpuMemoryUsage)?a:0,ssao:null!=(o=null==(d=this._ssaoHelper)?void 0:d.gpuMemoryUsage)?o:0}}get test(){const e=this;return {offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlightHelper,lighting:this._lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,enableNewAtmosphere:e=>{this._enableNewAtmosphere=e;},getFramebufferTexture:r=>{var t;switch(r){case 0:return e._offscreenRendering.colorTexture;case 1:return e._offscreenRendering.linearDepthTexture;case 2:return e._offscreenRendering.normalTexture;case 3:return null==(t=e._shadowMap)?void 0:t.test.depthTexture;case 4:return e._offscreenRendering.hudVisibilityTexture;case 5:return e._offscreenRendering.highlightTexture}}}}};e$x([d$y()],B.prototype,"_shadowAccumulator",void 0),e$x([d$y()],B.prototype,"_smaaPass",void 0),e$x([d$y()],B.prototype,"_antialiasing",void 0),e$x([d$y()],B.prototype,"_edgeView",void 0),e$x([d$y()],B.prototype,"updating",null),e$x([d$y()],B.prototype,"isCameraFinal",null),B=e$x([i$H("esri.views.3d.webgl-engine.lib.Renderer")],B);const Q=[],z=[],J=e$y(),K=e$y(),X=e$y(),Y=e$y();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class t$1 extends o$10{constructor(e,t,n){super(e,t),this.newCache=n;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const f$1=s$y.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository");let m=class extends p$N{constructor(e,t,s){super({}),this._stage=e,this._techniqueRepository=t,this._rctx=s,this._idToRefCountedTexture=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new n$L,this._frameTask=e.resourceController.scheduler.registerTask(f$u.TEXTURE_UNLOAD);}normalizeCtorArgs(){return {}}dispose(){this._frameTask.remove(),this._stage.forEachOfType(4,(e=>e.unload()));}get updating(){return this._loadingCount>0||this._frameTask.updating}get textureTechnique(){return t$F(this._textureTechnique)&&(this._textureTechnique=this._techniqueRepository.acquire(u$T,new m$I)),this._textureTechnique}acquire(e){const t=this._idToRefCountedTexture.get(e);return t?(t.ref(),Promise.resolve(t)):this._createNewRef(e)}update(){let e=!1;this._frameUpdates.forEach((t=>{const r=t.texture.frameUpdate(this._rctx,this.textureTechnique,t.previousToken);r>=0&&r!==t.previousToken&&(t.previousToken=r,e=!0);})),e&&this.events.emit("changed",0);}async _createNewRef(e){const t=this._stage.getObject(e);if(t$F(t))return i$13(void 0!==t),null;const r=t.events.on("unloaded",(()=>{r.remove(),this._onTextureUnloaded(e);})),s=new l$2(e,(()=>{this._frameTask.schedule((()=>{s.isUnreferenced&&t.unload();}));}));return this._idToRefCountedTexture.set(e,s),s.ref(),r$A(t.glTexture)?(this._updateGLTexture(s,t.glTexture),t.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:t,previousToken:-1})):(this._loadingCount++,await this._stage.schedule((()=>{const r=t.load(this._rctx,(()=>this.textureTechnique)),o=r=>(this._loadingCount--,this._updateGLTexture(s,r),t.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),s),i=e=>{this._loadingCount--,d$B(e)||f$1.error(e);};return O$q(r)?r.then(o,i):o(r)}))),s}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",1);}_onTextureUnloaded(e){this._idToRefCountedTexture.delete(e),this._frameUpdates.delete(e);}};e$x([d$y()],m.prototype,"_loadingCount",void 0),e$x([d$y()],m.prototype,"_frameTask",void 0),e$x([d$y()],m.prototype,"updating",null),m=e$x([i$H("esri.views.3d.webgl-engine.lib.TextureRepository")],m);class l$2{constructor(e,t){this.id=e,this._release=t,this._refCount=0;}get isUnreferenced(){return 0===this._refCount}ref(){++this._refCount;}release(){--this._refCount,this._refCount>0||(0!==this._refCount?(f$1.error("Cannot dereference texture that has no references!"),this._refCount=0):this._release());}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const n$1=s$y.getLogger("esri.views.3d.webgl-engine.materials.internal.waterMaterialUtils");let l$1=class extends p$N{constructor(){super(...arguments),this._data=new Array,this.loadingState=0;}dispose(){this.loadingState=0,this._data.forEach((t=>t.dispose())),this._data.length=0;}get updating(){return 1===this.loadingState}get ready(){return 2===this.loadingState}loadTextures(t){const r=[a$1c("esri/images/materials/water/normals.jpg"),a$1c("esri/images/materials/water/perturbation.jpg")];this.loadingState=1,Promise.all(r.map((t=>t$R(t)))).then((e=>{e.forEach((e=>this._data.push(new o$G(t,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:10497,samplingMode:9987,hasMipmap:!0,maxAnisotropy:8,width:e.width,height:e.height},e)))),this.loadingState=2;})).catch((t=>{n$1.error("Failed to load textures for water material.",t),this.loadingState=0;}));}bind(t){this.ready&&(t.bindTexture(this._data[0],"texWaveNormal"),t.bindTexture(this._data[1],"texWavePerturbation"));}};e$x([d$y()],l$1.prototype,"loadingState",void 0),e$x([d$y({type:Boolean,readOnly:!0})],l$1.prototype,"updating",null),l$1=e$x([i$H("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],l$1);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
class h extends e$V{constructor(e,t,r,s=null,i,n=!0){super(),this._rctx=e,this._renderScene=t,this._requestRenderScene=r,this._renderOverlay=s,this.forceCameraHook=i,this.supersample=n,this._screenshotQueue=new Array;}dispose(){this._rctx=null;}takeScreenshot(e){this._requestRenderScene(0);const r=B$f();return this._screenshotQueue.push({settings:e,resolver:r}),r.promise}update(e){for(const t of this._screenshotQueue){if(this.isDisposed){t.resolver.reject();continue}const r={...t.settings,pixelRatio:t.settings.pixelRatio*e.viewCamera.pixelRatio},s=this._ensureScreenshotEncodeCanvas(),n=this._renderScreenshot(e,r),o=a$1d(n,r,s,{flipY:!0,premultipliedAlpha:!0});t.resolver(o);}this._screenshotQueue.length=0;}_renderScreenshotOverlay(t,r,s){if(t$F(this._renderOverlay))return r;t.width=r.width,t.height=r.height;const i=t.getContext("2d"),n=s.pixelRatio;return i.save(),i.translate(0,r.height),i.scale(1,-1),s.region&&i.translate(-s.region.x,-s.region.y),i.scale(n,n),r=this._renderOverlay(t,r),i.restore(),r}_readbackScreenshot(e){return e.resample?this._readbackScreenshotResampled(e):this._readbackScreenshotImmediate(e)}_readbackScreenshotResampled(e){const{framebufferWidth:t,framebufferHeight:r,region:s,resample:i}=e,a=this._ensureScreenshotEncodeCanvas();let h=f$L(t,r,a);this._rctx.gl.readPixels(0,0,t,r,6408,5121,new Uint8Array(h.data.buffer)),h=this._renderScreenshotOverlay(a,h,{...e,region:null});const c=f$L(s.width,s.height,a);return d$T(h,c,!0,i.region.x,r-(i.region.y+i.region.height),i.region.width,i.region.height)}_readbackScreenshotImmediate(e){const{framebufferHeight:t,region:r}=e,s=this._ensureScreenshotEncodeCanvas(),i=f$L(r.width,r.height,s);return this._rctx.gl.readPixels(r.x,t-(r.y+r.height),r.width,r.height,6408,5121,new Uint8Array(i.data.buffer)),this._renderScreenshotOverlay(s,i,e)}_renderScreenshot(e,t){let s=null;const i=e.viewCamera,{framebufferWidth:n,framebufferHeight:o}=t;let h=!1;const c=t.disableDecorations&&e.frameHasDecorations,l=n!==i.fullWidth||o!==i.fullHeight,d=t.ignorePadding&&i.pixelRatio!==t.pixelRatio,f=l||c||d;if(f){const e=i.clone();if(t.ignorePadding){const s=t$16(e.padding);for(let r=0;r<4;r++)s[r]=Math.round(s[r]/e.pixelRatio*t.pixelRatio);e.padding=s;}e.fullWidth=n,e.fullHeight=o,e.pixelRatio=t.pixelRatio;const c=i.fovX-e.fovX,l=i.fovY-e.fovY;c<0&&c<l?e.fovX=i.fovX:l<0&&l<c&&(e.fovY=i.fovY),this.forceCameraHook(e),h=!0,s=new l$F(this._rctx,{width:e.fullWidth,height:e.fullHeight,colorTarget:0,depthStencilTarget:3}),this._renderScene(s,e,t.disableDecorations?0:1);}const u=this._readbackScreenshot(t);if(f&&!this._rctx.contextAttributes.alpha)for(let r=3;r<u.data.length;r+=4)u.data[r]=255;return s&&s.dispose(),this._rctx.bindFramebuffer(null),h&&this.forceCameraHook(i),u}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const L=s$y.getLogger("esri.views.3d.webgl-engine.parts.View");let H=class extends(s$_(p$N)){constructor(e){super({}),this.events=new n$L,this.waterTextureRepository=new l$1,this._magnifierHelper=new x$1,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._logicUpdateLast=0,this._container=e.container,this._initializeContext(e),i$P(this.waterTextureRepository,"loadingState",(()=>this.requestRender())),this._magnifierHelper.events.on("request-render",(()=>this.requestRender())),this._stippleTextureRepository=new s$$(this._rctx),this._shaderTechniqueRepository=new n$1f({rctx:this._rctx,viewingMode:e.viewingMode,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),this._textureRepository=new m(e,this._shaderTechniqueRepository,this._rctx),this._textureRepository.events.on("changed",(e=>this.requestRender(e))),this._materialRepository=new n$1g(this._textureRepository,this._shaderTechniqueRepository,(()=>this.requestRender()),(()=>this.requestRender())),this._compositingHelper=new a$6(this._rctx,this._shaderTechniqueRepository),this._renderer=new B(this._materialRepository,this._textureRepository,this._shaderTechniqueRepository,this._rctx,this._compositingHelper,this._magnifierHelper,(e=>this.requestRender(e)),((t,r)=>e.schedule(t,r)),e),this._screenshotManager=new h(this._rctx,((e,t,r)=>this._renderer.render(e,t,t,r)),(e=>this.requestRender(e)),e.options.screenshot.renderOverlay,(e=>this.events.emit("force-camera-for-screenshot",e))),this._registerFrameTask(e);}normalizeCtorArgs(){return {}}dispose(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=s$E(this._frameTask),this._shaderTechniqueRepository=i$M(this._shaderTechniqueRepository),super.dispose(),this._tmpDepthBuffer=null,this._rctx=null;}get performanceInfo(){const e=this._rctx.gl;return {renderer:this._renderer.performanceInfo,textureMemory:void 0!==e.getUsedTextureMemory?e.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==e.getUsedRenderbufferMemory?e.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==e.getUsedVBOMemory?e.getUsedVBOMemory():void 0}}requestRender(e=1){1===e?this._needsUpdate=!0:this._needsRender=!0;}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this._renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}ensureEdgeView(){return this._renderer.ensureEdgeView()}get edgeView(){return this._renderer.edgeView}get textureRepository(){return this._textureRepository}get compositingHelper(){return this._compositingHelper}set magnifier(e){this._magnifierHelper.magnifier=e;}updateLightSources(e,t,r){this._renderer.updateLightSources(e,t,r),this.requestRender();}setRenderParameters(e){void 0!==e.idleSuspend&&this._idleSuspend!==!!e.idleSuspend&&(this._idleSuspend=!!e.idleSuspend,this.requestRender()),this._renderer.setRenderParameters(e);}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}modify(e){this._renderer.modify(e),e.clear();}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e)}get hasShadowsEnabled(){return this._renderer.hasShadowsEnabled}readAccumulatedShadow(e){return this._renderer.readAccumulatedShadow(e[0],e[1])}getMinimalDepthForArea(e,t,r,i,s=i){const o=r.constrainWindowSize(e,t,i*r.pixelRatio,s*r.pixelRatio),n=this._ensureDepthBuffer(o);this._renderer.readDepthPixels(r,o[0],o[1],o[2],o[3],n);let a=Number.MAX_VALUE;for(let p=0;p<o[2]*o[3];p++){const e=M$2(4*p,n,r.nearFar);a>e&&e!==r.nearFar[0]&&e!==r.nearFar[1]&&(a=e);}return a===Number.MAX_VALUE?void 0:a}_ensureDepthBuffer(e){const t=4*e[2]*e[3];return (t$F(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}get renderPlugins(){return this._renderer.renderPlugins}get test(){return {renderer:this._renderer}}get gpuMemoryUsage(){return this._renderer.gpuMemoryUsage}async reloadShaders(){e$h(),await this._shaderTechniqueRepository.reloadAll(),this.requestRender();}_registerFrameTask(e){const t=e.state,r={viewCamera:t.camera,frameHasDecorations:!1},i={preRender:r=>{e.processSyncLayers();const i=n$W(r.time-this._logicUpdateLast);if(i>r$j||r$A(this.forcedAnimationTime)){const e={camera:t.camera,dt:i,forcedTime:this.forcedAnimationTime};this._logicUpdateLast=r.time,this._renderer.updateLogic(e)&&this.requestRender(0);}},render:()=>{if((this._needsUpdate||this._needsRender||!this._idleSuspend||!this._renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const e=this._needsUpdate&&this._idleSuspend&&this._renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this._renderer.render(null,t.camera,t.contentCamera,1),e&&this._renderer.hasWaterReflection&&(this.requestRender(0),this._needsWaterReflectionUpdate=!0);}},update:()=>{r.viewCamera=t.camera,r.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled,this._textureRepository.update(),this._screenshotManager.update(r);}};this._frameTask=A$n(i);}_initializeContext(e){const t=e.options;this._canvas=t.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const r={alpha:t.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==t.stencil||t.stencil,powerPreference:"high-performance"};let s;const o=s$H("esri-force-webgl");if(1===o||2===o?s=t$17(this._canvas,o,r):(s=r$1a(this._canvas,2,r),t$F(s)&&(s=t$17(this._canvas,1,r))),t$F(s))return void L.error(o);const n={disabledExtensions:t.deactivatedWebGLExtensions||{},debugWebGLExtensions:t.debugWebGLExtensions||{},maxAnisotropy:8};this._rctx=new t$1(s,n,((t,r)=>e.resourceController.memoryController.newCache(t,r))),this._loadShaderOnlyExtensions(),!t.alpha&&this._rctx.contextAttributes.alpha&&L.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&s$H("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas);}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("standardDerivatives"),this._rctx.capabilities.enable("shaderTextureLOD"),this._rctx.capabilities.enable("textureFloat");}get componentObjectCollection(){return t$F(this._componentObjectCollection)&&(this._componentObjectCollection=new H$2(this._renderer.renderPassManager)),this._componentObjectCollection}set componentObjectCollection(e){this._componentObjectCollection=e;}};e$x([d$y({type:Boolean,readOnly:!0})],H.prototype,"updating",null),e$x([i$14()],H.prototype,"_rctx",void 0),e$x([i$14()],H.prototype,"_container",void 0),e$x([i$14()],H.prototype,"_canvas",void 0),e$x([i$14()],H.prototype,"_stippleTextureRepository",void 0),e$x([i$14(),d$y()],H.prototype,"waterTextureRepository",void 0),e$x([i$14(),d$y()],H.prototype,"_magnifierHelper",void 0),e$x([i$14(),d$y()],H.prototype,"_textureRepository",void 0),e$x([i$14()],H.prototype,"_compositingHelper",void 0),e$x([i$14()],H.prototype,"_renderer",void 0),e$x([i$14()],H.prototype,"_screenshotManager",void 0),e$x([i$14()],H.prototype,"componentObjectCollection",null),e$x([i$14()],H.prototype,"_componentObjectCollection",void 0),e$x([d$y()],H.prototype,"_needsUpdate",void 0),e$x([d$y()],H.prototype,"_needsWaterReflectionUpdate",void 0),H=e$x([i$H("esri.views.3d.webgl-engine.parts.RenderView")],H);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
var f;let w=f=class extends(s$_(p$N)){constructor(e){super(e),this._handles=new u$D,this._model=new l$9,this._layers=new n$Z,this._changeSet=new r$1b,this._layerSyncSet=new Set;}initialize(){this._set("renderView",new H(this)),this._frameTask=this.resourceController.scheduler.registerTask(f$u.STAGE,this),this._handles.add(this._frameTask);}destroy(){o$U.pool.prune(0),this._handles.destroy(),this.dispose();}get viewingMode(){return this.state.viewingMode}get updating(){return this._model.dirtySet.dirty||this.renderView.updating||this._frameTask.updating}add(e){this._model.add(e),l$Q(e)&&(e.attachStage(this),this._addLayer(e)),this.renderView.requestRender();}remove(e){t$F(e)||(this.renderView.requestRender(),this._model.remove(e),l$Q(e)&&(this._removeLayer(e),e.detachStage()));}addMany(e){r$A(e)&&(this._model.addMany(e),this.renderView.requestRender());}removeMany(e){r$A(e)&&(this._model.removeMany(e),this.renderView.requestRender());}async load(e){t$F(e)||(Array.isArray(e)||(e=[e]),await s$z(e.filter((e=>t$F(e.glTexture))).map((e=>this.schedule((()=>e.load(this.renderView.renderingContext,(()=>this.renderView.textureRepository.textureTechnique))))))));}loadSynchronous(e){return e.load(this.renderView.renderingContext,(()=>this.renderView.textureRepository.textureTechnique))}forEachOfType(e,t){this._model.forEachOfType(e,t);}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender());}get running(){return this._model.dirtySet.dirty}runTask(e){this._frameTask.processQueue(e),e.done||this._commit();}_commit(){const e=this._model.dirtySet;f.DebugSettings.logDirtySet&&console.log("Dirty set: "+e.formatDebugInfo()),e.commit(this._changeSet),f.DebugSettings.logDirtySet&&(console.log("RGs add: "+this._changeSet.adds.map((e=>e.id))),console.log("RGs remove: "+this._changeSet.removes.map((e=>e.id)))),this._layerSyncSet.clear(),this.renderView.modify(this._changeSet),this.renderView.requestRender();}schedule(e,t){return this._frameTask.schedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender();}processSyncLayers(){const e=this._model.dirtySet;this._layers.forAll((t=>{(this._layerSyncSet.has(t.id)||1===t.updatePolicy)&&(e.commitLayer(t.id,this._changeSet),this._layerSyncSet.delete(t.id));}));for(const t of this._layerSyncSet)e.commitLayer(t,this._changeSet);this._layerSyncSet.clear(),this.renderView.modify(this._changeSet);}getObject(e){return this._model.getObject(e)}get layers(){return this._layers}_addLayer(e){this._layers.some((t=>t===e))||this._layers.push(e);}_removeLayer(e){this._commit(),null!=this._layers.removeUnordered(e)&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._changeSet.removes),this.renderView.modify(this._changeSet));}addRenderPlugin(e,t,r){const s=this.renderView.renderPlugins.add(e,t,r),o=()=>{x$9(t)&&this.sceneIntersectionHelper.addIntersectionHandler(t);};if(q$l(s))return s.then(o);o();}removeRenderPlugin(e){x$9(e)&&this.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderView.renderPlugins.remove(e);}get performanceInfo(){return {renderView:this.renderView.performanceInfo,model:this._model.getStats()}}get test(){const e=this;return {getCount:t=>e._model.test.content.filter((e=>e.type===t)).length,model:e._model}}};w.DebugSettings={endFrameContentValidation:!1,logDirtySet:!1},e$x([d$y({constructOnly:!0})],w.prototype,"resourceController",void 0),e$x([d$y({constructOnly:!0})],w.prototype,"options",void 0),e$x([d$y({constructOnly:!0})],w.prototype,"state",void 0),e$x([d$y({constructOnly:!0})],w.prototype,"sceneIntersectionHelper",void 0),e$x([d$y({readOnly:!0})],w.prototype,"viewingMode",null),e$x([d$y({constructOnly:!0})],w.prototype,"container",void 0),e$x([d$y({constructOnly:!0})],w.prototype,"renderSR",void 0),e$x([d$y({constructOnly:!0})],w.prototype,"_handles",void 0),e$x([d$y({readOnly:!0})],w.prototype,"updating",null),e$x([d$y({constructOnly:!0})],w.prototype,"_model",void 0),e$x([i$14(),d$y()],w.prototype,"renderView",void 0),w=f=e$x([i$H("esri.views.3d.webgl-engine.Stage")],w);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
function t(e,r){var a;switch(null==(a=e.target)?void 0:a.type){case"stage":return l(e.target.obj.metadata,r);case"external":switch(e.intersector){case"PointRenderer":return u(e.target,r);case"I3S":case"IM":case"LodRenderer":case"OverlayRenderer":return l(e.target.metadata,r);case"TerrainRenderer":return r.map&&r.map.ground}}return null}function n(e,r){var a;switch(null==(a=e.target)?void 0:a.type){case"stage":return i(e.target.obj.metadata,r);case"external":switch(e.intersector){case"PointRenderer":return d(e.target);case"I3S":case"IM":case"LodRenderer":case"OverlayRenderer":return i(e.target.metadata,r)}}return null}function i(t,n){if(t$F(t))return null;const i=l(t,n);if(t$F(i))return null;if(i===n.graphics)return r$A(n.graphicsView)?e$z(n.graphicsView.getGraphicFromGraphicUid(t.graphicUid)):null;const u=n.allLayerViews.find((e=>e.layer===i));return u?c(u,t):null}function c(e,r){return !e||e.suspended?null:"getGraphicFromIntersectorMetadata"in e&&r?e.getGraphicFromIntersectorMetadata(r):"getGraphicFromGraphicUid"in e&&null!=r.graphicUid?e.getGraphicFromGraphicUid(r.graphicUid):null}function l(a,t){return t$F(a)||null==a.layerUid?null:r$A(t.graphicsView)&&a.layerUid===t.graphicsView.graphics3d.layer.id?t.graphics:t.map.findLayerByUid(a.layerUid)}function u(e,r){const a=e.metadata.layerUid;return null!=a?r.map.findLayerByUid(a):null}function d(e){return e.metadata.createGraphic()}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
let e=class extends u$U{constructor(o){super(o),this.components=["attribution","zoom","navigation-toggle","compass"];}};e$x([d$y()],e.prototype,"components",void 0),e=e$x([i$H("esri.views.ui.3d.DefaultUI3D")],e);const p=e;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
const ke=s$y.getLogger("esri.views.SceneView");let Ne=class extends(m$J(_$j(a$1e(P$p)))){constructor(e){super(e),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._defaults={},this._externallySet={environment:!1},this._createGraphicsViewController=null,this._resolveWhenReady=[],this.propertiesPool=new o$O({slicePlane:z$m},this),this._resourceController=g$d(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new d$k({view:this}),this.labeler=new I$7({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.basemapTerrain=null,this.elevationProvider=null,this.camera=null,this.canvas=null,this.center=null,this.constraints=new a$E,this.environmentManager=new j$k,this.extent=null,this.floors=new S$o,this.windowDevicePixelRatio=1,this.fullOpacity=1,this.graphicsView=null,this.groundView=null,this.navigating=!1,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new g$e,this.scale=null,this.spatialReference=null,this.isHeightModelInfoRequired=!0,this.alphaCompositingEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new p,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.viewpoint=null,this.zoom=null,this.highlightOptions=new e$k,c$14(),e&&e.environment||(this._defaults.environment=new u$u,this.environment=this._defaults.environment);const t=e=>{r$A(e)&&4===e.type||(this.updatingChanged(),this.map&&this.map.allLayers.forEach((async e=>{try{await e.when();}catch{}this.updatingChanged();})));};this.handles.add([$$9(this,"map.allLayers","after-changes",t,t,t,!0),this.allLayerViews.on("after-changes",(e=>this._updateUpdatingMonitors(e))),this.watch("map",(e=>{e&&e.load&&e.load().catch((()=>{}));}))]),this.inputManager=new k$8({view:this});const i=()=>{const e=window.devicePixelRatio;e!==this.windowDevicePixelRatio&&(this.windowDevicePixelRatio=e,this.notifyChange("pixelRatio"));};this.stateManager=new L$7({view:this,updateDevicePixelRatio:i});}initialize(){this.groundView=new l$v({view:this}),this._updateUpdatingMonitors();const e=()=>this._updateDefaultToMapOptions();this.handles.add($$9(this,"map.allLayers","after-changes",e,e,e)),this.updatingHandles.add(this.qualitySettings,"memoryLimit",(e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e);}),2),this.updatingHandles.add(this.qualitySettings,"additionalCacheMemory",(e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e);}),2),this.updatingHandles.add(this.qualitySettings,"frameRate",(e=>F$i(e>0?1e3/Math.ceil(e):0)),2),this.updatingHandles.add(I$j,"SCENEVIEW_LOCKING_LOG",(e=>this.defaultsFromMap.logDebugInformation=e),2),this.updatingHandles.add(this,"map.ground",e,3),this.updatingHandles.add(this,"map.ground.opacity",(()=>this._updateDefaultHitTestOptions()),3),this.handles.add(this.watch("spatialReference",(()=>this.notifyChange("clippingArea")),!0));}destroy(){this.destroyed||(this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=l$E(this.sharedSymbolResources),this.labeler.destroy(),this._set("labeler",null),this.deconflictor.destroy(),this._set("deconflictor",null),this._resourceController=l$E(this._resourceController),this.stateManager.destroy(),this._set("stateManager",null),this.inputManager.destroy(),this._set("inputManager",null),this.propertiesPool.destroy(),this.handles.remove("updatingMonitors"),this.environmentManager.destroy(),this._set("environmentManager",null),this.groundView=l$E(this.groundView));}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){return this.basemapTerrain&&this.basemapTerrain.spatialReference}installContentCameraReset(e={sticky:!1}){return this.stateManager.installContentCameraReset(e)}get clippingArea(){if("global"===this.viewingMode)return null;let e=this._userClippingArea||this.get("map.clippingArea");return !(!!this._userClippingArea||this.get("map.clippingEnabled"))||t$F(e)?(this._clippingArea=null,null):e instanceof M$g?this.spatialReference&&(e=Qe(e,this.spatialReference),t$F(e))?(ke.error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(e=e.clone(),t$F(e.intersection(this.groundAndLayersExtent))&&(e.xmin=e.xmax,e.ymin=e.ymax),e.zmin=void 0,e.zmax=void 0,e.equals(this._clippingArea)||(this._clippingArea=e),this._clippingArea):(ke.error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(e){this.ready&&"global"===this.viewingMode&&r$A(e)?ke.error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e;}get renderDataExtent(){if(1===this.state.viewingMode)return null;const e=this.renderSpatialReference,t=this.dataExtent;return t$F(t)||t$F(e)||t.spatialReference.equals(e)?t:Qe(t,e)}get dataExtent(){let e=this.groundAndLayersExtent;const t=this.spatialReference||k$l.WGS84,i=Qe(this.clippingArea,t);r$A(i)&&(e=r$A(e)?e.intersection(i):i);const r=this._get("dataExtent");return r$A(e)&&e.equals(r)?r:e}get groundAndLayersExtent(){const e=this.spatialReference||k$l.WGS84;let t;const i=i=>{const r=Qe(i,e);t$F(r)||(r$A(t)?t.union(r):t=r.clone());},r=this.basemapTerrain;if(null!=r&&r.spatialReference){const e=r.groundExtent;i(new M$g({xmin:e[0],ymin:e[1],zmin:0,xmax:e[2],ymax:e[3],zmax:0,spatialReference:r.spatialReference}));}if(this.map){const e=e=>{!r$A(e.fullExtent)||"graphics"===e.type&&e.internal||i(e.fullExtent);};this.map.allLayers.forEach((t=>e(t)));}if(t$F(t))return null;t.hasZ?(t.zmin=Math.min(0,t.zmin),t.zmax=Math.max(0,t.zmax)):(t.zmin=0,t.zmax=0);const s=this._get("groundAndLayersExtent");return t.equals(s)?s:t}set environment(e){e!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",e);}castEnvironment(e){return e?e instanceof u$u?e:e instanceof c$K?null!=this.environment?this.environment.cloneWithWebsceneEnvironment(e):u$u.fromWebsceneEnvironment(e):b$n(u$u,e):new u$u}get pixelRatio(){return Math.min(this.windowDevicePixelRatio,this.maximumPixelRatio)}set pixelRatio(e){r$A(e)?this._override("pixelRatio",e):this._clearOverride("pixelRatio");}get maximumPixelRatio(){let e=1/0;const{maximumPixelRatio:t,maximumRenderResolution:i}=this.qualitySettings;if(null!=t&&(e=Math.min(e,t)),null!=i){const t=i/Math.max(this.width,this.height);e=Math.min(e,t);}return e}set maximumPixelRatio(e){r$A(e)?this._override("maximumPixelRatio",e):this._clearOverride("maximumPixelRatio");}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get interacting(){return this.navigating||r$A(this.activeTool)}get stationary(){return !this.animation&&!this.resizing&&(t$F(this.state)||this.state.stationary)}set qualityProfile(e){o$l.isValidProfile(e)&&(o$l.apply(e,this.qualitySettings),this._set("qualityProfile",e));}get qualityProfile(){return this._get("qualityProfile")||o$l.getDefaultProfile()}set slicePlane(e){if(this._stage.renderView.setRenderParameters({slicePlane:e}),t$F(e))return void this._set("slicePlane",null);const t=this.propertiesPool.get("slicePlane");D$i(e,t),this._set("slicePlane",t);}get resolution(){return null!=this.spatialReference?i$K(this.scale,this.spatialReference):0}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return null!=e?v$t.deriveUnitFromSR(e,this.spatialReference):null}get updating(){var e,t,i;if(this.destroyed)return !1;let r=0,s=this.layerViewManager.updating,n=s?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach((e=>{if(e.isFulfilled()){if(e.updating){if(s=!0,e.suspended||E$k(e))return;++n,r+=e.updatingProgress;}}else ++n;}));for(const a of [this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this.featureTreeDebugger,this.toolViewManager])if(r$A(a)&&a.updating){const e=.1;n+=e,r+=.5*e;}for(const a of [this.deconflictor,this.labeler,this.basemapTerrain])r$A(a)&&a.updating&&(++n,r+=a.updatingProgress);if(s=!!(s||n>0||this.updatingHandles.updating||!this.ready||!this.stationary||this._createGraphicsViewController||null!=(e=this.inputManager)&&e.hasPendingInputs||null!=(t=this.map)&&null!=(i=t.allLayers)&&i.some((e=>!e.isFulfilled()))),s?(this._numUpdating=Math.max(n,this._numUpdating),r+=this._numUpdating-n):this._numUpdating=0,this._numUpdating>0?r/=this._numUpdating:r=s?0:1,this._get("updatingProgress")!==r){const e=this._resourceController.scheduler.now;if(r<1){const t=Math.min((e-this._lastUpdateTime)/2e3,1);r=this.updatingProgress*(1-t)+r*t;}this._set("updatingProgress",r),this._lastUpdateTime=s&&r<1?e:0;}return s}get viewingMode(){const e=this.get("map.initialViewProperties.viewingMode");if(e)return e;const t=this.spatialReference;return !t||i$J(t,"global")?"global":"local"}set viewingMode(e){if(this.ready)ke.error("#viewingMode","viewingMode cannot be set once view is ready");else {["local","global"].indexOf(e)>=0?this._override("viewingMode",e):void 0===e&&this._clearOverride("viewingMode");}}get resourceController(){return this._resourceController}get performanceInfo(){return new t$p(this)}forceAnimationTime(e){this._stage.renderView.forcedAnimationTime=this.basemapTerrain.overlayManager.forcedAnimationTime=e;}on(e,t,i,r){const s=this.viewEvents.on(e,t,i,r);return s||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return ke.error("#toMap()","Scene view cannot be used before it is ready"),null;const i=t?this.externalToInternalIntersectOptions(t):this._defaultToMapOptions,r=r$A(i.graphics)&&(r$A(i.graphics.include)||r$A(i.graphics.exclude)),s=i$1a(e)?c$15(this,e):e,n$1=d$H(s);i.enableDraped=i.include&&!i.include.has(O$p)||i.exclude&&i.exclude.has(O$p);const a=this.sceneIntersectionHelper,o=new y$s(this.state.viewingMode);if(o.options.selectionMode=!0,o.options.store=r?2:0,a.intersectIntersectorScreen(n$1,o,i),r){for(const e of o.results.all){const t=n(e,this);if(t$F(t))return this._intersectResultToMapPoint(e);if(this._testGraphicUidFilter(i.graphics,t))return this._intersectResultToMapPoint(e)}return null}return this._intersectResultToMapPoint(o.results.min)}toScreen(e){if(!this.ready)return ke.error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=c$N(null==e.z&&i$I(this.elevationProvider,e),0);return wn(e,Ke,this.renderSpatialReference,t),this.state.camera.projectToScreen(Ke,Ze),c$X(Ze[0],Ze[1])}pixelSizeAt(e){return this.ready?e?(wn(e,Ke,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(Ke)):0:(ke.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e):1}hitTest(e,t$1){if(!this.ready)return ke.error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=i$1a(e)?c$15(this,e):e,r=i$S(i.x,i.y),s=t$1?this.externalToInternalIntersectOptions(t$1):this._defaultHitTestOptions;s.requiresGroundFeedback=!0,s.enableDraped=!0;const n=new y$s(this.state.viewingMode);n.options.selectionMode=!0,n.options.store=2,this.sceneIntersectionHelper.intersectIntersectorScreen(r,n,s);const a=this._intersectResultsToHits(n.results.all,s.graphics),o=n.results.ground,l=t(o,this),p=r$A(l)&&"type"in l&&"integrated-mesh"===l.type?l:null,h={screenPoint:i,results:a,ground:{mapPoint:this._intersectResultToMapPoint(o),distance:o.hasIntersectionPoint?o.distanceInRenderSpace:0,layer:p}};return I$j.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(h.intersector=n),Promise.resolve(h)}popupHitTest(e){return t$18(this,e).then((({results:t,ground:i})=>{let r=null;return !(0===t.length||Math.abs(t[0].distance-i.distance)<1e-5)||i.layer&&"integrated-mesh"===i.layer.type||(r=i.mapPoint),{results:t,screenPoint:e,mapPoint:r}}))}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}async whenAnalysisView(e){if(t$F(e.parent))throw new s$w("view:no-analysisview-for-analysis","The analysis has not been added to an AnalysisLayer",{analysis:e});return (await this.whenLayerView(e.parent)).whenAnalysisView(e)}whenLayerView(e){return super.whenLayerView(e)}takeScreenshot(e){return this.whenReady().then((()=>{const t=o$11(e,this);return t.pixelRatio/=this.pixelRatio,this._stage.renderView.takeScreenshot(c$16(t,this.supersampleScreenshotsEnabled,this.padding))}))}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return o$y.importLayerView(e)}hasLayerViewModule(e){return o$y.hasLayerViewModule(e)}forceDOMReadyCycle(){this.forceReadyCycle();}getDefaultSpatialReference(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")||this.get("defaultsFromMap.isSpatialReferenceDone")&&this._initialDefaultSpatialReference||null}async validate(){let e=s$10();if(s$H("safari")&&s$H("safari")<9&&(e=new s$w("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:s$H("safari")})),r$A(e))throw ke.warn("#validate()",e.message),e}isSpatialReferenceSupported(e,t,i){const r=e.isGeographic,s=e.isWebMercator,n=i$J(e,"global"),a="local"===this.viewingMode,o=!(!this._isOverridden("viewingMode")&&!this.get("map.initialViewProperties.viewingMode"));if(o){if(a&&r&&!i$J(e,"local"))return i?i(`Layer ${t.id} is ignored because its spatial reference is not supported in local viewing mode`):ke.warnOnce("Spatial reference defined on view not supported in local viewing mode."),!1;if(!a&&!n)return i?i(`Layer ${t.id} is ignored because its spatial reference is not supported in global viewing mode`):ke.warnOnce("Spatial reference defined on view not supported in global viewing mode."),!1}else if(r&&!n)return i?i(`Layer ${t.id} is ignored because its spatial reference is geographic but unsupported`):ke.warnOnce("Spatial reference is geographic but not supported."),!1;if(t)if(e$O(t)){let r;if(o){r=null!=b$t(t,e,l$u(this.viewingMode)).tileInfo;}else {let i=b$t(t,e,1);null==i.tileInfo&&(i=b$t(t,e,2),null!=i.tileInfo&&s&&!this.ready&&(this.viewingMode="local")),r=null!=i.tileInfo;}if(!r)return i&&i(`Layer ${t.id} is ignored because it is tiled but\n            its tiling scheme is not supported or compatible with the viewing mode`),!1}else if((e.isWGS84||s)&&!a)return null==this._initialDefaultSpatialReference&&(this._initialDefaultSpatialReference=e),o||this.ready||(this.viewingMode="global",i&&i(`Viewing mode locked to global due to reprojectable layer ${t.id}`)),i&&i(`Layer ${t.id} is ignored because it supports server-side reprojection`),!1;return !0}whenReady(){return new Promise((e=>{this.ready?e(this):this._resolveWhenReady.push(e);}))}computeMapPointFromVec3d(e,t){let i=this.spatialReference||k$l.WGS84;return gn(e,this.renderSpatialReference,e,i)||(i=k$l.WGS84,gn(e,this.renderSpatialReference,e,i)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=i):t=new b$m(e,i),t}trackGraphicState(e){if(!e.graphic)return ke.error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let i=null,r=!1;const s=t=>{!r&&r$A(t)&&"graphics3d"in t&&t.graphics3d&&t.graphics3d.graphicsCore&&(i=t.graphics3d.graphicsCore.trackGraphicState(e));};return r$A(t)?s(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),{remove:()=>{r=!0,r$A(i)&&(i.remove(),i=null);}}}highlight(e){if(Array.isArray(e))return r$1c(e.map((e=>this.highlight(e))));if(S$o.isCollection(e))return r$1c(e.toArray().map((e=>this.highlight(e))));const t=this.getViewForGraphic(e);return t&&"highlight"in t?t.highlight(e):n$1h()}maskOccludee(e){if(!e)return ke.error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let i=null,r=!1;const s=t=>{!r&&r$A(t)&&"graphics3d"in t&&t$19(t)&&(i=t.maskOccludee(e));};return r$A(t)?s(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),{remove:()=>{r=!0,r$A(i)&&(i.remove(),i=null);}}}getViewForGraphic(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find((t=>t.layer===e.layer)):null}graphicChanged(e){r$A(this.graphicsView)&&this.graphicsView.graphicChanged(e);}async whenViewForGraphic(e,t){if(e.layer===this)return await a$11(this,"graphicsView"),this.graphicsView;if(!e.layer||!this.map)throw new s$w("no-view-for-graphic");return t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise(((t,i)=>{const r=this.map.allLayers.on("change",(s=>{-1!==s.added.indexOf(e.layer)&&(r.remove(),this.whenLayerView(e.layer).then(t,i));}));})):this.whenLayerView(e.layer)}externalToInternalIntersectOptions(e){const t=this._externalToInternalRenderItems(e.include,0),i=this._externalToInternalRenderItems(e.exclude,1);return {include:t.layerUids,exclude:i.layerUids,graphics:{include:t.graphicUids,exclude:i.graphicUids}}}_intersectResultToMapPoint(e,t){return e.getIntersectionPoint(Ke)?(t=this.computeMapPointFromVec3d(Ke,t),"TerrainRenderer"===e.intersector&&this.basemapTerrain&&(t.z=c$N(i$I(this.basemapTerrain,t),0)),t):null}_intersectResultsToHits(e,t$1){const i=new Array;let r=null;for(let s=0;s<e.length;s++){const n$1=e[s],a=t(n$1,this);if(r$A(a)&&(a===this.map.ground||"type"in a&&"integrated-mesh"===a.type))break;const o=n(n$1,this);if(!r$A(o))continue;if(t$F(r)&&s!==e.length-1&&(r=new Set),r$A(r)){const e=this._getGraphicFilterUid(o);if(r.has(e))continue;r.add(e);}if(!this._testGraphicUidFilter(t$1,o))continue;const l=this._intersectResultToMapPoint(n$1),p=n$1.distanceInRenderSpace;i.push({graphic:o,mapPoint:l,distance:p});}return i}_getGraphicFilterUid(e){if(e.layer&&"objectIdField"in e.layer){const t=e.attributes[e.layer.objectIdField];if(t)return `o-${e.layer.id}-${t}`}return `u-${e.uid}`}_testGraphicUidFilter(e,t){const i=this._getGraphicFilterUid(t);return t$F(e)||(t$F(e.include)||e.include.has(i))&&(t$F(e.exclude)||!e.exclude.has(i))}_externalToInternalRenderItems(e,t,s={layerUids:null,graphicUids:null}){return e?(e instanceof h$t?($e(s,this._getGraphicFilterUid(e)),0===t&&(r$A(this.graphicsView)&&e.layer===this?Be(s,this.graphicsView.graphics3d.layer.id):e.layer&&Be(s,e.layer.uid))):"forEach"in e?e.forEach((e=>{Array.isArray(e)?this._externalToInternalRenderItems(e,t,s):S$o.isCollection(e)?e===this.graphics&&r$A(this.graphicsView)?Be(s,this.graphicsView.graphics3d.layer.id):this._externalToInternalRenderItems(e,t,s):e instanceof A$j?e===this.map.ground&&Be(s,O$p):this._externalToInternalRenderItems(e,t,s);})):Be(s,e.uid),s):s}_initBasemapTerrain(){this._set("basemapTerrain",new Oe({view:this})),this._set("elevationProvider",new u$i({view:this})),this.elevationProvider.register("ground",this.basemapTerrain);}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null));}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new N$9({view:this})),this._set("featureTiles",new k$6({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.contentCameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const e=()=>{const e=this.basemapTerrain&&this.basemapTerrain.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const e=r$A(this.basemapTerrain.extent)?O$k(m$C(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;r$A(this.clippingArea)?this.featureTiles.filterExtent=this.clippingArea.intersection(e):this.featureTiles.filterExtent=e;}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null;};this.handles.add([this.updatingHandles.add(I$j,"FEATURE_TILE_TREE_SHOW_TILES",(e=>{e&&this.featureTiles&&!this.featureTreeDebugger?this.updatingHandles.addPromise(import('./FeatureTileTree3DDebugger-604511c8.js')).then((({FeatureTileTree3DDebugger:e})=>{!this.featureTreeDebugger&&I$j.FEATURE_TILE_TREE_SHOW_TILES&&(this.featureTreeDebugger=new e({view:this}));})):e||!this.featureTreeDebugger||I$j.FEATURE_TILE_TREE_SHOW_TILES||(this.featureTreeDebugger.destroy(),this.featureTreeDebugger=null);}),3),this.updatingHandles.add(this,"clippingArea",e,3),this.updatingHandles.add(this,"basemapTerrain.extent",e,3)],"feature-tiles"),this.stateManager.init();}_exitGlobe(){this.state&&(this.stateManager.deinit(),this.handles.remove("render-coords-helper"),this.handles.remove("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem());}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(e)||this._set("mapCoordsHelper",new a$h(this.map,e));const t=this.state.isGlobal,i=H$d(t,e);i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",_$8.create(this.state.viewingMode,i)),t||this.handles.add(this.watch("basemapTerrain.extent",(e=>{const t=this.renderCoordsHelper.spatialReference;0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]||!bn(e,this.basemapTerrain.spatialReference,Je,t)||(this.renderCoordsHelper.extent=Je);}),!0),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(y$s.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters));}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null);}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.handles.remove("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null));}updatingChanged(){this.notifyChange("updating");}_updateUpdatingMonitors(e=null){r$A(e)&&4===e.type||(this.handles.remove("updatingMonitors"),this.allLayerViews.forEach((e=>{e.destroyed||(this.handles.add([e.watch(["updating","updatingProgress"],(()=>this.updatingChanged()),!0)],"updatingMonitors"),e.when((()=>this.updatingChanged()),(()=>this.updatingChanged())));})),this.updatingChanged());}_renderScreenshotOverlay(e,t){if(!this.overlay||!this.overlay.hasVisibleItems)return t;const i=e.getContext("2d");return i.putImageData(t,0,0),this.overlay.renderCanvas(e),i.getImageData(0,0,t.width,t.height)}_initStage(){const e={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,canvas:this.renderCanvas,screenshot:{renderOverlay:(e,t)=>this._renderScreenshotOverlay(e,t)}},t=new v$a(this.state.viewingMode,(e=>this._stage.layers.forAll(e)),this);this._set("sceneIntersectionHelper",t);const i=e$10(this.surface),{resourceController:r,state:s,renderSpatialReference:n}=this;this._stage=new w({options:e,container:i,resourceController:r,state:s,sceneIntersectionHelper:t,renderSR:n}),this._lostWebGLContextHandle=r$1d(this._stage.renderView.canvas,"webglcontextlost",(()=>this.fatalError=new s$w("webgl-context-lost"))),this.handles.add([this.updatingHandles.add(this.qualitySettings,"antialiasingEnabled",(()=>{this._stage.renderView.setRenderParameters({antialiasingEnabled:this.qualitySettings.antialiasingEnabled});}),2),this.updatingHandles.add(this.qualitySettings,"highQualityTransparency",(()=>{this._stage.renderView.setRenderParameters({highQualityTransparency:this.qualitySettings.highQualityTransparency});}),2),i$P(this,"magnifier",(e=>this._stage.renderView.magnifier=e),!0)],"stage");const p=()=>{this._stage.renderView.setRenderParameters({defaultHighlightOptions:e$k.toEngineOptions(this.highlightOptions)});};for(const a of ["highlightOptions","highlightOptions.color","highlightOptions.haloColor","highlightOptions.haloOpacity","highlightOptions.fillOpacity","highlightOptions.shadowOpacity","highlightOptions.shadowColor","highlightOptions.shadowDifference"])this.handles.add(this.updatingHandles.add(this,a,p),"stage");p(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(y$s.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas);}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage.destroy(),this._stage=null,this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null,this.handles.remove("stage"),this._set("canvas",null);}_initSurface(e){this._exitSurface(),this.state.init(e,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new c$i({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state,objectResourceCache:new c$m});}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage());}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController)return;if(0===this.graphics.length)return;this.handles.remove("graphics-view"),this._createGraphicsViewController=new AbortController;const e=()=>{this._createGraphicsViewController=null,this.updatingChanged();};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(e,e),this.updatingChanged();}async _createGraphicsViewAsync(e){const t=(await import('./GraphicsView3D-5958bd50.js')).default;h$B(e),await d$K(this.basemapTerrain,"ready",e),this._set("graphicsView",new t({view:this}));}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.handles.remove("graphics-view"),r$A(this.graphicsView)&&(this.handles.remove(this.graphicsView.graphics3d.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null));}_startup(){const e=l$u(this.viewingMode);if(1===e&&(this._clippingArea=null),this._set("ready",!0),this._initSurface(e),this.handles.add($$9(this,"graphics","after-changes",(()=>this._createGraphicsViewIfNeeded())),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){const e=this.get("map.initialViewProperties.environment");e&&(this.environment=e);}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const t=this._resolveWhenReady;this._resolveWhenReady=[],t.forEach((e=>e(this)));}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.handles.remove("graphics-view"),this._exitSurface(),this._set("ready",!1);}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(O$p);for(const e of this.map.allLayers.items)"integrated-mesh"===e.type&&this._defaultToMapOptions.include.add(e.uid);}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(O$p);for(const e of this.map.allLayers.items)"integrated-mesh"===e.type&&e.opacity<1&&this._defaultToMapOptions.exclude.add(e.uid);}}};function Be(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t);}function $e(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t);}function Qe(e,t){return r$A(e)&&tn(e.spatialReference,t)?O$k(e,t):null}e$x([d$y()],Ne.prototype,"_userClippingArea",void 0),e$x([d$y()],Ne.prototype,"_resourceController",void 0),e$x([d$y()],Ne.prototype,"_stage",void 0),e$x([d$y({readOnly:!0})],Ne.prototype,"deconflictor",void 0),e$x([d$y({readOnly:!0})],Ne.prototype,"labeler",void 0),e$x([d$y({type:n$X,readOnly:!0,aliasOf:"state.animation"})],Ne.prototype,"animation",void 0),e$x([d$y({readOnly:!0})],Ne.prototype,"basemapTerrain",void 0),e$x([d$y({readOnly:!0})],Ne.prototype,"elevationProvider",void 0),e$x([d$y({type:d$A,aliasOf:"stateManager.camera"})],Ne.prototype,"camera",void 0),e$x([d$y({type:d$A,aliasOf:"stateManager.contentCamera"})],Ne.prototype,"contentCamera",void 0),e$x([d$y({readOnly:!0})],Ne.prototype,"canvas",void 0),e$x([d$y({type:b$m,aliasOf:"stateManager.center"})],Ne.prototype,"center",void 0),e$x([d$y({type:M$g})],Ne.prototype,"clippingArea",null),e$x([d$y({type:a$E})],Ne.prototype,"constraints",void 0),e$x([d$y({type:M$g,readOnly:!0})],Ne.prototype,"renderDataExtent",null),e$x([d$y({type:M$g,readOnly:!0})],Ne.prototype,"dataExtent",null),e$x([d$y({type:M$g,readOnly:!0})],Ne.prototype,"groundAndLayersExtent",null),e$x([d$y({value:null,type:u$u})],Ne.prototype,"environment",null),e$x([c$P("environment")],Ne.prototype,"castEnvironment",null),e$x([d$y({readOnly:!0})],Ne.prototype,"environmentManager",void 0),e$x([d$y({type:M$g,aliasOf:"stateManager.extent"})],Ne.prototype,"extent",void 0),e$x([d$y()],Ne.prototype,"floors",void 0),e$x([d$y({readOnly:!0,aliasOf:"stateManager.screenCenter"})],Ne.prototype,"screenCenter",void 0),e$x([d$y({type:Number})],Ne.prototype,"pixelRatio",null),e$x([d$y({type:Number,dependsOn:["qualitySettings.maximumPixelRatio","qualitySettings.maximumRenderResolution","size"]})],Ne.prototype,"maximumPixelRatio",null),e$x([d$y({aliasOf:"stateManager.frustum"})],Ne.prototype,"frustum",void 0),e$x([d$y({type:Number,readOnly:!0})],Ne.prototype,"fullOpacity",void 0),e$x([d$y({readOnly:!0})],Ne.prototype,"graphicsView",void 0),e$x([d$y()],Ne.prototype,"groundView",void 0),e$x([d$y({type:Boolean})],Ne.prototype,"initialExtentRequired",null),e$x([d$y({type:Boolean,readOnly:!0})],Ne.prototype,"interacting",null),e$x([d$y()],Ne.prototype,"stationary",null),e$x([d$y({aliasOf:"state.navigating"})],Ne.prototype,"navigating",void 0),e$x([d$y()],Ne.prototype,"map",void 0),e$x([d$y({readOnly:!0})],Ne.prototype,"mapCoordsHelper",void 0),e$x([d$y({aliasOf:"stateManager.padding"})],Ne.prototype,"padding",void 0),e$x([d$y({type:N$9,readOnly:!0})],Ne.prototype,"pointsOfInterest",void 0),e$x([d$y({type:k$6,readOnly:!0})],Ne.prototype,"featureTiles",void 0),e$x([d$y()],Ne.prototype,"featureTreeDebugger",void 0),e$x([d$y({type:Boolean})],Ne.prototype,"screenSizePerspectiveEnabled",void 0),e$x([d$y({constructOnly:!0})],Ne.prototype,"deactivatedWebGLExtensions",void 0),e$x([d$y({constructOnly:!0})],Ne.prototype,"debugWebGLExtensions",void 0),e$x([d$y({constructOnly:!0})],Ne.prototype,"renderCanvas",void 0),e$x([d$y({constructOnly:!0})],Ne.prototype,"state",void 0),e$x([d$y({readOnly:!0})],Ne.prototype,"inputManager",void 0),e$x([d$y({readOnly:!0})],Ne.prototype,"stateManager",void 0),e$x([d$y({type:["low","medium","high"]})],Ne.prototype,"qualityProfile",null),e$x([d$y({type:l$g,get(){let e=this._get("qualitySettings");return e||(e=new l$g,o$l.apply(this.qualityProfile,e)),e}})],Ne.prototype,"qualitySettings",void 0),e$x([d$y()],Ne.prototype,"slicePlane",null),e$x([d$y({dependsOn:["viewingMode"]})],Ne.prototype,"preconditionsReady",void 0),e$x([d$y({readOnly:!0})],Ne.prototype,"renderCoordsHelper",void 0),e$x([d$y({readOnly:!0})],Ne.prototype,"sceneIntersectionHelper",void 0),e$x([d$y({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],Ne.prototype,"resolution",null),e$x([d$y({type:Number,aliasOf:"stateManager.scale"})],Ne.prototype,"scale",void 0),e$x([d$y({dependsOn:[]})],Ne.prototype,"heightModelInfo",null),e$x([d$y({dependsOn:["map.initialViewProperties?.spatialReference","defaultsFromMap.isSpatialReferenceDone"]})],Ne.prototype,"spatialReference",void 0),e$x([d$y({type:Boolean,constructOnly:!0})],Ne.prototype,"alphaCompositingEnabled",void 0),e$x([d$y({type:Boolean})],Ne.prototype,"supersampleScreenshotsEnabled",void 0),e$x([d$y({readOnly:!0})],Ne.prototype,"type",void 0),e$x([d$y({type:p})],Ne.prototype,"ui",void 0),e$x([d$y({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.hasPendingInputs","toolViewManager.updating"]})],Ne.prototype,"updating",null),e$x([d$y({type:Number,readOnly:!0,dependsOn:["updating"]})],Ne.prototype,"updatingProgress",void 0),e$x([d$y({type:["global","local"],dependsOn:["map.initialViewProperties?.viewingMode","spatialReference"]})],Ne.prototype,"viewingMode",null),e$x([d$y({type:u$z,aliasOf:"stateManager.viewpoint"})],Ne.prototype,"viewpoint",void 0),e$x([d$y({type:Number,aliasOf:"stateManager.zoom"})],Ne.prototype,"zoom",void 0),e$x([d$y({type:e$k})],Ne.prototype,"highlightOptions",void 0),Ne=e$x([i$H("esri.views.SceneView")],Ne);const Ke=n$F(),Ze=i$S(),Je=u$B(),Xe=Ne;

const arcgisWebsceneCss = "@import url('https://js.arcgis.com/next/esri/themes/light/main.css');.scene-view{padding:0;margin:0}";

let ArcGISWebScene = class {
  constructor(hostRef) {
    registerInstance(this, hostRef);
    this.loaded = createEvent(this, "loaded", 7);
  }
  validateApiKey(value) {
    t$1a.apiKey = value;
  }
  validateItemId(value, old) {
    if (value && value !== old) {
      this.loadMap();
    }
  }
  componentWillLoad() {
    if (this.apiKey) {
      t$1a.apiKey = this.apiKey;
    }
    if (this.itemId) {
      this.loadMap();
    }
  }
  componentDidRender() {
    // Find any arcgis-* components in View DOM
    const elem = this.el.querySelector('.esri-view-user-storage');
    if (elem) {
      const elems = Array.from(elem.children);
      for (let e of elems) {
        if (e.tagName.toLowerCase().includes('arcgis-')) {
          e.view = this.view;
        }
      }
    }
  }
  loadMap() {
    const mapParams = {};
    if (this.itemId) {
      mapParams.portalItem = {
        id: this.itemId
      };
    }
    const map = new Y$9(mapParams);
    const params = {};
    if (this.zoom) {
      params.zoom = this.zoom;
    }
    if (this.center) {
      if (typeof this.center === 'string') {
        params.center = this.center.split(',').map((x) => Number(x));
      }
      else {
        params.center = this.center;
      }
    }
    const view = new Xe(Object.assign({ container: this.el, map }, params));
    this.view = view;
    view.when(() => this.loaded.emit(true));
  }
  render() {
    return (h$G("div", { class: "scene-view" }));
  }
  get el() { return getElement(this); }
  static get watchers() { return {
    "apiKey": ["validateApiKey"],
    "itemId": ["validateItemId"]
  }; }
};
ArcGISWebScene.style = arcgisWebsceneCss;

export { n as A, ArcGISWebScene as B, D$2 as D, E$3 as E, F$3 as F, G$2 as G, H$4 as H, J$4 as J, K$4 as K, L$3 as L, N$5 as N, O$1 as O, P$3 as P, S$3 as S, V$3 as V, m$7 as a, n$v as b, t$z as c, d$d as d, e$6 as e, i$s as f, r$d as g, r$c as h, i$t as i, j$3 as j, o$b as k, h$3 as l, m$c as m, n$l as n, o$v as o, p$e as p, o$u as q, r$t as r, s$o as s, t$m as t, t$7 as u, l$6 as v, i$5 as w, t$5 as x, n$3 as y, p$2 as z };
